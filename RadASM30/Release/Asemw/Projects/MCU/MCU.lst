

       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



        Source File:    MCU.a51
        Object File:    MCU.hex
        List File:      MCU.lst



 Line  I  Addr  Code            Source

    1:                          $NOPAGING
    2:          N      00FA     $PAGEWIDTH (250) ;250 columns per line
    3:                          $NOTABS          ;expand tabs
    4:                          $NOSYMBOLS
    5:
    6:          N      0001     DEVMODE         EQU 1
    7:          N      0000     DEBUG           EQU 0
    8:
    9:                          ;*****************************************************
   10:                          ;Interrupt vectors.
   11:                          ;-----------------------------------------------------
   12:                          ;RESET          0000
   13:                          ;IE0            0003
   14:                          ;TF0            000B
   15:                          ;IE1            0013
   16:                          ;TF1            001B
   17:                          ;RI & TI        0023
   18:                          ;TF2 & EXF2     002B
   19:                          ;-----------------------------------------------------
   20:                          ;*****************************************************
   21:                          ;PORT 1
   22:                          ;-----------------------------------------------------
   23:                          ;P1.0           OUT:    +5V On
   24:                          ;P1.1           OUT:    RST
   25:                          ;P1.2           OUT:    SCK
   26:                          ;P1.3           OUT:    MISO
   27:                          ;P1.4           IN:     MOSI
   28:                          ;P1.5
   29:                          ;P1.6
   30:                          ;P1.7
   31:                          ;-----------------------------------------------------
   32:                          ;*****************************************************
   33:                          ;RAM Locations
   34:                          ;-----------------------------------------------------
   35:                          ;20             Interrupt control bit flags
   36:                          ;               D0                      If set INT0 interrupt jumps to 2003h
   37:                          ;               D1                      If set TIMER0 interrupt jumps to 200Bh
   38:                          ;               D2                      If set INT1 interrupt jumps to 2013h
   39:                          ;               D3                      If set TIMER1 interrupt jumps to 201Bh
   40:                          ;               D4                      If set RI/TI interrupt jumps to 2023h
   41:                          ;               D5                      If set TIMER2 interrupt jumps to 202Bh
   42:                          ;               D6                      If set output is to terminal instead of LCD
   43:                          ;               D7                      If set single stepping is enabled
   44:
   45:                          ;24             ARG_STACK               ARGUMENT STACK POINTER
   46:                          ;25             FORMAT                  LOCATION OF OUTPUT FORMAT BYTE
   47:                          ;26.1           INTGRC                  BIT SET IF INTEGER ERROR
   48:                          ;26.3           ADD_IN                  DCMPXZ IN BASIC BACKAGE
   49:                          ;26.6           ZSURP                   ZERO SUPRESSION FOR HEX PRINT
   50:                          ;28-3D          FP WORK AREA
   51:                          ;40-4F          ROMBUFF / LCDLINE       16 Bytes
   52:                          ;50             FPCHR_OUT               Holds addrss to next byte during FP number convertion
   53:                          ;51             ROMVER                  Byte to be verified
   54:                          ;52             ROMPAGES                Number of pages
   55:                          ;53             ROMACTION               Menu pos
   56:                          ;54             ROMSIZE                 Menu pos
   57:                          ;55             ROMMODE                 Menu pos
   58:                          ;56             ROMVERERR               Number of verify errors
   59:                          ;57             DPLSAVE                 Holds DPL during PRNTCSTR
   60:                          ;58             DPHSAVE                 Holds DPH during PRNTCSTR
   61:                          ;59             MODE                    Selected mode (0-7)
   62:                          ;5A             SSADRLSB                Single step adress
   63:                          ;5B             SSADRMSB                Single step adress
   64:
   65:                          ;C0-FF          48 Byte stack
   66:
   67:                          ;0048           EXTERNAL RAM FP NUMBER INPUT AREA
   68:                          ;0100           EXTERNAL RAM FP STACK
   69:                          ;8000           MEMORU MAPPED I/O
   70:                          ;8001           MEMORU MAPPED I/O
   71:
   72:                          ;-----------------------------------------------------
   73:                          ;*****************************************************
   74:                          ;SCREEN DRIVER
   75:                          ;-----------------------------------------------------
   76:                          ;01             START SEND ROMDATA.HEX FILE
   77:                          ;02             STOP SEND FILE
   78:                          ;03             START RECIEVE ROMDATA.HEX FILE
   79:                          ;04             STOP RECIEVE FILE
   80:                          ;05             START RECIEVE FILE IN 16 BYTE BLOCKS
   81:                          ;06             STOP RECIEVE FILE IN 16 BYTE BLOCKS
   82:                          ;07             BELL
   83:                          ;08             BACK SPACE
   84:                          ;09             TAB
   85:                          ;0A             LF
   86:                          ;0B             LOCATE
   87:                          ;0C             HOME
   88:                          ;0D             CR
   89:                          ;0E             CLS
   90:                          ;0F             MODE
   91:                          ;10             START SEND CMDFILE.CMD FILE
   92:                          ;-----------------------------------------------------
   93:                          ;*****************************************************
   94:                          ;Memory mapped I/O
   95:                          ;-----------------------------------------------------
   96:                          ;8000h Output
   97:                          ;-----------------------------------------------------
   98:                          ;D0             LCD DB4
   99:                          ;D1             LCD DB5
  100:                          ;D2             LCD DB6
  101:                          ;D3             LCD DB7
  102:                          ;D4             LCD RS
  103:                          ;D5             LCD E
  104:                          ;D6
  105:                          ;D7
  106:                          ;-----------------------------------------------------
  107:                          ;8001h Output
  108:                          ;-----------------------------------------------------
  109:                          ;D0             FRQ SEL A
  110:                          ;D1             FRQ SEL B
  111:                          ;D2             FRQ GATE
  112:                          ;D3             FRQ RESET
  113:                          ;D4             ADC CS
  114:                          ;D5             ADC CLK
  115:                          ;D6             ADC DIN
  116:                          ;D7
  117:                          ;-----------------------------------------------------
  118:                          ;8000h Input
  119:                          ;-----------------------------------------------------
  120:                          ;D0             FRQ LSB
  121:                          ;D1
  122:                          ;D2
  123:                          ;D3
  124:                          ;D4
  125:                          ;D5
  126:                          ;D6
  127:                          ;D7             FRQ MSB
  128:                          ;-----------------------------------------------------
  129:                          ;8001h Input
  130:                          ;-----------------------------------------------------
  131:                          ;D0             ADC DOUT
  132:                          ;D1
  133:                          ;D2
  134:                          ;D3
  135:                          ;D4
  136:                          ;D5
  137:                          ;D6
  138:                          ;D7
  139:
  140:                          ;-----------------------------------------------------
  141:                          ;*****************************************************
  142:                          ;Equates
  143:                          ;-----------------------------------------------------
  144:          N      00C8     T2CON           EQU 0C8h
  145:          N      00CA     RCAP2L          EQU 0CAh
  146:          N      00CB     RCAP2H          EQU 0CBh
  147:          N      00CC     TL2             EQU 0CCh
  148:          N      00CD     TH2             EQU 0CDh
  149:          N        BD     PT2             BIT 0BDh
  150:                          ;-----------------------------------------------------
  151:          N      0020     INTBITS         EQU 20h                 ;Interrupt jump control
  152:
  153:          N      0040     ROMBUFF         EQU 40h                 ;16 Bytes
  154:
  155:
  156:          N      0040     LCDLINE         EQU 40h                 ;16 Bytes
  157:
  158:          N      0050     FPCHR_OUT       EQU 50h                 ;Holds addrss to next byte during FP number convertion
  159:          N      0051     ROMVER          EQU 51h                 ;Byte to be verified
  160:          N      0052     ROMPAGES        EQU 52h                 ;Number of pages
  161:          N      0053     ROMACTION       EQU 53h                 ;Menu pos
  162:          N      0054     ROMSIZE         EQU 54h                 ;Menu pos
  163:          N      0055     ROMMODE         EQU 55h                 ;Menu pos
  164:          N      0056     ROMVERERR       EQU 56h                 ;Number of verify errors
  165:          N      0057     DPLSAVE         EQU 57h                 ;Holds DPL during PRNTCSTR
  166:          N      0058     DPHSAVE         EQU 58h                 ;Holds DPH during PRNTCSTR
  167:          N      0059     MODE            EQU 59h                 ;Selected mode (0-7)
  168:          N      005A     SSADRLSB        EQU 5Ah                 ;Single step adress LSB
  169:          N      005B     SSADRMSB        EQU 5Bh                 ;Single step adress MSB
  170:                          ;-----------------------------------------------------
  171:          N      0000     IF DEVMODE=0
  172:                          ;RESET:***********************************************
  173:                                          ORG     0000h
  174:                                          LJMP    START0
  175:                          ;IE0IRQ:**********************************************
  176:                                          ORG     0003h
  177:                                          AJMP    IE0IRQ
  178:                          ;TF0IRQ:**********************************************
  179:                                          ORG     000Bh
  180:                                          JB      INTBITS.1,$+4
  181:                                          RETI
  182:                                          LJMP    200Bh
  183:                          ;IE1IRQ:**********************************************
  184:                                          ORG     0013h
  185:                                          AJMP    IE1IRQ
  186:                          ;TF1IRQ:**********************************************
  187:                                          ORG     001Bh
  188:                                          JB      INTBITS.3,$+4
  189:                                          RETI
  190:                                          LJMP    201Bh
  191:                          ;RITIIRQ:*********************************************
  192:                                          ORG     0023h
  193:                                          JB      INTBITS.4,$+4
  194:                                          RETI
  195:                                          LJMP    2023h
  196:                          ;TF2EXF2IRQ:******************************************
  197:                                          ORG     002Bh
  198:                                          JB      INTBITS.5,$+4
  199:                                          RETI
  200:                                          LJMP    202Bh
  201:                          ;*****************************************************
  202:                          IE0IRQ:         JB      INTBITS.0,IE0IRQ1
  203:                                          ACALL   DEBOUNCEINT0
  204:                                          INC     MODE
  205:                                          LJMP    START
  206:                          IE0IRQ1:        LJMP    2003h
  207:
  208:                          IE1IRQ:         JB      INTBITS.2,IE1IRQ1
  209:                                          JB      INTBITS.7,IE1IRQ2
  210:                                          ACALL   DEBOUNCEINT1
  211:                                          DEC     MODE
  212:                                          LJMP    START
  213:                          IE1IRQ1:        LJMP    2013h
  214:                          IE1IRQ2:        LJMP    SINGLESTEP
  215:
  216:                          DEBOUNCEINT0:   MOV     R6,#00h
  217:                                          MOV     R7,#00h
  218:                          DEBOUNCEINT01:  JNB     P3.2,DEBOUNCEINT0
  219:                                          DJNZ    R6,DEBOUNCEINT01
  220:                                          DJNZ    R7,DEBOUNCEINT01
  221:                                          RETI
  222:
  223:                          DEBOUNCEINT1:   MOV     R6,#00h
  224:                                          MOV     R7,#00h
  225:                          DEBOUNCEINT11:  JNB     P3.2,DEBOUNCEINT1
  226:                                          DJNZ    R6,DEBOUNCEINT11
  227:                                          DJNZ    R7,DEBOUNCEINT11
  228:                                          RETI
  229:
  230:                                          ORG     0080h
  231:
  232:                          ;               LJMP    TXBYTE
  233:                          ;               LJMP    RXBYTE
  234:                          ;               LJMP    HEXOUT
  235:                          ;               LJMP    HEXDPTR
  236:                          ;               LJMP    PRNTCRLF
  237:                          ;               LJMP    PRINTSTR
  238:                          ;               LJMP    PRINTDPTRSTR
  239:                          ;               LJMP    PRNTCSTR
  240:                          ;               LJMP    BIN2DEC
  241:                          ;               LJMP    FLOATING_ADD
  242:                          ;               LJMP    FLOATING_SUB
  243:                          ;               LJMP    FLOATING_COMP
  244:                          ;               LJMP    FLOATING_MUL
  245:                          ;               LJMP    FLOATING_DIV
  246:                          ;               LJMP    HEXSCAN
  247:                          ;               LJMP    FLOATING_POINT_INPUT
  248:                          ;               LJMP    FLOATING_POINT_OUTPUT
  249:                          ;               LJMP    CONVERT_BINARY_TO_ASCII_STRING
  250:                          ;               LJMP    CONVERT_ASCII_STRING_TO_BINARY
  251:                          ;               LJMP    MULNUM10
  252:                          ;               LJMP    PUSHR2R0                        ;INTEGER to FLOAT
  253:                          ;               LJMP    IFIX                            ;FLOAT to INTEGER
  254:                          ;               LJMP    PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
  255:                          ;               LJMP    POPAS                           ;POP ARGUMENT TO R3:R1
  256:                          ;               LJMP    MOVAS                           ;COPY ARGUMENT
  257:                          ;               LJMP    AINT                            ;INT FUNCTION
  258:                          ;               LJMP    PUSHC                           ;PUSH ARG IN DPTR TO STACK
  259:                          ELSE
  260:                          ;RESET:***********************************************
  261:          N      2000                     ORG     2000h
  262:    2000  02 30 00                        LJMP    START0
  263:                          ;IE0IRQ:**********************************************
  264:          N      2003                     ORG     2003h
  265:    2003  01 2C                           AJMP    IE0IRQ
  266:                          ;TF0IRQ:**********************************************
  267:          N      200B                     ORG     200Bh
  268:    200B  32                              RETI
  269:                          ;IE1IRQ:**********************************************
  270:          N      2013                     ORG     2013h
  271:    2013  01 33                           AJMP    IE1IRQ
  272:                          ;TF1IRQ:**********************************************
  273:          N      201B                     ORG     201Bh
  274:    201B  32                              RETI
  275:                          ;RITIIRQ:*********************************************
  276:          N      2023                     ORG     2023h
  277:    2023  32                              RETI
  278:                          ;TF2EXF2IRQ:******************************************
  279:          N      202B                     ORG     202Bh
  280:    202B  32                              RETI
  281:                          ;*****************************************************
  282:    202C  11 3E           IE0IRQ:         ACALL   DEBOUNCEINT0
  283:    202E  05 59                           INC     MODE
  284:    2030  02 30 39                        LJMP    START
  285:
  286:    2033  20 07 05        IE1IRQ:         JB      INTBITS.7,IE1IRQ2
  287:    2036  15 59                           DEC     MODE
  288:    2038  02 30 39                        LJMP    START
  289:    203B  02 3E CD        IE1IRQ2:        LJMP    SINGLESTEP
  290:
  291:    203E  7E 00           DEBOUNCEINT0:   MOV     R6,#00h
  292:    2040  7F 00                           MOV     R7,#00h
  293:    2042  30 B2 F9        DEBOUNCEINT01:  JNB     P3.2,DEBOUNCEINT0
  294:    2045  DE FB                           DJNZ    R6,DEBOUNCEINT01
  295:    2047  DF F9                           DJNZ    R7,DEBOUNCEINT01
  296:    2049  32                              RETI
  297:
  298:    204A  7E 00           DEBOUNCEINT1:   MOV     R6,#00h
  299:    204C  7F 00                           MOV     R7,#00h
  300:    204E  30 B2 F9        DEBOUNCEINT11:  JNB     P3.2,DEBOUNCEINT1
  301:    2051  DE FB                           DJNZ    R6,DEBOUNCEINT11
  302:    2053  DF F9                           DJNZ    R7,DEBOUNCEINT11
  303:    2055  32                              RETI
  304:
  305:          N      2080                     ORG     2080h
  306:
  307:                          ;               LJMP    TXBYTE
  308:                          ;               LJMP    RXBYTE
  309:                          ;               LJMP    HEXOUT
  310:                          ;               LJMP    HEXDPTR
  311:                          ;               LJMP    PRNTCRLF
  312:                          ;               LJMP    PRINTSTR
  313:                          ;               LJMP    PRINTDPTRSTR
  314:                          ;               LJMP    PRNTCSTR
  315:                          ;               LJMP    BIN2DEC
  316:                          ;               LJMP    FLOATING_ADD
  317:                          ;               LJMP    FLOATING_SUB
  318:                          ;               LJMP    FLOATING_COMP
  319:                          ;               LJMP    FLOATING_MUL
  320:                          ;               LJMP    FLOATING_DIV
  321:                          ;               LJMP    HEXSCAN
  322:                          ;               LJMP    FLOATING_POINT_INPUT
  323:                          ;               LJMP    FLOATING_POINT_OUTPUT
  324:                          ;               LJMP    CONVERT_BINARY_TO_ASCII_STRING
  325:                          ;               LJMP    CONVERT_ASCII_STRING_TO_BINARY
  326:                          ;               LJMP    MULNUM10
  327:                          ;               LJMP    PUSHR2R0                        ;INTEGER to FLOAT
  328:                          ;               LJMP    IFIX                            ;FLOAT to INTEGER
  329:                          ;               LJMP    PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
  330:                          ;               LJMP    POPAS                           ;POP ARGUMENT TO R3:R1
  331:                          ;               LJMP    MOVAS                           ;COPY ARGUMENT
  332:                          ;               LJMP    AINT                            ;INT FUNCTION
  333:                          ;               LJMP    PUSHC                           ;PUSH ARG IN DPTR TO STACK
  334:
  335:                          ENDIF
  336:
  337:                          ; This is a complete BCD floating point package for the 8051 micro-
  338:                          ; controller. It provides 8 digits of accuracy with exponents that
  339:                          ; range from +127 to -127. The mantissa is in packed BCD, while the
  340:                          ; exponent is expressed in pseudo-twos complement. A ZERO exponent
  341:                          ; is used to express the number ZERO. An exponent value of 80H or
  342:                          ; greater than means the exponent is positive, i.e. 80H = E 0,
  343:                          ; 81H = E+1, 82H = E+2 and so on. If the exponent is 7FH or less,
  344:                          ; the exponent is negative, 7FH = E-1, 7EH = E-2, and so on.
  345:                          ; ALL NUMBERS ARE ASSUMED TO BE NORMALIZED and all results are
  346:                          ; normalized after calculation. A normalized mantissa is >=.10 and
  347:                          ; <=.99999999.
  348:                          ;
  349:                          ; The numbers in memory assumed to be stored as follows:
  350:                          ;
  351:                          ; EXPONENT OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE
  352:                          ; SIGN OF ARGUMENT 2       =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-1
  353:                          ; DIGIT 78 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-2
  354:                          ; DIGIT 56 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-3
  355:                          ; DIGIT 34 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-4
  356:                          ; DIGIT 12 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-5
  357:                          ;
  358:                          ; EXPONENT OF ARGUMENT 1   =   VALUE OF ARG_STACK
  359:                          ; SIGN OF ARGUMENT 1       =   VALUE OF ARG_STACK-1
  360:                          ; DIGIT 78 OF ARGUMENT 1   =   VALUE OF ARG_STACK-2
  361:                          ; DIGIT 56 OF ARGUMENT 1   =   VALUE OF ARG_STACK-3
  362:                          ; DIGIT 34 OF ARGUMENT 1   =   VALUE OF ARG_STACK-4
  363:                          ; DIGIT 12 OF ARGUMENT 1   =   VALUE OF ARG_STACK-5
  364:                          ;
  365:                          ; The operations are performed thusly:
  366:                          ;
  367:                          ; ARG_STACK+FP_NUMBER_SIZE = ARG_STACK+FP_NUMBER_SIZE # ARG_STACK
  368:                          ;
  369:                          ; Which is ARGUMENT 2 = ARGUMENT 2 # ARGUMENT 1
  370:                          ;
  371:                          ; Where # can be ADD, SUBTRACT, MULTIPLY OR DIVIDE.
  372:                          ;
  373:                          ; Note that the stack gets popped after an operation.
  374:                          ;
  375:                          ; The FP_COMP instruction POPS the ARG_STACK TWICE and returns status.
  376:                          ;
  377:                          ;**********************************************************************
  378:                          ;
  379:                          ;**********************************************************************
  380:                          ;
  381:                          ; STATUS ON RETURN - After performing an operation (+, -, *, /)
  382:                          ;                    the accumulator contains the following status
  383:                          ;
  384:                          ; ACCUMULATOR - BIT 0 - FLOATING POINT UNDERFLOW OCCURED
  385:                          ;
  386:                          ;             - BIT 1 - FLOATING POINT OVERFLOW OCCURED
  387:                          ;
  388:                          ;             - BIT 2 - RESULT WAS ZER0
  389:                          ;
  390:                          ;             - BIT 3 - DIVIDE BY ZERO ATTEMPTED
  391:                          ;
  392:                          ;             - BIT 4 - NOT USED, 0 RETURNED
  393:                          ;
  394:                          ;             - BIT 5 - NOT USED, 0 RETURNED
  395:                          ;
  396:                          ;             - BIT 6 - NOT USED, 0 RETURNED
  397:                          ;
  398:                          ;             - BIT 7 - NOT USED, 0 RETURNED
  399:                          ;
  400:                          ; NOTE: When underflow occures, a ZERO result is returned.
  401:                          ;       When overflow or divide by zero occures, a result of
  402:                          ;       .99999999 E+127 is returned and it is up to the user
  403:                          ;       to handle these conditions as needed in the program.
  404:                          ;
  405:                          ; NOTE: The Compare instruction returns F0 = 0 if ARG 1 = ARG 2
  406:                          ;       and returns a CARRY FLAG = 1 if ARG 1 is > ARG 2
  407:                          ;
  408:                          ;***********************************************************************
  409:                          ;
  410:                          ;***********************************************************************
  411:                          ;
  412:                          ; The following values MUST be provided by the user
  413:                          ;
  414:                          ;***********************************************************************
  415:                          ;
  416:          N      0001     ARG_STACK_PAGE  EQU     01H                             ;External memory page for arg stack
  417:          N      0024     ARG_STACK       EQU     24H                             ;ARGUMENT STACK POINTER
  418:          N      0025     FORMAT          EQU     25H                             ;LOCATION OF OUTPUT FORMAT BYTE
  419:                          ;OUTPUT         EQU     R5OUT                           ;CALL LOCATION TO OUTPUT A CHARACTER in R5
  420:          N      0048     CONVT           EQU     0048H                           ;String addr TO CONVERT NUMBERS
  421:          B        31     INTGRC          BIT     26H.1                           ;BIT SET IF INTEGER ERROR
  422:          B        33     ADD_IN          BIT     26H.3                           ;DCMPXZ IN BASIC BACKAGE
  423:          B        36     ZSURP           BIT     26H.6                           ;ZERO SUPRESSION FOR HEX PRINT
  424:                          ;
  425:                          ;***********************************************************************
  426:                          ;
  427:                          ; The following equates are used internally
  428:                          ;
  429:                          ;***********************************************************************
  430:                          ;
  431:          N      0006     FP_NUMBER_SIZE  EQU     6
  432:          N      0004     DIGIT           EQU     4
  433:          N      0000     R0B0            EQU     0
  434:          N      0001     R1B0            EQU     1
  435:          N      0000     UNDERFLOW       EQU     0
  436:          N      0001     OVERFLOW        EQU     1
  437:          N      0002     ZERO            EQU     2
  438:          N      0003     ZERO_DIVIDE     EQU     3
  439:                          ;
  440:                          ;***********************************************************************
  441:                                  ;**************************************************************
  442:                                  ;
  443:                                  ; The following internal locations are used by the math pack
  444:                                  ; ordering is important and the FP_DIGITS must be bit
  445:                                  ; addressable
  446:                                  ;
  447:                                  ;***************************************************************
  448:                                  ;
  449:          N      0028     FP_STATUS       EQU     28H                             ;NOT used data pointer me
  450:          N      0029     FP_TEMP         EQU     FP_STATUS+1                     ;NOT USED
  451:          N      002A     FP_CARRY        EQU     FP_STATUS+2                     ;USED FOR BITS
  452:          N      002B     FP_DIG12        EQU     FP_CARRY+1
  453:          N      002C     FP_DIG34        EQU     FP_CARRY+2
  454:          N      002D     FP_DIG56        EQU     FP_CARRY+3
  455:          N      002E     FP_DIG78        EQU     FP_CARRY+4
  456:          N      002F     FP_SIGN         EQU     FP_CARRY+5
  457:          N      0030     FP_EXP          EQU     FP_CARRY+6
  458:          B        78     MSIGN           BIT     FP_SIGN.0
  459:          B        50     XSIGN           BIT     FP_CARRY.0
  460:          B        51     FOUND_RADIX     BIT     FP_CARRY.1
  461:          B        52     FIRST_RADIX     BIT     FP_CARRY.2
  462:          B        53     DONE_LOAD       BIT     FP_CARRY.3
  463:          N      002B     FP_NIB1         EQU     FP_DIG12
  464:          N      002C     FP_NIB2         EQU     FP_NIB1+1
  465:          N      002D     FP_NIB3         EQU     FP_NIB1+2
  466:          N      002E     FP_NIB4         EQU     FP_NIB1+3
  467:          N      002F     FP_NIB5         EQU     FP_NIB1+4
  468:          N      0030     FP_NIB6         EQU     FP_NIB1+5
  469:          N      0031     FP_NIB7         EQU     FP_NIB1+6
  470:          N      0032     FP_NIB8         EQU     FP_NIB1+7
  471:          N      0033     FP_ACCX         EQU     FP_NIB1+8
  472:          N      0034     FP_ACCC         EQU     FP_NIB1+9
  473:          N      0035     FP_ACC1         EQU     FP_NIB1+10
  474:          N      0036     FP_ACC2         EQU     FP_NIB1+11
  475:          N      0037     FP_ACC3         EQU     FP_NIB1+12
  476:          N      0038     FP_ACC4         EQU     FP_NIB1+13
  477:          N      0039     FP_ACC5         EQU     FP_NIB1+14
  478:          N      003A     FP_ACC6         EQU     FP_NIB1+15
  479:          N      003B     FP_ACC7         EQU     FP_NIB1+16
  480:          N      003C     FP_ACC8         EQU     FP_NIB1+17
  481:          N      003D     FP_ACCS         EQU     FP_NIB1+18
  482:                                  ;
  483:
  484:          C      2080     FP_BASE         EQU     $
  485:
  486:                                  ;**************************************************************
  487:                                  ;
  488:                                  ; The floating point entry points and jump table
  489:                                  ;
  490:                                  ;**************************************************************
  491:                                  ;
  492:    2080  01 B2                           AJMP    FLOATING_ADD
  493:    2082  01 A8                           AJMP    FLOATING_SUB
  494:    2084  21 65                           AJMP    FLOATING_COMP
  495:    2086  21 96                           AJMP    FLOATING_MUL
  496:    2088  21 CB                           AJMP    FLOATING_DIV
  497:    208A  61 92                           AJMP    HEXSCAN
  498:    208C  61 CB                           AJMP    FLOATING_POINT_INPUT
  499:    208E  81 83                           AJMP    FLOATING_POINT_OUTPUT
  500:    2090  C1 00                           AJMP    CONVERT_BINARY_TO_ASCII_STRING
  501:    2092  A1 A7                           AJMP    CONVERT_ASCII_STRING_TO_BINARY
  502:    2094  A1 DC                           AJMP    MULNUM10
  503:    2096  C1 48                           AJMP    FPHEXOUT
  504:                          ;
  505:                          ; the remaining jump to routines were extracted from basic52
  506:                          ; by me to make the floating point software stand alone
  507:                          ;
  508:    2098  61 BF                           AJMP    PUSHR2R0                        ; INTEGER to FLOAT
  509:    209A  C1 92                           AJMP    IFIX                            ; FLOAT to INTEGER
  510:    209C  C1 D3                           AJMP    PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
  511:    209E  C1 CF                           AJMP    POPAS                           ; POP ARGUMENT TO R3:R1
  512:    20A0  C1 F0                           AJMP    MOVAS                           ; COPY ARGUMENT
  513:    20A2  E1 13                           AJMP    AINT                            ; INT FUNCTION
  514:    20A4  E1 3B                           AJMP    PUSHC                           ; PUSH ARG IN DPTR TO STACK
  515:
  516:    20A6  22              PRTERR:         RET
  517:    20A7  22              BADPRM:         RET
  518:
  519:                                  ;
  520:                                  ;
  521:    20A8                  FLOATING_SUB:
  522:                                  ;
  523:    20A8  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
  524:    20AB  A8 24                           MOV     R0,ARG_STACK
  525:    20AD  18                              DEC     R0                              ;POINT TO SIGN
  526:    20AE  E2                              MOVX    A,@R0                           ;READ SIGN
  527:    20AF  B2 E0                           CPL     ACC.0
  528:    20B1  F2                              MOVX    @R0,A
  529:                                  ;
  530:                                  ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  531:                                  ;
  532:    20B2                  FLOATING_ADD:
  533:                                  ;
  534:                                  ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  535:                                  ;
  536:                                  ;
  537:    20B2  71 73                           ACALL   MDES1                           ;R7=TOS EXP, R6=TOS-1 EXP, R4=TOS SIGN
  538:                                                                                                                          ;R3=TOS-1 SIGN, OPERATION IS R1 # R0
  539:                                  ;
  540:    20B4  EF                              MOV     A,R7                            ;GET TOS EXPONENT
  541:    20B5  60 0D                           JZ      POP_AND_EXIT                    ;IF TOS=0 THEN POP AND EXIT
  542:    20B7  BE 00 12                        CJNE    R6,#0,LOAD1                     ;CLEAR CARRY EXIT IF ZERO
  543:                                  ;
  544:                                  ;**************************************************************
  545:                                  ;
  546:    20BA                  SWAP_AND_EXIT:                                          ; Swap external args and return
  547:                                  ;
  548:                                  ;**************************************************************
  549:                                  ;
  550:    20BA  71 67                           ACALL   LOAD_POINTERS
  551:    20BC  7F 06                           MOV     R7,#FP_NUMBER_SIZE
  552:                                  ;
  553:    20BE  E2              SE1:            MOVX    A,@R0                           ;SWAP THE ARGUMENTS
  554:    20BF  F3                              MOVX    @R1,A
  555:    20C0  18                              DEC     R0
  556:    20C1  19                              DEC     R1
  557:    20C2  DF FA                           DJNZ    R7,SE1
  558:                                  ;
  559:    20C4                  POP_AND_EXIT:
  560:                                  ;
  561:    20C4  E5 24                           MOV     A,ARG_STACK                     ;POP THE STACK
  562:    20C6  24 06                           ADD     A,#FP_NUMBER_SIZE
  563:    20C8  F5 24                           MOV     ARG_STACK,A
  564:    20CA  E4                              CLR             A
  565:    20CB  22                              RET
  566:                                  ;
  567:                                  ;
  568:    20CC  9E              LOAD1:          SUBB    A,R6                            ;A = ARG 1 EXP - ARG 2 EXP
  569:    20CD  8F 30                           MOV     FP_EXP,R7                       ;SAVE EXPONENT AND SIGN
  570:    20CF  8C 2F                           MOV     FP_SIGN,R4
  571:    20D1  50 09                           JNC     LOAD2                           ;ARG1 EXPONENT IS LARGER OR SAME
  572:    20D3  8E 30                           MOV     FP_EXP,R6
  573:    20D5  8B 2F                           MOV     FP_SIGN,R3
  574:    20D7  F4                              CPL     A
  575:    20D8  04                              INC     A                               ;COMPENSATE FOR EXP DELTA
  576:    20D9  C8                              XCH     A,R0                            ;FORCE R0 TO POINT AT THE LARGEST
  577:    20DA  C9                              XCH     A,R1                            ;EXPONENT
  578:    20DB  C8                              XCH     A,R0
  579:                                  ;
  580:    20DC  FF              LOAD2:          MOV     R7,A                            ;SAVE THE EXPONENT DELTA IN R7
  581:    20DD  C2 33                           CLR     ADD_IN
  582:    20DF  BD 00 02                        CJNE    R5,#0,$+5
  583:    20E2  D2 33                           SETB    ADD_IN
  584:                                  ;
  585:                                  ; Load the R1 mantissa
  586:                                  ;
  587:    20E4  71 84                           ACALL   LOADR1_MANTISSA                 ;LOAD THE SMALLEST NUMBER
  588:                                  ;
  589:                                  ; Now align the number to the delta exponent
  590:                                  ; R4 points to the string of the last digits lost
  591:                                  ;
  592:    20E6  BF 0B 00                        CJNE    R7,#DIGIT+DIGIT+3,$+3
  593:    20E9  40 02                           JC      $+4
  594:    20EB  7F 0A                           MOV     R7,#DIGIT+DIGIT+2
  595:                                  ;
  596:    20ED  75 2A 00                        MOV     FP_CARRY,#00                    ;CLEAR THE CARRY
  597:    20F0  51 C4                           ACALL   RIGHT                           ;SHIFT THE NUMBER
  598:                                  ;
  599:                                  ; Set up for addition and subtraction
  600:                                  ;
  601:    20F2  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  602:    20F4  79 2E                           MOV     R1,#FP_DIG78
  603:    20F6  74 9E                           MOV     A,#9EH
  604:    20F8  C3                              CLR     C
  605:    20F9  9C                              SUBB    A,R4
  606:    20FA  D4                              DA      A
  607:    20FB  CC                              XCH     A,R4
  608:    20FC  70 01                           JNZ     $+3
  609:    20FE  FC                              MOV     R4,A
  610:    20FF  B4 50 00                        CJNE    A,#50H,$+3                      ;TEST FOR SUBTRACTION
  611:    2102  30 33 18                        JNB     ADD_IN,SUBLP                    ;DO SUBTRACTION IF NO ADD_IN
  612:    2105  B3                              CPL     C                               ;FLIP CARRY FOR ADDITION
  613:    2106  31 14                           ACALL   ADDLP                           ;DO ADDITION
  614:                                  ;
  615:    2108  50 08                           JNC     ADD_R
  616:    210A  05 2A                           INC     FP_CARRY
  617:    210C  7F 01                           MOV     R7,#1
  618:    210E  51 C4                           ACALL   RIGHT
  619:    2110  51 7B                           ACALL   INC_FP_EXP                      ;SHIFT AND BUMP EXPONENT
  620:                                  ;
  621:    2112  41 6C           ADD_R:          AJMP    STORE_ALIGN_TEST_AND_EXIT
  622:                                  ;
  623:    2114  E2              ADDLP:          MOVX    A,@R0
  624:    2115  37                              ADDC    A,@R1
  625:    2116  D4                              DA      A
  626:    2117  F7                              MOV     @R1,A
  627:    2118  18                              DEC     R0
  628:    2119  19                              DEC     R1
  629:    211A  DF F8                           DJNZ    R7,ADDLP                        ;LOOP UNTIL DONE
  630:    211C  22                              RET
  631:                                  ;
  632:                                  ;
  633:    211D  E2              SUBLP:          MOVX    A,@R0                           ;NOW DO SUBTRACTION
  634:    211E  FE                              MOV     R6,A
  635:    211F  E4                              CLR     A
  636:    2120  34 99                           ADDC    A,#99H
  637:    2122  97                              SUBB    A,@R1
  638:    2123  2E                              ADD     A,R6
  639:    2124  D4                              DA      A
  640:    2125  F7                              MOV     @R1,A
  641:    2126  18                              DEC     R0
  642:    2127  19                              DEC     R1
  643:    2128  DF F3                           DJNZ    R7,SUBLP
  644:    212A  40 11                           JC      FSUB6
  645:                                  ;
  646:                                  ;
  647:                                  ; Need to complement the result and sign because the floating
  648:                                  ; point accumulator mantissa was larger than the external
  649:                                  ; memory and their signs were equal.
  650:                                  ;
  651:    212C  B2 78                           CPL     FP_SIGN.0
  652:    212E  79 2E                           MOV     R1,#FP_DIG78
  653:    2130  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  654:                                  ;
  655:    2132  74 9A           FSUB5:          MOV     A,#9AH
  656:    2134  97                              SUBB    A,@R1
  657:    2135  24 00                           ADD     A,#0
  658:    2137  D4                              DA      A
  659:    2138  F7                              MOV     @R1,A
  660:    2139  19                              DEC     R1
  661:    213A  B3                              CPL     C
  662:    213B  DF F5                           DJNZ    R7,FSUB5                        ;LOOP
  663:                                  ;
  664:                                  ; Now see how many zeros their are
  665:                                  ;
  666:    213D  78 2B           FSUB6:          MOV     R0,#FP_DIG12
  667:    213F  7F 00                           MOV     R7,#0
  668:                                  ;
  669:    2141  E6              FSUB7:          MOV     A,@R0
  670:    2142  70 08                           JNZ     FSUB8
  671:    2144  0F                              INC     R7
  672:    2145  0F                              INC     R7
  673:    2146  08                              INC     R0
  674:    2147  B8 2F F7                        CJNE    R0,#FP_SIGN,FSUB7
  675:    214A  41 B4                           AJMP    ZERO_AND_EXIT
  676:                                  ;
  677:    214C  B4 10 00        FSUB8:          CJNE    A,#10H,$+3
  678:    214F  50 01                           JNC     FSUB9
  679:    2151  0F                              INC     R7
  680:                                  ;
  681:                                  ; Now R7 has the number of leading zeros in the FP ACC
  682:                                  ;
  683:    2152  E5 30           FSUB9:          MOV     A,FP_EXP                        ;GET THE OLD EXPONENT
  684:    2154  C3                              CLR     C
  685:    2155  9F                              SUBB    A,R7                            ;SUBTRACT FROM THE NUMBER OF ZEROS
  686:    2156  60 0B                           JZ      FSUB10
  687:    2158  40 09                           JC      FSUB10
  688:                                  ;
  689:    215A  F5 30                           MOV     FP_EXP,A                        ;SAVE THE NEW EXPONENT
  690:                                  ;
  691:    215C  51 FE                           ACALL   LEFT1                           ;SHIFT THE FP ACC
  692:    215E  75 2A 00                        MOV     FP_CARRY,#0
  693:    2161  41 6C                           AJMP    STORE_ALIGN_TEST_AND_EXIT
  694:                                  ;
  695:    2163  41 AE           FSUB10:         AJMP    UNDERFLOW_AND_EXIT
  696:                                  ;
  697:                                  ;***************************************************************
  698:                                  ;
  699:    2165                  FLOATING_COMP:  ; Compare two floating point numbers
  700:                                          ; used for relational operations and is faster
  701:                                          ; than subtraction. ON RETURN, The carry is set
  702:                                          ; if ARG1 is > ARG2, else carry is not set
  703:                                          ; if ARG1 = ARG2, F0 gets set
  704:                                  ;
  705:                                  ;***************************************************************
  706:                                  ;
  707:    2165  71 73                           ACALL   MDES1                           ;SET UP THE REGISTERS
  708:    2167  E5 24                           MOV     A,ARG_STACK
  709:    2169  24 0C                           ADD     A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
  710:    216B  F5 24                           MOV     ARG_STACK,A                     ;POP THE STACK TWICE, CLEAR THE CARRY
  711:    216D  EE                              MOV     A,R6                            ;CHECK OUT EXPONENTS
  712:    216E  C2 D5                           CLR     F0
  713:    2170  C3                              CLR     C
  714:    2171  9F                              SUBB    A,R7
  715:    2172  60 0A                           JZ      EXPONENTS_EQUAL
  716:    2174  40 03                           JC      ARG1_EXP_IS_LARGER
  717:                                  ;
  718:                                  ; Now the ARG2 EXPONENT is > ARG1 EXPONENT
  719:                                  ;
  720:    2176                  SIGNS_DIFFERENT:
  721:                                  ;
  722:    2176  EB                              MOV     A,R3                            ;SEE IF SIGN OF ARG2 IS POSITIVE
  723:    2177  80 01                           SJMP    $+3
  724:                                  ;
  725:    2179                  ARG1_EXP_IS_LARGER:
  726:                                  ;
  727:    2179  EC                              MOV     A,R4                            ;GET THE SIGN OF ARG1 EXPONENT
  728:    217A  60 01                           JZ      $+3
  729:    217C  B3                              CPL     C
  730:    217D  22                              RET
  731:                                  ;
  732:    217E                  EXPONENTS_EQUAL:
  733:                                  ;
  734:                                  ; First, test the sign, then the mantissa
  735:                                  ;
  736:    217E  BD 00 F5                        CJNE    R5,#0,SIGNS_DIFFERENT
  737:                                  ;
  738:    2181                  BOTH_PLUS:
  739:                                  ;
  740:    2181  7F 04                           MOV     R7,#DIGIT                       ;POINT AT MS DIGIT
  741:    2183  18                              DEC     R0
  742:    2184  18                              DEC     R0
  743:    2185  18                              DEC     R0
  744:    2186  19                              DEC     R1
  745:    2187  19                              DEC     R1
  746:    2188  19                              DEC     R1
  747:                                  ;
  748:                                  ; Now do the compare
  749:                                  ;
  750:    2189  E2              CLOOP:          MOVX    A,@R0
  751:    218A  FE                              MOV     R6,A
  752:    218B  E3                              MOVX    A,@R1
  753:    218C  9E                              SUBB    A,R6
  754:    218D  70 EA                           JNZ     ARG1_EXP_IS_LARGER
  755:    218F  08                              INC     R0
  756:    2190  09                              INC     R1
  757:    2191  DF F6                           DJNZ    R7,CLOOP
  758:                                  ;
  759:                                  ; If here, the numbers are the same, the carry is cleared
  760:                                  ;
  761:    2193  D2 D5                           SETB    F0
  762:    2195  22                              RET                                     ;EXIT WITH EQUAL
  763:                                  ;
  764:                          ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  765:                          ;
  766:    2196                  FLOATING_MUL:                                           ; Floating point multiply
  767:                          ;
  768:                          ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  769:                          ;
  770:    2196  71 71                           ACALL   MUL_DIV_EXP_AND_SIGN
  771:                                  ;
  772:                                  ; check for zero exponents
  773:                                  ;
  774:    2198  BE 00 02                        CJNE    R6,#00,$+5                      ;ARG 2 EXP ZERO?
  775:    219B  41 B4                           AJMP    ZERO_AND_EXIT
  776:                                  ;
  777:                                  ; calculate the exponent
  778:                                  ;
  779:    219D  8D 2F           FMUL1:          MOV     FP_SIGN,R5                      ;SAVE THE SIGN, IN CASE OF FAILURE
  780:                                  ;
  781:    219F  EF                              MOV     A,R7
  782:    21A0  60 F9                           JZ      FMUL1-2
  783:    21A2  2E                              ADD     A,R6                            ;ADD THE EXPONENTS
  784:    21A3  20 E7 05                        JB      ACC.7,FMUL_OVER
  785:    21A6  10 D7 06                        JBC     CY,FMUL2                        ;SEE IF CARRY IS SET
  786:                                  ;
  787:    21A9  41 AE                           AJMP    UNDERFLOW_AND_EXIT
  788:                                  ;
  789:    21AB                  FMUL_OVER:
  790:                                  ;
  791:    21AB  50 02                           JNC     FMUL2                           ;OK IF SET
  792:                                  ;
  793:    21AD  41 9D           FOV:            AJMP    OVERFLOW_AND_EXIT
  794:                                  ;
  795:    21AF  94 81           FMUL2:          SUBB    A,#129                          ;SUBTRACT THE EXPONENT BIAS
  796:    21B1  FE                              MOV     R6,A                            ;SAVE IT FOR LATER
  797:                                  ;
  798:                                  ; Unpack and load R0
  799:                                  ;
  800:    21B2  51 87                           ACALL   UNPACK_R0
  801:                                  ;
  802:                                  ; Now set up for loop multiply
  803:                                  ;
  804:    21B4  7B 04                           MOV     R3,#DIGIT
  805:    21B6  AC 01                           MOV     R4,R1B0
  806:                                  ;
  807:                                  ;
  808:                                  ; Now, do the multiply and accumulate the product
  809:                                  ;
  810:    21B8  8C 01           FMUL3:          MOV     R1B0,R4
  811:    21BA  E3                              MOVX    A,@R1
  812:    21BB  FA                              MOV     R2,A
  813:    21BC  71 34                           ACALL   MUL_NIBBLE
  814:                                  ;
  815:    21BE  EA                              MOV     A,R2
  816:    21BF  C4                              SWAP    A
  817:    21C0  71 34                           ACALL   MUL_NIBBLE
  818:    21C2  1C                              DEC     R4
  819:    21C3  DB F3                           DJNZ    R3,FMUL3
  820:                                  ;
  821:                                  ; Now, pack and restore the sign
  822:                                  ;
  823:    21C5  8E 30                           MOV     FP_EXP,R6
  824:    21C7  8D 2F                           MOV     FP_SIGN,R5
  825:    21C9  41 2C                           AJMP    PACK                            ;FINISH IT OFF
  826:                                  ;
  827:                                  ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  828:                                  ;
  829:    21CB                  FLOATING_DIV:
  830:                                  ;
  831:                                  ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  832:                                  ;
  833:    21CB  71 73                           ACALL   MDES1
  834:                                  ;
  835:                                  ; Check the exponents
  836:                                  ;
  837:    21CD  8D 2F                           MOV     FP_SIGN,R5                      ;SAVE THE SIGN
  838:    21CF  BF 00 06                        CJNE    R7,#0,DIV0                      ;CLEARS THE CARRY
  839:    21D2  51 9D                           ACALL   OVERFLOW_AND_EXIT
  840:    21D4  E4                              CLR     A
  841:    21D5  D2 E3                           SETB    ACC.ZERO_DIVIDE
  842:    21D7  22                              RET
  843:                                  ;
  844:    21D8  EE              DIV0:           MOV     A,R6                            ;GET EXPONENT
  845:    21D9  60 C0                           JZ      FMUL1-2                         ;EXIT IF ZERO
  846:    21DB  9F                              SUBB    A,R7                            ;DELTA EXPONENT
  847:    21DC  20 E7 04                        JB      ACC.7,D_UNDER
  848:    21DF  50 04                           JNC     DIV3
  849:    21E1  41 AE                           AJMP    UNDERFLOW_AND_EXIT
  850:                                  ;
  851:    21E3  50 C8           D_UNDER:        JNC     FOV
  852:                                  ;
  853:    21E5  24 81           DIV3:           ADD     A,#129                          ;CORRECTLY BIAS THE EXPONENT
  854:    21E7  F5 30                           MOV     FP_EXP,A                        ;SAVE THE EXPONENT
  855:    21E9  71 84                           ACALL   LOADR1_MANTISSA                 ;LOAD THE DIVIDED
  856:                                  ;
  857:    21EB  7A 34                           MOV     R2,#FP_ACCC                     ;SAVE LOCATION
  858:    21ED  AB 00                           MOV     R3,R0B0                         ;SAVE POINTER IN R3
  859:    21EF  75 2A 00                        MOV     FP_CARRY,#0                     ;ZERO CARRY BYTE
  860:                                  ;
  861:    21F2  7D FF           DIV4:           MOV     R5,#0FFH                        ;LOOP COUNT
  862:    21F4  D3                              SETB    C
  863:                                  ;
  864:    21F5  8B 00           DIV5:           MOV     R0B0,R3                         ;RESTORE THE EXTERNAL POINTER
  865:    21F7  79 2E                           MOV     R1,#FP_DIG78                    ;SET UP INTERNAL POINTER
  866:    21F9  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  867:    21FB  50 17                           JNC     DIV7                            ;EXIT IF NO CARRY
  868:                                  ;
  869:    21FD  E2              DIV6:           MOVX    A,@R0                           ;DO ACCUMLATION
  870:    21FE  FE                              MOV     R6,A
  871:    21FF  E4                              CLR     A
  872:    2200  34 99                           ADDC    A,#99H
  873:    2202  9E                              SUBB    A,R6
  874:    2203  27                              ADD     A,@R1
  875:    2204  D4                              DA      A
  876:    2205  F7                              MOV     @R1,A
  877:    2206  18                              DEC     R0
  878:    2207  19                              DEC     R1
  879:    2208  DF F3                           DJNZ    R7,DIV6                         ;LOOP
  880:                                  ;
  881:    220A  0D                              INC     R5                              ;SUBTRACT COUNTER
  882:    220B  40 E8                           JC      DIV5                            ;KEEP LOOPING IF CARRY
  883:    220D  E7                              MOV     A,@R1                           ;GET CARRY
  884:    220E  94 01                           SUBB    A,#1                            ;CARRY IS CLEARED
  885:    2210  F7                              MOV     @R1,A                           ;SAVE CARRY DIGIT
  886:    2211  B3                              CPL     C
  887:    2212  80 E1                           SJMP    DIV5                            ;LOOP
  888:                                  ;
  889:                                  ; Restore the result if carry was found
  890:                                  ;
  891:    2214  31 14           DIV7:           ACALL   ADDLP                           ;ADD NUMBER BACK
  892:    2216  77 00                           MOV     @R1,#0                          ;CLEAR CARRY
  893:    2218  8A 00                           MOV     R0B0,R2                         ;GET SAVE COUNTER
  894:    221A  A6 05                           MOV     @R0,5                           ;SAVE COUNT BYTE
  895:                                  ;
  896:    221C  0A                              INC     R2                              ;ADJUST SAVE COUNTER
  897:    221D  7F 01                           MOV     R7,#1                           ;BUMP DIVIDEND
  898:    221F  51 FC                           ACALL   LEFT
  899:    2221  BA 3E CE                        CJNE    R2,#FP_ACC8+2,DIV4
  900:                                  ;
  901:    2224  D5 30 02                        DJNZ    FP_EXP,DIV8
  902:    2227  41 AE                           AJMP    UNDERFLOW_AND_EXIT
  903:                                  ;
  904:    2229  75 2A 00        DIV8:           MOV     FP_CARRY,#0
  905:                                  ;
  906:                                  ;***************************************************************
  907:                                  ;
  908:    222C                  PACK:   ; Pack the mantissa
  909:                                  ;
  910:                                  ;***************************************************************
  911:                                  ;
  912:                                  ; First, set up the pointers
  913:                                  ;
  914:    222C  78 34                           MOV     R0,#FP_ACCC
  915:    222E  E6                              MOV     A,@R0                           ;GET FP_ACCC
  916:    222F  FE                              MOV     R6,A                            ;SAVE FOR ZERO COUNT
  917:    2230  60 03                           JZ      PACK0                           ;JUMP OVER IF ZERO
  918:    2232  51 7B                           ACALL   INC_FP_EXP                      ;BUMP THE EXPONENT
  919:    2234  18                              DEC     R0
  920:                                  ;
  921:    2235  08              PACK0:          INC     R0                              ;POINT AT FP_ACC1
  922:                                  ;
  923:    2236  74 08           PACK1:          MOV     A,#8                            ;ADJUST NIBBLE POINTER
  924:    2238  F9                              MOV     R1,A
  925:    2239  28                              ADD     A,R0
  926:    223A  F8                              MOV     R0,A
  927:    223B  B6 05 00                        CJNE    @R0,#5,$+3                      ;SEE IF ADJUSTING NEEDED
  928:    223E  40 13                           JC      PACK3+1
  929:                                  ;
  930:    2240  D3              PACK2:          SETB    C
  931:    2241  E4                              CLR     A
  932:    2242  18                              DEC     R0
  933:    2243  36                              ADDC    A,@R0
  934:    2244  D4                              DA      A
  935:    2245  D6                              XCHD    A,@R0                           ;SAVE THE VALUE
  936:    2246  30 E4 09                        JNB     ACC.4,PACK3
  937:    2249  D9 F5                           DJNZ    R1,PACK2
  938:                                  ;
  939:    224B  18                              DEC     R0
  940:    224C  76 01                           MOV     @R0,#1
  941:    224E  51 7B                           ACALL   INC_FP_EXP
  942:    2250  80 06                           SJMP    PACK4
  943:                                  ;
  944:    2252  19              PACK3:          DEC     R1
  945:    2253  E9                              MOV     A,R1
  946:    2254  C3                              CLR     C
  947:    2255  C8                              XCH     A,R0
  948:    2256  98                              SUBB    A,R0
  949:    2257  F8                              MOV     R0,A
  950:                                  ;
  951:    2258  79 2B           PACK4:          MOV     R1,#FP_DIG12
  952:                                  ;
  953:                                  ; Now, pack
  954:                                  ;
  955:    225A  E6              PLOOP:          MOV     A,@R0
  956:    225B  C4                              SWAP    A                               ;FLIP THE DIGITS
  957:    225C  08                              INC     R0
  958:    225D  D6                              XCHD    A,@R0
  959:    225E  42 06                           ORL     6,A                             ;ACCUMULATE THE OR'ED DIGITS
  960:    2260  F7                              MOV     @R1,A
  961:    2261  08                              INC     R0
  962:    2262  09                              INC     R1
  963:    2263  B9 2F F4                        CJNE    R1,#FP_SIGN,PLOOP
  964:    2266  EE                              MOV     A,R6
  965:    2267  70 03                           JNZ     STORE_ALIGN_TEST_AND_EXIT
  966:    2269  75 30 00                        MOV     FP_EXP,#0                       ;ZERO EXPONENT
  967:                                  ;
  968:                                  ;**************************************************************
  969:                                  ;
  970:    226C                  STORE_ALIGN_TEST_AND_EXIT:                              ;Save the number align carry and exit
  971:                                  ;
  972:                                  ;**************************************************************
  973:                                  ;
  974:    226C  71 67                           ACALL   LOAD_POINTERS
  975:    226E  89 24                           MOV     ARG_STACK,R1                    ;SET UP THE NEW STACK
  976:    2270  78 30                           MOV     R0,#FP_EXP
  977:                                  ;
  978:                                  ; Now load the numbers
  979:                                  ;
  980:    2272  E6              STORE2:         MOV     A,@R0
  981:    2273  F3                              MOVX    @R1,A                           ;SAVE THE NUMBER
  982:    2274  18                              DEC     R0
  983:    2275  19                              DEC     R1
  984:    2276  B8 2A F9                        CJNE    R0,#FP_CARRY,STORE2
  985:                                  ;
  986:    2279  E4                              CLR     A                               ;NO ERRORS
  987:                                  ;
  988:    227A  22              PRET:           RET                                     ;EXIT
  989:                                  ;
  990:    227B                  INC_FP_EXP:
  991:                                  ;
  992:    227B  05 30                           INC     FP_EXP
  993:    227D  E5 30                           MOV     A,FP_EXP
  994:    227F  70 F9                           JNZ     PRET                            ;EXIT IF NOT ZERO
  995:    2281  D0 E0                           POP     ACC                             ;WASTE THE CALLING STACK
  996:    2283  D0 E0                           POP     ACC
  997:    2285  41 9D                           AJMP    OVERFLOW_AND_EXIT
  998:                                  ;
  999:                          ;***********************************************************************
 1000:                          ;
 1001:    2287                  UNPACK_R0:      ; Unpack BCD digits and load into nibble locations
 1002:                          ;
 1003:                          ;***********************************************************************
 1004:                                  ;
 1005:    2287  C0 01                           PUSH    R1B0
 1006:    2289  79 32                           MOV     R1,#FP_NIB8
 1007:                                  ;
 1008:    228B  E2              ULOOP:          MOVX    A,@R0
 1009:    228C  54 0F                           ANL     A,#0FH
 1010:    228E  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE
 1011:    228F  E2                              MOVX    A,@R0
 1012:    2290  C4                              SWAP    A
 1013:    2291  54 0F                           ANL     A,#0FH
 1014:    2293  19                              DEC     R1
 1015:    2294  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE AGAIN
 1016:    2295  18                              DEC     R0
 1017:    2296  19                              DEC     R1
 1018:    2297  B9 2A F1                        CJNE    R1,#FP_NIB1-1,ULOOP
 1019:                                  ;
 1020:    229A  D0 01                           POP     R1B0
 1021:                                  ;
 1022:    229C  22              LOAD7:          RET
 1023:                                  ;
 1024:                                  ;**************************************************************
 1025:                                  ;
 1026:    229D                  OVERFLOW_AND_EXIT:      ;LOAD 99999999 E+127,  SET OV BIT, AND EXIT
 1027:                                  ;
 1028:                                  ;**************************************************************
 1029:                                  ;
 1030:    229D  78 2E                           MOV     R0,#FP_DIG78
 1031:    229F  74 99                           MOV     A,#99H
 1032:                                  ;
 1033:    22A1  F6              OVE1:           MOV     @R0,A
 1034:    22A2  18                              DEC     R0
 1035:    22A3  B8 2A FB                        CJNE    R0,#FP_CARRY,OVE1
 1036:                                  ;
 1037:    22A6  75 30 FF                        MOV     FP_EXP,#0FFH
 1038:    22A9  51 6C                           ACALL   STORE_ALIGN_TEST_AND_EXIT
 1039:                                  ;
 1040:    22AB  D2 E1                           SETB    ACC.OVERFLOW
 1041:    22AD  22                              RET
 1042:                                  ;
 1043:                                  ;**************************************************************
 1044:                                  ;
 1045:    22AE                  UNDERFLOW_AND_EXIT:     ;LOAD 0, SET UF BIT, AND EXIT
 1046:                                  ;
 1047:                                  ;**************************************************************
 1048:                                  ;
 1049:    22AE  51 B4                           ACALL   ZERO_AND_EXIT
 1050:    22B0  E4                              CLR     A
 1051:    22B1  D2 E0                           SETB    ACC.UNDERFLOW
 1052:    22B3  22                              RET
 1053:                                  ;
 1054:                                  ;**************************************************************
 1055:                                  ;
 1056:    22B4                  ZERO_AND_EXIT:          ;LOAD 0, SET ZERO BIT, AND EXIT
 1057:                                  ;
 1058:                                  ;**************************************************************
 1059:                                  ;
 1060:    22B4  51 BB                           ACALL   FP_CLEAR
 1061:    22B6  51 6C                           ACALL   STORE_ALIGN_TEST_AND_EXIT
 1062:    22B8  D2 E2                           SETB    ACC.ZERO
 1063:    22BA  22                              RET                                     ;EXIT
 1064:                                  ;
 1065:                                  ;**************************************************************
 1066:                                  ;
 1067:    22BB                  FP_CLEAR:
 1068:                                  ;
 1069:                                  ; Clear internal storage
 1070:                                  ;
 1071:                                  ;**************************************************************
 1072:                                  ;
 1073:    22BB  E4                              CLR     A
 1074:    22BC  78 3D                           MOV     R0,#FP_ACC8+1
 1075:                                  ;
 1076:    22BE  F6              FPC1:           MOV     @R0,A
 1077:    22BF  18                              DEC     R0
 1078:    22C0  B8 29 FB                        CJNE    R0,#FP_TEMP,FPC1
 1079:    22C3  22                              RET
 1080:                                  ;
 1081:                                  ;**************************************************************
 1082:                                  ;
 1083:    22C4                  RIGHT:  ; Shift ACCUMULATOR RIGHT the number of nibbles in R7
 1084:                                  ; Save the shifted values in R4 if SAVE_ROUND is set
 1085:                                  ;
 1086:                                  ;**************************************************************
 1087:                                  ;
 1088:    22C4  7C 00                           MOV     R4,#0                           ;IN CASE OF NO SHIFT
 1089:                                  ;
 1090:    22C6  C3              RIGHT1:         CLR     C
 1091:    22C7  EF                              MOV     A,R7                            ;GET THE DIGITS TO SHIFT
 1092:    22C8  60 22                           JZ      RIGHT5-1                        ;EXIT IF ZERO
 1093:    22CA  94 02                           SUBB    A,#2                            ;TWO TO DO?
 1094:    22CC  50 1F                           JNC     RIGHT5                          ;SHIFT TWO NIBBLES
 1095:                                  ;
 1096:                                  ; Swap one nibble then exit
 1097:                                  ;
 1098:    22CE  C0 00           RIGHT3:         PUSH    R0B0                            ;SAVE POINTER REGISTER
 1099:    22D0  C0 01                           PUSH    R1B0
 1100:                                  ;
 1101:    22D2  79 2E                           MOV     R1,#FP_DIG78                    ;LOAD THE POINTERS
 1102:    22D4  78 2D                           MOV     R0,#FP_DIG56
 1103:    22D6  EC                              MOV     A,R4                            ;GET THE OVERFLOW REGISTER
 1104:    22D7  D7                              XCHD    A,@R1                           ;GET DIGIT 8
 1105:    22D8  C4                              SWAP    A                               ;FLIP FOR LOAD
 1106:    22D9  FC                              MOV     R4,A
 1107:                                  ;
 1108:    22DA  E7              RIGHTL:         MOV     A,@R1                           ;GET THE LOW ORDER BYTE
 1109:    22DB  D6                              XCHD    A,@R0                           ;SWAP NIBBLES
 1110:    22DC  C4                              SWAP    A                               ;FLIP FOR STORE
 1111:    22DD  F7                              MOV     @R1,A                           ;SAVE THE DIGITS
 1112:    22DE  18                              DEC     R0                              ;BUMP THE POINTERS
 1113:    22DF  19                              DEC     R1
 1114:    22E0  B9 2A F7                        CJNE    R1,#FP_DIG12-1,RIGHTL           ;LOOP
 1115:                                  ;
 1116:    22E3  E7                              MOV     A,@R1                           ;ACC = CH8
 1117:    22E4  C4                              SWAP    A                               ;ACC = 8CH
 1118:    22E5  54 0F                           ANL     A,#0FH                          ;ACC = 0CH
 1119:    22E7  F7                              MOV     @R1,A                           ;CARRY DONE
 1120:    22E8  D0 01                           POP     R1B0                            ;EXIT
 1121:    22EA  D0 00                           POP     R0B0                            ;RESTORE REGISTER
 1122:    22EC  22                              RET
 1123:                                  ;
 1124:    22ED  FF              RIGHT5:         MOV     R7,A                            ;SAVE THE NEW SHIFT NUMBER
 1125:    22EE  E4                              CLR     A
 1126:    22EF  C5 2A                           XCH     A,FP_CARRY                      ;SWAP THE NIBBLES
 1127:    22F1  C5 2B                           XCH     A,FP_DIG12
 1128:    22F3  C5 2C                           XCH     A,FP_DIG34
 1129:    22F5  C5 2D                           XCH     A,FP_DIG56
 1130:    22F7  C5 2E                           XCH     A,FP_DIG78
 1131:    22F9  FC                              MOV     R4,A                            ;SAVE THE LAST DIGIT SHIFTED
 1132:    22FA  80 CB                           SJMP    RIGHT1+1
 1133:                                  ;
 1134:                                  ;***************************************************************
 1135:                                  ;
 1136:    22FC                  LEFT:   ; Shift ACCUMULATOR LEFT the number of nibbles in R7
 1137:                                  ;
 1138:                                  ;***************************************************************
 1139:                                  ;
 1140:    22FC  7C 00                           MOV     R4,#00H                         ;CLEAR FOR SOME ENTRYS
 1141:                                  ;
 1142:    22FE  C3              LEFT1:          CLR     C
 1143:    22FF  EF                              MOV     A,R7                            ;GET SHIFT VALUE
 1144:    2300  60 22                           JZ      LEFT5-1                         ;EXIT IF ZERO
 1145:    2302  94 02                           SUBB    A,#2                            ;SEE HOW MANY BYTES TO SHIFT
 1146:    2304  50 1F                           JNC     LEFT5
 1147:                                  ;
 1148:    2306  C0 00           LEFT3:          PUSH    R0B0                            ;SAVE POINTER
 1149:    2308  C0 01                           PUSH    R1B0
 1150:    230A  78 2A                           MOV     R0,#FP_CARRY
 1151:    230C  79 2B                           MOV     R1,#FP_DIG12
 1152:                                  ;
 1153:    230E  E6                              MOV     A,@R0                           ;ACC=CHCL
 1154:    230F  C4                              SWAP    A                               ;ACC = CLCH
 1155:    2310  F6                              MOV     @R0,A                           ;ACC = CLCH, @R0 = CLCH
 1156:                                  ;
 1157:    2311  E7              LEFTL:          MOV     A,@R1                           ;DIG 12
 1158:    2312  C4                              SWAP    A                               ;DIG 21
 1159:    2313  D6                              XCHD    A,@R0
 1160:    2314  F7                              MOV     @R1,A                           ;SAVE IT
 1161:    2315  08                              INC     R0                              ;BUMP POINTERS
 1162:    2316  09                              INC     R1
 1163:    2317  B8 2E F7                        CJNE    R0,#FP_DIG78,LEFTL
 1164:                                  ;
 1165:    231A  EC                              MOV     A,R4
 1166:    231B  C4                              SWAP    A
 1167:    231C  D6                              XCHD    A,@R0
 1168:    231D  54 F0                           ANL     A,#0F0H
 1169:    231F  FC                              MOV     R4,A
 1170:                                  ;
 1171:    2320  D0 01                           POP     R1B0
 1172:    2322  D0 00                           POP     R0B0                            ;RESTORE
 1173:    2324  22                              RET                                     ;DONE
 1174:                                  ;
 1175:    2325  FF              LEFT5:          MOV     R7,A                            ;RESTORE COUNT
 1176:    2326  E4                              CLR     A
 1177:    2327  CC                              XCH     A,R4                            ;GET THE RESTORATION BYTE
 1178:    2328  C5 2E                           XCH     A,FP_DIG78                      ;DO THE SWAP
 1179:    232A  C5 2D                           XCH     A,FP_DIG56
 1180:    232C  C5 2C                           XCH     A,FP_DIG34
 1181:    232E  C5 2B                           XCH     A,FP_DIG12
 1182:    2330  C5 2A                           XCH     A,FP_CARRY
 1183:    2332  80 CB                           SJMP    LEFT1+1
 1184:                                  ;
 1185:    2334                  MUL_NIBBLE:
 1186:                                  ;
 1187:                                  ; Multiply the nibble in R7 by the FP_NIB locations
 1188:                                  ; accumulate the product in FP_ACC
 1189:                                  ;
 1190:                                  ; Set up the pointers for multiplication
 1191:                                  ;
 1192:    2334  54 0F                           ANL     A,#0FH                          ;STRIP OFF MS NIBBLE
 1193:    2336  FF                              MOV     R7,A
 1194:    2337  78 3C                           MOV     R0,#FP_ACC8
 1195:    2339  79 32                           MOV     R1,#FP_NIB8
 1196:    233B  E4                              CLR     A
 1197:    233C  F5 33                           MOV     FP_ACCX,A
 1198:                                  ;
 1199:    233E  18              MNLOOP:         DEC     R0                              ;BUMP POINTER TO PROPAGATE CARRY
 1200:    233F  26                              ADD     A,@R0                           ;ATTEMPT TO FORCE CARRY
 1201:    2340  D4                              DA      A                               ;BCD ADJUST
 1202:    2341  30 E4 03                        JNB     ACC.4,MNL0                      ;DON'T ADJUST IF NO NEED
 1203:    2344  18                              DEC     R0                              ;PROPAGATE CARRY TO THE NEXT DIGIT
 1204:    2345  06                              INC     @R0                             ;DO THE ADJUSTING
 1205:    2346  08                              INC     R0                              ;RESTORE R0
 1206:                                  ;
 1207:    2347  D6              MNL0:           XCHD    A,@R0                           ;RESTORE INITIAL NUMBER
 1208:    2348  8F F0                           MOV     B,R7                            ;GET THE NUBBLE TO MULTIPLY
 1209:    234A  E7                              MOV     A,@R1                           ;GET THE OTHER NIBBLE
 1210:    234B  A4                              MUL     AB                              ;DO THE MULTIPLY
 1211:    234C  75 F0 0A                        MOV     B,#10                           ;NOW BCD ADJUST
 1212:    234F  84                              DIV     AB
 1213:    2350  C5 F0                           XCH     A,B                             ;GET THE REMAINDER
 1214:    2352  26                              ADD     A,@R0                           ;PROPAGATE THE PARTIAL PRODUCTS
 1215:    2353  D4                              DA      A                               ;BCD ADJUST
 1216:    2354  30 E4 02                        JNB     ACC.4,MNL1                      ;PROPAGATE PARTIAL PRODUCT CARRY
 1217:    2357  05 F0                           INC     B
 1218:                                  ;
 1219:    2359  08              MNL1:           INC     R0
 1220:    235A  D6                              XCHD    A,@R0                           ;SAVE THE NEW PRODUCT
 1221:    235B  18                              DEC     R0
 1222:    235C  E5 F0                           MOV     A,B                             ;GET BACK THE QUOTIENT
 1223:    235E  19                              DEC     R1
 1224:    235F  B9 2A DC                        CJNE    R1,#FP_NIB1-1,MNLOOP
 1225:                                  ;
 1226:    2362  25 33                           ADD     A,FP_ACCX                       ;GET THE OVERFLOW
 1227:    2364  D4                              DA      A                               ;ADJUST
 1228:    2365  F6                              MOV     @R0,A                           ;SAVE IT
 1229:    2366  22                              RET                                     ;EXIT
 1230:                                  ;
 1231:                                  ;***************************************************************
 1232:                                  ;
 1233:    2367                  LOAD_POINTERS:  ; Load the ARG_STACK into R0 and bump R1
 1234:                                  ;
 1235:                                  ;***************************************************************
 1236:                                  ;
 1237:    2367  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1238:    236A  A8 24                           MOV     R0,ARG_STACK
 1239:    236C  74 06                           MOV     A,#FP_NUMBER_SIZE
 1240:    236E  28                              ADD     A,R0
 1241:    236F  F9                              MOV     R1,A
 1242:    2370  22                              RET
 1243:                                  ;
 1244:                                  ;***************************************************************
 1245:                                  ;
 1246:    2371                  MUL_DIV_EXP_AND_SIGN:
 1247:                                  ;
 1248:                                  ; Load the sign into R7, R6. R5 gets the sign for
 1249:                                  ; multiply and divide.
 1250:                                  ;
 1251:                                  ;***************************************************************
 1252:                                  ;
 1253:    2371  51 BB                           ACALL   FP_CLEAR                        ;CLEAR INTERNAL MEMORY
 1254:                                  ;
 1255:    2373  71 67           MDES1:          ACALL   LOAD_POINTERS                   ;LOAD REGISTERS
 1256:    2375  E2                              MOVX    A,@R0                           ;ARG 1 EXP
 1257:    2376  FF                              MOV     R7,A                            ;SAVED IN R7
 1258:    2377  E3                              MOVX    A,@R1                           ;ARG 2 EXP
 1259:    2378  FE                              MOV     R6,A                            ;SAVED IN R6
 1260:    2379  18                              DEC     R0                              ;BUMP POINTERS TO SIGN
 1261:    237A  19                              DEC     R1
 1262:    237B  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1263:    237C  FC                              MOV     R4,A                            ;SIGN OF ARG1
 1264:    237D  E3                              MOVX    A,@R1                           ;GET SIGN OF NEXT ARG
 1265:    237E  FB                              MOV     R3,A                            ;SIGN OF ARG2
 1266:    237F  6C                              XRL     A,R4                            ;ACC GETS THE NEW SIGN
 1267:    2380  FD                              MOV     R5,A                            ;R5 GETS THE NEW SIGN
 1268:                                  ;
 1269:                                  ; Bump the pointers to point at the LS digit
 1270:                                  ;
 1271:    2381  18                              DEC     R0
 1272:    2382  19                              DEC     R1
 1273:                                  ;
 1274:    2383  22                              RET
 1275:                                  ;
 1276:                                  ;***************************************************************
 1277:                                  ;
 1278:    2384                  LOADR1_MANTISSA:
 1279:                                  ;
 1280:                                  ; Load the mantissa of R0 into FP_Digits
 1281:                                  ;
 1282:                                  ;***************************************************************
 1283:                                  ;
 1284:    2384  C0 00                           PUSH    R0B0                            ;SAVE REGISTER 1
 1285:    2386  78 2E                           MOV     R0,#FP_DIG78                    ;SET UP THE POINTER
 1286:                                  ;
 1287:    2388  E3              LOADR1:         MOVX    A,@R1
 1288:    2389  F6                              MOV     @R0,A
 1289:    238A  19                              DEC     R1
 1290:    238B  18                              DEC     R0
 1291:    238C  B8 2A F9                        CJNE    R0,#FP_CARRY,LOADR1
 1292:                                  ;
 1293:    238F  D0 00                           POP     R0B0
 1294:    2391  22                              RET
 1295:                                  ;
 1296:                                  ;***************************************************************
 1297:                                  ;
 1298:    2392                  HEXSCAN:        ; Scan a string to determine if it is a hex number
 1299:                                          ; set carry if hex, else carry = 0
 1300:                                  ;
 1301:                                  ;***************************************************************
 1302:                                  ;
 1303:    2392  91 68                           ACALL   GET_DPTR_CHARACTER
 1304:    2394  C0 83                           PUSH    DPH
 1305:    2396  C0 82                           PUSH    DPL                             ;SAVE THE POINTER
 1306:                                  ;
 1307:    2398  E0              HEXSC1:         MOVX    A,@DPTR                         ;GET THE CHARACTER
 1308:    2399  D1 76                           ACALL   DIGIT_CHECK                     ;SEE IF A DIGIT
 1309:    239B  40 12                           JC      HS1                             ;CONTINUE IF A DIGIT
 1310:    239D  71 B2                           ACALL   HEX_CHECK                       ;SEE IF HEX
 1311:    239F  40 0E                           JC      HS1
 1312:                                  ;
 1313:    23A1  C2 E5                           CLR     ACC.5                           ;NO LOWER CASE
 1314:    23A3  B4 48 03                        CJNE    A,#'H',HEXDON
 1315:    23A6  D3                              SETB    C
 1316:    23A7  80 01                           SJMP    HEXDO1                          ;NUMBER IS VALID HEX, MAYBE
 1317:                                  ;
 1318:    23A9  C3              HEXDON:         CLR     C
 1319:                                  ;
 1320:    23AA  D0 82           HEXDO1:         POP     DPL                             ;RESTORE POINTER
 1321:    23AC  D0 83                           POP     DPH
 1322:    23AE  22                              RET
 1323:                                  ;
 1324:    23AF  A3              HS1:            INC     DPTR                            ;BUMP TO NEXT CHARACTER
 1325:    23B0  80 E6                           SJMP    HEXSC1                          ;LOOP
 1326:                                  ;
 1327:    23B2                  HEX_CHECK:      ;CHECK FOR A VALID ASCII HEX, SET CARRY IF FOUND
 1328:                                  ;
 1329:    23B2  C2 E5                           CLR     ACC.5                           ;WASTE LOWER CASE
 1330:    23B4  B4 47 00                        CJNE    A,#'F'+1,$+3                    ;SEE IF F OR LESS
 1331:    23B7  40 01                           JC      HC1
 1332:    23B9  22                              RET
 1333:                                  ;
 1334:    23BA  B4 41 00        HC1:            CJNE    A,#'A',$+3                      ;SEE IF A OR GREATER
 1335:    23BD  B3                              CPL     C
 1336:    23BE  22                              RET
 1337:                                  ;
 1338:                                  ;
 1339:    23BF                  PUSHR2R0:
 1340:                                  ;
 1341:    23BF  7B 00                           MOV     R3,#HIGH CONVT                  ;CONVERSION LOCATION
 1342:    23C1  79 48                           MOV     R1,#LOW CONVT
 1343:    23C3  D1 00                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1344:    23C5  74 0D                           MOV     A,#0DH                          ;A CR TO TERMINATE
 1345:    23C7  F3                              MOVX    @R1,A                           ;SAVE THE CR
 1346:    23C8  90 00 48                        MOV     DPTR,#CONVT
 1347:                                  ;
 1348:                                  ; Falls thru to FLOATING INPUT
 1349:                                  ;
 1350:                                  ;***************************************************************
 1351:                                  ;
 1352:    23CB                  FLOATING_POINT_INPUT:   ; Input a floating point number pointed to by
 1353:                                                                          ; the DPTR
 1354:                                  ;
 1355:                                  ;***************************************************************
 1356:                                  ;
 1357:    23CB  51 BB                           ACALL   FP_CLEAR                        ;CLEAR EVERYTHING
 1358:    23CD  91 68                           ACALL   GET_DPTR_CHARACTER
 1359:    23CF  91 6E                           ACALL   PLUS_MINUS_TEST
 1360:    23D1  92 78                           MOV     MSIGN,C                         ;SAVE THE MANTISSA SIGN
 1361:                                  ;
 1362:                                  ; Now, set up for input loop
 1363:                                  ;
 1364:    23D3  78 34                           MOV     R0,#FP_ACCC
 1365:    23D5  7E 7F                           MOV     R6,#7FH                         ;BASE EXPONENT
 1366:    23D7  D2 D5                           SETB    F0                              ;SET INITIAL FLAG
 1367:                                  ;
 1368:    23D9  D1 74           INLOOP:         ACALL   GET_DIGIT_CHECK
 1369:    23DB  50 07                           JNC     GTEST                           ;IF NOT A CHARACTER, WHAT IS IT?
 1370:    23DD  54 0F                           ANL     A,#0FH                          ;STRIP ASCII
 1371:    23DF  91 41                           ACALL   STDIG                           ;STORE THE DIGITS
 1372:                                  ;
 1373:    23E1  A3              INLPIK:         INC     DPTR                            ;BUMP POINTER FOR LOOP
 1374:    23E2  80 F5                           SJMP    INLOOP                          ;LOOP FOR INPUT
 1375:                                  ;
 1376:    23E4  B4 2E 0C        GTEST:          CJNE    A,#'.',GT1                      ;SEE IF A RADIX
 1377:    23E7  20 51 63                        JB      FOUND_RADIX,INERR
 1378:    23EA  D2 51                           SETB    FOUND_RADIX
 1379:    23EC  B8 34 F2                        CJNE    R0,#FP_ACCC,INLPIK
 1380:    23EF  D2 52                           SETB    FIRST_RADIX                     ;SET IF FIRST RADIX
 1381:    23F1  80 EE                           SJMP    INLPIK                          ;GET ADDITIONAL DIGITS
 1382:                                  ;
 1383:    23F3  20 D5 57        GT1:            JB      F0,INERR                        ;ERROR IF NOT CLEARED
 1384:    23F6  B4 65 02                        CJNE    A,#'e',$+5                      ;CHECK FOR LOWER CASE
 1385:    23F9  80 03                           SJMP    $+5
 1386:    23FB  B4 45 33                        CJNE    A,#'E',FINISH_UP
 1387:    23FE  91 67                           ACALL   INC_AND_GET_DPTR_CHARACTER
 1388:    2400  91 6E                           ACALL   PLUS_MINUS_TEST
 1389:    2402  92 50                           MOV     XSIGN,C                         ;SAVE SIGN STATUS
 1390:    2404  D1 74                           ACALL   GET_DIGIT_CHECK
 1391:    2406  50 45                           JNC     INERR
 1392:                                  ;
 1393:    2408  54 0F                           ANL     A,#0FH                          ;STRIP ASCII BIAS OFF THE CHARACTER
 1394:    240A  FD                              MOV     R5,A                            ;SAVE THE CHARACTER IN R5
 1395:                                  ;
 1396:    240B  A3              GT2:            INC     DPTR
 1397:    240C  D1 74                           ACALL   GET_DIGIT_CHECK
 1398:    240E  50 0D                           JNC     FINISH1
 1399:    2410  54 0F                           ANL     A,#0FH                          ;STRIP OFF BIAS
 1400:    2412  CD                              XCH     A,R5                            ;GET THE LAST DIGIT
 1401:    2413  75 F0 0A                        MOV     B,#10                           ;MULTIPLY BY TEN
 1402:    2416  A4                              MUL     AB
 1403:    2417  2D                              ADD     A,R5                            ;ADD TO ORIGINAL VALUE
 1404:    2418  FD                              MOV     R5,A                            ;SAVE IN R5
 1405:    2419  50 F0                           JNC     GT2                             ;LOOP IF NO CARRY
 1406:    241B  7D FF                           MOV     R5,#0FFH                        ;FORCE AN ERROR
 1407:                                  ;
 1408:    241D  ED              FINISH1:        MOV     A,R5                            ;GET THE SIGN
 1409:    241E  30 50 09                        JNB     XSIGN,POSNUM                    ;SEE IF EXPONENT IS POS OR NEG
 1410:    2421  C3                              CLR     C
 1411:    2422  9E                              SUBB    A,R6
 1412:    2423  F4                              CPL     A
 1413:    2424  04                              INC     A
 1414:    2425  40 09                           JC      FINISH2
 1415:    2427  74 01                           MOV     A,#01H
 1416:    2429  22                              RET
 1417:                                  ;
 1418:    242A  2E              POSNUM:         ADD     A,R6                            ;ADD TO EXPONENT
 1419:    242B  50 03                           JNC     FINISH2
 1420:                                  ;
 1421:    242D  74 02           POSNM1:         MOV     A,#02H
 1422:    242F  22                              RET
 1423:                                  ;
 1424:    2430  CE              FINISH2:        XCH     A,R6                            ;SAVE THE EXPONENT
 1425:                                  ;
 1426:    2431                  FINISH_UP:
 1427:                                  ;
 1428:    2431  8E 30                           MOV     FP_EXP,R6                       ;SAVE EXPONENT
 1429:    2433  B8 34 02                        CJNE    R0,#FP_ACCC,$+5
 1430:    2436  51 BB                           ACALL   FP_CLEAR                        ;CLEAR THE MEMORY IF 0
 1431:    2438  E5 24                           MOV     A,ARG_STACK                     ;GET THE ARG STACK
 1432:    243A  C3                              CLR     C
 1433:    243B  94 0C                           SUBB    A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
 1434:    243D  F5 24                           MOV     ARG_STACK,A                     ;ADJUST FOR STORE
 1435:    243F  41 2C                           AJMP    PACK
 1436:                                  ;
 1437:    2441  C2 D5           STDIG:          CLR     F0                              ;CLEAR INITIAL DESIGNATOR
 1438:    2443  70 0B                           JNZ     STDIG1                          ;CONTINUE IF NOT ZERO
 1439:    2445  B8 34 08                        CJNE    R0,#FP_ACCC,STDIG1
 1440:    2448  30 52 04                        JNB     FIRST_RADIX,RET_X
 1441:                                  ;
 1442:    244B  DE 02           DECX:           DJNZ    R6,RET_X
 1443:                                  ;
 1444:    244D  74 FF           INERR:          MOV     A,#0FFH
 1445:                                  ;
 1446:    244F  22              RET_X:          RET
 1447:                                  ;
 1448:    2450  20 53 02        STDIG1:         JB      DONE_LOAD,FRTEST
 1449:    2453  C2 52                           CLR     FIRST_RADIX
 1450:                                  ;
 1451:    2455  20 52 F3        FRTEST:         JB      FIRST_RADIX,DECX
 1452:                                  ;
 1453:    2458  20 51 01        FDTEST:         JB      FOUND_RADIX,FDT1
 1454:    245B  0E                              INC     R6
 1455:                                  ;
 1456:    245C  20 53 F0        FDT1:           JB      DONE_LOAD,RET_X
 1457:    245F  B8 3D 02                        CJNE    R0,#FP_ACC8+1,FDT2
 1458:    2462  D2 53                           SETB    DONE_LOAD
 1459:                                  ;
 1460:    2464  F6              FDT2:           MOV     @R0,A                           ;SAVE THE STRIPPED ACCUMULATOR
 1461:    2465  08                              INC     R0                              ;BUMP THE POINTER
 1462:    2466  22                              RET                                     ;EXIT
 1463:                                  ;
 1464:                                  ;***************************************************************
 1465:                                  ;
 1466:                                  ; I/O utilities
 1467:                                  ;
 1468:                                  ;***************************************************************
 1469:                                  ;
 1470:    2467                  INC_AND_GET_DPTR_CHARACTER:
 1471:                                  ;
 1472:    2467  A3                              INC     DPTR
 1473:                                  ;
 1474:    2468                  GET_DPTR_CHARACTER:
 1475:                                  ;
 1476:    2468  E0                              MOVX    A,@DPTR                         ;GET THE CHARACTER
 1477:    2469  B4 20 16                        CJNE    A,#' ',PMT1                     ;SEE IF A SPACE
 1478:                                  ;
 1479:                                  ; Kill spaces
 1480:                                  ;
 1481:    246C  80 F9                           SJMP    INC_AND_GET_DPTR_CHARACTER
 1482:                                  ;
 1483:    246E                  PLUS_MINUS_TEST:
 1484:                                  ;
 1485:    246E  B4 E3 02                        CJNE    A,#0E3H,$+5                     ;SEE IF A PLUS, PLUS TOKEN FROM BASIC
 1486:    2471  80 0E                           SJMP    PMT3
 1487:    2473  B4 2B 02                        CJNE    A,#'+',$+5
 1488:    2476  80 09                           SJMP    PMT3
 1489:    2478  B4 E5 02                        CJNE    A,#0E5H,$+5                     ;SEE IF MINUS, MINUS TOKEN FROM BASIC
 1490:    247B  80 03                           SJMP    PMT2
 1491:    247D  B4 2D 02                        CJNE    A,#'-',PMT1
 1492:                                  ;
 1493:    2480  D3              PMT2:           SETB    C
 1494:                                  ;
 1495:    2481  A3              PMT3:           INC     DPTR
 1496:                                  ;
 1497:    2482  22              PMT1:           RET
 1498:                                  ;
 1499:                                  ;***************************************************************
 1500:                                  ;
 1501:    2483                  FLOATING_POINT_OUTPUT:  ; Output the number, format is in location 25
 1502:                                  ;
 1503:                                  ; IF FORMAT = 00 - FREE FLOATING
 1504:                                  ;           = FX - EXPONENTIAL (X IS THE NUMBER OF SIG DIGITS)
 1505:                                  ;           = NX - N = NUM BEFORE RADIX, X = NUM AFTER RADIX
 1506:                                  ;                  N + X = 8 MAX
 1507:                                  ;
 1508:                                  ;***************************************************************
 1509:                                  ;
 1510:    2483  71 73                           ACALL   MDES1                           ;GET THE NUMBER TO OUTPUT, R0 IS POINTER
 1511:    2485  11 C4                           ACALL   POP_AND_EXIT                    ;OUTPUT POPS THE STACK
 1512:    2487  EF                              MOV     A,R7
 1513:    2488  FE                              MOV     R6,A                            ;PUT THE EXPONENT IN R6
 1514:    2489  51 87                           ACALL   UNPACK_R0                       ;UNPACK THE NUMBER
 1515:    248B  78 2B                           MOV     R0,#FP_NIB1                     ;POINT AT THE NUMBER
 1516:    248D  E5 25                           MOV     A,FORMAT                        ;GET THE FORMAT
 1517:    248F  FB                              MOV     R3,A                            ;SAVE IN CASE OF EXP FORMAT
 1518:    2490  60 49                           JZ      FREE                            ;FREE FLOATING?
 1519:    2492  B4 F0 00                        CJNE    A,#0F0H,$+3                     ;SEE IF EXPONENTIAL
 1520:    2495  50 73                           JNC     EXPOUT
 1521:                                  ;
 1522:                                  ; If here, must be integer USING format
 1523:                                  ;
 1524:    2497  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1525:    2498  70 02                           JNZ     $+4
 1526:    249A  7E 80                           MOV     R6,#80H
 1527:    249C  EB                              MOV     A,R3                            ;GET THE FORMAT
 1528:    249D  C4                              SWAP    A                                       ;SPLIT INTEGER AND FRACTION
 1529:    249E  54 0F                           ANL     A,#0FH
 1530:    24A0  FA                              MOV     R2,A                            ;SAVE INTEGER
 1531:    24A1  B1 70                           ACALL   NUM_LT                          ;GET THE NUMBER OF INTEGERS
 1532:    24A3  CA                              XCH     A,R2                            ;FLIP FOR SUBB
 1533:    24A4  C3                              CLR             C
 1534:    24A5  9A                              SUBB    A,R2
 1535:    24A6  FF                              MOV     R7,A
 1536:    24A7  50 06                           JNC     $+8
 1537:    24A9  7D 3F                           MOV     R5,#'?'                         ;OUTPUT A QUESTION MARK
 1538:    24AB  B1 A5                           ACALL   SOUT1                           ;NUMBER IS TOO LARGE FOR FORMAT
 1539:    24AD  81 DB                           AJMP    FREE
 1540:    24AF  BA 00 07                        CJNE    R2,#00,USING0                   ;SEE IF ZERO
 1541:    24B2  1F                              DEC     R7
 1542:    24B3  B1 92                           ACALL   SS7
 1543:    24B5  B1 9F                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1544:    24B7  80 06                           SJMP    USING1
 1545:                                  ;
 1546:    24B9  B1 92           USING0:         ACALL   SS7                             ;OUTPUT SPACES, IF NEED TO
 1547:    24BB  EA                              MOV     A,R2                            ;OUTPUT DIGITS
 1548:    24BC  FF                              MOV     R7,A
 1549:    24BD  B1 54                           ACALL   OUTR0
 1550:                                  ;
 1551:    24BF  EB              USING1:         MOV     A,R3
 1552:    24C0  54 0F                           ANL     A,#0FH                          ;GET THE NUMBER RIGHT OF DP
 1553:    24C2  FA                              MOV     R2,A                            ;SAVE IT
 1554:    24C3  60 BD                           JZ      PMT1                            ;EXIT IF ZERO
 1555:    24C5  B1 9B                           ACALL   ROUT                            ;OUTPUT DP
 1556:    24C7  B1 79                           ACALL   NUM_RT
 1557:    24C9  B5 02 03                        CJNE    A,2,USINGX                      ;COMPARE A TO R2
 1558:                                  ;
 1559:    24CC  EA              USINGY:         MOV     A,R2
 1560:    24CD  A1 89                           AJMP    Z7R7
 1561:                                  ;
 1562:    24CF  50 FB           USINGX:         JNC     USINGY
 1563:                                  ;
 1564:    24D1  CA              USING2:         XCH     A,R2
 1565:    24D2  C3                              CLR     C
 1566:    24D3  9A                              SUBB    A,R2
 1567:    24D4  CA                              XCH     A,R2
 1568:    24D5  B1 89                           ACALL   Z7R7                            ;OUTPUT ZEROS IF NEED TO
 1569:    24D7  EA                              MOV     A,R2
 1570:    24D8  FF                              MOV     R7,A
 1571:    24D9  A1 54                           AJMP    OUTR0
 1572:                                  ;
 1573:                                  ; First, force exponential output, if need to
 1574:                                  ;
 1575:    24DB  EE              FREE:           MOV     A,R6                            ;GET THE EXPONENT
 1576:    24DC  70 04                           JNZ     FREE1                           ;IF ZERO, PRINT IT
 1577:    24DE  B1 A3                           ACALL   SOUT
 1578:    24E0  A1 9F                           AJMP    ZOUT
 1579:                                  ;
 1580:    24E2  7B F0           FREE1:          MOV     R3,#0F0H                        ;IN CASE EXP NEEDED
 1581:    24E4  74 77                           MOV     A,#80H-DIGIT-DIGIT-1
 1582:    24E6  2E                              ADD     A,R6
 1583:    24E7  40 21                           JC      EXPOUT
 1584:    24E9  94 F7                           SUBB    A,#0F7H
 1585:    24EB  40 1D                           JC      EXPOUT
 1586:                                  ;
 1587:                                  ; Now, just print the number
 1588:                                  ;
 1589:    24ED  B1 94                           ACALL   SINOUT                          ;PRINT THE SIGN OF THE NUMBER
 1590:    24EF  B1 70                           ACALL   NUM_LT                          ;GET THE NUMBER LEFT OF DP
 1591:    24F1  B4 08 02                        CJNE    A,#8,FREE4
 1592:    24F4  A1 54                           AJMP    OUTR0
 1593:                                  ;
 1594:    24F6  B1 54           FREE4:          ACALL   OUTR0
 1595:    24F8  B1 66                           ACALL   ZTEST                           ;TEST FOR TRAILING ZEROS
 1596:    24FA  60 57                           JZ      U_RET                           ;DONE IF ALL TRAILING ZEROS
 1597:    24FC  B1 9B                           ACALL   ROUT                            ;OUTPUT RADIX
 1598:                                  ;
 1599:    24FE  7F 01           FREE2:          MOV     R7,#1                           ;OUTPUT ONE DIGIT
 1600:    2500  B1 54                           ACALL   OUTR0
 1601:    2502  70 4F                           JNZ     U_RET
 1602:    2504  B1 66                           ACALL   ZTEST
 1603:    2506  60 4B                           JZ      U_RET
 1604:    2508  80 F4                           SJMP    FREE2                           ;LOOP
 1605:                                  ;
 1606:    250A  B1 94           EXPOUT:         ACALL   SINOUT                          ;PRINT THE SIGN
 1607:    250C  7F 01                           MOV     R7,#1                           ;OUTPUT ONE CHARACTER
 1608:    250E  B1 54                           ACALL   OUTR0
 1609:    2510  B1 9B                           ACALL   ROUT                            ;OUTPUT RADIX
 1610:    2512  EB                              MOV     A,R3                            ;GET FORMAT
 1611:    2513  54 0F                           ANL     A,#0FH                          ;STRIP INDICATOR
 1612:    2515  60 06                           JZ      EXPOTX
 1613:                                  ;
 1614:    2517  FF                              MOV     R7,A                            ;OUTPUT THE NUMBER OF DIGITS
 1615:    2518  1F                              DEC     R7                              ;ADJUST BECAUSE ONE CHAR ALREADY OUT
 1616:    2519  B1 54                           ACALL   OUTR0
 1617:    251B  80 02                           SJMP    EXPOT4
 1618:                                  ;
 1619:    251D  91 FE           EXPOTX:         ACALL   FREE2                           ;OUTPUT UNTIL TRAILING ZEROS
 1620:                                  ;
 1621:    251F  B1 A3           EXPOT4:         ACALL   SOUT                            ;OUTPUT A SPACE
 1622:    2521  7D 45                           MOV     R5,#'E'
 1623:    2523  B1 A5                           ACALL   SOUT1                           ;OUTPUT AN E
 1624:    2525  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1625:    2526  60 04                           JZ      XOUT0                           ;EXIT IF ZERO
 1626:    2528  14                              DEC     A                               ;ADJUST FOR THE DIGIT ALREADY OUTPUT
 1627:    2529  B4 80 05                        CJNE    A,#80H,XOUT2                    ;SEE WHAT IT IS
 1628:                                  ;
 1629:    252C  B1 A3           XOUT0:          ACALL   SOUT
 1630:    252E  E4                              CLR     A
 1631:    252F  80 0C                           SJMP    XOUT4
 1632:                                  ;
 1633:    2531  40 06           XOUT2:          JC      XOUT3                           ;NEGATIVE EXPONENT
 1634:    2533  7D 2B                           MOV     R5,#'+'                         ;OUTPUT A PLUS SIGN
 1635:    2535  B1 A5                           ACALL   SOUT1
 1636:    2537  80 04                           SJMP    XOUT4
 1637:                                  ;
 1638:    2539  B1 97           XOUT3:          ACALL   MOUT
 1639:    253B  F4                              CPL     A                               ;FLIP BITS
 1640:    253C  04                              INC     A                               ;BUMP
 1641:                                  ;
 1642:    253D  C2 E7           XOUT4:          CLR     ACC.7
 1643:    253F  F8                              MOV     R0,A
 1644:    2540  7A 00                           MOV     R2,#0
 1645:    2542  79 48                           MOV     R1,#LOW CONVT                   ;CONVERSION LOCATION
 1646:    2544  7B 00                           MOV     R3,#HIGH CONVT
 1647:    2546  D1 00                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1648:    2548  78 48                           MOV     R0,#LOW CONVT                   ;NOW, OUTPUT EXPONENT
 1649:                                  ;
 1650:    254A  E2              EXPOT5:         MOVX    A,@R0                           ;GET THE CHARACTER
 1651:    254B  FD                              MOV     R5,A                            ;OUTPUT IT
 1652:    254C  B1 A5                           ACALL   SOUT1
 1653:    254E  08                              INC     R0                              ;BUMP THE POINTER
 1654:    254F  E8                              MOV     A,R0                            ;GET THE POINTER
 1655:    2550  B5 01 F7                        CJNE    A,R1B0,EXPOT5                   ;LOOP
 1656:                                  ;
 1657:    2553  22              U_RET:          RET                                     ;EXIT
 1658:                                  ;
 1659:    2554                  OUTR0:  ; Output the characters pointed to by R0, also bias ascii
 1660:                                  ;
 1661:    2554  EF                              MOV     A,R7                            ;GET THE COUNTER
 1662:    2555  60 0E                           JZ      OUTR                            ;EXIT IF DONE
 1663:    2557  E6                              MOV     A,@R0                           ;GET THE NUMBER
 1664:    2558  44 30                           ORL     A,#30H                          ;ASCII BIAS
 1665:    255A  08                              INC     R0                              ;BUMP POINTER AND COUNTER
 1666:    255B  1F                              DEC     R7
 1667:    255C  FD                              MOV     R5,A                            ;PUT CHARACTER IN OUTPUT REGISTER
 1668:    255D  B1 A5                           ACALL   SOUT1                           ;OUTPUT THE CHARACTER
 1669:    255F  E4                              CLR     A                               ;JUST FOR TEST
 1670:    2560  B8 33 F1                        CJNE    R0,#FP_NIB8+1,OUTR0
 1671:    2563  74 55                           MOV     A,#55H                          ;KNOW WHERE EXIT OCCURED
 1672:                                  ;
 1673:    2565  22              OUTR:           RET
 1674:                                  ;
 1675:    2566  A9 00           ZTEST:          MOV     R1,R0B0                         ;GET POINTER REGISTER
 1676:                                  ;
 1677:    2568  E7              ZT0:            MOV     A,@R1                           ;GET THE VALUE
 1678:    2569  70 04                           JNZ     ZT1
 1679:    256B  09                              INC     R1                              ;BUMP POINTER
 1680:    256C  B9 33 F9                        CJNE    R1,#FP_NIB8+1,ZT0
 1681:                                  ;
 1682:    256F  22              ZT1:            RET
 1683:                                  ;
 1684:    2570  EE              NUM_LT:         MOV     A,R6                            ;GET EXPONENT
 1685:    2571  C3                              CLR     C                               ;GET READY FOR SUBB
 1686:    2572  94 80                           SUBB    A,#80H                          ;SUB EXPONENT BIAS
 1687:    2574  50 01                           JNC     NL1                             ;OK IF NO CARRY
 1688:    2576  E4                              CLR     A                               ;NO DIGITS LEFT
 1689:                                  ;
 1690:    2577  FF              NL1:            MOV     R7,A                            ;SAVE THE COUNT
 1691:    2578  22                              RET
 1692:                                  ;
 1693:    2579  C3              NUM_RT:         CLR     C                               ;SUBB AGAIN
 1694:    257A  74 80                           MOV     A,#80H                          ;EXPONENT BIAS
 1695:    257C  9E                              SUBB    A,R6                            ;GET THE BIASED EXPONENT
 1696:    257D  50 01                           JNC     NR1
 1697:    257F  E4                              CLR     A
 1698:                                  ;
 1699:    2580  22              NR1:            RET                                     ;EXIT
 1700:                                  ;
 1701:    2581  EF              SPACE7:         MOV     A,R7                            ;GET THE NUMBER OF SPACES
 1702:    2582  60 FC                           JZ      NR1                             ;EXIT IF ZERO
 1703:    2584  B1 A3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1704:    2586  1F                              DEC     R7                              ;BUMP COUNTER
 1705:    2587  80 F8                           SJMP    SPACE7                          ;LOOP
 1706:                                  ;
 1707:    2589  FF              Z7R7:           MOV     R7,A
 1708:                                  ;
 1709:    258A  EF              ZERO7:          MOV     A,R7                            ;GET COUNTER
 1710:    258B  60 F3                           JZ      NR1                             ;EXIT IF ZERO
 1711:    258D  B1 9F                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1712:    258F  1F                              DEC     R7                              ;BUMP COUNTER
 1713:    2590  80 F8                           SJMP    ZERO7                           ;LOOP
 1714:                                  ;
 1715:    2592  B1 81           SS7:            ACALL   SPACE7
 1716:                                  ;
 1717:    2594  EC              SINOUT:         MOV     A,R4                            ;GET THE SIGN
 1718:    2595  60 0C                           JZ      SOUT                            ;OUTPUT A SPACE IF ZERO
 1719:                                  ;
 1720:    2597  7D 2D           MOUT:           MOV     R5,#'-'
 1721:    2599  80 0A                           SJMP    SOUT1                           ;OUTPUT A MINUS IF NOT
 1722:                                  ;
 1723:    259B  7D 2E           ROUT:           MOV     R5,#'.'                         ;OUTPUT A RADIX
 1724:    259D  80 06                           SJMP    SOUT1
 1725:                                  ;
 1726:    259F  7D 30           ZOUT:           MOV     R5,#'0'                         ;OUTPUT A ZERO
 1727:    25A1  80 02                           SJMP    SOUT1
 1728:                                  ;
 1729:    25A3  7D 20           SOUT:           MOV     R5,#' '                         ;OUTPUT A SPACE
 1730:                                  ;
 1731:    25A5  C1 81           SOUT1:          AJMP    R5OUT
 1732:                                  ;
 1733:                                  ;***************************************************************
 1734:                                  ;
 1735:    25A7                  CONVERT_ASCII_STRING_TO_BINARY:
 1736:                                  ;
 1737:                                  ;DPTR POINTS TO ASCII STRING
 1738:                                  ;PUT THE BINARY NUMBER IN R2:R0, ERROR IF >64K
 1739:                                  ;
 1740:                                  ;***************************************************************
 1741:                                  ;
 1742:    25A7  71 92           CASB:           ACALL   HEXSCAN                         ;SEE IF HEX NUMBER
 1743:    25A9  92 33                           MOV     ADD_IN,C                        ;IF ADD_IN IS SET, THE NUMBER IS HEX
 1744:    25AB  D1 74                           ACALL   GET_DIGIT_CHECK
 1745:    25AD  B3                              CPL     C                               ;FLIP FOR EXIT
 1746:    25AE  40 28                           JC      RCASB
 1747:    25B0  7B 00                           MOV     R3,#00H                         ;ZERO R3:R1 FOR LOOP
 1748:    25B2  79 00                           MOV     R1,#00H
 1749:    25B4  80 15                           SJMP    CASB5
 1750:                                  ;
 1751:    25B6  A3              CASB2:          INC     DPTR
 1752:    25B7  89 00                           MOV     R0B0,R1                         ;SAVE THE PRESENT CONVERTED VALUE
 1753:    25B9  8B 02                           MOV     R0B0+2,R3                       ;IN R2:R0
 1754:    25BB  D1 74                           ACALL   GET_DIGIT_CHECK
 1755:    25BD  40 0C                           JC      CASB5
 1756:    25BF  30 33 16                        JNB     ADD_IN,RCASB                    ;CONVERSION COMPLETE
 1757:    25C2  71 B2                           ACALL   HEX_CHECK                       ;SEE IF HEX NUMBER
 1758:    25C4  40 03                           JC      CASB4                           ;PROCEED IF GOOD
 1759:    25C6  A3                              INC     DPTR                            ;BUMP PAST H
 1760:    25C7  80 0F                           SJMP    RCASB
 1761:                                  ;
 1762:    25C9  24 09           CASB4:          ADD     A,#9                            ;ADJUST HEX ASCII BIAS
 1763:                                  ;
 1764:    25CB  75 F0 0A        CASB5:          MOV     B,#10
 1765:    25CE  30 33 03                        JNB     ADD_IN,CASB6
 1766:    25D1  75 F0 10                        MOV     B,#16                           ;HEX MODE
 1767:                                  ;
 1768:    25D4  B1 DF           CASB6:          ACALL   MULNUM                          ;ACCUMULATE THE DIGITS
 1769:    25D6  50 DE                           JNC     CASB2                           ;LOOP IF NO CARRY
 1770:                                  ;
 1771:    25D8  E4              RCASB:          CLR     A                               ;RESET ACC
 1772:    25D9  92 E1                           MOV     ACC.OVERFLOW,C                  ;IF OVERFLOW, SAY SO
 1773:    25DB  22                              RET                                     ;EXIT
 1774:                                  ;
 1775:                                  ;
 1776:    25DC  75 F0 0A        MULNUM10:       MOV     B,#10
 1777:                                  ;
 1778:                                  ;***************************************************************
 1779:                                  ;
 1780:    25DF                  MULNUM: ; Take the next digit in the acc (masked to 0FH)
 1781:                                  ; accumulate in R3:R1
 1782:                                  ;
 1783:                                  ;***************************************************************
 1784:                                  ;
 1785:    25DF  C0 E0                           PUSH    ACC                             ;SAVE ACC
 1786:    25E1  C0 F0                           PUSH    B                               ;SAVE MULTIPLIER
 1787:    25E3  E9                              MOV     A,R1                            ;PUT LOW ORDER BITS IN ACC
 1788:    25E4  A4                              MUL     AB                              ;DO THE MULTIPLY
 1789:    25E5  F9                              MOV     R1,A                            ;PUT THE RESULT BACK
 1790:    25E6  EB                              MOV     A,R3                            ;GET THE HIGH ORDER BYTE
 1791:    25E7  AB F0                           MOV     R3,B                            ;SAVE THE OVERFLOW
 1792:    25E9  D0 F0                           POP     B                               ;GET THE MULTIPLIER
 1793:    25EB  A4                              MUL     AB                              ;DO IT
 1794:    25EC  A2 D2                           MOV     C,OV                            ;SAVE OVERFLOW IN F0
 1795:    25EE  92 D5                           MOV     F0,C
 1796:    25F0  2B                              ADD     A,R3                            ;ADD OVERFLOW TO HIGH RESULT
 1797:    25F1  FB                              MOV     R3,A                            ;PUT IT BACK
 1798:    25F2  D0 E0                           POP     ACC                             ;GET THE ORIGINAL ACC BACK
 1799:    25F4  72 D5                           ORL     C,F0                            ;OR CARRY AND OVERFLOW
 1800:    25F6  40 07                           JC      MULX                            ;NO GOOD IF THE CARRY IS SET
 1801:                                  ;
 1802:    25F8  54 0F           MUL11:          ANL     A,#0FH                          ;MASK OFF HIGH ORDER BITS
 1803:    25FA  29                              ADD     A,R1                            ;NOW ADD THE ACC
 1804:    25FB  F9                              MOV     R1,A                            ;PUT IT BACK
 1805:    25FC  E4                              CLR     A                               ;PROPAGATE THE CARRY
 1806:    25FD  3B                              ADDC    A,R3
 1807:    25FE  FB                              MOV     R3,A                            ;PUT IT BACK
 1808:                                  ;
 1809:    25FF  22              MULX:           RET                                     ;EXIT WITH OR WITHOUT CARRY
 1810:                                  ;
 1811:                                  ;***************************************************************
 1812:                                  ;
 1813:    2600                  CONVERT_BINARY_TO_ASCII_STRING:
 1814:                                  ;
 1815:                                  ;R3:R1 contains the address of the string
 1816:                                  ;R2:R0 contains the value to convert
 1817:                                  ;DPTR, R7, R6, and ACC gets clobbered
 1818:                                  ;
 1819:                                  ;***************************************************************
 1820:                                  ;
 1821:    2600  E4                              CLR     A                               ;NO LEADING ZEROS
 1822:    2601  90 27 10                        MOV     DPTR,#10000                     ;SUBTRACT 10000
 1823:    2604  D1 1D                           ACALL   RSUB                            ;DO THE SUBTRACTION
 1824:    2606  90 03 E8                        MOV     DPTR,#1000                      ;NOW 1000
 1825:    2609  D1 1D                           ACALL   RSUB
 1826:    260B  90 00 64                        MOV     DPTR,#100                       ;NOW 100
 1827:    260E  D1 1D                           ACALL   RSUB
 1828:    2610  90 00 0A                        MOV     DPTR,#10                        ;NOW 10
 1829:    2613  D1 1D                           ACALL   RSUB
 1830:    2615  90 00 01                        MOV     DPTR,#1                         ;NOW 1
 1831:    2618  D1 1D                           ACALL   RSUB
 1832:    261A  60 20                           JZ      RSUB2                           ;JUMP OVER RET
 1833:                                  ;
 1834:    261C  22              RSUB_R:         RET
 1835:                                  ;
 1836:    261D  7E FF           RSUB:           MOV     R6,#-1                          ;SET UP THE COUNTER
 1837:                                  ;
 1838:    261F  0E              RSUB1:          INC     R6                              ;BUMP THE COUNTER
 1839:    2620  CA                              XCH     A,R2                            ;DO A FAST COMPARE
 1840:    2621  B5 83 00                        CJNE    A,DPH,$+3
 1841:    2624  CA                              XCH     A,R2
 1842:    2625  40 12                           JC      FAST_DONE
 1843:    2627  C8                              XCH     A,R0                            ;GET LOW BYTE
 1844:    2628  95 82                           SUBB    A,DPL                           ;SUBTRACT, CARRY IS CLEARED
 1845:    262A  C8                              XCH     A,R0                            ;PUT IT BACK
 1846:    262B  CA                              XCH     A,R2                            ;GET THE HIGH BYTE
 1847:    262C  95 83                           SUBB    A,DPH                           ;ADD THE HIGH BYTE
 1848:    262E  CA                              XCH     A,R2                            ;PUT IT BACK
 1849:    262F  50 EE                           JNC     RSUB1                           ;LOOP UNTIL CARRY
 1850:                                  ;
 1851:    2631  C8                              XCH     A,R0
 1852:    2632  25 82                           ADD     A,DPL                           ;RESTORE R2:R0
 1853:    2634  C8                              XCH     A,R0
 1854:    2635  CA                              XCH     A,R2
 1855:    2636  35 83                           ADDC    A,DPH
 1856:    2638  CA                              XCH     A,R2
 1857:                                  ;
 1858:    2639                  FAST_DONE:
 1859:                                  ;
 1860:    2639  4E                              ORL     A,R6                            ;OR THE COUNT VALUE
 1861:    263A  60 E0                           JZ      RSUB_R                          ;RETURN IF ZERO
 1862:                                  ;
 1863:    263C  74 30           RSUB2:          MOV     A,#'0'                          ;GET THE ASCII BIAS
 1864:    263E  2E                              ADD     A,R6                            ;ADD THE COUNT
 1865:                                  ;
 1866:    263F  8B A0           RSUB4:          MOV     P2,R3                           ;SET UP P2
 1867:    2641  F3                              MOVX    @R1,A                           ;PLACE THE VALUE IN MEMORY
 1868:    2642  09                              INC     R1
 1869:    2643  B9 00 01                        CJNE    R1,#00H,RSUB3                   ;SEE IF RAPPED AROUND
 1870:    2646  0B                              INC     R3                              ;BUMP HIGH BYTE
 1871:                                  ;
 1872:    2647  22              RSUB3:          RET                                     ;EXIT
 1873:                                  ;
 1874:                                  ;***************************************************************
 1875:                                  ;
 1876:    2648                  FPHEXOUT:       ; Output the hex number in R3:R1, supress leading zeros, if set
 1877:                                  ;
 1878:                                  ;***************************************************************
 1879:                                  ;
 1880:    2648  B1 A3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1881:    264A  A2 36                           MOV     C,ZSURP                         ;GET ZERO SUPPRESSION BIT
 1882:    264C  92 33                           MOV     ADD_IN,C
 1883:    264E  EB                              MOV     A,R3                            ;GET HIGH NIBBLE AND PRINT IT
 1884:    264F  D1 6B                           ACALL   HOUTHI
 1885:    2651  EB                              MOV     A,R3
 1886:    2652  D1 6C                           ACALL   HOUTLO
 1887:                                  ;
 1888:    2654  C2 33           HEX2X:          CLR     ADD_IN                          ;DON'T SUPPRESS ZEROS
 1889:    2656  E9                              MOV     A,R1                            ;GET LOW NIBBLE AND PRINT IT
 1890:    2657  D1 6B                           ACALL   HOUTHI
 1891:    2659  E9                              MOV     A,R1
 1892:    265A  D1 6C                           ACALL   HOUTLO
 1893:    265C  7D 48                           MOV     R5,#'H'                         ;OUTPUT H TO INDICATE HEX MODE
 1894:                                  ;
 1895:    265E  A1 A5           SOUT_1:         AJMP    SOUT1
 1896:                                  ;
 1897:    2660  C2 33           HOUT1:          CLR     ADD_IN                          ;PRINTED SOMETHING, SO CLEAR ADD_IN
 1898:    2662  24 90                           ADD     A,#90H                          ;CONVERT TO ASCII
 1899:    2664  D4                              DA      A
 1900:    2665  34 40                           ADDC    A,#40H
 1901:    2667  D4                              DA      A                               ;GOT IT HERE
 1902:    2668  FD                              MOV     R5,A                            ;OUTPUT THE BYTE
 1903:    2669  80 F3                           SJMP    SOUT_1
 1904:                                  ;
 1905:    266B  C4              HOUTHI:         SWAP    A                               ;SWAP TO OUTPUT HIGH NIBBLE
 1906:                                  ;
 1907:    266C  54 0F           HOUTLO:         ANL     A,#0FH                          ;STRIP
 1908:    266E  70 F0                           JNZ     HOUT1                           ;PRINT IF NOT ZERO
 1909:    2670  30 33 ED                        JNB     ADD_IN,HOUT1                    ;OUTPUT A ZERO IF NOT SUPRESSED
 1910:    2673  22                              RET
 1911:                                  ;
 1912:                                  ;
 1913:    2674                  GET_DIGIT_CHECK:        ; Get a character, then check for digit
 1914:                                  ;
 1915:    2674  91 68                           ACALL   GET_DPTR_CHARACTER
 1916:                                  ;
 1917:    2676                  DIGIT_CHECK:    ;CHECK FOR A VALID ASCII DIGIT, SET CARRY IF FOUND
 1918:                                  ;
 1919:    2676  B4 3A 00                        CJNE    A,#'9'+1,$+3                    ;SEE IF ASCII 9 OR LESS
 1920:    2679  40 01                           JC      DC1
 1921:    267B  22                              RET
 1922:                                  ;
 1923:    267C  B4 30 00        DC1:            CJNE    A,#'0',$+3                      ;SEE IF ASCII 0 OR GREATER
 1924:    267F  B3                              CPL     C
 1925:    2680  22                              RET
 1926:                                  ;
 1927:
 1928:    2681  C0 E0           R5OUT:          PUSH    ACC                             ; ME
 1929:    2683  C0 00                           PUSH    00H
 1930:    2685  A8 50                           MOV     R0,FPCHR_OUT
 1931:    2687  ED                              MOV     A,R5                            ; ME
 1932:    2688  F6                              MOV     @R0,A
 1933:    2689  05 50                           INC     FPCHR_OUT
 1934:    268B  D0 00                           POP     00H
 1935:    268D  D0 E0                           POP     ACC                             ; ME
 1936:    268F  22                              RET                                     ; ME
 1937:
 1938:    2690  01 A7           SQ_ERR:         JMP     BADPRM                          ; me
 1939:
 1940:                                  ;***************************************************************
 1941:                                  ;
 1942:    2692                  IFIX:   ; Convert a floating point number to an integer, put in R3:R1
 1943:                                  ;
 1944:                                  ;***************************************************************
 1945:                                  ;
 1946:    2692  E4                              CLR     A                               ;RESET THE START
 1947:    2693  FB                              MOV     R3,A
 1948:    2694  F9                              MOV     R1,A
 1949:    2695  A8 24                           MOV     R0,ARG_STACK                    ;GET THE ARG STACK
 1950:    2697  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1951:    269A  E2                              MOVX    A,@R0                           ;READ EXPONENT
 1952:    269B  C3                              CLR     C
 1953:    269C  94 81                           SUBB    A,#81H                          ;BASE EXPONENT
 1954:    269E  FC                              MOV     R4,A                            ;SAVE IT
 1955:    269F  18                              DEC     R0                              ;POINT AT SIGN
 1956:    26A0  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1957:    26A1  70 ED                           JNZ     SQ_ERR                          ;ERROR IF NEGATIVE
 1958:    26A3  40 17                           JC      INC_ASTKA                       ;EXIT IF EXPONENT IS < 81H
 1959:    26A5  0C                              INC     R4                              ;ADJUST LOOP COUNTER
 1960:    26A6  E8                              MOV     A,R0                            ;BUMP THE POINTER REGISTER
 1961:    26A7  94 05                           SUBB    A,#FP_NUMBER_SIZE-1
 1962:    26A9  F8                              MOV     R0,A
 1963:                                  ;
 1964:    26AA  08              I2:             INC     R0                              ;POINT AT DIGIT
 1965:    26AB  E2                              MOVX    A,@R0                           ;GET DIGIT
 1966:    26AC  C4                              SWAP    A                               ;FLIP
 1967:    26AD  11 94                           CALL    FP_BASE+20                      ;ACCUMULATE
 1968:    26AF  40 DF                           JC      SQ_ERR
 1969:    26B1  DC 02                           DJNZ    R4,$+4
 1970:    26B3  80 07                           SJMP    INC_ASTKA
 1971:    26B5  E2                              MOVX    A,@R0                           ;GET DIGIT
 1972:    26B6  11 94                           CALL    FP_BASE+20
 1973:    26B8  40 D6                           JC      SQ_ERR
 1974:    26BA  DC EE                           DJNZ    R4,I2
 1975:                          ;
 1976:                          ; Pop the ARG STACK and check for overflow
 1977:    26BC                  INC_ASTKA:
 1978:    26BC  74 06                           MOV     A,#FP_NUMBER_SIZE               ;number to pop
 1979:    26BE  80 18                           SJMP    SETREG+1
 1980:                          ;
 1981:                          ;Push ARG STACK and check for underflow
 1982:    26C0                  DEC_ASTKA:
 1983:    26C0  74 FA                           MOV     A,#-FP_NUMBER_SIZE
 1984:    26C2  25 24                           ADD     A,ARG_STACK
 1985:    26C4  B4 00 00                        CJNE    A,#0,$+3
 1986:    26C7  40 45                           JC      E4YY
 1987:    26C9  F5 24                           MOV     ARG_STACK,A
 1988:    26CB  F9                              MOV     R1,A
 1989:    26CC  7B 01                           MOV     R3,#ARG_STACK_PAGE
 1990:    26CE  22              SRT:            RET
 1991:                          ;
 1992:    26CF  D1 BC           POPAS:          ACALL   INC_ASTKA
 1993:    26D1  E1 01                           AJMP    VARCOP                          ;COPY THE VARIABLE
 1994:                          ;
 1995:    26D3  D1 C0           PUSHAS:         ACALL   DEC_ASTKA
 1996:    26D5  E1 01                           AJMP    VARCOP
 1997:                          ;
 1998:    26D7  E4              SETREG:         CLR     A                               ;DON'T POP ANYTHING
 1999:    26D8  A8 24                           MOV     R0,ARG_STACK
 2000:    26DA  7A 01                           MOV     R2,#ARG_STACK_PAGE
 2001:    26DC  8A A0                           MOV     P2,R2
 2002:    26DE  28                              ADD     A,R0
 2003:    26DF  40 2D                           JC      E4YY
 2004:    26E1  F5 24                           MOV     ARG_STACK,A
 2005:    26E3  E2                              MOVX    A,@R0
 2006:    26E4  22              A_D:            RET
 2007:                                  ;
 2008:    26E5  18              DEC3210:        DEC     R0                              ;BUMP THE POINTER
 2009:    26E6  B8 FF 01                        CJNE    R0,#0FFH,$+4                    ;SEE IF OVERFLOWED
 2010:    26E9  1A                              DEC     R2                              ;BUMP THE HIGH BYTE
 2011:    26EA  19                              DEC     R1                              ;BUMP THE POINTER
 2012:    26EB  B9 FF 01                        CJNE    R1,#0FFH,DEC_R                  ;SEE IF OVERFLOWED
 2013:    26EE  1B                              DEC     R3                              ;CHANGE THE HIGH BYTE
 2014:    26EF  22              DEC_R:          RET                                     ;EXIT
 2015:                          ;
 2016:
 2017:
 2018:                          ;Routine to copy bottom arg on stack to address in DPTR.
 2019:                          ;Does not work over page boundaries.
 2020:                          ;Bugs fixed by JKJ/IRC
 2021:    26F0  D1 D7           MOVAS:          ACALL   SETREG                          ;SET UP R2:R0
 2022:    26F2  AB 83                           MOV     R3,DPH
 2023:    26F4  A9 82                           MOV     R1,DPL
 2024:    26F6  8A A0           M_C:            MOV     P2,R2                           ;SET UP THE PORTS
 2025:    26F8  E2                              MOVX    A,@R0                           ;READ THE VALUE
 2026:    26F9  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 2027:    26FB  F3                              MOVX    @R1,A                           ;SAVE IT
 2028:    26FC  08                              INC     R0
 2029:    26FD  09                              INC     R1
 2030:    26FE  DC F6                           DJNZ    R4,M_C                          ;LOOP
 2031:    2700  22                              RET                                     ;EXIT
 2032:
 2033:
 2034:                          ; VARCOP - Copy a variable from R2:R0 to R3:R1
 2035:    2701  7C 06           VARCOP:         MOV     R4,#FP_NUMBER_SIZE              ;LOAD THE LOOP COUNTER
 2036:    2703  8A A0           V_C:            MOV     P2,R2                           ;SET UP THE PORTS
 2037:    2705  E2                              MOVX    A,@R0                           ;READ THE VALUE
 2038:    2706  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 2039:    2708  F3                              MOVX    @R1,A                           ;SAVE IT
 2040:    2709  D1 E5                           ACALL   DEC3210
 2041:    270B  DC F6                           DJNZ    R4,V_C                          ;LOOP
 2042:    270D  22                              RET                                     ;EXIT
 2043:                          ;
 2044:    270E  90 27 49        E4YY:           MOV     DPTR,#EXA
 2045:    2711  01 A6                           JMP     PRTERR                          ; me
 2046:
 2047:                                  ; integer operator - INT
 2048:    2713  D1 D7           AINT:           ACALL   SETREG                          ;SET UP THE REGISTERS, CLEAR CARRY
 2049:    2715  94 81                           SUBB    A,#129                          ;SUBTRACT EXPONENT BIAS
 2050:    2717  50 0D                           JNC     AI1                             ;JUMP IF ACC > 81H
 2051:                                  ;
 2052:                                  ; Force the number to be a zero
 2053:                                  ;
 2054:    2719  D1 BC                           ACALL   INC_ASTKA                       ;BUMP THE STACK
 2055:                                  ;
 2056:    271B  90 27 20        P_Z:            MOV     DPTR,#ZRO                       ;PUT ZERO ON THE STACK
 2057:    271E  E1 3B                           AJMP    PUSHC
 2058:    2720  00 00 00 00     ZRO:            DB      0,0,0,0,0,0
          2724  00 00
 2059:                                  ;
 2060:    2726  94 07           AI1:            SUBB    A,#7
 2061:    2728  50 10                           JNC     AI3
 2062:    272A  F4                              CPL     A
 2063:    272B  04                              INC     A
 2064:    272C  FB                              MOV     R3,A
 2065:    272D  18                              DEC     R0                              ;POINT AT SIGN
 2066:                                  ;
 2067:    272E  18              AI2:            DEC     R0                              ;NOW AT LSB'S
 2068:    272F  E2                              MOVX    A,@R0                           ;READ BYTE
 2069:    2730  54 F0                           ANL     A,#0F0H                         ;STRIP NIBBLE
 2070:    2732  F2                              MOVX    @R0,A                           ;WRITE BYTE
 2071:    2733  DB 01                           DJNZ    R3,$+3
 2072:    2735  22                              RET
 2073:    2736  E4                              CLR     A
 2074:    2737  F2                              MOVX    @R0,A                           ;CLEAR THE LOCATION
 2075:    2738  DB F4                           DJNZ    R3,AI2
 2076:    273A  22              AI3:            RET                                     ;EXIT
 2077:                                  ;
 2078:                                  ; PUSHC - Push constant pointed by DPTR on to the arg stack
 2079:    273B  D1 C0           PUSHC:          ACALL   DEC_ASTKA
 2080:    273D  8B A0                           MOV     P2,R3
 2081:    273F  7B 06                           MOV     R3,#FP_NUMBER_SIZE              ;LOOP COUNTER
 2082:    2741  E4              PCL:            CLR     A                               ;SET UP A
 2083:    2742  93                              MOVC    A,@A+DPTR                       ;LOAD IT
 2084:    2743  F3                              MOVX    @R1,A                           ;SAVE IT
 2085:    2744  A3                              INC     DPTR                            ;BUMP POINTERS
 2086:    2745  19                              DEC     R1
 2087:    2746  DB F9                           DJNZ    R3,PCL                          ;LOOP
 2088:    2748  22                              RET                                     ;EXIT
 2089:                          ;
 2090:    2749  41 2D 53 54     EXA:            DB      'A-STACK',0
          274D  41 43 4B 00
 2091:
 2092:                          ;------------------------------------------------------------------
 2093:
 2094:                          ;Binary to decimal converter
 2095:                          ;Converts R7:R6:R5:R4 to decimal pointed to by R0
 2096:                          ;Returns with number of digits in A
 2097:                          ;------------------------------------------------------------------
 2098:    2751  C0 00           BIN2DEC:        PUSH    00h
 2099:    2753  90 27 A7                        MOV     DPTR,#BINDEC
 2100:    2756  7A 0A                           MOV     R2,#0Ah
 2101:    2758  7B 2F           BIN2DEC1:       MOV     R3,#2Fh
 2102:    275A  0B              BIN2DEC2:       INC     R3
 2103:    275B  F1 7A                           ACALL   SUBIT
 2104:    275D  50 FB                           JNC     BIN2DEC2
 2105:    275F  F1 93                           ACALL   ADDIT
 2106:    2761  EB                              MOV     A,R3
 2107:    2762  F6                              MOV     @R0,A
 2108:    2763  08                              INC     R0
 2109:    2764  A3                              INC     DPTR
 2110:    2765  A3                              INC     DPTR
 2111:    2766  A3                              INC     DPTR
 2112:    2767  A3                              INC     DPTR
 2113:    2768  DA EE                           DJNZ    R2,BIN2DEC1
 2114:    276A  D0 00                           POP     00h
 2115:                                          ;Remove leading zeroes
 2116:    276C  7A 09                           MOV     R2,#09h
 2117:    276E  E6              BIN2DEC3:       MOV     A,@R0
 2118:    276F  B4 30 05                        CJNE    A,#30h,BIN2DEC4
 2119:    2772  76 20                           MOV     @R0,#20h
 2120:    2774  08                              INC     R0
 2121:    2775  DA F7                           DJNZ    R2,BIN2DEC3
 2122:    2777  0A              BIN2DEC4:       INC     R2
 2123:    2778  EA                              MOV     A,R2
 2124:    2779  22                              RET
 2125:
 2126:    277A  E4              SUBIT:          CLR     A
 2127:    277B  93                              MOVC    A,@A+DPTR
 2128:    277C  CC                              XCH     A,R4
 2129:    277D  C3                              CLR     C
 2130:    277E  9C                              SUBB    A,R4
 2131:    277F  FC                              MOV     R4,A
 2132:    2780  74 01                           MOV     A,#01h
 2133:    2782  93                              MOVC    A,@A+DPTR
 2134:    2783  CD                              XCH     A,R5
 2135:    2784  9D                              SUBB    A,R5
 2136:    2785  FD                              MOV     R5,A
 2137:    2786  74 02                           MOV     A,#02h
 2138:    2788  93                              MOVC    A,@A+DPTR
 2139:    2789  CE                              XCH     A,R6
 2140:    278A  9E                              SUBB    A,R6
 2141:    278B  FE                              MOV     R6,A
 2142:    278C  74 03                           MOV     A,#03h
 2143:    278E  93                              MOVC    A,@A+DPTR
 2144:    278F  CF                              XCH     A,R7
 2145:    2790  9F                              SUBB    A,R7
 2146:    2791  FF                              MOV     R7,A
 2147:    2792  22                              RET
 2148:
 2149:    2793  E4              ADDIT:          CLR     A
 2150:    2794  93                              MOVC    A,@A+DPTR
 2151:    2795  2C                              ADD     A,R4
 2152:    2796  FC                              MOV     R4,A
 2153:    2797  74 01                           MOV     A,#01h
 2154:    2799  93                              MOVC    A,@A+DPTR
 2155:    279A  3D                              ADDC    A,R5
 2156:    279B  FD                              MOV     R5,A
 2157:    279C  74 02                           MOV     A,#02h
 2158:    279E  93                              MOVC    A,@A+DPTR
 2159:    279F  3E                              ADDC    A,R6
 2160:    27A0  FE                              MOV     R6,A
 2161:    27A1  74 03                           MOV     A,#03h
 2162:    27A3  93                              MOVC    A,@A+DPTR
 2163:    27A4  3F                              ADDC    A,R7
 2164:    27A5  FF                              MOV     R7,A
 2165:    27A6  22                              RET
 2166:
 2167:    27A7  00 CA 9A 3B     BINDEC:         DB 000h,0CAh,09Ah,03Bh                  ;1000000000
 2168:    27AB  00 E1 F5 05                     DB 000h,0E1h,0F5h,005h                  ; 100000000
 2169:    27AF  80 96 98 00                     DB 080h,096h,098h,000h                  ;  10000000
 2170:    27B3  40 42 0F 00                     DB 040h,042h,0Fh,0000h                  ;   1000000
 2171:    27B7  A0 86 01 00                     DB 0A0h,086h,001h,000h                  ;    100000
 2172:    27BB  10 27 00 00                     DB 010h,027h,000h,000h                  ;     10000
 2173:    27BF  E8 03 00 00                     DB 0E8h,003h,000h,000h                  ;      1000
 2174:    27C3  64 00 00 00                     DB 064h,000h,000h,000h                  ;       100
 2175:    27C7  0A 00 00 00                     DB 00Ah,000h,000h,000h                  ;        10
 2176:    27CB  01 00 00 00                     DB 001h,000h,000h,000h                  ;         1
 2177:
 2178:    27CF  7E 00 79 07     ADCMUL:         DB 7Eh,00h,79h,07h,03h,16h              ;CH0    1.6030779e-3
          27D3  03 16
 2179:    27D5  7E 00 79 07                     DB 7Eh,00h,79h,07h,03h,16h              ;CH1    1.6030779e-3
          27D9  03 16
 2180:    27DB  7E 00 79 07                     DB 7Eh,00h,79h,07h,03h,16h              ;CH2    1.6030779e-3
          27DF  03 16
 2181:    27E1  7E 00 79 07                     DB 7Eh,00h,79h,07h,03h,16h              ;CH3    1.6030779e-3
          27E5  03 16
 2182:
 2183:
 2184:                          ;------------------------------------------------------------------
 2185:
 2186:          N      0000     IF DEVMODE=0
 2187:                                          ORG     1000h
 2188:                          ELSE
 2189:          N      3000                     ORG     3000h
 2190:                          ENDIF
 2191:
 2192:    3000  E4              START0:         CLR     A
 2193:    3001  F5 A8                           MOV     IE,A                            ;Disable all interrupts
 2194:    3003  F5 59                           MOV     MODE,A                          ;Set mode to RS232 Terminal
 2195:    3005  F5 20                           MOV     INTBITS,A                       ;RAM int routines (.0-.5 INTERRUPTS, .6=LCD OUT, .7 Single step)
 2196:    3007  14                              DEC     A
 2197:    3008  F5 5A                           MOV     SSADRLSB,A                      ;Single step adress
 2198:    300A  F5 5B                           MOV     SSADRMSB,A                      ;Single step adress
 2199:    300C  F5 B0                           MOV     P3,A                            ;All bits input
 2200:    300E  75 CA D9                        MOV     RCAP2L,#0D9h                    ;19200bps with 24MHz OSC
 2201:    3011  75 CB FF                        MOV     RCAP2H,#0FFh
 2202:    3014  75 CC D9                        MOV     TL2,#0D9h
 2203:    3017  75 CD FF                        MOV     TH2,#0FFh
 2204:    301A  75 C8 34                        MOV     T2CON,#34h                      ;TF2=l
 2205:                                                                                  ;EXF2=l
 2206:                                                                                  ;RCLK=h
 2207:                                                                                  ;TCLK=h
 2208:                                                                                  ;EXEN2=l
 2209:                                                                                  ;TR2=h
 2210:                                                                                  ;C/T2#=l
 2211:                                                                                  ;CP/RL2#=l
 2212:    301D  75 98 50                        MOV     SCON,#50h                       ;SM0=l
 2213:                                                                                  ;SM1=h
 2214:                                                                                  ;SM2=l
 2215:                                                                                  ;REN=h
 2216:                                                                                  ;TB8=l
 2217:                                                                                  ;RB8=l
 2218:                                                                                  ;TI=l
 2219:                                                                                  ;RI=l
 2220:    3020  75 53 01                        MOV     ROMACTION,#01h                  ;Action
 2221:    3023  75 54 02                        MOV     ROMSIZE,#02h                    ;Size
 2222:    3026  75 55 01                        MOV     ROMMODE,#01h                    ;Mode
 2223:
 2224:    3029  D2 88                           SETB    IT0                             ;Edge triggered
 2225:    302B  D2 8A                           SETB    IT1                             ;Edge triggered
 2226:    302D  D2 A8                           SETB    EX0                             ;Enable INT0
 2227:    302F  D2 AA                           SETB    EX1                             ;Enable INT1
 2228:    3031  D2 AF                           SETB    EA                              ;Enable interrupts
 2229:    3033  12 3D 65                        LCALL   LCDINIT
 2230:
 2231:          N      FFFF     IF DEVMODE=1
 2232:    3036  75 20 7F                        MOV     INTBITS,#7Fh                    ;Redirect all interrupts, Output to terminal
 2233:          N      0000             IF DEBUG=1
 2234:                                          SETB    INTBITS.7                       ;Set single step flag
 2235:                                          CLR     IT1                             ;Level triggered
 2236:                                          CLR     P3.3                            ;Pull INT1 low
 2237:                                          NOP
 2238:                                          NOP
 2239:                                  ENDIF
 2240:                          ENDIF
 2241:
 2242:    3039  75 81 CF        START:          MOV     SP,#0CFh                        ;Init stack pointer. The stack is 48 bytes
 2243:    303C  90 20 00                        MOV     DPTR,#2000h
 2244:    303F  53 59 07                        ANL     MODE,#07h
 2245:
 2246:          N      FFFF     IF DEVMODE=1
 2247:    3042  30 98 03                        JNB     RI,START10
 2248:    3045  02 00 00                        LJMP    0000h
 2249:    3048  75 59 00        START10:        MOV     MODE,#0
 2250:                          ENDIF
 2251:
 2252:                          ;LCALL  LCDINIT
 2253:                          ;MOV    A,#41h
 2254:                          ;LCALL  LCDCHROUT
 2255:                          ;MOV    A,#42h
 2256:                          ;LCALL  LCDCHROUT
 2257:                          ;MOV    A,#43h
 2258:                          ;LCALL  LCDCHROUT
 2259:                          ;MOV    A,#41h
 2260:                          ;LCALL  LCDCHROUT
 2261:
 2262:    304B  AF 59                           MOV     R7,MODE
 2263:    304D  0F                              INC     R7
 2264:    304E  DF 02                           DJNZ    R7,START1
 2265:    3050  01 73                           AJMP    TERMINAL                        ;RS232 Terminal
 2266:    3052  DF 03           START1:         DJNZ    R7,START2
 2267:    3054  E4                              CLR     A                               ;Frequency counter channel 0
 2268:    3055  01 E1                           AJMP    FREQENCYCOUNT
 2269:    3057  DF 04           START2:         DJNZ    R7,START3                       ;Frequency counter channel 1
 2270:    3059  74 01                           MOV     A,#01h
 2271:    305B  01 E1                           AJMP    FREQENCYCOUNT
 2272:    305D  DF 04           START3:         DJNZ    R7,START4
 2273:    305F  74 02                           MOV     A,#02h                          ;Frequency counter channel 2
 2274:    3061  01 E1                           AJMP    FREQENCYCOUNT
 2275:    3063  DF 04           START4:         DJNZ    R7,START5
 2276:    3065  74 03                           MOV     A,#03h                          ;Frequency counter channel 3
 2277:    3067  01 E1                           AJMP    FREQENCYCOUNT
 2278:    3069  DF 02           START5:         DJNZ    R7,START6
 2279:    306B  21 28                           AJMP    ADCONVERTER                     ;AD Coverter
 2280:    306D  DF 02           START6:         DJNZ    R7,START7
 2281:    306F  21 83                           AJMP    LMETER                          ;Inductance
 2282:    3071  21 85           START7:         AJMP    CMETER                          ;Capacitance
 2283:
 2284:
 2285:                          ;RS232 Terminal
 2286:                          ;IN:    Nothing
 2287:                          ;OUT:   Nothing
 2288:    3073  51 BE           TERMINAL:       ACALL   HELPMENU
 2289:    3075  31 CA           TERMINAL1:      ACALL   PRNTCRLF
 2290:    3077  74 3E                           MOV     A,#3Eh
 2291:    3079  51 A7                           ACALL   TXBYTE
 2292:    307B  51 90           TERMINAL2:      ACALL   RXBYTE
 2293:    307D  B4 41 06                        CJNE    A,#41h,TERMINAL3
 2294:                                          ;Address input
 2295:    3080  31 C5                           ACALL   PRNTCMND
 2296:    3082  71 69                           ACALL   ADRINPUT
 2297:    3084  80 EF                           SJMP    TERMINAL1
 2298:    3086  B4 44 06        TERMINAL3:      CJNE    A,#44h,TERMINAL4
 2299:                                          ;Dump
 2300:    3089  31 C5                           ACALL   PRNTCMND
 2301:    308B  71 6C                           ACALL   DUMP
 2302:    308D  80 E4                           SJMP    TERMINAL
 2303:    308F  B4 45 06        TERMINAL4:      CJNE    A,#45h,TERMINAL5
 2304:                                          ;Enter hex
 2305:    3092  31 C5                           ACALL   PRNTCMND
 2306:    3094  71 98                           ACALL   ENTERHEX
 2307:    3096  80 DB                           SJMP    TERMINAL
 2308:    3098  B4 47 06        TERMINAL5:      CJNE    A,#47h,TERMINAL6
 2309:                                          ;Go
 2310:    309B  31 C5                           ACALL   PRNTCMND
 2311:    309D  B1 73                           ACALL   GO
 2312:    309F  80 D2                           SJMP    TERMINAL
 2313:    30A1  B4 48 04        TERMINAL6:      CJNE    A,#48h,TERMINAL7
 2314:                                          ;Help
 2315:    30A4  31 C5                           ACALL   PRNTCMND
 2316:    30A6  80 CB                           SJMP    TERMINAL
 2317:    30A8  B4 49 06        TERMINAL7:      CJNE    A,#49h,TERMINAL8
 2318:                                          ;Internal memory
 2319:    30AB  31 C5                           ACALL   PRNTCMND
 2320:    30AD  71 AD                           ACALL   MEMDUMP
 2321:    30AF  80 C4                           SJMP    TERMINAL1
 2322:    30B1  B4 4C 06        TERMINAL8:      CJNE    A,#4Ch,TERMINAL9
 2323:                                          ;Load
 2324:    30B4  31 C5                           ACALL   PRNTCMND
 2325:    30B6  B1 46                           ACALL   LOAD
 2326:    30B8  80 BB                           SJMP    TERMINAL1
 2327:    30BA  B4 50 06        TERMINAL9:      CJNE    A,#50h,TERMINAL10
 2328:                                          ;Program ROM
 2329:    30BD  31 C5                           ACALL   PRNTCMND
 2330:    30BF  B1 77                           ACALL   EPROM
 2331:    30C1  80 B0                           SJMP    TERMINAL
 2332:    30C3  B4 52 06        TERMINAL10:     CJNE    A,#52h,TERMINAL11
 2333:                                          ;Run
 2334:    30C6  31 C5                           ACALL   PRNTCMND
 2335:    30C8  B1 75                           ACALL   RUN
 2336:    30CA  80 A7                           SJMP    TERMINAL
 2337:    30CC  B4 53 07        TERMINAL11:     CJNE    A,#53h,TERMINAL12
 2338:                                          ;SFR dump
 2339:    30CF  12 31 C5                        LCALL   PRNTCMND
 2340:    30D2  71 D0                           ACALL   DUMPSFR
 2341:    30D4  80 9F                           SJMP    TERMINAL1
 2342:    30D6  B4 9F 03        TERMINAL12:     CJNE    A,#9Fh,TERMINAL13
 2343:                                          ;Esc
 2344:    30D9  02 00 00                        LJMP    0000h
 2345:    30DC  B4 0D 9C        TERMINAL13:     CJNE    A,#0Dh,TERMINAL2
 2346:                                          ;CR
 2347:    30DF  80 94                           SJMP    TERMINAL1
 2348:
 2349:
 2350:                          ;Frequency conter and AD Converter channel 2 and 3
 2351:                          ;IN:    Frequency cont channel (0-3)
 2352:                          ;OUT:   Nothing
 2353:    30E1  C0 E0           FREQENCYCOUNT:  PUSH    ACC
 2354:    30E3  12 3D 93                        LCALL   FRQCOUNT
 2355:    30E6  78 44                           MOV     R0,#LCDLINE+4                   ;Decimal buffer
 2356:    30E8  12 27 51                        LCALL   BIN2DEC
 2357:    30EB  FF                              MOV     R7,A                            ;Number of digits
 2358:    30EC  D0 E0                           POP     ACC
 2359:    30EE  C0 E0                           PUSH    ACC
 2360:    30F0  12 3D DA                        LCALL   FRQFORMAT
 2361:    30F3  78 40                           MOV     R0,#LCDLINE                     ;Output result
 2362:    30F5  7F 10                           MOV     R7,#10h
 2363:    30F7  31 A5                           ACALL   PRINTSTR
 2364:    30F9  74 02                           MOV     A,#02h                          ;ADC Channel 2
 2365:    30FB  12 3E 3D                        LCALL   ADCONVERT
 2366:    30FE  74 02                           MOV     A,#02h
 2367:    3100  79 44                           MOV     R1,#LCDLINE+4
 2368:    3102  12 3E A2                        LCALL   ADOUTPUT
 2369:    3105  74 03                           MOV     A,#03h                          ;ADC Channel 3
 2370:    3107  12 3E 3D                        LCALL   ADCONVERT
 2371:    310A  74 03                           MOV     A,#03h
 2372:    310C  79 4A                           MOV     R1,#LCDLINE+10
 2373:    310E  12 3E A2                        LCALL   ADOUTPUT
 2374:    3111  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2375:    3114  75 41 4E                        MOV     LCDLINE+1,#'N'
 2376:    3117  75 42 54                        MOV     LCDLINE+2,#'T'
 2377:    311A  75 43 20                        MOV     LCDLINE+3,#' '
 2378:    311D  78 40                           MOV     R0,#LCDLINE
 2379:    311F  7F 10                           MOV     R7,#10h
 2380:    3121  12 31 A5                        LCALL   PRINTSTR
 2381:    3124  D0 E0                           POP     ACC
 2382:    3126  01 39                           AJMP    START
 2383:
 2384:                          ;AD Converter
 2385:                          ;IN:    Nothing
 2386:                          ;OUT:   Nothing
 2387:    3128  74 02           ADCONVERTER:    MOV     A,#02h                          ;Channel 2
 2388:    312A  12 3E 3D                        LCALL   ADCONVERT
 2389:    312D  74 02                           MOV     A,#02h
 2390:    312F  79 44                           MOV     R1,#LCDLINE+4
 2391:    3131  12 3E A2                        LCALL   ADOUTPUT
 2392:    3134  74 03                           MOV     A,#03h                          ;Channel 3
 2393:    3136  12 3E 3D                        LCALL   ADCONVERT
 2394:    3139  74 03                           MOV     A,#03h
 2395:    313B  79 4A                           MOV     R1,#LCDLINE+10
 2396:    313D  12 3E A2                        LCALL   ADOUTPUT
 2397:    3140  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2398:    3143  75 41 4E                        MOV     LCDLINE+1,#'N'
 2399:    3146  75 42 54                        MOV     LCDLINE+2,#'T'
 2400:    3149  75 43 20                        MOV     LCDLINE+3,#' '
 2401:    314C  78 40                           MOV     R0,#LCDLINE
 2402:    314E  7F 10                           MOV     R7,#10h
 2403:    3150  12 31 A5                        LCALL   PRINTSTR
 2404:    3153  74 00                           MOV     A,#00h                          ;Channel 0
 2405:    3155  12 3E 3D                        LCALL   ADCONVERT
 2406:    3158  74 00                           MOV     A,#00h
 2407:    315A  79 44                           MOV     R1,#LCDLINE+4
 2408:    315C  12 3E A2                        LCALL   ADOUTPUT
 2409:    315F  74 01                           MOV     A,#01h                          ;Channel 1
 2410:    3161  12 3E 3D                        LCALL   ADCONVERT
 2411:    3164  74 01                           MOV     A,#01h
 2412:    3166  79 4A                           MOV     R1,#LCDLINE+10
 2413:    3168  12 3E A2                        LCALL   ADOUTPUT
 2414:    316B  75 40 45                        MOV     LCDLINE,#'E'                    ;Output result
 2415:    316E  75 41 58                        MOV     LCDLINE+1,#'X'
 2416:    3171  75 42 54                        MOV     LCDLINE+2,#'T'
 2417:    3174  75 43 20                        MOV     LCDLINE+3,#' '
 2418:    3177  78 40                           MOV     R0,#LCDLINE
 2419:    3179  7F 10                           MOV     R7,#10h
 2420:    317B  12 31 A5                        LCALL   PRINTSTR
 2421:    317E  12 3D 85                        LCALL   WAITASEC                        ;Wait 1 Secod
 2422:    3181  01 39                           AJMP    START
 2423:
 2424:                          ;Inductance meter
 2425:                          ;IN:    Nothing
 2426:                          ;OUT:   Nothing
 2427:    3183                  LMETER:
 2428:    3183  01 39                           AJMP    START
 2429:
 2430:                          ;Capacitance meter
 2431:                          ;IN:    Nothing
 2432:                          ;OUT:   Nothing
 2433:    3185                  CMETER:
 2434:    3185  01 39                           AJMP    START
 2435:
 2436:                          ;RS232 Functions
 2437:                          ;------------------------------------------------------------------
 2438:
 2439:    3187  85 82 57        PRNTCSTR:       MOV     DPLSAVE,DPL
 2440:    318A  85 83 58                        MOV     DPHSAVE,DPH
 2441:    318D  D0 83                           POP     DPH
 2442:    318F  D0 82                           POP     DPL
 2443:    3191  E4              PRNTCSTR1:      CLR     A
 2444:    3192  93                              MOVC    A,@A+DPTR
 2445:    3193  A3                              INC     DPTR
 2446:    3194  60 04                           JZ      PRNTCSTR2
 2447:    3196  51 A7                           ACALL   TXBYTE
 2448:    3198  80 F7                           SJMP    PRNTCSTR1
 2449:    319A  C0 82           PRNTCSTR2:      PUSH    DPL
 2450:    319C  C0 83                           PUSH    DPH
 2451:    319E  85 57 82                        MOV     DPL,DPLSAVE
 2452:    31A1  85 58 83                        MOV     DPH,DPHSAVE
 2453:    31A4  22                              RET
 2454:
 2455:    31A5  30 06 09        PRINTSTR:       JNB     INTBITS.6,PRINTSTRLCD
 2456:    31A8  E6              PRINTSTRTRM:    MOV     A,@R0
 2457:    31A9  51 A7                           ACALL   TXBYTE
 2458:    31AB  08                              INC     R0
 2459:    31AC  DF FA                           DJNZ    R7,PRINTSTRTRM
 2460:    31AE  31 CA                           ACALL   PRNTCRLF
 2461:    31B0  22                              RET
 2462:
 2463:    31B1  E6              PRINTSTRLCD:    MOV     A,@R0
 2464:    31B2  12 3D 46                        LCALL   LCDCHROUT
 2465:    31B5  08                              INC     R0
 2466:    31B6  DF F9                           DJNZ    R7,PRINTSTRLCD
 2467:    31B8  22                              RET
 2468:
 2469:    31B9  E0              PRINTDPTRSTR:   MOVX    A,@DPTR
 2470:    31BA  51 A7                           ACALL   TXBYTE
 2471:    31BC  A3                              INC     DPTR
 2472:    31BD  B4 0D F9                        CJNE    A,#0Dh,PRINTDPTRSTR
 2473:    31C0  74 0A                           MOV     A,#0Ah
 2474:    31C2  51 A7                           ACALL   TXBYTE
 2475:    31C4  22                              RET
 2476:
 2477:    31C5  51 A7           PRNTCMND:       ACALL   TXBYTE
 2478:    31C7  31 CA                           ACALL   PRNTCRLF
 2479:    31C9  22                              RET
 2480:
 2481:    31CA  74 0D           PRNTCRLF:       MOV     A,#0Dh
 2482:    31CC  51 A7                           ACALL   TXBYTE
 2483:    31CE  74 0A                           MOV     A,#0Ah
 2484:    31D0  51 A7                           ACALL   TXBYTE
 2485:    31D2  22                              RET
 2486:
 2487:    31D3  C0 E0           HEXOUT:         PUSH    ACC
 2488:    31D5  C4                              SWAP    A
 2489:    31D6  31 DA                           ACALL   HEXOUT1
 2490:    31D8  D0 E0                           POP     ACC
 2491:    31DA  54 0F           HEXOUT1:        ANL     A,#0Fh
 2492:    31DC  C3                              CLR     C
 2493:    31DD  94 0A                           SUBB    A,#0Ah
 2494:    31DF  40 02                           JC      HEXOUT2
 2495:    31E1  24 07                           ADD     A,#07h
 2496:    31E3  24 3A           HEXOUT2:        ADD     A,#3Ah
 2497:    31E5  51 A7                           ACALL   TXBYTE
 2498:    31E7  22                              RET
 2499:
 2500:    31E8  78 08           BINOUT:         MOV     R0,#08h
 2501:    31EA  33              BINOUT1:        RLC     A
 2502:    31EB  C0 E0                           PUSH    ACC
 2503:    31ED  74 20                           MOV     A,#20h
 2504:    31EF  12 32 A7                        LCALL   TXBYTE
 2505:    31F2  74 20                           MOV     A,#20h
 2506:    31F4  12 32 A7                        LCALL   TXBYTE
 2507:    31F7  74 30                           MOV     A,#30H
 2508:    31F9  50 01           BINOUT2:        JNC     BINOUT3
 2509:    31FB  04                              INC     A
 2510:    31FC  12 32 A7        BINOUT3:        LCALL   TXBYTE
 2511:    31FF  D0 E0                           POP     ACC
 2512:    3201  D8 E7                           DJNZ    R0,BINOUT1
 2513:    3203  12 31 CA                        LCALL   PRNTCRLF
 2514:    3206  22                              RET
 2515:
 2516:    3207  E5 83           HEXDPTR:        MOV     A,DPH
 2517:    3209  31 D3                           ACALL   HEXOUT
 2518:    320B  E5 82                           MOV     A,DPL
 2519:    320D  31 D3                           ACALL   HEXOUT
 2520:    320F  74 20                           MOV     A,#20h
 2521:    3211  51 A7                           ACALL   TXBYTE
 2522:    3213  22                              RET
 2523:
 2524:    3214  E5 24           HEXDUMPFP:      MOV     A,ARG_STACK
 2525:    3216  C3                              CLR     C
 2526:    3217  94 05                           SUBB    A,#05h
 2527:    3219  F5 82                           MOV     DPL,A
 2528:    321B  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 2529:    321E  7F 06                           MOV     R7,#06h
 2530:    3220  E0              HEXDUMPFP1:     MOVX    A,@DPTR
 2531:    3221  31 D3                           ACALL   HEXOUT
 2532:    3223  05 82                           INC     DPL
 2533:    3225  DF F9                           DJNZ    R7,HEXDUMPFP1
 2534:    3227  74 0D                           MOV     A,#0Dh
 2535:    3229  51 A7                           ACALL   TXBYTE
 2536:    322B  74 0A                           MOV     A,#0Ah
 2537:    322D  51 A7                           ACALL   TXBYTE
 2538:    322F  22                              RET
 2539:
 2540:    3230  51 3C           HEXINPBYTE:     ACALL   HEXINP
 2541:    3232  40 07                           JC      HEXINPBYTE1
 2542:    3234  C4                              SWAP    A
 2543:    3235  FB                              MOV     R3,A
 2544:    3236  51 3C                           ACALL   HEXINP
 2545:    3238  40 01                           JC      HEXINPBYTE1
 2546:    323A  2B                              ADD     A,R3
 2547:    323B  22              HEXINPBYTE1:    RET
 2548:
 2549:    323C  51 48           HEXINP:         ACALL   HEXINP2
 2550:    323E  40 07                           JC      HEXINP1
 2551:    3240  C0 E0                           PUSH    ACC
 2552:    3242  EA                              MOV     A,R2
 2553:    3243  51 A7                           ACALL   TXBYTE
 2554:    3245  D0 E0                           POP     ACC
 2555:    3247  22              HEXINP1:        RET
 2556:
 2557:    3248  51 90           HEXINP2:        ACALL   RXBYTE
 2558:    324A  B4 9F 02                        CJNE    A,#9Fh,HEXINP3                  ;Esc
 2559:    324D  D3                              SETB    C
 2560:    324E  22                              RET
 2561:    324F  B4 0D 02        HEXINP3:        CJNE    A,#0Dh,HEXINP4                  ;Cr
 2562:    3252  D3                              SETB    C
 2563:    3253  22                              RET
 2564:    3254  FA              HEXINP4:        MOV     R2,A
 2565:    3255  B4 3A 00                        CJNE    A,#3Ah,HEXINP40
 2566:    3258  50 08           HEXINP40:       JNC     HEXINP5
 2567:    325A  B4 30 00                        CJNE    A,#30h,HEXINP41
 2568:    325D  40 E9           HEXINP41:       JC      HEXINP2
 2569:    325F  94 30                           SUBB    A,#30h
 2570:    3261  22                              RET
 2571:    3262  B4 47 00        HEXINP5:        CJNE    A,#47h,HEXINP50
 2572:    3265  50 E1           HEXINP50:       JNC     HEXINP2
 2573:    3267  B4 41 00                        CJNE    A,#41h,HEXINP51
 2574:    326A  40 DC           HEXINP51:       JC      HEXINP2
 2575:    326C  94 37                           SUBB    A,#37h
 2576:    326E  22                              RET
 2577:
 2578:    326F  51 07           INPDPTR:        ACALL   HEXDPTR
 2579:    3271  51 30                           ACALL   HEXINPBYTE
 2580:    3273  40 08                           JC      INPDPTR1
 2581:    3275  F5 83                           MOV     DPH,A
 2582:    3277  51 30                           ACALL   HEXINPBYTE
 2583:    3279  40 02                           JC      INPDPTR1
 2584:    327B  F5 82                           MOV     DPL,A
 2585:    327D  31 CA           INPDPTR1:       ACALL   PRNTCRLF
 2586:    327F  22                              RET
 2587:
 2588:    3280  74 05           RX16BYTES:      MOV     A,#05h
 2589:    3282  51 A7                           ACALL   TXBYTE
 2590:    3284  78 40                           MOV     R0,#ROMBUFF
 2591:    3286  51 90           RX16BYTES1:     ACALL   RXBYTE
 2592:    3288  F6                              MOV     @R0,A
 2593:    3289  08                              INC     R0
 2594:    328A  B8 50 F9                        CJNE    R0,#ROMBUFF+10h,RX16BYTES1
 2595:    328D  78 40                           MOV     R0,#ROMBUFF
 2596:    328F  22                              RET
 2597:
 2598:    3290  20 AA 08        RXBYTE:         JB      EX1,RXBYTE1
 2599:    3293  30 98 FD                        JNB     RI,$
 2600:    3296  C2 98                           CLR     RI
 2601:    3298  E5 99                           MOV     A,SBUF
 2602:    329A  22                              RET
 2603:
 2604:    329B  C2 AA           RXBYTE1:        CLR     EX1
 2605:    329D  30 98 FD                        JNB     RI,$
 2606:    32A0  C2 98                           CLR     RI
 2607:    32A2  E5 99                           MOV     A,SBUF
 2608:    32A4  D2 AA                           SETB    EX1
 2609:    32A6  22                              RET
 2610:
 2611:    32A7  20 AA 08        TXBYTE:         JB      EX1,TXBYTE1
 2612:    32AA  F5 99                           MOV     SBUF,A
 2613:    32AC  30 99 FD                        JNB     TI,$
 2614:    32AF  C2 99                           CLR     TI
 2615:    32B1  22                              RET
 2616:
 2617:    32B2  C2 AA           TXBYTE1:        CLR     EX1
 2618:    32B4  F5 99                           MOV     SBUF,A
 2619:    32B6  30 99 FD                        JNB     TI,$
 2620:    32B9  C2 99                           CLR     TI
 2621:    32BB  D2 AA                           SETB    EX1
 2622:    32BD  22                              RET
 2623:
 2624:                          ;Functions
 2625:                          ;------------------------------------------------------------------
 2626:
 2627:    32BE  31 87           HELPMENU:       ACALL   PRNTCSTR
 2628:    32C0  0E                              DB      0Eh
 2629:          N      FFFF     IF DEVMODE=1
 2630:    32C1  2A 2A 2A 20                     DB      '*** DEVMODE ***',0Dh,0Ah
          32C5  44 45 56 4D
          32C9  4F 44 45 20
          32CD  2A 2A 2A 0D
          32D1  0A
 2631:                          ENDIF
 2632:    32D2  41 20 41 64                     DB      'A Address input',0Dh,0Ah
          32D6  64 72 65 73
          32DA  73 20 69 6E
          32DE  70 75 74 0D
          32E2  0A
 2633:    32E3  44 20 44 75                     DB      'D Dump as hex',0Dh,0Ah
          32E7  6D 70 20 61
          32EB  73 20 68 65
          32EF  78 0D 0A
 2634:    32F2  45 20 45 6E                     DB      'E Enter hex',0Dh,0Ah
          32F6  74 65 72 20
          32FA  68 65 78 0D
          32FE  0A
 2635:    32FF  47 20 47 6F                     DB      'G Go (Load and Run)',0Dh,0Ah
          3303  20 28 4C 6F
          3307  61 64 20 61
          330B  6E 64 20 52
          330F  75 6E 29 0D
          3313  0A
 2636:    3314  48 20 48 65                     DB      'H Help',0Dh,0Ah
          3318  6C 70 0D 0A
 2637:    331C  49 20 49 6E                     DB      'I Internal memory dump',0Dh,0Ah
          3320  74 65 72 6E
          3324  61 6C 20 6D
          3328  65 6D 6F 72
          332C  79 20 64 75
          3330  6D 70 0D 0A
 2638:    3334  4C 20 4C 6F                     DB      'L Load cmd file',0Dh,0Ah
          3338  61 64 20 63
          333C  6D 64 20 66
          3340  69 6C 65 0D
          3344  0A
 2639:    3345  50 20 50 72                     DB      'P Program ROM',0Dh,0Ah
          3349  6F 67 72 61
          334D  6D 20 52 4F
          3351  4D 0D 0A
 2640:    3354  52 20 52 75                     DB      'R Run',0Dh,0Ah
          3358  6E 0D 0A
 2641:    335B  53 20 53 46                     DB      'S SFR dunp',0Dh,0Ah,00h
          335F  52 20 64 75
          3363  6E 70 0D 0A
          3367  00
 2642:    3368  22                              RET
 2643:
 2644:    3369  51 6F           ADRINPUT:       ACALL   INPDPTR
 2645:    336B  22                              RET
 2646:
 2647:    336C  C0 82           DUMP:           PUSH    DPL
 2648:    336E  C0 83                           PUSH    DPH
 2649:    3370  C0 02                           PUSH    02h
 2650:    3372  C0 03                           PUSH    03h
 2651:    3374  7B 10           DUMP1:          MOV     R3,#10h
 2652:    3376  7A 10           DUMP2:          MOV     R2,#10h
 2653:    3378  51 07                           ACALL   HEXDPTR
 2654:    337A  E0              DUMP3:          MOVX    A,@DPTR
 2655:    337B  31 D3                           ACALL   HEXOUT
 2656:    337D  74 20                           MOV     A,#20h
 2657:    337F  51 A7                           ACALL   TXBYTE
 2658:    3381  A3                              INC     DPTR
 2659:    3382  DA F6                           DJNZ    R2,DUMP3
 2660:    3384  31 CA                           ACALL   PRNTCRLF
 2661:    3386  DB EE                           DJNZ    R3,DUMP2
 2662:    3388  31 CA                           ACALL   PRNTCRLF
 2663:    338A  51 90                           ACALL   RXBYTE
 2664:    338C  B4 9F E5                        CJNE    A,#9Fh,DUMP1                    ;Esc
 2665:    338F  D0 03                           POP     03h
 2666:    3391  D0 02                           POP     02h
 2667:    3393  D0 83                           POP     DPH
 2668:    3395  D0 82                           POP     DPL
 2669:    3397  22                              RET
 2670:
 2671:    3398  C0 82           ENTERHEX:       PUSH    DPL
 2672:    339A  C0 83                           PUSH    DPH
 2673:    339C  51 07           ENTERHEX1:      ACALL   HEXDPTR
 2674:    339E  51 30                           ACALL   HEXINPBYTE
 2675:    33A0  40 06                           JC      ENTERHEX2
 2676:    33A2  F0                              MOVX    @DPTR,A
 2677:    33A3  A3                              INC     DPTR
 2678:    33A4  31 CA                           ACALL   PRNTCRLF
 2679:    33A6  80 F4                           SJMP    ENTERHEX1
 2680:    33A8  D0 83           ENTERHEX2:      POP     DPH
 2681:    33AA  D0 82                           POP     DPL
 2682:    33AC  22                              RET
 2683:
 2684:    33AD  C0 00           MEMDUMP:        PUSH    00h
 2685:    33AF  78 00                           MOV     R0,#00h
 2686:    33B1  E4              MEMDUMP1:       CLR     A
 2687:    33B2  31 D3                           ACALL   HEXOUT
 2688:    33B4  E8                              MOV     A,R0
 2689:    33B5  31 D3                           ACALL   HEXOUT
 2690:    33B7  74 20                           MOV     A,#20h
 2691:    33B9  51 A7                           ACALL   TXBYTE
 2692:    33BB  E6              MEMDUMP2:       MOV     A,@R0
 2693:    33BC  31 D3                           ACALL   HEXOUT
 2694:    33BE  74 20                           MOV     A,#20h
 2695:    33C0  51 A7                           ACALL   TXBYTE
 2696:    33C2  08                              INC     R0
 2697:    33C3  E8                              MOV     A,R0
 2698:    33C4  54 0F                           ANL     A,#0Fh
 2699:    33C6  70 F3                           JNZ     MEMDUMP2
 2700:    33C8  31 CA                           ACALL   PRNTCRLF
 2701:    33CA  E8                              MOV     A,R0
 2702:    33CB  70 E4                           JNZ     MEMDUMP1
 2703:    33CD  D0 00                           POP     00h
 2704:    33CF  22                              RET
 2705:
 2706:    33D0  C0 D0           DUMPSFR:        PUSH    PSW
 2707:    33D2  C2 D3                           CLR     RS0
 2708:    33D4  C2 D4                           CLR     RS1
 2709:    33D6  C0 E0                           PUSH    ACC
 2710:    33D8  C0 00                           PUSH    00h
 2711:    33DA  C0 E0                           PUSH    ACC
 2712:    33DC  12 31 87                        LCALL   PRNTCSTR
 2713:    33DF  0D 0A 53 46                     DB 0Dh,0Ah,'SFR  D7 D6 D5 D4 D3 D2 D1 D0',0Dh,0Ah
          33E3  52 20 20 44
          33E7  37 20 44 36
          33EB  20 44 35 20
          33EF  44 34 20 44
          33F3  33 20 44 32
          33F7  20 44 31 20
          33FB  44 30 0D 0A
 2714:    33FF  2D 2D 2D 2D                     DB '----------------------------',0Dh,0Ah
          3403  2D 2D 2D 2D
          3407  2D 2D 2D 2D
          340B  2D 2D 2D 2D
          340F  2D 2D 2D 2D
          3413  2D 2D 2D 2D
          3417  2D 2D 2D 2D
          341B  0D 0A
 2715:    341D  41 43 43 20                     DB 'ACC ',0
          3421  00
 2716:    3422  D0 E0                           POP     ACC
 2717:    3424  12 31 E8                        LCALL   BINOUT
 2718:    3427  12 31 87                        LCALL   PRNTCSTR
 2719:    342A  42 20 20 20                     DB 'B   ',0
          342E  00
 2720:    342F  E5 F0                           MOV     A,B
 2721:    3431  12 31 E8                        LCALL   BINOUT
 2722:    3434  12 31 87                        LCALL   PRNTCSTR
 2723:    3437  44 50 48 20                     DB 'DPH ',0
          343B  00
 2724:    343C  E5 83                           MOV     A,DPH
 2725:    343E  12 31 E8                        LCALL   BINOUT
 2726:    3441  12 31 87                        LCALL   PRNTCSTR
 2727:    3444  44 50 4C 20                     DB 'DPL ',0
          3448  00
 2728:    3449  E5 82                           MOV     A,DPL
 2729:    344B  12 31 E8                        LCALL   BINOUT
 2730:    344E  12 31 87                        LCALL   PRNTCSTR
 2731:    3451  49 45 20 20                     DB 'IE  ',0
          3455  00
 2732:    3456  E5 A8                           MOV     A,IE
 2733:    3458  12 31 E8                        LCALL   BINOUT
 2734:    345B  12 31 87                        LCALL   PRNTCSTR
 2735:    345E  49 50 20 20                     DB 'IP  ',0
          3462  00
 2736:    3463  E5 B8                           MOV     A,IP
 2737:    3465  12 31 E8                        LCALL   BINOUT
 2738:    3468  12 31 87                        LCALL   PRNTCSTR
 2739:    346B  50 30 20 20                     DB 'P0  ',0
          346F  00
 2740:    3470  E5 80                           MOV     A,P0
 2741:    3472  12 31 E8                        LCALL   BINOUT
 2742:    3475  12 31 87                        LCALL   PRNTCSTR
 2743:    3478  50 31 20 20                     DB 'P1  ',0
          347C  00
 2744:    347D  E5 90                           MOV     A,P1
 2745:    347F  12 31 E8                        LCALL   BINOUT
 2746:    3482  12 31 87                        LCALL   PRNTCSTR
 2747:    3485  50 32 20 20                     DB 'P2  ',0
          3489  00
 2748:    348A  E5 A0                           MOV     A,P2
 2749:    348C  12 31 E8                        LCALL   BINOUT
 2750:    348F  12 31 87                        LCALL   PRNTCSTR
 2751:    3492  50 33 20 20                     DB 'P3  ',0
          3496  00
 2752:    3497  E5 B0                           MOV     A,P3
 2753:    3499  12 31 E8                        LCALL   BINOUT
 2754:    349C  12 31 87                        LCALL   PRNTCSTR
 2755:    349F  50 43 4F 4E                     DB 'PCON',0
          34A3  00
 2756:    34A4  E5 87                           MOV     A,PCON
 2757:    34A6  12 31 E8                        LCALL   BINOUT
 2758:    34A9  12 31 87                        LCALL   PRNTCSTR
 2759:    34AC  50 53 57 20                     DB 'PSW ',0
          34B0  00
 2760:    34B1  E5 D0                           MOV     A,PSW
 2761:    34B3  12 31 E8                        LCALL   BINOUT
 2762:    34B6  12 31 87                        LCALL   PRNTCSTR
 2763:    34B9  53 42 55 46                     DB 'SBUF',0
          34BD  00
 2764:    34BE  E5 99                           MOV     A,SBUF
 2765:    34C0  12 31 E8                        LCALL   BINOUT
 2766:    34C3  12 31 87                        LCALL   PRNTCSTR
 2767:    34C6  53 43 4F 4E                     DB 'SCON',0
          34CA  00
 2768:    34CB  E5 98                           MOV     A,SCON
 2769:    34CD  12 31 E8                        LCALL   BINOUT
 2770:    34D0  12 31 87                        LCALL   PRNTCSTR
 2771:    34D3  53 50 20 20                     DB 'SP  ',0
          34D7  00
 2772:    34D8  E5 81                           MOV     A,SP
 2773:    34DA  12 31 E8                        LCALL   BINOUT
 2774:    34DD  12 31 87                        LCALL   PRNTCSTR
 2775:    34E0  54 43 4F 4E                     DB 'TCON',0
          34E4  00
 2776:    34E5  E5 88                           MOV     A,TCON
 2777:    34E7  12 31 E8                        LCALL   BINOUT
 2778:    34EA  12 31 87                        LCALL   PRNTCSTR
 2779:    34ED  54 48 30 20                     DB 'TH0 ',0
          34F1  00
 2780:    34F2  E5 8C                           MOV     A,TH0
 2781:    34F4  12 31 E8                        LCALL   BINOUT
 2782:    34F7  12 31 87                        LCALL   PRNTCSTR
 2783:    34FA  54 48 31 20                     DB 'TH1 ',0
          34FE  00
 2784:    34FF  E5 8D                           MOV     A,TH1
 2785:    3501  12 31 E8                        LCALL   BINOUT
 2786:    3504  12 31 87                        LCALL   PRNTCSTR
 2787:    3507  54 4C 30 20                     DB 'TL0 ',0
          350B  00
 2788:    350C  E5 8A                           MOV     A,TL0
 2789:    350E  12 31 E8                        LCALL   BINOUT
 2790:    3511  12 31 87                        LCALL   PRNTCSTR
 2791:    3514  54 4C 31 20                     DB 'TL1 ',0
          3518  00
 2792:    3519  E5 8B                           MOV     A,TL1
 2793:    351B  12 31 E8                        LCALL   BINOUT
 2794:    351E  12 31 87                        LCALL   PRNTCSTR
 2795:    3521  54 4D 4F 44                     DB 'TMOD',0
          3525  00
 2796:    3526  E5 89                           MOV     A,TMOD
 2797:    3528  12 31 E8                        LCALL   BINOUT
 2798:    352B  D0 00                           POP     00h
 2799:    352D  D0 E0                           POP     ACC
 2800:    352F  D0 D0                           POP     PSW
 2801:    3531  22                              RET
 2802:
 2803:    3532  7B 40           LOAD1K:         MOV     R3,#40h
 2804:    3534  51 80           LOAD1K1:        ACALL   RX16BYTES                       ;Read 16 bytes from cmd file
 2805:    3536  E6              LOAD1K2:        MOV     A,@R0
 2806:    3537  F0                              MOVX    @DPTR,A
 2807:    3538  A3                              INC     DPTR
 2808:    3539  08                              INC     R0
 2809:    353A  E8                              MOV     A,R0
 2810:    353B  64 50                           XRL     A,#50h
 2811:    353D  70 F7                           JNZ     LOAD1K2                         ;Not 16 bytes yet
 2812:    353F  DB F3                           DJNZ    R3,LOAD1K1                      ;Not 1K yet
 2813:    3541  74 2E                           MOV     A,#'.'
 2814:    3543  51 A7                           ACALL   TXBYTE
 2815:    3545  22                              RET
 2816:
 2817:    3546  C0 82           LOAD:           PUSH    DPL
 2818:    3548  C0 83                           PUSH    DPH
 2819:    354A  C0 00                           PUSH    00h
 2820:    354C  C0 03                           PUSH    03h
 2821:    354E  C0 04                           PUSH    04h
 2822:    3550  31 87                           ACALL   PRNTCSTR
 2823:    3552  4C 6F 61 64                     DB      'Loading .',0
          3556  69 6E 67 20
          355A  2E 00
 2824:    355C  7C 08                           MOV     R4,#08h
 2825:    355E  B1 32           LOAD10:         ACALL   LOAD1K
 2826:    3560  DC FC                           DJNZ    R4,LOAD10
 2827:    3562  74 06                           MOV     A,#06h
 2828:    3564  51 A7                           ACALL   TXBYTE                          ;End read 16 bytes from cmd file
 2829:    3566  31 CA                           ACALL   PRNTCRLF
 2830:    3568  D0 04                           POP     04h
 2831:    356A  D0 03                           POP     03h
 2832:    356C  D0 00                           POP     00h
 2833:    356E  D0 83                           POP     DPH
 2834:    3570  D0 82                           POP     DPL
 2835:    3572  22                              RET
 2836:
 2837:    3573  B1 46           GO:             ACALL   LOAD
 2838:    3575  E4              RUN:            CLR     A
 2839:    3576  73                              JMP     @A+DPTR
 2840:
 2841:                          ;ROM menu selection
 2842:                          ;------------------------------------------------------------------
 2843:
 2844:    3577  B1 EC           EPROM:          ACALL   ROMMENU
 2845:    3579  B4 94 6F                        CJNE    A,#94h,EPROMEXIT
 2846:    357C  12 38 7C                        LCALL   ROMINSERT
 2847:    357F  40 F6                           JC      EPROM
 2848:    3581  12 3C BC                        LCALL   ROMINIT                         ;Turn on VCC, pull RST high and init programming mode
 2849:    3584  40 F1                           JC      EPROM                           ;Initialisation failed
 2850:    3586  E5 53                           MOV     A,ROMACTION
 2851:    3588  14                              DEC     A
 2852:    3589  70 12                           JNZ     EPROM2
 2853:                                          ;Test erased
 2854:    358B  12 39 26                        LCALL   ROMWAIT
 2855:    358E  E5 55                           MOV     A,ROMMODE
 2856:    3590  14                              DEC     A
 2857:    3591  70 05                           JNZ     EPROM1
 2858:    3593  12 39 36                        LCALL   BM_ROMERASED
 2859:    3596  80 DF                           SJMP    EPROM
 2860:    3598  12 3A 1B        EPROM1:         LCALL   PM_ROMERASED
 2861:    359B  80 DA                           SJMP    EPROM
 2862:    359D  14              EPROM2:         DEC     A
 2863:    359E  70 12                           JNZ     EPROM3
 2864:                                          ;Dump to hex file
 2865:    35A0  12 39 26                        LCALL   ROMWAIT
 2866:    35A3  E5 55                           MOV     A,ROMMODE
 2867:    35A5  14                              DEC     A
 2868:    35A6  70 05                           JNZ     EPROM21
 2869:    35A8  12 39 82                        LCALL   BM_ROMDUMPF
 2870:    35AB  80 CA                           SJMP    EPROM
 2871:    35AD  12 3A 72        EPROM21:        LCALL   PM_ROMDUMPF
 2872:    35B0  80 C5                           SJMP    EPROM
 2873:    35B2  14              EPROM3:         DEC     A
 2874:    35B3  70 0F                           JNZ     EPROM4
 2875:                                          ;Dump to screen
 2876:    35B5  E5 55                           MOV     A,ROMMODE
 2877:    35B7  14                              DEC     A
 2878:    35B8  70 05                           JNZ     EPROM31
 2879:    35BA  12 39 AE                        LCALL   BM_ROMDUMPS
 2880:    35BD  80 B8                           SJMP    EPROM
 2881:    35BF  12 3A AA        EPROM31:        LCALL   PM_ROMDUMPS
 2882:    35C2  80 B3                           SJMP    EPROM
 2883:    35C4  14              EPROM4:         DEC     A
 2884:    35C5  70 12                           JNZ     EPROM5
 2885:                                          ;Verify
 2886:    35C7  12 39 26                        LCALL   ROMWAIT
 2887:    35CA  E5 55                           MOV     A,ROMMODE
 2888:    35CC  14                              DEC     A
 2889:    35CD  70 05                           JNZ     EPROM41
 2890:    35CF  12 39 DB                        LCALL   BM_ROMVERIFY
 2891:    35D2  80 A3                           SJMP    EPROM
 2892:    35D4  12 3A E2        EPROM41:        LCALL   PM_ROMVERIFY
 2893:    35D7  80 9E                           SJMP    EPROM
 2894:    35D9                  EPROM5:         ;Program
 2895:    35D9  12 39 26                        LCALL   ROMWAIT
 2896:    35DC  E5 55                           MOV     A,ROMMODE
 2897:    35DE  14                              DEC     A
 2898:    35DF  70 05                           JNZ     EPROM51
 2899:    35E1  12 3B 59                        LCALL   PM_ROMPROG
 2900:    35E4  80 91                           SJMP    EPROM
 2901:    35E6  12 3B 59        EPROM51:        LCALL   PM_ROMPROG
 2902:    35E9  80 8C                           SJMP    EPROM
 2903:    35EB  22              EPROMEXIT:      RET
 2904:
 2905:    35EC  31 87           ROMMENU:        ACALL   PRNTCSTR
 2906:    35EE  0E                              DB      0Eh
 2907:    35EF  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          35F3  2D 2D 2D 2D
          35F7  2D 2D 2D 2D
          35FB  2D 2D 2D 2D
          35FF  2D 2D 2D 2D
          3603  20 20 2D 2D
          3607  2D 2D 2D 2D
          360B  2D 2D 2D 2D
          360F  2D 2D 2D 2D
          3613  2D 2D 2D 20
          3617  20 2D 2D 2D
          361B  2D 2D 2D 2D
          361F  2D 2D 2D 2D
          3623  2D 2D 2D 2D
          3627  2D 2D 0D 0A
 2908:    362B  20 20 20 7C                     DB      '   |  Action       |  |  EEPROM size  |  |  Mode         |',0Dh,0Ah
          362F  20 20 41 63
          3633  74 69 6F 6E
          3637  20 20 20 20
          363B  20 20 20 7C
          363F  20 20 7C 20
          3643  20 45 45 50
          3647  52 4F 4D 20
          364B  73 69 7A 65
          364F  20 20 7C 20
          3653  20 7C 20 20
          3657  4D 6F 64 65
          365B  20 20 20 20
          365F  20 20 20 20
          3663  20 7C 0D 0A
 2909:    3667  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          366B  2D 2D 2D 2D
          366F  2D 2D 2D 2D
          3673  2D 2D 2D 2D
          3677  2D 2D 2D 2D
          367B  20 20 2D 2D
          367F  2D 2D 2D 2D
          3683  2D 2D 2D 2D
          3687  2D 2D 2D 2D
          368B  2D 2D 2D 20
          368F  20 2D 2D 2D
          3693  2D 2D 2D 2D
          3697  2D 2D 2D 2D
          369B  2D 2D 2D 2D
          369F  2D 2D 0D 0A
 2910:    36A3  20 20 20 7C                     DB      '   |  Test erased  |  |  4K           |  |  Byte         |',0Dh,0Ah
          36A7  20 20 54 65
          36AB  73 74 20 65
          36AF  72 61 73 65
          36B3  64 20 20 7C
          36B7  20 20 7C 20
          36BB  20 34 4B 20
          36BF  20 20 20 20
          36C3  20 20 20 20
          36C7  20 20 7C 20
          36CB  20 7C 20 20
          36CF  42 79 74 65
          36D3  20 20 20 20
          36D7  20 20 20 20
          36DB  20 7C 0D 0A
 2911:    36DF  20 20 20 7C                     DB      '   |  Filedump     |  |  8K           |  |  Page         |',0Dh,0Ah
          36E3  20 20 46 69
          36E7  6C 65 64 75
          36EB  6D 70 20 20
          36EF  20 20 20 7C
          36F3  20 20 7C 20
          36F7  20 38 4B 20
          36FB  20 20 20 20
          36FF  20 20 20 20
          3703  20 20 7C 20
          3707  20 7C 20 20
          370B  50 61 67 65
          370F  20 20 20 20
          3713  20 20 20 20
          3717  20 7C 0D 0A
 2912:    371B  20 20 20 7C                     DB      '   |  Screendump   |  |  16K          |  |               |',0Dh,0Ah
          371F  20 20 53 63
          3723  72 65 65 6E
          3727  64 75 6D 70
          372B  20 20 20 7C
          372F  20 20 7C 20
          3733  20 31 36 4B
          3737  20 20 20 20
          373B  20 20 20 20
          373F  20 20 7C 20
          3743  20 7C 20 20
          3747  20 20 20 20
          374B  20 20 20 20
          374F  20 20 20 20
          3753  20 7C 0D 0A
 2913:    3757  20 20 20 7C                     DB      '   |  Verify       |  |  32K          |  |               |',0Dh,0Ah
          375B  20 20 56 65
          375F  72 69 66 79
          3763  20 20 20 20
          3767  20 20 20 7C
          376B  20 20 7C 20
          376F  20 33 32 4B
          3773  20 20 20 20
          3777  20 20 20 20
          377B  20 20 7C 20
          377F  20 7C 20 20
          3783  20 20 20 20
          3787  20 20 20 20
          378B  20 20 20 20
          378F  20 7C 0D 0A
 2914:    3793  20 20 20 7C                     DB      '   |  Program      |  |  64K          |  |               |',0Dh,0Ah
          3797  20 20 50 72
          379B  6F 67 72 61
          379F  6D 20 20 20
          37A3  20 20 20 7C
          37A7  20 20 7C 20
          37AB  20 36 34 4B
          37AF  20 20 20 20
          37B3  20 20 20 20
          37B7  20 20 7C 20
          37BB  20 7C 20 20
          37BF  20 20 20 20
          37C3  20 20 20 20
          37C7  20 20 20 20
          37CB  20 7C 0D 0A
 2915:    37CF  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          37D3  2D 2D 2D 2D
          37D7  2D 2D 2D 2D
          37DB  2D 2D 2D 2D
          37DF  2D 2D 2D 2D
          37E3  20 20 2D 2D
          37E7  2D 2D 2D 2D
          37EB  2D 2D 2D 2D
          37EF  2D 2D 2D 2D
          37F3  2D 2D 2D 20
          37F7  20 2D 2D 2D
          37FB  2D 2D 2D 2D
          37FF  2D 2D 2D 2D
          3803  2D 2D 2D 2D
          3807  2D 2D 0D 0A
 2916:    380B  00                              DB      00h
 2917:    380C  78 54                           MOV     R0,#ROMSIZE
 2918:    380E  11 5F                           ACALL   MENUSET
 2919:    3810  08                              INC     R0
 2920:    3811  11 5F                           ACALL   MENUSET
 2921:    3813  78 53                           MOV     R0,#ROMACTION
 2922:    3815  11 18                           ACALL   MENUXP
 2923:    3817  22                              RET
 2924:
 2925:    3818  11 5F           MENUXP:         ACALL   MENUSET
 2926:    381A  74 08                           MOV     A,#08h
 2927:    381C  12 32 A7                        LCALL   TXBYTE
 2928:    381F  12 32 90                        LCALL   RXBYTE
 2929:    3822  B4 9A 0C                        CJNE    A,#9Ah,MENUXP1
 2930:    3825  E6                              MOV     A,@R0
 2931:    3826  14                              DEC     A
 2932:    3827  60 EF                           JZ      MENUXP
 2933:    3829  74 20                           MOV     A,#20h
 2934:    382B  12 32 A7                        LCALL   TXBYTE
 2935:    382E  16                              DEC     @R0
 2936:    382F  80 E7                           SJMP    MENUXP
 2937:    3831  B4 9B 0D        MENUXP1:        CJNE    A,#9Bh,MENUXP2
 2938:    3834  E6                              MOV     A,@R0
 2939:    3835  94 05                           SUBB    A,#05h
 2940:    3837  60 DF                           JZ      MENUXP
 2941:    3839  74 20                           MOV     A,#20h
 2942:    383B  12 32 A7                        LCALL   TXBYTE
 2943:    383E  06                              INC     @R0
 2944:    383F  80 D7                           SJMP    MENUXP
 2945:    3841  B4 9C 08        MENUXP2:        CJNE    A,#9Ch,MENUYP1
 2946:    3844  E8                              MOV     A,R0
 2947:    3845  94 55                           SUBB    A,#ROMMODE
 2948:    3847  60 CF                           JZ      MENUXP
 2949:    3849  08                              INC     R0
 2950:    384A  80 CC                           SJMP    MENUXP
 2951:    384C  B4 9D 08        MENUYP1:        CJNE    A,#9Dh,MENUYP2
 2952:    384F  E8                              MOV     A,R0
 2953:    3850  94 53                           SUBB    A,#ROMACTION
 2954:    3852  60 C4                           JZ      MENUXP
 2955:    3854  18                              DEC     R0
 2956:    3855  80 C1                           SJMP    MENUXP
 2957:    3857  B4 9F 01        MENUYP2:        CJNE    A,#9Fh,MENUYP3                  ;Esc
 2958:    385A  22                              RET
 2959:    385B  B4 94 BA        MENUYP3:        CJNE    A,#94h,MENUXP                   ;Insert
 2960:    385E  22                              RET
 2961:
 2962:    385F  74 0B           MENUSET:        MOV     A,#0Bh
 2963:    3861  12 32 A7                        LCALL   TXBYTE
 2964:    3864  E6                              MOV     A,@R0
 2965:    3865  24 22                           ADD     A,#22h
 2966:    3867  12 32 A7                        LCALL   TXBYTE
 2967:    386A  E8                              MOV     A,R0
 2968:    386B  94 53                           SUBB    A,#ROMACTION
 2969:    386D  75 F0 13                        MOV     B,#13h
 2970:    3870  A4                              MUL     AB
 2971:    3871  24 24                           ADD     A,#24h
 2972:    3873  12 32 A7                        LCALL   TXBYTE
 2973:    3876  74 FB                           MOV     A,#0FBh                         ;
 2974:    3878  12 32 A7                        LCALL   TXBYTE
 2975:    387B  22                              RET
 2976:
 2977:                          ;------------------------------------------------------------------
 2978:
 2979:    387C  12 3C 6C        ROMINSERT:      LCALL   ROMOFF
 2980:    387F  12 31 87                        LCALL   PRNTCSTR
 2981:    3882  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Insert ',00h
          3886  6E 73 65 72
          388A  74 20 00
 2982:    388D  E5 54                           MOV     A,ROMSIZE
 2983:    388F  14                              DEC     A
 2984:    3890  70 09                           JNZ     ROMINSERT1
 2985:    3892  12 31 87                        LCALL   PRNTCSTR
 2986:    3895  34 4B 00                        DB      '4K',00h
 2987:    3898  75 52 10                        MOV     ROMPAGES,#10h                   ;16 Pages
 2988:    389B  14              ROMINSERT1:     DEC     A
 2989:    389C  70 09                           JNZ     ROMINSERT2
 2990:    389E  12 31 87                        LCALL   PRNTCSTR
 2991:    38A1  38 4B 00                        DB      '8K',00h
 2992:    38A4  75 52 20                        MOV     ROMPAGES,#20h                   ;32 Pages
 2993:    38A7  14              ROMINSERT2:     DEC     A
 2994:    38A8  70 0A                           JNZ     ROMINSERT3
 2995:    38AA  12 31 87                        LCALL   PRNTCSTR
 2996:    38AD  31 36 4B 00                     DB      '16K',00h
 2997:    38B1  75 52 40                        MOV     ROMPAGES,#40h                   ;64 Pages
 2998:    38B4  14              ROMINSERT3:     DEC     A
 2999:    38B5  70 0A                           JNZ     ROMINSERT4
 3000:    38B7  12 31 87                        LCALL   PRNTCSTR
 3001:    38BA  33 32 4B 00                     DB      '32K',00h
 3002:    38BE  75 52 80                        MOV     ROMPAGES,#80h                   ;128 Pages
 3003:    38C1  14              ROMINSERT4:     DEC     A
 3004:    38C2  70 0A                           JNZ     ROMINSERT5
 3005:    38C4  12 31 87                        LCALL   PRNTCSTR
 3006:    38C7  36 34 4B 00                     DB      '64K',00h
 3007:    38CB  75 52 00                        MOV     ROMPAGES,#00h                   ;256 Pages
 3008:    38CE  12 31 87        ROMINSERT5:     LCALL   PRNTCSTR
 3009:    38D1  20 64 65 76                     DB      ' device and strike <Enter> ',00h
          38D5  69 63 65 20
          38D9  61 6E 64 20
          38DD  73 74 72 69
          38E1  6B 65 20 3C
          38E5  45 6E 74 65
          38E9  72 3E 20 00
 3010:    38ED  12 32 90                        LCALL   RXBYTE
 3011:    38F0  B4 9F 02                        CJNE    A,#9Fh,ROMINSERT6               ;Esc
 3012:    38F3  D3                              SETB    C
 3013:    38F4  22                              RET
 3014:    38F5  12 31 87        ROMINSERT6:     LCALL   PRNTCSTR
 3015:    38F8  0B 2A 23 20                     DB      0Bh,2Ah,23h,'                                       '
          38FC  20 20 20 20
          3900  20 20 20 20
          3904  20 20 20 20
          3908  20 20 20 20
          390C  20 20 20 20
          3910  20 20 20 20
          3914  20 20 20 20
          3918  20 20 20 20
          391C  20 20 20 20
          3920  20 20
 3016:    3922  0D 00                           DB      0Dh,00h
 3017:    3924  C3                              CLR     C
 3018:    3925  22                              RET
 3019:
 3020:    3926  12 31 87        ROMWAIT:        LCALL   PRNTCSTR
 3021:    3929  0B 2A 23 57                     DB      0Bh,2Ah,23h,'Wait ...',00h
          392D  61 69 74 20
          3931  2E 2E 2E 00
 3022:    3935  22                              RET
 3023:
 3024:
 3025:                          ;Byte mode
 3026:                          ;------------------------------------------------------------------
 3027:
 3028:    3936  12 3C CC        BM_ROMERASED:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3029:    3939  B4 FF 0E                        CJNE    A,#0FFh,BM_ROMERASED1           ;Not erased
 3030:    393C  A3                              INC     DPTR                            ;Next address
 3031:    393D  E5 82                           MOV     A,DPL
 3032:    393F  70 F5                           JNZ     BM_ROMERASED                    ;Jump if more bytes in this page
 3033:    3941  E5 83                           MOV     A,DPH
 3034:    3943  B5 52 F0                        CJNE    A,ROMPAGES,BM_ROMERASED         ;Jump if more pages
 3035:    3946  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3036:    3949  22                              RET
 3037:    394A  12 3C 6C        BM_ROMERASED1:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3038:    394D  12 31 87                        LCALL   PRNTCSTR
 3039:    3950  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          3954  79 74 65 20
          3958  61 74 20 00
 3040:    395C  E5 83                           MOV     A,DPH
 3041:    395E  12 31 D3                        LCALL   HEXOUT                          ;High address
 3042:    3961  E5 82                           MOV     A,DPL
 3043:    3963  12 31 D3                        LCALL   HEXOUT                          ;Low address
 3044:    3966  12 31 87                        LCALL   PRNTCSTR
 3045:    3969  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          396D  20 65 72 61
          3971  73 65 64 20
          3975  3C 45 6E 74
          3979  65 72 3E 20
          397D  00
 3046:    397E  12 32 90                        LCALL   RXBYTE                          ;Wait for keypress
 3047:    3981  22                              RET
 3048:
 3049:    3982  74 03           BM_ROMDUMPF:    MOV     A,#03h
 3050:    3984  12 32 A7                        LCALL   TXBYTE                          ;Init write to file
 3051:    3987  12 3C CC        BM_ROMDUMPF1:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3052:    398A  12 31 D3                        LCALL   HEXOUT                          ;Output as hex
 3053:    398D  74 20                           MOV     A,#20h
 3054:    398F  12 32 A7                        LCALL   TXBYTE                          ;Output a space
 3055:    3992  A3                              INC     DPTR
 3056:    3993  E5 82                           MOV     A,DPL
 3057:    3995  54 0F                           ANL     A,#0Fh
 3058:    3997  70 03                           JNZ     BM_ROMDUMPF2                    ;Still on same line
 3059:    3999  12 31 CA                        LCALL   PRNTCRLF                        ;Output CRLF
 3060:    399C  E5 82           BM_ROMDUMPF2:   MOV     A,DPL
 3061:    399E  70 E7                           JNZ     BM_ROMDUMPF1                    ;Jump if more bytes in this page
 3062:    39A0  E5 83                           MOV     A,DPH
 3063:    39A2  B5 52 E2                        CJNE    A,ROMPAGES,BM_ROMDUMPF1         ;Jump if more pages
 3064:    39A5  74 04                           MOV     A,#04h
 3065:    39A7  12 32 A7                        LCALL   TXBYTE                          ;End write to file
 3066:    39AA  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3067:    39AD  22              BM_ROMDUMPF3:   RET
 3068:
 3069:    39AE  12 3C CC        BM_ROMDUMPS:    LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3070:    39B1  12 31 D3                        LCALL   HEXOUT                          ;Output as hex
 3071:    39B4  74 20                           MOV     A,#20h
 3072:    39B6  12 32 A7                        LCALL   TXBYTE                          ;Output a space
 3073:    39B9  A3                              INC     DPTR                            ;Next ROM address
 3074:    39BA  E5 82                           MOV     A,DPL
 3075:    39BC  54 0F                           ANL     A,#0Fh
 3076:    39BE  70 03                           JNZ     BM_ROMDUMPS1                    ;Jump if still on same line
 3077:    39C0  12 31 CA                        LCALL   PRNTCRLF                        ;Output CRLF
 3078:    39C3  E5 82           BM_ROMDUMPS1:   MOV     A,DPL
 3079:    39C5  70 E7                           JNZ     BM_ROMDUMPS                     ;Jump if more bytes in this page
 3080:    39C7  12 31 CA                        LCALL   PRNTCRLF                        ;Output CRLF
 3081:    39CA  12 32 90                        LCALL   RXBYTE                          ;Wait for a keypress
 3082:    39CD  B4 9F 02                        CJNE    A,#9Fh,BM_ROMDUMPS2
 3083:    39D0  80 05                           SJMP    BM_ROMDUMPS3
 3084:    39D2  E5 83           BM_ROMDUMPS2:   MOV     A,DPH
 3085:    39D4  B5 52 D7                        CJNE    A,ROMPAGES,BM_ROMDUMPS          ;Jump if more pages
 3086:    39D7  12 3C 6C        BM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3087:    39DA  22                              RET
 3088:
 3089:    39DB  C0 00           BM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3090:    39DD  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3091:    39E0  12 32 80                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3092:    39E3  86 51           BM_ROMVERIFY1:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3093:    39E5  12 3C CC                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3094:    39E8  B5 51 1D                        CJNE    A,ROMVER,BM_ROMVERIFY4          ;Compare and jump if not equal
 3095:    39EB  08              BM_ROMVERIFY2:  INC     R0                              ;Increment buffer pointer
 3096:    39EC  E8                              MOV     A,R0
 3097:    39ED  B4 50 03                        CJNE    A,#50h,BM_ROMVERIFY3            ;Jump if not last byte in buffer
 3098:    39F0  12 32 80                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3099:    39F3  A3              BM_ROMVERIFY3:  INC     DPTR                            ;Next ROM address
 3100:    39F4  E5 82                           MOV     A,DPL
 3101:    39F6  70 EB                           JNZ     BM_ROMVERIFY1                   ;Jump if still on same page
 3102:    39F8  E5 83                           MOV     A,DPH
 3103:    39FA  B5 52 E6                        CJNE    A,ROMPAGES,BM_ROMVERIFY1        ;Jump if more pages
 3104:    39FD  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3105:    3A00  74 06                           MOV     A,#06h
 3106:    3A02  12 32 A7                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3107:    3A05  D0 00                           POP     00h                             ;Restore R0
 3108:    3A07  22                              RET
 3109:    3A08  12 3C E1        BM_ROMVERIFY4:  LCALL   ROMVERIFYERR
 3110:    3A0B  50 DE                           JNC     BM_ROMVERIFY2                   ;Jump if less than 16 errors
 3111:    3A0D  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3112:    3A10  74 06                           MOV     A,#06h
 3113:    3A12  12 32 A7                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3114:    3A15  12 32 90                        LCALL   RXBYTE                          ;Wait for a keypress
 3115:    3A18  D0 00                           POP     00h                             ;Restore R0
 3116:    3A1A  22                              RET
 3117:
 3118:                          ;Page mode
 3119:                          ;------------------------------------------------------------------
 3120:
 3121:    3A1B  74 30           PM_ROMERASED:   MOV     A,#30h
 3122:    3A1D  12 3C 44                        LCALL   ISPCOMM                         ;Init read page mode
 3123:    3A20  E5 83                           MOV     A,DPH
 3124:    3A22  12 3C 44                        LCALL   ISPCOMM                         ;Send high address
 3125:    3A25  E4              PM_ROMERASED1:  CLR     A
 3126:    3A26  12 3C 44                        LCALL   ISPCOMM                         ;Get byte from ROM
 3127:    3A29  B4 FF 0E                        CJNE    A,#0FFh,PM_ROMERASED2           ;Jump if not erased
 3128:    3A2C  A3                              INC     DPTR
 3129:    3A2D  E5 82                           MOV     A,DPL
 3130:    3A2F  70 F4                           JNZ     PM_ROMERASED1                   ;Jump if more bytes on this page
 3131:    3A31  E5 83                           MOV     A,DPH
 3132:    3A33  B5 52 E5                        CJNE    A,ROMPAGES,PM_ROMERASED         ;Jump if more pagees
 3133:    3A36  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3134:    3A39  22                              RET
 3135:    3A3A  12 3C 6C        PM_ROMERASED2:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3136:    3A3D  12 31 87                        LCALL   PRNTCSTR
 3137:    3A40  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          3A44  79 74 65 20
          3A48  61 74 20 00
 3138:    3A4C  E5 83                           MOV     A,DPH
 3139:    3A4E  12 31 D3                        LCALL   HEXOUT                          ;Output high address as hex
 3140:    3A51  E5 82                           MOV     A,DPL
 3141:    3A53  12 31 D3                        LCALL   HEXOUT                          ;Output low address as hex
 3142:    3A56  12 31 87                        LCALL   PRNTCSTR
 3143:    3A59  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          3A5D  20 65 72 61
          3A61  73 65 64 20
          3A65  3C 45 6E 74
          3A69  65 72 3E 20
          3A6D  00
 3144:    3A6E  12 32 90                        LCALL   RXBYTE                          ;Wait for a keypress
 3145:    3A71  22                              RET
 3146:
 3147:    3A72  74 03           PM_ROMDUMPF:    MOV     A,#03h
 3148:    3A74  12 32 A7                        LCALL   TXBYTE                          ;Init Output to hex file
 3149:    3A77  74 30           PM_ROMDUMPF1:   MOV     A,#30h
 3150:    3A79  12 3C 44                        LCALL   ISPCOMM                         ;Init read page mode
 3151:    3A7C  E5 83                           MOV     A,DPH
 3152:    3A7E  12 3C 44                        LCALL   ISPCOMM                         ;Send high address
 3153:    3A81  E4              PM_ROMDUMPF2:   CLR     A
 3154:    3A82  12 3C 44                        LCALL   ISPCOMM                         ;Get byte from ROM
 3155:    3A85  12 31 D3                        LCALL   HEXOUT                          ;Output as hex
 3156:    3A88  74 20                           MOV     A,#20h
 3157:    3A8A  12 32 A7                        LCALL   TXBYTE                          ;Output a space
 3158:    3A8D  A3                              INC     DPTR
 3159:    3A8E  E5 82                           MOV     A,DPL
 3160:    3A90  54 0F                           ANL     A,#0Fh
 3161:    3A92  B4 00 07                        CJNE    A,#00h,PM_ROMDUMPF3             ;Jump if more bytes in this line
 3162:    3A95  12 31 CA                        LCALL   PRNTCRLF                        ;Output CRLF
 3163:    3A98  E5 82                           MOV     A,DPL
 3164:    3A9A  70 E5                           JNZ     PM_ROMDUMPF2                    ;Jump if more bytes in this page
 3165:    3A9C  E5 83           PM_ROMDUMPF3:   MOV     A,DPH
 3166:    3A9E  B5 52 D6                        CJNE    A,ROMPAGES,PM_ROMDUMPF1         ;Jump if more pages
 3167:    3AA1  74 04                           MOV     A,#04h
 3168:    3AA3  12 32 A7                        LCALL   TXBYTE                          ;End Output to hex file
 3169:    3AA6  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3170:    3AA9  22                              RET
 3171:
 3172:    3AAA  74 30           PM_ROMDUMPS:    MOV     A,#30h
 3173:    3AAC  12 3C 44                        LCALL   ISPCOMM                         ;Init read page mode
 3174:    3AAF  E5 83                           MOV     A,DPH
 3175:    3AB1  12 3C 44                        LCALL   ISPCOMM                         ;Send high address
 3176:    3AB4  E4              PM_ROMDUMPS1:   CLR     A
 3177:    3AB5  12 3C 44                        LCALL   ISPCOMM                         ;Get byte from ROM
 3178:    3AB8  12 31 D3                        LCALL   HEXOUT                          ;Output as hex
 3179:    3ABB  74 20                           MOV     A,#20h
 3180:    3ABD  12 32 A7                        LCALL   TXBYTE                          ;Output a space
 3181:    3AC0  A3                              INC     DPTR
 3182:    3AC1  E5 82                           MOV     A,DPL
 3183:    3AC3  54 0F                           ANL     A,#0Fh
 3184:    3AC5  70 12                           JNZ     PM_ROMDUMPS2                    ;Jump if still on same line
 3185:    3AC7  12 31 CA                        LCALL   PRNTCRLF                        ;Output CRLF
 3186:    3ACA  E5 82                           MOV     A,DPL
 3187:    3ACC  70 E6                           JNZ     PM_ROMDUMPS1                    ;Jump if more bytes on this page
 3188:    3ACE  12 31 CA                        LCALL   PRNTCRLF                        ;Output CRLF
 3189:    3AD1  12 32 90                        LCALL   RXBYTE                          ;Wait for a keypress
 3190:    3AD4  B4 9F 02                        CJNE    A,#9Fh,PM_ROMDUMPS2
 3191:    3AD7  80 05                           SJMP    PM_ROMDUMPS3                    ;Esc pressed
 3192:    3AD9  E5 83           PM_ROMDUMPS2:   MOV     A,DPH
 3193:    3ADB  B5 52 CC                        CJNE    A,ROMPAGES,PM_ROMDUMPS          ;Jump if more pages
 3194:    3ADE  12 3C 6C        PM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3195:    3AE1  22                              RET
 3196:
 3197:    3AE2  C0 00           PM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3198:    3AE4  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3199:    3AE7  12 32 80                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3200:    3AEA  74 30           PM_ROMVERIFY1:  MOV     A,#30h
 3201:    3AEC  12 3C 44                        LCALL   ISPCOMM                         ;Init read page mode
 3202:    3AEF  E5 83                           MOV     A,DPH
 3203:    3AF1  12 3C 44                        LCALL   ISPCOMM                         ;Send high address
 3204:    3AF4  86 51           PM_ROMVERIFY2:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3205:    3AF6  E4                              CLR     A
 3206:    3AF7  12 3C 44                        LCALL   ISPCOMM                         ;Get byte from ROM
 3207:    3AFA  B5 51 1D                        CJNE    A,ROMVER,PM_ROMVERIFY5          ;Compare and jump if not equal
 3208:    3AFD  08              PM_ROMVERIFY3:  INC     R0                              ;Increment buffer pointer
 3209:    3AFE  E8                              MOV     A,R0
 3210:    3AFF  B4 50 03                        CJNE    A,#50h,PM_ROMVERIFY4            ;Jump if not last byte in buffer
 3211:    3B02  12 32 80                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3212:    3B05  A3              PM_ROMVERIFY4:  INC     DPTR
 3213:    3B06  E5 82                           MOV     A,DPL
 3214:    3B08  70 EA                           JNZ     PM_ROMVERIFY2                   ;Jump if still on same page
 3215:    3B0A  E5 83                           MOV     A,DPH
 3216:    3B0C  B5 52 DB                        CJNE    A,ROMPAGES,PM_ROMVERIFY1        ;Jump if more pages
 3217:    3B0F  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3218:    3B12  74 06                           MOV     A,#06h
 3219:    3B14  12 32 A7                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3220:    3B17  D0 00                           POP     00h                             ;Restore R0
 3221:    3B19  22                              RET
 3222:    3B1A  12 3C E1        PM_ROMVERIFY5:  LCALL   ROMVERIFYERR
 3223:    3B1D  50 DE                           JNC     PM_ROMVERIFY3                   ;Jump if less than 16 errors
 3224:    3B1F  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3225:    3B22  74 06                           MOV     A,#06h
 3226:    3B24  12 32 A7                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3227:    3B27  12 32 90                        LCALL   RXBYTE                          ;Wait for keypress
 3228:    3B2A  D0 00                           POP     00h                             ;Restore R0
 3229:    3B2C  22                              RET
 3230:
 3231:    3B2D  90 00 00        PM_ISERASED:    MOV     DPTR,#0000h
 3232:    3B30  75 56 00                        MOV     ROMVERERR,#00h
 3233:    3B33  74 30           PM_ISERASED1:   MOV     A,#30h
 3234:    3B35  12 3C 44                        LCALL   ISPCOMM                         ;Init read page mode
 3235:    3B38  E5 83                           MOV     A,DPH
 3236:    3B3A  12 3C 44                        LCALL   ISPCOMM                         ;Send high address
 3237:    3B3D  E4              PM_ISERASED2:   CLR     A
 3238:    3B3E  12 3C 44                        LCALL   ISPCOMM                         ;Get byte from ROM
 3239:    3B41  04                              INC     A
 3240:    3B42  42 56                           ORL     ROMVERERR,A
 3241:    3B44  A3                              INC     DPTR
 3242:    3B45  E5 82                           MOV     A,DPL
 3243:    3B47  70 F4                           JNZ     PM_ISERASED2                    ;Jump if more bytes on this page
 3244:    3B49  E5 56                           MOV     A,ROMVERERR
 3245:    3B4B  70 05                           JNZ     PM_ISERASED3
 3246:    3B4D  E5 83                           MOV     A,DPH
 3247:    3B4F  B5 52 E1                        CJNE    A,ROMPAGES,PM_ISERASED1         ;Jump if more pagees
 3248:    3B52  C3              PM_ISERASED3:   CLR     C
 3249:    3B53  E5 56                           MOV     A,ROMVERERR
 3250:    3B55  60 01                           JZ      PM_ISERASED4
 3251:    3B57  D3                              SETB    C
 3252:    3B58  22              PM_ISERASED4:   RET
 3253:
 3254:    3B59  12 3B 2D        PM_ROMPROG:     LCALL   PM_ISERASED                     ;Check if chip is erased
 3255:    3B5C  50 4E                           JNC     PM_ROMPROG1
 3256:    3B5E  74 AC                           MOV     A,#0ACh
 3257:    3B60  12 3C 44                        LCALL   ISPCOMM                         ;Init chip erase byte 1
 3258:    3B63  74 80                           MOV     A,#80h
 3259:    3B65  12 3C 44                        LCALL   ISPCOMM                         ;Init chip erase byte 2
 3260:    3B68  E4                              CLR     A
 3261:    3B69  12 3C 44                        LCALL   ISPCOMM                         ;Init chip erase byte 3
 3262:    3B6C  E4                              CLR     A
 3263:    3B6D  12 3C 44                        LCALL   ISPCOMM                         ;Init chip erase byte 4
 3264:    3B70  E4                              CLR     A
 3265:    3B71  12 3C 3D                        LCALL   WAIT                            ;Wait 256 ms
 3266:    3B74  E4                              CLR     A
 3267:    3B75  12 3C 3D                        LCALL   WAIT                            ;Wait 256 ms
 3268:    3B78  E4                              CLR     A
 3269:    3B79  12 3C 3D                        LCALL   WAIT                            ;Wait 256 ms
 3270:    3B7C  12 3B 2D                        LCALL   PM_ISERASED
 3271:    3B7F  50 2B                           JNC     PM_ROMPROG1
 3272:    3B81  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3273:    3B84  12 31 87                        LCALL   PRNTCSTR
 3274:    3B87  0B 2A 23 43                     DB      0Bh,2Ah,23h,'Could not erase chip <Enter> ',00h
          3B8B  6F 75 6C 64
          3B8F  20 6E 6F 74
          3B93  20 65 72 61
          3B97  73 65 20 63
          3B9B  68 69 70 20
          3B9F  3C 45 6E 74
          3BA3  65 72 3E 20
          3BA7  00
 3275:    3BA8  12 32 90                        LCALL   RXBYTE                          ;Wait for keypress
 3276:    3BAB  22                              RET
 3277:    3BAC  C0 00           PM_ROMPROG1:    PUSH    00h
 3278:    3BAE  90 00 00                        MOV     DPTR,#0000h
 3279:    3BB1  12 32 80                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3280:    3BB4  74 40           PM_ROMPROG2:    MOV     A,#40h
 3281:    3BB6  12 3C 44                        LCALL   ISPCOMM                         ;Init byte programming mode
 3282:    3BB9  E5 83                           MOV     A,DPH
 3283:    3BBB  12 3C 44                        LCALL   ISPCOMM                         ;Send high address
 3284:    3BBE  E5 82                           MOV     A,DPL
 3285:    3BC0  12 3C 44                        LCALL   ISPCOMM                         ;Send low address
 3286:    3BC3  E6                              MOV     A,@R0                           ;Get byte from buffer
 3287:    3BC4  F5 51                           MOV     ROMVER,A
 3288:    3BC6  12 3C 44                        LCALL   ISPCOMM                         ;Send byte to be programmed
 3289:    3BC9  74 10                           MOV     A,#10h
 3290:    3BCB  12 3C 3D                        LCALL   WAIT                            ;Wait 1mS
 3291:    3BCE  12 3C CC                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3292:    3BD1  B5 51 22                        CJNE    A,ROMVER,PM_ROMPROG4            ;Compare and jump if not equal
 3293:    3BD4  08                              INC     R0
 3294:    3BD5  E8                              MOV     A,R0
 3295:    3BD6  B4 50 03                        CJNE    A,#50h,PM_ROMPROG3
 3296:    3BD9  12 32 80                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3297:    3BDC  A3              PM_ROMPROG3:    INC     DPTR
 3298:    3BDD  E5 82                           MOV     A,DPL
 3299:    3BDF  70 D3                           JNZ     PM_ROMPROG2                     ;Jump if still on same page
 3300:    3BE1  74 2E                           MOV     A,#2Eh
 3301:    3BE3  12 32 A7                        LCALL   TXBYTE
 3302:    3BE6  E5 83                           MOV     A,DPH
 3303:    3BE8  B5 52 C9                        CJNE    A,ROMPAGES,PM_ROMPROG2          ;Jump if more pages
 3304:    3BEB  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3305:    3BEE  74 06                           MOV     A,#06h
 3306:    3BF0  12 32 A7                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3307:    3BF3  D0 00                           POP     00h
 3308:    3BF5  22                              RET
 3309:    3BF6  C0 E0           PM_ROMPROG4:    PUSH    ACC
 3310:    3BF8  12 3C 6C                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3311:    3BFB  74 06                           MOV     A,#06h
 3312:    3BFD  12 32 A7                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3313:    3C00  12 31 87                        LCALL   PRNTCSTR
 3314:    3C03  0B 2A 23 45                     DB      0Bh,2Ah,23h,'Error at ',00h
          3C07  72 72 6F 72
          3C0B  20 61 74 20
          3C0F  00
 3315:    3C10  E5 83                           MOV     A,DPH
 3316:    3C12  12 31 D3                        LCALL   HEXOUT                          ;High address
 3317:    3C15  E5 82                           MOV     A,DPL
 3318:    3C17  12 31 D3                        LCALL   HEXOUT                          ;Low address
 3319:    3C1A  74 20                           MOV     A,#20h
 3320:    3C1C  12 32 A7                        LCALL   TXBYTE
 3321:    3C1F  E5 51                           MOV     A,ROMVER                        ;Byte from .cmd file
 3322:    3C21  12 31 D3                        LCALL   HEXOUT
 3323:    3C24  74 20                           MOV     A,#20h
 3324:    3C26  12 32 A7                        LCALL   TXBYTE
 3325:    3C29  D0 E0                           POP     ACC
 3326:    3C2B  12 31 D3                        LCALL   HEXOUT                          ;Byte read from ROM
 3327:    3C2E  12 32 90                        LCALL   RXBYTE                          ;Wait for a keypress
 3328:    3C31  D0 00                           POP     00h                             ;Restore R0
 3329:    3C33  22                              RET
 3330:
 3331:                          ;Wait functions
 3332:                          ;------------------------------------------------------------------
 3333:
 3334:    3C34  C0 07           WAIT100:        PUSH    07h                             ;Save R7
 3335:    3C36  7F 64                           MOV     R7,#64h
 3336:    3C38  DF FE           WAIT1001:       DJNZ    R7,WAIT1001                     ;Wait loop, 100uS
 3337:    3C3A  D0 07                           POP     07h                             ;Restore R7
 3338:    3C3C  22                              RET
 3339:
 3340:    3C3D  CF              WAIT:           XCH     A,R7
 3341:    3C3E  91 34           WAIT1:          ACALL   WAIT100
 3342:    3C40  DF FC                           DJNZ    R7,WAIT1
 3343:    3C42  CF                              XCH     A,R7
 3344:    3C43  22                              RET
 3345:
 3346:                          ;Control functions
 3347:                          ;------------------------------------------------------------------
 3348:
 3349:                          ;IN A, OUT A
 3350:    3C44  C0 07           ISPCOMM:        PUSH    07h
 3351:    3C46  C0 02                           PUSH    02h
 3352:    3C48  7A 08                           MOV     R2,#08h
 3353:    3C4A  33              ISPCOMM1:       RLC     A
 3354:    3C4B  92 93                           MOV     P1.3,C                          ;MISO
 3355:    3C4D  A2 94                           MOV     C,P1.4                          ;MOSI
 3356:    3C4F  CF                              XCH     A,R7
 3357:    3C50  33                              RLC     A
 3358:    3C51  CF                              XCH     A,R7
 3359:    3C52  D2 92                           SETB    P1.2                            ;SCK H
 3360:    3C54  00                              NOP
 3361:    3C55  C2 92                           CLR     P1.2                            ;SCK L
 3362:    3C57  DA F1                           DJNZ    R2,ISPCOMM1
 3363:    3C59  EF                              MOV     A,R7
 3364:    3C5A  D0 02                           POP     02
 3365:    3C5C  D0 07                           POP     07
 3366:    3C5E  22                              RET
 3367:
 3368:    3C5F  D2 90           ROMON:          SETB    P1.0                            ;+5V On
 3369:    3C61  74 0A                           MOV     A,#0Ah
 3370:    3C63  91 3D                           ACALL   WAIT                            ;Wait 1mS
 3371:    3C65  D2 91                           SETB    P1.1                            ;RST H
 3372:    3C67  74 0A                           MOV     A,#0Ah
 3373:    3C69  91 3D                           ACALL   WAIT                            ;Wait 1mS
 3374:    3C6B  22                              RET
 3375:
 3376:    3C6C  C2 91           ROMOFF:         CLR     P1.1                            ;RST L
 3377:    3C6E  74 01                           MOV     A,#01h
 3378:    3C70  91 3D                           ACALL   WAIT                            ;Wait 100uS
 3379:    3C72  75 90 10                        MOV     P1,#10h                         ;+5V Off, P1.4 As Input
 3380:    3C75  74 0A                           MOV     A,#0Ah
 3381:    3C77  12 3C 3D                        LCALL   WAIT                            ;Wait 1mS
 3382:    3C7A  22                              RET
 3383:
 3384:    3C7B  74 AC           ROMINITPGM:     MOV     A,#0ACh
 3385:    3C7D  12 3C 44                        LCALL   ISPCOMM
 3386:    3C80  74 53                           MOV     A,#53h
 3387:    3C82  12 3C 44                        LCALL   ISPCOMM
 3388:    3C85  74 00                           MOV     A,#00h
 3389:    3C87  12 3C 44                        LCALL   ISPCOMM
 3390:    3C8A  74 00                           MOV     A,#00h
 3391:    3C8C  12 3C 44                        LCALL   ISPCOMM
 3392:    3C8F  B4 69 01                        CJNE    A,#69h,ROMINITPGM1
 3393:    3C92  22                              RET
 3394:    3C93  12 31 87        ROMINITPGM1:    LCALL   PRNTCSTR
 3395:    3C96  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Initialisation Error <Enter> ',00h
          3C9A  6E 69 74 69
          3C9E  61 6C 69 73
          3CA2  61 74 69 6F
          3CA6  6E 20 45 72
          3CAA  72 6F 72 20
          3CAE  3C 45 6E 74
          3CB2  65 72 3E 20
          3CB6  00
 3396:    3CB7  12 32 90                        LCALL   RXBYTE
 3397:    3CBA  D3                              SETB    C
 3398:    3CBB  22                              RET
 3399:
 3400:    3CBC  90 00 00        ROMINIT:        MOV     DPTR,#0000h                     ;DPTR holds ROM address
 3401:    3CBF  12 3C 5F                        LCALL   ROMON                           ;Turn on VCC and pull RST high
 3402:    3CC2  12 3C 7B                        LCALL   ROMINITPGM
 3403:    3CC5  50 04                           JNC     ROMINIT1
 3404:    3CC7  12 3C 6C                        LCALL   ROMOFF                          ;Init programming failed
 3405:    3CCA  D3                              SETB    C
 3406:    3CCB  22              ROMINIT1:       RET
 3407:
 3408:    3CCC  74 20           BM_ROMRDBYTE:   MOV     A,#20h
 3409:    3CCE  12 3C 44                        LCALL   ISPCOMM
 3410:    3CD1  E5 83                           MOV     A,DPH
 3411:    3CD3  12 3C 44                        LCALL   ISPCOMM
 3412:    3CD6  E5 82                           MOV     A,DPL
 3413:    3CD8  12 3C 44                        LCALL   ISPCOMM
 3414:    3CDB  74 00                           MOV     A,#00h
 3415:    3CDD  12 3C 44                        LCALL   ISPCOMM
 3416:    3CE0  22                              RET
 3417:
 3418:    3CE1  C0 E0           ROMVERIFYERR:   PUSH    ACC
 3419:    3CE3  12 31 87                        LCALL   PRNTCSTR
 3420:    3CE6  0D 20 20 20                     DB      0Dh,'   Error at ',00h
          3CEA  45 72 72 6F
          3CEE  72 20 61 74
          3CF2  20 00
 3421:    3CF4  E5 83                           MOV     A,DPH
 3422:    3CF6  12 31 D3                        LCALL   HEXOUT
 3423:    3CF9  E5 82                           MOV     A,DPL
 3424:    3CFB  12 31 D3                        LCALL   HEXOUT
 3425:    3CFE  74 20                           MOV     A,#20h
 3426:    3D00  12 32 A7                        LCALL   TXBYTE
 3427:    3D03  E5 51                           MOV     A,ROMVER
 3428:    3D05  12 31 D3                        LCALL   HEXOUT
 3429:    3D08  74 20                           MOV     A,#20h
 3430:    3D0A  12 32 A7                        LCALL   TXBYTE
 3431:    3D0D  D0 E0                           POP     ACC
 3432:    3D0F  12 31 D3                        LCALL   HEXOUT
 3433:    3D12  12 31 CA                        LCALL   PRNTCRLF
 3434:    3D15  05 56                           INC     ROMVERERR
 3435:    3D17  E5 56                           MOV     A,ROMVERERR
 3436:    3D19  B4 10 00                        CJNE    A,#10h,ROMVERIFYERR1
 3437:    3D1C  B3              ROMVERIFYERR1:  CPL     C
 3438:    3D1D  22                              RET
 3439:
 3440:                          ;LCD Output.
 3441:                          ;-----------------------------------------------------
 3442:    3D1E  C0 07           LCDDELAY:       PUSH    07h
 3443:    3D20  7F 00                           MOV     R7,#00h
 3444:    3D22  DF FE                           DJNZ    R7,$
 3445:    3D24  D0 07                           POP     07h
 3446:    3D26  22                              RET
 3447:
 3448:                          ;A CONTAINS NIBBLE
 3449:    3D27  C2 E5           LCDNIBOUT:      CLR     ACC.5                           ; | negative edge on E
 3450:    3D29  F0                              MOVX    @DPTR,A                         ; |
 3451:    3D2A  00                              NOP
 3452:    3D2B  D2 E5                           SETB    ACC.5                           ; | E
 3453:    3D2D  F0                              MOVX    @DPTR,A                         ; |
 3454:    3D2E  00                              NOP
 3455:    3D2F  C2 E5                           CLR     ACC.5                           ; | negative edge on E
 3456:    3D31  F0                              MOVX    @DPTR,A                         ; |
 3457:    3D32  00                              NOP
 3458:    3D33  22                              RET
 3459:
 3460:                          ;A CONTAINS BYTE
 3461:    3D34  C0 E0           LCDCMDOUT:      PUSH    ACC
 3462:    3D36  C4                              SWAP    A                               ;High nibble first
 3463:    3D37  54 0F                           ANL     A,#0Fh
 3464:    3D39  B1 27                           ACALL   LCDNIBOUT
 3465:    3D3B  D0 E0                           POP     ACC
 3466:    3D3D  54 0F                           ANL     A,#0Fh
 3467:    3D3F  B1 27                           ACALL   LCDNIBOUT
 3468:    3D41  B1 1E                           ACALL   LCDDELAY                        ; wait for BF to clear
 3469:    3D43  B1 1E                           ACALL   LCDDELAY                        ; wait for BF to clear
 3470:    3D45  22                              RET
 3471:
 3472:                          ;A contains byte
 3473:    3D46  C0 82           LCDCHROUT:      PUSH    DPL
 3474:    3D48  C0 83                           PUSH    DPH
 3475:    3D4A  90 80 00                        MOV     DPTR,#8000h
 3476:    3D4D  C0 E0                           PUSH    ACC
 3477:    3D4F  C4                              SWAP    A                               ;High nibble first
 3478:    3D50  54 0F                           ANL     A,#0Fh
 3479:    3D52  D2 E4                           SETB    ACC.4                           ;RS
 3480:    3D54  B1 27                           ACALL   LCDNIBOUT
 3481:    3D56  D0 E0                           POP     ACC
 3482:    3D58  54 0F                           ANL     A,#0Fh
 3483:    3D5A  D2 E4                           SETB    ACC.4                           ;RS
 3484:    3D5C  B1 27                           ACALL   LCDNIBOUT
 3485:    3D5E  B1 1E                           ACALL   LCDDELAY                        ; wait for BF to clear
 3486:    3D60  D0 83                           POP     DPH
 3487:    3D62  D0 82                           POP     DPL
 3488:    3D64  22                              RET
 3489:
 3490:    3D65  C0 82           LCDINIT:        PUSH    DPL
 3491:    3D67  C0 83                           PUSH    DPH
 3492:    3D69  90 80 00                        MOV     DPTR,#8000h
 3493:                                          ;Function set
 3494:    3D6C  74 02                           MOV     A,#00000010b
 3495:    3D6E  B1 27                           ACALL   LCDNIBOUT
 3496:    3D70  74 20                           MOV     A,#00100000b
 3497:    3D72  B1 34                           ACALL   LCDCMDOUT
 3498:                                          ;Display ON/OFF
 3499:    3D74  74 0F                           MOV     A,#00001111b
 3500:    3D76  B1 34                           ACALL   LCDCMDOUT
 3501:                                          ;Clear
 3502:    3D78  74 01                           MOV     A,#00000001b
 3503:    3D7A  B1 34                           ACALL   LCDCMDOUT
 3504:                                          ;Cursor direction
 3505:    3D7C  74 06                           MOV     A,#00000110b
 3506:    3D7E  B1 34                           ACALL   LCDCMDOUT
 3507:    3D80  D0 83                           POP     DPH
 3508:    3D82  D0 82                           POP     DPL
 3509:    3D84  22                              RET
 3510:
 3511:                          ;Wait 1 second
 3512:                          ;Wait loop
 3513:                          ;-----------------------------------------------------
 3514:    3D85  7F F8           WAITASEC:       MOV     R7,#0F8h
 3515:    3D87  7E 33                           MOV     R6,#51
 3516:    3D89  7D 10                           MOV     R5,#16
 3517:    3D8B  DF FE           WAITASEC1:      DJNZ    R7,WAITASEC1
 3518:    3D8D  DE FC                           DJNZ    R6,WAITASEC1
 3519:    3D8F  DD FA                           DJNZ    R5,WAITASEC1
 3520:    3D91  00                              NOP
 3521:    3D92  22                              RET
 3522:
 3523:                          ;Frequency counter.
 3524:                          ;LSB from 74LS393 read at 8001h, TL0, TH0, TF0 bit. 25 bits
 3525:                          ;IN;    A holds channel (0 to 3).
 3526:                          ;OUT:   32 Bit result in R7:R6:R5:R4
 3527:                          ;------------------------------------------------------------------
 3528:    3D93  D2 E2           FRQCOUNT:       SETB    ACC.2                           ;D2     FRQ Gate active low
 3529:    3D95  D2 E3                           SETB    ACC.3                           ;D3     FRQ     Reset active high
 3530:    3D97  D2 E4                           SETB    ACC.4                           ;D4     ADC CS Active low
 3531:    3D99  D2 E5                           SETB    ACC.5                           ;D5     ADC CLK High to low transition
 3532:    3D9B  D2 E6                           SETB    ACC.6                           ;D6     ADC DIN
 3533:    3D9D  D2 E7                           SETB    ACC.7                           ;D7
 3534:    3D9F  90 80 01                        MOV     DPTR,#8001h
 3535:    3DA2  F0                              MOVX    @DPTR,A                         ;Reset and gate off
 3536:    3DA3  C0 E0                           PUSH    ACC
 3537:    3DA5  75 8A 00                        MOV     TL0,#00h
 3538:    3DA8  75 8C 00                        MOV     TH0,#00h
 3539:    3DAB  E5 89                           MOV     A,TMOD
 3540:    3DAD  D2 E0                           SETB    ACC.0                           ;M00
 3541:    3DAF  C2 E1                           CLR     ACC.1                           ;M01
 3542:    3DB1  D2 E2                           SETB    ACC.2                           ;C/T0#
 3543:    3DB3  C2 E3                           CLR     ACC.3                           ;GATE0
 3544:    3DB5  F5 89                           MOV     TMOD,A
 3545:    3DB7  E5 88                           MOV     A,TCON
 3546:    3DB9  D2 E4                           SETB    ACC.4                           ;TR0
 3547:    3DBB  C2 E5                           CLR     ACC.5                           ;TF0
 3548:    3DBD  F5 88                           MOV     TCON,A
 3549:    3DBF  D0 E0                           POP     ACC
 3550:    3DC1  C2 E2                           CLR     ACC.2                           ;D2     FRQ Gate active low
 3551:    3DC3  C2 E3                           CLR     ACC.3                           ;D3     FRQ Reset active high
 3552:    3DC5  F0                              MOVX    @DPTR,A                         ;Select internal ALE,Gate on(low),Reset inactive
 3553:    3DC6  B1 85                           ACALL   WAITASEC
 3554:    3DC8  D2 E2                           SETB    ACC.2                           ;D2     FRQ Gate active low
 3555:    3DCA  F0                              MOVX    @DPTR,A                         ;Stop counting
 3556:    3DCB  E0                              MOVX    A,@DPTR
 3557:    3DCC  FC                              MOV     R4,A
 3558:    3DCD  E5 8A                           MOV     A,TL0
 3559:    3DCF  FD                              MOV     R5,A
 3560:    3DD0  E5 8C                           MOV     A,TH0
 3561:    3DD2  FE                              MOV     R6,A
 3562:    3DD3  E4                              CLR     A                               ;TF0 Is the 25th bit
 3563:    3DD4  A2 8D                           MOV     C,TF0
 3564:    3DD6  92 E0                           MOV     ACC.0,C
 3565:    3DD8  FF                              MOV     R7,A
 3566:    3DD9  22                              RET
 3567:
 3568:                          ;Format frequency conter text line
 3569:                          ;IN:    A holds channel (0 to 3)
 3570:                          ;       LCDLINE+4 Decimal result
 3571:                          ;       R7 Number of digits
 3572:                          ;OUT:   Formatted LCDLINE
 3573:    3DDA  75 40 43        FRQFORMAT:      MOV     LCDLINE,#'C'
 3574:    3DDD  75 41 48                        MOV     LCDLINE+1,#'H'
 3575:    3DE0  44 30                           ORL     A,#30h
 3576:    3DE2  F5 42                           MOV     LCDLINE+2,A
 3577:    3DE4  75 43 20                        MOV     LCDLINE+3,#' '
 3578:    3DE7  78 44                           MOV     R0,#LCDLINE+4
 3579:    3DE9  79 46                           MOV     R1,#LCDLINE+6
 3580:    3DEB  BF 07 00                        CJNE    R7,#07h,$+3
 3581:    3DEE  40 19                           JC      FRQFORMATKHZ
 3582:                                          ;MHz
 3583:    3DF0  7F 08                           MOV     R7,#08h
 3584:    3DF2  E7              FRQFORMATMHZ1:  MOV     A,@R1
 3585:    3DF3  BF 06 03                        CJNE    R7,#06h,FRQFORMATMHZ2
 3586:    3DF6  76 2E                           MOV     @R0,#'.'
 3587:    3DF8  08                              INC     R0
 3588:    3DF9  F6              FRQFORMATMHZ2:  MOV     @R0,A
 3589:    3DFA  08                              INC     R0
 3590:    3DFB  09                              INC     R1
 3591:    3DFC  DF F4                           DJNZ    R7,FRQFORMATMHZ1
 3592:    3DFE  75 4D 4D                        MOV     LCDLINE+13,#'M'
 3593:    3E01  75 4E 48                        MOV     LCDLINE+14,#'H'
 3594:    3E04  75 4F 7A                        MOV     LCDLINE+15,#'z'
 3595:    3E07  80 33                           SJMP    FRQFORMATDONE
 3596:    3E09  BF 04 00        FRQFORMATKHZ:   CJNE    R7,#04h,$+3
 3597:    3E0C  40 19                           JC      FRQFORMATHZ
 3598:                                          ;KHz
 3599:    3E0E  7F 08                           MOV     R7,#08h
 3600:    3E10  E7              FRQFORMATKHZ1:  MOV     A,@R1
 3601:    3E11  BF 03 03                        CJNE    R7,#03h,FRQFORMATKHZ2
 3602:    3E14  76 2E                           MOV     @R0,#'.'
 3603:    3E16  08                              INC     R0
 3604:    3E17  F6              FRQFORMATKHZ2:  MOV     @R0,A
 3605:    3E18  08                              INC     R0
 3606:    3E19  09                              INC     R1
 3607:    3E1A  DF F4                           DJNZ    R7,FRQFORMATKHZ1
 3608:    3E1C  75 4D 4B                        MOV     LCDLINE+13,#'K'
 3609:    3E1F  75 4E 48                        MOV     LCDLINE+14,#'H'
 3610:    3E22  75 4F 7A                        MOV     LCDLINE+15,#'z'
 3611:    3E25  80 15                           SJMP    FRQFORMATDONE
 3612:    3E27                  FRQFORMATHZ:    ;Hz
 3613:    3E27  75 44 20                        MOV     LCDLINE+4,#' '
 3614:    3E2A  08                              INC     R0
 3615:    3E2B  7F 08                           MOV     R7,#08h
 3616:    3E2D  E7              FRQFORMATHZ1:   MOV     A,@R1
 3617:    3E2E  F6                              MOV     @R0,A
 3618:    3E2F  08                              INC     R0
 3619:    3E30  09                              INC     R1
 3620:    3E31  DF FA                           DJNZ    R7,FRQFORMATHZ1
 3621:    3E33  75 4D 48                        MOV     LCDLINE+13,#'H'
 3622:    3E36  75 4E 7A                        MOV     LCDLINE+14,#'z'
 3623:    3E39  75 4F 20                        MOV     LCDLINE+15,#' '
 3624:    3E3C  22              FRQFORMATDONE:  RET
 3625:
 3626:                          ;AD Converter.
 3627:                          ;IN:    A holds channel (0 to 7).
 3628:                          ;OUT:   R2:R0 Holds 16 Bit result
 3629:                          ;-----------------------------------------------------
 3630:    3E3D  D2 E4           ADCONVERT:      SETB    ACC.4                           ;START
 3631:    3E3F  D2 E3                           SETB    ACC.3                           ;SINGLE ENDED
 3632:    3E41  23                              RL      A
 3633:    3E42  23                              RL      A
 3634:    3E43  23                              RL      A
 3635:    3E44  FA                              MOV     R2,A
 3636:    3E45  C2 E0                           CLR     ACC.0                           ;FRQ SEL
 3637:    3E47  C2 E1                           CLR     ACC.1                           ;FRQ SEL
 3638:    3E49  D2 E2                           SETB    ACC.2                           ;D2             FRQ GATE ACTIVE LOW
 3639:    3E4B  D2 E3                           SETB    ACC.3                           ;D3             FRQ     RESET ACTIVE HIGH
 3640:    3E4D  D2 E4                           SETB    ACC.4                           ;D4             ADC CS ACTIVE LOW
 3641:    3E4F  D2 E5                           SETB    ACC.5                           ;D5             ADC CLK HIGH TO LOW TRANSITION
 3642:    3E51  D2 E6                           SETB    ACC.6                           ;D6             ADC DIN
 3643:    3E53  D2 E7                           SETB    ACC.7                           ;D7
 3644:    3E55  90 80 01                        MOV     DPTR,#8001h
 3645:    3E58  F0                              MOVX    @DPTR,A
 3646:                                          ;CS low
 3647:    3E59  C2 E4                           CLR     ACC.4                           ;D4             ADC CS ACTIVE LOW
 3648:    3E5B  F0                              MOVX    @DPTR,A
 3649:                                          ;Clock in channel select and Single/Diff+2 clocks for sample
 3650:    3E5C  7F 07                           MOV     R7,#07h
 3651:    3E5E  CA              ADCONVERT1:     XCH     A,R2
 3652:    3E5F  33                              RLC     A
 3653:    3E60  CA                              XCH     A,R2
 3654:    3E61  92 E6                           MOV     ACC.6,C ;ADC DIN
 3655:    3E63  C2 E5                           CLR     ACC.5
 3656:    3E65  F0                              MOVX    @DPTR,A
 3657:    3E66  D2 E5                           SETB    ACC.5
 3658:    3E68  F0                              MOVX    @DPTR,A
 3659:    3E69  DF F3                           DJNZ    R7,ADCONVERT1
 3660:    3E6B  7A 00                           MOV     R2,#00h
 3661:                                          ;Clock in 5 bits, including null bit
 3662:    3E6D  7F 05                           MOV     R7,#05h
 3663:    3E6F  C0 E0           ADCONVERT2:     PUSH    ACC
 3664:    3E71  90 80 00                        MOV     DPTR,#8000h
 3665:    3E74  E0                              MOVX    A,@DPTR
 3666:    3E75  13                              RRC     A
 3667:    3E76  CA                              XCH     A,R2
 3668:    3E77  33                              RLC     A
 3669:    3E78  CA                              XCH     A,R2
 3670:    3E79  90 80 01                        MOV     DPTR,#8001h
 3671:    3E7C  D0 E0                           POP     ACC
 3672:    3E7E  C2 E5                           CLR     ACC.5
 3673:    3E80  F0                              MOVX    @DPTR,A
 3674:    3E81  D2 E5                           SETB    ACC.5
 3675:    3E83  F0                              MOVX    @DPTR,A
 3676:    3E84  DF E9                           DJNZ    R7,ADCONVERT2
 3677:    3E86  78 00                           MOV     R0,#00h
 3678:                                          ;Clock in 8 bits
 3679:    3E88  7F 08                           MOV     R7,#08h
 3680:    3E8A  F0              ADCONVERT3:     MOVX    @DPTR,A
 3681:    3E8B  C0 E0                           PUSH    ACC
 3682:    3E8D  90 80 00                        MOV     DPTR,#8000h
 3683:    3E90  E0                              MOVX    A,@DPTR
 3684:    3E91  13                              RRC     A
 3685:    3E92  C8                              XCH     A,R0
 3686:    3E93  33                              RLC     A
 3687:    3E94  C8                              XCH     A,R0
 3688:    3E95  90 80 01                        MOV     DPTR,#8001h
 3689:    3E98  D0 E0                           POP     ACC
 3690:    3E9A  C2 E5                           CLR     ACC.5
 3691:    3E9C  F0                              MOVX    @DPTR,A
 3692:    3E9D  D2 E5                           SETB    ACC.5
 3693:    3E9F  DF E9                           DJNZ    R7,ADCONVERT3
 3694:    3EA1  22                              RET
 3695:
 3696:                          ;AD Converter output
 3697:                          ;IN:    A holds channel (0 to 7).
 3698:                          ;       R2:R0 adc result
 3699:                          ;       R1 pointer to buffer
 3700:                          ;OUT:   6 Characters
 3701:                          ;-----------------------------------------------------
 3702:    3EA2  89 50           ADOUTPUT:       MOV     FPCHR_OUT,R1
 3703:    3EA4  C0 E0                           PUSH    ACC
 3704:                                          ;Convert 16 bit integer in R2:R0 to float and push it to fp arg stack
 3705:    3EA6  12 23 BF                        LCALL   PUSHR2R0
 3706:                                          ;Push the channelS constant to fp arg stack
 3707:    3EA9  90 27 CF                        MOV     DPTR,#ADCMUL
 3708:    3EAC  D0 E0                           POP     ACC
 3709:    3EAE  75 F0 06                        MOV     B,#FP_NUMBER_SIZE
 3710:    3EB1  A4                              MUL     AB
 3711:    3EB2  25 82                           ADD     A,DPL
 3712:    3EB4  F5 82                           MOV     DPL,A
 3713:    3EB6  50 02                           JNC     ADOUTPUT1
 3714:    3EB8  05 83                           INC     DPH
 3715:    3EBA  12 27 3B        ADOUTPUT1:      LCALL   PUSHC
 3716:                                          ;Multiply
 3717:    3EBD  12 21 96                        LCALL   FLOATING_MUL
 3718:    3EC0  75 25 22                        MOV     FORMAT,#22h
 3719:    3EC3  E5 24                           MOV     A,ARG_STACK
 3720:    3EC5  C3                              CLR     C
 3721:    3EC6  94 05                           SUBB    A,#05h
 3722:    3EC8  F8                              MOV     R0,A
 3723:    3EC9  12 24 83                        LCALL   FLOATING_POINT_OUTPUT
 3724:    3ECC  22                              RET
 3725:
 3726:                          ;Single step called when INT1 pin low and interupt is enabled
 3727:                          ;------------------------------------------------------------------
 3728:    3ECD  C0 D0           SINGLESTEP:     PUSH    PSW
 3729:    3ECF  C0 E0                           PUSH    ACC
 3730:    3ED1  C2 D3                           CLR     RS0
 3731:    3ED3  C2 D4                           CLR     RS1
 3732:    3ED5  C0 00                           PUSH    00h
 3733:    3ED7  A8 81                           MOV     R0,SP
 3734:    3ED9  18                              DEC     R0                              ;Skip PSW
 3735:    3EDA  18                              DEC     R0                              ;Skip ACC
 3736:    3EDB  18                              DEC     R0                              ;Skip R0
 3737:    3EDC  E5 5B                           MOV     A,SSADRMSB
 3738:    3EDE  04                              INC     A
 3739:    3EDF  60 0A                           JZ      SINGLESTEP0
 3740:    3EE1  E6                              MOV     A,@R0                           ;MSB adress
 3741:    3EE2  B5 5B 74                        CJNE    A,SSADRMSB,SINGLESTEPEX2
 3742:    3EE5  18                              DEC     R0
 3743:    3EE6  E6                              MOV     A,@R0                           ;MSB adress
 3744:    3EE7  08                              INC     R0
 3745:    3EE8  B5 5A 6E                        CJNE    A,SSADRLSB,SINGLESTEPEX2
 3746:    3EEB  74 07           SINGLESTEP0:    MOV     A,#07h
 3747:    3EED  12 32 A7                        LCALL   TXBYTE
 3748:    3EF0  E6                              MOV     A,@R0                           ;MSB adress
 3749:    3EF1  12 32 A7                        LCALL   TXBYTE
 3750:    3EF4  18                              DEC     R0
 3751:    3EF5  E6                              MOV     A,@R0                           ;LSB adress
 3752:    3EF6  12 32 A7                        LCALL   TXBYTE
 3753:    3EF9  08                              INC     R0                              ;MSB adress
 3754:    3EFA  08                              INC     R0                              ;PSW
 3755:    3EFB  E6                              MOV     A,@R0                           ;PSW
 3756:    3EFC  12 32 A7                        LCALL   TXBYTE
 3757:    3EFF  08                              INC     R0                              ;ACC
 3758:    3F00  E6                              MOV     A,@R0                           ;ACC
 3759:    3F01  12 32 A7                        LCALL   TXBYTE
 3760:    3F04  E5 F0                           MOV     A,B                             ;B
 3761:    3F06  12 32 A7                        LCALL   TXBYTE
 3762:    3F09  E5 81                           MOV     A,SP                            ;SP
 3763:    3F0B  C3                              CLR     C
 3764:    3F0C  94 05                           SUBB    A,#05h
 3765:    3F0E  12 32 A7                        LCALL   TXBYTE
 3766:    3F11  E5 82                           MOV     A,DPL                           ;DPL
 3767:    3F13  12 32 A7                        LCALL   TXBYTE
 3768:    3F16  E5 83                           MOV     A,DPH                           ;DPH
 3769:    3F18  12 32 A7                        LCALL   TXBYTE
 3770:    3F1B  08                              INC     R0                              ;R0
 3771:    3F1C  E6                              MOV     A,@R0                           ;R0
 3772:    3F1D  12 32 A7                        LCALL   TXBYTE
 3773:    3F20  78 01                           MOV     R0,#01h
 3774:    3F22  E6              SINGLESTEP1:    MOV     A,@R0                           ;31 Bytes
 3775:    3F23  12 32 A7                        LCALL   TXBYTE
 3776:    3F26  08                              INC     R0
 3777:    3F27  B8 20 F8                        CJNE    R0,#20h,SINGLESTEP1
 3778:    3F2A  C0 82                           PUSH    DPL
 3779:    3F2C  C0 83                           PUSH    DPH
 3780:    3F2E  78 20                           MOV     R0,#20h                         ;32 Bytes
 3781:    3F30  E0              SINGLESTEP2:    MOVX    A,@DPTR
 3782:    3F31  12 32 A7                        LCALL   TXBYTE
 3783:    3F34  A3                              INC     DPTR
 3784:    3F35  D8 F9                           DJNZ    R0,SINGLESTEP2
 3785:    3F37  12 32 90        SINGLESTEP3:    LCALL   RXBYTE
 3786:    3F3A  B4 52 04                        CJNE    A,#'R',SINGLESTEP4              ;R Run
 3787:    3F3D  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 3788:    3F3F  80 0E                           SJMP    SINGLESTEPEX
 3789:    3F41  B4 73 08        SINGLESTEP4:    CJNE    A,#'s',SINGLESTEP5              ;s Stop
 3790:    3F44  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 3791:    3F46  E4                              CLR     A
 3792:    3F47  C0 E0                           PUSH    ACC                             ;Force a software reset
 3793:    3F49  C0 E0                           PUSH    ACC
 3794:    3F4B  32                              RETI                                    ;Return to reset vector
 3795:    3F4C  B4 69 11        SINGLESTEP5:    CJNE    A,#'i',SINGLESTEP6              ;i Step into
 3796:    3F4F  75 5A FF        SINGLESTEPEX:   MOV     SSADRLSB,#0FFh
 3797:    3F52  75 5B FF                        MOV     SSADRMSB,#0FFh
 3798:    3F55  D0 83           SINGLESTEPEX1:  POP     DPH
 3799:    3F57  D0 82                           POP     DPL
 3800:    3F59  D0 00           SINGLESTEPEX2:  POP     00h
 3801:    3F5B  D0 E0                           POP     ACC
 3802:    3F5D  D0 D0                           POP     PSW
 3803:    3F5F  32                              RETI
 3804:    3F60  B4 6F 0C        SINGLESTEP6:    CJNE    A,#'o',SINGLESTEP7              ;o Step over / Run to caret
 3805:    3F63  12 32 90                        LCALL   RXBYTE
 3806:    3F66  F5 5A                           MOV     SSADRLSB,A
 3807:    3F68  12 32 90                        LCALL   RXBYTE
 3808:    3F6B  F5 5B                           MOV     SSADRMSB,A
 3809:    3F6D  80 E6                           SJMP    SINGLESTEPEX1
 3810:    3F6F  B4 41 05        SINGLESTEP7:    CJNE    A,#'A',SINGLESTEP8              ;A Adress input
 3811:    3F72  12 32 6F                        LCALL   INPDPTR
 3812:    3F75  80 C0                           SJMP    SINGLESTEP3
 3813:    3F77  B4 49 05        SINGLESTEP8:    CJNE    A,#'I',SINGLESTEP9              ;Dump internal memory
 3814:    3F7A  12 33 AD                        LCALL   MEMDUMP
 3815:    3F7D  80 B8                           SJMP    SINGLESTEP3
 3816:    3F7F  B4 44 05        SINGLESTEP9:    CJNE    A,#'D',SINGLESTEP10             ;Dump external memory
 3817:    3F82  12 33 6C                        LCALL   DUMP
 3818:    3F85  80 B0                           SJMP    SINGLESTEP3
 3819:    3F87  B4 53 AD        SINGLESTEP10:   CJNE    A,#'S',SINGLESTEP3              ;Dump SFR's
 3820:    3F8A  D0 83                           POP     DPH
 3821:    3F8C  D0 82                           POP     DPL
 3822:    3F8E  D0 00                           POP     00h
 3823:    3F90  D0 E0                           POP     ACC
 3824:    3F92  D0 D0                           POP     PSW
 3825:    3F94  C0 D0                           PUSH    PSW
 3826:    3F96  C0 E0                           PUSH    ACC
 3827:    3F98  C2 D3                           CLR     RS0
 3828:    3F9A  C2 D4                           CLR     RS1
 3829:    3F9C  C0 00                           PUSH    00h
 3830:    3F9E  C0 82                           PUSH    DPL
 3831:    3FA0  C0 83                           PUSH    DPH
 3832:    3FA2  12 33 D0                        LCALL   DUMPSFR
 3833:    3FA5  80 90                           SJMP    SINGLESTEP3
 3834:
 3835:                                          END





                     register banks used:  ---

                     no errors



