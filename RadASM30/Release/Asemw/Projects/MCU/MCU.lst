

       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



        Source File:    MCU.a51
        Object File:    MCU.hex
        List File:      MCU.lst



 Line  I  Addr  Code            Source

    1:                          $NOPAGING
    2:          N      00FA     $PAGEWIDTH (250) ;250 columns per line
    3:                          $NOTABS          ;expand tabs
    4:                          $NOSYMBOLS
    5:
    6:                          $INCLUDE        (MCU.inc)
    7: 1                        ;*****************************************************
    8: 1                        ;Interrupt vectors.
    9: 1                        ;-----------------------------------------------------
   10: 1                        ;RESET          0000
   11: 1                        ;IE0            0003
   12: 1                        ;TF0            000B
   13: 1                        ;IE1            0013
   14: 1                        ;TF1            001B
   15: 1                        ;RI & TI        0023
   16: 1                        ;TF2 & EXF2     002B
   17: 1                        ;-----------------------------------------------------
   18: 1                        ;*****************************************************
   19: 1                        ;PORT 1
   20: 1                        ;-----------------------------------------------------
   21: 1                        ;P1.0           OUT:    +5V On
   22: 1                        ;P1.1           OUT:    RST
   23: 1                        ;P1.2           OUT:    SCK
   24: 1                        ;P1.3           OUT:    MISO
   25: 1                        ;P1.4           IN:     MOSI
   26: 1                        ;P1.5
   27: 1                        ;P1.6
   28: 1                        ;P1.7
   29: 1                        ;-----------------------------------------------------
   30: 1                        ;*****************************************************
   31: 1                        ;Internal RAM Locations
   32: 1                        ;-----------------------------------------------------
   33: 1                        ;20             Interrupt control bit flags
   34: 1                        ;               D0                      If set INT0 interrupt jumps to 2003h
   35: 1                        ;               D1                      If set TIMER0 interrupt jumps to 200Bh
   36: 1                        ;               D2                      If set INT1 interrupt jumps to 2013h
   37: 1                        ;               D3                      If set TIMER1 interrupt jumps to 201Bh
   38: 1                        ;               D4                      If set RI/TI interrupt jumps to 2023h
   39: 1                        ;               D5                      If set TIMER2 interrupt jumps to 202Bh
   40: 1                        ;               D6                      If set output is to terminal instead of LCD
   41: 1                        ;               D7                      If set single stepping is enabled
   42: 1
   43: 1                        ;24             ARG_STACK               ARGUMENT STACK POINTER
   44: 1                        ;25             FORMAT                  LOCATION OF OUTPUT FORMAT BYTE
   45: 1                        ;26.1           INTGRC                  BIT SET IF INTEGER ERROR
   46: 1                        ;26.3           ADD_IN                  DCMPXZ IN BASIC BACKAGE
   47: 1                        ;26.6           ZSURP                   ZERO SUPRESSION FOR HEX PRINT
   48: 1                        ;28-3D          FP WORK AREA
   49: 1                        ;40-4F          ROMBUFF / LCDLINE       16 Bytes
   50: 1                        ;50             FPCHR_OUT               Holds addrss to next byte during FP number convertion
   51: 1                        ;51             ROMVER                  Byte to be verified
   52: 1                        ;52             ROMPAGES                Number of pages
   53: 1                        ;53             ROMACTION               Menu pos
   54: 1                        ;54             ROMSIZE                 Menu pos
   55: 1                        ;55             ROMMODE                 Menu pos
   56: 1                        ;56             ROMVERERR               Number of verify errors
   57: 1                        ;57             DPLSAVE                 Holds DPL during PRNTCSTR
   58: 1                        ;58             DPHSAVE                 Holds DPH during PRNTCSTR
   59: 1                        ;59             MODE                    Selected mode (0-7)
   60: 1                        ;5A             SSADRLSB                Single step adress
   61: 1                        ;5B             SSADRMSB                Single step adress
   62: 1                        ;60             LCF1
   63: 1                        ;68             LCF2
   64: 1                        ;70             LCF3
   65: 1
   66: 1                        ;C0-FF          48 Byte stack
   67: 1
   68: 1                        ;External RAM Locations
   69: 1                        ;-----------------------------------------------------
   70: 1                        ;0048           EXTERNAL RAM FP NUMBER INPUT AREA
   71: 1                        ;0100           EXTERNAL RAM FP STACK
   72: 1                        ;8000           MEMORU MAPPED I/O
   73: 1                        ;8001           MEMORU MAPPED I/O
   74: 1
   75: 1                        ;-----------------------------------------------------
   76: 1                        ;*****************************************************
   77: 1                        ;SCREEN DRIVER
   78: 1                        ;-----------------------------------------------------
   79: 1                        ;01             START SEND ROMDATA.HEX FILE
   80: 1                        ;02             STOP SEND FILE
   81: 1                        ;03             START RECIEVE ROMDATA.HEX FILE
   82: 1                        ;04             STOP RECIEVE FILE
   83: 1                        ;05             START RECIEVE FILE IN 16 BYTE BLOCKS
   84: 1                        ;06             STOP RECIEVE FILE IN 16 BYTE BLOCKS
   85: 1                        ;07             BELL
   86: 1                        ;08             BACK SPACE
   87: 1                        ;09             TAB
   88: 1                        ;0A             LF
   89: 1                        ;0B             LOCATE
   90: 1                        ;0C             HOME
   91: 1                        ;0D             CR
   92: 1                        ;0E             CLS
   93: 1                        ;0F             MODE
   94: 1                        ;10             START SEND CMDFILE.CMD FILE
   95: 1                        ;-----------------------------------------------------
   96: 1                        ;*****************************************************
   97: 1                        ;Memory mapped I/O
   98: 1                        ;-----------------------------------------------------
   99: 1                        ;8000h Output
  100: 1                        ;-----------------------------------------------------
  101: 1                        ;D0             LCD DB4
  102: 1                        ;D1             LCD DB5
  103: 1                        ;D2             LCD DB6
  104: 1                        ;D3             LCD DB7
  105: 1                        ;D4             LCD RS
  106: 1                        ;D5             LCD E
  107: 1                        ;D6             LC Meter        0=C, 1=L
  108: 1                        ;D7             LC Meter        0=F1, 1=F2 (Adding C Cal)
  109: 1                        ;-----------------------------------------------------
  110: 1                        ;8001h Output
  111: 1                        ;-----------------------------------------------------
  112: 1                        ;D0             FRQ SEL A
  113: 1                        ;D1             FRQ SEL B       00=EXT FRQ,01=FGEN,10=LCMETER,11=ALE
  114: 1                        ;D2             FRQ GATE        ACTIVE LOW
  115: 1                        ;D3             FRQ RESET       ACTIVE HIGH
  116: 1                        ;D4             ADC CS          ACTIVE LOW
  117: 1                        ;D5             ADC CLK         HIGH TO LOW TRANSITION
  118: 1                        ;D6             ADC DIN         START,S/D,D2,D1,D0
  119: 1                        ;D7             FRQ TTL         ACTIVE HIGH
  120: 1                        ;-----------------------------------------------------
  121: 1                        ;8000h Input
  122: 1                        ;-----------------------------------------------------
  123: 1                        ;D0             FRQ LSB
  124: 1                        ;D1
  125: 1                        ;D2
  126: 1                        ;D3
  127: 1                        ;D4
  128: 1                        ;D5
  129: 1                        ;D6
  130: 1                        ;D7             FRQ MSB
  131: 1                        ;-----------------------------------------------------
  132: 1                        ;8001h Input
  133: 1                        ;-----------------------------------------------------
  134: 1                        ;D0             ADC DOUT
  135: 1                        ;D1
  136: 1                        ;D2
  137: 1                        ;D3
  138: 1                        ;D4
  139: 1                        ;D5
  140: 1                        ;D6
  141: 1                        ;D7
  142: 1
  143: 1                        ;-----------------------------------------------------
  144: 1                        ;*****************************************************
  145: 1                        ;Equates
  146: 1                        ;-----------------------------------------------------
  147: 1        N      00C8     T2CON           EQU 0C8h
  148: 1        N      00CA     RCAP2L          EQU 0CAh
  149: 1        N      00CB     RCAP2H          EQU 0CBh
  150: 1        N      00CC     TL2             EQU 0CCh
  151: 1        N      00CD     TH2             EQU 0CDh
  152: 1        N        BD     PT2             BIT 0BDh
  153: 1        N      000A     MODEMAX         EQU 10
  154: 1                        ;-----------------------------------------------------
  155: 1        N      0020     INTBITS         EQU 20h                 ;Interrupt jump control
  156: 1        N      0040     ROMBUFF         EQU 40h                 ;16 Bytes
  157: 1        N      0040     LCDLINE         EQU 40h                 ;16 Bytes
  158: 1        N      0050     FPCHR_OUT       EQU 50h                 ;Holds addrss to next byte during FP number convertion
  159: 1        N      0051     ROMVER          EQU 51h                 ;Byte to be verified
  160: 1        N      0052     ROMPAGES        EQU 52h                 ;Number of pages
  161: 1        N      0053     ROMACTION       EQU 53h                 ;Menu pos
  162: 1        N      0054     ROMSIZE         EQU 54h                 ;Menu pos
  163: 1        N      0055     ROMMODE         EQU 55h                 ;Menu pos
  164: 1        N      0056     ROMVERERR       EQU 56h                 ;Number of verify errors
  165: 1        N      0057     DPLSAVE         EQU 57h                 ;Holds DPL during PRNTCSTR
  166: 1        N      0058     DPHSAVE         EQU 58h                 ;Holds DPH during PRNTCSTR
  167: 1        N      0059     MODE            EQU 59h                 ;Selected mode (0-7)
  168: 1        N      005A     SSADRLSB        EQU 5Ah                 ;Single step adress LSB
  169: 1        N      005B     SSADRMSB        EQU 5Bh                 ;Single step adress MSB
  170: 1                        ;*****************************************************
  171: 1                        ; The following values MUST be provided by the user
  172: 1                        ;*****************************************************
  173: 1        N      0001     ARG_STACK_PAGE  EQU 01H                 ;External memory page for arg stack
  174: 1        N      0024     ARG_STACK       EQU 24H                 ;ARGUMENT STACK POINTER
  175: 1        N      0025     FORMAT          EQU 25H                 ;LOCATION OF OUTPUT FORMAT BYTE
  176: 1        B        31     INTGRC          BIT 26H.1               ;BIT SET IF INTEGER ERROR
  177: 1        B        33     ADD_IN          BIT 26H.3               ;DCMPXZ IN BASIC BACKAGE
  178: 1        B        36     ZSURP           BIT 26H.6               ;ZERO SUPRESSION FOR HEX PRINT
  179: 1                        ;*****************************************************
  180: 1                        ;XRAM
  181: 1                        ;*****************************************************
  182: 1        N      0048     CONVT           EQU 0048H               ;String addr TO CONVERT NUMBERS
  183: 1        N      0060     LCF1            EQU 0060H               ;LC Meter F1
  184: 1        N      0068     LCF2            EQU 0068h               ;LC Meter F2
  185: 1        N      0070     LCF3            EQU 0070h               ;LC Meter F3
  186: 1        N      0078     LCCA            EQU 0078h               ;((F1/F2)^2)-1
  187: 1        N      0080     LCCB            EQU 0080h               ;((1/2*Pi*F1)^2)*LCCA
  188: 1        N      0088     LCCT            EQU 0088h               ;Temp
  189: 1                        ;-----------------------------------------------------
  190:
  191:          N      0001     DEVMODE         EQU 1
  192:          N      0000     DEBUG           EQU 0
  193:
  194:          N      0000     IF DEVMODE=0
  195:                          ;RESET:***********************************************
  196:                                          ORG     0000h
  197:                                          LJMP    START0
  198:                          ;IE0IRQ:**********************************************
  199:                                          ORG     0003h
  200:                                          AJMP    IE0IRQ
  201:                          ;TF0IRQ:**********************************************
  202:                                          ORG     000Bh
  203:                                          JB      INTBITS.1,$+4
  204:                                          RETI
  205:                                          LJMP    200Bh
  206:                          ;IE1IRQ:**********************************************
  207:                                          ORG     0013h
  208:                                          AJMP    IE1IRQ
  209:                          ;TF1IRQ:**********************************************
  210:                                          ORG     001Bh
  211:                                          JB      INTBITS.3,$+4
  212:                                          RETI
  213:                                          LJMP    201Bh
  214:                          ;RITIIRQ:*********************************************
  215:                                          ORG     0023h
  216:                                          JB      INTBITS.4,$+4
  217:                                          RETI
  218:                                          LJMP    2023h
  219:                          ;TF2EXF2IRQ:******************************************
  220:                                          ORG     002Bh
  221:                                          JB      INTBITS.5,$+4
  222:                                          RETI
  223:                                          LJMP    202Bh
  224:                          ;*****************************************************
  225:                          IE0IRQ:         JB      INTBITS.0,IE0IRQ1
  226:                                          ACALL   DEBOUNCEINT0
  227:                                          DEC     MODE
  228:                                          LCALL   LCDCLEAR
  229:                                          LJMP    START
  230:                          IE0IRQ1:        LJMP    2003h
  231:
  232:                          DEBOUNCEINT0:   MOV     R6,#00h
  233:                                          MOV     R7,#00h
  234:                          DEBOUNCEINT01:  JNB     P3.2,DEBOUNCEINT0
  235:                                          DJNZ    R6,DEBOUNCEINT01
  236:                                          DJNZ    R7,DEBOUNCEINT01
  237:                                          CLR     IE0
  238:                                          RETI
  239:
  240:                          IE1IRQ:         JB      INTBITS.2,IE1IRQ1
  241:                                          JB      INTBITS.7,IE1IRQ2
  242:                                          ACALL   DEBOUNCEINT1
  243:                                          INC     MODE
  244:                                          LCALL   LCDCLEAR
  245:                                          LJMP    START
  246:                          IE1IRQ1:        LJMP    2013h
  247:                          IE1IRQ2:        LJMP    SINGLESTEP
  248:
  249:                          DEBOUNCEINT1:   MOV     R6,#00h
  250:                                          MOV     R7,#00h
  251:                          DEBOUNCEINT11:  JNB     P3.3,DEBOUNCEINT1
  252:                                          DJNZ    R6,DEBOUNCEINT11
  253:                                          DJNZ    R7,DEBOUNCEINT11
  254:                                          CLR     IE1
  255:                                          RETI
  256:
  257:                                          ORG     0080h
  258:
  259:                          ELSE
  260:                          ;RESET:***********************************************
  261:          N      2000                     ORG     2000h
  262:    2000  02 30 00                        LJMP    START0
  263:                          ;IE0IRQ:**********************************************
  264:          N      2003                     ORG     2003h
  265:    2003  01 2C                           AJMP    IE0IRQ
  266:                          ;TF0IRQ:**********************************************
  267:          N      200B                     ORG     200Bh
  268:    200B  32                              RETI
  269:                          ;IE1IRQ:**********************************************
  270:          N      2013                     ORG     2013h
  271:    2013  01 41                           AJMP    IE1IRQ
  272:                          ;TF1IRQ:**********************************************
  273:          N      201B                     ORG     201Bh
  274:    201B  32                              RETI
  275:                          ;RITIIRQ:*********************************************
  276:          N      2023                     ORG     2023h
  277:    2023  32                              RETI
  278:                          ;TF2EXF2IRQ:******************************************
  279:          N      202B                     ORG     202Bh
  280:    202B  32                              RETI
  281:                          ;*****************************************************
  282:    202C  11 33           IE0IRQ:         ACALL   DEBOUNCEINT0
  283:    202E  15 59                           DEC     MODE
  284:    2030  02 30 3B                        LJMP    START
  285:
  286:    2033  7E 00           DEBOUNCEINT0:   MOV     R6,#00h
  287:    2035  7F 00                           MOV     R7,#00h
  288:    2037  30 B2 F9        DEBOUNCEINT01:  JNB     P3.2,DEBOUNCEINT0
  289:    203A  DE FB                           DJNZ    R6,DEBOUNCEINT01
  290:    203C  DF F9                           DJNZ    R7,DEBOUNCEINT01
  291:    203E  C2 89                           CLR     IE0
  292:    2040  32                              RETI
  293:
  294:    2041  20 07 07        IE1IRQ:         JB      INTBITS.7,IE1IRQ2
  295:    2044  11 4E                           ACALL   DEBOUNCEINT1
  296:    2046  05 59                           INC     MODE
  297:    2048  02 30 3B                        LJMP    START
  298:    204B  02 3D 92        IE1IRQ2:        LJMP    SINGLESTEP
  299:
  300:    204E  7E 00           DEBOUNCEINT1:   MOV     R6,#00h
  301:    2050  7F 00                           MOV     R7,#00h
  302:    2052  30 B3 F9        DEBOUNCEINT11:  JNB     P3.3,DEBOUNCEINT1
  303:    2055  DE FB                           DJNZ    R6,DEBOUNCEINT11
  304:    2057  DF F9                           DJNZ    R7,DEBOUNCEINT11
  305:    2059  C2 8B                           CLR     IE1
  306:    205B  32                              RETI
  307:
  308:          N      2080                     ORG     2080h
  309:
  310:                          ENDIF
  311:
  312:                          $INCLUDE        (FP52.a51)
  313: 1                        ; This is a complete BCD floating point package for the 8051 micro-
  314: 1                        ; controller. It provides 8 digits of accuracy with exponents that
  315: 1                        ; range from +127 to -127. The mantissa is in packed BCD, while the
  316: 1                        ; exponent is expressed in pseudo-twos complement. A ZERO exponent
  317: 1                        ; is used to express the number ZERO. An exponent value of 80H or
  318: 1                        ; greater than means the exponent is positive, i.e. 80H = E 0,
  319: 1                        ; 81H = E+1, 82H = E+2 and so on. If the exponent is 7FH or less,
  320: 1                        ; the exponent is negative, 7FH = E-1, 7EH = E-2, and so on.
  321: 1                        ; ALL NUMBERS ARE ASSUMED TO BE NORMALIZED and all results are
  322: 1                        ; normalized after calculation. A normalized mantissa is >=.10 and
  323: 1                        ; <=.99999999.
  324: 1                        ;
  325: 1                        ; The numbers in memory assumed to be stored as follows:
  326: 1                        ;
  327: 1                        ; EXPONENT OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE
  328: 1                        ; SIGN OF ARGUMENT 2       =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-1
  329: 1                        ; DIGIT 78 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-2
  330: 1                        ; DIGIT 56 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-3
  331: 1                        ; DIGIT 34 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-4
  332: 1                        ; DIGIT 12 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-5
  333: 1                        ;
  334: 1                        ; EXPONENT OF ARGUMENT 1   =   VALUE OF ARG_STACK
  335: 1                        ; SIGN OF ARGUMENT 1       =   VALUE OF ARG_STACK-1
  336: 1                        ; DIGIT 78 OF ARGUMENT 1   =   VALUE OF ARG_STACK-2
  337: 1                        ; DIGIT 56 OF ARGUMENT 1   =   VALUE OF ARG_STACK-3
  338: 1                        ; DIGIT 34 OF ARGUMENT 1   =   VALUE OF ARG_STACK-4
  339: 1                        ; DIGIT 12 OF ARGUMENT 1   =   VALUE OF ARG_STACK-5
  340: 1                        ;
  341: 1                        ; The operations are performed thusly:
  342: 1                        ;
  343: 1                        ; ARG_STACK+FP_NUMBER_SIZE = ARG_STACK+FP_NUMBER_SIZE # ARG_STACK
  344: 1                        ;
  345: 1                        ; Which is ARGUMENT 2 = ARGUMENT 2 # ARGUMENT 1
  346: 1                        ;
  347: 1                        ; Where # can be ADD, SUBTRACT, MULTIPLY OR DIVIDE.
  348: 1                        ;
  349: 1                        ; Note that the stack gets popped after an operation.
  350: 1                        ;
  351: 1                        ; The FP_COMP instruction POPS the ARG_STACK TWICE and returns status.
  352: 1                        ;
  353: 1                        ;**********************************************************************
  354: 1                        ;
  355: 1                        ;**********************************************************************
  356: 1                        ;
  357: 1                        ; STATUS ON RETURN - After performing an operation (+, -, *, /)
  358: 1                        ;                    the accumulator contains the following status
  359: 1                        ;
  360: 1                        ; ACCUMULATOR - BIT 0 - FLOATING POINT UNDERFLOW OCCURED
  361: 1                        ;
  362: 1                        ;             - BIT 1 - FLOATING POINT OVERFLOW OCCURED
  363: 1                        ;
  364: 1                        ;             - BIT 2 - RESULT WAS ZER0
  365: 1                        ;
  366: 1                        ;             - BIT 3 - DIVIDE BY ZERO ATTEMPTED
  367: 1                        ;
  368: 1                        ;             - BIT 4 - NOT USED, 0 RETURNED
  369: 1                        ;
  370: 1                        ;             - BIT 5 - NOT USED, 0 RETURNED
  371: 1                        ;
  372: 1                        ;             - BIT 6 - NOT USED, 0 RETURNED
  373: 1                        ;
  374: 1                        ;             - BIT 7 - NOT USED, 0 RETURNED
  375: 1                        ;
  376: 1                        ; NOTE: When underflow occures, a ZERO result is returned.
  377: 1                        ;       When overflow or divide by zero occures, a result of
  378: 1                        ;       .99999999 E+127 is returned and it is up to the user
  379: 1                        ;       to handle these conditions as needed in the program.
  380: 1                        ;
  381: 1                        ; NOTE: The Compare instruction returns F0 = 0 if ARG 1 = ARG 2
  382: 1                        ;       and returns a CARRY FLAG = 1 if ARG 1 is > ARG 2
  383: 1                        ;
  384: 1                        ;***********************************************************************
  385: 1                        ;
  386: 1                        ; The following equates are used internally
  387: 1                        ;
  388: 1                        ;***********************************************************************
  389: 1                        ;
  390: 1        N      0006     FP_NUMBER_SIZE  EQU     6
  391: 1        N      0004     DIGIT           EQU     4
  392: 1        N      0000     R0B0            EQU     0
  393: 1        N      0001     R1B0            EQU     1
  394: 1        N      0000     UNDERFLOW       EQU     0
  395: 1        N      0001     OVERFLOW        EQU     1
  396: 1        N      0002     ZERO            EQU     2
  397: 1        N      0003     ZERO_DIVIDE     EQU     3
  398: 1                        ;
  399: 1                        ;***********************************************************************
  400: 1                                ;**************************************************************
  401: 1                                ;
  402: 1                                ; The following internal locations are used by the math pack
  403: 1                                ; ordering is important and the FP_DIGITS must be bit
  404: 1                                ; addressable
  405: 1                                ;
  406: 1                                ;***************************************************************
  407: 1                                ;
  408: 1        N      0028     FP_STATUS       EQU     28H                             ;NOT used data pointer me
  409: 1        N      0029     FP_TEMP         EQU     FP_STATUS+1                     ;NOT USED
  410: 1        N      002A     FP_CARRY        EQU     FP_STATUS+2                     ;USED FOR BITS
  411: 1        N      002B     FP_DIG12        EQU     FP_CARRY+1
  412: 1        N      002C     FP_DIG34        EQU     FP_CARRY+2
  413: 1        N      002D     FP_DIG56        EQU     FP_CARRY+3
  414: 1        N      002E     FP_DIG78        EQU     FP_CARRY+4
  415: 1        N      002F     FP_SIGN         EQU     FP_CARRY+5
  416: 1        N      0030     FP_EXP          EQU     FP_CARRY+6
  417: 1        B        78     MSIGN           BIT     FP_SIGN.0
  418: 1        B        50     XSIGN           BIT     FP_CARRY.0
  419: 1        B        51     FOUND_RADIX     BIT     FP_CARRY.1
  420: 1        B        52     FIRST_RADIX     BIT     FP_CARRY.2
  421: 1        B        53     DONE_LOAD       BIT     FP_CARRY.3
  422: 1        N      002B     FP_NIB1         EQU     FP_DIG12
  423: 1        N      002C     FP_NIB2         EQU     FP_NIB1+1
  424: 1        N      002D     FP_NIB3         EQU     FP_NIB1+2
  425: 1        N      002E     FP_NIB4         EQU     FP_NIB1+3
  426: 1        N      002F     FP_NIB5         EQU     FP_NIB1+4
  427: 1        N      0030     FP_NIB6         EQU     FP_NIB1+5
  428: 1        N      0031     FP_NIB7         EQU     FP_NIB1+6
  429: 1        N      0032     FP_NIB8         EQU     FP_NIB1+7
  430: 1        N      0033     FP_ACCX         EQU     FP_NIB1+8
  431: 1        N      0034     FP_ACCC         EQU     FP_NIB1+9
  432: 1        N      0035     FP_ACC1         EQU     FP_NIB1+10
  433: 1        N      0036     FP_ACC2         EQU     FP_NIB1+11
  434: 1        N      0037     FP_ACC3         EQU     FP_NIB1+12
  435: 1        N      0038     FP_ACC4         EQU     FP_NIB1+13
  436: 1        N      0039     FP_ACC5         EQU     FP_NIB1+14
  437: 1        N      003A     FP_ACC6         EQU     FP_NIB1+15
  438: 1        N      003B     FP_ACC7         EQU     FP_NIB1+16
  439: 1        N      003C     FP_ACC8         EQU     FP_NIB1+17
  440: 1        N      003D     FP_ACCS         EQU     FP_NIB1+18
  441: 1                                ;
  442: 1
  443: 1        C      2080     FP_BASE         EQU     $
  444: 1
  445: 1                                ;**************************************************************
  446: 1                                ;
  447: 1                                ; The floating point entry points and jump table
  448: 1                                ;
  449: 1                                ;**************************************************************
  450: 1                                ;
  451: 1  2080  01 B2                           AJMP    FLOATING_ADD
  452: 1  2082  01 A8                           AJMP    FLOATING_SUB
  453: 1  2084  21 65                           AJMP    FLOATING_COMP
  454: 1  2086  21 96                           AJMP    FLOATING_MUL
  455: 1  2088  21 CB                           AJMP    FLOATING_DIV
  456: 1  208A  61 92                           AJMP    HEXSCAN
  457: 1  208C  61 CB                           AJMP    FLOATING_POINT_INPUT
  458: 1  208E  81 83                           AJMP    FLOATING_POINT_OUTPUT
  459: 1  2090  C1 00                           AJMP    CONVERT_BINARY_TO_ASCII_STRING
  460: 1  2092  A1 A7                           AJMP    CONVERT_ASCII_STRING_TO_BINARY
  461: 1  2094  A1 DC                           AJMP    MULNUM10
  462: 1  2096  C1 48                           AJMP    FPHEXOUT
  463: 1                        ;
  464: 1                        ; the remaining jump to routines were extracted from basic52
  465: 1                        ; by me to make the floating point software stand alone
  466: 1                        ;
  467: 1  2098  61 BF                           AJMP    PUSHR2R0                        ; INTEGER to FLOAT
  468: 1  209A  C1 92                           AJMP    IFIX                            ; FLOAT to INTEGER
  469: 1  209C  C1 D3                           AJMP    PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
  470: 1  209E  C1 CF                           AJMP    POPAS                           ; POP ARGUMENT TO R3:R1
  471: 1  20A0  C1 F0                           AJMP    MOVAS                           ; COPY ARGUMENT
  472: 1  20A2  E1 13                           AJMP    AINT                            ; INT FUNCTION
  473: 1  20A4  E1 3B                           AJMP    PUSHC                           ; PUSH ARG IN DPTR TO STACK
  474: 1
  475: 1  20A6  22              PRTERR:         RET
  476: 1  20A7  22              BADPRM:         RET
  477: 1
  478: 1                                ;
  479: 1                                ;
  480: 1  20A8                  FLOATING_SUB:
  481: 1                                ;
  482: 1  20A8  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
  483: 1  20AB  A8 24                           MOV     R0,ARG_STACK
  484: 1  20AD  18                              DEC     R0                              ;POINT TO SIGN
  485: 1  20AE  E2                              MOVX    A,@R0                           ;READ SIGN
  486: 1  20AF  B2 E0                           CPL     ACC.0
  487: 1  20B1  F2                              MOVX    @R0,A
  488: 1                                ;
  489: 1                                ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  490: 1                                ;
  491: 1  20B2                  FLOATING_ADD:
  492: 1                                ;
  493: 1                                ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  494: 1                                ;
  495: 1                                ;
  496: 1  20B2  71 73                           ACALL   MDES1                           ;R7=TOS EXP, R6=TOS-1 EXP, R4=TOS SIGN
  497: 1                                                                                                                        ;R3=TOS-1 SIGN, OPERATION IS R1 # R0
  498: 1                                ;
  499: 1  20B4  EF                              MOV     A,R7                            ;GET TOS EXPONENT
  500: 1  20B5  60 0D                           JZ      POP_AND_EXIT                    ;IF TOS=0 THEN POP AND EXIT
  501: 1  20B7  BE 00 12                        CJNE    R6,#0,LOAD1                     ;CLEAR CARRY EXIT IF ZERO
  502: 1                                ;
  503: 1                                ;**************************************************************
  504: 1                                ;
  505: 1  20BA                  SWAP_AND_EXIT:                                          ; Swap external args and return
  506: 1                                ;
  507: 1                                ;**************************************************************
  508: 1                                ;
  509: 1  20BA  71 67                           ACALL   LOAD_POINTERS
  510: 1  20BC  7F 06                           MOV     R7,#FP_NUMBER_SIZE
  511: 1                                ;
  512: 1  20BE  E2              SE1:            MOVX    A,@R0                           ;SWAP THE ARGUMENTS
  513: 1  20BF  F3                              MOVX    @R1,A
  514: 1  20C0  18                              DEC     R0
  515: 1  20C1  19                              DEC     R1
  516: 1  20C2  DF FA                           DJNZ    R7,SE1
  517: 1                                ;
  518: 1  20C4                  POP_AND_EXIT:
  519: 1                                ;
  520: 1  20C4  E5 24                           MOV     A,ARG_STACK                     ;POP THE STACK
  521: 1  20C6  24 06                           ADD     A,#FP_NUMBER_SIZE
  522: 1  20C8  F5 24                           MOV     ARG_STACK,A
  523: 1  20CA  E4                              CLR     A
  524: 1  20CB  22                              RET
  525: 1                                ;
  526: 1                                ;
  527: 1  20CC  9E              LOAD1:          SUBB    A,R6                            ;A = ARG 1 EXP - ARG 2 EXP
  528: 1  20CD  8F 30                           MOV     FP_EXP,R7                       ;SAVE EXPONENT AND SIGN
  529: 1  20CF  8C 2F                           MOV     FP_SIGN,R4
  530: 1  20D1  50 09                           JNC     LOAD2                           ;ARG1 EXPONENT IS LARGER OR SAME
  531: 1  20D3  8E 30                           MOV     FP_EXP,R6
  532: 1  20D5  8B 2F                           MOV     FP_SIGN,R3
  533: 1  20D7  F4                              CPL     A
  534: 1  20D8  04                              INC     A                               ;COMPENSATE FOR EXP DELTA
  535: 1  20D9  C8                              XCH     A,R0                            ;FORCE R0 TO POINT AT THE LARGEST
  536: 1  20DA  C9                              XCH     A,R1                            ;EXPONENT
  537: 1  20DB  C8                              XCH     A,R0
  538: 1                                ;
  539: 1  20DC  FF              LOAD2:          MOV     R7,A                            ;SAVE THE EXPONENT DELTA IN R7
  540: 1  20DD  C2 33                           CLR     ADD_IN
  541: 1  20DF  BD 00 02                        CJNE    R5,#0,$+5
  542: 1  20E2  D2 33                           SETB    ADD_IN
  543: 1                                ;
  544: 1                                ; Load the R1 mantissa
  545: 1                                ;
  546: 1  20E4  71 84                           ACALL   LOADR1_MANTISSA                 ;LOAD THE SMALLEST NUMBER
  547: 1                                ;
  548: 1                                ; Now align the number to the delta exponent
  549: 1                                ; R4 points to the string of the last digits lost
  550: 1                                ;
  551: 1  20E6  BF 0B 00                        CJNE    R7,#DIGIT+DIGIT+3,$+3
  552: 1  20E9  40 02                           JC      $+4
  553: 1  20EB  7F 0A                           MOV     R7,#DIGIT+DIGIT+2
  554: 1                                ;
  555: 1  20ED  75 2A 00                        MOV     FP_CARRY,#00                    ;CLEAR THE CARRY
  556: 1  20F0  51 C4                           ACALL   RIGHT                           ;SHIFT THE NUMBER
  557: 1                                ;
  558: 1                                ; Set up for addition and subtraction
  559: 1                                ;
  560: 1  20F2  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  561: 1  20F4  79 2E                           MOV     R1,#FP_DIG78
  562: 1  20F6  74 9E                           MOV     A,#9EH
  563: 1  20F8  C3                              CLR     C
  564: 1  20F9  9C                              SUBB    A,R4
  565: 1  20FA  D4                              DA      A
  566: 1  20FB  CC                              XCH     A,R4
  567: 1  20FC  70 01                           JNZ     $+3
  568: 1  20FE  FC                              MOV     R4,A
  569: 1  20FF  B4 50 00                        CJNE    A,#50H,$+3                      ;TEST FOR SUBTRACTION
  570: 1  2102  30 33 18                        JNB     ADD_IN,SUBLP                    ;DO SUBTRACTION IF NO ADD_IN
  571: 1  2105  B3                              CPL     C                               ;FLIP CARRY FOR ADDITION
  572: 1  2106  31 14                           ACALL   ADDLP                           ;DO ADDITION
  573: 1                                ;
  574: 1  2108  50 08                           JNC     ADD_R
  575: 1  210A  05 2A                           INC     FP_CARRY
  576: 1  210C  7F 01                           MOV     R7,#1
  577: 1  210E  51 C4                           ACALL   RIGHT
  578: 1  2110  51 7B                           ACALL   INC_FP_EXP                      ;SHIFT AND BUMP EXPONENT
  579: 1                                ;
  580: 1  2112  41 6C           ADD_R:          AJMP    STORE_ALIGN_TEST_AND_EXIT
  581: 1                                ;
  582: 1  2114  E2              ADDLP:          MOVX    A,@R0
  583: 1  2115  37                              ADDC    A,@R1
  584: 1  2116  D4                              DA      A
  585: 1  2117  F7                              MOV     @R1,A
  586: 1  2118  18                              DEC     R0
  587: 1  2119  19                              DEC     R1
  588: 1  211A  DF F8                           DJNZ    R7,ADDLP                        ;LOOP UNTIL DONE
  589: 1  211C  22                              RET
  590: 1                                ;
  591: 1                                ;
  592: 1  211D  E2              SUBLP:          MOVX    A,@R0                           ;NOW DO SUBTRACTION
  593: 1  211E  FE                              MOV     R6,A
  594: 1  211F  E4                              CLR     A
  595: 1  2120  34 99                           ADDC    A,#99H
  596: 1  2122  97                              SUBB    A,@R1
  597: 1  2123  2E                              ADD     A,R6
  598: 1  2124  D4                              DA      A
  599: 1  2125  F7                              MOV     @R1,A
  600: 1  2126  18                              DEC     R0
  601: 1  2127  19                              DEC     R1
  602: 1  2128  DF F3                           DJNZ    R7,SUBLP
  603: 1  212A  40 11                           JC      FSUB6
  604: 1                                ;
  605: 1                                ;
  606: 1                                ; Need to complement the result and sign because the floating
  607: 1                                ; point accumulator mantissa was larger than the external
  608: 1                                ; memory and their signs were equal.
  609: 1                                ;
  610: 1  212C  B2 78                           CPL     FP_SIGN.0
  611: 1  212E  79 2E                           MOV     R1,#FP_DIG78
  612: 1  2130  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  613: 1                                ;
  614: 1  2132  74 9A           FSUB5:          MOV     A,#9AH
  615: 1  2134  97                              SUBB    A,@R1
  616: 1  2135  24 00                           ADD     A,#0
  617: 1  2137  D4                              DA      A
  618: 1  2138  F7                              MOV     @R1,A
  619: 1  2139  19                              DEC     R1
  620: 1  213A  B3                              CPL     C
  621: 1  213B  DF F5                           DJNZ    R7,FSUB5                        ;LOOP
  622: 1                                ;
  623: 1                                ; Now see how many zeros their are
  624: 1                                ;
  625: 1  213D  78 2B           FSUB6:          MOV     R0,#FP_DIG12
  626: 1  213F  7F 00                           MOV     R7,#0
  627: 1                                ;
  628: 1  2141  E6              FSUB7:          MOV     A,@R0
  629: 1  2142  70 08                           JNZ     FSUB8
  630: 1  2144  0F                              INC     R7
  631: 1  2145  0F                              INC     R7
  632: 1  2146  08                              INC     R0
  633: 1  2147  B8 2F F7                        CJNE    R0,#FP_SIGN,FSUB7
  634: 1  214A  41 B4                           AJMP    ZERO_AND_EXIT
  635: 1                                ;
  636: 1  214C  B4 10 00        FSUB8:          CJNE    A,#10H,$+3
  637: 1  214F  50 01                           JNC     FSUB9
  638: 1  2151  0F                              INC     R7
  639: 1                                ;
  640: 1                                ; Now R7 has the number of leading zeros in the FP ACC
  641: 1                                ;
  642: 1  2152  E5 30           FSUB9:          MOV     A,FP_EXP                        ;GET THE OLD EXPONENT
  643: 1  2154  C3                              CLR     C
  644: 1  2155  9F                              SUBB    A,R7                            ;SUBTRACT FROM THE NUMBER OF ZEROS
  645: 1  2156  60 0B                           JZ      FSUB10
  646: 1  2158  40 09                           JC      FSUB10
  647: 1                                ;
  648: 1  215A  F5 30                           MOV     FP_EXP,A                        ;SAVE THE NEW EXPONENT
  649: 1                                ;
  650: 1  215C  51 FE                           ACALL   LEFT1                           ;SHIFT THE FP ACC
  651: 1  215E  75 2A 00                        MOV     FP_CARRY,#0
  652: 1  2161  41 6C                           AJMP    STORE_ALIGN_TEST_AND_EXIT
  653: 1                                ;
  654: 1  2163  41 AE           FSUB10:         AJMP    UNDERFLOW_AND_EXIT
  655: 1                                ;
  656: 1                                ;***************************************************************
  657: 1                                ;
  658: 1  2165                  FLOATING_COMP:  ; Compare two floating point numbers
  659: 1                                        ; used for relational operations and is faster
  660: 1                                        ; than subtraction. ON RETURN, The carry is set
  661: 1                                        ; if ARG1 is > ARG2, else carry is not set
  662: 1                                        ; if ARG1 = ARG2, F0 gets set
  663: 1                                ;
  664: 1                                ;***************************************************************
  665: 1                                ;
  666: 1  2165  71 73                           ACALL   MDES1                           ;SET UP THE REGISTERS
  667: 1  2167  E5 24                           MOV     A,ARG_STACK
  668: 1  2169  24 0C                           ADD     A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
  669: 1  216B  F5 24                           MOV     ARG_STACK,A                     ;POP THE STACK TWICE, CLEAR THE CARRY
  670: 1  216D  EE                              MOV     A,R6                            ;CHECK OUT EXPONENTS
  671: 1  216E  C2 D5                           CLR     F0
  672: 1  2170  C3                              CLR     C
  673: 1  2171  9F                              SUBB    A,R7
  674: 1  2172  60 0A                           JZ      EXPONENTS_EQUAL
  675: 1  2174  40 03                           JC      ARG1_EXP_IS_LARGER
  676: 1                                ;
  677: 1                                ; Now the ARG2 EXPONENT is > ARG1 EXPONENT
  678: 1                                ;
  679: 1  2176                  SIGNS_DIFFERENT:
  680: 1                                ;
  681: 1  2176  EB                              MOV     A,R3                            ;SEE IF SIGN OF ARG2 IS POSITIVE
  682: 1  2177  80 01                           SJMP    $+3
  683: 1                                ;
  684: 1  2179                  ARG1_EXP_IS_LARGER:
  685: 1                                ;
  686: 1  2179  EC                              MOV     A,R4                            ;GET THE SIGN OF ARG1 EXPONENT
  687: 1  217A  60 01                           JZ      $+3
  688: 1  217C  B3                              CPL     C
  689: 1  217D  22                              RET
  690: 1                                ;
  691: 1  217E                  EXPONENTS_EQUAL:
  692: 1                                ;
  693: 1                                ; First, test the sign, then the mantissa
  694: 1                                ;
  695: 1  217E  BD 00 F5                        CJNE    R5,#0,SIGNS_DIFFERENT
  696: 1                                ;
  697: 1  2181                  BOTH_PLUS:
  698: 1                                ;
  699: 1  2181  7F 04                           MOV     R7,#DIGIT                       ;POINT AT MS DIGIT
  700: 1  2183  18                              DEC     R0
  701: 1  2184  18                              DEC     R0
  702: 1  2185  18                              DEC     R0
  703: 1  2186  19                              DEC     R1
  704: 1  2187  19                              DEC     R1
  705: 1  2188  19                              DEC     R1
  706: 1                                ;
  707: 1                                ; Now do the compare
  708: 1                                ;
  709: 1  2189  E2              CLOOP:          MOVX    A,@R0
  710: 1  218A  FE                              MOV     R6,A
  711: 1  218B  E3                              MOVX    A,@R1
  712: 1  218C  9E                              SUBB    A,R6
  713: 1  218D  70 EA                           JNZ     ARG1_EXP_IS_LARGER
  714: 1  218F  08                              INC     R0
  715: 1  2190  09                              INC     R1
  716: 1  2191  DF F6                           DJNZ    R7,CLOOP
  717: 1                                ;
  718: 1                                ; If here, the numbers are the same, the carry is cleared
  719: 1                                ;
  720: 1  2193  D2 D5                           SETB    F0
  721: 1  2195  22                              RET                                     ;EXIT WITH EQUAL
  722: 1                                ;
  723: 1                        ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  724: 1                        ;
  725: 1  2196                  FLOATING_MUL:                                           ; Floating point multiply
  726: 1                        ;
  727: 1                        ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  728: 1                        ;
  729: 1  2196  71 71                           ACALL   MUL_DIV_EXP_AND_SIGN
  730: 1                                ;
  731: 1                                ; check for zero exponents
  732: 1                                ;
  733: 1  2198  BE 00 02                        CJNE    R6,#00,$+5                      ;ARG 2 EXP ZERO?
  734: 1  219B  41 B4                           AJMP    ZERO_AND_EXIT
  735: 1                                ;
  736: 1                                ; calculate the exponent
  737: 1                                ;
  738: 1  219D  8D 2F           FMUL1:          MOV     FP_SIGN,R5                      ;SAVE THE SIGN, IN CASE OF FAILURE
  739: 1                                ;
  740: 1  219F  EF                              MOV     A,R7
  741: 1  21A0  60 F9                           JZ      FMUL1-2
  742: 1  21A2  2E                              ADD     A,R6                            ;ADD THE EXPONENTS
  743: 1  21A3  20 E7 05                        JB      ACC.7,FMUL_OVER
  744: 1  21A6  10 D7 06                        JBC     CY,FMUL2                        ;SEE IF CARRY IS SET
  745: 1                                ;
  746: 1  21A9  41 AE                           AJMP    UNDERFLOW_AND_EXIT
  747: 1                                ;
  748: 1  21AB                  FMUL_OVER:
  749: 1                                ;
  750: 1  21AB  50 02                           JNC     FMUL2                           ;OK IF SET
  751: 1                                ;
  752: 1  21AD  41 9D           FOV:            AJMP    OVERFLOW_AND_EXIT
  753: 1                                ;
  754: 1  21AF  94 81           FMUL2:          SUBB    A,#129                          ;SUBTRACT THE EXPONENT BIAS
  755: 1  21B1  FE                              MOV     R6,A                            ;SAVE IT FOR LATER
  756: 1                                ;
  757: 1                                ; Unpack and load R0
  758: 1                                ;
  759: 1  21B2  51 87                           ACALL   UNPACK_R0
  760: 1                                ;
  761: 1                                ; Now set up for loop multiply
  762: 1                                ;
  763: 1  21B4  7B 04                           MOV     R3,#DIGIT
  764: 1  21B6  AC 01                           MOV     R4,R1B0
  765: 1                                ;
  766: 1                                ;
  767: 1                                ; Now, do the multiply and accumulate the product
  768: 1                                ;
  769: 1  21B8  8C 01           FMUL3:          MOV     R1B0,R4
  770: 1  21BA  E3                              MOVX    A,@R1
  771: 1  21BB  FA                              MOV     R2,A
  772: 1  21BC  71 34                           ACALL   MUL_NIBBLE
  773: 1                                ;
  774: 1  21BE  EA                              MOV     A,R2
  775: 1  21BF  C4                              SWAP    A
  776: 1  21C0  71 34                           ACALL   MUL_NIBBLE
  777: 1  21C2  1C                              DEC     R4
  778: 1  21C3  DB F3                           DJNZ    R3,FMUL3
  779: 1                                ;
  780: 1                                ; Now, pack and restore the sign
  781: 1                                ;
  782: 1  21C5  8E 30                           MOV     FP_EXP,R6
  783: 1  21C7  8D 2F                           MOV     FP_SIGN,R5
  784: 1  21C9  41 2C                           AJMP    PACK                            ;FINISH IT OFF
  785: 1                                ;
  786: 1                                ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  787: 1                                ;
  788: 1  21CB                  FLOATING_DIV:
  789: 1                                ;
  790: 1                                ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  791: 1                                ;
  792: 1  21CB  71 73                           ACALL   MDES1
  793: 1                                ;
  794: 1                                ; Check the exponents
  795: 1                                ;
  796: 1  21CD  8D 2F                           MOV     FP_SIGN,R5                      ;SAVE THE SIGN
  797: 1  21CF  BF 00 06                        CJNE    R7,#0,DIV0                      ;CLEARS THE CARRY
  798: 1  21D2  51 9D                           ACALL   OVERFLOW_AND_EXIT
  799: 1  21D4  E4                              CLR     A
  800: 1  21D5  D2 E3                           SETB    ACC.ZERO_DIVIDE
  801: 1  21D7  22                              RET
  802: 1                                ;
  803: 1  21D8  EE              DIV0:           MOV     A,R6                            ;GET EXPONENT
  804: 1  21D9  60 C0                           JZ      FMUL1-2                         ;EXIT IF ZERO
  805: 1  21DB  9F                              SUBB    A,R7                            ;DELTA EXPONENT
  806: 1  21DC  20 E7 04                        JB      ACC.7,D_UNDER
  807: 1  21DF  50 04                           JNC     DIV3
  808: 1  21E1  41 AE                           AJMP    UNDERFLOW_AND_EXIT
  809: 1                                ;
  810: 1  21E3  50 C8           D_UNDER:        JNC     FOV
  811: 1                                ;
  812: 1  21E5  24 81           DIV3:           ADD     A,#129                          ;CORRECTLY BIAS THE EXPONENT
  813: 1  21E7  F5 30                           MOV     FP_EXP,A                        ;SAVE THE EXPONENT
  814: 1  21E9  71 84                           ACALL   LOADR1_MANTISSA                 ;LOAD THE DIVIDED
  815: 1                                ;
  816: 1  21EB  7A 34                           MOV     R2,#FP_ACCC                     ;SAVE LOCATION
  817: 1  21ED  AB 00                           MOV     R3,R0B0                         ;SAVE POINTER IN R3
  818: 1  21EF  75 2A 00                        MOV     FP_CARRY,#0                     ;ZERO CARRY BYTE
  819: 1                                ;
  820: 1  21F2  7D FF           DIV4:           MOV     R5,#0FFH                        ;LOOP COUNT
  821: 1  21F4  D3                              SETB    C
  822: 1                                ;
  823: 1  21F5  8B 00           DIV5:           MOV     R0B0,R3                         ;RESTORE THE EXTERNAL POINTER
  824: 1  21F7  79 2E                           MOV     R1,#FP_DIG78                    ;SET UP INTERNAL POINTER
  825: 1  21F9  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  826: 1  21FB  50 17                           JNC     DIV7                            ;EXIT IF NO CARRY
  827: 1                                ;
  828: 1  21FD  E2              DIV6:           MOVX    A,@R0                           ;DO ACCUMLATION
  829: 1  21FE  FE                              MOV     R6,A
  830: 1  21FF  E4                              CLR     A
  831: 1  2200  34 99                           ADDC    A,#99H
  832: 1  2202  9E                              SUBB    A,R6
  833: 1  2203  27                              ADD     A,@R1
  834: 1  2204  D4                              DA      A
  835: 1  2205  F7                              MOV     @R1,A
  836: 1  2206  18                              DEC     R0
  837: 1  2207  19                              DEC     R1
  838: 1  2208  DF F3                           DJNZ    R7,DIV6                         ;LOOP
  839: 1                                ;
  840: 1  220A  0D                              INC     R5                              ;SUBTRACT COUNTER
  841: 1  220B  40 E8                           JC      DIV5                            ;KEEP LOOPING IF CARRY
  842: 1  220D  E7                              MOV     A,@R1                           ;GET CARRY
  843: 1  220E  94 01                           SUBB    A,#1                            ;CARRY IS CLEARED
  844: 1  2210  F7                              MOV     @R1,A                           ;SAVE CARRY DIGIT
  845: 1  2211  B3                              CPL     C
  846: 1  2212  80 E1                           SJMP    DIV5                            ;LOOP
  847: 1                                ;
  848: 1                                ; Restore the result if carry was found
  849: 1                                ;
  850: 1  2214  31 14           DIV7:           ACALL   ADDLP                           ;ADD NUMBER BACK
  851: 1  2216  77 00                           MOV     @R1,#0                          ;CLEAR CARRY
  852: 1  2218  8A 00                           MOV     R0B0,R2                         ;GET SAVE COUNTER
  853: 1  221A  A6 05                           MOV     @R0,5                           ;SAVE COUNT BYTE
  854: 1                                ;
  855: 1  221C  0A                              INC     R2                              ;ADJUST SAVE COUNTER
  856: 1  221D  7F 01                           MOV     R7,#1                           ;BUMP DIVIDEND
  857: 1  221F  51 FC                           ACALL   LEFT
  858: 1  2221  BA 3E CE                        CJNE    R2,#FP_ACC8+2,DIV4
  859: 1                                ;
  860: 1  2224  D5 30 02                        DJNZ    FP_EXP,DIV8
  861: 1  2227  41 AE                           AJMP    UNDERFLOW_AND_EXIT
  862: 1                                ;
  863: 1  2229  75 2A 00        DIV8:           MOV     FP_CARRY,#0
  864: 1                                ;
  865: 1                                ;***************************************************************
  866: 1                                ;
  867: 1  222C                  PACK:   ; Pack the mantissa
  868: 1                                ;
  869: 1                                ;***************************************************************
  870: 1                                ;
  871: 1                                ; First, set up the pointers
  872: 1                                ;
  873: 1  222C  78 34                           MOV     R0,#FP_ACCC
  874: 1  222E  E6                              MOV     A,@R0                           ;GET FP_ACCC
  875: 1  222F  FE                              MOV     R6,A                            ;SAVE FOR ZERO COUNT
  876: 1  2230  60 03                           JZ      PACK0                           ;JUMP OVER IF ZERO
  877: 1  2232  51 7B                           ACALL   INC_FP_EXP                      ;BUMP THE EXPONENT
  878: 1  2234  18                              DEC     R0
  879: 1                                ;
  880: 1  2235  08              PACK0:          INC     R0                              ;POINT AT FP_ACC1
  881: 1                                ;
  882: 1  2236  74 08           PACK1:          MOV     A,#8                            ;ADJUST NIBBLE POINTER
  883: 1  2238  F9                              MOV     R1,A
  884: 1  2239  28                              ADD     A,R0
  885: 1  223A  F8                              MOV     R0,A
  886: 1  223B  B6 05 00                        CJNE    @R0,#5,$+3                      ;SEE IF ADJUSTING NEEDED
  887: 1  223E  40 13                           JC      PACK3+1
  888: 1                                ;
  889: 1  2240  D3              PACK2:          SETB    C
  890: 1  2241  E4                              CLR     A
  891: 1  2242  18                              DEC     R0
  892: 1  2243  36                              ADDC    A,@R0
  893: 1  2244  D4                              DA      A
  894: 1  2245  D6                              XCHD    A,@R0                           ;SAVE THE VALUE
  895: 1  2246  30 E4 09                        JNB     ACC.4,PACK3
  896: 1  2249  D9 F5                           DJNZ    R1,PACK2
  897: 1                                ;
  898: 1  224B  18                              DEC     R0
  899: 1  224C  76 01                           MOV     @R0,#1
  900: 1  224E  51 7B                           ACALL   INC_FP_EXP
  901: 1  2250  80 06                           SJMP    PACK4
  902: 1                                ;
  903: 1  2252  19              PACK3:          DEC     R1
  904: 1  2253  E9                              MOV     A,R1
  905: 1  2254  C3                              CLR     C
  906: 1  2255  C8                              XCH     A,R0
  907: 1  2256  98                              SUBB    A,R0
  908: 1  2257  F8                              MOV     R0,A
  909: 1                                ;
  910: 1  2258  79 2B           PACK4:          MOV     R1,#FP_DIG12
  911: 1                                ;
  912: 1                                ; Now, pack
  913: 1                                ;
  914: 1  225A  E6              PLOOP:          MOV     A,@R0
  915: 1  225B  C4                              SWAP    A                               ;FLIP THE DIGITS
  916: 1  225C  08                              INC     R0
  917: 1  225D  D6                              XCHD    A,@R0
  918: 1  225E  42 06                           ORL     6,A                             ;ACCUMULATE THE OR'ED DIGITS
  919: 1  2260  F7                              MOV     @R1,A
  920: 1  2261  08                              INC     R0
  921: 1  2262  09                              INC     R1
  922: 1  2263  B9 2F F4                        CJNE    R1,#FP_SIGN,PLOOP
  923: 1  2266  EE                              MOV     A,R6
  924: 1  2267  70 03                           JNZ     STORE_ALIGN_TEST_AND_EXIT
  925: 1  2269  75 30 00                        MOV     FP_EXP,#0                       ;ZERO EXPONENT
  926: 1                                ;
  927: 1                                ;**************************************************************
  928: 1                                ;
  929: 1  226C                  STORE_ALIGN_TEST_AND_EXIT:                              ;Save the number align carry and exit
  930: 1                                ;
  931: 1                                ;**************************************************************
  932: 1                                ;
  933: 1  226C  71 67                           ACALL   LOAD_POINTERS
  934: 1  226E  89 24                           MOV     ARG_STACK,R1                    ;SET UP THE NEW STACK
  935: 1  2270  78 30                           MOV     R0,#FP_EXP
  936: 1                                ;
  937: 1                                ; Now load the numbers
  938: 1                                ;
  939: 1  2272  E6              STORE2:         MOV     A,@R0
  940: 1  2273  F3                              MOVX    @R1,A                           ;SAVE THE NUMBER
  941: 1  2274  18                              DEC     R0
  942: 1  2275  19                              DEC     R1
  943: 1  2276  B8 2A F9                        CJNE    R0,#FP_CARRY,STORE2
  944: 1                                ;
  945: 1  2279  E4                              CLR     A                               ;NO ERRORS
  946: 1                                ;
  947: 1  227A  22              PRET:           RET                                     ;EXIT
  948: 1                                ;
  949: 1  227B                  INC_FP_EXP:
  950: 1                                ;
  951: 1  227B  05 30                           INC     FP_EXP
  952: 1  227D  E5 30                           MOV     A,FP_EXP
  953: 1  227F  70 F9                           JNZ     PRET                            ;EXIT IF NOT ZERO
  954: 1  2281  D0 E0                           POP     ACC                             ;WASTE THE CALLING STACK
  955: 1  2283  D0 E0                           POP     ACC
  956: 1  2285  41 9D                           AJMP    OVERFLOW_AND_EXIT
  957: 1                                ;
  958: 1                        ;***********************************************************************
  959: 1                        ;
  960: 1  2287                  UNPACK_R0:      ; Unpack BCD digits and load into nibble locations
  961: 1                        ;
  962: 1                        ;***********************************************************************
  963: 1                                ;
  964: 1  2287  C0 01                           PUSH    R1B0
  965: 1  2289  79 32                           MOV     R1,#FP_NIB8
  966: 1                                ;
  967: 1  228B  E2              ULOOP:          MOVX    A,@R0
  968: 1  228C  54 0F                           ANL     A,#0FH
  969: 1  228E  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE
  970: 1  228F  E2                              MOVX    A,@R0
  971: 1  2290  C4                              SWAP    A
  972: 1  2291  54 0F                           ANL     A,#0FH
  973: 1  2293  19                              DEC     R1
  974: 1  2294  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE AGAIN
  975: 1  2295  18                              DEC     R0
  976: 1  2296  19                              DEC     R1
  977: 1  2297  B9 2A F1                        CJNE    R1,#FP_NIB1-1,ULOOP
  978: 1                                ;
  979: 1  229A  D0 01                           POP     R1B0
  980: 1                                ;
  981: 1  229C  22              LOAD7:          RET
  982: 1                                ;
  983: 1                                ;**************************************************************
  984: 1                                ;
  985: 1  229D                  OVERFLOW_AND_EXIT:      ;LOAD 99999999 E+127,  SET OV BIT, AND EXIT
  986: 1                                ;
  987: 1                                ;**************************************************************
  988: 1                                ;
  989: 1  229D  78 2E                           MOV     R0,#FP_DIG78
  990: 1  229F  74 99                           MOV     A,#99H
  991: 1                                ;
  992: 1  22A1  F6              OVE1:           MOV     @R0,A
  993: 1  22A2  18                              DEC     R0
  994: 1  22A3  B8 2A FB                        CJNE    R0,#FP_CARRY,OVE1
  995: 1                                ;
  996: 1  22A6  75 30 FF                        MOV     FP_EXP,#0FFH
  997: 1  22A9  51 6C                           ACALL   STORE_ALIGN_TEST_AND_EXIT
  998: 1                                ;
  999: 1  22AB  D2 E1                           SETB    ACC.OVERFLOW
 1000: 1  22AD  22                              RET
 1001: 1                                ;
 1002: 1                                ;**************************************************************
 1003: 1                                ;
 1004: 1  22AE                  UNDERFLOW_AND_EXIT:     ;LOAD 0, SET UF BIT, AND EXIT
 1005: 1                                ;
 1006: 1                                ;**************************************************************
 1007: 1                                ;
 1008: 1  22AE  51 B4                           ACALL   ZERO_AND_EXIT
 1009: 1  22B0  E4                              CLR     A
 1010: 1  22B1  D2 E0                           SETB    ACC.UNDERFLOW
 1011: 1  22B3  22                              RET
 1012: 1                                ;
 1013: 1                                ;**************************************************************
 1014: 1                                ;
 1015: 1  22B4                  ZERO_AND_EXIT:          ;LOAD 0, SET ZERO BIT, AND EXIT
 1016: 1                                ;
 1017: 1                                ;**************************************************************
 1018: 1                                ;
 1019: 1  22B4  51 BB                           ACALL   FP_CLEAR
 1020: 1  22B6  51 6C                           ACALL   STORE_ALIGN_TEST_AND_EXIT
 1021: 1  22B8  D2 E2                           SETB    ACC.ZERO
 1022: 1  22BA  22                              RET                                     ;EXIT
 1023: 1                                ;
 1024: 1                                ;**************************************************************
 1025: 1                                ;
 1026: 1  22BB                  FP_CLEAR:
 1027: 1                                ;
 1028: 1                                ; Clear internal storage
 1029: 1                                ;
 1030: 1                                ;**************************************************************
 1031: 1                                ;
 1032: 1  22BB  E4                              CLR     A
 1033: 1  22BC  78 3D                           MOV     R0,#FP_ACC8+1
 1034: 1                                ;
 1035: 1  22BE  F6              FPC1:           MOV     @R0,A
 1036: 1  22BF  18                              DEC     R0
 1037: 1  22C0  B8 29 FB                        CJNE    R0,#FP_TEMP,FPC1
 1038: 1  22C3  22                              RET
 1039: 1                                ;
 1040: 1                                ;**************************************************************
 1041: 1                                ;
 1042: 1  22C4                  RIGHT:  ; Shift ACCUMULATOR RIGHT the number of nibbles in R7
 1043: 1                                ; Save the shifted values in R4 if SAVE_ROUND is set
 1044: 1                                ;
 1045: 1                                ;**************************************************************
 1046: 1                                ;
 1047: 1  22C4  7C 00                           MOV     R4,#0                           ;IN CASE OF NO SHIFT
 1048: 1                                ;
 1049: 1  22C6  C3              RIGHT1:         CLR     C
 1050: 1  22C7  EF                              MOV     A,R7                            ;GET THE DIGITS TO SHIFT
 1051: 1  22C8  60 22                           JZ      RIGHT5-1                        ;EXIT IF ZERO
 1052: 1  22CA  94 02                           SUBB    A,#2                            ;TWO TO DO?
 1053: 1  22CC  50 1F                           JNC     RIGHT5                          ;SHIFT TWO NIBBLES
 1054: 1                                ;
 1055: 1                                ; Swap one nibble then exit
 1056: 1                                ;
 1057: 1  22CE  C0 00           RIGHT3:         PUSH    R0B0                            ;SAVE POINTER REGISTER
 1058: 1  22D0  C0 01                           PUSH    R1B0
 1059: 1                                ;
 1060: 1  22D2  79 2E                           MOV     R1,#FP_DIG78                    ;LOAD THE POINTERS
 1061: 1  22D4  78 2D                           MOV     R0,#FP_DIG56
 1062: 1  22D6  EC                              MOV     A,R4                            ;GET THE OVERFLOW REGISTER
 1063: 1  22D7  D7                              XCHD    A,@R1                           ;GET DIGIT 8
 1064: 1  22D8  C4                              SWAP    A                               ;FLIP FOR LOAD
 1065: 1  22D9  FC                              MOV     R4,A
 1066: 1                                ;
 1067: 1  22DA  E7              RIGHTL:         MOV     A,@R1                           ;GET THE LOW ORDER BYTE
 1068: 1  22DB  D6                              XCHD    A,@R0                           ;SWAP NIBBLES
 1069: 1  22DC  C4                              SWAP    A                               ;FLIP FOR STORE
 1070: 1  22DD  F7                              MOV     @R1,A                           ;SAVE THE DIGITS
 1071: 1  22DE  18                              DEC     R0                              ;BUMP THE POINTERS
 1072: 1  22DF  19                              DEC     R1
 1073: 1  22E0  B9 2A F7                        CJNE    R1,#FP_DIG12-1,RIGHTL           ;LOOP
 1074: 1                                ;
 1075: 1  22E3  E7                              MOV     A,@R1                           ;ACC = CH8
 1076: 1  22E4  C4                              SWAP    A                               ;ACC = 8CH
 1077: 1  22E5  54 0F                           ANL     A,#0FH                          ;ACC = 0CH
 1078: 1  22E7  F7                              MOV     @R1,A                           ;CARRY DONE
 1079: 1  22E8  D0 01                           POP     R1B0                            ;EXIT
 1080: 1  22EA  D0 00                           POP     R0B0                            ;RESTORE REGISTER
 1081: 1  22EC  22                              RET
 1082: 1                                ;
 1083: 1  22ED  FF              RIGHT5:         MOV     R7,A                            ;SAVE THE NEW SHIFT NUMBER
 1084: 1  22EE  E4                              CLR     A
 1085: 1  22EF  C5 2A                           XCH     A,FP_CARRY                      ;SWAP THE NIBBLES
 1086: 1  22F1  C5 2B                           XCH     A,FP_DIG12
 1087: 1  22F3  C5 2C                           XCH     A,FP_DIG34
 1088: 1  22F5  C5 2D                           XCH     A,FP_DIG56
 1089: 1  22F7  C5 2E                           XCH     A,FP_DIG78
 1090: 1  22F9  FC                              MOV     R4,A                            ;SAVE THE LAST DIGIT SHIFTED
 1091: 1  22FA  80 CB                           SJMP    RIGHT1+1
 1092: 1                                ;
 1093: 1                                ;***************************************************************
 1094: 1                                ;
 1095: 1  22FC                  LEFT:   ; Shift ACCUMULATOR LEFT the number of nibbles in R7
 1096: 1                                ;
 1097: 1                                ;***************************************************************
 1098: 1                                ;
 1099: 1  22FC  7C 00                           MOV     R4,#00H                         ;CLEAR FOR SOME ENTRYS
 1100: 1                                ;
 1101: 1  22FE  C3              LEFT1:          CLR     C
 1102: 1  22FF  EF                              MOV     A,R7                            ;GET SHIFT VALUE
 1103: 1  2300  60 22                           JZ      LEFT5-1                         ;EXIT IF ZERO
 1104: 1  2302  94 02                           SUBB    A,#2                            ;SEE HOW MANY BYTES TO SHIFT
 1105: 1  2304  50 1F                           JNC     LEFT5
 1106: 1                                ;
 1107: 1  2306  C0 00           LEFT3:          PUSH    R0B0                            ;SAVE POINTER
 1108: 1  2308  C0 01                           PUSH    R1B0
 1109: 1  230A  78 2A                           MOV     R0,#FP_CARRY
 1110: 1  230C  79 2B                           MOV     R1,#FP_DIG12
 1111: 1                                ;
 1112: 1  230E  E6                              MOV     A,@R0                           ;ACC=CHCL
 1113: 1  230F  C4                              SWAP    A                               ;ACC = CLCH
 1114: 1  2310  F6                              MOV     @R0,A                           ;ACC = CLCH, @R0 = CLCH
 1115: 1                                ;
 1116: 1  2311  E7              LEFTL:          MOV     A,@R1                           ;DIG 12
 1117: 1  2312  C4                              SWAP    A                               ;DIG 21
 1118: 1  2313  D6                              XCHD    A,@R0
 1119: 1  2314  F7                              MOV     @R1,A                           ;SAVE IT
 1120: 1  2315  08                              INC     R0                              ;BUMP POINTERS
 1121: 1  2316  09                              INC     R1
 1122: 1  2317  B8 2E F7                        CJNE    R0,#FP_DIG78,LEFTL
 1123: 1                                ;
 1124: 1  231A  EC                              MOV     A,R4
 1125: 1  231B  C4                              SWAP    A
 1126: 1  231C  D6                              XCHD    A,@R0
 1127: 1  231D  54 F0                           ANL     A,#0F0H
 1128: 1  231F  FC                              MOV     R4,A
 1129: 1                                ;
 1130: 1  2320  D0 01                           POP     R1B0
 1131: 1  2322  D0 00                           POP     R0B0                            ;RESTORE
 1132: 1  2324  22                              RET                                     ;DONE
 1133: 1                                ;
 1134: 1  2325  FF              LEFT5:          MOV     R7,A                            ;RESTORE COUNT
 1135: 1  2326  E4                              CLR     A
 1136: 1  2327  CC                              XCH     A,R4                            ;GET THE RESTORATION BYTE
 1137: 1  2328  C5 2E                           XCH     A,FP_DIG78                      ;DO THE SWAP
 1138: 1  232A  C5 2D                           XCH     A,FP_DIG56
 1139: 1  232C  C5 2C                           XCH     A,FP_DIG34
 1140: 1  232E  C5 2B                           XCH     A,FP_DIG12
 1141: 1  2330  C5 2A                           XCH     A,FP_CARRY
 1142: 1  2332  80 CB                           SJMP    LEFT1+1
 1143: 1                                ;
 1144: 1  2334                  MUL_NIBBLE:
 1145: 1                                ;
 1146: 1                                ; Multiply the nibble in R7 by the FP_NIB locations
 1147: 1                                ; accumulate the product in FP_ACC
 1148: 1                                ;
 1149: 1                                ; Set up the pointers for multiplication
 1150: 1                                ;
 1151: 1  2334  54 0F                           ANL     A,#0FH                          ;STRIP OFF MS NIBBLE
 1152: 1  2336  FF                              MOV     R7,A
 1153: 1  2337  78 3C                           MOV     R0,#FP_ACC8
 1154: 1  2339  79 32                           MOV     R1,#FP_NIB8
 1155: 1  233B  E4                              CLR     A
 1156: 1  233C  F5 33                           MOV     FP_ACCX,A
 1157: 1                                ;
 1158: 1  233E  18              MNLOOP:         DEC     R0                              ;BUMP POINTER TO PROPAGATE CARRY
 1159: 1  233F  26                              ADD     A,@R0                           ;ATTEMPT TO FORCE CARRY
 1160: 1  2340  D4                              DA      A                               ;BCD ADJUST
 1161: 1  2341  30 E4 03                        JNB     ACC.4,MNL0                      ;DON'T ADJUST IF NO NEED
 1162: 1  2344  18                              DEC     R0                              ;PROPAGATE CARRY TO THE NEXT DIGIT
 1163: 1  2345  06                              INC     @R0                             ;DO THE ADJUSTING
 1164: 1  2346  08                              INC     R0                              ;RESTORE R0
 1165: 1                                ;
 1166: 1  2347  D6              MNL0:           XCHD    A,@R0                           ;RESTORE INITIAL NUMBER
 1167: 1  2348  8F F0                           MOV     B,R7                            ;GET THE NUBBLE TO MULTIPLY
 1168: 1  234A  E7                              MOV     A,@R1                           ;GET THE OTHER NIBBLE
 1169: 1  234B  A4                              MUL     AB                              ;DO THE MULTIPLY
 1170: 1  234C  75 F0 0A                        MOV     B,#10                           ;NOW BCD ADJUST
 1171: 1  234F  84                              DIV     AB
 1172: 1  2350  C5 F0                           XCH     A,B                             ;GET THE REMAINDER
 1173: 1  2352  26                              ADD     A,@R0                           ;PROPAGATE THE PARTIAL PRODUCTS
 1174: 1  2353  D4                              DA      A                               ;BCD ADJUST
 1175: 1  2354  30 E4 02                        JNB     ACC.4,MNL1                      ;PROPAGATE PARTIAL PRODUCT CARRY
 1176: 1  2357  05 F0                           INC     B
 1177: 1                                ;
 1178: 1  2359  08              MNL1:           INC     R0
 1179: 1  235A  D6                              XCHD    A,@R0                           ;SAVE THE NEW PRODUCT
 1180: 1  235B  18                              DEC     R0
 1181: 1  235C  E5 F0                           MOV     A,B                             ;GET BACK THE QUOTIENT
 1182: 1  235E  19                              DEC     R1
 1183: 1  235F  B9 2A DC                        CJNE    R1,#FP_NIB1-1,MNLOOP
 1184: 1                                ;
 1185: 1  2362  25 33                           ADD     A,FP_ACCX                       ;GET THE OVERFLOW
 1186: 1  2364  D4                              DA      A                               ;ADJUST
 1187: 1  2365  F6                              MOV     @R0,A                           ;SAVE IT
 1188: 1  2366  22                              RET                                     ;EXIT
 1189: 1                                ;
 1190: 1                                ;***************************************************************
 1191: 1                                ;
 1192: 1  2367                  LOAD_POINTERS:  ; Load the ARG_STACK into R0 and bump R1
 1193: 1                                ;
 1194: 1                                ;***************************************************************
 1195: 1                                ;
 1196: 1  2367  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1197: 1  236A  A8 24                           MOV     R0,ARG_STACK
 1198: 1  236C  74 06                           MOV     A,#FP_NUMBER_SIZE
 1199: 1  236E  28                              ADD     A,R0
 1200: 1  236F  F9                              MOV     R1,A
 1201: 1  2370  22                              RET
 1202: 1                                ;
 1203: 1                                ;***************************************************************
 1204: 1                                ;
 1205: 1  2371                  MUL_DIV_EXP_AND_SIGN:
 1206: 1                                ;
 1207: 1                                ; Load the sign into R7, R6. R5 gets the sign for
 1208: 1                                ; multiply and divide.
 1209: 1                                ;
 1210: 1                                ;***************************************************************
 1211: 1                                ;
 1212: 1  2371  51 BB                           ACALL   FP_CLEAR                        ;CLEAR INTERNAL MEMORY
 1213: 1                                ;
 1214: 1  2373  71 67           MDES1:          ACALL   LOAD_POINTERS                   ;LOAD REGISTERS
 1215: 1  2375  E2                              MOVX    A,@R0                           ;ARG 1 EXP
 1216: 1  2376  FF                              MOV     R7,A                            ;SAVED IN R7
 1217: 1  2377  E3                              MOVX    A,@R1                           ;ARG 2 EXP
 1218: 1  2378  FE                              MOV     R6,A                            ;SAVED IN R6
 1219: 1  2379  18                              DEC     R0                              ;BUMP POINTERS TO SIGN
 1220: 1  237A  19                              DEC     R1
 1221: 1  237B  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1222: 1  237C  FC                              MOV     R4,A                            ;SIGN OF ARG1
 1223: 1  237D  E3                              MOVX    A,@R1                           ;GET SIGN OF NEXT ARG
 1224: 1  237E  FB                              MOV     R3,A                            ;SIGN OF ARG2
 1225: 1  237F  6C                              XRL     A,R4                            ;ACC GETS THE NEW SIGN
 1226: 1  2380  FD                              MOV     R5,A                            ;R5 GETS THE NEW SIGN
 1227: 1                                ;
 1228: 1                                ; Bump the pointers to point at the LS digit
 1229: 1                                ;
 1230: 1  2381  18                              DEC     R0
 1231: 1  2382  19                              DEC     R1
 1232: 1                                ;
 1233: 1  2383  22                              RET
 1234: 1                                ;
 1235: 1                                ;***************************************************************
 1236: 1                                ;
 1237: 1  2384                  LOADR1_MANTISSA:
 1238: 1                                ;
 1239: 1                                ; Load the mantissa of R0 into FP_Digits
 1240: 1                                ;
 1241: 1                                ;***************************************************************
 1242: 1                                ;
 1243: 1  2384  C0 00                           PUSH    R0B0                            ;SAVE REGISTER 1
 1244: 1  2386  78 2E                           MOV     R0,#FP_DIG78                    ;SET UP THE POINTER
 1245: 1                                ;
 1246: 1  2388  E3              LOADR1:         MOVX    A,@R1
 1247: 1  2389  F6                              MOV     @R0,A
 1248: 1  238A  19                              DEC     R1
 1249: 1  238B  18                              DEC     R0
 1250: 1  238C  B8 2A F9                        CJNE    R0,#FP_CARRY,LOADR1
 1251: 1                                ;
 1252: 1  238F  D0 00                           POP     R0B0
 1253: 1  2391  22                              RET
 1254: 1                                ;
 1255: 1                                ;***************************************************************
 1256: 1                                ;
 1257: 1  2392                  HEXSCAN:        ; Scan a string to determine if it is a hex number
 1258: 1                                        ; set carry if hex, else carry = 0
 1259: 1                                ;
 1260: 1                                ;***************************************************************
 1261: 1                                ;
 1262: 1  2392  91 68                           ACALL   GET_DPTR_CHARACTER
 1263: 1  2394  C0 83                           PUSH    DPH
 1264: 1  2396  C0 82                           PUSH    DPL                             ;SAVE THE POINTER
 1265: 1                                ;
 1266: 1  2398  E0              HEXSC1:         MOVX    A,@DPTR                         ;GET THE CHARACTER
 1267: 1  2399  D1 76                           ACALL   DIGIT_CHECK                     ;SEE IF A DIGIT
 1268: 1  239B  40 12                           JC      HS1                             ;CONTINUE IF A DIGIT
 1269: 1  239D  71 B2                           ACALL   HEX_CHECK                       ;SEE IF HEX
 1270: 1  239F  40 0E                           JC      HS1
 1271: 1                                ;
 1272: 1  23A1  C2 E5                           CLR     ACC.5                           ;NO LOWER CASE
 1273: 1  23A3  B4 48 03                        CJNE    A,#'H',HEXDON
 1274: 1  23A6  D3                              SETB    C
 1275: 1  23A7  80 01                           SJMP    HEXDO1                          ;NUMBER IS VALID HEX, MAYBE
 1276: 1                                ;
 1277: 1  23A9  C3              HEXDON:         CLR     C
 1278: 1                                ;
 1279: 1  23AA  D0 82           HEXDO1:         POP     DPL                             ;RESTORE POINTER
 1280: 1  23AC  D0 83                           POP     DPH
 1281: 1  23AE  22                              RET
 1282: 1                                ;
 1283: 1  23AF  A3              HS1:            INC     DPTR                            ;BUMP TO NEXT CHARACTER
 1284: 1  23B0  80 E6                           SJMP    HEXSC1                          ;LOOP
 1285: 1                                ;
 1286: 1  23B2                  HEX_CHECK:      ;CHECK FOR A VALID ASCII HEX, SET CARRY IF FOUND
 1287: 1                                ;
 1288: 1  23B2  C2 E5                           CLR     ACC.5                           ;WASTE LOWER CASE
 1289: 1  23B4  B4 47 00                        CJNE    A,#'F'+1,$+3                    ;SEE IF F OR LESS
 1290: 1  23B7  40 01                           JC      HC1
 1291: 1  23B9  22                              RET
 1292: 1                                ;
 1293: 1  23BA  B4 41 00        HC1:            CJNE    A,#'A',$+3                      ;SEE IF A OR GREATER
 1294: 1  23BD  B3                              CPL     C
 1295: 1  23BE  22                              RET
 1296: 1                                ;
 1297: 1                                ;
 1298: 1  23BF                  PUSHR2R0:
 1299: 1                                ;
 1300: 1  23BF  7B 00                           MOV     R3,#HIGH CONVT                  ;CONVERSION LOCATION
 1301: 1  23C1  79 48                           MOV     R1,#LOW CONVT
 1302: 1  23C3  D1 00                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1303: 1  23C5  74 0D                           MOV     A,#0DH                          ;A CR TO TERMINATE
 1304: 1  23C7  F3                              MOVX    @R1,A                           ;SAVE THE CR
 1305: 1  23C8  90 00 48                        MOV     DPTR,#CONVT
 1306: 1                                ;
 1307: 1                                ; Falls thru to FLOATING INPUT
 1308: 1                                ;
 1309: 1                                ;***************************************************************
 1310: 1                                ;
 1311: 1  23CB                  FLOATING_POINT_INPUT:   ; Input a floating point number pointed to by the DPTR
 1312: 1                                ;
 1313: 1                                ;***************************************************************
 1314: 1                                ;
 1315: 1  23CB  51 BB                           ACALL   FP_CLEAR                        ;CLEAR EVERYTHING
 1316: 1  23CD  91 68                           ACALL   GET_DPTR_CHARACTER
 1317: 1  23CF  91 6E                           ACALL   PLUS_MINUS_TEST
 1318: 1  23D1  92 78                           MOV     MSIGN,C                         ;SAVE THE MANTISSA SIGN
 1319: 1                                ;
 1320: 1                                ; Now, set up for input loop
 1321: 1                                ;
 1322: 1  23D3  78 34                           MOV     R0,#FP_ACCC
 1323: 1  23D5  7E 7F                           MOV     R6,#7FH                         ;BASE EXPONENT
 1324: 1  23D7  D2 D5                           SETB    F0                              ;SET INITIAL FLAG
 1325: 1                                ;
 1326: 1  23D9  D1 74           INLOOP:         ACALL   GET_DIGIT_CHECK
 1327: 1  23DB  50 07                           JNC     GTEST                           ;IF NOT A CHARACTER, WHAT IS IT?
 1328: 1  23DD  54 0F                           ANL     A,#0FH                          ;STRIP ASCII
 1329: 1  23DF  91 41                           ACALL   STDIG                           ;STORE THE DIGITS
 1330: 1                                ;
 1331: 1  23E1  A3              INLPIK:         INC     DPTR                            ;BUMP POINTER FOR LOOP
 1332: 1  23E2  80 F5                           SJMP    INLOOP                          ;LOOP FOR INPUT
 1333: 1                                ;
 1334: 1  23E4  B4 2E 0C        GTEST:          CJNE    A,#'.',GT1                      ;SEE IF A RADIX
 1335: 1  23E7  20 51 63                        JB      FOUND_RADIX,INERR
 1336: 1  23EA  D2 51                           SETB    FOUND_RADIX
 1337: 1  23EC  B8 34 F2                        CJNE    R0,#FP_ACCC,INLPIK
 1338: 1  23EF  D2 52                           SETB    FIRST_RADIX                     ;SET IF FIRST RADIX
 1339: 1  23F1  80 EE                           SJMP    INLPIK                          ;GET ADDITIONAL DIGITS
 1340: 1                                ;
 1341: 1  23F3  20 D5 57        GT1:            JB      F0,INERR                        ;ERROR IF NOT CLEARED
 1342: 1  23F6  B4 65 02                        CJNE    A,#'e',$+5                      ;CHECK FOR LOWER CASE
 1343: 1  23F9  80 03                           SJMP    $+5
 1344: 1  23FB  B4 45 33                        CJNE    A,#'E',FINISH_UP
 1345: 1  23FE  91 67                           ACALL   INC_AND_GET_DPTR_CHARACTER
 1346: 1  2400  91 6E                           ACALL   PLUS_MINUS_TEST
 1347: 1  2402  92 50                           MOV     XSIGN,C                         ;SAVE SIGN STATUS
 1348: 1  2404  D1 74                           ACALL   GET_DIGIT_CHECK
 1349: 1  2406  50 45                           JNC     INERR
 1350: 1                                ;
 1351: 1  2408  54 0F                           ANL     A,#0FH                          ;STRIP ASCII BIAS OFF THE CHARACTER
 1352: 1  240A  FD                              MOV     R5,A                            ;SAVE THE CHARACTER IN R5
 1353: 1                                ;
 1354: 1  240B  A3              GT2:            INC     DPTR
 1355: 1  240C  D1 74                           ACALL   GET_DIGIT_CHECK
 1356: 1  240E  50 0D                           JNC     FINISH1
 1357: 1  2410  54 0F                           ANL     A,#0FH                          ;STRIP OFF BIAS
 1358: 1  2412  CD                              XCH     A,R5                            ;GET THE LAST DIGIT
 1359: 1  2413  75 F0 0A                        MOV     B,#10                           ;MULTIPLY BY TEN
 1360: 1  2416  A4                              MUL     AB
 1361: 1  2417  2D                              ADD     A,R5                            ;ADD TO ORIGINAL VALUE
 1362: 1  2418  FD                              MOV     R5,A                            ;SAVE IN R5
 1363: 1  2419  50 F0                           JNC     GT2                             ;LOOP IF NO CARRY
 1364: 1  241B  7D FF                           MOV     R5,#0FFH                        ;FORCE AN ERROR
 1365: 1                                ;
 1366: 1  241D  ED              FINISH1:        MOV     A,R5                            ;GET THE SIGN
 1367: 1  241E  30 50 09                        JNB     XSIGN,POSNUM                    ;SEE IF EXPONENT IS POS OR NEG
 1368: 1  2421  C3                              CLR     C
 1369: 1  2422  9E                              SUBB    A,R6
 1370: 1  2423  F4                              CPL     A
 1371: 1  2424  04                              INC     A
 1372: 1  2425  40 09                           JC      FINISH2
 1373: 1  2427  74 01                           MOV     A,#01H
 1374: 1  2429  22                              RET
 1375: 1                                ;
 1376: 1  242A  2E              POSNUM:         ADD     A,R6                            ;ADD TO EXPONENT
 1377: 1  242B  50 03                           JNC     FINISH2
 1378: 1                                ;
 1379: 1  242D  74 02           POSNM1:         MOV     A,#02H
 1380: 1  242F  22                              RET
 1381: 1                                ;
 1382: 1  2430  CE              FINISH2:        XCH     A,R6                            ;SAVE THE EXPONENT
 1383: 1                                ;
 1384: 1  2431                  FINISH_UP:
 1385: 1                                ;
 1386: 1  2431  8E 30                           MOV     FP_EXP,R6                       ;SAVE EXPONENT
 1387: 1  2433  B8 34 02                        CJNE    R0,#FP_ACCC,$+5
 1388: 1  2436  51 BB                           ACALL   FP_CLEAR                        ;CLEAR THE MEMORY IF 0
 1389: 1  2438  E5 24                           MOV     A,ARG_STACK                     ;GET THE ARG STACK
 1390: 1  243A  C3                              CLR     C
 1391: 1  243B  94 0C                           SUBB    A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
 1392: 1  243D  F5 24                           MOV     ARG_STACK,A                     ;ADJUST FOR STORE
 1393: 1  243F  41 2C                           AJMP    PACK
 1394: 1                                ;
 1395: 1  2441  C2 D5           STDIG:          CLR     F0                              ;CLEAR INITIAL DESIGNATOR
 1396: 1  2443  70 0B                           JNZ     STDIG1                          ;CONTINUE IF NOT ZERO
 1397: 1  2445  B8 34 08                        CJNE    R0,#FP_ACCC,STDIG1
 1398: 1  2448  30 52 04                        JNB     FIRST_RADIX,RET_X
 1399: 1                                ;
 1400: 1  244B  DE 02           DECX:           DJNZ    R6,RET_X
 1401: 1                                ;
 1402: 1  244D  74 FF           INERR:          MOV     A,#0FFH
 1403: 1                                ;
 1404: 1  244F  22              RET_X:          RET
 1405: 1                                ;
 1406: 1  2450  20 53 02        STDIG1:         JB      DONE_LOAD,FRTEST
 1407: 1  2453  C2 52                           CLR     FIRST_RADIX
 1408: 1                                ;
 1409: 1  2455  20 52 F3        FRTEST:         JB      FIRST_RADIX,DECX
 1410: 1                                ;
 1411: 1  2458  20 51 01        FDTEST:         JB      FOUND_RADIX,FDT1
 1412: 1  245B  0E                              INC     R6
 1413: 1                                ;
 1414: 1  245C  20 53 F0        FDT1:           JB      DONE_LOAD,RET_X
 1415: 1  245F  B8 3D 02                        CJNE    R0,#FP_ACC8+1,FDT2
 1416: 1  2462  D2 53                           SETB    DONE_LOAD
 1417: 1                                ;
 1418: 1  2464  F6              FDT2:           MOV     @R0,A                           ;SAVE THE STRIPPED ACCUMULATOR
 1419: 1  2465  08                              INC     R0                              ;BUMP THE POINTER
 1420: 1  2466  22                              RET                                     ;EXIT
 1421: 1                                ;
 1422: 1                                ;***************************************************************
 1423: 1                                ;
 1424: 1                                ; I/O utilities
 1425: 1                                ;
 1426: 1                                ;***************************************************************
 1427: 1                                ;
 1428: 1  2467                  INC_AND_GET_DPTR_CHARACTER:
 1429: 1                                ;
 1430: 1  2467  A3                              INC     DPTR
 1431: 1                                ;
 1432: 1  2468                  GET_DPTR_CHARACTER:
 1433: 1                                ;
 1434: 1  2468  E0                              MOVX    A,@DPTR                         ;GET THE CHARACTER
 1435: 1  2469  B4 20 16                        CJNE    A,#' ',PMT1                     ;SEE IF A SPACE
 1436: 1                                ;
 1437: 1                                ; Kill spaces
 1438: 1                                ;
 1439: 1  246C  80 F9                           SJMP    INC_AND_GET_DPTR_CHARACTER
 1440: 1                                ;
 1441: 1  246E                  PLUS_MINUS_TEST:
 1442: 1                                ;
 1443: 1  246E  B4 E3 02                        CJNE    A,#0E3H,$+5                     ;SEE IF A PLUS, PLUS TOKEN FROM BASIC
 1444: 1  2471  80 0E                           SJMP    PMT3
 1445: 1  2473  B4 2B 02                        CJNE    A,#'+',$+5
 1446: 1  2476  80 09                           SJMP    PMT3
 1447: 1  2478  B4 E5 02                        CJNE    A,#0E5H,$+5                     ;SEE IF MINUS, MINUS TOKEN FROM BASIC
 1448: 1  247B  80 03                           SJMP    PMT2
 1449: 1  247D  B4 2D 02                        CJNE    A,#'-',PMT1
 1450: 1                                ;
 1451: 1  2480  D3              PMT2:           SETB    C
 1452: 1                                ;
 1453: 1  2481  A3              PMT3:           INC     DPTR
 1454: 1                                ;
 1455: 1  2482  22              PMT1:           RET
 1456: 1                                ;
 1457: 1                                ;***************************************************************
 1458: 1                                ;
 1459: 1  2483                  FLOATING_POINT_OUTPUT:  ; Output the number, format is in location 25
 1460: 1                                ;
 1461: 1                                ; IF FORMAT = 00 - FREE FLOATING
 1462: 1                                ;           = FX - EXPONENTIAL (X IS THE NUMBER OF SIG DIGITS)
 1463: 1                                ;           = NX - N = NUM BEFORE RADIX, X = NUM AFTER RADIX
 1464: 1                                ;                  N + X = 8 MAX
 1465: 1                                ;
 1466: 1                                ;***************************************************************
 1467: 1                                ;
 1468: 1  2483  71 73                           ACALL   MDES1                           ;GET THE NUMBER TO OUTPUT, R0 IS POINTER
 1469: 1  2485  11 C4                           ACALL   POP_AND_EXIT                    ;OUTPUT POPS THE STACK
 1470: 1  2487  EF                              MOV     A,R7
 1471: 1  2488  FE                              MOV     R6,A                            ;PUT THE EXPONENT IN R6
 1472: 1  2489  51 87                           ACALL   UNPACK_R0                       ;UNPACK THE NUMBER
 1473: 1  248B  78 2B                           MOV     R0,#FP_NIB1                     ;POINT AT THE NUMBER
 1474: 1  248D  E5 25                           MOV     A,FORMAT                        ;GET THE FORMAT
 1475: 1  248F  FB                              MOV     R3,A                            ;SAVE IN CASE OF EXP FORMAT
 1476: 1  2490  60 49                           JZ      FREE                            ;FREE FLOATING?
 1477: 1  2492  B4 F0 00                        CJNE    A,#0F0H,$+3                     ;SEE IF EXPONENTIAL
 1478: 1  2495  50 73                           JNC     EXPOUT
 1479: 1                                ;
 1480: 1                                ; If here, must be integer USING format
 1481: 1                                ;
 1482: 1  2497  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1483: 1  2498  70 02                           JNZ     $+4
 1484: 1  249A  7E 80                           MOV     R6,#80H
 1485: 1  249C  EB                              MOV     A,R3                            ;GET THE FORMAT
 1486: 1  249D  C4                              SWAP    A                                       ;SPLIT INTEGER AND FRACTION
 1487: 1  249E  54 0F                           ANL     A,#0FH
 1488: 1  24A0  FA                              MOV     R2,A                            ;SAVE INTEGER
 1489: 1  24A1  B1 70                           ACALL   NUM_LT                          ;GET THE NUMBER OF INTEGERS
 1490: 1  24A3  CA                              XCH     A,R2                            ;FLIP FOR SUBB
 1491: 1  24A4  C3                              CLR             C
 1492: 1  24A5  9A                              SUBB    A,R2
 1493: 1  24A6  FF                              MOV     R7,A
 1494: 1  24A7  50 06                           JNC     $+8
 1495: 1  24A9  7D 3F                           MOV     R5,#'?'                         ;OUTPUT A QUESTION MARK
 1496: 1  24AB  B1 A5                           ACALL   SOUT1                           ;NUMBER IS TOO LARGE FOR FORMAT
 1497: 1  24AD  81 DB                           AJMP    FREE
 1498: 1  24AF  BA 00 07                        CJNE    R2,#00,USING0                   ;SEE IF ZERO
 1499: 1  24B2  1F                              DEC     R7
 1500: 1  24B3  B1 92                           ACALL   SS7
 1501: 1  24B5  B1 9F                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1502: 1  24B7  80 06                           SJMP    USING1
 1503: 1                                ;
 1504: 1  24B9  B1 92           USING0:         ACALL   SS7                             ;OUTPUT SPACES, IF NEED TO
 1505: 1  24BB  EA                              MOV     A,R2                            ;OUTPUT DIGITS
 1506: 1  24BC  FF                              MOV     R7,A
 1507: 1  24BD  B1 54                           ACALL   OUTR0
 1508: 1                                ;
 1509: 1  24BF  EB              USING1:         MOV     A,R3
 1510: 1  24C0  54 0F                           ANL     A,#0FH                          ;GET THE NUMBER RIGHT OF DP
 1511: 1  24C2  FA                              MOV     R2,A                            ;SAVE IT
 1512: 1  24C3  60 BD                           JZ      PMT1                            ;EXIT IF ZERO
 1513: 1  24C5  B1 9B                           ACALL   ROUT                            ;OUTPUT DP
 1514: 1  24C7  B1 79                           ACALL   NUM_RT
 1515: 1  24C9  B5 02 03                        CJNE    A,2,USINGX                      ;COMPARE A TO R2
 1516: 1                                ;
 1517: 1  24CC  EA              USINGY:         MOV     A,R2
 1518: 1  24CD  A1 89                           AJMP    Z7R7
 1519: 1                                ;
 1520: 1  24CF  50 FB           USINGX:         JNC     USINGY
 1521: 1                                ;
 1522: 1  24D1  CA              USING2:         XCH     A,R2
 1523: 1  24D2  C3                              CLR     C
 1524: 1  24D3  9A                              SUBB    A,R2
 1525: 1  24D4  CA                              XCH     A,R2
 1526: 1  24D5  B1 89                           ACALL   Z7R7                            ;OUTPUT ZEROS IF NEED TO
 1527: 1  24D7  EA                              MOV     A,R2
 1528: 1  24D8  FF                              MOV     R7,A
 1529: 1  24D9  A1 54                           AJMP    OUTR0
 1530: 1                                ;
 1531: 1                                ; First, force exponential output, if need to
 1532: 1                                ;
 1533: 1  24DB  EE              FREE:           MOV     A,R6                            ;GET THE EXPONENT
 1534: 1  24DC  70 04                           JNZ     FREE1                           ;IF ZERO, PRINT IT
 1535: 1  24DE  B1 A3                           ACALL   SOUT
 1536: 1  24E0  A1 9F                           AJMP    ZOUT
 1537: 1                                ;
 1538: 1  24E2  7B F0           FREE1:          MOV     R3,#0F0H                        ;IN CASE EXP NEEDED
 1539: 1  24E4  74 77                           MOV     A,#80H-DIGIT-DIGIT-1
 1540: 1  24E6  2E                              ADD     A,R6
 1541: 1  24E7  40 21                           JC      EXPOUT
 1542: 1  24E9  94 F7                           SUBB    A,#0F7H
 1543: 1  24EB  40 1D                           JC      EXPOUT
 1544: 1                                ;
 1545: 1                                ; Now, just print the number
 1546: 1                                ;
 1547: 1  24ED  B1 94                           ACALL   SINOUT                          ;PRINT THE SIGN OF THE NUMBER
 1548: 1  24EF  B1 70                           ACALL   NUM_LT                          ;GET THE NUMBER LEFT OF DP
 1549: 1  24F1  B4 08 02                        CJNE    A,#8,FREE4
 1550: 1  24F4  A1 54                           AJMP    OUTR0
 1551: 1                                ;
 1552: 1  24F6  B1 54           FREE4:          ACALL   OUTR0
 1553: 1  24F8  B1 66                           ACALL   ZTEST                           ;TEST FOR TRAILING ZEROS
 1554: 1  24FA  60 57                           JZ      U_RET                           ;DONE IF ALL TRAILING ZEROS
 1555: 1  24FC  B1 9B                           ACALL   ROUT                            ;OUTPUT RADIX
 1556: 1                                ;
 1557: 1  24FE  7F 01           FREE2:          MOV     R7,#1                           ;OUTPUT ONE DIGIT
 1558: 1  2500  B1 54                           ACALL   OUTR0
 1559: 1  2502  70 4F                           JNZ     U_RET
 1560: 1  2504  B1 66                           ACALL   ZTEST
 1561: 1  2506  60 4B                           JZ      U_RET
 1562: 1  2508  80 F4                           SJMP    FREE2                           ;LOOP
 1563: 1                                ;
 1564: 1  250A  B1 94           EXPOUT:         ACALL   SINOUT                          ;PRINT THE SIGN
 1565: 1  250C  7F 01                           MOV     R7,#1                           ;OUTPUT ONE CHARACTER
 1566: 1  250E  B1 54                           ACALL   OUTR0
 1567: 1  2510  B1 9B                           ACALL   ROUT                            ;OUTPUT RADIX
 1568: 1  2512  EB                              MOV     A,R3                            ;GET FORMAT
 1569: 1  2513  54 0F                           ANL     A,#0FH                          ;STRIP INDICATOR
 1570: 1  2515  60 06                           JZ      EXPOTX
 1571: 1                                ;
 1572: 1  2517  FF                              MOV     R7,A                            ;OUTPUT THE NUMBER OF DIGITS
 1573: 1  2518  1F                              DEC     R7                              ;ADJUST BECAUSE ONE CHAR ALREADY OUT
 1574: 1  2519  B1 54                           ACALL   OUTR0
 1575: 1  251B  80 02                           SJMP    EXPOT4
 1576: 1                                ;
 1577: 1  251D  91 FE           EXPOTX:         ACALL   FREE2                           ;OUTPUT UNTIL TRAILING ZEROS
 1578: 1                                ;
 1579: 1  251F  B1 A3           EXPOT4:         ACALL   SOUT                            ;OUTPUT A SPACE
 1580: 1  2521  7D 45                           MOV     R5,#'E'
 1581: 1  2523  B1 A5                           ACALL   SOUT1                           ;OUTPUT AN E
 1582: 1  2525  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1583: 1  2526  60 04                           JZ      XOUT0                           ;EXIT IF ZERO
 1584: 1  2528  14                              DEC     A                               ;ADJUST FOR THE DIGIT ALREADY OUTPUT
 1585: 1  2529  B4 80 05                        CJNE    A,#80H,XOUT2                    ;SEE WHAT IT IS
 1586: 1                                ;
 1587: 1  252C  B1 A3           XOUT0:          ACALL   SOUT
 1588: 1  252E  E4                              CLR     A
 1589: 1  252F  80 0C                           SJMP    XOUT4
 1590: 1                                ;
 1591: 1  2531  40 06           XOUT2:          JC      XOUT3                           ;NEGATIVE EXPONENT
 1592: 1  2533  7D 2B                           MOV     R5,#'+'                         ;OUTPUT A PLUS SIGN
 1593: 1  2535  B1 A5                           ACALL   SOUT1
 1594: 1  2537  80 04                           SJMP    XOUT4
 1595: 1                                ;
 1596: 1  2539  B1 97           XOUT3:          ACALL   MOUT
 1597: 1  253B  F4                              CPL     A                               ;FLIP BITS
 1598: 1  253C  04                              INC     A                               ;BUMP
 1599: 1                                ;
 1600: 1  253D  C2 E7           XOUT4:          CLR     ACC.7
 1601: 1  253F  F8                              MOV     R0,A
 1602: 1  2540  7A 00                           MOV     R2,#0
 1603: 1  2542  79 48                           MOV     R1,#LOW CONVT                   ;CONVERSION LOCATION
 1604: 1  2544  7B 00                           MOV     R3,#HIGH CONVT
 1605: 1  2546  D1 00                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1606: 1  2548  78 48                           MOV     R0,#LOW CONVT                   ;NOW, OUTPUT EXPONENT
 1607: 1                                ;
 1608: 1  254A  E2              EXPOT5:         MOVX    A,@R0                           ;GET THE CHARACTER
 1609: 1  254B  FD                              MOV     R5,A                            ;OUTPUT IT
 1610: 1  254C  B1 A5                           ACALL   SOUT1
 1611: 1  254E  08                              INC     R0                              ;BUMP THE POINTER
 1612: 1  254F  E8                              MOV     A,R0                            ;GET THE POINTER
 1613: 1  2550  B5 01 F7                        CJNE    A,R1B0,EXPOT5                   ;LOOP
 1614: 1                                ;
 1615: 1  2553  22              U_RET:          RET                                     ;EXIT
 1616: 1                                ;
 1617: 1  2554                  OUTR0:  ; Output the characters pointed to by R0, also bias ascii
 1618: 1                                ;
 1619: 1  2554  EF                              MOV     A,R7                            ;GET THE COUNTER
 1620: 1  2555  60 0E                           JZ      OUTR                            ;EXIT IF DONE
 1621: 1  2557  E6                              MOV     A,@R0                           ;GET THE NUMBER
 1622: 1  2558  44 30                           ORL     A,#30H                          ;ASCII BIAS
 1623: 1  255A  08                              INC     R0                              ;BUMP POINTER AND COUNTER
 1624: 1  255B  1F                              DEC     R7
 1625: 1  255C  FD                              MOV     R5,A                            ;PUT CHARACTER IN OUTPUT REGISTER
 1626: 1  255D  B1 A5                           ACALL   SOUT1                           ;OUTPUT THE CHARACTER
 1627: 1  255F  E4                              CLR     A                               ;JUST FOR TEST
 1628: 1  2560  B8 33 F1                        CJNE    R0,#FP_NIB8+1,OUTR0
 1629: 1  2563  74 55                           MOV     A,#55H                          ;KNOW WHERE EXIT OCCURED
 1630: 1                                ;
 1631: 1  2565  22              OUTR:           RET
 1632: 1                                ;
 1633: 1  2566  A9 00           ZTEST:          MOV     R1,R0B0                         ;GET POINTER REGISTER
 1634: 1                                ;
 1635: 1  2568  E7              ZT0:            MOV     A,@R1                           ;GET THE VALUE
 1636: 1  2569  70 04                           JNZ     ZT1
 1637: 1  256B  09                              INC     R1                              ;BUMP POINTER
 1638: 1  256C  B9 33 F9                        CJNE    R1,#FP_NIB8+1,ZT0
 1639: 1                                ;
 1640: 1  256F  22              ZT1:            RET
 1641: 1                                ;
 1642: 1  2570  EE              NUM_LT:         MOV     A,R6                            ;GET EXPONENT
 1643: 1  2571  C3                              CLR     C                               ;GET READY FOR SUBB
 1644: 1  2572  94 80                           SUBB    A,#80H                          ;SUB EXPONENT BIAS
 1645: 1  2574  50 01                           JNC     NL1                             ;OK IF NO CARRY
 1646: 1  2576  E4                              CLR     A                               ;NO DIGITS LEFT
 1647: 1                                ;
 1648: 1  2577  FF              NL1:            MOV     R7,A                            ;SAVE THE COUNT
 1649: 1  2578  22                              RET
 1650: 1                                ;
 1651: 1  2579  C3              NUM_RT:         CLR     C                               ;SUBB AGAIN
 1652: 1  257A  74 80                           MOV     A,#80H                          ;EXPONENT BIAS
 1653: 1  257C  9E                              SUBB    A,R6                            ;GET THE BIASED EXPONENT
 1654: 1  257D  50 01                           JNC     NR1
 1655: 1  257F  E4                              CLR     A
 1656: 1                                ;
 1657: 1  2580  22              NR1:            RET                                     ;EXIT
 1658: 1                                ;
 1659: 1  2581  EF              SPACE7:         MOV     A,R7                            ;GET THE NUMBER OF SPACES
 1660: 1  2582  60 FC                           JZ      NR1                             ;EXIT IF ZERO
 1661: 1  2584  B1 A3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1662: 1  2586  1F                              DEC     R7                              ;BUMP COUNTER
 1663: 1  2587  80 F8                           SJMP    SPACE7                          ;LOOP
 1664: 1                                ;
 1665: 1  2589  FF              Z7R7:           MOV     R7,A
 1666: 1                                ;
 1667: 1  258A  EF              ZERO7:          MOV     A,R7                            ;GET COUNTER
 1668: 1  258B  60 F3                           JZ      NR1                             ;EXIT IF ZERO
 1669: 1  258D  B1 9F                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1670: 1  258F  1F                              DEC     R7                              ;BUMP COUNTER
 1671: 1  2590  80 F8                           SJMP    ZERO7                           ;LOOP
 1672: 1                                ;
 1673: 1  2592  B1 81           SS7:            ACALL   SPACE7
 1674: 1                                ;
 1675: 1  2594  EC              SINOUT:         MOV     A,R4                            ;GET THE SIGN
 1676: 1  2595  60 0C                           JZ      SOUT                            ;OUTPUT A SPACE IF ZERO
 1677: 1                                ;
 1678: 1  2597  7D 2D           MOUT:           MOV     R5,#'-'
 1679: 1  2599  80 0A                           SJMP    SOUT1                           ;OUTPUT A MINUS IF NOT
 1680: 1                                ;
 1681: 1  259B  7D 2E           ROUT:           MOV     R5,#'.'                         ;OUTPUT A RADIX
 1682: 1  259D  80 06                           SJMP    SOUT1
 1683: 1                                ;
 1684: 1  259F  7D 30           ZOUT:           MOV     R5,#'0'                         ;OUTPUT A ZERO
 1685: 1  25A1  80 02                           SJMP    SOUT1
 1686: 1                                ;
 1687: 1  25A3  7D 20           SOUT:           MOV     R5,#' '                         ;OUTPUT A SPACE
 1688: 1                                ;
 1689: 1  25A5  C1 81           SOUT1:          AJMP    R5OUT
 1690: 1                                ;
 1691: 1                                ;***************************************************************
 1692: 1                                ;
 1693: 1  25A7                  CONVERT_ASCII_STRING_TO_BINARY:
 1694: 1                                ;
 1695: 1                                ;DPTR POINTS TO ASCII STRING
 1696: 1                                ;PUT THE BINARY NUMBER IN R2:R0, ERROR IF >64K
 1697: 1                                ;
 1698: 1                                ;***************************************************************
 1699: 1                                ;
 1700: 1  25A7  71 92           CASB:           ACALL   HEXSCAN                         ;SEE IF HEX NUMBER
 1701: 1  25A9  92 33                           MOV     ADD_IN,C                        ;IF ADD_IN IS SET, THE NUMBER IS HEX
 1702: 1  25AB  D1 74                           ACALL   GET_DIGIT_CHECK
 1703: 1  25AD  B3                              CPL     C                               ;FLIP FOR EXIT
 1704: 1  25AE  40 28                           JC      RCASB
 1705: 1  25B0  7B 00                           MOV     R3,#00H                         ;ZERO R3:R1 FOR LOOP
 1706: 1  25B2  79 00                           MOV     R1,#00H
 1707: 1  25B4  80 15                           SJMP    CASB5
 1708: 1                                ;
 1709: 1  25B6  A3              CASB2:          INC     DPTR
 1710: 1  25B7  89 00                           MOV     R0B0,R1                         ;SAVE THE PRESENT CONVERTED VALUE
 1711: 1  25B9  8B 02                           MOV     R0B0+2,R3                       ;IN R2:R0
 1712: 1  25BB  D1 74                           ACALL   GET_DIGIT_CHECK
 1713: 1  25BD  40 0C                           JC      CASB5
 1714: 1  25BF  30 33 16                        JNB     ADD_IN,RCASB                    ;CONVERSION COMPLETE
 1715: 1  25C2  71 B2                           ACALL   HEX_CHECK                       ;SEE IF HEX NUMBER
 1716: 1  25C4  40 03                           JC      CASB4                           ;PROCEED IF GOOD
 1717: 1  25C6  A3                              INC     DPTR                            ;BUMP PAST H
 1718: 1  25C7  80 0F                           SJMP    RCASB
 1719: 1                                ;
 1720: 1  25C9  24 09           CASB4:          ADD     A,#9                            ;ADJUST HEX ASCII BIAS
 1721: 1                                ;
 1722: 1  25CB  75 F0 0A        CASB5:          MOV     B,#10
 1723: 1  25CE  30 33 03                        JNB     ADD_IN,CASB6
 1724: 1  25D1  75 F0 10                        MOV     B,#16                           ;HEX MODE
 1725: 1                                ;
 1726: 1  25D4  B1 DF           CASB6:          ACALL   MULNUM                          ;ACCUMULATE THE DIGITS
 1727: 1  25D6  50 DE                           JNC     CASB2                           ;LOOP IF NO CARRY
 1728: 1                                ;
 1729: 1  25D8  E4              RCASB:          CLR     A                               ;RESET ACC
 1730: 1  25D9  92 E1                           MOV     ACC.OVERFLOW,C                  ;IF OVERFLOW, SAY SO
 1731: 1  25DB  22                              RET                                     ;EXIT
 1732: 1                                ;
 1733: 1                                ;
 1734: 1  25DC  75 F0 0A        MULNUM10:       MOV     B,#10
 1735: 1                                ;
 1736: 1                                ;***************************************************************
 1737: 1                                ;
 1738: 1  25DF                  MULNUM: ; Take the next digit in the acc (masked to 0FH)
 1739: 1                                ; accumulate in R3:R1
 1740: 1                                ;
 1741: 1                                ;***************************************************************
 1742: 1                                ;
 1743: 1  25DF  C0 E0                           PUSH    ACC                             ;SAVE ACC
 1744: 1  25E1  C0 F0                           PUSH    B                               ;SAVE MULTIPLIER
 1745: 1  25E3  E9                              MOV     A,R1                            ;PUT LOW ORDER BITS IN ACC
 1746: 1  25E4  A4                              MUL     AB                              ;DO THE MULTIPLY
 1747: 1  25E5  F9                              MOV     R1,A                            ;PUT THE RESULT BACK
 1748: 1  25E6  EB                              MOV     A,R3                            ;GET THE HIGH ORDER BYTE
 1749: 1  25E7  AB F0                           MOV     R3,B                            ;SAVE THE OVERFLOW
 1750: 1  25E9  D0 F0                           POP     B                               ;GET THE MULTIPLIER
 1751: 1  25EB  A4                              MUL     AB                              ;DO IT
 1752: 1  25EC  A2 D2                           MOV     C,OV                            ;SAVE OVERFLOW IN F0
 1753: 1  25EE  92 D5                           MOV     F0,C
 1754: 1  25F0  2B                              ADD     A,R3                            ;ADD OVERFLOW TO HIGH RESULT
 1755: 1  25F1  FB                              MOV     R3,A                            ;PUT IT BACK
 1756: 1  25F2  D0 E0                           POP     ACC                             ;GET THE ORIGINAL ACC BACK
 1757: 1  25F4  72 D5                           ORL     C,F0                            ;OR CARRY AND OVERFLOW
 1758: 1  25F6  40 07                           JC      MULX                            ;NO GOOD IF THE CARRY IS SET
 1759: 1                                ;
 1760: 1  25F8  54 0F           MUL11:          ANL     A,#0FH                          ;MASK OFF HIGH ORDER BITS
 1761: 1  25FA  29                              ADD     A,R1                            ;NOW ADD THE ACC
 1762: 1  25FB  F9                              MOV     R1,A                            ;PUT IT BACK
 1763: 1  25FC  E4                              CLR     A                               ;PROPAGATE THE CARRY
 1764: 1  25FD  3B                              ADDC    A,R3
 1765: 1  25FE  FB                              MOV     R3,A                            ;PUT IT BACK
 1766: 1                                ;
 1767: 1  25FF  22              MULX:           RET                                     ;EXIT WITH OR WITHOUT CARRY
 1768: 1                                ;
 1769: 1                                ;***************************************************************
 1770: 1                                ;
 1771: 1  2600                  CONVERT_BINARY_TO_ASCII_STRING:
 1772: 1                                ;
 1773: 1                                ;R3:R1 contains the address of the string
 1774: 1                                ;R2:R0 contains the value to convert
 1775: 1                                ;DPTR, R7, R6, and ACC gets clobbered
 1776: 1                                ;
 1777: 1                                ;***************************************************************
 1778: 1                                ;
 1779: 1  2600  E4                              CLR     A                               ;NO LEADING ZEROS
 1780: 1  2601  90 27 10                        MOV     DPTR,#10000                     ;SUBTRACT 10000
 1781: 1  2604  D1 1D                           ACALL   RSUB                            ;DO THE SUBTRACTION
 1782: 1  2606  90 03 E8                        MOV     DPTR,#1000                      ;NOW 1000
 1783: 1  2609  D1 1D                           ACALL   RSUB
 1784: 1  260B  90 00 64                        MOV     DPTR,#100                       ;NOW 100
 1785: 1  260E  D1 1D                           ACALL   RSUB
 1786: 1  2610  90 00 0A                        MOV     DPTR,#10                        ;NOW 10
 1787: 1  2613  D1 1D                           ACALL   RSUB
 1788: 1  2615  90 00 01                        MOV     DPTR,#1                         ;NOW 1
 1789: 1  2618  D1 1D                           ACALL   RSUB
 1790: 1  261A  60 20                           JZ      RSUB2                           ;JUMP OVER RET
 1791: 1                                ;
 1792: 1  261C  22              RSUB_R:         RET
 1793: 1                                ;
 1794: 1  261D  7E FF           RSUB:           MOV     R6,#-1                          ;SET UP THE COUNTER
 1795: 1                                ;
 1796: 1  261F  0E              RSUB1:          INC     R6                              ;BUMP THE COUNTER
 1797: 1  2620  CA                              XCH     A,R2                            ;DO A FAST COMPARE
 1798: 1  2621  B5 83 00                        CJNE    A,DPH,$+3
 1799: 1  2624  CA                              XCH     A,R2
 1800: 1  2625  40 12                           JC      FAST_DONE
 1801: 1  2627  C8                              XCH     A,R0                            ;GET LOW BYTE
 1802: 1  2628  95 82                           SUBB    A,DPL                           ;SUBTRACT, CARRY IS CLEARED
 1803: 1  262A  C8                              XCH     A,R0                            ;PUT IT BACK
 1804: 1  262B  CA                              XCH     A,R2                            ;GET THE HIGH BYTE
 1805: 1  262C  95 83                           SUBB    A,DPH                           ;ADD THE HIGH BYTE
 1806: 1  262E  CA                              XCH     A,R2                            ;PUT IT BACK
 1807: 1  262F  50 EE                           JNC     RSUB1                           ;LOOP UNTIL CARRY
 1808: 1                                ;
 1809: 1  2631  C8                              XCH     A,R0
 1810: 1  2632  25 82                           ADD     A,DPL                           ;RESTORE R2:R0
 1811: 1  2634  C8                              XCH     A,R0
 1812: 1  2635  CA                              XCH     A,R2
 1813: 1  2636  35 83                           ADDC    A,DPH
 1814: 1  2638  CA                              XCH     A,R2
 1815: 1                                ;
 1816: 1  2639                  FAST_DONE:
 1817: 1                                ;
 1818: 1  2639  4E                              ORL     A,R6                            ;OR THE COUNT VALUE
 1819: 1  263A  60 E0                           JZ      RSUB_R                          ;RETURN IF ZERO
 1820: 1                                ;
 1821: 1  263C  74 30           RSUB2:          MOV     A,#'0'                          ;GET THE ASCII BIAS
 1822: 1  263E  2E                              ADD     A,R6                            ;ADD THE COUNT
 1823: 1                                ;
 1824: 1  263F  8B A0           RSUB4:          MOV     P2,R3                           ;SET UP P2
 1825: 1  2641  F3                              MOVX    @R1,A                           ;PLACE THE VALUE IN MEMORY
 1826: 1  2642  09                              INC     R1
 1827: 1  2643  B9 00 01                        CJNE    R1,#00H,RSUB3                   ;SEE IF RAPPED AROUND
 1828: 1  2646  0B                              INC     R3                              ;BUMP HIGH BYTE
 1829: 1                                ;
 1830: 1  2647  22              RSUB3:          RET                                     ;EXIT
 1831: 1                                ;
 1832: 1                                ;***************************************************************
 1833: 1                                ;
 1834: 1  2648                  FPHEXOUT:       ; Output the hex number in R3:R1, supress leading zeros, if set
 1835: 1                                ;
 1836: 1                                ;***************************************************************
 1837: 1                                ;
 1838: 1  2648  B1 A3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1839: 1  264A  A2 36                           MOV     C,ZSURP                         ;GET ZERO SUPPRESSION BIT
 1840: 1  264C  92 33                           MOV     ADD_IN,C
 1841: 1  264E  EB                              MOV     A,R3                            ;GET HIGH NIBBLE AND PRINT IT
 1842: 1  264F  D1 6B                           ACALL   HOUTHI
 1843: 1  2651  EB                              MOV     A,R3
 1844: 1  2652  D1 6C                           ACALL   HOUTLO
 1845: 1                                ;
 1846: 1  2654  C2 33           HEX2X:          CLR     ADD_IN                          ;DON'T SUPPRESS ZEROS
 1847: 1  2656  E9                              MOV     A,R1                            ;GET LOW NIBBLE AND PRINT IT
 1848: 1  2657  D1 6B                           ACALL   HOUTHI
 1849: 1  2659  E9                              MOV     A,R1
 1850: 1  265A  D1 6C                           ACALL   HOUTLO
 1851: 1  265C  7D 48                           MOV     R5,#'H'                         ;OUTPUT H TO INDICATE HEX MODE
 1852: 1                                ;
 1853: 1  265E  A1 A5           SOUT_1:         AJMP    SOUT1
 1854: 1                                ;
 1855: 1  2660  C2 33           HOUT1:          CLR     ADD_IN                          ;PRINTED SOMETHING, SO CLEAR ADD_IN
 1856: 1  2662  24 90                           ADD     A,#90H                          ;CONVERT TO ASCII
 1857: 1  2664  D4                              DA      A
 1858: 1  2665  34 40                           ADDC    A,#40H
 1859: 1  2667  D4                              DA      A                               ;GOT IT HERE
 1860: 1  2668  FD                              MOV     R5,A                            ;OUTPUT THE BYTE
 1861: 1  2669  80 F3                           SJMP    SOUT_1
 1862: 1                                ;
 1863: 1  266B  C4              HOUTHI:         SWAP    A                               ;SWAP TO OUTPUT HIGH NIBBLE
 1864: 1                                ;
 1865: 1  266C  54 0F           HOUTLO:         ANL     A,#0FH                          ;STRIP
 1866: 1  266E  70 F0                           JNZ     HOUT1                           ;PRINT IF NOT ZERO
 1867: 1  2670  30 33 ED                        JNB     ADD_IN,HOUT1                    ;OUTPUT A ZERO IF NOT SUPRESSED
 1868: 1  2673  22                              RET
 1869: 1                                ;
 1870: 1                                ;
 1871: 1  2674                  GET_DIGIT_CHECK:        ; Get a character, then check for digit
 1872: 1                                ;
 1873: 1  2674  91 68                           ACALL   GET_DPTR_CHARACTER
 1874: 1                                ;
 1875: 1  2676                  DIGIT_CHECK:    ;CHECK FOR A VALID ASCII DIGIT, SET CARRY IF FOUND
 1876: 1                                ;
 1877: 1  2676  B4 3A 00                        CJNE    A,#'9'+1,$+3                    ;SEE IF ASCII 9 OR LESS
 1878: 1  2679  40 01                           JC      DC1
 1879: 1  267B  22                              RET
 1880: 1                                ;
 1881: 1  267C  B4 30 00        DC1:            CJNE    A,#'0',$+3                      ;SEE IF ASCII 0 OR GREATER
 1882: 1  267F  B3                              CPL     C
 1883: 1  2680  22                              RET
 1884: 1                                ;
 1885: 1
 1886: 1  2681  C0 E0           R5OUT:          PUSH    ACC                             ; ME
 1887: 1  2683  C0 00                           PUSH    00H
 1888: 1  2685  A8 50                           MOV     R0,FPCHR_OUT
 1889: 1  2687  ED                              MOV     A,R5                            ; ME
 1890: 1  2688  F6                              MOV     @R0,A
 1891: 1  2689  05 50                           INC     FPCHR_OUT
 1892: 1  268B  D0 00                           POP     00H
 1893: 1  268D  D0 E0                           POP     ACC                             ; ME
 1894: 1  268F  22                              RET                                     ; ME
 1895: 1
 1896: 1  2690  01 A7           SQ_ERR:         JMP     BADPRM                          ; me
 1897: 1
 1898: 1                                ;***************************************************************
 1899: 1                                ;
 1900: 1  2692                  IFIX:   ; Convert a floating point number to an integer, put in R3:R1
 1901: 1                                ;
 1902: 1                                ;***************************************************************
 1903: 1                                ;
 1904: 1  2692  E4                              CLR     A                               ;RESET THE START
 1905: 1  2693  FB                              MOV     R3,A
 1906: 1  2694  F9                              MOV     R1,A
 1907: 1  2695  A8 24                           MOV     R0,ARG_STACK                    ;GET THE ARG STACK
 1908: 1  2697  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1909: 1  269A  E2                              MOVX    A,@R0                           ;READ EXPONENT
 1910: 1  269B  C3                              CLR     C
 1911: 1  269C  94 81                           SUBB    A,#81H                          ;BASE EXPONENT
 1912: 1  269E  FC                              MOV     R4,A                            ;SAVE IT
 1913: 1  269F  18                              DEC     R0                              ;POINT AT SIGN
 1914: 1  26A0  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1915: 1  26A1  70 ED                           JNZ     SQ_ERR                          ;ERROR IF NEGATIVE
 1916: 1  26A3  40 17                           JC      INC_ASTKA                       ;EXIT IF EXPONENT IS < 81H
 1917: 1  26A5  0C                              INC     R4                              ;ADJUST LOOP COUNTER
 1918: 1  26A6  E8                              MOV     A,R0                            ;BUMP THE POINTER REGISTER
 1919: 1  26A7  94 05                           SUBB    A,#FP_NUMBER_SIZE-1
 1920: 1  26A9  F8                              MOV     R0,A
 1921: 1                                ;
 1922: 1  26AA  08              I2:             INC     R0                              ;POINT AT DIGIT
 1923: 1  26AB  E2                              MOVX    A,@R0                           ;GET DIGIT
 1924: 1  26AC  C4                              SWAP    A                               ;FLIP
 1925: 1  26AD  11 94                           CALL    FP_BASE+20                      ;ACCUMULATE
 1926: 1  26AF  40 DF                           JC      SQ_ERR
 1927: 1  26B1  DC 02                           DJNZ    R4,$+4
 1928: 1  26B3  80 07                           SJMP    INC_ASTKA
 1929: 1  26B5  E2                              MOVX    A,@R0                           ;GET DIGIT
 1930: 1  26B6  11 94                           CALL    FP_BASE+20
 1931: 1  26B8  40 D6                           JC      SQ_ERR
 1932: 1  26BA  DC EE                           DJNZ    R4,I2
 1933: 1                        ;
 1934: 1                        ; Pop the ARG STACK and check for overflow
 1935: 1  26BC                  INC_ASTKA:
 1936: 1  26BC  74 06                           MOV     A,#FP_NUMBER_SIZE               ;number to pop
 1937: 1  26BE  80 18                           SJMP    SETREG+1
 1938: 1                        ;
 1939: 1                        ;Push ARG STACK and check for underflow
 1940: 1  26C0                  DEC_ASTKA:
 1941: 1  26C0  74 FA                           MOV     A,#-FP_NUMBER_SIZE
 1942: 1  26C2  25 24                           ADD     A,ARG_STACK
 1943: 1  26C4  B4 00 00                        CJNE    A,#0,$+3
 1944: 1  26C7  40 45                           JC      E4YY
 1945: 1  26C9  F5 24                           MOV     ARG_STACK,A
 1946: 1  26CB  F9                              MOV     R1,A
 1947: 1  26CC  7B 01                           MOV     R3,#ARG_STACK_PAGE
 1948: 1  26CE  22              SRT:            RET
 1949: 1                        ;
 1950: 1  26CF  D1 BC           POPAS:          ACALL   INC_ASTKA
 1951: 1  26D1  E1 01                           AJMP    VARCOP                          ;COPY THE VARIABLE
 1952: 1                        ;
 1953: 1  26D3  D1 C0           PUSHAS:         ACALL   DEC_ASTKA
 1954: 1  26D5  E1 01                           AJMP    VARCOP
 1955: 1                        ;
 1956: 1  26D7  E4              SETREG:         CLR     A                               ;DON'T POP ANYTHING
 1957: 1  26D8  A8 24                           MOV     R0,ARG_STACK
 1958: 1  26DA  7A 01                           MOV     R2,#ARG_STACK_PAGE
 1959: 1  26DC  8A A0                           MOV     P2,R2
 1960: 1  26DE  28                              ADD     A,R0
 1961: 1  26DF  40 2D                           JC      E4YY
 1962: 1  26E1  F5 24                           MOV     ARG_STACK,A
 1963: 1  26E3  E2                              MOVX    A,@R0
 1964: 1  26E4  22              A_D:            RET
 1965: 1                                ;
 1966: 1  26E5  18              DEC3210:        DEC     R0                              ;BUMP THE POINTER
 1967: 1  26E6  B8 FF 01                        CJNE    R0,#0FFH,$+4                    ;SEE IF OVERFLOWED
 1968: 1  26E9  1A                              DEC     R2                              ;BUMP THE HIGH BYTE
 1969: 1  26EA  19                              DEC     R1                              ;BUMP THE POINTER
 1970: 1  26EB  B9 FF 01                        CJNE    R1,#0FFH,DEC_R                  ;SEE IF OVERFLOWED
 1971: 1  26EE  1B                              DEC     R3                              ;CHANGE THE HIGH BYTE
 1972: 1  26EF  22              DEC_R:          RET                                     ;EXIT
 1973: 1                        ;
 1974: 1
 1975: 1
 1976: 1                        ;Routine to copy bottom arg on stack to address in DPTR.
 1977: 1                        ;Does not work over page boundaries.
 1978: 1                        ;Bugs fixed by JKJ/IRC
 1979: 1  26F0  D1 D7           MOVAS:          ACALL   SETREG                          ;SET UP R2:R0
 1980: 1  26F2  AB 83                           MOV     R3,DPH
 1981: 1  26F4  A9 82                           MOV     R1,DPL
 1982: 1  26F6  8A A0           M_C:            MOV     P2,R2                           ;SET UP THE PORTS
 1983: 1  26F8  E2                              MOVX    A,@R0                           ;READ THE VALUE
 1984: 1  26F9  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 1985: 1  26FB  F3                              MOVX    @R1,A                           ;SAVE IT
 1986: 1  26FC  08                              INC     R0
 1987: 1  26FD  09                              INC     R1
 1988: 1  26FE  DC F6                           DJNZ    R4,M_C                          ;LOOP
 1989: 1  2700  22                              RET                                     ;EXIT
 1990: 1
 1991: 1
 1992: 1                        ; VARCOP - Copy a variable from R2:R0 to R3:R1
 1993: 1  2701  7C 06           VARCOP:         MOV     R4,#FP_NUMBER_SIZE              ;LOAD THE LOOP COUNTER
 1994: 1  2703  8A A0           V_C:            MOV     P2,R2                           ;SET UP THE PORTS
 1995: 1  2705  E2                              MOVX    A,@R0                           ;READ THE VALUE
 1996: 1  2706  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 1997: 1  2708  F3                              MOVX    @R1,A                           ;SAVE IT
 1998: 1  2709  D1 E5                           ACALL   DEC3210
 1999: 1  270B  DC F6                           DJNZ    R4,V_C                          ;LOOP
 2000: 1  270D  22                              RET                                     ;EXIT
 2001: 1                        ;
 2002: 1  270E  90 27 49        E4YY:           MOV     DPTR,#EXA
 2003: 1  2711  01 A6                           JMP     PRTERR                          ; me
 2004: 1
 2005: 1                                ; integer operator - INT
 2006: 1  2713  D1 D7           AINT:           ACALL   SETREG                          ;SET UP THE REGISTERS, CLEAR CARRY
 2007: 1  2715  94 81                           SUBB    A,#129                          ;SUBTRACT EXPONENT BIAS
 2008: 1  2717  50 0D                           JNC     AI1                             ;JUMP IF ACC > 81H
 2009: 1                                ;
 2010: 1                                ; Force the number to be a zero
 2011: 1                                ;
 2012: 1  2719  D1 BC                           ACALL   INC_ASTKA                       ;BUMP THE STACK
 2013: 1                                ;
 2014: 1  271B  90 27 20        P_Z:            MOV     DPTR,#ZRO                       ;PUT ZERO ON THE STACK
 2015: 1  271E  E1 3B                           AJMP    PUSHC
 2016: 1  2720  00 00 00 00     ZRO:            DB      0,0,0,0,0,0
       1  2724  00 00
 2017: 1                                ;
 2018: 1  2726  94 07           AI1:            SUBB    A,#7
 2019: 1  2728  50 10                           JNC     AI3
 2020: 1  272A  F4                              CPL     A
 2021: 1  272B  04                              INC     A
 2022: 1  272C  FB                              MOV     R3,A
 2023: 1  272D  18                              DEC     R0                              ;POINT AT SIGN
 2024: 1                                ;
 2025: 1  272E  18              AI2:            DEC     R0                              ;NOW AT LSB'S
 2026: 1  272F  E2                              MOVX    A,@R0                           ;READ BYTE
 2027: 1  2730  54 F0                           ANL     A,#0F0H                         ;STRIP NIBBLE
 2028: 1  2732  F2                              MOVX    @R0,A                           ;WRITE BYTE
 2029: 1  2733  DB 01                           DJNZ    R3,$+3
 2030: 1  2735  22                              RET
 2031: 1  2736  E4                              CLR     A
 2032: 1  2737  F2                              MOVX    @R0,A                           ;CLEAR THE LOCATION
 2033: 1  2738  DB F4                           DJNZ    R3,AI2
 2034: 1  273A  22              AI3:            RET                                     ;EXIT
 2035: 1                                ;
 2036: 1                                ; PUSHC - Push constant pointed by DPTR on to the arg stack
 2037: 1  273B  D1 C0           PUSHC:          ACALL   DEC_ASTKA
 2038: 1  273D  8B A0                           MOV     P2,R3
 2039: 1  273F  7B 06                           MOV     R3,#FP_NUMBER_SIZE              ;LOOP COUNTER
 2040: 1  2741  E4              PCL:            CLR     A                               ;SET UP A
 2041: 1  2742  93                              MOVC    A,@A+DPTR                       ;LOAD IT
 2042: 1  2743  F3                              MOVX    @R1,A                           ;SAVE IT
 2043: 1  2744  A3                              INC     DPTR                            ;BUMP POINTERS
 2044: 1  2745  19                              DEC     R1
 2045: 1  2746  DB F9                           DJNZ    R3,PCL                          ;LOOP
 2046: 1  2748  22                              RET                                     ;EXIT
 2047: 1                        ;
 2048: 1  2749  41 2D 53 54     EXA:            DB      'A-STACK',0
       1  274D  41 43 4B 00
 2049: 1
 2050:
 2051:                          ;------------------------------------------------------------------
 2052:
 2053:                          ;Binary to decimal converter
 2054:                          ;Converts R7:R6:R5:R4 to decimal pointed to by R0
 2055:                          ;Returns with number of digits in A
 2056:                          ;------------------------------------------------------------------
 2057:    2751  C0 00           BIN2DEC:        PUSH    00h
 2058:    2753  90 27 A7                        MOV     DPTR,#BINDEC
 2059:    2756  7A 0A                           MOV     R2,#0Ah
 2060:    2758  7B 2F           BIN2DEC1:       MOV     R3,#2Fh
 2061:    275A  0B              BIN2DEC2:       INC     R3
 2062:    275B  F1 7A                           ACALL   SUBIT
 2063:    275D  50 FB                           JNC     BIN2DEC2
 2064:    275F  F1 93                           ACALL   ADDIT
 2065:    2761  EB                              MOV     A,R3
 2066:    2762  F6                              MOV     @R0,A
 2067:    2763  08                              INC     R0
 2068:    2764  A3                              INC     DPTR
 2069:    2765  A3                              INC     DPTR
 2070:    2766  A3                              INC     DPTR
 2071:    2767  A3                              INC     DPTR
 2072:    2768  DA EE                           DJNZ    R2,BIN2DEC1
 2073:    276A  D0 00                           POP     00h
 2074:                                          ;Remove leading zeroes
 2075:    276C  7A 09                           MOV     R2,#09h
 2076:    276E  E6              BIN2DEC3:       MOV     A,@R0
 2077:    276F  B4 30 05                        CJNE    A,#30h,BIN2DEC4
 2078:    2772  76 20                           MOV     @R0,#20h
 2079:    2774  08                              INC     R0
 2080:    2775  DA F7                           DJNZ    R2,BIN2DEC3
 2081:    2777  0A              BIN2DEC4:       INC     R2
 2082:    2778  EA                              MOV     A,R2
 2083:    2779  22                              RET
 2084:
 2085:    277A  E4              SUBIT:          CLR     A
 2086:    277B  93                              MOVC    A,@A+DPTR
 2087:    277C  CC                              XCH     A,R4
 2088:    277D  C3                              CLR     C
 2089:    277E  9C                              SUBB    A,R4
 2090:    277F  FC                              MOV     R4,A
 2091:    2780  74 01                           MOV     A,#01h
 2092:    2782  93                              MOVC    A,@A+DPTR
 2093:    2783  CD                              XCH     A,R5
 2094:    2784  9D                              SUBB    A,R5
 2095:    2785  FD                              MOV     R5,A
 2096:    2786  74 02                           MOV     A,#02h
 2097:    2788  93                              MOVC    A,@A+DPTR
 2098:    2789  CE                              XCH     A,R6
 2099:    278A  9E                              SUBB    A,R6
 2100:    278B  FE                              MOV     R6,A
 2101:    278C  74 03                           MOV     A,#03h
 2102:    278E  93                              MOVC    A,@A+DPTR
 2103:    278F  CF                              XCH     A,R7
 2104:    2790  9F                              SUBB    A,R7
 2105:    2791  FF                              MOV     R7,A
 2106:    2792  22                              RET
 2107:
 2108:    2793  E4              ADDIT:          CLR     A
 2109:    2794  93                              MOVC    A,@A+DPTR
 2110:    2795  2C                              ADD     A,R4
 2111:    2796  FC                              MOV     R4,A
 2112:    2797  74 01                           MOV     A,#01h
 2113:    2799  93                              MOVC    A,@A+DPTR
 2114:    279A  3D                              ADDC    A,R5
 2115:    279B  FD                              MOV     R5,A
 2116:    279C  74 02                           MOV     A,#02h
 2117:    279E  93                              MOVC    A,@A+DPTR
 2118:    279F  3E                              ADDC    A,R6
 2119:    27A0  FE                              MOV     R6,A
 2120:    27A1  74 03                           MOV     A,#03h
 2121:    27A3  93                              MOVC    A,@A+DPTR
 2122:    27A4  3F                              ADDC    A,R7
 2123:    27A5  FF                              MOV     R7,A
 2124:    27A6  22                              RET
 2125:
 2126:    27A7  00 CA 9A 3B     BINDEC:         DB 000h,0CAh,09Ah,03Bh                  ;1000000000
 2127:    27AB  00 E1 F5 05                     DB 000h,0E1h,0F5h,005h                  ; 100000000
 2128:    27AF  80 96 98 00                     DB 080h,096h,098h,000h                  ;  10000000
 2129:    27B3  40 42 0F 00                     DB 040h,042h,0Fh,0000h                  ;   1000000
 2130:    27B7  A0 86 01 00                     DB 0A0h,086h,001h,000h                  ;    100000
 2131:    27BB  10 27 00 00                     DB 010h,027h,000h,000h                  ;     10000
 2132:    27BF  E8 03 00 00                     DB 0E8h,003h,000h,000h                  ;      1000
 2133:    27C3  64 00 00 00                     DB 064h,000h,000h,000h                  ;       100
 2134:    27C7  0A 00 00 00                     DB 00Ah,000h,000h,000h                  ;        10
 2135:    27CB  01 00 00 00                     DB 001h,000h,000h,000h                  ;         1
 2136:
 2137:                          ;------------------------------------------------------------------
 2138:
 2139:                          ;Get LC meter frquency
 2140:                          ;IN:    A Port #8000h value, R3:R1 points to FP buffer
 2141:                          ;OUT:   Nothing
 2142:    27CF  C0 03           LCMETERGETFRQ:  PUSH    03h                             ;Save R3
 2143:    27D1  C0 01                           PUSH    01h                             ;Save R1
 2144:    27D3  90 80 00                        MOV     DPTR,#8000h
 2145:    27D6  F0                              MOVX    @DPTR,A                         ;D7, D6
 2146:    27D7  74 FA                           MOV     A,#250
 2147:    27D9  12 3C 28                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2148:    27DC  74 FA                           MOV     A,#250
 2149:    27DE  12 3C 28                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2150:    27E1  74 02                           MOV     A,#02h                          ;CH2, LC Meter
 2151:    27E3  12 2A 05                        LCALL   FRQCOUNT
 2152:    27E6  78 40                           MOV     R0,#LCDLINE
 2153:    27E8  12 27 51                        LCALL   BIN2DEC
 2154:    27EB  78 40                           MOV     R0,#LCDLINE
 2155:    27ED  90 00 48                        MOV     DPTR,#CONVT
 2156:    27F0  7F 0A                           MOV     R7,#0Ah
 2157:    27F2  E6              LCMETERGETFRQ1: MOV     A,@R0
 2158:    27F3  F0                              MOVX    @DPTR,A
 2159:    27F4  08                              INC     R0
 2160:    27F5  A3                              INC     DPTR
 2161:    27F6  DF FA                           DJNZ    R7,LCMETERGETFRQ1
 2162:    27F8  74 0D                           MOV     A,#0Dh
 2163:    27FA  F0                              MOVX    @DPTR,A
 2164:    27FB  90 00 48                        MOV     DPTR,#CONVT
 2165:    27FE  12 23 CB                        LCALL   FLOATING_POINT_INPUT
 2166:    2801  D0 01                           POP     01h                             ;Restore R1
 2167:    2803  D0 03                           POP     03H                             ;Restore R3
 2168:    2805  12 26 CF                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2169:    2808  22                              RET
 2170:
 2171:                          ;Calculate X=((Fa/Fb)^2)-1
 2172:                          ;IN:    Fa=R2:R0, Fb=R3:R1
 2173:                          ;OUT:   Nothing
 2174:    2809  C0 01           LCCALC:         PUSH    01h
 2175:    280B  C0 03                           PUSH    03h
 2176:    280D  12 26 D3                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2177:    2810  D0 02                           POP     02h
 2178:    2812  D0 00                           POP     00h
 2179:    2814  12 26 D3                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2180:    2817  12 21 CB                        LCALL   FLOATING_DIV
 2181:    281A  A8 24                           MOV     R0,ARG_STACK
 2182:    281C  7A 01                           MOV     R2,#ARG_STACK_PAGE
 2183:    281E  12 26 D3                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2184:    2821  12 21 96                        LCALL   FLOATING_MUL
 2185:    2824  90 2C BD                        MOV     DPTR,#FPONE
 2186:    2827  12 27 3B                        LCALL   PUSHC                           ; PUSH ARG IN DPTR TO STACK
 2187:    282A  12 20 A8                        LCALL   FLOATING_SUB
 2188:    282D  22                              RET
 2189:
 2190:                          ;Get LC meter frquency F1 and F2. Calculatr LCCA=((F1/F2)^2)-1 and LCCB=LCCA*((1/(2*Pi*F1))^2)*(1/Ccal)
 2191:                          ;IN:    Nothing
 2192:                          ;OUT:   Nothing
 2193:    282E  74 00           LCMETERINIT:    MOV     A,#00h                          ;D6 LC Meter    0=C, 1=L
 2194:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2195:    2830  90 80 00                        MOV     DPTR,#8000h
 2196:    2833  F0                              MOVX    @DPTR,A                         ;D7, D6
 2197:    2834  12 31 11                        LCALL   PRNTCSTR
 2198:    2837  0D 43 61 6C                     DB      0Dh,'Calibrating ',0
          283B  69 62 72 61
          283F  74 69 6E 67
          2843  20 00
 2199:    2845  12 29 F8                        LCALL   WAITASEC
 2200:    2848  74 2E                           MOV     A,#'.'
 2201:    284A  12 32 66                        LCALL   TXBYTE
 2202:    284D  12 29 F8                        LCALL   WAITASEC
 2203:    2850  74 2E                           MOV     A,#'.'
 2204:    2852  12 32 66                        LCALL   TXBYTE
 2205:    2855  12 29 F8                        LCALL   WAITASEC
 2206:    2858  74 2E                           MOV     A,#'.'
 2207:    285A  12 32 66                        LCALL   TXBYTE
 2208:    285D  12 29 F8                        LCALL   WAITASEC
 2209:    2860  74 2E                           MOV     A,#'.'
 2210:    2862  12 32 66                        LCALL   TXBYTE
 2211:    2865  12 29 F8                        LCALL   WAITASEC
 2212:    2868  74 2E                           MOV     A,#'.'
 2213:    286A  12 32 66                        LCALL   TXBYTE
 2214:    286D  74 00                           MOV     A,#00h                          ;D6 LC Meter    0=C, 1=L
 2215:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2216:    286F  79 60                           MOV     R1,#LOW LCF1
 2217:    2871  7B 00                           MOV     R3,#HIGH LCF1
 2218:    2873  12 27 CF                        LCALL   LCMETERGETFRQ                   ;Get F1
 2219:    2876  74 80                           MOV     A,#80h                          ;D6 LC Meter    0=C, 1=L
 2220:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2221:    2878  79 68                           MOV     R1,#LOW LCF2
 2222:    287A  7B 00                           MOV     R3,#HIGH LCF2
 2223:    287C  12 27 CF                        LCALL   LCMETERGETFRQ                   ;Get F2
 2224:                                          ;Calculate LCCA=((F1/F2)^2)-1
 2225:    287F  78 60                           MOV     R0,#LOW LCF1
 2226:    2881  7A 00                           MOV     R2,#HIGH LCF1
 2227:    2883  79 68                           MOV     R1,#LOW LCF2
 2228:    2885  7B 00                           MOV     R3,#HIGH LCF2
 2229:    2887  12 28 09                        LCALL   LCCALC
 2230:                                          ;Save result to LCCA
 2231:    288A  79 78                           MOV     R1,#LOW LCCA
 2232:    288C  7B 00                           MOV     R3,#HIGH LCCA
 2233:    288E  12 26 CF                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2234:                                          ;Calculate A=(1/(2*Pi*F1))^2
 2235:    2891  90 2C C3                        MOV     DPTR,#FPTWO
 2236:    2894  12 27 3B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2237:    2897  90 2C C9                        MOV     DPTR,#FPPI
 2238:    289A  12 27 3B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2239:    289D  12 21 96                        LCALL   FLOATING_MUL
 2240:    28A0  78 60                           MOV     R0,#LOW LCF1
 2241:    28A2  7A 00                           MOV     R2,#HIGH LCF1
 2242:    28A4  12 26 D3                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2243:    28A7  12 21 96                        LCALL   FLOATING_MUL
 2244:    28AA  79 88                           MOV     R1,#LOW LCCT
 2245:    28AC  7B 00                           MOV     R3,#HIGH LCCT
 2246:    28AE  12 26 CF                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2247:    28B1  90 2C BD                        MOV     DPTR,#FPONE
 2248:    28B4  12 27 3B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2249:    28B7  78 88                           MOV     R0,#LOW LCCT
 2250:    28B9  7A 00                           MOV     R2,#HIGH LCCT
 2251:    28BB  12 26 D3                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2252:    28BE  12 21 CB                        LCALL   FLOATING_DIV
 2253:    28C1  A8 24                           MOV     R0,ARG_STACK
 2254:    28C3  7A 01                           MOV     R2,#ARG_STACK_PAGE
 2255:    28C5  12 26 D3                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2256:    28C8  12 21 96                        LCALL   FLOATING_MUL
 2257:                                          ;Calculate LCCB=A*LCCA*(1/Ccal)
 2258:    28CB  78 78                           MOV     R0,#LOW LCCA
 2259:    28CD  7A 00                           MOV     R2,#HIGH LCCA
 2260:    28CF  12 26 D3                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2261:    28D2  12 21 96                        LCALL   FLOATING_MUL
 2262:    28D5  90 2C CF                        MOV     DPTR,#FPCCAL
 2263:    28D8  12 27 3B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2264:    28DB  12 21 CB                        LCALL   FLOATING_DIV
 2265:                                          ;Save result to LCCB
 2266:    28DE  79 80                           MOV     R1,#LOW LCCB
 2267:    28E0  7B 00                           MOV     R3,#HIGH LCCB
 2268:    28E2  12 26 CF                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2269:    28E5  E4                              CLR     A
 2270:    28E6  90 80 00                        MOV     DPTR,#8000h
 2271:    28E9  F0                              MOVX    @DPTR,A                         ;D7, D6
 2272:    28EA  74 0D                           MOV     A,#0Dh
 2273:    28EC  12 32 66                        LCALL   TXBYTE
 2274:    28EF  74 0A                           MOV     A,#0Ah
 2275:    28F1  12 32 66                        LCALL   TXBYTE
 2276:    28F4  22                              RET
 2277:
 2278:                          ;Inductance meter Lx=((F1/F3)^2)-1)*((F1/F2)^2)-1)*((1/(2*Pi*F1))^2)*(1/Ccal)
 2279:                          ;IN:    Nothing
 2280:                          ;OUT:   Nothing
 2281:    28F5  74 40           LMETER:         MOV     A,#40h                          ;D6 LC Meter    0=C, 1=L
 2282:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2283:    28F7  79 70                           MOV     R1,#LOW LCF3
 2284:    28F9  7B 00                           MOV     R3,#HIGH LCF3
 2285:    28FB  12 27 CF                        LCALL   LCMETERGETFRQ                   ;Get F3
 2286:                                          ;Calculate A=((F1/F3)^2)-1
 2287:    28FE  78 60                           MOV     R0,#LOW LCF1
 2288:    2900  7A 00                           MOV     R2,#HIGH LCF1
 2289:    2902  79 70                           MOV     R1,#LOW LCF3
 2290:    2904  7B 00                           MOV     R3,#HIGH LCF3
 2291:    2906  12 28 09                        LCALL   LCCALC
 2292:                                          ;Calculate B=A*LCCB
 2293:    2909  78 80                           MOV     R0,#LOW LCCB
 2294:    290B  7A 00                           MOV     R2,#HIGH LCCB
 2295:    290D  12 26 D3                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2296:    2910  12 21 96                        LCALL   FLOATING_MUL
 2297:    2913  85 24 82                        MOV     DPL,ARG_STACK
 2298:    2916  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 2299:    2919  15 82                           DEC     DPL
 2300:    291B  E0                              MOVX    A,@DPTR
 2301:    291C  05 82                           INC     DPL
 2302:    291E  60 02                           JZ      LMETER1
 2303:    2920  E4                              CLR     A
 2304:    2921  F0                              MOVX    @DPTR,A
 2305:    2922  E0              LMETER1:        MOVX    A,@DPTR
 2306:    2923  B4 80 00                        CJNE    A,#80h,$+3
 2307:    2926  40 02                           JC      LMETER2
 2308:    2928  E4                              CLR     A
 2309:    2929  F0                              MOVX    @DPTR,A
 2310:    292A  75 4E 6E        LMETER2:        MOV     LCDLINE+14,#'n'
 2311:    292D  90 2C DB                        MOV     DPTR,#FPN
 2312:    2930  60 16                           JZ      LMETER3
 2313:    2932  B4 7B 00                        CJNE    A,#7Bh,$+3
 2314:    2935  40 11                           JC      LMETER3
 2315:    2937  75 4E 75                        MOV     LCDLINE+14,#'u'
 2316:    293A  90 2C E1                        MOV     DPTR,#FPU
 2317:    293D  B4 7E 00                        CJNE    A,#7Eh,$+3
 2318:    2940  40 06                           JC      LMETER3
 2319:    2942  75 4E 6D                        MOV     LCDLINE+14,#'m'
 2320:    2945  90 2C E7                        MOV     DPTR,#FPM
 2321:    2948  12 27 3B        LMETER3:        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2322:    294B  12 21 96                        LCALL   FLOATING_MUL
 2323:    294E  75 40 4C                        MOV     LCDLINE,#'L'
 2324:    2951  75 41 20                        MOV     LCDLINE+1,#' '
 2325:    2954  75 42 3D                        MOV     LCDLINE+2,#'='
 2326:    2957  75 43 20                        MOV     LCDLINE+3,#' '
 2327:    295A  75 4F 48                        MOV     LCDLINE+15,#'H'
 2328:    295D  75 50 44                        MOV     FPCHR_OUT,#LCDLINE+4
 2329:    2960  75 25 53                        MOV     FORMAT,#53h
 2330:    2963  E5 24                           MOV     A,ARG_STACK
 2331:    2965  C3                              CLR     C
 2332:    2966  94 05                           SUBB    A,#05h
 2333:    2968  F8                              MOV     R0,A
 2334:    2969  12 24 83                        LCALL   FLOATING_POINT_OUTPUT
 2335:    296C  74 00                           MOV     A,#00h
 2336:    296E  12 3D 3F                        LCALL   LCDSETADR
 2337:    2971  78 40                           MOV     R0,#LCDLINE
 2338:    2973  7F 10                           MOV     R7,#10h
 2339:    2975  12 31 2F                        LCALL   PRINTSTR
 2340:    2978  02 30 3B                        LJMP    START
 2341:
 2342:                          ;Capacitance meter: Cx=((F1/F3)^2)-1)/((F1/F2)^2)-1)*Ccal
 2343:                          ;IN:    Nothing
 2344:                          ;OUT:   Nothing
 2345:    297B  74 00           CMETER:         MOV     A,#00h                          ;D6 LC Meter    0=C, 1=L
 2346:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2347:    297D  79 70                           MOV     R1,#LOW LCF3
 2348:    297F  7B 00                           MOV     R3,#HIGH LCF3
 2349:    2981  12 27 CF                        LCALL   LCMETERGETFRQ                   ;Get F3
 2350:                                          ;Calculate A=((F1/F3)^2)-1
 2351:    2984  78 60                           MOV     R0,#LOW LCF1
 2352:    2986  7A 00                           MOV     R2,#HIGH LCF1
 2353:    2988  79 70                           MOV     R1,#LOW LCF3
 2354:    298A  7B 00                           MOV     R3,#HIGH LCF3
 2355:    298C  12 28 09                        LCALL   LCCALC
 2356:                                          ;Calculate B=A/LCCA
 2357:    298F  78 78                           MOV     R0,#LOW LCCA
 2358:    2991  7A 00                           MOV     R2,#HIGH LCCA
 2359:    2993  12 26 D3                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2360:    2996  12 21 CB                        LCALL   FLOATING_DIV
 2361:                                          ;Calculate Cx=A/B*Ccal
 2362:    2999  90 2C CF                        MOV     DPTR,#FPCCAL
 2363:    299C  12 27 3B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2364:    299F  12 21 96                        LCALL   FLOATING_MUL
 2365:    29A2  85 24 82                        MOV     DPL,ARG_STACK
 2366:    29A5  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 2367:    29A8  15 82                           DEC     DPL
 2368:    29AA  E0                              MOVX    A,@DPTR
 2369:    29AB  05 82                           INC     DPL
 2370:    29AD  60 02                           JZ      CMETER1
 2371:    29AF  E4                              CLR     A
 2372:    29B0  F0                              MOVX    @DPTR,A
 2373:    29B1  E0              CMETER1:        MOVX    A,@DPTR
 2374:    29B2  75 4E 70                        MOV     LCDLINE+14,#'p'
 2375:    29B5  90 2C D5                        MOV     DPTR,#FPP
 2376:    29B8  60 0B                           JZ      CMETER2
 2377:    29BA  B4 78 00                        CJNE    A,#78h,$+3
 2378:    29BD  40 06                           JC      CMETER2
 2379:    29BF  75 4E 6E                        MOV     LCDLINE+14,#'n'
 2380:    29C2  90 2C DB                        MOV     DPTR,#FPN
 2381:    29C5  12 27 3B        CMETER2:        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2382:    29C8  12 21 96                        LCALL   FLOATING_MUL
 2383:    29CB  75 40 43                        MOV     LCDLINE,#'C'
 2384:    29CE  75 41 20                        MOV     LCDLINE+1,#' '
 2385:    29D1  75 42 3D                        MOV     LCDLINE+2,#'='
 2386:    29D4  75 43 20                        MOV     LCDLINE+3,#' '
 2387:    29D7  75 4F 46                        MOV     LCDLINE+15,#'F'
 2388:    29DA  75 50 44                        MOV     FPCHR_OUT,#LCDLINE+4
 2389:    29DD  75 25 53                        MOV     FORMAT,#53h
 2390:    29E0  E5 24                           MOV     A,ARG_STACK
 2391:    29E2  C3                              CLR     C
 2392:    29E3  94 05                           SUBB    A,#05h
 2393:    29E5  F8                              MOV     R0,A
 2394:    29E6  12 24 83                        LCALL   FLOATING_POINT_OUTPUT
 2395:    29E9  74 00                           MOV     A,#00h
 2396:    29EB  12 3D 3F                        LCALL   LCDSETADR
 2397:    29EE  78 40                           MOV     R0,#LCDLINE
 2398:    29F0  7F 10                           MOV     R7,#10h
 2399:    29F2  12 31 2F                        LCALL   PRINTSTR
 2400:    29F5  02 30 3B                        LJMP    START
 2401:
 2402:                          ;------------------------------------------------------------------
 2403:
 2404:                          ;Wait loop. Waits 1 second
 2405:                          ;-----------------------------------------------------
 2406:    29F8  7F F8           WAITASEC:       MOV     R7,#0F8h
 2407:    29FA  7E 33                           MOV     R6,#51
 2408:    29FC  7D 10                           MOV     R5,#16
 2409:    29FE  DF FE           WAITASEC1:      DJNZ    R7,WAITASEC1
 2410:    2A00  DE FC                           DJNZ    R6,WAITASEC1
 2411:    2A02  DD FA                           DJNZ    R5,WAITASEC1
 2412:    2A04  22                              RET
 2413:
 2414:                          ;Frequency counter. LSB from 74LS393 read at 8001h, TL0, TH0, TF0 bit. 25 bits, max 33554431 Hz
 2415:                          ;IN;    A holds channel (0 to 3). ACC.7 FRQ TTL Active high
 2416:                          ;OUT:   32 Bit result in R7:R6:R5:R4
 2417:                          ;------------------------------------------------------------------
 2418:    2A05  44 7C           FRQCOUNT:       ORL     A,#7Ch                          ;D0,D1  CHANNEL (0-3)
 2419:                                                                                  ;D2     FRQ     Gate active low
 2420:                                                                                  ;D3     FRQ     Reset active high
 2421:                                                                                  ;D4     ADC     CS Active low
 2422:                                                                                  ;D5     ADC     CLK High to Low transition
 2423:                                                                                  ;D6     ADC     DIN
 2424:                                                                                  ;D7     FRQ TTL  Active high
 2425:    2A07  90 80 01                        MOV     DPTR,#8001h
 2426:    2A0A  F0                              MOVX    @DPTR,A                         ;Reset and gate off
 2427:    2A0B  C0 E0                           PUSH    ACC
 2428:    2A0D  75 8A 00                        MOV     TL0,#00h
 2429:    2A10  75 8C 00                        MOV     TH0,#00h
 2430:    2A13  E5 89                           MOV     A,TMOD
 2431:    2A15  D2 E0                           SETB    ACC.0                           ;M00
 2432:    2A17  C2 E1                           CLR     ACC.1                           ;M01
 2433:    2A19  D2 E2                           SETB    ACC.2                           ;C/T0#
 2434:    2A1B  C2 E3                           CLR     ACC.3                           ;GATE0
 2435:    2A1D  F5 89                           MOV     TMOD,A
 2436:    2A1F  E5 88                           MOV     A,TCON
 2437:    2A21  D2 E4                           SETB    ACC.4                           ;TR0
 2438:    2A23  C2 E5                           CLR     ACC.5                           ;TF0
 2439:    2A25  F5 88                           MOV     TCON,A
 2440:    2A27  D0 E0                           POP     ACC
 2441:    2A29  54 F3                           ANL     A,#0F3h                         ;D2     FRQ Gate active low
 2442:                                                                                  ;D3     FRQ Reset active high
 2443:    2A2B  F0                              MOVX    @DPTR,A                         ;Gate on(low),Reset inactive (low)
 2444:    2A2C  31 F8                           ACALL   WAITASEC
 2445:    2A2E  D2 E2                           SETB    ACC.2                           ;D2     FRQ Gate active low
 2446:    2A30  F0                              MOVX    @DPTR,A                         ;Stop counting
 2447:    2A31  E0                              MOVX    A,@DPTR
 2448:    2A32  FC                              MOV     R4,A
 2449:    2A33  E5 8A                           MOV     A,TL0
 2450:    2A35  FD                              MOV     R5,A
 2451:    2A36  E5 8C                           MOV     A,TH0
 2452:    2A38  FE                              MOV     R6,A
 2453:    2A39  E4                              CLR     A                               ;TF0 Is the 25th bit
 2454:    2A3A  A2 8D                           MOV     C,TF0
 2455:    2A3C  33                              RLC     A
 2456:    2A3D  FF                              MOV     R7,A
 2457:    2A3E  22                              RET
 2458:
 2459:                          ;Format frequency conter text line
 2460:                          ;IN:    A holds channel (0 to 3)
 2461:                          ;       LCDLINE+4 Decimal result
 2462:                          ;       R7 Number of digits
 2463:                          ;OUT:   Formatted LCDLINE
 2464:    2A3F  75 40 43        FRQFORMAT:      MOV     LCDLINE,#'C'
 2465:    2A42  75 41 48                        MOV     LCDLINE+1,#'H'
 2466:    2A45  44 30                           ORL     A,#30h
 2467:    2A47  F5 42                           MOV     LCDLINE+2,A
 2468:    2A49  75 43 20                        MOV     LCDLINE+3,#' '
 2469:    2A4C  78 44                           MOV     R0,#LCDLINE+4
 2470:    2A4E  79 46                           MOV     R1,#LCDLINE+6
 2471:    2A50  BF 07 00                        CJNE    R7,#07h,$+3
 2472:    2A53  40 19                           JC      FRQFORMATKHZ
 2473:                                          ;MHz
 2474:    2A55  7F 08                           MOV     R7,#08h
 2475:    2A57  E7              FRQFORMATMHZ1:  MOV     A,@R1
 2476:    2A58  BF 06 03                        CJNE    R7,#06h,FRQFORMATMHZ2
 2477:    2A5B  76 2E                           MOV     @R0,#'.'
 2478:    2A5D  08                              INC     R0
 2479:    2A5E  F6              FRQFORMATMHZ2:  MOV     @R0,A
 2480:    2A5F  08                              INC     R0
 2481:    2A60  09                              INC     R1
 2482:    2A61  DF F4                           DJNZ    R7,FRQFORMATMHZ1
 2483:    2A63  75 4D 4D                        MOV     LCDLINE+13,#'M'
 2484:    2A66  75 4E 48                        MOV     LCDLINE+14,#'H'
 2485:    2A69  75 4F 7A                        MOV     LCDLINE+15,#'z'
 2486:    2A6C  80 33                           SJMP    FRQFORMATDONE
 2487:    2A6E  BF 04 00        FRQFORMATKHZ:   CJNE    R7,#04h,$+3
 2488:    2A71  40 19                           JC      FRQFORMATHZ
 2489:                                          ;KHz
 2490:    2A73  7F 08                           MOV     R7,#08h
 2491:    2A75  E7              FRQFORMATKHZ1:  MOV     A,@R1
 2492:    2A76  BF 03 03                        CJNE    R7,#03h,FRQFORMATKHZ2
 2493:    2A79  76 2E                           MOV     @R0,#'.'
 2494:    2A7B  08                              INC     R0
 2495:    2A7C  F6              FRQFORMATKHZ2:  MOV     @R0,A
 2496:    2A7D  08                              INC     R0
 2497:    2A7E  09                              INC     R1
 2498:    2A7F  DF F4                           DJNZ    R7,FRQFORMATKHZ1
 2499:    2A81  75 4D 4B                        MOV     LCDLINE+13,#'K'
 2500:    2A84  75 4E 48                        MOV     LCDLINE+14,#'H'
 2501:    2A87  75 4F 7A                        MOV     LCDLINE+15,#'z'
 2502:    2A8A  80 15                           SJMP    FRQFORMATDONE
 2503:    2A8C                  FRQFORMATHZ:    ;Hz
 2504:    2A8C  75 44 20                        MOV     LCDLINE+4,#' '
 2505:    2A8F  08                              INC     R0
 2506:    2A90  7F 08                           MOV     R7,#08h
 2507:    2A92  E7              FRQFORMATHZ1:   MOV     A,@R1
 2508:    2A93  F6                              MOV     @R0,A
 2509:    2A94  08                              INC     R0
 2510:    2A95  09                              INC     R1
 2511:    2A96  DF FA                           DJNZ    R7,FRQFORMATHZ1
 2512:    2A98  75 4D 48                        MOV     LCDLINE+13,#'H'
 2513:    2A9B  75 4E 7A                        MOV     LCDLINE+14,#'z'
 2514:    2A9E  75 4F 20                        MOV     LCDLINE+15,#' '
 2515:    2AA1  22              FRQFORMATDONE:  RET
 2516:
 2517:                          ;Frequency conter and AD Converter channel 0 and 5
 2518:                          ;IN:    Frequency cont channel (0-3)
 2519:                          ;OUT:   Nothing
 2520:    2AA2  C0 E0           FREQENCYCOUNT:  PUSH    ACC
 2521:    2AA4  12 2A 05                        LCALL   FRQCOUNT
 2522:    2AA7  78 44                           MOV     R0,#LCDLINE+4                   ;Decimal buffer
 2523:    2AA9  12 27 51                        LCALL   BIN2DEC
 2524:    2AAC  FF                              MOV     R7,A                            ;Number of digits
 2525:    2AAD  D0 E0                           POP     ACC
 2526:    2AAF  54 03                           ANL     A,#03h
 2527:    2AB1  12 2A 3F                        LCALL   FRQFORMAT
 2528:    2AB4  74 00                           MOV     A,#00h
 2529:    2AB6  12 3D 3F                        LCALL   LCDSETADR
 2530:    2AB9  78 40                           MOV     R0,#LCDLINE                     ;Output result
 2531:    2ABB  7F 10                           MOV     R7,#10h
 2532:    2ABD  12 31 2F                        LCALL   PRINTSTR
 2533:    2AC0  74 00                           MOV     A,#00h                          ;ADC Channel 0
 2534:    2AC2  12 2B 06                        LCALL   ADCONVERT
 2535:    2AC5  74 00                           MOV     A,#00h
 2536:    2AC7  79 44                           MOV     R1,#LCDLINE+4
 2537:    2AC9  75 25 22                        MOV     FORMAT,#22h
 2538:    2ACC  12 2B 5B                        LCALL   ADOUTPUT
 2539:    2ACF  74 05                           MOV     A,#05h                          ;ADC Channel 5
 2540:    2AD1  12 2B 06                        LCALL   ADCONVERT
 2541:    2AD4  E8                              MOV     A,R0
 2542:    2AD5  C3                              CLR     C
 2543:    2AD6  94 73                           SUBB    A,#73h
 2544:    2AD8  F8                              MOV     R0,A
 2545:    2AD9  EA                              MOV     A,R2
 2546:    2ADA  94 00                           SUBB    A,#00h
 2547:    2ADC  50 02                           JNC     FREQENCYCOUNT1
 2548:    2ADE  E4                              CLR     A
 2549:    2ADF  F8                              MOV     R0,A
 2550:    2AE0  FA              FREQENCYCOUNT1: MOV     R2,A
 2551:    2AE1  74 05                           MOV     A,#05h
 2552:    2AE3  79 4A                           MOV     R1,#LCDLINE+10
 2553:    2AE5  75 25 13                        MOV     FORMAT,#13h
 2554:    2AE8  12 2B 5B                        LCALL   ADOUTPUT
 2555:    2AEB  75 40 56                        MOV     LCDLINE,#'V'                    ;Output result
 2556:    2AEE  75 41 41                        MOV     LCDLINE+1,#'A'
 2557:    2AF1  75 42 52                        MOV     LCDLINE+2,#'R'
 2558:    2AF4  75 43 20                        MOV     LCDLINE+3,#' '
 2559:    2AF7  74 40                           MOV     A,#40h
 2560:    2AF9  12 3D 3F                        LCALL   LCDSETADR
 2561:    2AFC  78 40                           MOV     R0,#LCDLINE
 2562:    2AFE  7F 10                           MOV     R7,#10h
 2563:    2B00  12 31 2F                        LCALL   PRINTSTR
 2564:    2B03  02 30 3B                        LJMP    START
 2565:
 2566:                          ;------------------------------------------------------------------
 2567:
 2568:                          ;AD Converter.
 2569:                          ;IN:    A holds channel (0 to 7).
 2570:                          ;OUT:   R2:R0 Holds 16 Bit result
 2571:                          ;-----------------------------------------------------
 2572:    2B06  44 18           ADCONVERT:      ORL     A,#18h                          ;START, SINGLE ENDED
 2573:    2B08  23                              RL      A
 2574:    2B09  23                              RL      A
 2575:    2B0A  23                              RL      A
 2576:    2B0B  FA                              MOV     R2,A
 2577:    2B0C  74 7C                           MOV     A,#7Ch                          ;D0,D1 FRQ SEL
 2578:                                                                                  ;D2 FRQ GATE    ACTIVE LOW
 2579:                                                                                  ;D3 FRQ RESET   ACTIVE HIGH
 2580:                                                                                  ;D4 ADC CS      ACTIVE LOW
 2581:                                                                                  ;D5 ADC CLK     HIGH TO LOW TRANSITION
 2582:                                                                                  ;D6 ADC DIN     START,S/D,D2,D1,D0
 2583:                                                                                  ;D7 FRQ TTL     ACTIVE HIGH
 2584:    2B0E  90 80 01                        MOV     DPTR,#8001h
 2585:    2B11  F0                              MOVX    @DPTR,A
 2586:                                          ;CS low
 2587:    2B12  C2 E4                           CLR     ACC.4                           ;D4 ADC CS      ACTIVE LOW
 2588:    2B14  F0                              MOVX    @DPTR,A
 2589:                                          ;Clock in channel select and Single/Diff+2 clocks for sample
 2590:    2B15  7F 07                           MOV     R7,#07h
 2591:    2B17  CA              ADCONVERT1:     XCH     A,R2
 2592:    2B18  33                              RLC     A
 2593:    2B19  CA                              XCH     A,R2
 2594:    2B1A  92 E6                           MOV     ACC.6,C ;ADC DIN
 2595:    2B1C  C2 E5                           CLR     ACC.5
 2596:    2B1E  F0                              MOVX    @DPTR,A
 2597:    2B1F  D2 E5                           SETB    ACC.5
 2598:    2B21  F0                              MOVX    @DPTR,A
 2599:    2B22  DF F3                           DJNZ    R7,ADCONVERT1
 2600:    2B24  7A 00                           MOV     R2,#00h
 2601:                                          ;Clock in 5 bits, including null bit
 2602:    2B26  7F 05                           MOV     R7,#05h
 2603:    2B28  C0 E0           ADCONVERT2:     PUSH    ACC
 2604:    2B2A  90 80 00                        MOV     DPTR,#8000h
 2605:    2B2D  E0                              MOVX    A,@DPTR
 2606:    2B2E  13                              RRC     A
 2607:    2B2F  CA                              XCH     A,R2
 2608:    2B30  33                              RLC     A
 2609:    2B31  CA                              XCH     A,R2
 2610:    2B32  90 80 01                        MOV     DPTR,#8001h
 2611:    2B35  D0 E0                           POP     ACC
 2612:    2B37  C2 E5                           CLR     ACC.5
 2613:    2B39  F0                              MOVX    @DPTR,A
 2614:    2B3A  D2 E5                           SETB    ACC.5
 2615:    2B3C  F0                              MOVX    @DPTR,A
 2616:    2B3D  DF E9                           DJNZ    R7,ADCONVERT2
 2617:    2B3F  78 00                           MOV     R0,#00h
 2618:                                          ;Clock in 8 bits
 2619:    2B41  7F 08                           MOV     R7,#08h
 2620:    2B43  C0 E0           ADCONVERT3:     PUSH    ACC
 2621:    2B45  90 80 00                        MOV     DPTR,#8000h
 2622:    2B48  E0                              MOVX    A,@DPTR
 2623:    2B49  13                              RRC     A
 2624:    2B4A  C8                              XCH     A,R0
 2625:    2B4B  33                              RLC     A
 2626:    2B4C  C8                              XCH     A,R0
 2627:    2B4D  90 80 01                        MOV     DPTR,#8001h
 2628:    2B50  D0 E0                           POP     ACC
 2629:    2B52  C2 E5                           CLR     ACC.5
 2630:    2B54  F0                              MOVX    @DPTR,A
 2631:    2B55  D2 E5                           SETB    ACC.5
 2632:    2B57  F0                              MOVX    @DPTR,A
 2633:    2B58  DF E9                           DJNZ    R7,ADCONVERT3
 2634:    2B5A  22                              RET
 2635:
 2636:                          ;AD Converter output
 2637:                          ;IN:    A holds channel (0 to 7).
 2638:                          ;       R2:R0 adc result
 2639:                          ;       R1 pointer to buffer
 2640:                          ;OUT:   6 Characters
 2641:                          ;-----------------------------------------------------
 2642:    2B5B  89 50           ADOUTPUT:       MOV     FPCHR_OUT,R1
 2643:    2B5D  C0 E0                           PUSH    ACC
 2644:                                          ;Convert 16 bit integer in R2:R0 to float and push it to fp arg stack
 2645:    2B5F  12 23 BF                        LCALL   PUSHR2R0
 2646:                                          ;Push the channelS constant to fp arg stack
 2647:    2B62  90 2C 8D                        MOV     DPTR,#ADCMUL
 2648:    2B65  D0 E0                           POP     ACC
 2649:    2B67  75 F0 06                        MOV     B,#FP_NUMBER_SIZE
 2650:    2B6A  A4                              MUL     AB
 2651:    2B6B  25 82                           ADD     A,DPL
 2652:    2B6D  F5 82                           MOV     DPL,A
 2653:    2B6F  50 02                           JNC     ADOUTPUT1
 2654:    2B71  05 83                           INC     DPH
 2655:    2B73  12 27 3B        ADOUTPUT1:      LCALL   PUSHC
 2656:                                          ;Multiply
 2657:    2B76  12 21 96                        LCALL   FLOATING_MUL
 2658:    2B79  E5 24                           MOV     A,ARG_STACK
 2659:    2B7B  C3                              CLR     C
 2660:    2B7C  94 05                           SUBB    A,#05h
 2661:    2B7E  F8                              MOV     R0,A
 2662:    2B7F  12 24 83                        LCALL   FLOATING_POINT_OUTPUT
 2663:    2B82  22                              RET
 2664:
 2665:                          ;AD Converter
 2666:                          ;IN:    Nothing
 2667:                          ;OUT:   Nothing
 2668:    2B83  74 02           ADCONVERTERINT: MOV     A,#02h                          ;Channel 2
 2669:    2B85  12 2B 06                        LCALL   ADCONVERT
 2670:    2B88  74 02                           MOV     A,#02h
 2671:    2B8A  79 44                           MOV     R1,#LCDLINE+4
 2672:    2B8C  75 25 22                        MOV     FORMAT,#22h
 2673:    2B8F  12 2B 5B                        LCALL   ADOUTPUT
 2674:    2B92  74 06                           MOV     A,#06h                          ;Channel 6
 2675:    2B94  12 2B 06                        LCALL   ADCONVERT
 2676:    2B97  74 06                           MOV     A,#06h
 2677:    2B99  79 4A                           MOV     R1,#LCDLINE+10
 2678:    2B9B  75 25 13                        MOV     FORMAT,#13h
 2679:    2B9E  12 2B 5B                        LCALL   ADOUTPUT
 2680:    2BA1  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2681:    2BA4  75 41 4E                        MOV     LCDLINE+1,#'N'
 2682:    2BA7  75 42 54                        MOV     LCDLINE+2,#'T'
 2683:    2BAA  75 43 20                        MOV     LCDLINE+3,#' '
 2684:    2BAD  74 00                           MOV     A,#00h
 2685:    2BAF  12 3D 3F                        LCALL   LCDSETADR
 2686:    2BB2  78 40                           MOV     R0,#LCDLINE
 2687:    2BB4  7F 10                           MOV     R7,#10h
 2688:    2BB6  12 31 2F                        LCALL   PRINTSTR
 2689:    2BB9  74 03                           MOV     A,#03h                          ;Channel 3
 2690:    2BBB  12 2B 06                        LCALL   ADCONVERT
 2691:    2BBE  74 03                           MOV     A,#03h
 2692:    2BC0  79 44                           MOV     R1,#LCDLINE+4
 2693:    2BC2  75 25 22                        MOV     FORMAT,#22h
 2694:    2BC5  12 2B 5B                        LCALL   ADOUTPUT
 2695:    2BC8  74 07                           MOV     A,#07h                          ;Channel 7
 2696:    2BCA  12 2B 06                        LCALL   ADCONVERT
 2697:    2BCD  74 07                           MOV     A,#07h
 2698:    2BCF  79 4A                           MOV     R1,#LCDLINE+10
 2699:    2BD1  75 25 13                        MOV     FORMAT,#13h
 2700:    2BD4  12 2B 5B                        LCALL   ADOUTPUT
 2701:    2BD7  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2702:    2BDA  75 41 4E                        MOV     LCDLINE+1,#'N'
 2703:    2BDD  75 42 54                        MOV     LCDLINE+2,#'T'
 2704:    2BE0  75 43 20                        MOV     LCDLINE+3,#' '
 2705:    2BE3  74 40                           MOV     A,#40h
 2706:    2BE5  12 3D 3F                        LCALL   LCDSETADR
 2707:    2BE8  78 40                           MOV     R0,#LCDLINE
 2708:    2BEA  7F 10                           MOV     R7,#10h
 2709:    2BEC  12 31 2F                        LCALL   PRINTSTR
 2710:    2BEF  7F 14                           MOV     R7,#14h
 2711:    2BF1  74 FA           ADCONVERTERINT1:MOV     A,#250
 2712:    2BF3  12 3C 28                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2713:    2BF6  DF F9                           DJNZ    R7,ADCONVERTERINT1
 2714:    2BF8  02 30 3B                        LJMP    START
 2715:
 2716:    2BFB  74 00           ADCONVERTEREXT: MOV     A,#00h                          ;Channel 0
 2717:    2BFD  12 2B 06                        LCALL   ADCONVERT
 2718:    2C00  74 00                           MOV     A,#00h
 2719:    2C02  79 44                           MOV     R1,#LCDLINE+4
 2720:    2C04  75 25 22                        MOV     FORMAT,#22h
 2721:    2C07  12 2B 5B                        LCALL   ADOUTPUT
 2722:    2C0A  74 05                           MOV     A,#05h                          ;Channel 5
 2723:    2C0C  12 2B 06                        LCALL   ADCONVERT
 2724:    2C0F  E8                              MOV     A,R0
 2725:    2C10  C3                              CLR     C
 2726:    2C11  94 73                           SUBB    A,#73h
 2727:    2C13  F8                              MOV     R0,A
 2728:    2C14  EA                              MOV     A,R2
 2729:    2C15  94 00                           SUBB    A,#00h
 2730:    2C17  50 02                           JNC     ADCONVEXT
 2731:    2C19  E4                              CLR     A
 2732:    2C1A  F8                              MOV     R0,A
 2733:    2C1B  FA              ADCONVEXT:      MOV     R2,A
 2734:    2C1C  74 05                           MOV     A,#05h
 2735:    2C1E  79 4A                           MOV     R1,#LCDLINE+10
 2736:    2C20  75 25 13                        MOV     FORMAT,#13h
 2737:    2C23  12 2B 5B                        LCALL   ADOUTPUT
 2738:    2C26  75 40 56                        MOV     LCDLINE,#'V'                    ;Output result
 2739:    2C29  75 41 41                        MOV     LCDLINE+1,#'A'
 2740:    2C2C  75 42 52                        MOV     LCDLINE+2,#'R'
 2741:    2C2F  75 43 20                        MOV     LCDLINE+3,#' '
 2742:    2C32  74 00                           MOV     A,#00h
 2743:    2C34  12 3D 3F                        LCALL   LCDSETADR
 2744:    2C37  78 40                           MOV     R0,#LCDLINE
 2745:    2C39  7F 10                           MOV     R7,#10h
 2746:    2C3B  12 31 2F                        LCALL   PRINTSTR
 2747:    2C3E  74 01                           MOV     A,#01h                          ;Channel 1
 2748:    2C40  12 2B 06                        LCALL   ADCONVERT
 2749:    2C43  74 01                           MOV     A,#01h
 2750:    2C45  79 44                           MOV     R1,#LCDLINE+4
 2751:    2C47  75 25 22                        MOV     FORMAT,#22h
 2752:    2C4A  12 2B 5B                        LCALL   ADOUTPUT
 2753:    2C4D  74 04                           MOV     A,#04h                          ;Channel 4
 2754:    2C4F  12 2B 06                        LCALL   ADCONVERT
 2755:    2C52  E8                              MOV     A,R0
 2756:    2C53  C3                              CLR     C
 2757:    2C54  94 73                           SUBB    A,#73h
 2758:    2C56  F8                              MOV     R0,A
 2759:    2C57  EA                              MOV     A,R2
 2760:    2C58  94 00                           SUBB    A,#00h
 2761:    2C5A  50 02                           JNC     ADCONVEXT1
 2762:    2C5C  E4                              CLR     A
 2763:    2C5D  F8                              MOV     R0,A
 2764:    2C5E  FA              ADCONVEXT1:     MOV     R2,A
 2765:    2C5F  74 04                           MOV     A,#04h
 2766:    2C61  79 4A                           MOV     R1,#LCDLINE+10
 2767:    2C63  75 25 13                        MOV     FORMAT,#13h
 2768:    2C66  12 2B 5B                        LCALL   ADOUTPUT
 2769:    2C69  75 40 45                        MOV     LCDLINE,#'E'                    ;Output result
 2770:    2C6C  75 41 58                        MOV     LCDLINE+1,#'X'
 2771:    2C6F  75 42 54                        MOV     LCDLINE+2,#'T'
 2772:    2C72  75 43 20                        MOV     LCDLINE+3,#' '
 2773:    2C75  74 40                           MOV     A,#40h
 2774:    2C77  12 3D 3F                        LCALL   LCDSETADR
 2775:    2C7A  78 40                           MOV     R0,#LCDLINE
 2776:    2C7C  7F 10                           MOV     R7,#10h
 2777:    2C7E  12 31 2F                        LCALL   PRINTSTR
 2778:    2C81  7F 14                           MOV     R7,#14h
 2779:    2C83  74 FA           ADCONVERTEREXT1:MOV     A,#250
 2780:    2C85  12 3C 28                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2781:    2C88  DF F9                           DJNZ    R7,ADCONVERTEREXT1
 2782:    2C8A  02 30 3B                        LJMP    START
 2783:
 2784:                          ;------------------------------------------------------------------
 2785:    2C8D  7E 00 00 07     ADCMUL:         DB 7Eh,00h,00h,07h,03h,52h              ;CH0
          2C91  03 52
 2786:    2C93  7E 00 00 07                     DB 7Eh,00h,00h,07h,03h,16h              ;CH1
          2C97  03 16
 2787:    2C99  7E 00 00 00                     DB 7Eh,00h,00h,00h,02h,36h              ;CH2
          2C9D  02 36
 2788:    2C9F  7E 00 00 07                     DB 7Eh,00h,00h,07h,03h,16h              ;CH3
          2CA3  03 16
 2789:    2CA5  7D 00 00 00                     DB 7Dh,00h,00h,00h,50h,30h              ;CH4
          2CA9  50 30
 2790:    2CAB  7D 00 00 00                     DB 7Dh,00h,00h,00h,50h,30h              ;CH5
          2CAF  50 30
 2791:    2CB1  00 00 00 00                     DB 00h,00h,00h,00h,00h,00h              ;CH6
          2CB5  00 00
 2792:    2CB7  00 00 00 00                     DB 00h,00h,00h,00h,00h,00h              ;CH7
          2CBB  00 00
 2793:                          ;------------------------------------------------------------------
 2794:    2CBD  81 00 00 00     FPONE:          DB 81h,00h,00h,00h,00h,10h              ;1.0000000
          2CC1  00 10
 2795:    2CC3  81 00 00 00     FPTWO:          DB 81h,00h,00h,00h,00h,20h              ;2.0000000
          2CC7  00 20
 2796:    2CC9  81 00 27 59     FPPI:           DB 81h,00h,27h,59h,41h,31h              ;3.1415927
          2CCD  41 31
 2797:    2CCF  77 00 00 00     FPCCAL:         DB 77h,00h,00h,00h,50h,94h              ;1nF=1e-9
          2CD3  50 94
 2798:    2CD5  8D 00 00 00     FPP:            DB 8Dh,00h,00h,00h,00h,10h              ;1e12
          2CD9  00 10
 2799:    2CDB  8A 00 00 00     FPN:            DB 8Ah,00h,00h,00h,00h,10h              ;1e9
          2CDF  00 10
 2800:    2CE1  87 00 00 00     FPU:            DB 87h,00h,00h,00h,00h,10h              ;1e6
          2CE5  00 10
 2801:    2CE7  84 00 00 00     FPM:            DB 84h,00h,00h,00h,00h,10h              ;1e3
          2CEB  00 10
 2802:                          ;------------------------------------------------------------------
 2803:
 2804:          N      0000     IF DEVMODE=0
 2805:                                          ORG     1000h
 2806:                          ELSE
 2807:          N      3000                     ORG     3000h
 2808:                          ENDIF
 2809:
 2810:    3000  E4              START0:         CLR     A
 2811:    3001  F5 A8                           MOV     IE,A                            ;Disable all interrupts
 2812:    3003  F5 59                           MOV     MODE,A                          ;Set mode to RS232 Terminal
 2813:    3005  F5 20                           MOV     INTBITS,A                       ;RAM int routines (.0-.5 INTERRUPTS, .6=LCD OUT, .7 Single step)
 2814:    3007  14                              DEC     A
 2815:    3008  F5 5A                           MOV     SSADRLSB,A                      ;Single step adress
 2816:    300A  F5 5B                           MOV     SSADRMSB,A                      ;Single step adress
 2817:    300C  F5 B0                           MOV     P3,A                            ;All bits input
 2818:    300E  75 CA D9                        MOV     RCAP2L,#0D9h                    ;19200bps with 24MHz OSC
 2819:    3011  75 CB FF                        MOV     RCAP2H,#0FFh
 2820:    3014  75 CC D9                        MOV     TL2,#0D9h
 2821:    3017  75 CD FF                        MOV     TH2,#0FFh
 2822:    301A  75 C8 34                        MOV     T2CON,#34h                      ;TF2=l
 2823:                                                                                  ;EXF2=l
 2824:                                                                                  ;RCLK=h
 2825:                                                                                  ;TCLK=h
 2826:                                                                                  ;EXEN2=l
 2827:                                                                                  ;TR2=h
 2828:                                                                                  ;C/T2#=l
 2829:                                                                                  ;CP/RL2#=l
 2830:    301D  75 98 50                        MOV     SCON,#50h                       ;SM0=l
 2831:                                                                                  ;SM1=h
 2832:                                                                                  ;SM2=l
 2833:                                                                                  ;REN=h
 2834:                                                                                  ;TB8=l
 2835:                                                                                  ;RB8=l
 2836:                                                                                  ;TI=l
 2837:                                                                                  ;RI=l
 2838:    3020  75 53 01                        MOV     ROMACTION,#01h                  ;Action
 2839:    3023  75 54 02                        MOV     ROMSIZE,#02h                    ;Size
 2840:    3026  75 55 01                        MOV     ROMMODE,#01h                    ;Mode
 2841:
 2842:    3029  D2 A8                           SETB    EX0                             ;Enable INT0
 2843:    302B  D2 AA                           SETB    EX1                             ;Enable INT1
 2844:    302D  D2 AF                           SETB    EA                              ;Enable interrupts
 2845:    302F  75 20 00                        MOV     INTBITS,#00h                    ;Output to LCD
 2846:    3032  12 3D 6E                        LCALL   LCDINIT
 2847:    3035  12 28 2E                        LCALL   LCMETERINIT
 2848:
 2849:          N      FFFF     IF DEVMODE=1
 2850:    3038  75 20 3F                        MOV     INTBITS,#3Fh                    ;Redirect all interrupts, Output to LCD
 2851:          N      0000             IF DEBUG=1
 2852:                                          SETB    INTBITS.7                       ;Set single step flag
 2853:                                          CLR     IT1                             ;Level triggered
 2854:                                          CLR     P3.3                            ;Pull INT1 low
 2855:                                          NOP
 2856:                                          NOP
 2857:                                  ENDIF
 2858:                          ENDIF
 2859:
 2860:    303B  75 81 CF        START:          MOV     SP,#0CFh                        ;Init stack pointer. The stack is 48 bytes
 2861:    303E  90 20 00                        MOV     DPTR,#2000h
 2862:          N      FFFF     IF DEVMODE=1
 2863:    3041  30 98 06                        JNB     RI,START01
 2864:    3044  75 20 00                        MOV     INTBITS,#00h                    ;Redirect no interrupts
 2865:    3047  02 00 00                        LJMP    0000h
 2866:    304A                  START01:;       MOV     MODE,#08h
 2867:                          ENDIF
 2868:
 2869:    304A  75 24 80                        MOV     ARG_STACK,#80h
 2870:    304D  E5 59                           MOV     A,MODE
 2871:    304F  B4 FF 02                        CJNE    A,#0FFh,START11
 2872:    3052  74 0A                           MOV     A,#MODEMAX
 2873:    3054  B4 0B 01        START11:        CJNE    A,#MODEMAX+1,START12
 2874:    3057  E4                              CLR     A
 2875:    3058  F5 59           START12:        MOV     MODE,A
 2876:    305A  FF                              MOV     R7,A
 2877:    305B  70 02                           JNZ     START1
 2878:    305D  01 9A                           AJMP    TERMINAL                        ;RS232 Terminal
 2879:    305F  DF 04           START1:         DJNZ    R7,START2
 2880:    3061  E4                              CLR     A                               ;Frequency counter channel0. External, Amplified
 2881:    3062  02 2A A2                        LJMP    FREQENCYCOUNT
 2882:    3065  DF 05           START2:         DJNZ    R7,START3                       ;Frequency counter channel0. External, TTL Level
 2883:    3067  74 80                           MOV     A,#80h
 2884:    3069  02 2A A2                        LJMP    FREQENCYCOUNT
 2885:    306C  DF 05           START3:         DJNZ    R7,START4
 2886:    306E  74 01                           MOV     A,#01h                          ;Frequency counter channel1. Function generator
 2887:    3070  02 2A A2                        LJMP    FREQENCYCOUNT
 2888:    3073  DF 05           START4:         DJNZ    R7,START5
 2889:    3075  74 02                           MOV     A,#02h                          ;Frequency counter channel2. LC Meter
 2890:    3077  02 2A A2                        LJMP    FREQENCYCOUNT
 2891:    307A  DF 05           START5:         DJNZ    R7,START6
 2892:    307C  74 03                           MOV     A,#03h                          ;Frequency counter channel3. ALE
 2893:    307E  02 2A A2                        LJMP    FREQENCYCOUNT
 2894:    3081  DF 03           START6:         DJNZ    R7,START7
 2895:    3083  02 2B 83                        LJMP    ADCONVERTERINT                  ;AD Coverter Internal PSU
 2896:    3086  DF 03           START7:         DJNZ    R7,START8
 2897:    3088  02 2B FB                        LJMP    ADCONVERTEREXT                  ;AD Coverter External PSU
 2898:    308B  DF 03           START8:         DJNZ    R7,START9
 2899:    308D  02 28 F5                        LJMP    LMETER                          ;Inductance
 2900:    3090  DF 03           START9:         DJNZ    R7,START10
 2901:    3092  02 29 7B                        LJMP    CMETER                          ;Capacitance
 2902:    3095  12 28 2E        START10:        LCALL   LCMETERINIT                     ;Calibrate
 2903:    3098  80 A1                           SJMP    START
 2904:
 2905:                          ;------------------------------------------------------------------
 2906:
 2907:                          ;RS232 Terminal
 2908:                          ;IN:    Nothing
 2909:                          ;OUT:   Nothing
 2910:    309A  51 7D           TERMINAL:       ACALL   HELPMENU
 2911:    309C  31 89           TERMINAL1:      ACALL   PRNTCRLF
 2912:    309E  74 3E                           MOV     A,#3Eh
 2913:    30A0  51 66                           ACALL   TXBYTE
 2914:    30A2  51 4F           TERMINAL2:      ACALL   RXBYTE
 2915:    30A4  B4 41 06                        CJNE    A,#41h,TERMINAL3
 2916:                                          ;Address input
 2917:    30A7  31 84                           ACALL   PRNTCMND
 2918:    30A9  51 2E                           ACALL   INPDPTR
 2919:    30AB  80 EF                           SJMP    TERMINAL1
 2920:    30AD  B4 44 06        TERMINAL3:      CJNE    A,#44h,TERMINAL4
 2921:                                          ;Dump
 2922:    30B0  31 84                           ACALL   PRNTCMND
 2923:    30B2  71 37                           ACALL   DUMP
 2924:    30B4  80 E4                           SJMP    TERMINAL
 2925:    30B6  B4 45 06        TERMINAL4:      CJNE    A,#45h,TERMINAL5
 2926:                                          ;Enter hex
 2927:    30B9  31 84                           ACALL   PRNTCMND
 2928:    30BB  71 63                           ACALL   ENTERHEX
 2929:    30BD  80 DB                           SJMP    TERMINAL
 2930:    30BF  B4 47 06        TERMINAL5:      CJNE    A,#47h,TERMINAL6
 2931:                                          ;Go
 2932:    30C2  31 84                           ACALL   PRNTCMND
 2933:    30C4  B1 5B                           ACALL   GO
 2934:    30C6  80 D2                           SJMP    TERMINAL
 2935:    30C8  B4 48 04        TERMINAL6:      CJNE    A,#48h,TERMINAL7
 2936:                                          ;Help
 2937:    30CB  31 84                           ACALL   PRNTCMND
 2938:    30CD  80 CB                           SJMP    TERMINAL
 2939:    30CF  B4 49 06        TERMINAL7:      CJNE    A,#49h,TERMINAL8
 2940:                                          ;Internal memory
 2941:    30D2  31 84                           ACALL   PRNTCMND
 2942:    30D4  71 95                           ACALL   MEMDUMP
 2943:    30D6  80 C4                           SJMP    TERMINAL1
 2944:    30D8  B4 4C 06        TERMINAL8:      CJNE    A,#4Ch,TERMINAL9
 2945:                                          ;Load
 2946:    30DB  31 84                           ACALL   PRNTCMND
 2947:    30DD  B1 2E                           ACALL   LOAD
 2948:    30DF  80 BB                           SJMP    TERMINAL1
 2949:    30E1  B4 50 06        TERMINAL9:      CJNE    A,#50h,TERMINAL10
 2950:                                          ;Program ROM
 2951:    30E4  31 84                           ACALL   PRNTCMND
 2952:    30E6  B1 5F                           ACALL   EPROM
 2953:    30E8  80 B0                           SJMP    TERMINAL
 2954:    30EA  B4 52 06        TERMINAL10:     CJNE    A,#52h,TERMINAL11
 2955:                                          ;Run
 2956:    30ED  31 84                           ACALL   PRNTCMND
 2957:    30EF  B1 5D                           ACALL   RUN
 2958:    30F1  80 A7                           SJMP    TERMINAL
 2959:    30F3  B4 53 07        TERMINAL11:     CJNE    A,#53h,TERMINAL12
 2960:                                          ;SFR dump
 2961:    30F6  12 31 84                        LCALL   PRNTCMND
 2962:    30F9  71 B8                           ACALL   DUMPSFR
 2963:    30FB  80 9F                           SJMP    TERMINAL1
 2964:    30FD  B4 46 06        TERMINAL12:     CJNE    A,#46h,TERMINAL13
 2965:                                          ;Enter float
 2966:    3100  31 84                           ACALL   PRNTCMND
 2967:    3102  71 78                           ACALL   ENTERFLOAT
 2968:    3104  80 96                           SJMP    TERMINAL1
 2969:    3106  B4 9F 03        TERMINAL13:     CJNE    A,#9Fh,TERMINAL14
 2970:                                          ;Esc
 2971:    3109  02 00 00                        LJMP    0000h
 2972:    310C  B4 0D 93        TERMINAL14:     CJNE    A,#0Dh,TERMINAL2
 2973:                                          ;CR
 2974:    310F  80 8B                           SJMP    TERMINAL1
 2975:
 2976:                          ;RS232 Functions
 2977:                          ;------------------------------------------------------------------
 2978:
 2979:    3111  85 82 57        PRNTCSTR:       MOV     DPLSAVE,DPL
 2980:    3114  85 83 58                        MOV     DPHSAVE,DPH
 2981:    3117  D0 83                           POP     DPH
 2982:    3119  D0 82                           POP     DPL
 2983:    311B  E4              PRNTCSTR1:      CLR     A
 2984:    311C  93                              MOVC    A,@A+DPTR
 2985:    311D  A3                              INC     DPTR
 2986:    311E  60 04                           JZ      PRNTCSTR2
 2987:    3120  51 66                           ACALL   TXBYTE
 2988:    3122  80 F7                           SJMP    PRNTCSTR1
 2989:    3124  C0 82           PRNTCSTR2:      PUSH    DPL
 2990:    3126  C0 83                           PUSH    DPH
 2991:    3128  85 57 82                        MOV     DPL,DPLSAVE
 2992:    312B  85 58 83                        MOV     DPH,DPHSAVE
 2993:    312E  22                              RET
 2994:
 2995:    312F  30 06 09        PRINTSTR:       JNB     INTBITS.6,PRINTSTRLCD
 2996:    3132  E6              PRINTSTRTRM:    MOV     A,@R0
 2997:    3133  51 66                           ACALL   TXBYTE
 2998:    3135  08                              INC     R0
 2999:    3136  DF FA                           DJNZ    R7,PRINTSTRTRM
 3000:    3138  31 89                           ACALL   PRNTCRLF
 3001:    313A  22                              RET
 3002:
 3003:    313B  E6              PRINTSTRLCD:    MOV     A,@R0
 3004:    313C  12 3D 4F                        LCALL   LCDCHROUT
 3005:    313F  08                              INC     R0
 3006:    3140  DF F9                           DJNZ    R7,PRINTSTRLCD
 3007:    3142  22                              RET
 3008:
 3009:    3143  E0              PRINTDPTRSTR:   MOVX    A,@DPTR
 3010:    3144  51 66                           ACALL   TXBYTE
 3011:    3146  A3                              INC     DPTR
 3012:    3147  B4 0D F9                        CJNE    A,#0Dh,PRINTDPTRSTR
 3013:    314A  74 0A                           MOV     A,#0Ah
 3014:    314C  51 66                           ACALL   TXBYTE
 3015:    314E  22                              RET
 3016:
 3017:    314F  75 50 40        PRINTFP:        MOV     FPCHR_OUT,#LCDLINE
 3018:    3152  75 25 00                        MOV     FORMAT,#00h
 3019:    3155  E5 24                           MOV     A,ARG_STACK
 3020:    3157  C3                              CLR     C
 3021:    3158  94 05                           SUBB    A,#05h
 3022:    315A  F8                              MOV     R0,A
 3023:    315B  12 24 83                        LCALL   FLOATING_POINT_OUTPUT
 3024:    315E  A8 50                           MOV     R0,FPCHR_OUT
 3025:    3160  E4                              CLR     A
 3026:    3161  F6                              MOV     @R0,A
 3027:    3162  78 40                           MOV     R0,#LCDLINE
 3028:    3164  E6                              MOV     A,@R0
 3029:    3165  51 66           PRINTFP1:       ACALL   TXBYTE
 3030:    3167  08                              INC     R0
 3031:    3168  E6                              MOV     A,@R0
 3032:    3169  70 FA                           JNZ     PRINTFP1
 3033:    316B  74 20                           MOV     A,#20h
 3034:    316D  51 66                           ACALL   TXBYTE
 3035:    316F  74 20                           MOV     A,#20h
 3036:    3171  51 66                           ACALL   TXBYTE
 3037:    3173  74 20                           MOV     A,#20h
 3038:    3175  51 66                           ACALL   TXBYTE
 3039:    3177  74 20                           MOV     A,#20h
 3040:    3179  51 66                           ACALL   TXBYTE
 3041:    317B  74 0D                           MOV     A,#0Dh
 3042:    317D  51 66                           ACALL   TXBYTE
 3043:    317F  74 0A                           MOV     A,#0Ah
 3044:    3181  51 66                           ACALL   TXBYTE
 3045:    3183  22                              RET
 3046:
 3047:    3184  51 66           PRNTCMND:       ACALL   TXBYTE
 3048:    3186  31 89                           ACALL   PRNTCRLF
 3049:    3188  22                              RET
 3050:
 3051:    3189  74 0D           PRNTCRLF:       MOV     A,#0Dh
 3052:    318B  51 66                           ACALL   TXBYTE
 3053:    318D  74 0A                           MOV     A,#0Ah
 3054:    318F  51 66                           ACALL   TXBYTE
 3055:    3191  22                              RET
 3056:
 3057:    3192  C0 E0           HEXOUT:         PUSH    ACC
 3058:    3194  C4                              SWAP    A
 3059:    3195  31 99                           ACALL   HEXOUT1
 3060:    3197  D0 E0                           POP     ACC
 3061:    3199  54 0F           HEXOUT1:        ANL     A,#0Fh
 3062:    319B  C3                              CLR     C
 3063:    319C  94 0A                           SUBB    A,#0Ah
 3064:    319E  40 02                           JC      HEXOUT2
 3065:    31A0  24 07                           ADD     A,#07h
 3066:    31A2  24 3A           HEXOUT2:        ADD     A,#3Ah
 3067:    31A4  51 66                           ACALL   TXBYTE
 3068:    31A6  22                              RET
 3069:
 3070:    31A7  78 08           BINOUT:         MOV     R0,#08h
 3071:    31A9  33              BINOUT1:        RLC     A
 3072:    31AA  C0 E0                           PUSH    ACC
 3073:    31AC  74 20                           MOV     A,#20h
 3074:    31AE  12 32 66                        LCALL   TXBYTE
 3075:    31B1  74 20                           MOV     A,#20h
 3076:    31B3  12 32 66                        LCALL   TXBYTE
 3077:    31B6  74 30                           MOV     A,#30H
 3078:    31B8  50 01           BINOUT2:        JNC     BINOUT3
 3079:    31BA  04                              INC     A
 3080:    31BB  12 32 66        BINOUT3:        LCALL   TXBYTE
 3081:    31BE  D0 E0                           POP     ACC
 3082:    31C0  D8 E7                           DJNZ    R0,BINOUT1
 3083:    31C2  12 31 89                        LCALL   PRNTCRLF
 3084:    31C5  22                              RET
 3085:
 3086:    31C6  E5 83           HEXDPTR:        MOV     A,DPH
 3087:    31C8  31 92                           ACALL   HEXOUT
 3088:    31CA  E5 82                           MOV     A,DPL
 3089:    31CC  31 92                           ACALL   HEXOUT
 3090:    31CE  74 20                           MOV     A,#20h
 3091:    31D0  51 66                           ACALL   TXBYTE
 3092:    31D2  22                              RET
 3093:
 3094:    31D3  E5 24           HEXDUMPFP:      MOV     A,ARG_STACK
 3095:    31D5  C3                              CLR     C
 3096:    31D6  94 05                           SUBB    A,#05h
 3097:    31D8  F5 82                           MOV     DPL,A
 3098:    31DA  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 3099:    31DD  7F 06                           MOV     R7,#06h
 3100:    31DF  E0              HEXDUMPFP1:     MOVX    A,@DPTR
 3101:    31E0  31 92                           ACALL   HEXOUT
 3102:    31E2  05 82                           INC     DPL
 3103:    31E4  DF F9                           DJNZ    R7,HEXDUMPFP1
 3104:    31E6  74 0D                           MOV     A,#0Dh
 3105:    31E8  51 66                           ACALL   TXBYTE
 3106:    31EA  74 0A                           MOV     A,#0Ah
 3107:    31EC  51 66                           ACALL   TXBYTE
 3108:    31EE  22                              RET
 3109:
 3110:    31EF  31 FB           HEXINPBYTE:     ACALL   HEXINP
 3111:    31F1  40 07                           JC      HEXINPBYTE1
 3112:    31F3  C4                              SWAP    A
 3113:    31F4  FB                              MOV     R3,A
 3114:    31F5  31 FB                           ACALL   HEXINP
 3115:    31F7  40 01                           JC      HEXINPBYTE1
 3116:    31F9  2B                              ADD     A,R3
 3117:    31FA  22              HEXINPBYTE1:    RET
 3118:
 3119:    31FB  51 07           HEXINP:         ACALL   HEXINP2
 3120:    31FD  40 07                           JC      HEXINP1
 3121:    31FF  C0 E0                           PUSH    ACC
 3122:    3201  EA                              MOV     A,R2
 3123:    3202  51 66                           ACALL   TXBYTE
 3124:    3204  D0 E0                           POP     ACC
 3125:    3206  22              HEXINP1:        RET
 3126:
 3127:    3207  51 4F           HEXINP2:        ACALL   RXBYTE
 3128:    3209  B4 9F 02                        CJNE    A,#9Fh,HEXINP3                  ;Esc
 3129:    320C  D3                              SETB    C
 3130:    320D  22                              RET
 3131:    320E  B4 0D 02        HEXINP3:        CJNE    A,#0Dh,HEXINP4                  ;Cr
 3132:    3211  D3                              SETB    C
 3133:    3212  22                              RET
 3134:    3213  FA              HEXINP4:        MOV     R2,A
 3135:    3214  B4 3A 00                        CJNE    A,#3Ah,HEXINP40
 3136:    3217  50 08           HEXINP40:       JNC     HEXINP5
 3137:    3219  B4 30 00                        CJNE    A,#30h,HEXINP41
 3138:    321C  40 E9           HEXINP41:       JC      HEXINP2
 3139:    321E  94 30                           SUBB    A,#30h
 3140:    3220  22                              RET
 3141:    3221  B4 47 00        HEXINP5:        CJNE    A,#47h,HEXINP50
 3142:    3224  50 E1           HEXINP50:       JNC     HEXINP2
 3143:    3226  B4 41 00                        CJNE    A,#41h,HEXINP51
 3144:    3229  40 DC           HEXINP51:       JC      HEXINP2
 3145:    322B  94 37                           SUBB    A,#37h
 3146:    322D  22                              RET
 3147:
 3148:    322E  31 C6           INPDPTR:        ACALL   HEXDPTR
 3149:    3230  31 EF                           ACALL   HEXINPBYTE
 3150:    3232  40 08                           JC      INPDPTR1
 3151:    3234  F5 83                           MOV     DPH,A
 3152:    3236  31 EF                           ACALL   HEXINPBYTE
 3153:    3238  40 02                           JC      INPDPTR1
 3154:    323A  F5 82                           MOV     DPL,A
 3155:    323C  31 89           INPDPTR1:       ACALL   PRNTCRLF
 3156:    323E  22                              RET
 3157:
 3158:    323F  74 05           RX16BYTES:      MOV     A,#05h
 3159:    3241  51 66                           ACALL   TXBYTE
 3160:    3243  78 40                           MOV     R0,#ROMBUFF
 3161:    3245  51 4F           RX16BYTES1:     ACALL   RXBYTE
 3162:    3247  F6                              MOV     @R0,A
 3163:    3248  08                              INC     R0
 3164:    3249  B8 50 F9                        CJNE    R0,#ROMBUFF+10h,RX16BYTES1
 3165:    324C  78 40                           MOV     R0,#ROMBUFF
 3166:    324E  22                              RET
 3167:
 3168:    324F  20 07 08        RXBYTE:         JB      20h.7,RXBYTE1
 3169:    3252  30 98 FD                        JNB     RI,$
 3170:    3255  C2 98                           CLR     RI
 3171:    3257  E5 99                           MOV     A,SBUF
 3172:    3259  22                              RET
 3173:
 3174:    325A  C2 AA           RXBYTE1:        CLR     EX1
 3175:    325C  30 98 FD                        JNB     RI,$
 3176:    325F  C2 98                           CLR     RI
 3177:    3261  E5 99                           MOV     A,SBUF
 3178:    3263  D2 AA                           SETB    EX1
 3179:    3265  22                              RET
 3180:
 3181:    3266  20 07 08        TXBYTE:         JB      20h.7,TXBYTE1
 3182:    3269  F5 99                           MOV     SBUF,A
 3183:    326B  30 99 FD                        JNB     TI,$
 3184:    326E  C2 99                           CLR     TI
 3185:    3270  22                              RET
 3186:
 3187:    3271  C2 AA           TXBYTE1:        CLR     EX1
 3188:    3273  F5 99                           MOV     SBUF,A
 3189:    3275  30 99 FD                        JNB     TI,$
 3190:    3278  C2 99                           CLR     TI
 3191:    327A  D2 AA                           SETB    EX1
 3192:    327C  22                              RET
 3193:
 3194:                          ;Functions
 3195:                          ;------------------------------------------------------------------
 3196:
 3197:    327D  31 11           HELPMENU:       ACALL   PRNTCSTR
 3198:    327F  0E                              DB      0Eh
 3199:          N      FFFF     IF DEVMODE=1
 3200:    3280  2A 2A 2A 20                     DB      '*** DEVMODE ***',0Dh,0Ah
          3284  44 45 56 4D
          3288  4F 44 45 20
          328C  2A 2A 2A 0D
          3290  0A
 3201:                          ENDIF
 3202:    3291  41 20 41 64                     DB      'A Address input',0Dh,0Ah
          3295  64 72 65 73
          3299  73 20 69 6E
          329D  70 75 74 0D
          32A1  0A
 3203:    32A2  44 20 44 75                     DB      'D Dump as hex',0Dh,0Ah
          32A6  6D 70 20 61
          32AA  73 20 68 65
          32AE  78 0D 0A
 3204:    32B1  45 20 45 6E                     DB      'E Enter hex',0Dh,0Ah
          32B5  74 65 72 20
          32B9  68 65 78 0D
          32BD  0A
 3205:    32BE  46 20 45 6E                     DB      'F Enter float',0Dh,0Ah
          32C2  74 65 72 20
          32C6  66 6C 6F 61
          32CA  74 0D 0A
 3206:    32CD  47 20 47 6F                     DB      'G Go (Load and Run)',0Dh,0Ah
          32D1  20 28 4C 6F
          32D5  61 64 20 61
          32D9  6E 64 20 52
          32DD  75 6E 29 0D
          32E1  0A
 3207:    32E2  48 20 48 65                     DB      'H Help',0Dh,0Ah
          32E6  6C 70 0D 0A
 3208:    32EA  49 20 49 6E                     DB      'I Internal memory dump',0Dh,0Ah
          32EE  74 65 72 6E
          32F2  61 6C 20 6D
          32F6  65 6D 6F 72
          32FA  79 20 64 75
          32FE  6D 70 0D 0A
 3209:    3302  4C 20 4C 6F                     DB      'L Load cmd file',0Dh,0Ah
          3306  61 64 20 63
          330A  6D 64 20 66
          330E  69 6C 65 0D
          3312  0A
 3210:    3313  50 20 50 72                     DB      'P Program ROM',0Dh,0Ah
          3317  6F 67 72 61
          331B  6D 20 52 4F
          331F  4D 0D 0A
 3211:    3322  52 20 52 75                     DB      'R Run',0Dh,0Ah
          3326  6E 0D 0A
 3212:    3329  53 20 53 46                     DB      'S SFR dunp',0Dh,0Ah,00h
          332D  52 20 64 75
          3331  6E 70 0D 0A
          3335  00
 3213:    3336  22                              RET
 3214:
 3215:    3337  C0 82           DUMP:           PUSH    DPL
 3216:    3339  C0 83                           PUSH    DPH
 3217:    333B  C0 02                           PUSH    02h
 3218:    333D  C0 03                           PUSH    03h
 3219:    333F  7B 10           DUMP1:          MOV     R3,#10h
 3220:    3341  7A 10           DUMP2:          MOV     R2,#10h
 3221:    3343  31 C6                           ACALL   HEXDPTR
 3222:    3345  E0              DUMP3:          MOVX    A,@DPTR
 3223:    3346  31 92                           ACALL   HEXOUT
 3224:    3348  74 20                           MOV     A,#20h
 3225:    334A  51 66                           ACALL   TXBYTE
 3226:    334C  A3                              INC     DPTR
 3227:    334D  DA F6                           DJNZ    R2,DUMP3
 3228:    334F  31 89                           ACALL   PRNTCRLF
 3229:    3351  DB EE                           DJNZ    R3,DUMP2
 3230:    3353  31 89                           ACALL   PRNTCRLF
 3231:    3355  51 4F                           ACALL   RXBYTE
 3232:    3357  B4 9F E5                        CJNE    A,#9Fh,DUMP1                    ;Esc
 3233:    335A  D0 03                           POP     03h
 3234:    335C  D0 02                           POP     02h
 3235:    335E  D0 83                           POP     DPH
 3236:    3360  D0 82                           POP     DPL
 3237:    3362  22                              RET
 3238:
 3239:    3363  C0 82           ENTERHEX:       PUSH    DPL
 3240:    3365  C0 83                           PUSH    DPH
 3241:    3367  31 C6           ENTERHEX1:      ACALL   HEXDPTR
 3242:    3369  31 EF                           ACALL   HEXINPBYTE
 3243:    336B  40 06                           JC      ENTERHEX2
 3244:    336D  F0                              MOVX    @DPTR,A
 3245:    336E  A3                              INC     DPTR
 3246:    336F  31 89                           ACALL   PRNTCRLF
 3247:    3371  80 F4                           SJMP    ENTERHEX1
 3248:    3373  D0 83           ENTERHEX2:      POP     DPH
 3249:    3375  D0 82                           POP     DPL
 3250:    3377  22                              RET
 3251:
 3252:    3378  C0 82           ENTERFLOAT:     PUSH    DPL
 3253:    337A  C0 83                           PUSH    DPH
 3254:    337C  90 00 48                        MOV     DPTR,#CONVT
 3255:    337F  51 4F           ENTERFLOAT1:    ACALL   RXBYTE
 3256:    3381  51 66                           ACALL   TXBYTE
 3257:    3383  F0                              MOVX    @DPTR,A
 3258:    3384  A3                              INC     DPTR
 3259:    3385  B4 0D F7                        CJNE    A,#0Dh,ENTERFLOAT1
 3260:    3388  90 00 48                        MOV     DPTR,#CONVT
 3261:    338B  12 23 CB                        LCALL   FLOATING_POINT_INPUT
 3262:    338E  31 D3                           ACALL   HEXDUMPFP
 3263:    3390  D0 83                           POP     DPH
 3264:    3392  D0 82                           POP     DPL
 3265:    3394  22                              RET
 3266:
 3267:    3395  C0 00           MEMDUMP:        PUSH    00h
 3268:    3397  78 00                           MOV     R0,#00h
 3269:    3399  E4              MEMDUMP1:       CLR     A
 3270:    339A  31 92                           ACALL   HEXOUT
 3271:    339C  E8                              MOV     A,R0
 3272:    339D  31 92                           ACALL   HEXOUT
 3273:    339F  74 20                           MOV     A,#20h
 3274:    33A1  51 66                           ACALL   TXBYTE
 3275:    33A3  E6              MEMDUMP2:       MOV     A,@R0
 3276:    33A4  31 92                           ACALL   HEXOUT
 3277:    33A6  74 20                           MOV     A,#20h
 3278:    33A8  51 66                           ACALL   TXBYTE
 3279:    33AA  08                              INC     R0
 3280:    33AB  E8                              MOV     A,R0
 3281:    33AC  54 0F                           ANL     A,#0Fh
 3282:    33AE  70 F3                           JNZ     MEMDUMP2
 3283:    33B0  31 89                           ACALL   PRNTCRLF
 3284:    33B2  E8                              MOV     A,R0
 3285:    33B3  70 E4                           JNZ     MEMDUMP1
 3286:    33B5  D0 00                           POP     00h
 3287:    33B7  22                              RET
 3288:
 3289:    33B8  C0 D0           DUMPSFR:        PUSH    PSW
 3290:    33BA  C2 D3                           CLR     RS0
 3291:    33BC  C2 D4                           CLR     RS1
 3292:    33BE  C0 E0                           PUSH    ACC
 3293:    33C0  C0 00                           PUSH    00h
 3294:    33C2  C0 E0                           PUSH    ACC
 3295:    33C4  12 31 11                        LCALL   PRNTCSTR
 3296:    33C7  0D 0A 53 46                     DB 0Dh,0Ah,'SFR  D7 D6 D5 D4 D3 D2 D1 D0',0Dh,0Ah
          33CB  52 20 20 44
          33CF  37 20 44 36
          33D3  20 44 35 20
          33D7  44 34 20 44
          33DB  33 20 44 32
          33DF  20 44 31 20
          33E3  44 30 0D 0A
 3297:    33E7  2D 2D 2D 2D                     DB '----------------------------',0Dh,0Ah
          33EB  2D 2D 2D 2D
          33EF  2D 2D 2D 2D
          33F3  2D 2D 2D 2D
          33F7  2D 2D 2D 2D
          33FB  2D 2D 2D 2D
          33FF  2D 2D 2D 2D
          3403  0D 0A
 3298:    3405  41 43 43 20                     DB 'ACC ',0
          3409  00
 3299:    340A  D0 E0                           POP     ACC
 3300:    340C  12 31 A7                        LCALL   BINOUT
 3301:    340F  12 31 11                        LCALL   PRNTCSTR
 3302:    3412  42 20 20 20                     DB 'B   ',0
          3416  00
 3303:    3417  E5 F0                           MOV     A,B
 3304:    3419  12 31 A7                        LCALL   BINOUT
 3305:    341C  12 31 11                        LCALL   PRNTCSTR
 3306:    341F  44 50 48 20                     DB 'DPH ',0
          3423  00
 3307:    3424  E5 83                           MOV     A,DPH
 3308:    3426  12 31 A7                        LCALL   BINOUT
 3309:    3429  12 31 11                        LCALL   PRNTCSTR
 3310:    342C  44 50 4C 20                     DB 'DPL ',0
          3430  00
 3311:    3431  E5 82                           MOV     A,DPL
 3312:    3433  12 31 A7                        LCALL   BINOUT
 3313:    3436  12 31 11                        LCALL   PRNTCSTR
 3314:    3439  49 45 20 20                     DB 'IE  ',0
          343D  00
 3315:    343E  E5 A8                           MOV     A,IE
 3316:    3440  12 31 A7                        LCALL   BINOUT
 3317:    3443  12 31 11                        LCALL   PRNTCSTR
 3318:    3446  49 50 20 20                     DB 'IP  ',0
          344A  00
 3319:    344B  E5 B8                           MOV     A,IP
 3320:    344D  12 31 A7                        LCALL   BINOUT
 3321:    3450  12 31 11                        LCALL   PRNTCSTR
 3322:    3453  50 30 20 20                     DB 'P0  ',0
          3457  00
 3323:    3458  E5 80                           MOV     A,P0
 3324:    345A  12 31 A7                        LCALL   BINOUT
 3325:    345D  12 31 11                        LCALL   PRNTCSTR
 3326:    3460  50 31 20 20                     DB 'P1  ',0
          3464  00
 3327:    3465  E5 90                           MOV     A,P1
 3328:    3467  12 31 A7                        LCALL   BINOUT
 3329:    346A  12 31 11                        LCALL   PRNTCSTR
 3330:    346D  50 32 20 20                     DB 'P2  ',0
          3471  00
 3331:    3472  E5 A0                           MOV     A,P2
 3332:    3474  12 31 A7                        LCALL   BINOUT
 3333:    3477  12 31 11                        LCALL   PRNTCSTR
 3334:    347A  50 33 20 20                     DB 'P3  ',0
          347E  00
 3335:    347F  E5 B0                           MOV     A,P3
 3336:    3481  12 31 A7                        LCALL   BINOUT
 3337:    3484  12 31 11                        LCALL   PRNTCSTR
 3338:    3487  50 43 4F 4E                     DB 'PCON',0
          348B  00
 3339:    348C  E5 87                           MOV     A,PCON
 3340:    348E  12 31 A7                        LCALL   BINOUT
 3341:    3491  12 31 11                        LCALL   PRNTCSTR
 3342:    3494  50 53 57 20                     DB 'PSW ',0
          3498  00
 3343:    3499  E5 D0                           MOV     A,PSW
 3344:    349B  12 31 A7                        LCALL   BINOUT
 3345:    349E  12 31 11                        LCALL   PRNTCSTR
 3346:    34A1  53 42 55 46                     DB 'SBUF',0
          34A5  00
 3347:    34A6  E5 99                           MOV     A,SBUF
 3348:    34A8  12 31 A7                        LCALL   BINOUT
 3349:    34AB  12 31 11                        LCALL   PRNTCSTR
 3350:    34AE  53 43 4F 4E                     DB 'SCON',0
          34B2  00
 3351:    34B3  E5 98                           MOV     A,SCON
 3352:    34B5  12 31 A7                        LCALL   BINOUT
 3353:    34B8  12 31 11                        LCALL   PRNTCSTR
 3354:    34BB  53 50 20 20                     DB 'SP  ',0
          34BF  00
 3355:    34C0  E5 81                           MOV     A,SP
 3356:    34C2  12 31 A7                        LCALL   BINOUT
 3357:    34C5  12 31 11                        LCALL   PRNTCSTR
 3358:    34C8  54 43 4F 4E                     DB 'TCON',0
          34CC  00
 3359:    34CD  E5 88                           MOV     A,TCON
 3360:    34CF  12 31 A7                        LCALL   BINOUT
 3361:    34D2  12 31 11                        LCALL   PRNTCSTR
 3362:    34D5  54 48 30 20                     DB 'TH0 ',0
          34D9  00
 3363:    34DA  E5 8C                           MOV     A,TH0
 3364:    34DC  12 31 A7                        LCALL   BINOUT
 3365:    34DF  12 31 11                        LCALL   PRNTCSTR
 3366:    34E2  54 48 31 20                     DB 'TH1 ',0
          34E6  00
 3367:    34E7  E5 8D                           MOV     A,TH1
 3368:    34E9  12 31 A7                        LCALL   BINOUT
 3369:    34EC  12 31 11                        LCALL   PRNTCSTR
 3370:    34EF  54 4C 30 20                     DB 'TL0 ',0
          34F3  00
 3371:    34F4  E5 8A                           MOV     A,TL0
 3372:    34F6  12 31 A7                        LCALL   BINOUT
 3373:    34F9  12 31 11                        LCALL   PRNTCSTR
 3374:    34FC  54 4C 31 20                     DB 'TL1 ',0
          3500  00
 3375:    3501  E5 8B                           MOV     A,TL1
 3376:    3503  12 31 A7                        LCALL   BINOUT
 3377:    3506  12 31 11                        LCALL   PRNTCSTR
 3378:    3509  54 4D 4F 44                     DB 'TMOD',0
          350D  00
 3379:    350E  E5 89                           MOV     A,TMOD
 3380:    3510  12 31 A7                        LCALL   BINOUT
 3381:    3513  D0 00                           POP     00h
 3382:    3515  D0 E0                           POP     ACC
 3383:    3517  D0 D0                           POP     PSW
 3384:    3519  22                              RET
 3385:
 3386:    351A  7B 40           LOAD1K:         MOV     R3,#40h
 3387:    351C  51 3F           LOAD1K1:        ACALL   RX16BYTES                       ;Read 16 bytes from cmd file
 3388:    351E  E6              LOAD1K2:        MOV     A,@R0
 3389:    351F  F0                              MOVX    @DPTR,A
 3390:    3520  A3                              INC     DPTR
 3391:    3521  08                              INC     R0
 3392:    3522  E8                              MOV     A,R0
 3393:    3523  64 50                           XRL     A,#50h
 3394:    3525  70 F7                           JNZ     LOAD1K2                         ;Not 16 bytes yet
 3395:    3527  DB F3                           DJNZ    R3,LOAD1K1                      ;Not 1K yet
 3396:    3529  74 2E                           MOV     A,#'.'
 3397:    352B  51 66                           ACALL   TXBYTE
 3398:    352D  22                              RET
 3399:
 3400:    352E  C0 82           LOAD:           PUSH    DPL
 3401:    3530  C0 83                           PUSH    DPH
 3402:    3532  C0 00                           PUSH    00h
 3403:    3534  C0 03                           PUSH    03h
 3404:    3536  C0 04                           PUSH    04h
 3405:    3538  31 11                           ACALL   PRNTCSTR
 3406:    353A  4C 6F 61 64                     DB      'Loading .',0
          353E  69 6E 67 20
          3542  2E 00
 3407:    3544  7C 08                           MOV     R4,#08h
 3408:    3546  B1 1A           LOAD10:         ACALL   LOAD1K
 3409:    3548  DC FC                           DJNZ    R4,LOAD10
 3410:    354A  74 06                           MOV     A,#06h
 3411:    354C  51 66                           ACALL   TXBYTE                          ;End read 16 bytes from cmd file
 3412:    354E  31 89                           ACALL   PRNTCRLF
 3413:    3550  D0 04                           POP     04h
 3414:    3552  D0 03                           POP     03h
 3415:    3554  D0 00                           POP     00h
 3416:    3556  D0 83                           POP     DPH
 3417:    3558  D0 82                           POP     DPL
 3418:    355A  22                              RET
 3419:
 3420:    355B  B1 2E           GO:             ACALL   LOAD
 3421:    355D  E4              RUN:            CLR     A
 3422:    355E  73                              JMP     @A+DPTR
 3423:
 3424:                          ;ROM menu selection
 3425:                          ;------------------------------------------------------------------
 3426:
 3427:    355F  B1 D4           EPROM:          ACALL   ROMMENU
 3428:    3561  B4 94 6F                        CJNE    A,#94h,EPROMEXIT
 3429:    3564  12 38 67                        LCALL   ROMINSERT
 3430:    3567  40 F6                           JC      EPROM
 3431:    3569  12 3C A7                        LCALL   ROMINIT                         ;Turn on VCC, pull RST high and init programming mode
 3432:    356C  40 F1                           JC      EPROM                           ;Initialisation failed
 3433:    356E  E5 53                           MOV     A,ROMACTION
 3434:    3570  14                              DEC     A
 3435:    3571  70 12                           JNZ     EPROM2
 3436:                                          ;Test erased
 3437:    3573  12 39 11                        LCALL   ROMWAIT
 3438:    3576  E5 55                           MOV     A,ROMMODE
 3439:    3578  14                              DEC     A
 3440:    3579  70 05                           JNZ     EPROM1
 3441:    357B  12 39 21                        LCALL   BM_ROMERASED
 3442:    357E  80 DF                           SJMP    EPROM
 3443:    3580  12 3A 06        EPROM1:         LCALL   PM_ROMERASED
 3444:    3583  80 DA                           SJMP    EPROM
 3445:    3585  14              EPROM2:         DEC     A
 3446:    3586  70 12                           JNZ     EPROM3
 3447:                                          ;Dump to hex file
 3448:    3588  12 39 11                        LCALL   ROMWAIT
 3449:    358B  E5 55                           MOV     A,ROMMODE
 3450:    358D  14                              DEC     A
 3451:    358E  70 05                           JNZ     EPROM21
 3452:    3590  12 39 6D                        LCALL   BM_ROMDUMPF
 3453:    3593  80 CA                           SJMP    EPROM
 3454:    3595  12 3A 5D        EPROM21:        LCALL   PM_ROMDUMPF
 3455:    3598  80 C5                           SJMP    EPROM
 3456:    359A  14              EPROM3:         DEC     A
 3457:    359B  70 0F                           JNZ     EPROM4
 3458:                                          ;Dump to screen
 3459:    359D  E5 55                           MOV     A,ROMMODE
 3460:    359F  14                              DEC     A
 3461:    35A0  70 05                           JNZ     EPROM31
 3462:    35A2  12 39 99                        LCALL   BM_ROMDUMPS
 3463:    35A5  80 B8                           SJMP    EPROM
 3464:    35A7  12 3A 95        EPROM31:        LCALL   PM_ROMDUMPS
 3465:    35AA  80 B3                           SJMP    EPROM
 3466:    35AC  14              EPROM4:         DEC     A
 3467:    35AD  70 12                           JNZ     EPROM5
 3468:                                          ;Verify
 3469:    35AF  12 39 11                        LCALL   ROMWAIT
 3470:    35B2  E5 55                           MOV     A,ROMMODE
 3471:    35B4  14                              DEC     A
 3472:    35B5  70 05                           JNZ     EPROM41
 3473:    35B7  12 39 C6                        LCALL   BM_ROMVERIFY
 3474:    35BA  80 A3                           SJMP    EPROM
 3475:    35BC  12 3A CD        EPROM41:        LCALL   PM_ROMVERIFY
 3476:    35BF  80 9E                           SJMP    EPROM
 3477:    35C1                  EPROM5:         ;Program
 3478:    35C1  12 39 11                        LCALL   ROMWAIT
 3479:    35C4  E5 55                           MOV     A,ROMMODE
 3480:    35C6  14                              DEC     A
 3481:    35C7  70 05                           JNZ     EPROM51
 3482:    35C9  12 3B 44                        LCALL   PM_ROMPROG
 3483:    35CC  80 91                           SJMP    EPROM
 3484:    35CE  12 3B 44        EPROM51:        LCALL   PM_ROMPROG
 3485:    35D1  80 8C                           SJMP    EPROM
 3486:    35D3  22              EPROMEXIT:      RET
 3487:
 3488:    35D4  31 11           ROMMENU:        ACALL   PRNTCSTR
 3489:    35D6  0E                              DB      0Eh
 3490:    35D7  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          35DB  2D 2D 2D 2D
          35DF  2D 2D 2D 2D
          35E3  2D 2D 2D 2D
          35E7  2D 2D 2D 2D
          35EB  20 20 2D 2D
          35EF  2D 2D 2D 2D
          35F3  2D 2D 2D 2D
          35F7  2D 2D 2D 2D
          35FB  2D 2D 2D 20
          35FF  20 2D 2D 2D
          3603  2D 2D 2D 2D
          3607  2D 2D 2D 2D
          360B  2D 2D 2D 2D
          360F  2D 2D 0D 0A
 3491:    3613  20 20 20 7C                     DB      '   |  Action       |  |  EEPROM size  |  |  Mode         |',0Dh,0Ah
          3617  20 20 41 63
          361B  74 69 6F 6E
          361F  20 20 20 20
          3623  20 20 20 7C
          3627  20 20 7C 20
          362B  20 45 45 50
          362F  52 4F 4D 20
          3633  73 69 7A 65
          3637  20 20 7C 20
          363B  20 7C 20 20
          363F  4D 6F 64 65
          3643  20 20 20 20
          3647  20 20 20 20
          364B  20 7C 0D 0A
 3492:    364F  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          3653  2D 2D 2D 2D
          3657  2D 2D 2D 2D
          365B  2D 2D 2D 2D
          365F  2D 2D 2D 2D
          3663  20 20 2D 2D
          3667  2D 2D 2D 2D
          366B  2D 2D 2D 2D
          366F  2D 2D 2D 2D
          3673  2D 2D 2D 20
          3677  20 2D 2D 2D
          367B  2D 2D 2D 2D
          367F  2D 2D 2D 2D
          3683  2D 2D 2D 2D
          3687  2D 2D 0D 0A
 3493:    368B  20 20 20 7C                     DB      '   |  Test erased  |  |  4K           |  |  Byte         |',0Dh,0Ah
          368F  20 20 54 65
          3693  73 74 20 65
          3697  72 61 73 65
          369B  64 20 20 7C
          369F  20 20 7C 20
          36A3  20 34 4B 20
          36A7  20 20 20 20
          36AB  20 20 20 20
          36AF  20 20 7C 20
          36B3  20 7C 20 20
          36B7  42 79 74 65
          36BB  20 20 20 20
          36BF  20 20 20 20
          36C3  20 7C 0D 0A
 3494:    36C7  20 20 20 7C                     DB      '   |  Filedump     |  |  8K           |  |  Page         |',0Dh,0Ah
          36CB  20 20 46 69
          36CF  6C 65 64 75
          36D3  6D 70 20 20
          36D7  20 20 20 7C
          36DB  20 20 7C 20
          36DF  20 38 4B 20
          36E3  20 20 20 20
          36E7  20 20 20 20
          36EB  20 20 7C 20
          36EF  20 7C 20 20
          36F3  50 61 67 65
          36F7  20 20 20 20
          36FB  20 20 20 20
          36FF  20 7C 0D 0A
 3495:    3703  20 20 20 7C                     DB      '   |  Screendump   |  |  16K          |  |               |',0Dh,0Ah
          3707  20 20 53 63
          370B  72 65 65 6E
          370F  64 75 6D 70
          3713  20 20 20 7C
          3717  20 20 7C 20
          371B  20 31 36 4B
          371F  20 20 20 20
          3723  20 20 20 20
          3727  20 20 7C 20
          372B  20 7C 20 20
          372F  20 20 20 20
          3733  20 20 20 20
          3737  20 20 20 20
          373B  20 7C 0D 0A
 3496:    373F  20 20 20 7C                     DB      '   |  Verify       |  |  32K          |  |               |',0Dh,0Ah
          3743  20 20 56 65
          3747  72 69 66 79
          374B  20 20 20 20
          374F  20 20 20 7C
          3753  20 20 7C 20
          3757  20 33 32 4B
          375B  20 20 20 20
          375F  20 20 20 20
          3763  20 20 7C 20
          3767  20 7C 20 20
          376B  20 20 20 20
          376F  20 20 20 20
          3773  20 20 20 20
          3777  20 7C 0D 0A
 3497:    377B  20 20 20 7C                     DB      '   |  Program      |  |  64K          |  |               |',0Dh,0Ah
          377F  20 20 50 72
          3783  6F 67 72 61
          3787  6D 20 20 20
          378B  20 20 20 7C
          378F  20 20 7C 20
          3793  20 36 34 4B
          3797  20 20 20 20
          379B  20 20 20 20
          379F  20 20 7C 20
          37A3  20 7C 20 20
          37A7  20 20 20 20
          37AB  20 20 20 20
          37AF  20 20 20 20
          37B3  20 7C 0D 0A
 3498:    37B7  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          37BB  2D 2D 2D 2D
          37BF  2D 2D 2D 2D
          37C3  2D 2D 2D 2D
          37C7  2D 2D 2D 2D
          37CB  20 20 2D 2D
          37CF  2D 2D 2D 2D
          37D3  2D 2D 2D 2D
          37D7  2D 2D 2D 2D
          37DB  2D 2D 2D 20
          37DF  20 2D 2D 2D
          37E3  2D 2D 2D 2D
          37E7  2D 2D 2D 2D
          37EB  2D 2D 2D 2D
          37EF  2D 2D 0D 0A
 3499:    37F3  00                              DB      00h
 3500:    37F4  78 54                           MOV     R0,#ROMSIZE
 3501:    37F6  12 38 4A                        LCALL   MENUSET
 3502:    37F9  08                              INC     R0
 3503:    37FA  12 38 4A                        LCALL   MENUSET
 3504:    37FD  78 53                           MOV     R0,#ROMACTION
 3505:    37FF  11 02                           ACALL   MENUXP
 3506:    3801  22                              RET
 3507:
 3508:    3802  12 38 4A        MENUXP:         LCALL   MENUSET
 3509:    3805  74 08                           MOV     A,#08h
 3510:    3807  12 32 66                        LCALL   TXBYTE
 3511:    380A  12 32 4F                        LCALL   RXBYTE
 3512:    380D  B4 9A 0C                        CJNE    A,#9Ah,MENUXP1
 3513:    3810  E6                              MOV     A,@R0
 3514:    3811  14                              DEC     A
 3515:    3812  60 EE                           JZ      MENUXP
 3516:    3814  74 20                           MOV     A,#20h
 3517:    3816  12 32 66                        LCALL   TXBYTE
 3518:    3819  16                              DEC     @R0
 3519:    381A  80 E6                           SJMP    MENUXP
 3520:    381C  B4 9B 0D        MENUXP1:        CJNE    A,#9Bh,MENUXP2
 3521:    381F  E6                              MOV     A,@R0
 3522:    3820  94 05                           SUBB    A,#05h
 3523:    3822  60 DE                           JZ      MENUXP
 3524:    3824  74 20                           MOV     A,#20h
 3525:    3826  12 32 66                        LCALL   TXBYTE
 3526:    3829  06                              INC     @R0
 3527:    382A  80 D6                           SJMP    MENUXP
 3528:    382C  B4 9C 08        MENUXP2:        CJNE    A,#9Ch,MENUYP1
 3529:    382F  E8                              MOV     A,R0
 3530:    3830  94 55                           SUBB    A,#ROMMODE
 3531:    3832  60 CE                           JZ      MENUXP
 3532:    3834  08                              INC     R0
 3533:    3835  80 CB                           SJMP    MENUXP
 3534:    3837  B4 9D 08        MENUYP1:        CJNE    A,#9Dh,MENUYP2
 3535:    383A  E8                              MOV     A,R0
 3536:    383B  94 53                           SUBB    A,#ROMACTION
 3537:    383D  60 C3                           JZ      MENUXP
 3538:    383F  18                              DEC     R0
 3539:    3840  80 C0                           SJMP    MENUXP
 3540:    3842  B4 9F 01        MENUYP2:        CJNE    A,#9Fh,MENUYP3                  ;Esc
 3541:    3845  22                              RET
 3542:    3846  B4 94 B9        MENUYP3:        CJNE    A,#94h,MENUXP                   ;Insert
 3543:    3849  22                              RET
 3544:
 3545:    384A  74 0B           MENUSET:        MOV     A,#0Bh
 3546:    384C  12 32 66                        LCALL   TXBYTE
 3547:    384F  E6                              MOV     A,@R0
 3548:    3850  24 22                           ADD     A,#22h
 3549:    3852  12 32 66                        LCALL   TXBYTE
 3550:    3855  E8                              MOV     A,R0
 3551:    3856  94 53                           SUBB    A,#ROMACTION
 3552:    3858  75 F0 13                        MOV     B,#13h
 3553:    385B  A4                              MUL     AB
 3554:    385C  24 24                           ADD     A,#24h
 3555:    385E  12 32 66                        LCALL   TXBYTE
 3556:    3861  74 FB                           MOV     A,#0FBh                         ;
 3557:    3863  12 32 66                        LCALL   TXBYTE
 3558:    3866  22                              RET
 3559:
 3560:                          ;------------------------------------------------------------------
 3561:
 3562:    3867  12 3C 57        ROMINSERT:      LCALL   ROMOFF
 3563:    386A  12 31 11                        LCALL   PRNTCSTR
 3564:    386D  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Insert ',00h
          3871  6E 73 65 72
          3875  74 20 00
 3565:    3878  E5 54                           MOV     A,ROMSIZE
 3566:    387A  14                              DEC     A
 3567:    387B  70 09                           JNZ     ROMINSERT1
 3568:    387D  12 31 11                        LCALL   PRNTCSTR
 3569:    3880  34 4B 00                        DB      '4K',00h
 3570:    3883  75 52 10                        MOV     ROMPAGES,#10h                   ;16 Pages
 3571:    3886  14              ROMINSERT1:     DEC     A
 3572:    3887  70 09                           JNZ     ROMINSERT2
 3573:    3889  12 31 11                        LCALL   PRNTCSTR
 3574:    388C  38 4B 00                        DB      '8K',00h
 3575:    388F  75 52 20                        MOV     ROMPAGES,#20h                   ;32 Pages
 3576:    3892  14              ROMINSERT2:     DEC     A
 3577:    3893  70 0A                           JNZ     ROMINSERT3
 3578:    3895  12 31 11                        LCALL   PRNTCSTR
 3579:    3898  31 36 4B 00                     DB      '16K',00h
 3580:    389C  75 52 40                        MOV     ROMPAGES,#40h                   ;64 Pages
 3581:    389F  14              ROMINSERT3:     DEC     A
 3582:    38A0  70 0A                           JNZ     ROMINSERT4
 3583:    38A2  12 31 11                        LCALL   PRNTCSTR
 3584:    38A5  33 32 4B 00                     DB      '32K',00h
 3585:    38A9  75 52 80                        MOV     ROMPAGES,#80h                   ;128 Pages
 3586:    38AC  14              ROMINSERT4:     DEC     A
 3587:    38AD  70 0A                           JNZ     ROMINSERT5
 3588:    38AF  12 31 11                        LCALL   PRNTCSTR
 3589:    38B2  36 34 4B 00                     DB      '64K',00h
 3590:    38B6  75 52 00                        MOV     ROMPAGES,#00h                   ;256 Pages
 3591:    38B9  12 31 11        ROMINSERT5:     LCALL   PRNTCSTR
 3592:    38BC  20 64 65 76                     DB      ' device and strike <Enter> ',00h
          38C0  69 63 65 20
          38C4  61 6E 64 20
          38C8  73 74 72 69
          38CC  6B 65 20 3C
          38D0  45 6E 74 65
          38D4  72 3E 20 00
 3593:    38D8  12 32 4F                        LCALL   RXBYTE
 3594:    38DB  B4 9F 02                        CJNE    A,#9Fh,ROMINSERT6               ;Esc
 3595:    38DE  D3                              SETB    C
 3596:    38DF  22                              RET
 3597:    38E0  12 31 11        ROMINSERT6:     LCALL   PRNTCSTR
 3598:    38E3  0B 2A 23 20                     DB      0Bh,2Ah,23h,'                                       '
          38E7  20 20 20 20
          38EB  20 20 20 20
          38EF  20 20 20 20
          38F3  20 20 20 20
          38F7  20 20 20 20
          38FB  20 20 20 20
          38FF  20 20 20 20
          3903  20 20 20 20
          3907  20 20 20 20
          390B  20 20
 3599:    390D  0D 00                           DB      0Dh,00h
 3600:    390F  C3                              CLR     C
 3601:    3910  22                              RET
 3602:
 3603:    3911  12 31 11        ROMWAIT:        LCALL   PRNTCSTR
 3604:    3914  0B 2A 23 57                     DB      0Bh,2Ah,23h,'Wait ...',00h
          3918  61 69 74 20
          391C  2E 2E 2E 00
 3605:    3920  22                              RET
 3606:
 3607:
 3608:                          ;Byte mode
 3609:                          ;------------------------------------------------------------------
 3610:
 3611:    3921  12 3C B7        BM_ROMERASED:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3612:    3924  B4 FF 0E                        CJNE    A,#0FFh,BM_ROMERASED1           ;Not erased
 3613:    3927  A3                              INC     DPTR                            ;Next address
 3614:    3928  E5 82                           MOV     A,DPL
 3615:    392A  70 F5                           JNZ     BM_ROMERASED                    ;Jump if more bytes in this page
 3616:    392C  E5 83                           MOV     A,DPH
 3617:    392E  B5 52 F0                        CJNE    A,ROMPAGES,BM_ROMERASED         ;Jump if more pages
 3618:    3931  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3619:    3934  22                              RET
 3620:    3935  12 3C 57        BM_ROMERASED1:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3621:    3938  12 31 11                        LCALL   PRNTCSTR
 3622:    393B  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          393F  79 74 65 20
          3943  61 74 20 00
 3623:    3947  E5 83                           MOV     A,DPH
 3624:    3949  12 31 92                        LCALL   HEXOUT                          ;High address
 3625:    394C  E5 82                           MOV     A,DPL
 3626:    394E  12 31 92                        LCALL   HEXOUT                          ;Low address
 3627:    3951  12 31 11                        LCALL   PRNTCSTR
 3628:    3954  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          3958  20 65 72 61
          395C  73 65 64 20
          3960  3C 45 6E 74
          3964  65 72 3E 20
          3968  00
 3629:    3969  12 32 4F                        LCALL   RXBYTE                          ;Wait for keypress
 3630:    396C  22                              RET
 3631:
 3632:    396D  74 03           BM_ROMDUMPF:    MOV     A,#03h
 3633:    396F  12 32 66                        LCALL   TXBYTE                          ;Init write to file
 3634:    3972  12 3C B7        BM_ROMDUMPF1:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3635:    3975  12 31 92                        LCALL   HEXOUT                          ;Output as hex
 3636:    3978  74 20                           MOV     A,#20h
 3637:    397A  12 32 66                        LCALL   TXBYTE                          ;Output a space
 3638:    397D  A3                              INC     DPTR
 3639:    397E  E5 82                           MOV     A,DPL
 3640:    3980  54 0F                           ANL     A,#0Fh
 3641:    3982  70 03                           JNZ     BM_ROMDUMPF2                    ;Still on same line
 3642:    3984  12 31 89                        LCALL   PRNTCRLF                        ;Output CRLF
 3643:    3987  E5 82           BM_ROMDUMPF2:   MOV     A,DPL
 3644:    3989  70 E7                           JNZ     BM_ROMDUMPF1                    ;Jump if more bytes in this page
 3645:    398B  E5 83                           MOV     A,DPH
 3646:    398D  B5 52 E2                        CJNE    A,ROMPAGES,BM_ROMDUMPF1         ;Jump if more pages
 3647:    3990  74 04                           MOV     A,#04h
 3648:    3992  12 32 66                        LCALL   TXBYTE                          ;End write to file
 3649:    3995  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3650:    3998  22              BM_ROMDUMPF3:   RET
 3651:
 3652:    3999  12 3C B7        BM_ROMDUMPS:    LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3653:    399C  12 31 92                        LCALL   HEXOUT                          ;Output as hex
 3654:    399F  74 20                           MOV     A,#20h
 3655:    39A1  12 32 66                        LCALL   TXBYTE                          ;Output a space
 3656:    39A4  A3                              INC     DPTR                            ;Next ROM address
 3657:    39A5  E5 82                           MOV     A,DPL
 3658:    39A7  54 0F                           ANL     A,#0Fh
 3659:    39A9  70 03                           JNZ     BM_ROMDUMPS1                    ;Jump if still on same line
 3660:    39AB  12 31 89                        LCALL   PRNTCRLF                        ;Output CRLF
 3661:    39AE  E5 82           BM_ROMDUMPS1:   MOV     A,DPL
 3662:    39B0  70 E7                           JNZ     BM_ROMDUMPS                     ;Jump if more bytes in this page
 3663:    39B2  12 31 89                        LCALL   PRNTCRLF                        ;Output CRLF
 3664:    39B5  12 32 4F                        LCALL   RXBYTE                          ;Wait for a keypress
 3665:    39B8  B4 9F 02                        CJNE    A,#9Fh,BM_ROMDUMPS2
 3666:    39BB  80 05                           SJMP    BM_ROMDUMPS3
 3667:    39BD  E5 83           BM_ROMDUMPS2:   MOV     A,DPH
 3668:    39BF  B5 52 D7                        CJNE    A,ROMPAGES,BM_ROMDUMPS          ;Jump if more pages
 3669:    39C2  12 3C 57        BM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3670:    39C5  22                              RET
 3671:
 3672:    39C6  C0 00           BM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3673:    39C8  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3674:    39CB  12 32 3F                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3675:    39CE  86 51           BM_ROMVERIFY1:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3676:    39D0  12 3C B7                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3677:    39D3  B5 51 1D                        CJNE    A,ROMVER,BM_ROMVERIFY4          ;Compare and jump if not equal
 3678:    39D6  08              BM_ROMVERIFY2:  INC     R0                              ;Increment buffer pointer
 3679:    39D7  E8                              MOV     A,R0
 3680:    39D8  B4 50 03                        CJNE    A,#50h,BM_ROMVERIFY3            ;Jump if not last byte in buffer
 3681:    39DB  12 32 3F                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3682:    39DE  A3              BM_ROMVERIFY3:  INC     DPTR                            ;Next ROM address
 3683:    39DF  E5 82                           MOV     A,DPL
 3684:    39E1  70 EB                           JNZ     BM_ROMVERIFY1                   ;Jump if still on same page
 3685:    39E3  E5 83                           MOV     A,DPH
 3686:    39E5  B5 52 E6                        CJNE    A,ROMPAGES,BM_ROMVERIFY1        ;Jump if more pages
 3687:    39E8  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3688:    39EB  74 06                           MOV     A,#06h
 3689:    39ED  12 32 66                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3690:    39F0  D0 00                           POP     00h                             ;Restore R0
 3691:    39F2  22                              RET
 3692:    39F3  12 3C CC        BM_ROMVERIFY4:  LCALL   ROMVERIFYERR
 3693:    39F6  50 DE                           JNC     BM_ROMVERIFY2                   ;Jump if less than 16 errors
 3694:    39F8  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3695:    39FB  74 06                           MOV     A,#06h
 3696:    39FD  12 32 66                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3697:    3A00  12 32 4F                        LCALL   RXBYTE                          ;Wait for a keypress
 3698:    3A03  D0 00                           POP     00h                             ;Restore R0
 3699:    3A05  22                              RET
 3700:
 3701:                          ;Page mode
 3702:                          ;------------------------------------------------------------------
 3703:
 3704:    3A06  74 30           PM_ROMERASED:   MOV     A,#30h
 3705:    3A08  12 3C 2F                        LCALL   ISPCOMM                         ;Init read page mode
 3706:    3A0B  E5 83                           MOV     A,DPH
 3707:    3A0D  12 3C 2F                        LCALL   ISPCOMM                         ;Send high address
 3708:    3A10  E4              PM_ROMERASED1:  CLR     A
 3709:    3A11  12 3C 2F                        LCALL   ISPCOMM                         ;Get byte from ROM
 3710:    3A14  B4 FF 0E                        CJNE    A,#0FFh,PM_ROMERASED2           ;Jump if not erased
 3711:    3A17  A3                              INC     DPTR
 3712:    3A18  E5 82                           MOV     A,DPL
 3713:    3A1A  70 F4                           JNZ     PM_ROMERASED1                   ;Jump if more bytes on this page
 3714:    3A1C  E5 83                           MOV     A,DPH
 3715:    3A1E  B5 52 E5                        CJNE    A,ROMPAGES,PM_ROMERASED         ;Jump if more pagees
 3716:    3A21  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3717:    3A24  22                              RET
 3718:    3A25  12 3C 57        PM_ROMERASED2:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3719:    3A28  12 31 11                        LCALL   PRNTCSTR
 3720:    3A2B  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          3A2F  79 74 65 20
          3A33  61 74 20 00
 3721:    3A37  E5 83                           MOV     A,DPH
 3722:    3A39  12 31 92                        LCALL   HEXOUT                          ;Output high address as hex
 3723:    3A3C  E5 82                           MOV     A,DPL
 3724:    3A3E  12 31 92                        LCALL   HEXOUT                          ;Output low address as hex
 3725:    3A41  12 31 11                        LCALL   PRNTCSTR
 3726:    3A44  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          3A48  20 65 72 61
          3A4C  73 65 64 20
          3A50  3C 45 6E 74
          3A54  65 72 3E 20
          3A58  00
 3727:    3A59  12 32 4F                        LCALL   RXBYTE                          ;Wait for a keypress
 3728:    3A5C  22                              RET
 3729:
 3730:    3A5D  74 03           PM_ROMDUMPF:    MOV     A,#03h
 3731:    3A5F  12 32 66                        LCALL   TXBYTE                          ;Init Output to hex file
 3732:    3A62  74 30           PM_ROMDUMPF1:   MOV     A,#30h
 3733:    3A64  12 3C 2F                        LCALL   ISPCOMM                         ;Init read page mode
 3734:    3A67  E5 83                           MOV     A,DPH
 3735:    3A69  12 3C 2F                        LCALL   ISPCOMM                         ;Send high address
 3736:    3A6C  E4              PM_ROMDUMPF2:   CLR     A
 3737:    3A6D  12 3C 2F                        LCALL   ISPCOMM                         ;Get byte from ROM
 3738:    3A70  12 31 92                        LCALL   HEXOUT                          ;Output as hex
 3739:    3A73  74 20                           MOV     A,#20h
 3740:    3A75  12 32 66                        LCALL   TXBYTE                          ;Output a space
 3741:    3A78  A3                              INC     DPTR
 3742:    3A79  E5 82                           MOV     A,DPL
 3743:    3A7B  54 0F                           ANL     A,#0Fh
 3744:    3A7D  B4 00 07                        CJNE    A,#00h,PM_ROMDUMPF3             ;Jump if more bytes in this line
 3745:    3A80  12 31 89                        LCALL   PRNTCRLF                        ;Output CRLF
 3746:    3A83  E5 82                           MOV     A,DPL
 3747:    3A85  70 E5                           JNZ     PM_ROMDUMPF2                    ;Jump if more bytes in this page
 3748:    3A87  E5 83           PM_ROMDUMPF3:   MOV     A,DPH
 3749:    3A89  B5 52 D6                        CJNE    A,ROMPAGES,PM_ROMDUMPF1         ;Jump if more pages
 3750:    3A8C  74 04                           MOV     A,#04h
 3751:    3A8E  12 32 66                        LCALL   TXBYTE                          ;End Output to hex file
 3752:    3A91  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3753:    3A94  22                              RET
 3754:
 3755:    3A95  74 30           PM_ROMDUMPS:    MOV     A,#30h
 3756:    3A97  12 3C 2F                        LCALL   ISPCOMM                         ;Init read page mode
 3757:    3A9A  E5 83                           MOV     A,DPH
 3758:    3A9C  12 3C 2F                        LCALL   ISPCOMM                         ;Send high address
 3759:    3A9F  E4              PM_ROMDUMPS1:   CLR     A
 3760:    3AA0  12 3C 2F                        LCALL   ISPCOMM                         ;Get byte from ROM
 3761:    3AA3  12 31 92                        LCALL   HEXOUT                          ;Output as hex
 3762:    3AA6  74 20                           MOV     A,#20h
 3763:    3AA8  12 32 66                        LCALL   TXBYTE                          ;Output a space
 3764:    3AAB  A3                              INC     DPTR
 3765:    3AAC  E5 82                           MOV     A,DPL
 3766:    3AAE  54 0F                           ANL     A,#0Fh
 3767:    3AB0  70 12                           JNZ     PM_ROMDUMPS2                    ;Jump if still on same line
 3768:    3AB2  12 31 89                        LCALL   PRNTCRLF                        ;Output CRLF
 3769:    3AB5  E5 82                           MOV     A,DPL
 3770:    3AB7  70 E6                           JNZ     PM_ROMDUMPS1                    ;Jump if more bytes on this page
 3771:    3AB9  12 31 89                        LCALL   PRNTCRLF                        ;Output CRLF
 3772:    3ABC  12 32 4F                        LCALL   RXBYTE                          ;Wait for a keypress
 3773:    3ABF  B4 9F 02                        CJNE    A,#9Fh,PM_ROMDUMPS2
 3774:    3AC2  80 05                           SJMP    PM_ROMDUMPS3                    ;Esc pressed
 3775:    3AC4  E5 83           PM_ROMDUMPS2:   MOV     A,DPH
 3776:    3AC6  B5 52 CC                        CJNE    A,ROMPAGES,PM_ROMDUMPS          ;Jump if more pages
 3777:    3AC9  12 3C 57        PM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3778:    3ACC  22                              RET
 3779:
 3780:    3ACD  C0 00           PM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3781:    3ACF  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3782:    3AD2  12 32 3F                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3783:    3AD5  74 30           PM_ROMVERIFY1:  MOV     A,#30h
 3784:    3AD7  12 3C 2F                        LCALL   ISPCOMM                         ;Init read page mode
 3785:    3ADA  E5 83                           MOV     A,DPH
 3786:    3ADC  12 3C 2F                        LCALL   ISPCOMM                         ;Send high address
 3787:    3ADF  86 51           PM_ROMVERIFY2:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3788:    3AE1  E4                              CLR     A
 3789:    3AE2  12 3C 2F                        LCALL   ISPCOMM                         ;Get byte from ROM
 3790:    3AE5  B5 51 1D                        CJNE    A,ROMVER,PM_ROMVERIFY5          ;Compare and jump if not equal
 3791:    3AE8  08              PM_ROMVERIFY3:  INC     R0                              ;Increment buffer pointer
 3792:    3AE9  E8                              MOV     A,R0
 3793:    3AEA  B4 50 03                        CJNE    A,#50h,PM_ROMVERIFY4            ;Jump if not last byte in buffer
 3794:    3AED  12 32 3F                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3795:    3AF0  A3              PM_ROMVERIFY4:  INC     DPTR
 3796:    3AF1  E5 82                           MOV     A,DPL
 3797:    3AF3  70 EA                           JNZ     PM_ROMVERIFY2                   ;Jump if still on same page
 3798:    3AF5  E5 83                           MOV     A,DPH
 3799:    3AF7  B5 52 DB                        CJNE    A,ROMPAGES,PM_ROMVERIFY1        ;Jump if more pages
 3800:    3AFA  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3801:    3AFD  74 06                           MOV     A,#06h
 3802:    3AFF  12 32 66                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3803:    3B02  D0 00                           POP     00h                             ;Restore R0
 3804:    3B04  22                              RET
 3805:    3B05  12 3C CC        PM_ROMVERIFY5:  LCALL   ROMVERIFYERR
 3806:    3B08  50 DE                           JNC     PM_ROMVERIFY3                   ;Jump if less than 16 errors
 3807:    3B0A  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3808:    3B0D  74 06                           MOV     A,#06h
 3809:    3B0F  12 32 66                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3810:    3B12  12 32 4F                        LCALL   RXBYTE                          ;Wait for keypress
 3811:    3B15  D0 00                           POP     00h                             ;Restore R0
 3812:    3B17  22                              RET
 3813:
 3814:    3B18  90 00 00        PM_ISERASED:    MOV     DPTR,#0000h
 3815:    3B1B  75 56 00                        MOV     ROMVERERR,#00h
 3816:    3B1E  74 30           PM_ISERASED1:   MOV     A,#30h
 3817:    3B20  12 3C 2F                        LCALL   ISPCOMM                         ;Init read page mode
 3818:    3B23  E5 83                           MOV     A,DPH
 3819:    3B25  12 3C 2F                        LCALL   ISPCOMM                         ;Send high address
 3820:    3B28  E4              PM_ISERASED2:   CLR     A
 3821:    3B29  12 3C 2F                        LCALL   ISPCOMM                         ;Get byte from ROM
 3822:    3B2C  04                              INC     A
 3823:    3B2D  42 56                           ORL     ROMVERERR,A
 3824:    3B2F  A3                              INC     DPTR
 3825:    3B30  E5 82                           MOV     A,DPL
 3826:    3B32  70 F4                           JNZ     PM_ISERASED2                    ;Jump if more bytes on this page
 3827:    3B34  E5 56                           MOV     A,ROMVERERR
 3828:    3B36  70 05                           JNZ     PM_ISERASED3
 3829:    3B38  E5 83                           MOV     A,DPH
 3830:    3B3A  B5 52 E1                        CJNE    A,ROMPAGES,PM_ISERASED1         ;Jump if more pagees
 3831:    3B3D  C3              PM_ISERASED3:   CLR     C
 3832:    3B3E  E5 56                           MOV     A,ROMVERERR
 3833:    3B40  60 01                           JZ      PM_ISERASED4
 3834:    3B42  D3                              SETB    C
 3835:    3B43  22              PM_ISERASED4:   RET
 3836:
 3837:    3B44  12 3B 18        PM_ROMPROG:     LCALL   PM_ISERASED                     ;Check if chip is erased
 3838:    3B47  50 4E                           JNC     PM_ROMPROG1
 3839:    3B49  74 AC                           MOV     A,#0ACh
 3840:    3B4B  12 3C 2F                        LCALL   ISPCOMM                         ;Init chip erase byte 1
 3841:    3B4E  74 80                           MOV     A,#80h
 3842:    3B50  12 3C 2F                        LCALL   ISPCOMM                         ;Init chip erase byte 2
 3843:    3B53  E4                              CLR     A
 3844:    3B54  12 3C 2F                        LCALL   ISPCOMM                         ;Init chip erase byte 3
 3845:    3B57  E4                              CLR     A
 3846:    3B58  12 3C 2F                        LCALL   ISPCOMM                         ;Init chip erase byte 4
 3847:    3B5B  E4                              CLR     A
 3848:    3B5C  12 3C 28                        LCALL   WAIT                            ;Wait 256 ms
 3849:    3B5F  E4                              CLR     A
 3850:    3B60  12 3C 28                        LCALL   WAIT                            ;Wait 256 ms
 3851:    3B63  E4                              CLR     A
 3852:    3B64  12 3C 28                        LCALL   WAIT                            ;Wait 256 ms
 3853:    3B67  12 3B 18                        LCALL   PM_ISERASED
 3854:    3B6A  50 2B                           JNC     PM_ROMPROG1
 3855:    3B6C  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3856:    3B6F  12 31 11                        LCALL   PRNTCSTR
 3857:    3B72  0B 2A 23 43                     DB      0Bh,2Ah,23h,'Could not erase chip <Enter> ',00h
          3B76  6F 75 6C 64
          3B7A  20 6E 6F 74
          3B7E  20 65 72 61
          3B82  73 65 20 63
          3B86  68 69 70 20
          3B8A  3C 45 6E 74
          3B8E  65 72 3E 20
          3B92  00
 3858:    3B93  12 32 4F                        LCALL   RXBYTE                          ;Wait for keypress
 3859:    3B96  22                              RET
 3860:    3B97  C0 00           PM_ROMPROG1:    PUSH    00h
 3861:    3B99  90 00 00                        MOV     DPTR,#0000h
 3862:    3B9C  12 32 3F                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3863:    3B9F  74 40           PM_ROMPROG2:    MOV     A,#40h
 3864:    3BA1  12 3C 2F                        LCALL   ISPCOMM                         ;Init byte programming mode
 3865:    3BA4  E5 83                           MOV     A,DPH
 3866:    3BA6  12 3C 2F                        LCALL   ISPCOMM                         ;Send high address
 3867:    3BA9  E5 82                           MOV     A,DPL
 3868:    3BAB  12 3C 2F                        LCALL   ISPCOMM                         ;Send low address
 3869:    3BAE  E6                              MOV     A,@R0                           ;Get byte from buffer
 3870:    3BAF  F5 51                           MOV     ROMVER,A
 3871:    3BB1  12 3C 2F                        LCALL   ISPCOMM                         ;Send byte to be programmed
 3872:    3BB4  74 10                           MOV     A,#10h
 3873:    3BB6  12 3C 28                        LCALL   WAIT                            ;Wait 1mS
 3874:    3BB9  12 3C B7                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3875:    3BBC  B5 51 22                        CJNE    A,ROMVER,PM_ROMPROG4            ;Compare and jump if not equal
 3876:    3BBF  08                              INC     R0
 3877:    3BC0  E8                              MOV     A,R0
 3878:    3BC1  B4 50 03                        CJNE    A,#50h,PM_ROMPROG3
 3879:    3BC4  12 32 3F                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3880:    3BC7  A3              PM_ROMPROG3:    INC     DPTR
 3881:    3BC8  E5 82                           MOV     A,DPL
 3882:    3BCA  70 D3                           JNZ     PM_ROMPROG2                     ;Jump if still on same page
 3883:    3BCC  74 2E                           MOV     A,#2Eh
 3884:    3BCE  12 32 66                        LCALL   TXBYTE
 3885:    3BD1  E5 83                           MOV     A,DPH
 3886:    3BD3  B5 52 C9                        CJNE    A,ROMPAGES,PM_ROMPROG2          ;Jump if more pages
 3887:    3BD6  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3888:    3BD9  74 06                           MOV     A,#06h
 3889:    3BDB  12 32 66                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3890:    3BDE  D0 00                           POP     00h
 3891:    3BE0  22                              RET
 3892:    3BE1  C0 E0           PM_ROMPROG4:    PUSH    ACC
 3893:    3BE3  12 3C 57                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3894:    3BE6  74 06                           MOV     A,#06h
 3895:    3BE8  12 32 66                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3896:    3BEB  12 31 11                        LCALL   PRNTCSTR
 3897:    3BEE  0B 2A 23 45                     DB      0Bh,2Ah,23h,'Error at ',00h
          3BF2  72 72 6F 72
          3BF6  20 61 74 20
          3BFA  00
 3898:    3BFB  E5 83                           MOV     A,DPH
 3899:    3BFD  12 31 92                        LCALL   HEXOUT                          ;High address
 3900:    3C00  E5 82                           MOV     A,DPL
 3901:    3C02  12 31 92                        LCALL   HEXOUT                          ;Low address
 3902:    3C05  74 20                           MOV     A,#20h
 3903:    3C07  12 32 66                        LCALL   TXBYTE
 3904:    3C0A  E5 51                           MOV     A,ROMVER                        ;Byte from .cmd file
 3905:    3C0C  12 31 92                        LCALL   HEXOUT
 3906:    3C0F  74 20                           MOV     A,#20h
 3907:    3C11  12 32 66                        LCALL   TXBYTE
 3908:    3C14  D0 E0                           POP     ACC
 3909:    3C16  12 31 92                        LCALL   HEXOUT                          ;Byte read from ROM
 3910:    3C19  12 32 4F                        LCALL   RXBYTE                          ;Wait for a keypress
 3911:    3C1C  D0 00                           POP     00h                             ;Restore R0
 3912:    3C1E  22                              RET
 3913:
 3914:                          ;Wait functions
 3915:                          ;------------------------------------------------------------------
 3916:
 3917:    3C1F  C0 07           WAIT100:        PUSH    07h                             ;Save R7
 3918:    3C21  7F 64                           MOV     R7,#64h
 3919:    3C23  DF FE           WAIT1001:       DJNZ    R7,WAIT1001                     ;Wait loop, 100uS
 3920:    3C25  D0 07                           POP     07h                             ;Restore R7
 3921:    3C27  22                              RET
 3922:
 3923:    3C28  CF              WAIT:           XCH     A,R7
 3924:    3C29  91 1F           WAIT1:          ACALL   WAIT100
 3925:    3C2B  DF FC                           DJNZ    R7,WAIT1
 3926:    3C2D  CF                              XCH     A,R7
 3927:    3C2E  22                              RET
 3928:
 3929:                          ;Control functions
 3930:                          ;------------------------------------------------------------------
 3931:
 3932:                          ;IN A, OUT A
 3933:    3C2F  C0 07           ISPCOMM:        PUSH    07h
 3934:    3C31  C0 02                           PUSH    02h
 3935:    3C33  7A 08                           MOV     R2,#08h
 3936:    3C35  33              ISPCOMM1:       RLC     A
 3937:    3C36  92 93                           MOV     P1.3,C                          ;MISO
 3938:    3C38  A2 94                           MOV     C,P1.4                          ;MOSI
 3939:    3C3A  CF                              XCH     A,R7
 3940:    3C3B  33                              RLC     A
 3941:    3C3C  CF                              XCH     A,R7
 3942:    3C3D  D2 92                           SETB    P1.2                            ;SCK H
 3943:    3C3F  00                              NOP
 3944:    3C40  C2 92                           CLR     P1.2                            ;SCK L
 3945:    3C42  DA F1                           DJNZ    R2,ISPCOMM1
 3946:    3C44  EF                              MOV     A,R7
 3947:    3C45  D0 02                           POP     02
 3948:    3C47  D0 07                           POP     07
 3949:    3C49  22                              RET
 3950:
 3951:    3C4A  D2 90           ROMON:          SETB    P1.0                            ;+5V On
 3952:    3C4C  74 0A                           MOV     A,#0Ah
 3953:    3C4E  91 28                           ACALL   WAIT                            ;Wait 1mS
 3954:    3C50  D2 91                           SETB    P1.1                            ;RST H
 3955:    3C52  74 0A                           MOV     A,#0Ah
 3956:    3C54  91 28                           ACALL   WAIT                            ;Wait 1mS
 3957:    3C56  22                              RET
 3958:
 3959:    3C57  C2 91           ROMOFF:         CLR     P1.1                            ;RST L
 3960:    3C59  74 01                           MOV     A,#01h
 3961:    3C5B  91 28                           ACALL   WAIT                            ;Wait 100uS
 3962:    3C5D  75 90 10                        MOV     P1,#10h                         ;+5V Off, P1.4 As Input
 3963:    3C60  74 0A                           MOV     A,#0Ah
 3964:    3C62  12 3C 28                        LCALL   WAIT                            ;Wait 1mS
 3965:    3C65  22                              RET
 3966:
 3967:    3C66  74 AC           ROMINITPGM:     MOV     A,#0ACh
 3968:    3C68  12 3C 2F                        LCALL   ISPCOMM
 3969:    3C6B  74 53                           MOV     A,#53h
 3970:    3C6D  12 3C 2F                        LCALL   ISPCOMM
 3971:    3C70  74 00                           MOV     A,#00h
 3972:    3C72  12 3C 2F                        LCALL   ISPCOMM
 3973:    3C75  74 00                           MOV     A,#00h
 3974:    3C77  12 3C 2F                        LCALL   ISPCOMM
 3975:    3C7A  B4 69 01                        CJNE    A,#69h,ROMINITPGM1
 3976:    3C7D  22                              RET
 3977:    3C7E  12 31 11        ROMINITPGM1:    LCALL   PRNTCSTR
 3978:    3C81  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Initialisation Error <Enter> ',00h
          3C85  6E 69 74 69
          3C89  61 6C 69 73
          3C8D  61 74 69 6F
          3C91  6E 20 45 72
          3C95  72 6F 72 20
          3C99  3C 45 6E 74
          3C9D  65 72 3E 20
          3CA1  00
 3979:    3CA2  12 32 4F                        LCALL   RXBYTE
 3980:    3CA5  D3                              SETB    C
 3981:    3CA6  22                              RET
 3982:
 3983:    3CA7  90 00 00        ROMINIT:        MOV     DPTR,#0000h                     ;DPTR holds ROM address
 3984:    3CAA  12 3C 4A                        LCALL   ROMON                           ;Turn on VCC and pull RST high
 3985:    3CAD  12 3C 66                        LCALL   ROMINITPGM
 3986:    3CB0  50 04                           JNC     ROMINIT1
 3987:    3CB2  12 3C 57                        LCALL   ROMOFF                          ;Init programming failed
 3988:    3CB5  D3                              SETB    C
 3989:    3CB6  22              ROMINIT1:       RET
 3990:
 3991:    3CB7  74 20           BM_ROMRDBYTE:   MOV     A,#20h
 3992:    3CB9  12 3C 2F                        LCALL   ISPCOMM
 3993:    3CBC  E5 83                           MOV     A,DPH
 3994:    3CBE  12 3C 2F                        LCALL   ISPCOMM
 3995:    3CC1  E5 82                           MOV     A,DPL
 3996:    3CC3  12 3C 2F                        LCALL   ISPCOMM
 3997:    3CC6  74 00                           MOV     A,#00h
 3998:    3CC8  12 3C 2F                        LCALL   ISPCOMM
 3999:    3CCB  22                              RET
 4000:
 4001:    3CCC  C0 E0           ROMVERIFYERR:   PUSH    ACC
 4002:    3CCE  12 31 11                        LCALL   PRNTCSTR
 4003:    3CD1  0D 20 20 20                     DB      0Dh,'   Error at ',00h
          3CD5  45 72 72 6F
          3CD9  72 20 61 74
          3CDD  20 00
 4004:    3CDF  E5 83                           MOV     A,DPH
 4005:    3CE1  12 31 92                        LCALL   HEXOUT
 4006:    3CE4  E5 82                           MOV     A,DPL
 4007:    3CE6  12 31 92                        LCALL   HEXOUT
 4008:    3CE9  74 20                           MOV     A,#20h
 4009:    3CEB  12 32 66                        LCALL   TXBYTE
 4010:    3CEE  E5 51                           MOV     A,ROMVER
 4011:    3CF0  12 31 92                        LCALL   HEXOUT
 4012:    3CF3  74 20                           MOV     A,#20h
 4013:    3CF5  12 32 66                        LCALL   TXBYTE
 4014:    3CF8  D0 E0                           POP     ACC
 4015:    3CFA  12 31 92                        LCALL   HEXOUT
 4016:    3CFD  12 31 89                        LCALL   PRNTCRLF
 4017:    3D00  05 56                           INC     ROMVERERR
 4018:    3D02  E5 56                           MOV     A,ROMVERERR
 4019:    3D04  B4 10 00                        CJNE    A,#10h,ROMVERIFYERR1
 4020:    3D07  B3              ROMVERIFYERR1:  CPL     C
 4021:    3D08  22                              RET
 4022:
 4023:                          ;LCD Output.
 4024:                          ;-----------------------------------------------------
 4025:    3D09  C0 07           LCDDELAY:       PUSH    07h
 4026:    3D0B  7F 00                           MOV     R7,#00h
 4027:    3D0D  DF FE                           DJNZ    R7,$
 4028:    3D0F  D0 07                           POP     07h
 4029:    3D11  22                              RET
 4030:
 4031:                          ;A contains nibble
 4032:    3D12  D2 E5           LCDNIBOUT:      SETB    ACC.5                           ;E
 4033:    3D14  F0                              MOVX    @DPTR,A                         ;
 4034:    3D15  C2 E5                           CLR     ACC.5                           ;Negative edge on E
 4035:    3D17  F0                              MOVX    @DPTR,A                         ;
 4036:    3D18  22                              RET
 4037:
 4038:                          ;A contains byte
 4039:    3D19  C0 E0           LCDCMDOUT:      PUSH    ACC
 4040:    3D1B  C4                              SWAP    A                               ;High nibble first
 4041:    3D1C  54 0F                           ANL     A,#0Fh
 4042:    3D1E  B1 12                           ACALL   LCDNIBOUT
 4043:    3D20  D0 E0                           POP     ACC
 4044:    3D22  54 0F                           ANL     A,#0Fh
 4045:    3D24  B1 12                           ACALL   LCDNIBOUT
 4046:    3D26  B1 09                           ACALL   LCDDELAY                        ;Wait for BF to clear
 4047:    3D28  22                              RET
 4048:
 4049:    3D29  C0 82           LCDCLEAR:       PUSH    DPL
 4050:    3D2B  C0 83                           PUSH    DPH
 4051:    3D2D  90 80 00                        MOV     DPTR,#8000h
 4052:    3D30  74 01                           MOV     A,#00000001b
 4053:    3D32  B1 19                           ACALL   LCDCMDOUT
 4054:    3D34  B1 09                           ACALL   LCDDELAY
 4055:    3D36  B1 09                           ACALL   LCDDELAY
 4056:    3D38  B1 09                           ACALL   LCDDELAY
 4057:    3D3A  D0 83                           POP     DPH
 4058:    3D3C  D0 82                           POP     DPL
 4059:    3D3E  22                              RET
 4060:
 4061:                          ;A contais address
 4062:    3D3F  C0 82           LCDSETADR:      PUSH    DPL
 4063:    3D41  C0 83                           PUSH    DPH
 4064:    3D43  90 80 00                        MOV     DPTR,#8000h
 4065:    3D46  44 80                           ORL     A,#10000000b
 4066:    3D48  B1 19                           ACALL   LCDCMDOUT
 4067:    3D4A  D0 83                           POP     DPH
 4068:    3D4C  D0 82                           POP     DPL
 4069:    3D4E  22                              RET
 4070:
 4071:                          ;A contains byte
 4072:    3D4F  C0 82           LCDCHROUT:      PUSH    DPL
 4073:    3D51  C0 83                           PUSH    DPH
 4074:    3D53  90 80 00                        MOV     DPTR,#8000h
 4075:    3D56  C0 E0                           PUSH    ACC
 4076:    3D58  C4                              SWAP    A                               ;High nibble first
 4077:    3D59  54 0F                           ANL     A,#0Fh
 4078:    3D5B  D2 E4                           SETB    ACC.4                           ;RS
 4079:    3D5D  B1 12                           ACALL   LCDNIBOUT
 4080:    3D5F  D0 E0                           POP     ACC
 4081:    3D61  54 0F                           ANL     A,#0Fh
 4082:    3D63  D2 E4                           SETB    ACC.4                           ;RS
 4083:    3D65  B1 12                           ACALL   LCDNIBOUT
 4084:    3D67  B1 09                           ACALL   LCDDELAY                        ;Wait for BF to clear
 4085:    3D69  D0 83                           POP     DPH
 4086:    3D6B  D0 82                           POP     DPL
 4087:    3D6D  22                              RET
 4088:
 4089:    3D6E  C0 82           LCDINIT:        PUSH    DPL
 4090:    3D70  C0 83                           PUSH    DPH
 4091:    3D72  90 80 00                        MOV     DPTR,#8000h
 4092:                                          ;Function set
 4093:    3D75  74 03                           MOV     A,#00000011b
 4094:    3D77  B1 12                           ACALL   LCDNIBOUT
 4095:    3D79  B1 09                           ACALL   LCDDELAY                        ;Wait for BF to clear
 4096:    3D7B  74 28                           MOV     A,#00101000b
 4097:    3D7D  B1 19                           ACALL   LCDCMDOUT
 4098:    3D7F  74 28                           MOV     A,#00101000b
 4099:    3D81  B1 19                           ACALL   LCDCMDOUT
 4100:
 4101:                                          ;Display ON/OFF
 4102:    3D83  74 0C                           MOV     A,#00001100b
 4103:    3D85  B1 19                           ACALL   LCDCMDOUT
 4104:
 4105:                                          ;Clear
 4106:    3D87  B1 29                           ACALL   LCDCLEAR
 4107:
 4108:                                          ;Cursor direction
 4109:    3D89  74 07                           MOV     A,#00000111b
 4110:    3D8B  B1 19                           ACALL   LCDCMDOUT
 4111:
 4112:    3D8D  D0 83                           POP     DPH
 4113:    3D8F  D0 82                           POP     DPL
 4114:    3D91  22                              RET
 4115:
 4116:                          ;Single step called when INT1 pin low and interupt is enabled
 4117:                          ;------------------------------------------------------------------
 4118:    3D92  C0 D0           SINGLESTEP:     PUSH    PSW
 4119:    3D94  C0 E0                           PUSH    ACC
 4120:    3D96  C2 D3                           CLR     RS0
 4121:    3D98  C2 D4                           CLR     RS1
 4122:    3D9A  C0 00                           PUSH    00h
 4123:    3D9C  A8 81                           MOV     R0,SP
 4124:    3D9E  18                              DEC     R0                              ;Skip PSW
 4125:    3D9F  18                              DEC     R0                              ;Skip ACC
 4126:    3DA0  18                              DEC     R0                              ;Skip R0
 4127:    3DA1  E5 5B                           MOV     A,SSADRMSB
 4128:    3DA3  04                              INC     A
 4129:    3DA4  60 0A                           JZ      SINGLESTEP0
 4130:    3DA6  E6                              MOV     A,@R0                           ;MSB adress
 4131:    3DA7  B5 5B 74                        CJNE    A,SSADRMSB,SINGLESTEPEX2
 4132:    3DAA  18                              DEC     R0
 4133:    3DAB  E6                              MOV     A,@R0                           ;MSB adress
 4134:    3DAC  08                              INC     R0
 4135:    3DAD  B5 5A 6E                        CJNE    A,SSADRLSB,SINGLESTEPEX2
 4136:    3DB0  74 07           SINGLESTEP0:    MOV     A,#07h
 4137:    3DB2  12 32 66                        LCALL   TXBYTE
 4138:    3DB5  E6                              MOV     A,@R0                           ;MSB adress
 4139:    3DB6  12 32 66                        LCALL   TXBYTE
 4140:    3DB9  18                              DEC     R0
 4141:    3DBA  E6                              MOV     A,@R0                           ;LSB adress
 4142:    3DBB  12 32 66                        LCALL   TXBYTE
 4143:    3DBE  08                              INC     R0                              ;MSB adress
 4144:    3DBF  08                              INC     R0                              ;PSW
 4145:    3DC0  E6                              MOV     A,@R0                           ;PSW
 4146:    3DC1  12 32 66                        LCALL   TXBYTE
 4147:    3DC4  08                              INC     R0                              ;ACC
 4148:    3DC5  E6                              MOV     A,@R0                           ;ACC
 4149:    3DC6  12 32 66                        LCALL   TXBYTE
 4150:    3DC9  E5 F0                           MOV     A,B                             ;B
 4151:    3DCB  12 32 66                        LCALL   TXBYTE
 4152:    3DCE  E5 81                           MOV     A,SP                            ;SP
 4153:    3DD0  C3                              CLR     C
 4154:    3DD1  94 05                           SUBB    A,#05h
 4155:    3DD3  12 32 66                        LCALL   TXBYTE
 4156:    3DD6  E5 82                           MOV     A,DPL                           ;DPL
 4157:    3DD8  12 32 66                        LCALL   TXBYTE
 4158:    3DDB  E5 83                           MOV     A,DPH                           ;DPH
 4159:    3DDD  12 32 66                        LCALL   TXBYTE
 4160:    3DE0  08                              INC     R0                              ;R0
 4161:    3DE1  E6                              MOV     A,@R0                           ;R0
 4162:    3DE2  12 32 66                        LCALL   TXBYTE
 4163:    3DE5  78 01                           MOV     R0,#01h
 4164:    3DE7  E6              SINGLESTEP1:    MOV     A,@R0                           ;31 Bytes
 4165:    3DE8  12 32 66                        LCALL   TXBYTE
 4166:    3DEB  08                              INC     R0
 4167:    3DEC  B8 20 F8                        CJNE    R0,#20h,SINGLESTEP1
 4168:    3DEF  C0 82                           PUSH    DPL
 4169:    3DF1  C0 83                           PUSH    DPH
 4170:    3DF3  78 20                           MOV     R0,#20h                         ;32 Bytes
 4171:    3DF5  E0              SINGLESTEP2:    MOVX    A,@DPTR
 4172:    3DF6  12 32 66                        LCALL   TXBYTE
 4173:    3DF9  A3                              INC     DPTR
 4174:    3DFA  D8 F9                           DJNZ    R0,SINGLESTEP2
 4175:    3DFC  12 32 4F        SINGLESTEP3:    LCALL   RXBYTE
 4176:    3DFF  B4 52 04                        CJNE    A,#'R',SINGLESTEP4              ;R Run
 4177:    3E02  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 4178:    3E04  80 0E                           SJMP    SINGLESTEPEX
 4179:    3E06  B4 73 08        SINGLESTEP4:    CJNE    A,#'s',SINGLESTEP5              ;s Stop
 4180:    3E09  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 4181:    3E0B  E4                              CLR     A
 4182:    3E0C  C0 E0                           PUSH    ACC                             ;Force a software reset
 4183:    3E0E  C0 E0                           PUSH    ACC
 4184:    3E10  32                              RETI                                    ;Return to reset vector
 4185:    3E11  B4 69 11        SINGLESTEP5:    CJNE    A,#'i',SINGLESTEP6              ;i Step into
 4186:    3E14  75 5A FF        SINGLESTEPEX:   MOV     SSADRLSB,#0FFh
 4187:    3E17  75 5B FF                        MOV     SSADRMSB,#0FFh
 4188:    3E1A  D0 83           SINGLESTEPEX1:  POP     DPH
 4189:    3E1C  D0 82                           POP     DPL
 4190:    3E1E  D0 00           SINGLESTEPEX2:  POP     00h
 4191:    3E20  D0 E0                           POP     ACC
 4192:    3E22  D0 D0                           POP     PSW
 4193:    3E24  32                              RETI
 4194:    3E25  B4 6F 0C        SINGLESTEP6:    CJNE    A,#'o',SINGLESTEP7              ;o Step over / Run to caret
 4195:    3E28  12 32 4F                        LCALL   RXBYTE
 4196:    3E2B  F5 5A                           MOV     SSADRLSB,A
 4197:    3E2D  12 32 4F                        LCALL   RXBYTE
 4198:    3E30  F5 5B                           MOV     SSADRMSB,A
 4199:    3E32  80 E6                           SJMP    SINGLESTEPEX1
 4200:    3E34  B4 41 05        SINGLESTEP7:    CJNE    A,#'A',SINGLESTEP8              ;A Adress input
 4201:    3E37  12 32 2E                        LCALL   INPDPTR
 4202:    3E3A  80 C0                           SJMP    SINGLESTEP3
 4203:    3E3C  B4 49 05        SINGLESTEP8:    CJNE    A,#'I',SINGLESTEP9              ;Dump internal memory
 4204:    3E3F  12 33 95                        LCALL   MEMDUMP
 4205:    3E42  80 B8                           SJMP    SINGLESTEP3
 4206:    3E44  B4 44 05        SINGLESTEP9:    CJNE    A,#'D',SINGLESTEP10             ;Dump external memory
 4207:    3E47  12 33 37                        LCALL   DUMP
 4208:    3E4A  80 B0                           SJMP    SINGLESTEP3
 4209:    3E4C  B4 53 AD        SINGLESTEP10:   CJNE    A,#'S',SINGLESTEP3              ;Dump SFR's
 4210:    3E4F  D0 83                           POP     DPH
 4211:    3E51  D0 82                           POP     DPL
 4212:    3E53  D0 00                           POP     00h
 4213:    3E55  D0 E0                           POP     ACC
 4214:    3E57  D0 D0                           POP     PSW
 4215:    3E59  C0 D0                           PUSH    PSW
 4216:    3E5B  C0 E0                           PUSH    ACC
 4217:    3E5D  C2 D3                           CLR     RS0
 4218:    3E5F  C2 D4                           CLR     RS1
 4219:    3E61  C0 00                           PUSH    00h
 4220:    3E63  C0 82                           PUSH    DPL
 4221:    3E65  C0 83                           PUSH    DPH
 4222:    3E67  12 33 B8                        LCALL   DUMPSFR
 4223:    3E6A  80 90                           SJMP    SINGLESTEP3
 4224:
 4225:                                          END





                     register banks used:  ---

                     no errors



