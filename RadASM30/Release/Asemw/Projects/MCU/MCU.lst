

       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



        Source File:    MCU.a51
        Object File:    MCU.hex
        List File:      MCU.lst



 Line  I  Addr  Code            Source

    1:                          $NOPAGING
    2:          N      00FA     $PAGEWIDTH (250) ;250 columns per line
    3:                          $NOTABS          ;expand tabs
    4:                          $NOSYMBOLS
    5:
    6:                          $INCLUDE        (MCU.inc)
    7: 1                        ;*****************************************************
    8: 1                        ;Interrupt vectors.
    9: 1                        ;-----------------------------------------------------
   10: 1                        ;RESET          0000
   11: 1                        ;IE0            0003
   12: 1                        ;TF0            000B
   13: 1                        ;IE1            0013
   14: 1                        ;TF1            001B
   15: 1                        ;RI & TI        0023
   16: 1                        ;TF2 & EXF2     002B
   17: 1                        ;-----------------------------------------------------
   18: 1                        ;*****************************************************
   19: 1                        ;PORT 1
   20: 1                        ;-----------------------------------------------------
   21: 1                        ;P1.0           OUT:    +5V On
   22: 1                        ;P1.1           OUT:    RST
   23: 1                        ;P1.2           OUT:    SCK
   24: 1                        ;P1.3           OUT:    MISO
   25: 1                        ;P1.4           IN:     MOSI
   26: 1                        ;P1.5
   27: 1                        ;P1.6
   28: 1                        ;P1.7
   29: 1                        ;-----------------------------------------------------
   30: 1                        ;*****************************************************
   31: 1                        ;Internal RAM Locations
   32: 1                        ;-----------------------------------------------------
   33: 1                        ;20             Interrupt control bit flags
   34: 1                        ;               D0                      If set INT0 interrupt jumps to 2003h
   35: 1                        ;               D1                      If set TIMER0 interrupt jumps to 200Bh
   36: 1                        ;               D2                      If set INT1 interrupt jumps to 2013h
   37: 1                        ;               D3                      If set TIMER1 interrupt jumps to 201Bh
   38: 1                        ;               D4                      If set RI/TI interrupt jumps to 2023h
   39: 1                        ;               D5                      If set TIMER2 interrupt jumps to 202Bh
   40: 1                        ;               D6                      If set output is to terminal instead of LCD
   41: 1                        ;               D7                      If set single stepping is enabled
   42: 1
   43: 1                        ;24             ARG_STACK               ARGUMENT STACK POINTER
   44: 1                        ;25             FORMAT                  LOCATION OF OUTPUT FORMAT BYTE
   45: 1                        ;26.1           INTGRC                  BIT SET IF INTEGER ERROR
   46: 1                        ;26.3           ADD_IN                  DCMPXZ IN BASIC BACKAGE
   47: 1                        ;26.6           ZSURP                   ZERO SUPRESSION FOR HEX PRINT
   48: 1                        ;28-3D          FP WORK AREA
   49: 1                        ;40-4F          ROMBUFF / LCDLINE       16 Bytes
   50: 1                        ;50             FPCHR_OUT               Holds addrss to next byte during FP number convertion
   51: 1                        ;51             ROMVER                  Byte to be verified
   52: 1                        ;52             ROMPAGES                Number of pages
   53: 1                        ;53             ROMACTION               Menu pos
   54: 1                        ;54             ROMSIZE                 Menu pos
   55: 1                        ;55             ROMMODE                 Menu pos
   56: 1                        ;56             ROMVERERR               Number of verify errors
   57: 1                        ;57             DPLSAVE                 Holds DPL during PRNTCSTR
   58: 1                        ;58             DPHSAVE                 Holds DPH during PRNTCSTR
   59: 1                        ;59             MODE                    Selected mode (0-7)
   60: 1                        ;5A             SSADRLSB                Single step adress
   61: 1                        ;5B             SSADRMSB                Single step adress
   62: 1                        ;60             LCF1
   63: 1                        ;68             LCF2
   64: 1                        ;70             LCF3
   65: 1
   66: 1                        ;C0-FF          48 Byte stack
   67: 1
   68: 1                        ;External RAM Locations
   69: 1                        ;-----------------------------------------------------
   70: 1                        ;0048           EXTERNAL RAM FP NUMBER INPUT AREA
   71: 1                        ;0100           EXTERNAL RAM FP STACK
   72: 1                        ;8000           MEMORU MAPPED I/O
   73: 1                        ;8001           MEMORU MAPPED I/O
   74: 1
   75: 1                        ;-----------------------------------------------------
   76: 1                        ;*****************************************************
   77: 1                        ;SCREEN DRIVER
   78: 1                        ;-----------------------------------------------------
   79: 1                        ;01             START SEND ROMDATA.HEX FILE
   80: 1                        ;02             STOP SEND FILE
   81: 1                        ;03             START RECIEVE ROMDATA.HEX FILE
   82: 1                        ;04             STOP RECIEVE FILE
   83: 1                        ;05             START RECIEVE FILE IN 16 BYTE BLOCKS
   84: 1                        ;06             STOP RECIEVE FILE IN 16 BYTE BLOCKS
   85: 1                        ;07             BELL
   86: 1                        ;08             BACK SPACE
   87: 1                        ;09             TAB
   88: 1                        ;0A             LF
   89: 1                        ;0B             LOCATE
   90: 1                        ;0C             HOME
   91: 1                        ;0D             CR
   92: 1                        ;0E             CLS
   93: 1                        ;0F             MODE
   94: 1                        ;10             START SEND CMDFILE.CMD FILE
   95: 1                        ;-----------------------------------------------------
   96: 1                        ;*****************************************************
   97: 1                        ;Memory mapped I/O
   98: 1                        ;-----------------------------------------------------
   99: 1                        ;8000h Output
  100: 1                        ;-----------------------------------------------------
  101: 1                        ;D0             LCD DB4
  102: 1                        ;D1             LCD DB5
  103: 1                        ;D2             LCD DB6
  104: 1                        ;D3             LCD DB7
  105: 1                        ;D4             LCD RS
  106: 1                        ;D5             LCD E
  107: 1                        ;D6             LC Meter        0=C, 1=L
  108: 1                        ;D7             LC Meter        0=F1, 1=F2 (Adding C Cal)
  109: 1                        ;-----------------------------------------------------
  110: 1                        ;8001h Output
  111: 1                        ;-----------------------------------------------------
  112: 1                        ;D0             FRQ SEL A
  113: 1                        ;D1             FRQ SEL B       00=EXT FRQ,01=FGEN,10=LCMETER,11=ALE
  114: 1                        ;D2             FRQ GATE        ACTIVE LOW
  115: 1                        ;D3             FRQ RESET       ACTIVE HIGH
  116: 1                        ;D4             ADC CS          ACTIVE LOW
  117: 1                        ;D5             ADC CLK         HIGH TO LOW TRANSITION
  118: 1                        ;D6             ADC DIN         START,S/D,D2,D1,D0
  119: 1                        ;D7             FRQ TTL         ACTIVE HIGH
  120: 1                        ;-----------------------------------------------------
  121: 1                        ;8000h Input
  122: 1                        ;-----------------------------------------------------
  123: 1                        ;D0             FRQ LSB
  124: 1                        ;D1
  125: 1                        ;D2
  126: 1                        ;D3
  127: 1                        ;D4
  128: 1                        ;D5
  129: 1                        ;D6
  130: 1                        ;D7             FRQ MSB
  131: 1                        ;-----------------------------------------------------
  132: 1                        ;8001h Input
  133: 1                        ;-----------------------------------------------------
  134: 1                        ;D0             ADC DOUT
  135: 1                        ;D1
  136: 1                        ;D2
  137: 1                        ;D3
  138: 1                        ;D4
  139: 1                        ;D5
  140: 1                        ;D6
  141: 1                        ;D7
  142: 1
  143: 1                        ;-----------------------------------------------------
  144: 1                        ;*****************************************************
  145: 1                        ;Equates
  146: 1                        ;-----------------------------------------------------
  147: 1        N      00C8     T2CON           EQU 0C8h
  148: 1        N      00CA     RCAP2L          EQU 0CAh
  149: 1        N      00CB     RCAP2H          EQU 0CBh
  150: 1        N      00CC     TL2             EQU 0CCh
  151: 1        N      00CD     TH2             EQU 0CDh
  152: 1        N        BD     PT2             BIT 0BDh
  153: 1        N      0009     MODEMAX         EQU 9
  154: 1                        ;-----------------------------------------------------
  155: 1        N      0020     INTBITS         EQU 20h                 ;Interrupt jump control
  156: 1        N      0040     ROMBUFF         EQU 40h                 ;16 Bytes
  157: 1        N      0040     LCDLINE         EQU 40h                 ;16 Bytes
  158: 1        N      0050     FPCHR_OUT       EQU 50h                 ;Holds addrss to next byte during FP number convertion
  159: 1        N      0051     ROMVER          EQU 51h                 ;Byte to be verified
  160: 1        N      0052     ROMPAGES        EQU 52h                 ;Number of pages
  161: 1        N      0053     ROMACTION       EQU 53h                 ;Menu pos
  162: 1        N      0054     ROMSIZE         EQU 54h                 ;Menu pos
  163: 1        N      0055     ROMMODE         EQU 55h                 ;Menu pos
  164: 1        N      0056     ROMVERERR       EQU 56h                 ;Number of verify errors
  165: 1        N      0057     DPLSAVE         EQU 57h                 ;Holds DPL during PRNTCSTR
  166: 1        N      0058     DPHSAVE         EQU 58h                 ;Holds DPH during PRNTCSTR
  167: 1        N      0059     MODE            EQU 59h                 ;Selected mode (0-7)
  168: 1        N      005A     SSADRLSB        EQU 5Ah                 ;Single step adress LSB
  169: 1        N      005B     SSADRMSB        EQU 5Bh                 ;Single step adress MSB
  170: 1                        ;*****************************************************
  171: 1                        ; The following values MUST be provided by the user
  172: 1                        ;*****************************************************
  173: 1        N      0001     ARG_STACK_PAGE  EQU 01H                 ;External memory page for arg stack
  174: 1        N      0024     ARG_STACK       EQU 24H                 ;ARGUMENT STACK POINTER
  175: 1        N      0025     FORMAT          EQU 25H                 ;LOCATION OF OUTPUT FORMAT BYTE
  176: 1        B        31     INTGRC          BIT 26H.1               ;BIT SET IF INTEGER ERROR
  177: 1        B        33     ADD_IN          BIT 26H.3               ;DCMPXZ IN BASIC BACKAGE
  178: 1        B        36     ZSURP           BIT 26H.6               ;ZERO SUPRESSION FOR HEX PRINT
  179: 1                        ;*****************************************************
  180: 1                        ;XRAM
  181: 1                        ;*****************************************************
  182: 1        N      0048     CONVT           EQU 0048H               ;String addr TO CONVERT NUMBERS
  183: 1        N      0060     LCF1            EQU 0060H               ;LC Meter F1
  184: 1        N      0068     LCF2            EQU 0068h               ;LC Meter F2
  185: 1        N      0070     LCF3            EQU 0070h               ;LC Meter F3
  186: 1        N      0078     LCCA            EQU 0078h               ;((F1/F2)^2)-1
  187: 1        N      0080     LCCB            EQU 0080h               ;((1/2*Pi*F1)^2)*LCCA
  188: 1                        ;-----------------------------------------------------
  189:
  190:          N      0001     DEVMODE         EQU 1
  191:          N      0000     DEBUG           EQU 0
  192:
  193:          N      0000     IF DEVMODE=0
  194:                          ;RESET:***********************************************
  195:                                          ORG     0000h
  196:                                          LJMP    START0
  197:                          ;IE0IRQ:**********************************************
  198:                                          ORG     0003h
  199:                                          AJMP    IE0IRQ
  200:                          ;TF0IRQ:**********************************************
  201:                                          ORG     000Bh
  202:                                          JB      INTBITS.1,$+4
  203:                                          RETI
  204:                                          LJMP    200Bh
  205:                          ;IE1IRQ:**********************************************
  206:                                          ORG     0013h
  207:                                          AJMP    IE1IRQ
  208:                          ;TF1IRQ:**********************************************
  209:                                          ORG     001Bh
  210:                                          JB      INTBITS.3,$+4
  211:                                          RETI
  212:                                          LJMP    201Bh
  213:                          ;RITIIRQ:*********************************************
  214:                                          ORG     0023h
  215:                                          JB      INTBITS.4,$+4
  216:                                          RETI
  217:                                          LJMP    2023h
  218:                          ;TF2EXF2IRQ:******************************************
  219:                                          ORG     002Bh
  220:                                          JB      INTBITS.5,$+4
  221:                                          RETI
  222:                                          LJMP    202Bh
  223:                          ;*****************************************************
  224:                          IE0IRQ:         JB      INTBITS.0,IE0IRQ1
  225:                                          ACALL   DEBOUNCEINT0
  226:                                          INC     MODE
  227:                                          LJMP    START
  228:                          IE0IRQ1:        LJMP    2003h
  229:
  230:                          IE1IRQ:         JB      INTBITS.2,IE1IRQ1
  231:                                          JB      INTBITS.7,IE1IRQ2
  232:                                          ACALL   DEBOUNCEINT1
  233:                                          DEC     MODE
  234:                                          LJMP    START
  235:                          IE1IRQ1:        LJMP    2013h
  236:                          IE1IRQ2:        LJMP    SINGLESTEP
  237:
  238:                          DEBOUNCEINT0:   MOV     R6,#00h
  239:                                          MOV     R7,#00h
  240:                          DEBOUNCEINT01:  JNB     P3.2,DEBOUNCEINT0
  241:                                          DJNZ    R6,DEBOUNCEINT01
  242:                                          DJNZ    R7,DEBOUNCEINT01
  243:                                          RETI
  244:
  245:                          DEBOUNCEINT1:   MOV     R6,#00h
  246:                                          MOV     R7,#00h
  247:                          DEBOUNCEINT11:  JNB     P3.2,DEBOUNCEINT1
  248:                                          DJNZ    R6,DEBOUNCEINT11
  249:                                          DJNZ    R7,DEBOUNCEINT11
  250:                                          RETI
  251:
  252:                                          ORG     0080h
  253:
  254:                          ELSE
  255:                          ;RESET:***********************************************
  256:          N      2000                     ORG     2000h
  257:    2000  02 30 00                        LJMP    START0
  258:                          ;IE0IRQ:**********************************************
  259:          N      2003                     ORG     2003h
  260:    2003  01 2C                           AJMP    IE0IRQ
  261:                          ;TF0IRQ:**********************************************
  262:          N      200B                     ORG     200Bh
  263:    200B  32                              RETI
  264:                          ;IE1IRQ:**********************************************
  265:          N      2013                     ORG     2013h
  266:    2013  01 33                           AJMP    IE1IRQ
  267:                          ;TF1IRQ:**********************************************
  268:          N      201B                     ORG     201Bh
  269:    201B  32                              RETI
  270:                          ;RITIIRQ:*********************************************
  271:          N      2023                     ORG     2023h
  272:    2023  32                              RETI
  273:                          ;TF2EXF2IRQ:******************************************
  274:          N      202B                     ORG     202Bh
  275:    202B  32                              RETI
  276:                          ;*****************************************************
  277:    202C  11 3E           IE0IRQ:         ACALL   DEBOUNCEINT0
  278:    202E  05 59                           INC     MODE
  279:    2030  02 30 3C                        LJMP    START
  280:
  281:    2033  20 07 05        IE1IRQ:         JB      INTBITS.7,IE1IRQ2
  282:    2036  15 59                           DEC     MODE
  283:    2038  02 30 3C                        LJMP    START
  284:    203B  02 3E BD        IE1IRQ2:        LJMP    SINGLESTEP
  285:
  286:    203E  7E 00           DEBOUNCEINT0:   MOV     R6,#00h
  287:    2040  7F 00                           MOV     R7,#00h
  288:    2042  30 B2 F9        DEBOUNCEINT01:  JNB     P3.2,DEBOUNCEINT0
  289:    2045  DE FB                           DJNZ    R6,DEBOUNCEINT01
  290:    2047  DF F9                           DJNZ    R7,DEBOUNCEINT01
  291:    2049  32                              RETI
  292:
  293:    204A  7E 00           DEBOUNCEINT1:   MOV     R6,#00h
  294:    204C  7F 00                           MOV     R7,#00h
  295:    204E  30 B2 F9        DEBOUNCEINT11:  JNB     P3.2,DEBOUNCEINT1
  296:    2051  DE FB                           DJNZ    R6,DEBOUNCEINT11
  297:    2053  DF F9                           DJNZ    R7,DEBOUNCEINT11
  298:    2055  32                              RETI
  299:
  300:          N      2080                     ORG     2080h
  301:
  302:                          ENDIF
  303:
  304:                          ; This is a complete BCD floating point package for the 8051 micro-
  305:                          ; controller. It provides 8 digits of accuracy with exponents that
  306:                          ; range from +127 to -127. The mantissa is in packed BCD, while the
  307:                          ; exponent is expressed in pseudo-twos complement. A ZERO exponent
  308:                          ; is used to express the number ZERO. An exponent value of 80H or
  309:                          ; greater than means the exponent is positive, i.e. 80H = E 0,
  310:                          ; 81H = E+1, 82H = E+2 and so on. If the exponent is 7FH or less,
  311:                          ; the exponent is negative, 7FH = E-1, 7EH = E-2, and so on.
  312:                          ; ALL NUMBERS ARE ASSUMED TO BE NORMALIZED and all results are
  313:                          ; normalized after calculation. A normalized mantissa is >=.10 and
  314:                          ; <=.99999999.
  315:                          ;
  316:                          ; The numbers in memory assumed to be stored as follows:
  317:                          ;
  318:                          ; EXPONENT OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE
  319:                          ; SIGN OF ARGUMENT 2       =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-1
  320:                          ; DIGIT 78 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-2
  321:                          ; DIGIT 56 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-3
  322:                          ; DIGIT 34 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-4
  323:                          ; DIGIT 12 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-5
  324:                          ;
  325:                          ; EXPONENT OF ARGUMENT 1   =   VALUE OF ARG_STACK
  326:                          ; SIGN OF ARGUMENT 1       =   VALUE OF ARG_STACK-1
  327:                          ; DIGIT 78 OF ARGUMENT 1   =   VALUE OF ARG_STACK-2
  328:                          ; DIGIT 56 OF ARGUMENT 1   =   VALUE OF ARG_STACK-3
  329:                          ; DIGIT 34 OF ARGUMENT 1   =   VALUE OF ARG_STACK-4
  330:                          ; DIGIT 12 OF ARGUMENT 1   =   VALUE OF ARG_STACK-5
  331:                          ;
  332:                          ; The operations are performed thusly:
  333:                          ;
  334:                          ; ARG_STACK+FP_NUMBER_SIZE = ARG_STACK+FP_NUMBER_SIZE # ARG_STACK
  335:                          ;
  336:                          ; Which is ARGUMENT 2 = ARGUMENT 2 # ARGUMENT 1
  337:                          ;
  338:                          ; Where # can be ADD, SUBTRACT, MULTIPLY OR DIVIDE.
  339:                          ;
  340:                          ; Note that the stack gets popped after an operation.
  341:                          ;
  342:                          ; The FP_COMP instruction POPS the ARG_STACK TWICE and returns status.
  343:                          ;
  344:                          ;**********************************************************************
  345:                          ;
  346:                          ;**********************************************************************
  347:                          ;
  348:                          ; STATUS ON RETURN - After performing an operation (+, -, *, /)
  349:                          ;                    the accumulator contains the following status
  350:                          ;
  351:                          ; ACCUMULATOR - BIT 0 - FLOATING POINT UNDERFLOW OCCURED
  352:                          ;
  353:                          ;             - BIT 1 - FLOATING POINT OVERFLOW OCCURED
  354:                          ;
  355:                          ;             - BIT 2 - RESULT WAS ZER0
  356:                          ;
  357:                          ;             - BIT 3 - DIVIDE BY ZERO ATTEMPTED
  358:                          ;
  359:                          ;             - BIT 4 - NOT USED, 0 RETURNED
  360:                          ;
  361:                          ;             - BIT 5 - NOT USED, 0 RETURNED
  362:                          ;
  363:                          ;             - BIT 6 - NOT USED, 0 RETURNED
  364:                          ;
  365:                          ;             - BIT 7 - NOT USED, 0 RETURNED
  366:                          ;
  367:                          ; NOTE: When underflow occures, a ZERO result is returned.
  368:                          ;       When overflow or divide by zero occures, a result of
  369:                          ;       .99999999 E+127 is returned and it is up to the user
  370:                          ;       to handle these conditions as needed in the program.
  371:                          ;
  372:                          ; NOTE: The Compare instruction returns F0 = 0 if ARG 1 = ARG 2
  373:                          ;       and returns a CARRY FLAG = 1 if ARG 1 is > ARG 2
  374:                          ;
  375:                          ;***********************************************************************
  376:                          ;
  377:                          ; The following equates are used internally
  378:                          ;
  379:                          ;***********************************************************************
  380:                          ;
  381:          N      0006     FP_NUMBER_SIZE  EQU     6
  382:          N      0004     DIGIT           EQU     4
  383:          N      0000     R0B0            EQU     0
  384:          N      0001     R1B0            EQU     1
  385:          N      0000     UNDERFLOW       EQU     0
  386:          N      0001     OVERFLOW        EQU     1
  387:          N      0002     ZERO            EQU     2
  388:          N      0003     ZERO_DIVIDE     EQU     3
  389:                          ;
  390:                          ;***********************************************************************
  391:                                  ;**************************************************************
  392:                                  ;
  393:                                  ; The following internal locations are used by the math pack
  394:                                  ; ordering is important and the FP_DIGITS must be bit
  395:                                  ; addressable
  396:                                  ;
  397:                                  ;***************************************************************
  398:                                  ;
  399:          N      0028     FP_STATUS       EQU     28H                             ;NOT used data pointer me
  400:          N      0029     FP_TEMP         EQU     FP_STATUS+1                     ;NOT USED
  401:          N      002A     FP_CARRY        EQU     FP_STATUS+2                     ;USED FOR BITS
  402:          N      002B     FP_DIG12        EQU     FP_CARRY+1
  403:          N      002C     FP_DIG34        EQU     FP_CARRY+2
  404:          N      002D     FP_DIG56        EQU     FP_CARRY+3
  405:          N      002E     FP_DIG78        EQU     FP_CARRY+4
  406:          N      002F     FP_SIGN         EQU     FP_CARRY+5
  407:          N      0030     FP_EXP          EQU     FP_CARRY+6
  408:          B        78     MSIGN           BIT     FP_SIGN.0
  409:          B        50     XSIGN           BIT     FP_CARRY.0
  410:          B        51     FOUND_RADIX     BIT     FP_CARRY.1
  411:          B        52     FIRST_RADIX     BIT     FP_CARRY.2
  412:          B        53     DONE_LOAD       BIT     FP_CARRY.3
  413:          N      002B     FP_NIB1         EQU     FP_DIG12
  414:          N      002C     FP_NIB2         EQU     FP_NIB1+1
  415:          N      002D     FP_NIB3         EQU     FP_NIB1+2
  416:          N      002E     FP_NIB4         EQU     FP_NIB1+3
  417:          N      002F     FP_NIB5         EQU     FP_NIB1+4
  418:          N      0030     FP_NIB6         EQU     FP_NIB1+5
  419:          N      0031     FP_NIB7         EQU     FP_NIB1+6
  420:          N      0032     FP_NIB8         EQU     FP_NIB1+7
  421:          N      0033     FP_ACCX         EQU     FP_NIB1+8
  422:          N      0034     FP_ACCC         EQU     FP_NIB1+9
  423:          N      0035     FP_ACC1         EQU     FP_NIB1+10
  424:          N      0036     FP_ACC2         EQU     FP_NIB1+11
  425:          N      0037     FP_ACC3         EQU     FP_NIB1+12
  426:          N      0038     FP_ACC4         EQU     FP_NIB1+13
  427:          N      0039     FP_ACC5         EQU     FP_NIB1+14
  428:          N      003A     FP_ACC6         EQU     FP_NIB1+15
  429:          N      003B     FP_ACC7         EQU     FP_NIB1+16
  430:          N      003C     FP_ACC8         EQU     FP_NIB1+17
  431:          N      003D     FP_ACCS         EQU     FP_NIB1+18
  432:                                  ;
  433:
  434:          C      2080     FP_BASE         EQU     $
  435:
  436:                                  ;**************************************************************
  437:                                  ;
  438:                                  ; The floating point entry points and jump table
  439:                                  ;
  440:                                  ;**************************************************************
  441:                                  ;
  442:    2080  01 B2                           AJMP    FLOATING_ADD
  443:    2082  01 A8                           AJMP    FLOATING_SUB
  444:    2084  21 65                           AJMP    FLOATING_COMP
  445:    2086  21 96                           AJMP    FLOATING_MUL
  446:    2088  21 CB                           AJMP    FLOATING_DIV
  447:    208A  61 92                           AJMP    HEXSCAN
  448:    208C  61 CB                           AJMP    FLOATING_POINT_INPUT
  449:    208E  81 83                           AJMP    FLOATING_POINT_OUTPUT
  450:    2090  C1 00                           AJMP    CONVERT_BINARY_TO_ASCII_STRING
  451:    2092  A1 A7                           AJMP    CONVERT_ASCII_STRING_TO_BINARY
  452:    2094  A1 DC                           AJMP    MULNUM10
  453:    2096  C1 48                           AJMP    FPHEXOUT
  454:                          ;
  455:                          ; the remaining jump to routines were extracted from basic52
  456:                          ; by me to make the floating point software stand alone
  457:                          ;
  458:    2098  61 BF                           AJMP    PUSHR2R0                        ; INTEGER to FLOAT
  459:    209A  C1 92                           AJMP    IFIX                            ; FLOAT to INTEGER
  460:    209C  C1 D3                           AJMP    PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
  461:    209E  C1 CF                           AJMP    POPAS                           ; POP ARGUMENT TO R3:R1
  462:    20A0  C1 F0                           AJMP    MOVAS                           ; COPY ARGUMENT
  463:    20A2  E1 13                           AJMP    AINT                            ; INT FUNCTION
  464:    20A4  E1 3B                           AJMP    PUSHC                           ; PUSH ARG IN DPTR TO STACK
  465:
  466:    20A6  22              PRTERR:         RET
  467:    20A7  22              BADPRM:         RET
  468:
  469:                                  ;
  470:                                  ;
  471:    20A8                  FLOATING_SUB:
  472:                                  ;
  473:    20A8  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
  474:    20AB  A8 24                           MOV     R0,ARG_STACK
  475:    20AD  18                              DEC     R0                              ;POINT TO SIGN
  476:    20AE  E2                              MOVX    A,@R0                           ;READ SIGN
  477:    20AF  B2 E0                           CPL     ACC.0
  478:    20B1  F2                              MOVX    @R0,A
  479:                                  ;
  480:                                  ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  481:                                  ;
  482:    20B2                  FLOATING_ADD:
  483:                                  ;
  484:                                  ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  485:                                  ;
  486:                                  ;
  487:    20B2  71 73                           ACALL   MDES1                           ;R7=TOS EXP, R6=TOS-1 EXP, R4=TOS SIGN
  488:                                                                                                                          ;R3=TOS-1 SIGN, OPERATION IS R1 # R0
  489:                                  ;
  490:    20B4  EF                              MOV     A,R7                            ;GET TOS EXPONENT
  491:    20B5  60 0D                           JZ      POP_AND_EXIT                    ;IF TOS=0 THEN POP AND EXIT
  492:    20B7  BE 00 12                        CJNE    R6,#0,LOAD1                     ;CLEAR CARRY EXIT IF ZERO
  493:                                  ;
  494:                                  ;**************************************************************
  495:                                  ;
  496:    20BA                  SWAP_AND_EXIT:                                          ; Swap external args and return
  497:                                  ;
  498:                                  ;**************************************************************
  499:                                  ;
  500:    20BA  71 67                           ACALL   LOAD_POINTERS
  501:    20BC  7F 06                           MOV     R7,#FP_NUMBER_SIZE
  502:                                  ;
  503:    20BE  E2              SE1:            MOVX    A,@R0                           ;SWAP THE ARGUMENTS
  504:    20BF  F3                              MOVX    @R1,A
  505:    20C0  18                              DEC     R0
  506:    20C1  19                              DEC     R1
  507:    20C2  DF FA                           DJNZ    R7,SE1
  508:                                  ;
  509:    20C4                  POP_AND_EXIT:
  510:                                  ;
  511:    20C4  E5 24                           MOV     A,ARG_STACK                     ;POP THE STACK
  512:    20C6  24 06                           ADD     A,#FP_NUMBER_SIZE
  513:    20C8  F5 24                           MOV     ARG_STACK,A
  514:    20CA  E4                              CLR             A
  515:    20CB  22                              RET
  516:                                  ;
  517:                                  ;
  518:    20CC  9E              LOAD1:          SUBB    A,R6                            ;A = ARG 1 EXP - ARG 2 EXP
  519:    20CD  8F 30                           MOV     FP_EXP,R7                       ;SAVE EXPONENT AND SIGN
  520:    20CF  8C 2F                           MOV     FP_SIGN,R4
  521:    20D1  50 09                           JNC     LOAD2                           ;ARG1 EXPONENT IS LARGER OR SAME
  522:    20D3  8E 30                           MOV     FP_EXP,R6
  523:    20D5  8B 2F                           MOV     FP_SIGN,R3
  524:    20D7  F4                              CPL     A
  525:    20D8  04                              INC     A                               ;COMPENSATE FOR EXP DELTA
  526:    20D9  C8                              XCH     A,R0                            ;FORCE R0 TO POINT AT THE LARGEST
  527:    20DA  C9                              XCH     A,R1                            ;EXPONENT
  528:    20DB  C8                              XCH     A,R0
  529:                                  ;
  530:    20DC  FF              LOAD2:          MOV     R7,A                            ;SAVE THE EXPONENT DELTA IN R7
  531:    20DD  C2 33                           CLR     ADD_IN
  532:    20DF  BD 00 02                        CJNE    R5,#0,$+5
  533:    20E2  D2 33                           SETB    ADD_IN
  534:                                  ;
  535:                                  ; Load the R1 mantissa
  536:                                  ;
  537:    20E4  71 84                           ACALL   LOADR1_MANTISSA                 ;LOAD THE SMALLEST NUMBER
  538:                                  ;
  539:                                  ; Now align the number to the delta exponent
  540:                                  ; R4 points to the string of the last digits lost
  541:                                  ;
  542:    20E6  BF 0B 00                        CJNE    R7,#DIGIT+DIGIT+3,$+3
  543:    20E9  40 02                           JC      $+4
  544:    20EB  7F 0A                           MOV     R7,#DIGIT+DIGIT+2
  545:                                  ;
  546:    20ED  75 2A 00                        MOV     FP_CARRY,#00                    ;CLEAR THE CARRY
  547:    20F0  51 C4                           ACALL   RIGHT                           ;SHIFT THE NUMBER
  548:                                  ;
  549:                                  ; Set up for addition and subtraction
  550:                                  ;
  551:    20F2  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  552:    20F4  79 2E                           MOV     R1,#FP_DIG78
  553:    20F6  74 9E                           MOV     A,#9EH
  554:    20F8  C3                              CLR     C
  555:    20F9  9C                              SUBB    A,R4
  556:    20FA  D4                              DA      A
  557:    20FB  CC                              XCH     A,R4
  558:    20FC  70 01                           JNZ     $+3
  559:    20FE  FC                              MOV     R4,A
  560:    20FF  B4 50 00                        CJNE    A,#50H,$+3                      ;TEST FOR SUBTRACTION
  561:    2102  30 33 18                        JNB     ADD_IN,SUBLP                    ;DO SUBTRACTION IF NO ADD_IN
  562:    2105  B3                              CPL     C                               ;FLIP CARRY FOR ADDITION
  563:    2106  31 14                           ACALL   ADDLP                           ;DO ADDITION
  564:                                  ;
  565:    2108  50 08                           JNC     ADD_R
  566:    210A  05 2A                           INC     FP_CARRY
  567:    210C  7F 01                           MOV     R7,#1
  568:    210E  51 C4                           ACALL   RIGHT
  569:    2110  51 7B                           ACALL   INC_FP_EXP                      ;SHIFT AND BUMP EXPONENT
  570:                                  ;
  571:    2112  41 6C           ADD_R:          AJMP    STORE_ALIGN_TEST_AND_EXIT
  572:                                  ;
  573:    2114  E2              ADDLP:          MOVX    A,@R0
  574:    2115  37                              ADDC    A,@R1
  575:    2116  D4                              DA      A
  576:    2117  F7                              MOV     @R1,A
  577:    2118  18                              DEC     R0
  578:    2119  19                              DEC     R1
  579:    211A  DF F8                           DJNZ    R7,ADDLP                        ;LOOP UNTIL DONE
  580:    211C  22                              RET
  581:                                  ;
  582:                                  ;
  583:    211D  E2              SUBLP:          MOVX    A,@R0                           ;NOW DO SUBTRACTION
  584:    211E  FE                              MOV     R6,A
  585:    211F  E4                              CLR     A
  586:    2120  34 99                           ADDC    A,#99H
  587:    2122  97                              SUBB    A,@R1
  588:    2123  2E                              ADD     A,R6
  589:    2124  D4                              DA      A
  590:    2125  F7                              MOV     @R1,A
  591:    2126  18                              DEC     R0
  592:    2127  19                              DEC     R1
  593:    2128  DF F3                           DJNZ    R7,SUBLP
  594:    212A  40 11                           JC      FSUB6
  595:                                  ;
  596:                                  ;
  597:                                  ; Need to complement the result and sign because the floating
  598:                                  ; point accumulator mantissa was larger than the external
  599:                                  ; memory and their signs were equal.
  600:                                  ;
  601:    212C  B2 78                           CPL     FP_SIGN.0
  602:    212E  79 2E                           MOV     R1,#FP_DIG78
  603:    2130  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  604:                                  ;
  605:    2132  74 9A           FSUB5:          MOV     A,#9AH
  606:    2134  97                              SUBB    A,@R1
  607:    2135  24 00                           ADD     A,#0
  608:    2137  D4                              DA      A
  609:    2138  F7                              MOV     @R1,A
  610:    2139  19                              DEC     R1
  611:    213A  B3                              CPL     C
  612:    213B  DF F5                           DJNZ    R7,FSUB5                        ;LOOP
  613:                                  ;
  614:                                  ; Now see how many zeros their are
  615:                                  ;
  616:    213D  78 2B           FSUB6:          MOV     R0,#FP_DIG12
  617:    213F  7F 00                           MOV     R7,#0
  618:                                  ;
  619:    2141  E6              FSUB7:          MOV     A,@R0
  620:    2142  70 08                           JNZ     FSUB8
  621:    2144  0F                              INC     R7
  622:    2145  0F                              INC     R7
  623:    2146  08                              INC     R0
  624:    2147  B8 2F F7                        CJNE    R0,#FP_SIGN,FSUB7
  625:    214A  41 B4                           AJMP    ZERO_AND_EXIT
  626:                                  ;
  627:    214C  B4 10 00        FSUB8:          CJNE    A,#10H,$+3
  628:    214F  50 01                           JNC     FSUB9
  629:    2151  0F                              INC     R7
  630:                                  ;
  631:                                  ; Now R7 has the number of leading zeros in the FP ACC
  632:                                  ;
  633:    2152  E5 30           FSUB9:          MOV     A,FP_EXP                        ;GET THE OLD EXPONENT
  634:    2154  C3                              CLR     C
  635:    2155  9F                              SUBB    A,R7                            ;SUBTRACT FROM THE NUMBER OF ZEROS
  636:    2156  60 0B                           JZ      FSUB10
  637:    2158  40 09                           JC      FSUB10
  638:                                  ;
  639:    215A  F5 30                           MOV     FP_EXP,A                        ;SAVE THE NEW EXPONENT
  640:                                  ;
  641:    215C  51 FE                           ACALL   LEFT1                           ;SHIFT THE FP ACC
  642:    215E  75 2A 00                        MOV     FP_CARRY,#0
  643:    2161  41 6C                           AJMP    STORE_ALIGN_TEST_AND_EXIT
  644:                                  ;
  645:    2163  41 AE           FSUB10:         AJMP    UNDERFLOW_AND_EXIT
  646:                                  ;
  647:                                  ;***************************************************************
  648:                                  ;
  649:    2165                  FLOATING_COMP:  ; Compare two floating point numbers
  650:                                          ; used for relational operations and is faster
  651:                                          ; than subtraction. ON RETURN, The carry is set
  652:                                          ; if ARG1 is > ARG2, else carry is not set
  653:                                          ; if ARG1 = ARG2, F0 gets set
  654:                                  ;
  655:                                  ;***************************************************************
  656:                                  ;
  657:    2165  71 73                           ACALL   MDES1                           ;SET UP THE REGISTERS
  658:    2167  E5 24                           MOV     A,ARG_STACK
  659:    2169  24 0C                           ADD     A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
  660:    216B  F5 24                           MOV     ARG_STACK,A                     ;POP THE STACK TWICE, CLEAR THE CARRY
  661:    216D  EE                              MOV     A,R6                            ;CHECK OUT EXPONENTS
  662:    216E  C2 D5                           CLR     F0
  663:    2170  C3                              CLR     C
  664:    2171  9F                              SUBB    A,R7
  665:    2172  60 0A                           JZ      EXPONENTS_EQUAL
  666:    2174  40 03                           JC      ARG1_EXP_IS_LARGER
  667:                                  ;
  668:                                  ; Now the ARG2 EXPONENT is > ARG1 EXPONENT
  669:                                  ;
  670:    2176                  SIGNS_DIFFERENT:
  671:                                  ;
  672:    2176  EB                              MOV     A,R3                            ;SEE IF SIGN OF ARG2 IS POSITIVE
  673:    2177  80 01                           SJMP    $+3
  674:                                  ;
  675:    2179                  ARG1_EXP_IS_LARGER:
  676:                                  ;
  677:    2179  EC                              MOV     A,R4                            ;GET THE SIGN OF ARG1 EXPONENT
  678:    217A  60 01                           JZ      $+3
  679:    217C  B3                              CPL     C
  680:    217D  22                              RET
  681:                                  ;
  682:    217E                  EXPONENTS_EQUAL:
  683:                                  ;
  684:                                  ; First, test the sign, then the mantissa
  685:                                  ;
  686:    217E  BD 00 F5                        CJNE    R5,#0,SIGNS_DIFFERENT
  687:                                  ;
  688:    2181                  BOTH_PLUS:
  689:                                  ;
  690:    2181  7F 04                           MOV     R7,#DIGIT                       ;POINT AT MS DIGIT
  691:    2183  18                              DEC     R0
  692:    2184  18                              DEC     R0
  693:    2185  18                              DEC     R0
  694:    2186  19                              DEC     R1
  695:    2187  19                              DEC     R1
  696:    2188  19                              DEC     R1
  697:                                  ;
  698:                                  ; Now do the compare
  699:                                  ;
  700:    2189  E2              CLOOP:          MOVX    A,@R0
  701:    218A  FE                              MOV     R6,A
  702:    218B  E3                              MOVX    A,@R1
  703:    218C  9E                              SUBB    A,R6
  704:    218D  70 EA                           JNZ     ARG1_EXP_IS_LARGER
  705:    218F  08                              INC     R0
  706:    2190  09                              INC     R1
  707:    2191  DF F6                           DJNZ    R7,CLOOP
  708:                                  ;
  709:                                  ; If here, the numbers are the same, the carry is cleared
  710:                                  ;
  711:    2193  D2 D5                           SETB    F0
  712:    2195  22                              RET                                     ;EXIT WITH EQUAL
  713:                                  ;
  714:                          ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  715:                          ;
  716:    2196                  FLOATING_MUL:                                           ; Floating point multiply
  717:                          ;
  718:                          ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  719:                          ;
  720:    2196  71 71                           ACALL   MUL_DIV_EXP_AND_SIGN
  721:                                  ;
  722:                                  ; check for zero exponents
  723:                                  ;
  724:    2198  BE 00 02                        CJNE    R6,#00,$+5                      ;ARG 2 EXP ZERO?
  725:    219B  41 B4                           AJMP    ZERO_AND_EXIT
  726:                                  ;
  727:                                  ; calculate the exponent
  728:                                  ;
  729:    219D  8D 2F           FMUL1:          MOV     FP_SIGN,R5                      ;SAVE THE SIGN, IN CASE OF FAILURE
  730:                                  ;
  731:    219F  EF                              MOV     A,R7
  732:    21A0  60 F9                           JZ      FMUL1-2
  733:    21A2  2E                              ADD     A,R6                            ;ADD THE EXPONENTS
  734:    21A3  20 E7 05                        JB      ACC.7,FMUL_OVER
  735:    21A6  10 D7 06                        JBC     CY,FMUL2                        ;SEE IF CARRY IS SET
  736:                                  ;
  737:    21A9  41 AE                           AJMP    UNDERFLOW_AND_EXIT
  738:                                  ;
  739:    21AB                  FMUL_OVER:
  740:                                  ;
  741:    21AB  50 02                           JNC     FMUL2                           ;OK IF SET
  742:                                  ;
  743:    21AD  41 9D           FOV:            AJMP    OVERFLOW_AND_EXIT
  744:                                  ;
  745:    21AF  94 81           FMUL2:          SUBB    A,#129                          ;SUBTRACT THE EXPONENT BIAS
  746:    21B1  FE                              MOV     R6,A                            ;SAVE IT FOR LATER
  747:                                  ;
  748:                                  ; Unpack and load R0
  749:                                  ;
  750:    21B2  51 87                           ACALL   UNPACK_R0
  751:                                  ;
  752:                                  ; Now set up for loop multiply
  753:                                  ;
  754:    21B4  7B 04                           MOV     R3,#DIGIT
  755:    21B6  AC 01                           MOV     R4,R1B0
  756:                                  ;
  757:                                  ;
  758:                                  ; Now, do the multiply and accumulate the product
  759:                                  ;
  760:    21B8  8C 01           FMUL3:          MOV     R1B0,R4
  761:    21BA  E3                              MOVX    A,@R1
  762:    21BB  FA                              MOV     R2,A
  763:    21BC  71 34                           ACALL   MUL_NIBBLE
  764:                                  ;
  765:    21BE  EA                              MOV     A,R2
  766:    21BF  C4                              SWAP    A
  767:    21C0  71 34                           ACALL   MUL_NIBBLE
  768:    21C2  1C                              DEC     R4
  769:    21C3  DB F3                           DJNZ    R3,FMUL3
  770:                                  ;
  771:                                  ; Now, pack and restore the sign
  772:                                  ;
  773:    21C5  8E 30                           MOV     FP_EXP,R6
  774:    21C7  8D 2F                           MOV     FP_SIGN,R5
  775:    21C9  41 2C                           AJMP    PACK                            ;FINISH IT OFF
  776:                                  ;
  777:                                  ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  778:                                  ;
  779:    21CB                  FLOATING_DIV:
  780:                                  ;
  781:                                  ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  782:                                  ;
  783:    21CB  71 73                           ACALL   MDES1
  784:                                  ;
  785:                                  ; Check the exponents
  786:                                  ;
  787:    21CD  8D 2F                           MOV     FP_SIGN,R5                      ;SAVE THE SIGN
  788:    21CF  BF 00 06                        CJNE    R7,#0,DIV0                      ;CLEARS THE CARRY
  789:    21D2  51 9D                           ACALL   OVERFLOW_AND_EXIT
  790:    21D4  E4                              CLR     A
  791:    21D5  D2 E3                           SETB    ACC.ZERO_DIVIDE
  792:    21D7  22                              RET
  793:                                  ;
  794:    21D8  EE              DIV0:           MOV     A,R6                            ;GET EXPONENT
  795:    21D9  60 C0                           JZ      FMUL1-2                         ;EXIT IF ZERO
  796:    21DB  9F                              SUBB    A,R7                            ;DELTA EXPONENT
  797:    21DC  20 E7 04                        JB      ACC.7,D_UNDER
  798:    21DF  50 04                           JNC     DIV3
  799:    21E1  41 AE                           AJMP    UNDERFLOW_AND_EXIT
  800:                                  ;
  801:    21E3  50 C8           D_UNDER:        JNC     FOV
  802:                                  ;
  803:    21E5  24 81           DIV3:           ADD     A,#129                          ;CORRECTLY BIAS THE EXPONENT
  804:    21E7  F5 30                           MOV     FP_EXP,A                        ;SAVE THE EXPONENT
  805:    21E9  71 84                           ACALL   LOADR1_MANTISSA                 ;LOAD THE DIVIDED
  806:                                  ;
  807:    21EB  7A 34                           MOV     R2,#FP_ACCC                     ;SAVE LOCATION
  808:    21ED  AB 00                           MOV     R3,R0B0                         ;SAVE POINTER IN R3
  809:    21EF  75 2A 00                        MOV     FP_CARRY,#0                     ;ZERO CARRY BYTE
  810:                                  ;
  811:    21F2  7D FF           DIV4:           MOV     R5,#0FFH                        ;LOOP COUNT
  812:    21F4  D3                              SETB    C
  813:                                  ;
  814:    21F5  8B 00           DIV5:           MOV     R0B0,R3                         ;RESTORE THE EXTERNAL POINTER
  815:    21F7  79 2E                           MOV     R1,#FP_DIG78                    ;SET UP INTERNAL POINTER
  816:    21F9  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  817:    21FB  50 17                           JNC     DIV7                            ;EXIT IF NO CARRY
  818:                                  ;
  819:    21FD  E2              DIV6:           MOVX    A,@R0                           ;DO ACCUMLATION
  820:    21FE  FE                              MOV     R6,A
  821:    21FF  E4                              CLR     A
  822:    2200  34 99                           ADDC    A,#99H
  823:    2202  9E                              SUBB    A,R6
  824:    2203  27                              ADD     A,@R1
  825:    2204  D4                              DA      A
  826:    2205  F7                              MOV     @R1,A
  827:    2206  18                              DEC     R0
  828:    2207  19                              DEC     R1
  829:    2208  DF F3                           DJNZ    R7,DIV6                         ;LOOP
  830:                                  ;
  831:    220A  0D                              INC     R5                              ;SUBTRACT COUNTER
  832:    220B  40 E8                           JC      DIV5                            ;KEEP LOOPING IF CARRY
  833:    220D  E7                              MOV     A,@R1                           ;GET CARRY
  834:    220E  94 01                           SUBB    A,#1                            ;CARRY IS CLEARED
  835:    2210  F7                              MOV     @R1,A                           ;SAVE CARRY DIGIT
  836:    2211  B3                              CPL     C
  837:    2212  80 E1                           SJMP    DIV5                            ;LOOP
  838:                                  ;
  839:                                  ; Restore the result if carry was found
  840:                                  ;
  841:    2214  31 14           DIV7:           ACALL   ADDLP                           ;ADD NUMBER BACK
  842:    2216  77 00                           MOV     @R1,#0                          ;CLEAR CARRY
  843:    2218  8A 00                           MOV     R0B0,R2                         ;GET SAVE COUNTER
  844:    221A  A6 05                           MOV     @R0,5                           ;SAVE COUNT BYTE
  845:                                  ;
  846:    221C  0A                              INC     R2                              ;ADJUST SAVE COUNTER
  847:    221D  7F 01                           MOV     R7,#1                           ;BUMP DIVIDEND
  848:    221F  51 FC                           ACALL   LEFT
  849:    2221  BA 3E CE                        CJNE    R2,#FP_ACC8+2,DIV4
  850:                                  ;
  851:    2224  D5 30 02                        DJNZ    FP_EXP,DIV8
  852:    2227  41 AE                           AJMP    UNDERFLOW_AND_EXIT
  853:                                  ;
  854:    2229  75 2A 00        DIV8:           MOV     FP_CARRY,#0
  855:                                  ;
  856:                                  ;***************************************************************
  857:                                  ;
  858:    222C                  PACK:   ; Pack the mantissa
  859:                                  ;
  860:                                  ;***************************************************************
  861:                                  ;
  862:                                  ; First, set up the pointers
  863:                                  ;
  864:    222C  78 34                           MOV     R0,#FP_ACCC
  865:    222E  E6                              MOV     A,@R0                           ;GET FP_ACCC
  866:    222F  FE                              MOV     R6,A                            ;SAVE FOR ZERO COUNT
  867:    2230  60 03                           JZ      PACK0                           ;JUMP OVER IF ZERO
  868:    2232  51 7B                           ACALL   INC_FP_EXP                      ;BUMP THE EXPONENT
  869:    2234  18                              DEC     R0
  870:                                  ;
  871:    2235  08              PACK0:          INC     R0                              ;POINT AT FP_ACC1
  872:                                  ;
  873:    2236  74 08           PACK1:          MOV     A,#8                            ;ADJUST NIBBLE POINTER
  874:    2238  F9                              MOV     R1,A
  875:    2239  28                              ADD     A,R0
  876:    223A  F8                              MOV     R0,A
  877:    223B  B6 05 00                        CJNE    @R0,#5,$+3                      ;SEE IF ADJUSTING NEEDED
  878:    223E  40 13                           JC      PACK3+1
  879:                                  ;
  880:    2240  D3              PACK2:          SETB    C
  881:    2241  E4                              CLR     A
  882:    2242  18                              DEC     R0
  883:    2243  36                              ADDC    A,@R0
  884:    2244  D4                              DA      A
  885:    2245  D6                              XCHD    A,@R0                           ;SAVE THE VALUE
  886:    2246  30 E4 09                        JNB     ACC.4,PACK3
  887:    2249  D9 F5                           DJNZ    R1,PACK2
  888:                                  ;
  889:    224B  18                              DEC     R0
  890:    224C  76 01                           MOV     @R0,#1
  891:    224E  51 7B                           ACALL   INC_FP_EXP
  892:    2250  80 06                           SJMP    PACK4
  893:                                  ;
  894:    2252  19              PACK3:          DEC     R1
  895:    2253  E9                              MOV     A,R1
  896:    2254  C3                              CLR     C
  897:    2255  C8                              XCH     A,R0
  898:    2256  98                              SUBB    A,R0
  899:    2257  F8                              MOV     R0,A
  900:                                  ;
  901:    2258  79 2B           PACK4:          MOV     R1,#FP_DIG12
  902:                                  ;
  903:                                  ; Now, pack
  904:                                  ;
  905:    225A  E6              PLOOP:          MOV     A,@R0
  906:    225B  C4                              SWAP    A                               ;FLIP THE DIGITS
  907:    225C  08                              INC     R0
  908:    225D  D6                              XCHD    A,@R0
  909:    225E  42 06                           ORL     6,A                             ;ACCUMULATE THE OR'ED DIGITS
  910:    2260  F7                              MOV     @R1,A
  911:    2261  08                              INC     R0
  912:    2262  09                              INC     R1
  913:    2263  B9 2F F4                        CJNE    R1,#FP_SIGN,PLOOP
  914:    2266  EE                              MOV     A,R6
  915:    2267  70 03                           JNZ     STORE_ALIGN_TEST_AND_EXIT
  916:    2269  75 30 00                        MOV     FP_EXP,#0                       ;ZERO EXPONENT
  917:                                  ;
  918:                                  ;**************************************************************
  919:                                  ;
  920:    226C                  STORE_ALIGN_TEST_AND_EXIT:                              ;Save the number align carry and exit
  921:                                  ;
  922:                                  ;**************************************************************
  923:                                  ;
  924:    226C  71 67                           ACALL   LOAD_POINTERS
  925:    226E  89 24                           MOV     ARG_STACK,R1                    ;SET UP THE NEW STACK
  926:    2270  78 30                           MOV     R0,#FP_EXP
  927:                                  ;
  928:                                  ; Now load the numbers
  929:                                  ;
  930:    2272  E6              STORE2:         MOV     A,@R0
  931:    2273  F3                              MOVX    @R1,A                           ;SAVE THE NUMBER
  932:    2274  18                              DEC     R0
  933:    2275  19                              DEC     R1
  934:    2276  B8 2A F9                        CJNE    R0,#FP_CARRY,STORE2
  935:                                  ;
  936:    2279  E4                              CLR     A                               ;NO ERRORS
  937:                                  ;
  938:    227A  22              PRET:           RET                                     ;EXIT
  939:                                  ;
  940:    227B                  INC_FP_EXP:
  941:                                  ;
  942:    227B  05 30                           INC     FP_EXP
  943:    227D  E5 30                           MOV     A,FP_EXP
  944:    227F  70 F9                           JNZ     PRET                            ;EXIT IF NOT ZERO
  945:    2281  D0 E0                           POP     ACC                             ;WASTE THE CALLING STACK
  946:    2283  D0 E0                           POP     ACC
  947:    2285  41 9D                           AJMP    OVERFLOW_AND_EXIT
  948:                                  ;
  949:                          ;***********************************************************************
  950:                          ;
  951:    2287                  UNPACK_R0:      ; Unpack BCD digits and load into nibble locations
  952:                          ;
  953:                          ;***********************************************************************
  954:                                  ;
  955:    2287  C0 01                           PUSH    R1B0
  956:    2289  79 32                           MOV     R1,#FP_NIB8
  957:                                  ;
  958:    228B  E2              ULOOP:          MOVX    A,@R0
  959:    228C  54 0F                           ANL     A,#0FH
  960:    228E  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE
  961:    228F  E2                              MOVX    A,@R0
  962:    2290  C4                              SWAP    A
  963:    2291  54 0F                           ANL     A,#0FH
  964:    2293  19                              DEC     R1
  965:    2294  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE AGAIN
  966:    2295  18                              DEC     R0
  967:    2296  19                              DEC     R1
  968:    2297  B9 2A F1                        CJNE    R1,#FP_NIB1-1,ULOOP
  969:                                  ;
  970:    229A  D0 01                           POP     R1B0
  971:                                  ;
  972:    229C  22              LOAD7:          RET
  973:                                  ;
  974:                                  ;**************************************************************
  975:                                  ;
  976:    229D                  OVERFLOW_AND_EXIT:      ;LOAD 99999999 E+127,  SET OV BIT, AND EXIT
  977:                                  ;
  978:                                  ;**************************************************************
  979:                                  ;
  980:    229D  78 2E                           MOV     R0,#FP_DIG78
  981:    229F  74 99                           MOV     A,#99H
  982:                                  ;
  983:    22A1  F6              OVE1:           MOV     @R0,A
  984:    22A2  18                              DEC     R0
  985:    22A3  B8 2A FB                        CJNE    R0,#FP_CARRY,OVE1
  986:                                  ;
  987:    22A6  75 30 FF                        MOV     FP_EXP,#0FFH
  988:    22A9  51 6C                           ACALL   STORE_ALIGN_TEST_AND_EXIT
  989:                                  ;
  990:    22AB  D2 E1                           SETB    ACC.OVERFLOW
  991:    22AD  22                              RET
  992:                                  ;
  993:                                  ;**************************************************************
  994:                                  ;
  995:    22AE                  UNDERFLOW_AND_EXIT:     ;LOAD 0, SET UF BIT, AND EXIT
  996:                                  ;
  997:                                  ;**************************************************************
  998:                                  ;
  999:    22AE  51 B4                           ACALL   ZERO_AND_EXIT
 1000:    22B0  E4                              CLR     A
 1001:    22B1  D2 E0                           SETB    ACC.UNDERFLOW
 1002:    22B3  22                              RET
 1003:                                  ;
 1004:                                  ;**************************************************************
 1005:                                  ;
 1006:    22B4                  ZERO_AND_EXIT:          ;LOAD 0, SET ZERO BIT, AND EXIT
 1007:                                  ;
 1008:                                  ;**************************************************************
 1009:                                  ;
 1010:    22B4  51 BB                           ACALL   FP_CLEAR
 1011:    22B6  51 6C                           ACALL   STORE_ALIGN_TEST_AND_EXIT
 1012:    22B8  D2 E2                           SETB    ACC.ZERO
 1013:    22BA  22                              RET                                     ;EXIT
 1014:                                  ;
 1015:                                  ;**************************************************************
 1016:                                  ;
 1017:    22BB                  FP_CLEAR:
 1018:                                  ;
 1019:                                  ; Clear internal storage
 1020:                                  ;
 1021:                                  ;**************************************************************
 1022:                                  ;
 1023:    22BB  E4                              CLR     A
 1024:    22BC  78 3D                           MOV     R0,#FP_ACC8+1
 1025:                                  ;
 1026:    22BE  F6              FPC1:           MOV     @R0,A
 1027:    22BF  18                              DEC     R0
 1028:    22C0  B8 29 FB                        CJNE    R0,#FP_TEMP,FPC1
 1029:    22C3  22                              RET
 1030:                                  ;
 1031:                                  ;**************************************************************
 1032:                                  ;
 1033:    22C4                  RIGHT:  ; Shift ACCUMULATOR RIGHT the number of nibbles in R7
 1034:                                  ; Save the shifted values in R4 if SAVE_ROUND is set
 1035:                                  ;
 1036:                                  ;**************************************************************
 1037:                                  ;
 1038:    22C4  7C 00                           MOV     R4,#0                           ;IN CASE OF NO SHIFT
 1039:                                  ;
 1040:    22C6  C3              RIGHT1:         CLR     C
 1041:    22C7  EF                              MOV     A,R7                            ;GET THE DIGITS TO SHIFT
 1042:    22C8  60 22                           JZ      RIGHT5-1                        ;EXIT IF ZERO
 1043:    22CA  94 02                           SUBB    A,#2                            ;TWO TO DO?
 1044:    22CC  50 1F                           JNC     RIGHT5                          ;SHIFT TWO NIBBLES
 1045:                                  ;
 1046:                                  ; Swap one nibble then exit
 1047:                                  ;
 1048:    22CE  C0 00           RIGHT3:         PUSH    R0B0                            ;SAVE POINTER REGISTER
 1049:    22D0  C0 01                           PUSH    R1B0
 1050:                                  ;
 1051:    22D2  79 2E                           MOV     R1,#FP_DIG78                    ;LOAD THE POINTERS
 1052:    22D4  78 2D                           MOV     R0,#FP_DIG56
 1053:    22D6  EC                              MOV     A,R4                            ;GET THE OVERFLOW REGISTER
 1054:    22D7  D7                              XCHD    A,@R1                           ;GET DIGIT 8
 1055:    22D8  C4                              SWAP    A                               ;FLIP FOR LOAD
 1056:    22D9  FC                              MOV     R4,A
 1057:                                  ;
 1058:    22DA  E7              RIGHTL:         MOV     A,@R1                           ;GET THE LOW ORDER BYTE
 1059:    22DB  D6                              XCHD    A,@R0                           ;SWAP NIBBLES
 1060:    22DC  C4                              SWAP    A                               ;FLIP FOR STORE
 1061:    22DD  F7                              MOV     @R1,A                           ;SAVE THE DIGITS
 1062:    22DE  18                              DEC     R0                              ;BUMP THE POINTERS
 1063:    22DF  19                              DEC     R1
 1064:    22E0  B9 2A F7                        CJNE    R1,#FP_DIG12-1,RIGHTL           ;LOOP
 1065:                                  ;
 1066:    22E3  E7                              MOV     A,@R1                           ;ACC = CH8
 1067:    22E4  C4                              SWAP    A                               ;ACC = 8CH
 1068:    22E5  54 0F                           ANL     A,#0FH                          ;ACC = 0CH
 1069:    22E7  F7                              MOV     @R1,A                           ;CARRY DONE
 1070:    22E8  D0 01                           POP     R1B0                            ;EXIT
 1071:    22EA  D0 00                           POP     R0B0                            ;RESTORE REGISTER
 1072:    22EC  22                              RET
 1073:                                  ;
 1074:    22ED  FF              RIGHT5:         MOV     R7,A                            ;SAVE THE NEW SHIFT NUMBER
 1075:    22EE  E4                              CLR     A
 1076:    22EF  C5 2A                           XCH     A,FP_CARRY                      ;SWAP THE NIBBLES
 1077:    22F1  C5 2B                           XCH     A,FP_DIG12
 1078:    22F3  C5 2C                           XCH     A,FP_DIG34
 1079:    22F5  C5 2D                           XCH     A,FP_DIG56
 1080:    22F7  C5 2E                           XCH     A,FP_DIG78
 1081:    22F9  FC                              MOV     R4,A                            ;SAVE THE LAST DIGIT SHIFTED
 1082:    22FA  80 CB                           SJMP    RIGHT1+1
 1083:                                  ;
 1084:                                  ;***************************************************************
 1085:                                  ;
 1086:    22FC                  LEFT:   ; Shift ACCUMULATOR LEFT the number of nibbles in R7
 1087:                                  ;
 1088:                                  ;***************************************************************
 1089:                                  ;
 1090:    22FC  7C 00                           MOV     R4,#00H                         ;CLEAR FOR SOME ENTRYS
 1091:                                  ;
 1092:    22FE  C3              LEFT1:          CLR     C
 1093:    22FF  EF                              MOV     A,R7                            ;GET SHIFT VALUE
 1094:    2300  60 22                           JZ      LEFT5-1                         ;EXIT IF ZERO
 1095:    2302  94 02                           SUBB    A,#2                            ;SEE HOW MANY BYTES TO SHIFT
 1096:    2304  50 1F                           JNC     LEFT5
 1097:                                  ;
 1098:    2306  C0 00           LEFT3:          PUSH    R0B0                            ;SAVE POINTER
 1099:    2308  C0 01                           PUSH    R1B0
 1100:    230A  78 2A                           MOV     R0,#FP_CARRY
 1101:    230C  79 2B                           MOV     R1,#FP_DIG12
 1102:                                  ;
 1103:    230E  E6                              MOV     A,@R0                           ;ACC=CHCL
 1104:    230F  C4                              SWAP    A                               ;ACC = CLCH
 1105:    2310  F6                              MOV     @R0,A                           ;ACC = CLCH, @R0 = CLCH
 1106:                                  ;
 1107:    2311  E7              LEFTL:          MOV     A,@R1                           ;DIG 12
 1108:    2312  C4                              SWAP    A                               ;DIG 21
 1109:    2313  D6                              XCHD    A,@R0
 1110:    2314  F7                              MOV     @R1,A                           ;SAVE IT
 1111:    2315  08                              INC     R0                              ;BUMP POINTERS
 1112:    2316  09                              INC     R1
 1113:    2317  B8 2E F7                        CJNE    R0,#FP_DIG78,LEFTL
 1114:                                  ;
 1115:    231A  EC                              MOV     A,R4
 1116:    231B  C4                              SWAP    A
 1117:    231C  D6                              XCHD    A,@R0
 1118:    231D  54 F0                           ANL     A,#0F0H
 1119:    231F  FC                              MOV     R4,A
 1120:                                  ;
 1121:    2320  D0 01                           POP     R1B0
 1122:    2322  D0 00                           POP     R0B0                            ;RESTORE
 1123:    2324  22                              RET                                     ;DONE
 1124:                                  ;
 1125:    2325  FF              LEFT5:          MOV     R7,A                            ;RESTORE COUNT
 1126:    2326  E4                              CLR     A
 1127:    2327  CC                              XCH     A,R4                            ;GET THE RESTORATION BYTE
 1128:    2328  C5 2E                           XCH     A,FP_DIG78                      ;DO THE SWAP
 1129:    232A  C5 2D                           XCH     A,FP_DIG56
 1130:    232C  C5 2C                           XCH     A,FP_DIG34
 1131:    232E  C5 2B                           XCH     A,FP_DIG12
 1132:    2330  C5 2A                           XCH     A,FP_CARRY
 1133:    2332  80 CB                           SJMP    LEFT1+1
 1134:                                  ;
 1135:    2334                  MUL_NIBBLE:
 1136:                                  ;
 1137:                                  ; Multiply the nibble in R7 by the FP_NIB locations
 1138:                                  ; accumulate the product in FP_ACC
 1139:                                  ;
 1140:                                  ; Set up the pointers for multiplication
 1141:                                  ;
 1142:    2334  54 0F                           ANL     A,#0FH                          ;STRIP OFF MS NIBBLE
 1143:    2336  FF                              MOV     R7,A
 1144:    2337  78 3C                           MOV     R0,#FP_ACC8
 1145:    2339  79 32                           MOV     R1,#FP_NIB8
 1146:    233B  E4                              CLR     A
 1147:    233C  F5 33                           MOV     FP_ACCX,A
 1148:                                  ;
 1149:    233E  18              MNLOOP:         DEC     R0                              ;BUMP POINTER TO PROPAGATE CARRY
 1150:    233F  26                              ADD     A,@R0                           ;ATTEMPT TO FORCE CARRY
 1151:    2340  D4                              DA      A                               ;BCD ADJUST
 1152:    2341  30 E4 03                        JNB     ACC.4,MNL0                      ;DON'T ADJUST IF NO NEED
 1153:    2344  18                              DEC     R0                              ;PROPAGATE CARRY TO THE NEXT DIGIT
 1154:    2345  06                              INC     @R0                             ;DO THE ADJUSTING
 1155:    2346  08                              INC     R0                              ;RESTORE R0
 1156:                                  ;
 1157:    2347  D6              MNL0:           XCHD    A,@R0                           ;RESTORE INITIAL NUMBER
 1158:    2348  8F F0                           MOV     B,R7                            ;GET THE NUBBLE TO MULTIPLY
 1159:    234A  E7                              MOV     A,@R1                           ;GET THE OTHER NIBBLE
 1160:    234B  A4                              MUL     AB                              ;DO THE MULTIPLY
 1161:    234C  75 F0 0A                        MOV     B,#10                           ;NOW BCD ADJUST
 1162:    234F  84                              DIV     AB
 1163:    2350  C5 F0                           XCH     A,B                             ;GET THE REMAINDER
 1164:    2352  26                              ADD     A,@R0                           ;PROPAGATE THE PARTIAL PRODUCTS
 1165:    2353  D4                              DA      A                               ;BCD ADJUST
 1166:    2354  30 E4 02                        JNB     ACC.4,MNL1                      ;PROPAGATE PARTIAL PRODUCT CARRY
 1167:    2357  05 F0                           INC     B
 1168:                                  ;
 1169:    2359  08              MNL1:           INC     R0
 1170:    235A  D6                              XCHD    A,@R0                           ;SAVE THE NEW PRODUCT
 1171:    235B  18                              DEC     R0
 1172:    235C  E5 F0                           MOV     A,B                             ;GET BACK THE QUOTIENT
 1173:    235E  19                              DEC     R1
 1174:    235F  B9 2A DC                        CJNE    R1,#FP_NIB1-1,MNLOOP
 1175:                                  ;
 1176:    2362  25 33                           ADD     A,FP_ACCX                       ;GET THE OVERFLOW
 1177:    2364  D4                              DA      A                               ;ADJUST
 1178:    2365  F6                              MOV     @R0,A                           ;SAVE IT
 1179:    2366  22                              RET                                     ;EXIT
 1180:                                  ;
 1181:                                  ;***************************************************************
 1182:                                  ;
 1183:    2367                  LOAD_POINTERS:  ; Load the ARG_STACK into R0 and bump R1
 1184:                                  ;
 1185:                                  ;***************************************************************
 1186:                                  ;
 1187:    2367  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1188:    236A  A8 24                           MOV     R0,ARG_STACK
 1189:    236C  74 06                           MOV     A,#FP_NUMBER_SIZE
 1190:    236E  28                              ADD     A,R0
 1191:    236F  F9                              MOV     R1,A
 1192:    2370  22                              RET
 1193:                                  ;
 1194:                                  ;***************************************************************
 1195:                                  ;
 1196:    2371                  MUL_DIV_EXP_AND_SIGN:
 1197:                                  ;
 1198:                                  ; Load the sign into R7, R6. R5 gets the sign for
 1199:                                  ; multiply and divide.
 1200:                                  ;
 1201:                                  ;***************************************************************
 1202:                                  ;
 1203:    2371  51 BB                           ACALL   FP_CLEAR                        ;CLEAR INTERNAL MEMORY
 1204:                                  ;
 1205:    2373  71 67           MDES1:          ACALL   LOAD_POINTERS                   ;LOAD REGISTERS
 1206:    2375  E2                              MOVX    A,@R0                           ;ARG 1 EXP
 1207:    2376  FF                              MOV     R7,A                            ;SAVED IN R7
 1208:    2377  E3                              MOVX    A,@R1                           ;ARG 2 EXP
 1209:    2378  FE                              MOV     R6,A                            ;SAVED IN R6
 1210:    2379  18                              DEC     R0                              ;BUMP POINTERS TO SIGN
 1211:    237A  19                              DEC     R1
 1212:    237B  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1213:    237C  FC                              MOV     R4,A                            ;SIGN OF ARG1
 1214:    237D  E3                              MOVX    A,@R1                           ;GET SIGN OF NEXT ARG
 1215:    237E  FB                              MOV     R3,A                            ;SIGN OF ARG2
 1216:    237F  6C                              XRL     A,R4                            ;ACC GETS THE NEW SIGN
 1217:    2380  FD                              MOV     R5,A                            ;R5 GETS THE NEW SIGN
 1218:                                  ;
 1219:                                  ; Bump the pointers to point at the LS digit
 1220:                                  ;
 1221:    2381  18                              DEC     R0
 1222:    2382  19                              DEC     R1
 1223:                                  ;
 1224:    2383  22                              RET
 1225:                                  ;
 1226:                                  ;***************************************************************
 1227:                                  ;
 1228:    2384                  LOADR1_MANTISSA:
 1229:                                  ;
 1230:                                  ; Load the mantissa of R0 into FP_Digits
 1231:                                  ;
 1232:                                  ;***************************************************************
 1233:                                  ;
 1234:    2384  C0 00                           PUSH    R0B0                            ;SAVE REGISTER 1
 1235:    2386  78 2E                           MOV     R0,#FP_DIG78                    ;SET UP THE POINTER
 1236:                                  ;
 1237:    2388  E3              LOADR1:         MOVX    A,@R1
 1238:    2389  F6                              MOV     @R0,A
 1239:    238A  19                              DEC     R1
 1240:    238B  18                              DEC     R0
 1241:    238C  B8 2A F9                        CJNE    R0,#FP_CARRY,LOADR1
 1242:                                  ;
 1243:    238F  D0 00                           POP     R0B0
 1244:    2391  22                              RET
 1245:                                  ;
 1246:                                  ;***************************************************************
 1247:                                  ;
 1248:    2392                  HEXSCAN:        ; Scan a string to determine if it is a hex number
 1249:                                          ; set carry if hex, else carry = 0
 1250:                                  ;
 1251:                                  ;***************************************************************
 1252:                                  ;
 1253:    2392  91 68                           ACALL   GET_DPTR_CHARACTER
 1254:    2394  C0 83                           PUSH    DPH
 1255:    2396  C0 82                           PUSH    DPL                             ;SAVE THE POINTER
 1256:                                  ;
 1257:    2398  E0              HEXSC1:         MOVX    A,@DPTR                         ;GET THE CHARACTER
 1258:    2399  D1 76                           ACALL   DIGIT_CHECK                     ;SEE IF A DIGIT
 1259:    239B  40 12                           JC      HS1                             ;CONTINUE IF A DIGIT
 1260:    239D  71 B2                           ACALL   HEX_CHECK                       ;SEE IF HEX
 1261:    239F  40 0E                           JC      HS1
 1262:                                  ;
 1263:    23A1  C2 E5                           CLR     ACC.5                           ;NO LOWER CASE
 1264:    23A3  B4 48 03                        CJNE    A,#'H',HEXDON
 1265:    23A6  D3                              SETB    C
 1266:    23A7  80 01                           SJMP    HEXDO1                          ;NUMBER IS VALID HEX, MAYBE
 1267:                                  ;
 1268:    23A9  C3              HEXDON:         CLR     C
 1269:                                  ;
 1270:    23AA  D0 82           HEXDO1:         POP     DPL                             ;RESTORE POINTER
 1271:    23AC  D0 83                           POP     DPH
 1272:    23AE  22                              RET
 1273:                                  ;
 1274:    23AF  A3              HS1:            INC     DPTR                            ;BUMP TO NEXT CHARACTER
 1275:    23B0  80 E6                           SJMP    HEXSC1                          ;LOOP
 1276:                                  ;
 1277:    23B2                  HEX_CHECK:      ;CHECK FOR A VALID ASCII HEX, SET CARRY IF FOUND
 1278:                                  ;
 1279:    23B2  C2 E5                           CLR     ACC.5                           ;WASTE LOWER CASE
 1280:    23B4  B4 47 00                        CJNE    A,#'F'+1,$+3                    ;SEE IF F OR LESS
 1281:    23B7  40 01                           JC      HC1
 1282:    23B9  22                              RET
 1283:                                  ;
 1284:    23BA  B4 41 00        HC1:            CJNE    A,#'A',$+3                      ;SEE IF A OR GREATER
 1285:    23BD  B3                              CPL     C
 1286:    23BE  22                              RET
 1287:                                  ;
 1288:                                  ;
 1289:    23BF                  PUSHR2R0:
 1290:                                  ;
 1291:    23BF  7B 00                           MOV     R3,#HIGH CONVT                  ;CONVERSION LOCATION
 1292:    23C1  79 48                           MOV     R1,#LOW CONVT
 1293:    23C3  D1 00                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1294:    23C5  74 0D                           MOV     A,#0DH                          ;A CR TO TERMINATE
 1295:    23C7  F3                              MOVX    @R1,A                           ;SAVE THE CR
 1296:    23C8  90 00 48                        MOV     DPTR,#CONVT
 1297:                                  ;
 1298:                                  ; Falls thru to FLOATING INPUT
 1299:                                  ;
 1300:                                  ;***************************************************************
 1301:                                  ;
 1302:    23CB                  FLOATING_POINT_INPUT:   ; Input a floating point number pointed to by the DPTR
 1303:                                  ;
 1304:                                  ;***************************************************************
 1305:                                  ;
 1306:    23CB  51 BB                           ACALL   FP_CLEAR                        ;CLEAR EVERYTHING
 1307:    23CD  91 68                           ACALL   GET_DPTR_CHARACTER
 1308:    23CF  91 6E                           ACALL   PLUS_MINUS_TEST
 1309:    23D1  92 78                           MOV     MSIGN,C                         ;SAVE THE MANTISSA SIGN
 1310:                                  ;
 1311:                                  ; Now, set up for input loop
 1312:                                  ;
 1313:    23D3  78 34                           MOV     R0,#FP_ACCC
 1314:    23D5  7E 7F                           MOV     R6,#7FH                         ;BASE EXPONENT
 1315:    23D7  D2 D5                           SETB    F0                              ;SET INITIAL FLAG
 1316:                                  ;
 1317:    23D9  D1 74           INLOOP:         ACALL   GET_DIGIT_CHECK
 1318:    23DB  50 07                           JNC     GTEST                           ;IF NOT A CHARACTER, WHAT IS IT?
 1319:    23DD  54 0F                           ANL     A,#0FH                          ;STRIP ASCII
 1320:    23DF  91 41                           ACALL   STDIG                           ;STORE THE DIGITS
 1321:                                  ;
 1322:    23E1  A3              INLPIK:         INC     DPTR                            ;BUMP POINTER FOR LOOP
 1323:    23E2  80 F5                           SJMP    INLOOP                          ;LOOP FOR INPUT
 1324:                                  ;
 1325:    23E4  B4 2E 0C        GTEST:          CJNE    A,#'.',GT1                      ;SEE IF A RADIX
 1326:    23E7  20 51 63                        JB      FOUND_RADIX,INERR
 1327:    23EA  D2 51                           SETB    FOUND_RADIX
 1328:    23EC  B8 34 F2                        CJNE    R0,#FP_ACCC,INLPIK
 1329:    23EF  D2 52                           SETB    FIRST_RADIX                     ;SET IF FIRST RADIX
 1330:    23F1  80 EE                           SJMP    INLPIK                          ;GET ADDITIONAL DIGITS
 1331:                                  ;
 1332:    23F3  20 D5 57        GT1:            JB      F0,INERR                        ;ERROR IF NOT CLEARED
 1333:    23F6  B4 65 02                        CJNE    A,#'e',$+5                      ;CHECK FOR LOWER CASE
 1334:    23F9  80 03                           SJMP    $+5
 1335:    23FB  B4 45 33                        CJNE    A,#'E',FINISH_UP
 1336:    23FE  91 67                           ACALL   INC_AND_GET_DPTR_CHARACTER
 1337:    2400  91 6E                           ACALL   PLUS_MINUS_TEST
 1338:    2402  92 50                           MOV     XSIGN,C                         ;SAVE SIGN STATUS
 1339:    2404  D1 74                           ACALL   GET_DIGIT_CHECK
 1340:    2406  50 45                           JNC     INERR
 1341:                                  ;
 1342:    2408  54 0F                           ANL     A,#0FH                          ;STRIP ASCII BIAS OFF THE CHARACTER
 1343:    240A  FD                              MOV     R5,A                            ;SAVE THE CHARACTER IN R5
 1344:                                  ;
 1345:    240B  A3              GT2:            INC     DPTR
 1346:    240C  D1 74                           ACALL   GET_DIGIT_CHECK
 1347:    240E  50 0D                           JNC     FINISH1
 1348:    2410  54 0F                           ANL     A,#0FH                          ;STRIP OFF BIAS
 1349:    2412  CD                              XCH     A,R5                            ;GET THE LAST DIGIT
 1350:    2413  75 F0 0A                        MOV     B,#10                           ;MULTIPLY BY TEN
 1351:    2416  A4                              MUL     AB
 1352:    2417  2D                              ADD     A,R5                            ;ADD TO ORIGINAL VALUE
 1353:    2418  FD                              MOV     R5,A                            ;SAVE IN R5
 1354:    2419  50 F0                           JNC     GT2                             ;LOOP IF NO CARRY
 1355:    241B  7D FF                           MOV     R5,#0FFH                        ;FORCE AN ERROR
 1356:                                  ;
 1357:    241D  ED              FINISH1:        MOV     A,R5                            ;GET THE SIGN
 1358:    241E  30 50 09                        JNB     XSIGN,POSNUM                    ;SEE IF EXPONENT IS POS OR NEG
 1359:    2421  C3                              CLR     C
 1360:    2422  9E                              SUBB    A,R6
 1361:    2423  F4                              CPL     A
 1362:    2424  04                              INC     A
 1363:    2425  40 09                           JC      FINISH2
 1364:    2427  74 01                           MOV     A,#01H
 1365:    2429  22                              RET
 1366:                                  ;
 1367:    242A  2E              POSNUM:         ADD     A,R6                            ;ADD TO EXPONENT
 1368:    242B  50 03                           JNC     FINISH2
 1369:                                  ;
 1370:    242D  74 02           POSNM1:         MOV     A,#02H
 1371:    242F  22                              RET
 1372:                                  ;
 1373:    2430  CE              FINISH2:        XCH     A,R6                            ;SAVE THE EXPONENT
 1374:                                  ;
 1375:    2431                  FINISH_UP:
 1376:                                  ;
 1377:    2431  8E 30                           MOV     FP_EXP,R6                       ;SAVE EXPONENT
 1378:    2433  B8 34 02                        CJNE    R0,#FP_ACCC,$+5
 1379:    2436  51 BB                           ACALL   FP_CLEAR                        ;CLEAR THE MEMORY IF 0
 1380:    2438  E5 24                           MOV     A,ARG_STACK                     ;GET THE ARG STACK
 1381:    243A  C3                              CLR     C
 1382:    243B  94 0C                           SUBB    A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
 1383:    243D  F5 24                           MOV     ARG_STACK,A                     ;ADJUST FOR STORE
 1384:    243F  41 2C                           AJMP    PACK
 1385:                                  ;
 1386:    2441  C2 D5           STDIG:          CLR     F0                              ;CLEAR INITIAL DESIGNATOR
 1387:    2443  70 0B                           JNZ     STDIG1                          ;CONTINUE IF NOT ZERO
 1388:    2445  B8 34 08                        CJNE    R0,#FP_ACCC,STDIG1
 1389:    2448  30 52 04                        JNB     FIRST_RADIX,RET_X
 1390:                                  ;
 1391:    244B  DE 02           DECX:           DJNZ    R6,RET_X
 1392:                                  ;
 1393:    244D  74 FF           INERR:          MOV     A,#0FFH
 1394:                                  ;
 1395:    244F  22              RET_X:          RET
 1396:                                  ;
 1397:    2450  20 53 02        STDIG1:         JB      DONE_LOAD,FRTEST
 1398:    2453  C2 52                           CLR     FIRST_RADIX
 1399:                                  ;
 1400:    2455  20 52 F3        FRTEST:         JB      FIRST_RADIX,DECX
 1401:                                  ;
 1402:    2458  20 51 01        FDTEST:         JB      FOUND_RADIX,FDT1
 1403:    245B  0E                              INC     R6
 1404:                                  ;
 1405:    245C  20 53 F0        FDT1:           JB      DONE_LOAD,RET_X
 1406:    245F  B8 3D 02                        CJNE    R0,#FP_ACC8+1,FDT2
 1407:    2462  D2 53                           SETB    DONE_LOAD
 1408:                                  ;
 1409:    2464  F6              FDT2:           MOV     @R0,A                           ;SAVE THE STRIPPED ACCUMULATOR
 1410:    2465  08                              INC     R0                              ;BUMP THE POINTER
 1411:    2466  22                              RET                                     ;EXIT
 1412:                                  ;
 1413:                                  ;***************************************************************
 1414:                                  ;
 1415:                                  ; I/O utilities
 1416:                                  ;
 1417:                                  ;***************************************************************
 1418:                                  ;
 1419:    2467                  INC_AND_GET_DPTR_CHARACTER:
 1420:                                  ;
 1421:    2467  A3                              INC     DPTR
 1422:                                  ;
 1423:    2468                  GET_DPTR_CHARACTER:
 1424:                                  ;
 1425:    2468  E0                              MOVX    A,@DPTR                         ;GET THE CHARACTER
 1426:    2469  B4 20 16                        CJNE    A,#' ',PMT1                     ;SEE IF A SPACE
 1427:                                  ;
 1428:                                  ; Kill spaces
 1429:                                  ;
 1430:    246C  80 F9                           SJMP    INC_AND_GET_DPTR_CHARACTER
 1431:                                  ;
 1432:    246E                  PLUS_MINUS_TEST:
 1433:                                  ;
 1434:    246E  B4 E3 02                        CJNE    A,#0E3H,$+5                     ;SEE IF A PLUS, PLUS TOKEN FROM BASIC
 1435:    2471  80 0E                           SJMP    PMT3
 1436:    2473  B4 2B 02                        CJNE    A,#'+',$+5
 1437:    2476  80 09                           SJMP    PMT3
 1438:    2478  B4 E5 02                        CJNE    A,#0E5H,$+5                     ;SEE IF MINUS, MINUS TOKEN FROM BASIC
 1439:    247B  80 03                           SJMP    PMT2
 1440:    247D  B4 2D 02                        CJNE    A,#'-',PMT1
 1441:                                  ;
 1442:    2480  D3              PMT2:           SETB    C
 1443:                                  ;
 1444:    2481  A3              PMT3:           INC     DPTR
 1445:                                  ;
 1446:    2482  22              PMT1:           RET
 1447:                                  ;
 1448:                                  ;***************************************************************
 1449:                                  ;
 1450:    2483                  FLOATING_POINT_OUTPUT:  ; Output the number, format is in location 25
 1451:                                  ;
 1452:                                  ; IF FORMAT = 00 - FREE FLOATING
 1453:                                  ;           = FX - EXPONENTIAL (X IS THE NUMBER OF SIG DIGITS)
 1454:                                  ;           = NX - N = NUM BEFORE RADIX, X = NUM AFTER RADIX
 1455:                                  ;                  N + X = 8 MAX
 1456:                                  ;
 1457:                                  ;***************************************************************
 1458:                                  ;
 1459:    2483  71 73                           ACALL   MDES1                           ;GET THE NUMBER TO OUTPUT, R0 IS POINTER
 1460:    2485  11 C4                           ACALL   POP_AND_EXIT                    ;OUTPUT POPS THE STACK
 1461:    2487  EF                              MOV     A,R7
 1462:    2488  FE                              MOV     R6,A                            ;PUT THE EXPONENT IN R6
 1463:    2489  51 87                           ACALL   UNPACK_R0                       ;UNPACK THE NUMBER
 1464:    248B  78 2B                           MOV     R0,#FP_NIB1                     ;POINT AT THE NUMBER
 1465:    248D  E5 25                           MOV     A,FORMAT                        ;GET THE FORMAT
 1466:    248F  FB                              MOV     R3,A                            ;SAVE IN CASE OF EXP FORMAT
 1467:    2490  60 49                           JZ      FREE                            ;FREE FLOATING?
 1468:    2492  B4 F0 00                        CJNE    A,#0F0H,$+3                     ;SEE IF EXPONENTIAL
 1469:    2495  50 73                           JNC     EXPOUT
 1470:                                  ;
 1471:                                  ; If here, must be integer USING format
 1472:                                  ;
 1473:    2497  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1474:    2498  70 02                           JNZ     $+4
 1475:    249A  7E 80                           MOV     R6,#80H
 1476:    249C  EB                              MOV     A,R3                            ;GET THE FORMAT
 1477:    249D  C4                              SWAP    A                                       ;SPLIT INTEGER AND FRACTION
 1478:    249E  54 0F                           ANL     A,#0FH
 1479:    24A0  FA                              MOV     R2,A                            ;SAVE INTEGER
 1480:    24A1  B1 70                           ACALL   NUM_LT                          ;GET THE NUMBER OF INTEGERS
 1481:    24A3  CA                              XCH     A,R2                            ;FLIP FOR SUBB
 1482:    24A4  C3                              CLR             C
 1483:    24A5  9A                              SUBB    A,R2
 1484:    24A6  FF                              MOV     R7,A
 1485:    24A7  50 06                           JNC     $+8
 1486:    24A9  7D 3F                           MOV     R5,#'?'                         ;OUTPUT A QUESTION MARK
 1487:    24AB  B1 A5                           ACALL   SOUT1                           ;NUMBER IS TOO LARGE FOR FORMAT
 1488:    24AD  81 DB                           AJMP    FREE
 1489:    24AF  BA 00 07                        CJNE    R2,#00,USING0                   ;SEE IF ZERO
 1490:    24B2  1F                              DEC     R7
 1491:    24B3  B1 92                           ACALL   SS7
 1492:    24B5  B1 9F                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1493:    24B7  80 06                           SJMP    USING1
 1494:                                  ;
 1495:    24B9  B1 92           USING0:         ACALL   SS7                             ;OUTPUT SPACES, IF NEED TO
 1496:    24BB  EA                              MOV     A,R2                            ;OUTPUT DIGITS
 1497:    24BC  FF                              MOV     R7,A
 1498:    24BD  B1 54                           ACALL   OUTR0
 1499:                                  ;
 1500:    24BF  EB              USING1:         MOV     A,R3
 1501:    24C0  54 0F                           ANL     A,#0FH                          ;GET THE NUMBER RIGHT OF DP
 1502:    24C2  FA                              MOV     R2,A                            ;SAVE IT
 1503:    24C3  60 BD                           JZ      PMT1                            ;EXIT IF ZERO
 1504:    24C5  B1 9B                           ACALL   ROUT                            ;OUTPUT DP
 1505:    24C7  B1 79                           ACALL   NUM_RT
 1506:    24C9  B5 02 03                        CJNE    A,2,USINGX                      ;COMPARE A TO R2
 1507:                                  ;
 1508:    24CC  EA              USINGY:         MOV     A,R2
 1509:    24CD  A1 89                           AJMP    Z7R7
 1510:                                  ;
 1511:    24CF  50 FB           USINGX:         JNC     USINGY
 1512:                                  ;
 1513:    24D1  CA              USING2:         XCH     A,R2
 1514:    24D2  C3                              CLR     C
 1515:    24D3  9A                              SUBB    A,R2
 1516:    24D4  CA                              XCH     A,R2
 1517:    24D5  B1 89                           ACALL   Z7R7                            ;OUTPUT ZEROS IF NEED TO
 1518:    24D7  EA                              MOV     A,R2
 1519:    24D8  FF                              MOV     R7,A
 1520:    24D9  A1 54                           AJMP    OUTR0
 1521:                                  ;
 1522:                                  ; First, force exponential output, if need to
 1523:                                  ;
 1524:    24DB  EE              FREE:           MOV     A,R6                            ;GET THE EXPONENT
 1525:    24DC  70 04                           JNZ     FREE1                           ;IF ZERO, PRINT IT
 1526:    24DE  B1 A3                           ACALL   SOUT
 1527:    24E0  A1 9F                           AJMP    ZOUT
 1528:                                  ;
 1529:    24E2  7B F0           FREE1:          MOV     R3,#0F0H                        ;IN CASE EXP NEEDED
 1530:    24E4  74 77                           MOV     A,#80H-DIGIT-DIGIT-1
 1531:    24E6  2E                              ADD     A,R6
 1532:    24E7  40 21                           JC      EXPOUT
 1533:    24E9  94 F7                           SUBB    A,#0F7H
 1534:    24EB  40 1D                           JC      EXPOUT
 1535:                                  ;
 1536:                                  ; Now, just print the number
 1537:                                  ;
 1538:    24ED  B1 94                           ACALL   SINOUT                          ;PRINT THE SIGN OF THE NUMBER
 1539:    24EF  B1 70                           ACALL   NUM_LT                          ;GET THE NUMBER LEFT OF DP
 1540:    24F1  B4 08 02                        CJNE    A,#8,FREE4
 1541:    24F4  A1 54                           AJMP    OUTR0
 1542:                                  ;
 1543:    24F6  B1 54           FREE4:          ACALL   OUTR0
 1544:    24F8  B1 66                           ACALL   ZTEST                           ;TEST FOR TRAILING ZEROS
 1545:    24FA  60 57                           JZ      U_RET                           ;DONE IF ALL TRAILING ZEROS
 1546:    24FC  B1 9B                           ACALL   ROUT                            ;OUTPUT RADIX
 1547:                                  ;
 1548:    24FE  7F 01           FREE2:          MOV     R7,#1                           ;OUTPUT ONE DIGIT
 1549:    2500  B1 54                           ACALL   OUTR0
 1550:    2502  70 4F                           JNZ     U_RET
 1551:    2504  B1 66                           ACALL   ZTEST
 1552:    2506  60 4B                           JZ      U_RET
 1553:    2508  80 F4                           SJMP    FREE2                           ;LOOP
 1554:                                  ;
 1555:    250A  B1 94           EXPOUT:         ACALL   SINOUT                          ;PRINT THE SIGN
 1556:    250C  7F 01                           MOV     R7,#1                           ;OUTPUT ONE CHARACTER
 1557:    250E  B1 54                           ACALL   OUTR0
 1558:    2510  B1 9B                           ACALL   ROUT                            ;OUTPUT RADIX
 1559:    2512  EB                              MOV     A,R3                            ;GET FORMAT
 1560:    2513  54 0F                           ANL     A,#0FH                          ;STRIP INDICATOR
 1561:    2515  60 06                           JZ      EXPOTX
 1562:                                  ;
 1563:    2517  FF                              MOV     R7,A                            ;OUTPUT THE NUMBER OF DIGITS
 1564:    2518  1F                              DEC     R7                              ;ADJUST BECAUSE ONE CHAR ALREADY OUT
 1565:    2519  B1 54                           ACALL   OUTR0
 1566:    251B  80 02                           SJMP    EXPOT4
 1567:                                  ;
 1568:    251D  91 FE           EXPOTX:         ACALL   FREE2                           ;OUTPUT UNTIL TRAILING ZEROS
 1569:                                  ;
 1570:    251F  B1 A3           EXPOT4:         ACALL   SOUT                            ;OUTPUT A SPACE
 1571:    2521  7D 45                           MOV     R5,#'E'
 1572:    2523  B1 A5                           ACALL   SOUT1                           ;OUTPUT AN E
 1573:    2525  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1574:    2526  60 04                           JZ      XOUT0                           ;EXIT IF ZERO
 1575:    2528  14                              DEC     A                               ;ADJUST FOR THE DIGIT ALREADY OUTPUT
 1576:    2529  B4 80 05                        CJNE    A,#80H,XOUT2                    ;SEE WHAT IT IS
 1577:                                  ;
 1578:    252C  B1 A3           XOUT0:          ACALL   SOUT
 1579:    252E  E4                              CLR     A
 1580:    252F  80 0C                           SJMP    XOUT4
 1581:                                  ;
 1582:    2531  40 06           XOUT2:          JC      XOUT3                           ;NEGATIVE EXPONENT
 1583:    2533  7D 2B                           MOV     R5,#'+'                         ;OUTPUT A PLUS SIGN
 1584:    2535  B1 A5                           ACALL   SOUT1
 1585:    2537  80 04                           SJMP    XOUT4
 1586:                                  ;
 1587:    2539  B1 97           XOUT3:          ACALL   MOUT
 1588:    253B  F4                              CPL     A                               ;FLIP BITS
 1589:    253C  04                              INC     A                               ;BUMP
 1590:                                  ;
 1591:    253D  C2 E7           XOUT4:          CLR     ACC.7
 1592:    253F  F8                              MOV     R0,A
 1593:    2540  7A 00                           MOV     R2,#0
 1594:    2542  79 48                           MOV     R1,#LOW CONVT                   ;CONVERSION LOCATION
 1595:    2544  7B 00                           MOV     R3,#HIGH CONVT
 1596:    2546  D1 00                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1597:    2548  78 48                           MOV     R0,#LOW CONVT                   ;NOW, OUTPUT EXPONENT
 1598:                                  ;
 1599:    254A  E2              EXPOT5:         MOVX    A,@R0                           ;GET THE CHARACTER
 1600:    254B  FD                              MOV     R5,A                            ;OUTPUT IT
 1601:    254C  B1 A5                           ACALL   SOUT1
 1602:    254E  08                              INC     R0                              ;BUMP THE POINTER
 1603:    254F  E8                              MOV     A,R0                            ;GET THE POINTER
 1604:    2550  B5 01 F7                        CJNE    A,R1B0,EXPOT5                   ;LOOP
 1605:                                  ;
 1606:    2553  22              U_RET:          RET                                     ;EXIT
 1607:                                  ;
 1608:    2554                  OUTR0:  ; Output the characters pointed to by R0, also bias ascii
 1609:                                  ;
 1610:    2554  EF                              MOV     A,R7                            ;GET THE COUNTER
 1611:    2555  60 0E                           JZ      OUTR                            ;EXIT IF DONE
 1612:    2557  E6                              MOV     A,@R0                           ;GET THE NUMBER
 1613:    2558  44 30                           ORL     A,#30H                          ;ASCII BIAS
 1614:    255A  08                              INC     R0                              ;BUMP POINTER AND COUNTER
 1615:    255B  1F                              DEC     R7
 1616:    255C  FD                              MOV     R5,A                            ;PUT CHARACTER IN OUTPUT REGISTER
 1617:    255D  B1 A5                           ACALL   SOUT1                           ;OUTPUT THE CHARACTER
 1618:    255F  E4                              CLR     A                               ;JUST FOR TEST
 1619:    2560  B8 33 F1                        CJNE    R0,#FP_NIB8+1,OUTR0
 1620:    2563  74 55                           MOV     A,#55H                          ;KNOW WHERE EXIT OCCURED
 1621:                                  ;
 1622:    2565  22              OUTR:           RET
 1623:                                  ;
 1624:    2566  A9 00           ZTEST:          MOV     R1,R0B0                         ;GET POINTER REGISTER
 1625:                                  ;
 1626:    2568  E7              ZT0:            MOV     A,@R1                           ;GET THE VALUE
 1627:    2569  70 04                           JNZ     ZT1
 1628:    256B  09                              INC     R1                              ;BUMP POINTER
 1629:    256C  B9 33 F9                        CJNE    R1,#FP_NIB8+1,ZT0
 1630:                                  ;
 1631:    256F  22              ZT1:            RET
 1632:                                  ;
 1633:    2570  EE              NUM_LT:         MOV     A,R6                            ;GET EXPONENT
 1634:    2571  C3                              CLR     C                               ;GET READY FOR SUBB
 1635:    2572  94 80                           SUBB    A,#80H                          ;SUB EXPONENT BIAS
 1636:    2574  50 01                           JNC     NL1                             ;OK IF NO CARRY
 1637:    2576  E4                              CLR     A                               ;NO DIGITS LEFT
 1638:                                  ;
 1639:    2577  FF              NL1:            MOV     R7,A                            ;SAVE THE COUNT
 1640:    2578  22                              RET
 1641:                                  ;
 1642:    2579  C3              NUM_RT:         CLR     C                               ;SUBB AGAIN
 1643:    257A  74 80                           MOV     A,#80H                          ;EXPONENT BIAS
 1644:    257C  9E                              SUBB    A,R6                            ;GET THE BIASED EXPONENT
 1645:    257D  50 01                           JNC     NR1
 1646:    257F  E4                              CLR     A
 1647:                                  ;
 1648:    2580  22              NR1:            RET                                     ;EXIT
 1649:                                  ;
 1650:    2581  EF              SPACE7:         MOV     A,R7                            ;GET THE NUMBER OF SPACES
 1651:    2582  60 FC                           JZ      NR1                             ;EXIT IF ZERO
 1652:    2584  B1 A3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1653:    2586  1F                              DEC     R7                              ;BUMP COUNTER
 1654:    2587  80 F8                           SJMP    SPACE7                          ;LOOP
 1655:                                  ;
 1656:    2589  FF              Z7R7:           MOV     R7,A
 1657:                                  ;
 1658:    258A  EF              ZERO7:          MOV     A,R7                            ;GET COUNTER
 1659:    258B  60 F3                           JZ      NR1                             ;EXIT IF ZERO
 1660:    258D  B1 9F                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1661:    258F  1F                              DEC     R7                              ;BUMP COUNTER
 1662:    2590  80 F8                           SJMP    ZERO7                           ;LOOP
 1663:                                  ;
 1664:    2592  B1 81           SS7:            ACALL   SPACE7
 1665:                                  ;
 1666:    2594  EC              SINOUT:         MOV     A,R4                            ;GET THE SIGN
 1667:    2595  60 0C                           JZ      SOUT                            ;OUTPUT A SPACE IF ZERO
 1668:                                  ;
 1669:    2597  7D 2D           MOUT:           MOV     R5,#'-'
 1670:    2599  80 0A                           SJMP    SOUT1                           ;OUTPUT A MINUS IF NOT
 1671:                                  ;
 1672:    259B  7D 2E           ROUT:           MOV     R5,#'.'                         ;OUTPUT A RADIX
 1673:    259D  80 06                           SJMP    SOUT1
 1674:                                  ;
 1675:    259F  7D 30           ZOUT:           MOV     R5,#'0'                         ;OUTPUT A ZERO
 1676:    25A1  80 02                           SJMP    SOUT1
 1677:                                  ;
 1678:    25A3  7D 20           SOUT:           MOV     R5,#' '                         ;OUTPUT A SPACE
 1679:                                  ;
 1680:    25A5  C1 81           SOUT1:          AJMP    R5OUT
 1681:                                  ;
 1682:                                  ;***************************************************************
 1683:                                  ;
 1684:    25A7                  CONVERT_ASCII_STRING_TO_BINARY:
 1685:                                  ;
 1686:                                  ;DPTR POINTS TO ASCII STRING
 1687:                                  ;PUT THE BINARY NUMBER IN R2:R0, ERROR IF >64K
 1688:                                  ;
 1689:                                  ;***************************************************************
 1690:                                  ;
 1691:    25A7  71 92           CASB:           ACALL   HEXSCAN                         ;SEE IF HEX NUMBER
 1692:    25A9  92 33                           MOV     ADD_IN,C                        ;IF ADD_IN IS SET, THE NUMBER IS HEX
 1693:    25AB  D1 74                           ACALL   GET_DIGIT_CHECK
 1694:    25AD  B3                              CPL     C                               ;FLIP FOR EXIT
 1695:    25AE  40 28                           JC      RCASB
 1696:    25B0  7B 00                           MOV     R3,#00H                         ;ZERO R3:R1 FOR LOOP
 1697:    25B2  79 00                           MOV     R1,#00H
 1698:    25B4  80 15                           SJMP    CASB5
 1699:                                  ;
 1700:    25B6  A3              CASB2:          INC     DPTR
 1701:    25B7  89 00                           MOV     R0B0,R1                         ;SAVE THE PRESENT CONVERTED VALUE
 1702:    25B9  8B 02                           MOV     R0B0+2,R3                       ;IN R2:R0
 1703:    25BB  D1 74                           ACALL   GET_DIGIT_CHECK
 1704:    25BD  40 0C                           JC      CASB5
 1705:    25BF  30 33 16                        JNB     ADD_IN,RCASB                    ;CONVERSION COMPLETE
 1706:    25C2  71 B2                           ACALL   HEX_CHECK                       ;SEE IF HEX NUMBER
 1707:    25C4  40 03                           JC      CASB4                           ;PROCEED IF GOOD
 1708:    25C6  A3                              INC     DPTR                            ;BUMP PAST H
 1709:    25C7  80 0F                           SJMP    RCASB
 1710:                                  ;
 1711:    25C9  24 09           CASB4:          ADD     A,#9                            ;ADJUST HEX ASCII BIAS
 1712:                                  ;
 1713:    25CB  75 F0 0A        CASB5:          MOV     B,#10
 1714:    25CE  30 33 03                        JNB     ADD_IN,CASB6
 1715:    25D1  75 F0 10                        MOV     B,#16                           ;HEX MODE
 1716:                                  ;
 1717:    25D4  B1 DF           CASB6:          ACALL   MULNUM                          ;ACCUMULATE THE DIGITS
 1718:    25D6  50 DE                           JNC     CASB2                           ;LOOP IF NO CARRY
 1719:                                  ;
 1720:    25D8  E4              RCASB:          CLR     A                               ;RESET ACC
 1721:    25D9  92 E1                           MOV     ACC.OVERFLOW,C                  ;IF OVERFLOW, SAY SO
 1722:    25DB  22                              RET                                     ;EXIT
 1723:                                  ;
 1724:                                  ;
 1725:    25DC  75 F0 0A        MULNUM10:       MOV     B,#10
 1726:                                  ;
 1727:                                  ;***************************************************************
 1728:                                  ;
 1729:    25DF                  MULNUM: ; Take the next digit in the acc (masked to 0FH)
 1730:                                  ; accumulate in R3:R1
 1731:                                  ;
 1732:                                  ;***************************************************************
 1733:                                  ;
 1734:    25DF  C0 E0                           PUSH    ACC                             ;SAVE ACC
 1735:    25E1  C0 F0                           PUSH    B                               ;SAVE MULTIPLIER
 1736:    25E3  E9                              MOV     A,R1                            ;PUT LOW ORDER BITS IN ACC
 1737:    25E4  A4                              MUL     AB                              ;DO THE MULTIPLY
 1738:    25E5  F9                              MOV     R1,A                            ;PUT THE RESULT BACK
 1739:    25E6  EB                              MOV     A,R3                            ;GET THE HIGH ORDER BYTE
 1740:    25E7  AB F0                           MOV     R3,B                            ;SAVE THE OVERFLOW
 1741:    25E9  D0 F0                           POP     B                               ;GET THE MULTIPLIER
 1742:    25EB  A4                              MUL     AB                              ;DO IT
 1743:    25EC  A2 D2                           MOV     C,OV                            ;SAVE OVERFLOW IN F0
 1744:    25EE  92 D5                           MOV     F0,C
 1745:    25F0  2B                              ADD     A,R3                            ;ADD OVERFLOW TO HIGH RESULT
 1746:    25F1  FB                              MOV     R3,A                            ;PUT IT BACK
 1747:    25F2  D0 E0                           POP     ACC                             ;GET THE ORIGINAL ACC BACK
 1748:    25F4  72 D5                           ORL     C,F0                            ;OR CARRY AND OVERFLOW
 1749:    25F6  40 07                           JC      MULX                            ;NO GOOD IF THE CARRY IS SET
 1750:                                  ;
 1751:    25F8  54 0F           MUL11:          ANL     A,#0FH                          ;MASK OFF HIGH ORDER BITS
 1752:    25FA  29                              ADD     A,R1                            ;NOW ADD THE ACC
 1753:    25FB  F9                              MOV     R1,A                            ;PUT IT BACK
 1754:    25FC  E4                              CLR     A                               ;PROPAGATE THE CARRY
 1755:    25FD  3B                              ADDC    A,R3
 1756:    25FE  FB                              MOV     R3,A                            ;PUT IT BACK
 1757:                                  ;
 1758:    25FF  22              MULX:           RET                                     ;EXIT WITH OR WITHOUT CARRY
 1759:                                  ;
 1760:                                  ;***************************************************************
 1761:                                  ;
 1762:    2600                  CONVERT_BINARY_TO_ASCII_STRING:
 1763:                                  ;
 1764:                                  ;R3:R1 contains the address of the string
 1765:                                  ;R2:R0 contains the value to convert
 1766:                                  ;DPTR, R7, R6, and ACC gets clobbered
 1767:                                  ;
 1768:                                  ;***************************************************************
 1769:                                  ;
 1770:    2600  E4                              CLR     A                               ;NO LEADING ZEROS
 1771:    2601  90 27 10                        MOV     DPTR,#10000                     ;SUBTRACT 10000
 1772:    2604  D1 1D                           ACALL   RSUB                            ;DO THE SUBTRACTION
 1773:    2606  90 03 E8                        MOV     DPTR,#1000                      ;NOW 1000
 1774:    2609  D1 1D                           ACALL   RSUB
 1775:    260B  90 00 64                        MOV     DPTR,#100                       ;NOW 100
 1776:    260E  D1 1D                           ACALL   RSUB
 1777:    2610  90 00 0A                        MOV     DPTR,#10                        ;NOW 10
 1778:    2613  D1 1D                           ACALL   RSUB
 1779:    2615  90 00 01                        MOV     DPTR,#1                         ;NOW 1
 1780:    2618  D1 1D                           ACALL   RSUB
 1781:    261A  60 20                           JZ      RSUB2                           ;JUMP OVER RET
 1782:                                  ;
 1783:    261C  22              RSUB_R:         RET
 1784:                                  ;
 1785:    261D  7E FF           RSUB:           MOV     R6,#-1                          ;SET UP THE COUNTER
 1786:                                  ;
 1787:    261F  0E              RSUB1:          INC     R6                              ;BUMP THE COUNTER
 1788:    2620  CA                              XCH     A,R2                            ;DO A FAST COMPARE
 1789:    2621  B5 83 00                        CJNE    A,DPH,$+3
 1790:    2624  CA                              XCH     A,R2
 1791:    2625  40 12                           JC      FAST_DONE
 1792:    2627  C8                              XCH     A,R0                            ;GET LOW BYTE
 1793:    2628  95 82                           SUBB    A,DPL                           ;SUBTRACT, CARRY IS CLEARED
 1794:    262A  C8                              XCH     A,R0                            ;PUT IT BACK
 1795:    262B  CA                              XCH     A,R2                            ;GET THE HIGH BYTE
 1796:    262C  95 83                           SUBB    A,DPH                           ;ADD THE HIGH BYTE
 1797:    262E  CA                              XCH     A,R2                            ;PUT IT BACK
 1798:    262F  50 EE                           JNC     RSUB1                           ;LOOP UNTIL CARRY
 1799:                                  ;
 1800:    2631  C8                              XCH     A,R0
 1801:    2632  25 82                           ADD     A,DPL                           ;RESTORE R2:R0
 1802:    2634  C8                              XCH     A,R0
 1803:    2635  CA                              XCH     A,R2
 1804:    2636  35 83                           ADDC    A,DPH
 1805:    2638  CA                              XCH     A,R2
 1806:                                  ;
 1807:    2639                  FAST_DONE:
 1808:                                  ;
 1809:    2639  4E                              ORL     A,R6                            ;OR THE COUNT VALUE
 1810:    263A  60 E0                           JZ      RSUB_R                          ;RETURN IF ZERO
 1811:                                  ;
 1812:    263C  74 30           RSUB2:          MOV     A,#'0'                          ;GET THE ASCII BIAS
 1813:    263E  2E                              ADD     A,R6                            ;ADD THE COUNT
 1814:                                  ;
 1815:    263F  8B A0           RSUB4:          MOV     P2,R3                           ;SET UP P2
 1816:    2641  F3                              MOVX    @R1,A                           ;PLACE THE VALUE IN MEMORY
 1817:    2642  09                              INC     R1
 1818:    2643  B9 00 01                        CJNE    R1,#00H,RSUB3                   ;SEE IF RAPPED AROUND
 1819:    2646  0B                              INC     R3                              ;BUMP HIGH BYTE
 1820:                                  ;
 1821:    2647  22              RSUB3:          RET                                     ;EXIT
 1822:                                  ;
 1823:                                  ;***************************************************************
 1824:                                  ;
 1825:    2648                  FPHEXOUT:       ; Output the hex number in R3:R1, supress leading zeros, if set
 1826:                                  ;
 1827:                                  ;***************************************************************
 1828:                                  ;
 1829:    2648  B1 A3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1830:    264A  A2 36                           MOV     C,ZSURP                         ;GET ZERO SUPPRESSION BIT
 1831:    264C  92 33                           MOV     ADD_IN,C
 1832:    264E  EB                              MOV     A,R3                            ;GET HIGH NIBBLE AND PRINT IT
 1833:    264F  D1 6B                           ACALL   HOUTHI
 1834:    2651  EB                              MOV     A,R3
 1835:    2652  D1 6C                           ACALL   HOUTLO
 1836:                                  ;
 1837:    2654  C2 33           HEX2X:          CLR     ADD_IN                          ;DON'T SUPPRESS ZEROS
 1838:    2656  E9                              MOV     A,R1                            ;GET LOW NIBBLE AND PRINT IT
 1839:    2657  D1 6B                           ACALL   HOUTHI
 1840:    2659  E9                              MOV     A,R1
 1841:    265A  D1 6C                           ACALL   HOUTLO
 1842:    265C  7D 48                           MOV     R5,#'H'                         ;OUTPUT H TO INDICATE HEX MODE
 1843:                                  ;
 1844:    265E  A1 A5           SOUT_1:         AJMP    SOUT1
 1845:                                  ;
 1846:    2660  C2 33           HOUT1:          CLR     ADD_IN                          ;PRINTED SOMETHING, SO CLEAR ADD_IN
 1847:    2662  24 90                           ADD     A,#90H                          ;CONVERT TO ASCII
 1848:    2664  D4                              DA      A
 1849:    2665  34 40                           ADDC    A,#40H
 1850:    2667  D4                              DA      A                               ;GOT IT HERE
 1851:    2668  FD                              MOV     R5,A                            ;OUTPUT THE BYTE
 1852:    2669  80 F3                           SJMP    SOUT_1
 1853:                                  ;
 1854:    266B  C4              HOUTHI:         SWAP    A                               ;SWAP TO OUTPUT HIGH NIBBLE
 1855:                                  ;
 1856:    266C  54 0F           HOUTLO:         ANL     A,#0FH                          ;STRIP
 1857:    266E  70 F0                           JNZ     HOUT1                           ;PRINT IF NOT ZERO
 1858:    2670  30 33 ED                        JNB     ADD_IN,HOUT1                    ;OUTPUT A ZERO IF NOT SUPRESSED
 1859:    2673  22                              RET
 1860:                                  ;
 1861:                                  ;
 1862:    2674                  GET_DIGIT_CHECK:        ; Get a character, then check for digit
 1863:                                  ;
 1864:    2674  91 68                           ACALL   GET_DPTR_CHARACTER
 1865:                                  ;
 1866:    2676                  DIGIT_CHECK:    ;CHECK FOR A VALID ASCII DIGIT, SET CARRY IF FOUND
 1867:                                  ;
 1868:    2676  B4 3A 00                        CJNE    A,#'9'+1,$+3                    ;SEE IF ASCII 9 OR LESS
 1869:    2679  40 01                           JC      DC1
 1870:    267B  22                              RET
 1871:                                  ;
 1872:    267C  B4 30 00        DC1:            CJNE    A,#'0',$+3                      ;SEE IF ASCII 0 OR GREATER
 1873:    267F  B3                              CPL     C
 1874:    2680  22                              RET
 1875:                                  ;
 1876:
 1877:    2681  C0 E0           R5OUT:          PUSH    ACC                             ; ME
 1878:    2683  C0 00                           PUSH    00H
 1879:    2685  A8 50                           MOV     R0,FPCHR_OUT
 1880:    2687  ED                              MOV     A,R5                            ; ME
 1881:    2688  F6                              MOV     @R0,A
 1882:    2689  05 50                           INC     FPCHR_OUT
 1883:    268B  D0 00                           POP     00H
 1884:    268D  D0 E0                           POP     ACC                             ; ME
 1885:    268F  22                              RET                                     ; ME
 1886:
 1887:    2690  01 A7           SQ_ERR:         JMP     BADPRM                          ; me
 1888:
 1889:                                  ;***************************************************************
 1890:                                  ;
 1891:    2692                  IFIX:   ; Convert a floating point number to an integer, put in R3:R1
 1892:                                  ;
 1893:                                  ;***************************************************************
 1894:                                  ;
 1895:    2692  E4                              CLR     A                               ;RESET THE START
 1896:    2693  FB                              MOV     R3,A
 1897:    2694  F9                              MOV     R1,A
 1898:    2695  A8 24                           MOV     R0,ARG_STACK                    ;GET THE ARG STACK
 1899:    2697  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1900:    269A  E2                              MOVX    A,@R0                           ;READ EXPONENT
 1901:    269B  C3                              CLR     C
 1902:    269C  94 81                           SUBB    A,#81H                          ;BASE EXPONENT
 1903:    269E  FC                              MOV     R4,A                            ;SAVE IT
 1904:    269F  18                              DEC     R0                              ;POINT AT SIGN
 1905:    26A0  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1906:    26A1  70 ED                           JNZ     SQ_ERR                          ;ERROR IF NEGATIVE
 1907:    26A3  40 17                           JC      INC_ASTKA                       ;EXIT IF EXPONENT IS < 81H
 1908:    26A5  0C                              INC     R4                              ;ADJUST LOOP COUNTER
 1909:    26A6  E8                              MOV     A,R0                            ;BUMP THE POINTER REGISTER
 1910:    26A7  94 05                           SUBB    A,#FP_NUMBER_SIZE-1
 1911:    26A9  F8                              MOV     R0,A
 1912:                                  ;
 1913:    26AA  08              I2:             INC     R0                              ;POINT AT DIGIT
 1914:    26AB  E2                              MOVX    A,@R0                           ;GET DIGIT
 1915:    26AC  C4                              SWAP    A                               ;FLIP
 1916:    26AD  11 94                           CALL    FP_BASE+20                      ;ACCUMULATE
 1917:    26AF  40 DF                           JC      SQ_ERR
 1918:    26B1  DC 02                           DJNZ    R4,$+4
 1919:    26B3  80 07                           SJMP    INC_ASTKA
 1920:    26B5  E2                              MOVX    A,@R0                           ;GET DIGIT
 1921:    26B6  11 94                           CALL    FP_BASE+20
 1922:    26B8  40 D6                           JC      SQ_ERR
 1923:    26BA  DC EE                           DJNZ    R4,I2
 1924:                          ;
 1925:                          ; Pop the ARG STACK and check for overflow
 1926:    26BC                  INC_ASTKA:
 1927:    26BC  74 06                           MOV     A,#FP_NUMBER_SIZE               ;number to pop
 1928:    26BE  80 18                           SJMP    SETREG+1
 1929:                          ;
 1930:                          ;Push ARG STACK and check for underflow
 1931:    26C0                  DEC_ASTKA:
 1932:    26C0  74 FA                           MOV     A,#-FP_NUMBER_SIZE
 1933:    26C2  25 24                           ADD     A,ARG_STACK
 1934:    26C4  B4 00 00                        CJNE    A,#0,$+3
 1935:    26C7  40 45                           JC      E4YY
 1936:    26C9  F5 24                           MOV     ARG_STACK,A
 1937:    26CB  F9                              MOV     R1,A
 1938:    26CC  7B 01                           MOV     R3,#ARG_STACK_PAGE
 1939:    26CE  22              SRT:            RET
 1940:                          ;
 1941:    26CF  D1 BC           POPAS:          ACALL   INC_ASTKA
 1942:    26D1  E1 01                           AJMP    VARCOP                          ;COPY THE VARIABLE
 1943:                          ;
 1944:    26D3  D1 C0           PUSHAS:         ACALL   DEC_ASTKA
 1945:    26D5  E1 01                           AJMP    VARCOP
 1946:                          ;
 1947:    26D7  E4              SETREG:         CLR     A                               ;DON'T POP ANYTHING
 1948:    26D8  A8 24                           MOV     R0,ARG_STACK
 1949:    26DA  7A 01                           MOV     R2,#ARG_STACK_PAGE
 1950:    26DC  8A A0                           MOV     P2,R2
 1951:    26DE  28                              ADD     A,R0
 1952:    26DF  40 2D                           JC      E4YY
 1953:    26E1  F5 24                           MOV     ARG_STACK,A
 1954:    26E3  E2                              MOVX    A,@R0
 1955:    26E4  22              A_D:            RET
 1956:                                  ;
 1957:    26E5  18              DEC3210:        DEC     R0                              ;BUMP THE POINTER
 1958:    26E6  B8 FF 01                        CJNE    R0,#0FFH,$+4                    ;SEE IF OVERFLOWED
 1959:    26E9  1A                              DEC     R2                              ;BUMP THE HIGH BYTE
 1960:    26EA  19                              DEC     R1                              ;BUMP THE POINTER
 1961:    26EB  B9 FF 01                        CJNE    R1,#0FFH,DEC_R                  ;SEE IF OVERFLOWED
 1962:    26EE  1B                              DEC     R3                              ;CHANGE THE HIGH BYTE
 1963:    26EF  22              DEC_R:          RET                                     ;EXIT
 1964:                          ;
 1965:
 1966:
 1967:                          ;Routine to copy bottom arg on stack to address in DPTR.
 1968:                          ;Does not work over page boundaries.
 1969:                          ;Bugs fixed by JKJ/IRC
 1970:    26F0  D1 D7           MOVAS:          ACALL   SETREG                          ;SET UP R2:R0
 1971:    26F2  AB 83                           MOV     R3,DPH
 1972:    26F4  A9 82                           MOV     R1,DPL
 1973:    26F6  8A A0           M_C:            MOV     P2,R2                           ;SET UP THE PORTS
 1974:    26F8  E2                              MOVX    A,@R0                           ;READ THE VALUE
 1975:    26F9  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 1976:    26FB  F3                              MOVX    @R1,A                           ;SAVE IT
 1977:    26FC  08                              INC     R0
 1978:    26FD  09                              INC     R1
 1979:    26FE  DC F6                           DJNZ    R4,M_C                          ;LOOP
 1980:    2700  22                              RET                                     ;EXIT
 1981:
 1982:
 1983:                          ; VARCOP - Copy a variable from R2:R0 to R3:R1
 1984:    2701  7C 06           VARCOP:         MOV     R4,#FP_NUMBER_SIZE              ;LOAD THE LOOP COUNTER
 1985:    2703  8A A0           V_C:            MOV     P2,R2                           ;SET UP THE PORTS
 1986:    2705  E2                              MOVX    A,@R0                           ;READ THE VALUE
 1987:    2706  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 1988:    2708  F3                              MOVX    @R1,A                           ;SAVE IT
 1989:    2709  D1 E5                           ACALL   DEC3210
 1990:    270B  DC F6                           DJNZ    R4,V_C                          ;LOOP
 1991:    270D  22                              RET                                     ;EXIT
 1992:                          ;
 1993:    270E  90 27 49        E4YY:           MOV     DPTR,#EXA
 1994:    2711  01 A6                           JMP     PRTERR                          ; me
 1995:
 1996:                                  ; integer operator - INT
 1997:    2713  D1 D7           AINT:           ACALL   SETREG                          ;SET UP THE REGISTERS, CLEAR CARRY
 1998:    2715  94 81                           SUBB    A,#129                          ;SUBTRACT EXPONENT BIAS
 1999:    2717  50 0D                           JNC     AI1                             ;JUMP IF ACC > 81H
 2000:                                  ;
 2001:                                  ; Force the number to be a zero
 2002:                                  ;
 2003:    2719  D1 BC                           ACALL   INC_ASTKA                       ;BUMP THE STACK
 2004:                                  ;
 2005:    271B  90 27 20        P_Z:            MOV     DPTR,#ZRO                       ;PUT ZERO ON THE STACK
 2006:    271E  E1 3B                           AJMP    PUSHC
 2007:    2720  00 00 00 00     ZRO:            DB      0,0,0,0,0,0
          2724  00 00
 2008:                                  ;
 2009:    2726  94 07           AI1:            SUBB    A,#7
 2010:    2728  50 10                           JNC     AI3
 2011:    272A  F4                              CPL     A
 2012:    272B  04                              INC     A
 2013:    272C  FB                              MOV     R3,A
 2014:    272D  18                              DEC     R0                              ;POINT AT SIGN
 2015:                                  ;
 2016:    272E  18              AI2:            DEC     R0                              ;NOW AT LSB'S
 2017:    272F  E2                              MOVX    A,@R0                           ;READ BYTE
 2018:    2730  54 F0                           ANL     A,#0F0H                         ;STRIP NIBBLE
 2019:    2732  F2                              MOVX    @R0,A                           ;WRITE BYTE
 2020:    2733  DB 01                           DJNZ    R3,$+3
 2021:    2735  22                              RET
 2022:    2736  E4                              CLR     A
 2023:    2737  F2                              MOVX    @R0,A                           ;CLEAR THE LOCATION
 2024:    2738  DB F4                           DJNZ    R3,AI2
 2025:    273A  22              AI3:            RET                                     ;EXIT
 2026:                                  ;
 2027:                                  ; PUSHC - Push constant pointed by DPTR on to the arg stack
 2028:    273B  D1 C0           PUSHC:          ACALL   DEC_ASTKA
 2029:    273D  8B A0                           MOV     P2,R3
 2030:    273F  7B 06                           MOV     R3,#FP_NUMBER_SIZE              ;LOOP COUNTER
 2031:    2741  E4              PCL:            CLR     A                               ;SET UP A
 2032:    2742  93                              MOVC    A,@A+DPTR                       ;LOAD IT
 2033:    2743  F3                              MOVX    @R1,A                           ;SAVE IT
 2034:    2744  A3                              INC     DPTR                            ;BUMP POINTERS
 2035:    2745  19                              DEC     R1
 2036:    2746  DB F9                           DJNZ    R3,PCL                          ;LOOP
 2037:    2748  22                              RET                                     ;EXIT
 2038:                          ;
 2039:    2749  41 2D 53 54     EXA:            DB      'A-STACK',0
          274D  41 43 4B 00
 2040:
 2041:                          ;------------------------------------------------------------------
 2042:
 2043:                          ;Binary to decimal converter
 2044:                          ;Converts R7:R6:R5:R4 to decimal pointed to by R0
 2045:                          ;Returns with number of digits in A
 2046:                          ;------------------------------------------------------------------
 2047:    2751  C0 00           BIN2DEC:        PUSH    00h
 2048:    2753  90 28 61                        MOV     DPTR,#BINDEC
 2049:    2756  7A 0A                           MOV     R2,#0Ah
 2050:    2758  7B 2F           BIN2DEC1:       MOV     R3,#2Fh
 2051:    275A  0B              BIN2DEC2:       INC     R3
 2052:    275B  F1 7A                           ACALL   SUBIT
 2053:    275D  50 FB                           JNC     BIN2DEC2
 2054:    275F  F1 93                           ACALL   ADDIT
 2055:    2761  EB                              MOV     A,R3
 2056:    2762  F6                              MOV     @R0,A
 2057:    2763  08                              INC     R0
 2058:    2764  A3                              INC     DPTR
 2059:    2765  A3                              INC     DPTR
 2060:    2766  A3                              INC     DPTR
 2061:    2767  A3                              INC     DPTR
 2062:    2768  DA EE                           DJNZ    R2,BIN2DEC1
 2063:    276A  D0 00                           POP     00h
 2064:                                          ;Remove leading zeroes
 2065:    276C  7A 09                           MOV     R2,#09h
 2066:    276E  E6              BIN2DEC3:       MOV     A,@R0
 2067:    276F  B4 30 05                        CJNE    A,#30h,BIN2DEC4
 2068:    2772  76 20                           MOV     @R0,#20h
 2069:    2774  08                              INC     R0
 2070:    2775  DA F7                           DJNZ    R2,BIN2DEC3
 2071:    2777  0A              BIN2DEC4:       INC     R2
 2072:    2778  EA                              MOV     A,R2
 2073:    2779  22                              RET
 2074:
 2075:    277A  E4              SUBIT:          CLR     A
 2076:    277B  93                              MOVC    A,@A+DPTR
 2077:    277C  CC                              XCH     A,R4
 2078:    277D  C3                              CLR     C
 2079:    277E  9C                              SUBB    A,R4
 2080:    277F  FC                              MOV     R4,A
 2081:    2780  74 01                           MOV     A,#01h
 2082:    2782  93                              MOVC    A,@A+DPTR
 2083:    2783  CD                              XCH     A,R5
 2084:    2784  9D                              SUBB    A,R5
 2085:    2785  FD                              MOV     R5,A
 2086:    2786  74 02                           MOV     A,#02h
 2087:    2788  93                              MOVC    A,@A+DPTR
 2088:    2789  CE                              XCH     A,R6
 2089:    278A  9E                              SUBB    A,R6
 2090:    278B  FE                              MOV     R6,A
 2091:    278C  74 03                           MOV     A,#03h
 2092:    278E  93                              MOVC    A,@A+DPTR
 2093:    278F  CF                              XCH     A,R7
 2094:    2790  9F                              SUBB    A,R7
 2095:    2791  FF                              MOV     R7,A
 2096:    2792  22                              RET
 2097:
 2098:    2793  E4              ADDIT:          CLR     A
 2099:    2794  93                              MOVC    A,@A+DPTR
 2100:    2795  2C                              ADD     A,R4
 2101:    2796  FC                              MOV     R4,A
 2102:    2797  74 01                           MOV     A,#01h
 2103:    2799  93                              MOVC    A,@A+DPTR
 2104:    279A  3D                              ADDC    A,R5
 2105:    279B  FD                              MOV     R5,A
 2106:    279C  74 02                           MOV     A,#02h
 2107:    279E  93                              MOVC    A,@A+DPTR
 2108:    279F  3E                              ADDC    A,R6
 2109:    27A0  FE                              MOV     R6,A
 2110:    27A1  74 03                           MOV     A,#03h
 2111:    27A3  93                              MOVC    A,@A+DPTR
 2112:    27A4  3F                              ADDC    A,R7
 2113:    27A5  FF                              MOV     R7,A
 2114:    27A6  22                              RET
 2115:
 2116:                          ;Calculate ((Fa/Fb)^2)-1
 2117:                          ;IN:    Fa=R2:R0, Fb=R3:R1
 2118:                          ;OUT:   Nothing
 2119:    27A7  C0 01           LCCALC:         PUSH    01h
 2120:    27A9  C0 03                           PUSH    03h
 2121:    27AB  12 26 D3                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2122:    27AE  D0 02                           POP     02h
 2123:    27B0  D0 00                           POP     00h
 2124:    27B2  12 26 D3                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2125:    27B5  12 21 CB                        LCALL   FLOATING_DIV
 2126:    27B8  A8 24                           MOV     R0,ARG_STACK
 2127:    27BA  7A 01                           MOV     R2,#ARG_STACK_PAGE
 2128:    27BC  12 26 D3                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2129:    27BF  12 21 96                        LCALL   FLOATING_MUL
 2130:    27C2  90 28 A1                        MOV     DPTR,#FPONE
 2131:    27C5  12 27 3B                        LCALL   PUSHC                           ; PUSH ARG IN DPTR TO STACK
 2132:    27C8  12 20 A8                        LCALL   FLOATING_SUB
 2133:    27CB  22                              RET
 2134:
 2135:                          ;Get LC meter frquency F1 and F2. Calculatr LCCA and LCCB
 2136:                          ;IN:    Nothing
 2137:                          ;OUT:   Nothing
 2138:    27CC  E4              LCMETERINIT:    CLR     A                               ;D6 LC Meter    0=C, 1=L
 2139:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2140:    27CD  79 60                           MOV     R1,#LOW LCF1
 2141:    27CF  7B 00                           MOV     R3,#HIGH LCF1
 2142:    27D1  12 28 2C                        LCALL   LCMETERGETFRQ                   ;Get F1
 2143:    27D4  E5 80                           MOV     A,80h                           ;D6 LC Meter    0=C, 1=L
 2144:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2145:    27D6  79 68                           MOV     R1,#LOW LCF2
 2146:    27D8  7B 00                           MOV     R3,#HIGH LCF2
 2147:    27DA  12 28 2C                        LCALL   LCMETERGETFRQ                   ;Get F2
 2148:                                          ;Calculate LCCA=((F1/F2)^2)-1
 2149:    27DD  78 60                           MOV     R0,#LOW LCF1
 2150:    27DF  7A 00                           MOV     R2,#HIGH LCF1
 2151:    27E1  79 68                           MOV     R1,#LOW LCF2
 2152:    27E3  7B 00                           MOV     R3,#HIGH LCF2
 2153:    27E5  F1 A7                           ACALL   LCCALC
 2154:    27E7  79 78                           MOV     R1,#LOW LCCA
 2155:    27E9  7B 00                           MOV     R3,#HIGH LCCA
 2156:    27EB  12 26 CF                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2157:                                          ;Calculate LCCB=((1/2*Pi*F1)^2)*LCCA
 2158:    27EE  90 28 A7                        MOV     DPTR,#FPTWO
 2159:    27F1  12 27 3B                        LCALL   PUSHC                           ; PUSH ARG IN DPTR TO STACK
 2160:    27F4  90 28 AD                        MOV     DPTR,#FPPI
 2161:    27F7  12 27 3B                        LCALL   PUSHC                           ; PUSH ARG IN DPTR TO STACK
 2162:    27FA  12 21 96                        LCALL   FLOATING_MUL
 2163:    27FD  78 60                           MOV     R0,#LOW LCF1
 2164:    27FF  7A 00                           MOV     R2,#HIGH LCF1
 2165:    2801  12 26 D3                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2166:    2804  12 21 96                        LCALL   FLOATING_MUL
 2167:    2807  90 28 A1                        MOV     DPTR,#FPONE
 2168:    280A  12 27 3B                        LCALL   PUSHC                           ; PUSH ARG IN DPTR TO STACK
 2169:    280D  12 21 CB                        LCALL   FLOATING_DIV
 2170:    2810  A8 24                           MOV     R0,ARG_STACK
 2171:    2812  7A 01                           MOV     R2,#ARG_STACK_PAGE
 2172:    2814  12 26 D3                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2173:    2817  12 21 96                        LCALL   FLOATING_MUL
 2174:    281A  78 78                           MOV     R0,#LOW LCCA
 2175:    281C  7A 00                           MOV     R2,#HIGH LCCA
 2176:    281E  12 26 D3                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2177:    2821  12 21 96                        LCALL   FLOATING_MUL
 2178:    2824  79 80                           MOV     R1,#LOW LCCB
 2179:    2826  7B 00                           MOV     R3,#HIGH LCCB
 2180:    2828  12 26 CF                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2181:    282B  22                              RET
 2182:
 2183:                          ;Get LC meter frquency
 2184:                          ;IN:    A Port #8000h value, R3:R1 points to FP buffer
 2185:                          ;OUT:   Nothing
 2186:    282C  C0 03           LCMETERGETFRQ:  PUSH    03h                             ;Save R3
 2187:    282E  C0 01                           PUSH    01h                             ;Save R1
 2188:    2830  90 80 00                        MOV     DPTR,#8000h
 2189:    2833  F0                              MOVX    @DPTR,A                         ;D7, D6
 2190:    2834  74 FA                           MOV     A,#250
 2191:    2836  12 3C 4F                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2192:    2839  74 02                           MOV     A,#02h                          ;CH2, LC Meter
 2193:    283B  12 3D A0                        LCALL   FRQCOUNT
 2194:    283E  78 40                           MOV     R0,#LCDLINE
 2195:    2840  12 27 51                        LCALL   BIN2DEC
 2196:    2843  78 40                           MOV     R0,#LCDLINE
 2197:    2845  90 00 48                        MOV     DPTR,#CONVT
 2198:    2848  7F 0A                           MOV     R7,#0Ah
 2199:    284A  E6              LCMETERGETFRQ1: MOV     A,@R0
 2200:    284B  F0                              MOVX    @DPTR,A
 2201:    284C  08                              INC     R0
 2202:    284D  A3                              INC     DPTR
 2203:    284E  DF FA                           DJNZ    R7,LCMETERGETFRQ1
 2204:    2850  74 0D                           MOV     A,#0Dh
 2205:    2852  F0                              MOVX    @DPTR,A
 2206:    2853  90 00 48                        MOV     DPTR,#CONVT
 2207:    2856  12 23 CB                        LCALL   FLOATING_POINT_INPUT
 2208:    2859  D0 01                           POP     01h                             ;Restore R1
 2209:    285B  D0 03                           POP     03H                             ;Restore R3
 2210:    285D  12 26 CF                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2211:    2860  22                              RET
 2212:
 2213:    2861  00 CA 9A 3B     BINDEC:         DB 000h,0CAh,09Ah,03Bh                  ;1000000000
 2214:    2865  00 E1 F5 05                     DB 000h,0E1h,0F5h,005h                  ; 100000000
 2215:    2869  80 96 98 00                     DB 080h,096h,098h,000h                  ;  10000000
 2216:    286D  40 42 0F 00                     DB 040h,042h,0Fh,0000h                  ;   1000000
 2217:    2871  A0 86 01 00                     DB 0A0h,086h,001h,000h                  ;    100000
 2218:    2875  10 27 00 00                     DB 010h,027h,000h,000h                  ;     10000
 2219:    2879  E8 03 00 00                     DB 0E8h,003h,000h,000h                  ;      1000
 2220:    287D  64 00 00 00                     DB 064h,000h,000h,000h                  ;       100
 2221:    2881  0A 00 00 00                     DB 00Ah,000h,000h,000h                  ;        10
 2222:    2885  01 00 00 00                     DB 001h,000h,000h,000h                  ;         1
 2223:
 2224:    2889  7E 00 79 07     ADCMUL:         DB 7Eh,00h,79h,07h,03h,16h              ;CH0    1.6030779e-3
          288D  03 16
 2225:    288F  7E 00 79 07                     DB 7Eh,00h,79h,07h,03h,16h              ;CH1    1.6030779e-3
          2893  03 16
 2226:    2895  7E 00 79 07                     DB 7Eh,00h,79h,07h,03h,16h              ;CH2    1.6030779e-3
          2899  03 16
 2227:    289B  7E 00 79 07                     DB 7Eh,00h,79h,07h,03h,16h              ;CH3    1.6030779e-3
          289F  03 16
 2228:
 2229:    28A1  80 00 00 00     FPONE:          DB 80h,00h,00h,00h,00h,10h              ;1.0000000
          28A5  00 10
 2230:    28A7  80 00 00 00     FPTWO:          DB 80h,00h,00h,00h,00h,20h              ;2.0000000
          28AB  00 20
 2231:    28AD  81 00 27 59     FPPI:           DB 81h,00h,27h,59h,41h,31h              ;3.1415927
          28B1  41 31
 2232:
 2233:                          ;------------------------------------------------------------------
 2234:
 2235:          N      0000     IF DEVMODE=0
 2236:                                          ORG     1000h
 2237:                          ELSE
 2238:          N      3000                     ORG     3000h
 2239:                          ENDIF
 2240:
 2241:    3000  E4              START0:         CLR     A
 2242:    3001  F5 A8                           MOV     IE,A                            ;Disable all interrupts
 2243:    3003  F5 59                           MOV     MODE,A                          ;Set mode to RS232 Terminal
 2244:    3005  F5 20                           MOV     INTBITS,A                       ;RAM int routines (.0-.5 INTERRUPTS, .6=LCD OUT, .7 Single step)
 2245:    3007  14                              DEC     A
 2246:    3008  F5 5A                           MOV     SSADRLSB,A                      ;Single step adress
 2247:    300A  F5 5B                           MOV     SSADRMSB,A                      ;Single step adress
 2248:    300C  F5 B0                           MOV     P3,A                            ;All bits input
 2249:    300E  75 CA D9                        MOV     RCAP2L,#0D9h                    ;19200bps with 24MHz OSC
 2250:    3011  75 CB FF                        MOV     RCAP2H,#0FFh
 2251:    3014  75 CC D9                        MOV     TL2,#0D9h
 2252:    3017  75 CD FF                        MOV     TH2,#0FFh
 2253:    301A  75 C8 34                        MOV     T2CON,#34h                      ;TF2=l
 2254:                                                                                  ;EXF2=l
 2255:                                                                                  ;RCLK=h
 2256:                                                                                  ;TCLK=h
 2257:                                                                                  ;EXEN2=l
 2258:                                                                                  ;TR2=h
 2259:                                                                                  ;C/T2#=l
 2260:                                                                                  ;CP/RL2#=l
 2261:    301D  75 98 50                        MOV     SCON,#50h                       ;SM0=l
 2262:                                                                                  ;SM1=h
 2263:                                                                                  ;SM2=l
 2264:                                                                                  ;REN=h
 2265:                                                                                  ;TB8=l
 2266:                                                                                  ;RB8=l
 2267:                                                                                  ;TI=l
 2268:                                                                                  ;RI=l
 2269:    3020  75 53 01                        MOV     ROMACTION,#01h                  ;Action
 2270:    3023  75 54 02                        MOV     ROMSIZE,#02h                    ;Size
 2271:    3026  75 55 01                        MOV     ROMMODE,#01h                    ;Mode
 2272:
 2273:    3029  D2 88                           SETB    IT0                             ;Edge triggered
 2274:    302B  D2 8A                           SETB    IT1                             ;Edge triggered
 2275:    302D  D2 A8                           SETB    EX0                             ;Enable INT0
 2276:    302F  D2 AA                           SETB    EX1                             ;Enable INT1
 2277:    3031  D2 AF                           SETB    EA                              ;Enable interrupts
 2278:    3033  12 3D 72                        LCALL   LCDINIT
 2279:    3036  12 27 CC                        LCALL   LCMETERINIT
 2280:
 2281:          N      FFFF     IF DEVMODE=1
 2282:    3039  75 20 7F                        MOV     INTBITS,#7Fh                    ;Redirect all interrupts, Output to terminal
 2283:          N      0000             IF DEBUG=1
 2284:                                          SETB    INTBITS.7                       ;Set single step flag
 2285:                                          CLR     IT1                             ;Level triggered
 2286:                                          CLR     P3.3                            ;Pull INT1 low
 2287:                                          NOP
 2288:                                          NOP
 2289:                                  ENDIF
 2290:                          ENDIF
 2291:
 2292:    303C  75 81 CF        START:          MOV     SP,#0CFh                        ;Init stack pointer. The stack is 48 bytes
 2293:    303F  90 20 00                        MOV     DPTR,#2000h
 2294:          N      FFFF     IF DEVMODE=1
 2295:    3042  30 98 03                        JNB     RI,START10
 2296:    3045  02 00 00                        LJMP    0000h
 2297:    3048  75 59 00        START10:        MOV     MODE,#00h
 2298:                          ENDIF
 2299:
 2300:    304B  E5 59                           MOV     A,MODE
 2301:    304D  B4 FF 02                        CJNE    A,#0FFh,START11
 2302:    3050  E5 09                           MOV     A,MODEMAX
 2303:    3052  B5 0A 01        START11:        CJNE    A,MODEMAX+1,START12
 2304:    3055  E4                              CLR     A
 2305:    3056  F5 59           START12:        MOV     MODE,A
 2306:    3058  FF                              MOV     R7,A
 2307:    3059  70 02                           JNZ     START1
 2308:    305B  01 88                           AJMP    TERMINAL                        ;RS232 Terminal
 2309:    305D  DF 03           START1:         DJNZ    R7,START2
 2310:    305F  E4                              CLR     A                               ;Frequency counter channel0. External, Amplified
 2311:    3060  01 F6                           AJMP    FREQENCYCOUNT
 2312:    3062  DF 04           START2:         DJNZ    R7,START3                       ;Frequency counter channel0. External, TTL Level
 2313:    3064  74 80                           MOV     A,#80h
 2314:    3066  01 F6                           AJMP    FREQENCYCOUNT
 2315:    3068  DF 04           START3:         DJNZ    R7,START4
 2316:    306A  74 01                           MOV     A,#01h                          ;Frequency counter channel1. Function generator
 2317:    306C  01 F6                           AJMP    FREQENCYCOUNT
 2318:    306E  DF 04           START4:         DJNZ    R7,START5
 2319:    3070  74 02                           MOV     A,#02h                          ;Frequency counter channel2. LC Meter
 2320:    3072  01 F6                           AJMP    FREQENCYCOUNT
 2321:    3074  DF 04           START5:         DJNZ    R7,START6
 2322:    3076  74 03                           MOV     A,#03h                          ;Frequency counter channel3. ALE
 2323:    3078  01 F6                           AJMP    FREQENCYCOUNT
 2324:    307A  DF 02           START6:         DJNZ    R7,START7
 2325:    307C  21 3D                           AJMP    ADCONVERTER                     ;AD Coverter External PSU
 2326:    307E  DF 02           START7:         DJNZ    R7,START8
 2327:    3080  21 3D                           AJMP    ADCONVERTER                     ;AD Coverter Internal PSU
 2328:    3082  DF 02           START8:         DJNZ    R7,START9
 2329:    3084  21 98                           AJMP    LMETER                          ;Inductance
 2330:    3086  21 9A           START9:         AJMP    CMETER                          ;Capacitance
 2331:
 2332:
 2333:                          ;RS232 Terminal
 2334:                          ;IN:    Nothing
 2335:                          ;OUT:   Nothing
 2336:    3088  51 D3           TERMINAL:       ACALL   HELPMENU
 2337:    308A  31 DF           TERMINAL1:      ACALL   PRNTCRLF
 2338:    308C  74 3E                           MOV     A,#3Eh
 2339:    308E  51 BC                           ACALL   TXBYTE
 2340:    3090  51 A5           TERMINAL2:      ACALL   RXBYTE
 2341:    3092  B4 41 06                        CJNE    A,#41h,TERMINAL3
 2342:                                          ;Address input
 2343:    3095  31 DA                           ACALL   PRNTCMND
 2344:    3097  51 84                           ACALL   INPDPTR
 2345:    3099  80 EF                           SJMP    TERMINAL1
 2346:    309B  B4 44 06        TERMINAL3:      CJNE    A,#44h,TERMINAL4
 2347:                                          ;Dump
 2348:    309E  31 DA                           ACALL   PRNTCMND
 2349:    30A0  71 7E                           ACALL   DUMP
 2350:    30A2  80 E4                           SJMP    TERMINAL
 2351:    30A4  B4 45 06        TERMINAL4:      CJNE    A,#45h,TERMINAL5
 2352:                                          ;Enter hex
 2353:    30A7  31 DA                           ACALL   PRNTCMND
 2354:    30A9  71 AA                           ACALL   ENTERHEX
 2355:    30AB  80 DB                           SJMP    TERMINAL
 2356:    30AD  B4 47 06        TERMINAL5:      CJNE    A,#47h,TERMINAL6
 2357:                                          ;Go
 2358:    30B0  31 DA                           ACALL   PRNTCMND
 2359:    30B2  B1 85                           ACALL   GO
 2360:    30B4  80 D2                           SJMP    TERMINAL
 2361:    30B6  B4 48 04        TERMINAL6:      CJNE    A,#48h,TERMINAL7
 2362:                                          ;Help
 2363:    30B9  31 DA                           ACALL   PRNTCMND
 2364:    30BB  80 CB                           SJMP    TERMINAL
 2365:    30BD  B4 49 06        TERMINAL7:      CJNE    A,#49h,TERMINAL8
 2366:                                          ;Internal memory
 2367:    30C0  31 DA                           ACALL   PRNTCMND
 2368:    30C2  71 BF                           ACALL   MEMDUMP
 2369:    30C4  80 C4                           SJMP    TERMINAL1
 2370:    30C6  B4 4C 06        TERMINAL8:      CJNE    A,#4Ch,TERMINAL9
 2371:                                          ;Load
 2372:    30C9  31 DA                           ACALL   PRNTCMND
 2373:    30CB  B1 58                           ACALL   LOAD
 2374:    30CD  80 BB                           SJMP    TERMINAL1
 2375:    30CF  B4 50 06        TERMINAL9:      CJNE    A,#50h,TERMINAL10
 2376:                                          ;Program ROM
 2377:    30D2  31 DA                           ACALL   PRNTCMND
 2378:    30D4  B1 89                           ACALL   EPROM
 2379:    30D6  80 B0                           SJMP    TERMINAL
 2380:    30D8  B4 52 06        TERMINAL10:     CJNE    A,#52h,TERMINAL11
 2381:                                          ;Run
 2382:    30DB  31 DA                           ACALL   PRNTCMND
 2383:    30DD  B1 87                           ACALL   RUN
 2384:    30DF  80 A7                           SJMP    TERMINAL
 2385:    30E1  B4 53 07        TERMINAL11:     CJNE    A,#53h,TERMINAL12
 2386:                                          ;SFR dump
 2387:    30E4  12 31 DA                        LCALL   PRNTCMND
 2388:    30E7  71 E2                           ACALL   DUMPSFR
 2389:    30E9  80 9F                           SJMP    TERMINAL1
 2390:    30EB  B4 9F 03        TERMINAL12:     CJNE    A,#9Fh,TERMINAL13
 2391:                                          ;Esc
 2392:    30EE  02 00 00                        LJMP    0000h
 2393:    30F1  B4 0D 9C        TERMINAL13:     CJNE    A,#0Dh,TERMINAL2
 2394:                                          ;CR
 2395:    30F4  80 94                           SJMP    TERMINAL1
 2396:
 2397:
 2398:                          ;Frequency conter and AD Converter channel 2 and 3
 2399:                          ;IN:    Frequency cont channel (0-3)
 2400:                          ;OUT:   Nothing
 2401:    30F6  C0 E0           FREQENCYCOUNT:  PUSH    ACC
 2402:    30F8  12 3D A0                        LCALL   FRQCOUNT
 2403:    30FB  78 44                           MOV     R0,#LCDLINE+4                   ;Decimal buffer
 2404:    30FD  12 27 51                        LCALL   BIN2DEC
 2405:    3100  FF                              MOV     R7,A                            ;Number of digits
 2406:    3101  D0 E0                           POP     ACC
 2407:    3103  C0 E0                           PUSH    ACC
 2408:    3105  12 3D DA                        LCALL   FRQFORMAT
 2409:    3108  78 40                           MOV     R0,#LCDLINE                     ;Output result
 2410:    310A  7F 10                           MOV     R7,#10h
 2411:    310C  31 BA                           ACALL   PRINTSTR
 2412:    310E  74 02                           MOV     A,#02h                          ;ADC Channel 2
 2413:    3110  12 3E 3D                        LCALL   ADCONVERT
 2414:    3113  74 02                           MOV     A,#02h
 2415:    3115  79 44                           MOV     R1,#LCDLINE+4
 2416:    3117  12 3E 92                        LCALL   ADOUTPUT
 2417:    311A  74 03                           MOV     A,#03h                          ;ADC Channel 3
 2418:    311C  12 3E 3D                        LCALL   ADCONVERT
 2419:    311F  74 03                           MOV     A,#03h
 2420:    3121  79 4A                           MOV     R1,#LCDLINE+10
 2421:    3123  12 3E 92                        LCALL   ADOUTPUT
 2422:    3126  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2423:    3129  75 41 4E                        MOV     LCDLINE+1,#'N'
 2424:    312C  75 42 54                        MOV     LCDLINE+2,#'T'
 2425:    312F  75 43 20                        MOV     LCDLINE+3,#' '
 2426:    3132  78 40                           MOV     R0,#LCDLINE
 2427:    3134  7F 10                           MOV     R7,#10h
 2428:    3136  12 31 BA                        LCALL   PRINTSTR
 2429:    3139  D0 E0                           POP     ACC
 2430:    313B  01 3C                           AJMP    START
 2431:
 2432:                          ;AD Converter
 2433:                          ;IN:    Nothing
 2434:                          ;OUT:   Nothing
 2435:    313D  74 02           ADCONVERTER:    MOV     A,#02h                          ;Channel 2
 2436:    313F  12 3E 3D                        LCALL   ADCONVERT
 2437:    3142  74 02                           MOV     A,#02h
 2438:    3144  79 44                           MOV     R1,#LCDLINE+4
 2439:    3146  12 3E 92                        LCALL   ADOUTPUT
 2440:    3149  74 03                           MOV     A,#03h                          ;Channel 3
 2441:    314B  12 3E 3D                        LCALL   ADCONVERT
 2442:    314E  74 03                           MOV     A,#03h
 2443:    3150  79 4A                           MOV     R1,#LCDLINE+10
 2444:    3152  12 3E 92                        LCALL   ADOUTPUT
 2445:    3155  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2446:    3158  75 41 4E                        MOV     LCDLINE+1,#'N'
 2447:    315B  75 42 54                        MOV     LCDLINE+2,#'T'
 2448:    315E  75 43 20                        MOV     LCDLINE+3,#' '
 2449:    3161  78 40                           MOV     R0,#LCDLINE
 2450:    3163  7F 10                           MOV     R7,#10h
 2451:    3165  12 31 BA                        LCALL   PRINTSTR
 2452:    3168  74 00                           MOV     A,#00h                          ;Channel 0
 2453:    316A  12 3E 3D                        LCALL   ADCONVERT
 2454:    316D  74 00                           MOV     A,#00h
 2455:    316F  79 44                           MOV     R1,#LCDLINE+4
 2456:    3171  12 3E 92                        LCALL   ADOUTPUT
 2457:    3174  74 01                           MOV     A,#01h                          ;Channel 1
 2458:    3176  12 3E 3D                        LCALL   ADCONVERT
 2459:    3179  74 01                           MOV     A,#01h
 2460:    317B  79 4A                           MOV     R1,#LCDLINE+10
 2461:    317D  12 3E 92                        LCALL   ADOUTPUT
 2462:    3180  75 40 45                        MOV     LCDLINE,#'E'                    ;Output result
 2463:    3183  75 41 58                        MOV     LCDLINE+1,#'X'
 2464:    3186  75 42 54                        MOV     LCDLINE+2,#'T'
 2465:    3189  75 43 20                        MOV     LCDLINE+3,#' '
 2466:    318C  78 40                           MOV     R0,#LCDLINE
 2467:    318E  7F 10                           MOV     R7,#10h
 2468:    3190  12 31 BA                        LCALL   PRINTSTR
 2469:    3193  12 3D 92                        LCALL   WAITASEC                        ;Wait 1 Secod
 2470:    3196  01 3C                           AJMP    START
 2471:
 2472:                          ;Inductance meter
 2473:                          ;IN:    Nothing
 2474:                          ;OUT:   Nothing
 2475:    3198                  LMETER:
 2476:    3198  01 3C                           AJMP    START
 2477:
 2478:                          ;Capacitance meter
 2479:                          ;IN:    Nothing
 2480:                          ;OUT:   Nothing
 2481:    319A                  CMETER:
 2482:    319A  01 3C                           AJMP    START
 2483:
 2484:                          ;RS232 Functions
 2485:                          ;------------------------------------------------------------------
 2486:
 2487:    319C  85 82 57        PRNTCSTR:       MOV     DPLSAVE,DPL
 2488:    319F  85 83 58                        MOV     DPHSAVE,DPH
 2489:    31A2  D0 83                           POP     DPH
 2490:    31A4  D0 82                           POP     DPL
 2491:    31A6  E4              PRNTCSTR1:      CLR     A
 2492:    31A7  93                              MOVC    A,@A+DPTR
 2493:    31A8  A3                              INC     DPTR
 2494:    31A9  60 04                           JZ      PRNTCSTR2
 2495:    31AB  51 BC                           ACALL   TXBYTE
 2496:    31AD  80 F7                           SJMP    PRNTCSTR1
 2497:    31AF  C0 82           PRNTCSTR2:      PUSH    DPL
 2498:    31B1  C0 83                           PUSH    DPH
 2499:    31B3  85 57 82                        MOV     DPL,DPLSAVE
 2500:    31B6  85 58 83                        MOV     DPH,DPHSAVE
 2501:    31B9  22                              RET
 2502:
 2503:    31BA  30 06 09        PRINTSTR:       JNB     INTBITS.6,PRINTSTRLCD
 2504:    31BD  E6              PRINTSTRTRM:    MOV     A,@R0
 2505:    31BE  51 BC                           ACALL   TXBYTE
 2506:    31C0  08                              INC     R0
 2507:    31C1  DF FA                           DJNZ    R7,PRINTSTRTRM
 2508:    31C3  31 DF                           ACALL   PRNTCRLF
 2509:    31C5  22                              RET
 2510:
 2511:    31C6  E6              PRINTSTRLCD:    MOV     A,@R0
 2512:    31C7  12 3D 53                        LCALL   LCDCHROUT
 2513:    31CA  08                              INC     R0
 2514:    31CB  DF F9                           DJNZ    R7,PRINTSTRLCD
 2515:    31CD  22                              RET
 2516:
 2517:    31CE  E0              PRINTDPTRSTR:   MOVX    A,@DPTR
 2518:    31CF  51 BC                           ACALL   TXBYTE
 2519:    31D1  A3                              INC     DPTR
 2520:    31D2  B4 0D F9                        CJNE    A,#0Dh,PRINTDPTRSTR
 2521:    31D5  74 0A                           MOV     A,#0Ah
 2522:    31D7  51 BC                           ACALL   TXBYTE
 2523:    31D9  22                              RET
 2524:
 2525:    31DA  51 BC           PRNTCMND:       ACALL   TXBYTE
 2526:    31DC  31 DF                           ACALL   PRNTCRLF
 2527:    31DE  22                              RET
 2528:
 2529:    31DF  74 0D           PRNTCRLF:       MOV     A,#0Dh
 2530:    31E1  51 BC                           ACALL   TXBYTE
 2531:    31E3  74 0A                           MOV     A,#0Ah
 2532:    31E5  51 BC                           ACALL   TXBYTE
 2533:    31E7  22                              RET
 2534:
 2535:    31E8  C0 E0           HEXOUT:         PUSH    ACC
 2536:    31EA  C4                              SWAP    A
 2537:    31EB  31 EF                           ACALL   HEXOUT1
 2538:    31ED  D0 E0                           POP     ACC
 2539:    31EF  54 0F           HEXOUT1:        ANL     A,#0Fh
 2540:    31F1  C3                              CLR     C
 2541:    31F2  94 0A                           SUBB    A,#0Ah
 2542:    31F4  40 02                           JC      HEXOUT2
 2543:    31F6  24 07                           ADD     A,#07h
 2544:    31F8  24 3A           HEXOUT2:        ADD     A,#3Ah
 2545:    31FA  51 BC                           ACALL   TXBYTE
 2546:    31FC  22                              RET
 2547:
 2548:    31FD  78 08           BINOUT:         MOV     R0,#08h
 2549:    31FF  33              BINOUT1:        RLC     A
 2550:    3200  C0 E0                           PUSH    ACC
 2551:    3202  74 20                           MOV     A,#20h
 2552:    3204  12 32 BC                        LCALL   TXBYTE
 2553:    3207  74 20                           MOV     A,#20h
 2554:    3209  12 32 BC                        LCALL   TXBYTE
 2555:    320C  74 30                           MOV     A,#30H
 2556:    320E  50 01           BINOUT2:        JNC     BINOUT3
 2557:    3210  04                              INC     A
 2558:    3211  12 32 BC        BINOUT3:        LCALL   TXBYTE
 2559:    3214  D0 E0                           POP     ACC
 2560:    3216  D8 E7                           DJNZ    R0,BINOUT1
 2561:    3218  12 31 DF                        LCALL   PRNTCRLF
 2562:    321B  22                              RET
 2563:
 2564:    321C  E5 83           HEXDPTR:        MOV     A,DPH
 2565:    321E  31 E8                           ACALL   HEXOUT
 2566:    3220  E5 82                           MOV     A,DPL
 2567:    3222  31 E8                           ACALL   HEXOUT
 2568:    3224  74 20                           MOV     A,#20h
 2569:    3226  51 BC                           ACALL   TXBYTE
 2570:    3228  22                              RET
 2571:
 2572:    3229  E5 24           HEXDUMPFP:      MOV     A,ARG_STACK
 2573:    322B  C3                              CLR     C
 2574:    322C  94 05                           SUBB    A,#05h
 2575:    322E  F5 82                           MOV     DPL,A
 2576:    3230  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 2577:    3233  7F 06                           MOV     R7,#06h
 2578:    3235  E0              HEXDUMPFP1:     MOVX    A,@DPTR
 2579:    3236  31 E8                           ACALL   HEXOUT
 2580:    3238  05 82                           INC     DPL
 2581:    323A  DF F9                           DJNZ    R7,HEXDUMPFP1
 2582:    323C  74 0D                           MOV     A,#0Dh
 2583:    323E  51 BC                           ACALL   TXBYTE
 2584:    3240  74 0A                           MOV     A,#0Ah
 2585:    3242  51 BC                           ACALL   TXBYTE
 2586:    3244  22                              RET
 2587:
 2588:    3245  51 51           HEXINPBYTE:     ACALL   HEXINP
 2589:    3247  40 07                           JC      HEXINPBYTE1
 2590:    3249  C4                              SWAP    A
 2591:    324A  FB                              MOV     R3,A
 2592:    324B  51 51                           ACALL   HEXINP
 2593:    324D  40 01                           JC      HEXINPBYTE1
 2594:    324F  2B                              ADD     A,R3
 2595:    3250  22              HEXINPBYTE1:    RET
 2596:
 2597:    3251  51 5D           HEXINP:         ACALL   HEXINP2
 2598:    3253  40 07                           JC      HEXINP1
 2599:    3255  C0 E0                           PUSH    ACC
 2600:    3257  EA                              MOV     A,R2
 2601:    3258  51 BC                           ACALL   TXBYTE
 2602:    325A  D0 E0                           POP     ACC
 2603:    325C  22              HEXINP1:        RET
 2604:
 2605:    325D  51 A5           HEXINP2:        ACALL   RXBYTE
 2606:    325F  B4 9F 02                        CJNE    A,#9Fh,HEXINP3                  ;Esc
 2607:    3262  D3                              SETB    C
 2608:    3263  22                              RET
 2609:    3264  B4 0D 02        HEXINP3:        CJNE    A,#0Dh,HEXINP4                  ;Cr
 2610:    3267  D3                              SETB    C
 2611:    3268  22                              RET
 2612:    3269  FA              HEXINP4:        MOV     R2,A
 2613:    326A  B4 3A 00                        CJNE    A,#3Ah,HEXINP40
 2614:    326D  50 08           HEXINP40:       JNC     HEXINP5
 2615:    326F  B4 30 00                        CJNE    A,#30h,HEXINP41
 2616:    3272  40 E9           HEXINP41:       JC      HEXINP2
 2617:    3274  94 30                           SUBB    A,#30h
 2618:    3276  22                              RET
 2619:    3277  B4 47 00        HEXINP5:        CJNE    A,#47h,HEXINP50
 2620:    327A  50 E1           HEXINP50:       JNC     HEXINP2
 2621:    327C  B4 41 00                        CJNE    A,#41h,HEXINP51
 2622:    327F  40 DC           HEXINP51:       JC      HEXINP2
 2623:    3281  94 37                           SUBB    A,#37h
 2624:    3283  22                              RET
 2625:
 2626:    3284  51 1C           INPDPTR:        ACALL   HEXDPTR
 2627:    3286  51 45                           ACALL   HEXINPBYTE
 2628:    3288  40 08                           JC      INPDPTR1
 2629:    328A  F5 83                           MOV     DPH,A
 2630:    328C  51 45                           ACALL   HEXINPBYTE
 2631:    328E  40 02                           JC      INPDPTR1
 2632:    3290  F5 82                           MOV     DPL,A
 2633:    3292  31 DF           INPDPTR1:       ACALL   PRNTCRLF
 2634:    3294  22                              RET
 2635:
 2636:    3295  74 05           RX16BYTES:      MOV     A,#05h
 2637:    3297  51 BC                           ACALL   TXBYTE
 2638:    3299  78 40                           MOV     R0,#ROMBUFF
 2639:    329B  51 A5           RX16BYTES1:     ACALL   RXBYTE
 2640:    329D  F6                              MOV     @R0,A
 2641:    329E  08                              INC     R0
 2642:    329F  B8 50 F9                        CJNE    R0,#ROMBUFF+10h,RX16BYTES1
 2643:    32A2  78 40                           MOV     R0,#ROMBUFF
 2644:    32A4  22                              RET
 2645:
 2646:    32A5  20 AA 08        RXBYTE:         JB      EX1,RXBYTE1
 2647:    32A8  30 98 FD                        JNB     RI,$
 2648:    32AB  C2 98                           CLR     RI
 2649:    32AD  E5 99                           MOV     A,SBUF
 2650:    32AF  22                              RET
 2651:
 2652:    32B0  C2 AA           RXBYTE1:        CLR     EX1
 2653:    32B2  30 98 FD                        JNB     RI,$
 2654:    32B5  C2 98                           CLR     RI
 2655:    32B7  E5 99                           MOV     A,SBUF
 2656:    32B9  D2 AA                           SETB    EX1
 2657:    32BB  22                              RET
 2658:
 2659:    32BC  20 AA 08        TXBYTE:         JB      EX1,TXBYTE1
 2660:    32BF  F5 99                           MOV     SBUF,A
 2661:    32C1  30 99 FD                        JNB     TI,$
 2662:    32C4  C2 99                           CLR     TI
 2663:    32C6  22                              RET
 2664:
 2665:    32C7  C2 AA           TXBYTE1:        CLR     EX1
 2666:    32C9  F5 99                           MOV     SBUF,A
 2667:    32CB  30 99 FD                        JNB     TI,$
 2668:    32CE  C2 99                           CLR     TI
 2669:    32D0  D2 AA                           SETB    EX1
 2670:    32D2  22                              RET
 2671:
 2672:                          ;Functions
 2673:                          ;------------------------------------------------------------------
 2674:
 2675:    32D3  31 9C           HELPMENU:       ACALL   PRNTCSTR
 2676:    32D5  0E                              DB      0Eh
 2677:          N      FFFF     IF DEVMODE=1
 2678:    32D6  2A 2A 2A 20                     DB      '*** DEVMODE ***',0Dh,0Ah
          32DA  44 45 56 4D
          32DE  4F 44 45 20
          32E2  2A 2A 2A 0D
          32E6  0A
 2679:                          ENDIF
 2680:    32E7  41 20 41 64                     DB      'A Address input',0Dh,0Ah
          32EB  64 72 65 73
          32EF  73 20 69 6E
          32F3  70 75 74 0D
          32F7  0A
 2681:    32F8  44 20 44 75                     DB      'D Dump as hex',0Dh,0Ah
          32FC  6D 70 20 61
          3300  73 20 68 65
          3304  78 0D 0A
 2682:    3307  45 20 45 6E                     DB      'E Enter hex',0Dh,0Ah
          330B  74 65 72 20
          330F  68 65 78 0D
          3313  0A
 2683:    3314  47 20 47 6F                     DB      'G Go (Load and Run)',0Dh,0Ah
          3318  20 28 4C 6F
          331C  61 64 20 61
          3320  6E 64 20 52
          3324  75 6E 29 0D
          3328  0A
 2684:    3329  48 20 48 65                     DB      'H Help',0Dh,0Ah
          332D  6C 70 0D 0A
 2685:    3331  49 20 49 6E                     DB      'I Internal memory dump',0Dh,0Ah
          3335  74 65 72 6E
          3339  61 6C 20 6D
          333D  65 6D 6F 72
          3341  79 20 64 75
          3345  6D 70 0D 0A
 2686:    3349  4C 20 4C 6F                     DB      'L Load cmd file',0Dh,0Ah
          334D  61 64 20 63
          3351  6D 64 20 66
          3355  69 6C 65 0D
          3359  0A
 2687:    335A  50 20 50 72                     DB      'P Program ROM',0Dh,0Ah
          335E  6F 67 72 61
          3362  6D 20 52 4F
          3366  4D 0D 0A
 2688:    3369  52 20 52 75                     DB      'R Run',0Dh,0Ah
          336D  6E 0D 0A
 2689:    3370  53 20 53 46                     DB      'S SFR dunp',0Dh,0Ah,00h
          3374  52 20 64 75
          3378  6E 70 0D 0A
          337C  00
 2690:    337D  22                              RET
 2691:
 2692:    337E  C0 82           DUMP:           PUSH    DPL
 2693:    3380  C0 83                           PUSH    DPH
 2694:    3382  C0 02                           PUSH    02h
 2695:    3384  C0 03                           PUSH    03h
 2696:    3386  7B 10           DUMP1:          MOV     R3,#10h
 2697:    3388  7A 10           DUMP2:          MOV     R2,#10h
 2698:    338A  51 1C                           ACALL   HEXDPTR
 2699:    338C  E0              DUMP3:          MOVX    A,@DPTR
 2700:    338D  31 E8                           ACALL   HEXOUT
 2701:    338F  74 20                           MOV     A,#20h
 2702:    3391  51 BC                           ACALL   TXBYTE
 2703:    3393  A3                              INC     DPTR
 2704:    3394  DA F6                           DJNZ    R2,DUMP3
 2705:    3396  31 DF                           ACALL   PRNTCRLF
 2706:    3398  DB EE                           DJNZ    R3,DUMP2
 2707:    339A  31 DF                           ACALL   PRNTCRLF
 2708:    339C  51 A5                           ACALL   RXBYTE
 2709:    339E  B4 9F E5                        CJNE    A,#9Fh,DUMP1                    ;Esc
 2710:    33A1  D0 03                           POP     03h
 2711:    33A3  D0 02                           POP     02h
 2712:    33A5  D0 83                           POP     DPH
 2713:    33A7  D0 82                           POP     DPL
 2714:    33A9  22                              RET
 2715:
 2716:    33AA  C0 82           ENTERHEX:       PUSH    DPL
 2717:    33AC  C0 83                           PUSH    DPH
 2718:    33AE  51 1C           ENTERHEX1:      ACALL   HEXDPTR
 2719:    33B0  51 45                           ACALL   HEXINPBYTE
 2720:    33B2  40 06                           JC      ENTERHEX2
 2721:    33B4  F0                              MOVX    @DPTR,A
 2722:    33B5  A3                              INC     DPTR
 2723:    33B6  31 DF                           ACALL   PRNTCRLF
 2724:    33B8  80 F4                           SJMP    ENTERHEX1
 2725:    33BA  D0 83           ENTERHEX2:      POP     DPH
 2726:    33BC  D0 82                           POP     DPL
 2727:    33BE  22                              RET
 2728:
 2729:    33BF  C0 00           MEMDUMP:        PUSH    00h
 2730:    33C1  78 00                           MOV     R0,#00h
 2731:    33C3  E4              MEMDUMP1:       CLR     A
 2732:    33C4  31 E8                           ACALL   HEXOUT
 2733:    33C6  E8                              MOV     A,R0
 2734:    33C7  31 E8                           ACALL   HEXOUT
 2735:    33C9  74 20                           MOV     A,#20h
 2736:    33CB  51 BC                           ACALL   TXBYTE
 2737:    33CD  E6              MEMDUMP2:       MOV     A,@R0
 2738:    33CE  31 E8                           ACALL   HEXOUT
 2739:    33D0  74 20                           MOV     A,#20h
 2740:    33D2  51 BC                           ACALL   TXBYTE
 2741:    33D4  08                              INC     R0
 2742:    33D5  E8                              MOV     A,R0
 2743:    33D6  54 0F                           ANL     A,#0Fh
 2744:    33D8  70 F3                           JNZ     MEMDUMP2
 2745:    33DA  31 DF                           ACALL   PRNTCRLF
 2746:    33DC  E8                              MOV     A,R0
 2747:    33DD  70 E4                           JNZ     MEMDUMP1
 2748:    33DF  D0 00                           POP     00h
 2749:    33E1  22                              RET
 2750:
 2751:    33E2  C0 D0           DUMPSFR:        PUSH    PSW
 2752:    33E4  C2 D3                           CLR     RS0
 2753:    33E6  C2 D4                           CLR     RS1
 2754:    33E8  C0 E0                           PUSH    ACC
 2755:    33EA  C0 00                           PUSH    00h
 2756:    33EC  C0 E0                           PUSH    ACC
 2757:    33EE  12 31 9C                        LCALL   PRNTCSTR
 2758:    33F1  0D 0A 53 46                     DB 0Dh,0Ah,'SFR  D7 D6 D5 D4 D3 D2 D1 D0',0Dh,0Ah
          33F5  52 20 20 44
          33F9  37 20 44 36
          33FD  20 44 35 20
          3401  44 34 20 44
          3405  33 20 44 32
          3409  20 44 31 20
          340D  44 30 0D 0A
 2759:    3411  2D 2D 2D 2D                     DB '----------------------------',0Dh,0Ah
          3415  2D 2D 2D 2D
          3419  2D 2D 2D 2D
          341D  2D 2D 2D 2D
          3421  2D 2D 2D 2D
          3425  2D 2D 2D 2D
          3429  2D 2D 2D 2D
          342D  0D 0A
 2760:    342F  41 43 43 20                     DB 'ACC ',0
          3433  00
 2761:    3434  D0 E0                           POP     ACC
 2762:    3436  12 31 FD                        LCALL   BINOUT
 2763:    3439  12 31 9C                        LCALL   PRNTCSTR
 2764:    343C  42 20 20 20                     DB 'B   ',0
          3440  00
 2765:    3441  E5 F0                           MOV     A,B
 2766:    3443  12 31 FD                        LCALL   BINOUT
 2767:    3446  12 31 9C                        LCALL   PRNTCSTR
 2768:    3449  44 50 48 20                     DB 'DPH ',0
          344D  00
 2769:    344E  E5 83                           MOV     A,DPH
 2770:    3450  12 31 FD                        LCALL   BINOUT
 2771:    3453  12 31 9C                        LCALL   PRNTCSTR
 2772:    3456  44 50 4C 20                     DB 'DPL ',0
          345A  00
 2773:    345B  E5 82                           MOV     A,DPL
 2774:    345D  12 31 FD                        LCALL   BINOUT
 2775:    3460  12 31 9C                        LCALL   PRNTCSTR
 2776:    3463  49 45 20 20                     DB 'IE  ',0
          3467  00
 2777:    3468  E5 A8                           MOV     A,IE
 2778:    346A  12 31 FD                        LCALL   BINOUT
 2779:    346D  12 31 9C                        LCALL   PRNTCSTR
 2780:    3470  49 50 20 20                     DB 'IP  ',0
          3474  00
 2781:    3475  E5 B8                           MOV     A,IP
 2782:    3477  12 31 FD                        LCALL   BINOUT
 2783:    347A  12 31 9C                        LCALL   PRNTCSTR
 2784:    347D  50 30 20 20                     DB 'P0  ',0
          3481  00
 2785:    3482  E5 80                           MOV     A,P0
 2786:    3484  12 31 FD                        LCALL   BINOUT
 2787:    3487  12 31 9C                        LCALL   PRNTCSTR
 2788:    348A  50 31 20 20                     DB 'P1  ',0
          348E  00
 2789:    348F  E5 90                           MOV     A,P1
 2790:    3491  12 31 FD                        LCALL   BINOUT
 2791:    3494  12 31 9C                        LCALL   PRNTCSTR
 2792:    3497  50 32 20 20                     DB 'P2  ',0
          349B  00
 2793:    349C  E5 A0                           MOV     A,P2
 2794:    349E  12 31 FD                        LCALL   BINOUT
 2795:    34A1  12 31 9C                        LCALL   PRNTCSTR
 2796:    34A4  50 33 20 20                     DB 'P3  ',0
          34A8  00
 2797:    34A9  E5 B0                           MOV     A,P3
 2798:    34AB  12 31 FD                        LCALL   BINOUT
 2799:    34AE  12 31 9C                        LCALL   PRNTCSTR
 2800:    34B1  50 43 4F 4E                     DB 'PCON',0
          34B5  00
 2801:    34B6  E5 87                           MOV     A,PCON
 2802:    34B8  12 31 FD                        LCALL   BINOUT
 2803:    34BB  12 31 9C                        LCALL   PRNTCSTR
 2804:    34BE  50 53 57 20                     DB 'PSW ',0
          34C2  00
 2805:    34C3  E5 D0                           MOV     A,PSW
 2806:    34C5  12 31 FD                        LCALL   BINOUT
 2807:    34C8  12 31 9C                        LCALL   PRNTCSTR
 2808:    34CB  53 42 55 46                     DB 'SBUF',0
          34CF  00
 2809:    34D0  E5 99                           MOV     A,SBUF
 2810:    34D2  12 31 FD                        LCALL   BINOUT
 2811:    34D5  12 31 9C                        LCALL   PRNTCSTR
 2812:    34D8  53 43 4F 4E                     DB 'SCON',0
          34DC  00
 2813:    34DD  E5 98                           MOV     A,SCON
 2814:    34DF  12 31 FD                        LCALL   BINOUT
 2815:    34E2  12 31 9C                        LCALL   PRNTCSTR
 2816:    34E5  53 50 20 20                     DB 'SP  ',0
          34E9  00
 2817:    34EA  E5 81                           MOV     A,SP
 2818:    34EC  12 31 FD                        LCALL   BINOUT
 2819:    34EF  12 31 9C                        LCALL   PRNTCSTR
 2820:    34F2  54 43 4F 4E                     DB 'TCON',0
          34F6  00
 2821:    34F7  E5 88                           MOV     A,TCON
 2822:    34F9  12 31 FD                        LCALL   BINOUT
 2823:    34FC  12 31 9C                        LCALL   PRNTCSTR
 2824:    34FF  54 48 30 20                     DB 'TH0 ',0
          3503  00
 2825:    3504  E5 8C                           MOV     A,TH0
 2826:    3506  12 31 FD                        LCALL   BINOUT
 2827:    3509  12 31 9C                        LCALL   PRNTCSTR
 2828:    350C  54 48 31 20                     DB 'TH1 ',0
          3510  00
 2829:    3511  E5 8D                           MOV     A,TH1
 2830:    3513  12 31 FD                        LCALL   BINOUT
 2831:    3516  12 31 9C                        LCALL   PRNTCSTR
 2832:    3519  54 4C 30 20                     DB 'TL0 ',0
          351D  00
 2833:    351E  E5 8A                           MOV     A,TL0
 2834:    3520  12 31 FD                        LCALL   BINOUT
 2835:    3523  12 31 9C                        LCALL   PRNTCSTR
 2836:    3526  54 4C 31 20                     DB 'TL1 ',0
          352A  00
 2837:    352B  E5 8B                           MOV     A,TL1
 2838:    352D  12 31 FD                        LCALL   BINOUT
 2839:    3530  12 31 9C                        LCALL   PRNTCSTR
 2840:    3533  54 4D 4F 44                     DB 'TMOD',0
          3537  00
 2841:    3538  E5 89                           MOV     A,TMOD
 2842:    353A  12 31 FD                        LCALL   BINOUT
 2843:    353D  D0 00                           POP     00h
 2844:    353F  D0 E0                           POP     ACC
 2845:    3541  D0 D0                           POP     PSW
 2846:    3543  22                              RET
 2847:
 2848:    3544  7B 40           LOAD1K:         MOV     R3,#40h
 2849:    3546  51 95           LOAD1K1:        ACALL   RX16BYTES                       ;Read 16 bytes from cmd file
 2850:    3548  E6              LOAD1K2:        MOV     A,@R0
 2851:    3549  F0                              MOVX    @DPTR,A
 2852:    354A  A3                              INC     DPTR
 2853:    354B  08                              INC     R0
 2854:    354C  E8                              MOV     A,R0
 2855:    354D  64 50                           XRL     A,#50h
 2856:    354F  70 F7                           JNZ     LOAD1K2                         ;Not 16 bytes yet
 2857:    3551  DB F3                           DJNZ    R3,LOAD1K1                      ;Not 1K yet
 2858:    3553  74 2E                           MOV     A,#'.'
 2859:    3555  51 BC                           ACALL   TXBYTE
 2860:    3557  22                              RET
 2861:
 2862:    3558  C0 82           LOAD:           PUSH    DPL
 2863:    355A  C0 83                           PUSH    DPH
 2864:    355C  C0 00                           PUSH    00h
 2865:    355E  C0 03                           PUSH    03h
 2866:    3560  C0 04                           PUSH    04h
 2867:    3562  31 9C                           ACALL   PRNTCSTR
 2868:    3564  4C 6F 61 64                     DB      'Loading .',0
          3568  69 6E 67 20
          356C  2E 00
 2869:    356E  7C 08                           MOV     R4,#08h
 2870:    3570  B1 44           LOAD10:         ACALL   LOAD1K
 2871:    3572  DC FC                           DJNZ    R4,LOAD10
 2872:    3574  74 06                           MOV     A,#06h
 2873:    3576  51 BC                           ACALL   TXBYTE                          ;End read 16 bytes from cmd file
 2874:    3578  31 DF                           ACALL   PRNTCRLF
 2875:    357A  D0 04                           POP     04h
 2876:    357C  D0 03                           POP     03h
 2877:    357E  D0 00                           POP     00h
 2878:    3580  D0 83                           POP     DPH
 2879:    3582  D0 82                           POP     DPL
 2880:    3584  22                              RET
 2881:
 2882:    3585  B1 58           GO:             ACALL   LOAD
 2883:    3587  E4              RUN:            CLR     A
 2884:    3588  73                              JMP     @A+DPTR
 2885:
 2886:                          ;ROM menu selection
 2887:                          ;------------------------------------------------------------------
 2888:
 2889:    3589  B1 FE           EPROM:          ACALL   ROMMENU
 2890:    358B  B4 94 6F                        CJNE    A,#94h,EPROMEXIT
 2891:    358E  12 38 8E                        LCALL   ROMINSERT
 2892:    3591  40 F6                           JC      EPROM
 2893:    3593  12 3C CE                        LCALL   ROMINIT                         ;Turn on VCC, pull RST high and init programming mode
 2894:    3596  40 F1                           JC      EPROM                           ;Initialisation failed
 2895:    3598  E5 53                           MOV     A,ROMACTION
 2896:    359A  14                              DEC     A
 2897:    359B  70 12                           JNZ     EPROM2
 2898:                                          ;Test erased
 2899:    359D  12 39 38                        LCALL   ROMWAIT
 2900:    35A0  E5 55                           MOV     A,ROMMODE
 2901:    35A2  14                              DEC     A
 2902:    35A3  70 05                           JNZ     EPROM1
 2903:    35A5  12 39 48                        LCALL   BM_ROMERASED
 2904:    35A8  80 DF                           SJMP    EPROM
 2905:    35AA  12 3A 2D        EPROM1:         LCALL   PM_ROMERASED
 2906:    35AD  80 DA                           SJMP    EPROM
 2907:    35AF  14              EPROM2:         DEC     A
 2908:    35B0  70 12                           JNZ     EPROM3
 2909:                                          ;Dump to hex file
 2910:    35B2  12 39 38                        LCALL   ROMWAIT
 2911:    35B5  E5 55                           MOV     A,ROMMODE
 2912:    35B7  14                              DEC     A
 2913:    35B8  70 05                           JNZ     EPROM21
 2914:    35BA  12 39 94                        LCALL   BM_ROMDUMPF
 2915:    35BD  80 CA                           SJMP    EPROM
 2916:    35BF  12 3A 84        EPROM21:        LCALL   PM_ROMDUMPF
 2917:    35C2  80 C5                           SJMP    EPROM
 2918:    35C4  14              EPROM3:         DEC     A
 2919:    35C5  70 0F                           JNZ     EPROM4
 2920:                                          ;Dump to screen
 2921:    35C7  E5 55                           MOV     A,ROMMODE
 2922:    35C9  14                              DEC     A
 2923:    35CA  70 05                           JNZ     EPROM31
 2924:    35CC  12 39 C0                        LCALL   BM_ROMDUMPS
 2925:    35CF  80 B8                           SJMP    EPROM
 2926:    35D1  12 3A BC        EPROM31:        LCALL   PM_ROMDUMPS
 2927:    35D4  80 B3                           SJMP    EPROM
 2928:    35D6  14              EPROM4:         DEC     A
 2929:    35D7  70 12                           JNZ     EPROM5
 2930:                                          ;Verify
 2931:    35D9  12 39 38                        LCALL   ROMWAIT
 2932:    35DC  E5 55                           MOV     A,ROMMODE
 2933:    35DE  14                              DEC     A
 2934:    35DF  70 05                           JNZ     EPROM41
 2935:    35E1  12 39 ED                        LCALL   BM_ROMVERIFY
 2936:    35E4  80 A3                           SJMP    EPROM
 2937:    35E6  12 3A F4        EPROM41:        LCALL   PM_ROMVERIFY
 2938:    35E9  80 9E                           SJMP    EPROM
 2939:    35EB                  EPROM5:         ;Program
 2940:    35EB  12 39 38                        LCALL   ROMWAIT
 2941:    35EE  E5 55                           MOV     A,ROMMODE
 2942:    35F0  14                              DEC     A
 2943:    35F1  70 05                           JNZ     EPROM51
 2944:    35F3  12 3B 6B                        LCALL   PM_ROMPROG
 2945:    35F6  80 91                           SJMP    EPROM
 2946:    35F8  12 3B 6B        EPROM51:        LCALL   PM_ROMPROG
 2947:    35FB  80 8C                           SJMP    EPROM
 2948:    35FD  22              EPROMEXIT:      RET
 2949:
 2950:    35FE  31 9C           ROMMENU:        ACALL   PRNTCSTR
 2951:    3600  0E                              DB      0Eh
 2952:    3601  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          3605  2D 2D 2D 2D
          3609  2D 2D 2D 2D
          360D  2D 2D 2D 2D
          3611  2D 2D 2D 2D
          3615  20 20 2D 2D
          3619  2D 2D 2D 2D
          361D  2D 2D 2D 2D
          3621  2D 2D 2D 2D
          3625  2D 2D 2D 20
          3629  20 2D 2D 2D
          362D  2D 2D 2D 2D
          3631  2D 2D 2D 2D
          3635  2D 2D 2D 2D
          3639  2D 2D 0D 0A
 2953:    363D  20 20 20 7C                     DB      '   |  Action       |  |  EEPROM size  |  |  Mode         |',0Dh,0Ah
          3641  20 20 41 63
          3645  74 69 6F 6E
          3649  20 20 20 20
          364D  20 20 20 7C
          3651  20 20 7C 20
          3655  20 45 45 50
          3659  52 4F 4D 20
          365D  73 69 7A 65
          3661  20 20 7C 20
          3665  20 7C 20 20
          3669  4D 6F 64 65
          366D  20 20 20 20
          3671  20 20 20 20
          3675  20 7C 0D 0A
 2954:    3679  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          367D  2D 2D 2D 2D
          3681  2D 2D 2D 2D
          3685  2D 2D 2D 2D
          3689  2D 2D 2D 2D
          368D  20 20 2D 2D
          3691  2D 2D 2D 2D
          3695  2D 2D 2D 2D
          3699  2D 2D 2D 2D
          369D  2D 2D 2D 20
          36A1  20 2D 2D 2D
          36A5  2D 2D 2D 2D
          36A9  2D 2D 2D 2D
          36AD  2D 2D 2D 2D
          36B1  2D 2D 0D 0A
 2955:    36B5  20 20 20 7C                     DB      '   |  Test erased  |  |  4K           |  |  Byte         |',0Dh,0Ah
          36B9  20 20 54 65
          36BD  73 74 20 65
          36C1  72 61 73 65
          36C5  64 20 20 7C
          36C9  20 20 7C 20
          36CD  20 34 4B 20
          36D1  20 20 20 20
          36D5  20 20 20 20
          36D9  20 20 7C 20
          36DD  20 7C 20 20
          36E1  42 79 74 65
          36E5  20 20 20 20
          36E9  20 20 20 20
          36ED  20 7C 0D 0A
 2956:    36F1  20 20 20 7C                     DB      '   |  Filedump     |  |  8K           |  |  Page         |',0Dh,0Ah
          36F5  20 20 46 69
          36F9  6C 65 64 75
          36FD  6D 70 20 20
          3701  20 20 20 7C
          3705  20 20 7C 20
          3709  20 38 4B 20
          370D  20 20 20 20
          3711  20 20 20 20
          3715  20 20 7C 20
          3719  20 7C 20 20
          371D  50 61 67 65
          3721  20 20 20 20
          3725  20 20 20 20
          3729  20 7C 0D 0A
 2957:    372D  20 20 20 7C                     DB      '   |  Screendump   |  |  16K          |  |               |',0Dh,0Ah
          3731  20 20 53 63
          3735  72 65 65 6E
          3739  64 75 6D 70
          373D  20 20 20 7C
          3741  20 20 7C 20
          3745  20 31 36 4B
          3749  20 20 20 20
          374D  20 20 20 20
          3751  20 20 7C 20
          3755  20 7C 20 20
          3759  20 20 20 20
          375D  20 20 20 20
          3761  20 20 20 20
          3765  20 7C 0D 0A
 2958:    3769  20 20 20 7C                     DB      '   |  Verify       |  |  32K          |  |               |',0Dh,0Ah
          376D  20 20 56 65
          3771  72 69 66 79
          3775  20 20 20 20
          3779  20 20 20 7C
          377D  20 20 7C 20
          3781  20 33 32 4B
          3785  20 20 20 20
          3789  20 20 20 20
          378D  20 20 7C 20
          3791  20 7C 20 20
          3795  20 20 20 20
          3799  20 20 20 20
          379D  20 20 20 20
          37A1  20 7C 0D 0A
 2959:    37A5  20 20 20 7C                     DB      '   |  Program      |  |  64K          |  |               |',0Dh,0Ah
          37A9  20 20 50 72
          37AD  6F 67 72 61
          37B1  6D 20 20 20
          37B5  20 20 20 7C
          37B9  20 20 7C 20
          37BD  20 36 34 4B
          37C1  20 20 20 20
          37C5  20 20 20 20
          37C9  20 20 7C 20
          37CD  20 7C 20 20
          37D1  20 20 20 20
          37D5  20 20 20 20
          37D9  20 20 20 20
          37DD  20 7C 0D 0A
 2960:    37E1  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          37E5  2D 2D 2D 2D
          37E9  2D 2D 2D 2D
          37ED  2D 2D 2D 2D
          37F1  2D 2D 2D 2D
          37F5  20 20 2D 2D
          37F9  2D 2D 2D 2D
          37FD  2D 2D 2D 2D
          3801  2D 2D 2D 2D
          3805  2D 2D 2D 20
          3809  20 2D 2D 2D
          380D  2D 2D 2D 2D
          3811  2D 2D 2D 2D
          3815  2D 2D 2D 2D
          3819  2D 2D 0D 0A
 2961:    381D  00                              DB      00h
 2962:    381E  78 54                           MOV     R0,#ROMSIZE
 2963:    3820  11 71                           ACALL   MENUSET
 2964:    3822  08                              INC     R0
 2965:    3823  11 71                           ACALL   MENUSET
 2966:    3825  78 53                           MOV     R0,#ROMACTION
 2967:    3827  11 2A                           ACALL   MENUXP
 2968:    3829  22                              RET
 2969:
 2970:    382A  11 71           MENUXP:         ACALL   MENUSET
 2971:    382C  74 08                           MOV     A,#08h
 2972:    382E  12 32 BC                        LCALL   TXBYTE
 2973:    3831  12 32 A5                        LCALL   RXBYTE
 2974:    3834  B4 9A 0C                        CJNE    A,#9Ah,MENUXP1
 2975:    3837  E6                              MOV     A,@R0
 2976:    3838  14                              DEC     A
 2977:    3839  60 EF                           JZ      MENUXP
 2978:    383B  74 20                           MOV     A,#20h
 2979:    383D  12 32 BC                        LCALL   TXBYTE
 2980:    3840  16                              DEC     @R0
 2981:    3841  80 E7                           SJMP    MENUXP
 2982:    3843  B4 9B 0D        MENUXP1:        CJNE    A,#9Bh,MENUXP2
 2983:    3846  E6                              MOV     A,@R0
 2984:    3847  94 05                           SUBB    A,#05h
 2985:    3849  60 DF                           JZ      MENUXP
 2986:    384B  74 20                           MOV     A,#20h
 2987:    384D  12 32 BC                        LCALL   TXBYTE
 2988:    3850  06                              INC     @R0
 2989:    3851  80 D7                           SJMP    MENUXP
 2990:    3853  B4 9C 08        MENUXP2:        CJNE    A,#9Ch,MENUYP1
 2991:    3856  E8                              MOV     A,R0
 2992:    3857  94 55                           SUBB    A,#ROMMODE
 2993:    3859  60 CF                           JZ      MENUXP
 2994:    385B  08                              INC     R0
 2995:    385C  80 CC                           SJMP    MENUXP
 2996:    385E  B4 9D 08        MENUYP1:        CJNE    A,#9Dh,MENUYP2
 2997:    3861  E8                              MOV     A,R0
 2998:    3862  94 53                           SUBB    A,#ROMACTION
 2999:    3864  60 C4                           JZ      MENUXP
 3000:    3866  18                              DEC     R0
 3001:    3867  80 C1                           SJMP    MENUXP
 3002:    3869  B4 9F 01        MENUYP2:        CJNE    A,#9Fh,MENUYP3                  ;Esc
 3003:    386C  22                              RET
 3004:    386D  B4 94 BA        MENUYP3:        CJNE    A,#94h,MENUXP                   ;Insert
 3005:    3870  22                              RET
 3006:
 3007:    3871  74 0B           MENUSET:        MOV     A,#0Bh
 3008:    3873  12 32 BC                        LCALL   TXBYTE
 3009:    3876  E6                              MOV     A,@R0
 3010:    3877  24 22                           ADD     A,#22h
 3011:    3879  12 32 BC                        LCALL   TXBYTE
 3012:    387C  E8                              MOV     A,R0
 3013:    387D  94 53                           SUBB    A,#ROMACTION
 3014:    387F  75 F0 13                        MOV     B,#13h
 3015:    3882  A4                              MUL     AB
 3016:    3883  24 24                           ADD     A,#24h
 3017:    3885  12 32 BC                        LCALL   TXBYTE
 3018:    3888  74 FB                           MOV     A,#0FBh                         ;
 3019:    388A  12 32 BC                        LCALL   TXBYTE
 3020:    388D  22                              RET
 3021:
 3022:                          ;------------------------------------------------------------------
 3023:
 3024:    388E  12 3C 7E        ROMINSERT:      LCALL   ROMOFF
 3025:    3891  12 31 9C                        LCALL   PRNTCSTR
 3026:    3894  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Insert ',00h
          3898  6E 73 65 72
          389C  74 20 00
 3027:    389F  E5 54                           MOV     A,ROMSIZE
 3028:    38A1  14                              DEC     A
 3029:    38A2  70 09                           JNZ     ROMINSERT1
 3030:    38A4  12 31 9C                        LCALL   PRNTCSTR
 3031:    38A7  34 4B 00                        DB      '4K',00h
 3032:    38AA  75 52 10                        MOV     ROMPAGES,#10h                   ;16 Pages
 3033:    38AD  14              ROMINSERT1:     DEC     A
 3034:    38AE  70 09                           JNZ     ROMINSERT2
 3035:    38B0  12 31 9C                        LCALL   PRNTCSTR
 3036:    38B3  38 4B 00                        DB      '8K',00h
 3037:    38B6  75 52 20                        MOV     ROMPAGES,#20h                   ;32 Pages
 3038:    38B9  14              ROMINSERT2:     DEC     A
 3039:    38BA  70 0A                           JNZ     ROMINSERT3
 3040:    38BC  12 31 9C                        LCALL   PRNTCSTR
 3041:    38BF  31 36 4B 00                     DB      '16K',00h
 3042:    38C3  75 52 40                        MOV     ROMPAGES,#40h                   ;64 Pages
 3043:    38C6  14              ROMINSERT3:     DEC     A
 3044:    38C7  70 0A                           JNZ     ROMINSERT4
 3045:    38C9  12 31 9C                        LCALL   PRNTCSTR
 3046:    38CC  33 32 4B 00                     DB      '32K',00h
 3047:    38D0  75 52 80                        MOV     ROMPAGES,#80h                   ;128 Pages
 3048:    38D3  14              ROMINSERT4:     DEC     A
 3049:    38D4  70 0A                           JNZ     ROMINSERT5
 3050:    38D6  12 31 9C                        LCALL   PRNTCSTR
 3051:    38D9  36 34 4B 00                     DB      '64K',00h
 3052:    38DD  75 52 00                        MOV     ROMPAGES,#00h                   ;256 Pages
 3053:    38E0  12 31 9C        ROMINSERT5:     LCALL   PRNTCSTR
 3054:    38E3  20 64 65 76                     DB      ' device and strike <Enter> ',00h
          38E7  69 63 65 20
          38EB  61 6E 64 20
          38EF  73 74 72 69
          38F3  6B 65 20 3C
          38F7  45 6E 74 65
          38FB  72 3E 20 00
 3055:    38FF  12 32 A5                        LCALL   RXBYTE
 3056:    3902  B4 9F 02                        CJNE    A,#9Fh,ROMINSERT6               ;Esc
 3057:    3905  D3                              SETB    C
 3058:    3906  22                              RET
 3059:    3907  12 31 9C        ROMINSERT6:     LCALL   PRNTCSTR
 3060:    390A  0B 2A 23 20                     DB      0Bh,2Ah,23h,'                                       '
          390E  20 20 20 20
          3912  20 20 20 20
          3916  20 20 20 20
          391A  20 20 20 20
          391E  20 20 20 20
          3922  20 20 20 20
          3926  20 20 20 20
          392A  20 20 20 20
          392E  20 20 20 20
          3932  20 20
 3061:    3934  0D 00                           DB      0Dh,00h
 3062:    3936  C3                              CLR     C
 3063:    3937  22                              RET
 3064:
 3065:    3938  12 31 9C        ROMWAIT:        LCALL   PRNTCSTR
 3066:    393B  0B 2A 23 57                     DB      0Bh,2Ah,23h,'Wait ...',00h
          393F  61 69 74 20
          3943  2E 2E 2E 00
 3067:    3947  22                              RET
 3068:
 3069:
 3070:                          ;Byte mode
 3071:                          ;------------------------------------------------------------------
 3072:
 3073:    3948  12 3C DE        BM_ROMERASED:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3074:    394B  B4 FF 0E                        CJNE    A,#0FFh,BM_ROMERASED1           ;Not erased
 3075:    394E  A3                              INC     DPTR                            ;Next address
 3076:    394F  E5 82                           MOV     A,DPL
 3077:    3951  70 F5                           JNZ     BM_ROMERASED                    ;Jump if more bytes in this page
 3078:    3953  E5 83                           MOV     A,DPH
 3079:    3955  B5 52 F0                        CJNE    A,ROMPAGES,BM_ROMERASED         ;Jump if more pages
 3080:    3958  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3081:    395B  22                              RET
 3082:    395C  12 3C 7E        BM_ROMERASED1:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3083:    395F  12 31 9C                        LCALL   PRNTCSTR
 3084:    3962  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          3966  79 74 65 20
          396A  61 74 20 00
 3085:    396E  E5 83                           MOV     A,DPH
 3086:    3970  12 31 E8                        LCALL   HEXOUT                          ;High address
 3087:    3973  E5 82                           MOV     A,DPL
 3088:    3975  12 31 E8                        LCALL   HEXOUT                          ;Low address
 3089:    3978  12 31 9C                        LCALL   PRNTCSTR
 3090:    397B  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          397F  20 65 72 61
          3983  73 65 64 20
          3987  3C 45 6E 74
          398B  65 72 3E 20
          398F  00
 3091:    3990  12 32 A5                        LCALL   RXBYTE                          ;Wait for keypress
 3092:    3993  22                              RET
 3093:
 3094:    3994  74 03           BM_ROMDUMPF:    MOV     A,#03h
 3095:    3996  12 32 BC                        LCALL   TXBYTE                          ;Init write to file
 3096:    3999  12 3C DE        BM_ROMDUMPF1:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3097:    399C  12 31 E8                        LCALL   HEXOUT                          ;Output as hex
 3098:    399F  74 20                           MOV     A,#20h
 3099:    39A1  12 32 BC                        LCALL   TXBYTE                          ;Output a space
 3100:    39A4  A3                              INC     DPTR
 3101:    39A5  E5 82                           MOV     A,DPL
 3102:    39A7  54 0F                           ANL     A,#0Fh
 3103:    39A9  70 03                           JNZ     BM_ROMDUMPF2                    ;Still on same line
 3104:    39AB  12 31 DF                        LCALL   PRNTCRLF                        ;Output CRLF
 3105:    39AE  E5 82           BM_ROMDUMPF2:   MOV     A,DPL
 3106:    39B0  70 E7                           JNZ     BM_ROMDUMPF1                    ;Jump if more bytes in this page
 3107:    39B2  E5 83                           MOV     A,DPH
 3108:    39B4  B5 52 E2                        CJNE    A,ROMPAGES,BM_ROMDUMPF1         ;Jump if more pages
 3109:    39B7  74 04                           MOV     A,#04h
 3110:    39B9  12 32 BC                        LCALL   TXBYTE                          ;End write to file
 3111:    39BC  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3112:    39BF  22              BM_ROMDUMPF3:   RET
 3113:
 3114:    39C0  12 3C DE        BM_ROMDUMPS:    LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3115:    39C3  12 31 E8                        LCALL   HEXOUT                          ;Output as hex
 3116:    39C6  74 20                           MOV     A,#20h
 3117:    39C8  12 32 BC                        LCALL   TXBYTE                          ;Output a space
 3118:    39CB  A3                              INC     DPTR                            ;Next ROM address
 3119:    39CC  E5 82                           MOV     A,DPL
 3120:    39CE  54 0F                           ANL     A,#0Fh
 3121:    39D0  70 03                           JNZ     BM_ROMDUMPS1                    ;Jump if still on same line
 3122:    39D2  12 31 DF                        LCALL   PRNTCRLF                        ;Output CRLF
 3123:    39D5  E5 82           BM_ROMDUMPS1:   MOV     A,DPL
 3124:    39D7  70 E7                           JNZ     BM_ROMDUMPS                     ;Jump if more bytes in this page
 3125:    39D9  12 31 DF                        LCALL   PRNTCRLF                        ;Output CRLF
 3126:    39DC  12 32 A5                        LCALL   RXBYTE                          ;Wait for a keypress
 3127:    39DF  B4 9F 02                        CJNE    A,#9Fh,BM_ROMDUMPS2
 3128:    39E2  80 05                           SJMP    BM_ROMDUMPS3
 3129:    39E4  E5 83           BM_ROMDUMPS2:   MOV     A,DPH
 3130:    39E6  B5 52 D7                        CJNE    A,ROMPAGES,BM_ROMDUMPS          ;Jump if more pages
 3131:    39E9  12 3C 7E        BM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3132:    39EC  22                              RET
 3133:
 3134:    39ED  C0 00           BM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3135:    39EF  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3136:    39F2  12 32 95                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3137:    39F5  86 51           BM_ROMVERIFY1:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3138:    39F7  12 3C DE                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3139:    39FA  B5 51 1D                        CJNE    A,ROMVER,BM_ROMVERIFY4          ;Compare and jump if not equal
 3140:    39FD  08              BM_ROMVERIFY2:  INC     R0                              ;Increment buffer pointer
 3141:    39FE  E8                              MOV     A,R0
 3142:    39FF  B4 50 03                        CJNE    A,#50h,BM_ROMVERIFY3            ;Jump if not last byte in buffer
 3143:    3A02  12 32 95                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3144:    3A05  A3              BM_ROMVERIFY3:  INC     DPTR                            ;Next ROM address
 3145:    3A06  E5 82                           MOV     A,DPL
 3146:    3A08  70 EB                           JNZ     BM_ROMVERIFY1                   ;Jump if still on same page
 3147:    3A0A  E5 83                           MOV     A,DPH
 3148:    3A0C  B5 52 E6                        CJNE    A,ROMPAGES,BM_ROMVERIFY1        ;Jump if more pages
 3149:    3A0F  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3150:    3A12  74 06                           MOV     A,#06h
 3151:    3A14  12 32 BC                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3152:    3A17  D0 00                           POP     00h                             ;Restore R0
 3153:    3A19  22                              RET
 3154:    3A1A  12 3C F3        BM_ROMVERIFY4:  LCALL   ROMVERIFYERR
 3155:    3A1D  50 DE                           JNC     BM_ROMVERIFY2                   ;Jump if less than 16 errors
 3156:    3A1F  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3157:    3A22  74 06                           MOV     A,#06h
 3158:    3A24  12 32 BC                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3159:    3A27  12 32 A5                        LCALL   RXBYTE                          ;Wait for a keypress
 3160:    3A2A  D0 00                           POP     00h                             ;Restore R0
 3161:    3A2C  22                              RET
 3162:
 3163:                          ;Page mode
 3164:                          ;------------------------------------------------------------------
 3165:
 3166:    3A2D  74 30           PM_ROMERASED:   MOV     A,#30h
 3167:    3A2F  12 3C 56                        LCALL   ISPCOMM                         ;Init read page mode
 3168:    3A32  E5 83                           MOV     A,DPH
 3169:    3A34  12 3C 56                        LCALL   ISPCOMM                         ;Send high address
 3170:    3A37  E4              PM_ROMERASED1:  CLR     A
 3171:    3A38  12 3C 56                        LCALL   ISPCOMM                         ;Get byte from ROM
 3172:    3A3B  B4 FF 0E                        CJNE    A,#0FFh,PM_ROMERASED2           ;Jump if not erased
 3173:    3A3E  A3                              INC     DPTR
 3174:    3A3F  E5 82                           MOV     A,DPL
 3175:    3A41  70 F4                           JNZ     PM_ROMERASED1                   ;Jump if more bytes on this page
 3176:    3A43  E5 83                           MOV     A,DPH
 3177:    3A45  B5 52 E5                        CJNE    A,ROMPAGES,PM_ROMERASED         ;Jump if more pagees
 3178:    3A48  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3179:    3A4B  22                              RET
 3180:    3A4C  12 3C 7E        PM_ROMERASED2:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3181:    3A4F  12 31 9C                        LCALL   PRNTCSTR
 3182:    3A52  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          3A56  79 74 65 20
          3A5A  61 74 20 00
 3183:    3A5E  E5 83                           MOV     A,DPH
 3184:    3A60  12 31 E8                        LCALL   HEXOUT                          ;Output high address as hex
 3185:    3A63  E5 82                           MOV     A,DPL
 3186:    3A65  12 31 E8                        LCALL   HEXOUT                          ;Output low address as hex
 3187:    3A68  12 31 9C                        LCALL   PRNTCSTR
 3188:    3A6B  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          3A6F  20 65 72 61
          3A73  73 65 64 20
          3A77  3C 45 6E 74
          3A7B  65 72 3E 20
          3A7F  00
 3189:    3A80  12 32 A5                        LCALL   RXBYTE                          ;Wait for a keypress
 3190:    3A83  22                              RET
 3191:
 3192:    3A84  74 03           PM_ROMDUMPF:    MOV     A,#03h
 3193:    3A86  12 32 BC                        LCALL   TXBYTE                          ;Init Output to hex file
 3194:    3A89  74 30           PM_ROMDUMPF1:   MOV     A,#30h
 3195:    3A8B  12 3C 56                        LCALL   ISPCOMM                         ;Init read page mode
 3196:    3A8E  E5 83                           MOV     A,DPH
 3197:    3A90  12 3C 56                        LCALL   ISPCOMM                         ;Send high address
 3198:    3A93  E4              PM_ROMDUMPF2:   CLR     A
 3199:    3A94  12 3C 56                        LCALL   ISPCOMM                         ;Get byte from ROM
 3200:    3A97  12 31 E8                        LCALL   HEXOUT                          ;Output as hex
 3201:    3A9A  74 20                           MOV     A,#20h
 3202:    3A9C  12 32 BC                        LCALL   TXBYTE                          ;Output a space
 3203:    3A9F  A3                              INC     DPTR
 3204:    3AA0  E5 82                           MOV     A,DPL
 3205:    3AA2  54 0F                           ANL     A,#0Fh
 3206:    3AA4  B4 00 07                        CJNE    A,#00h,PM_ROMDUMPF3             ;Jump if more bytes in this line
 3207:    3AA7  12 31 DF                        LCALL   PRNTCRLF                        ;Output CRLF
 3208:    3AAA  E5 82                           MOV     A,DPL
 3209:    3AAC  70 E5                           JNZ     PM_ROMDUMPF2                    ;Jump if more bytes in this page
 3210:    3AAE  E5 83           PM_ROMDUMPF3:   MOV     A,DPH
 3211:    3AB0  B5 52 D6                        CJNE    A,ROMPAGES,PM_ROMDUMPF1         ;Jump if more pages
 3212:    3AB3  74 04                           MOV     A,#04h
 3213:    3AB5  12 32 BC                        LCALL   TXBYTE                          ;End Output to hex file
 3214:    3AB8  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3215:    3ABB  22                              RET
 3216:
 3217:    3ABC  74 30           PM_ROMDUMPS:    MOV     A,#30h
 3218:    3ABE  12 3C 56                        LCALL   ISPCOMM                         ;Init read page mode
 3219:    3AC1  E5 83                           MOV     A,DPH
 3220:    3AC3  12 3C 56                        LCALL   ISPCOMM                         ;Send high address
 3221:    3AC6  E4              PM_ROMDUMPS1:   CLR     A
 3222:    3AC7  12 3C 56                        LCALL   ISPCOMM                         ;Get byte from ROM
 3223:    3ACA  12 31 E8                        LCALL   HEXOUT                          ;Output as hex
 3224:    3ACD  74 20                           MOV     A,#20h
 3225:    3ACF  12 32 BC                        LCALL   TXBYTE                          ;Output a space
 3226:    3AD2  A3                              INC     DPTR
 3227:    3AD3  E5 82                           MOV     A,DPL
 3228:    3AD5  54 0F                           ANL     A,#0Fh
 3229:    3AD7  70 12                           JNZ     PM_ROMDUMPS2                    ;Jump if still on same line
 3230:    3AD9  12 31 DF                        LCALL   PRNTCRLF                        ;Output CRLF
 3231:    3ADC  E5 82                           MOV     A,DPL
 3232:    3ADE  70 E6                           JNZ     PM_ROMDUMPS1                    ;Jump if more bytes on this page
 3233:    3AE0  12 31 DF                        LCALL   PRNTCRLF                        ;Output CRLF
 3234:    3AE3  12 32 A5                        LCALL   RXBYTE                          ;Wait for a keypress
 3235:    3AE6  B4 9F 02                        CJNE    A,#9Fh,PM_ROMDUMPS2
 3236:    3AE9  80 05                           SJMP    PM_ROMDUMPS3                    ;Esc pressed
 3237:    3AEB  E5 83           PM_ROMDUMPS2:   MOV     A,DPH
 3238:    3AED  B5 52 CC                        CJNE    A,ROMPAGES,PM_ROMDUMPS          ;Jump if more pages
 3239:    3AF0  12 3C 7E        PM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3240:    3AF3  22                              RET
 3241:
 3242:    3AF4  C0 00           PM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3243:    3AF6  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3244:    3AF9  12 32 95                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3245:    3AFC  74 30           PM_ROMVERIFY1:  MOV     A,#30h
 3246:    3AFE  12 3C 56                        LCALL   ISPCOMM                         ;Init read page mode
 3247:    3B01  E5 83                           MOV     A,DPH
 3248:    3B03  12 3C 56                        LCALL   ISPCOMM                         ;Send high address
 3249:    3B06  86 51           PM_ROMVERIFY2:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3250:    3B08  E4                              CLR     A
 3251:    3B09  12 3C 56                        LCALL   ISPCOMM                         ;Get byte from ROM
 3252:    3B0C  B5 51 1D                        CJNE    A,ROMVER,PM_ROMVERIFY5          ;Compare and jump if not equal
 3253:    3B0F  08              PM_ROMVERIFY3:  INC     R0                              ;Increment buffer pointer
 3254:    3B10  E8                              MOV     A,R0
 3255:    3B11  B4 50 03                        CJNE    A,#50h,PM_ROMVERIFY4            ;Jump if not last byte in buffer
 3256:    3B14  12 32 95                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3257:    3B17  A3              PM_ROMVERIFY4:  INC     DPTR
 3258:    3B18  E5 82                           MOV     A,DPL
 3259:    3B1A  70 EA                           JNZ     PM_ROMVERIFY2                   ;Jump if still on same page
 3260:    3B1C  E5 83                           MOV     A,DPH
 3261:    3B1E  B5 52 DB                        CJNE    A,ROMPAGES,PM_ROMVERIFY1        ;Jump if more pages
 3262:    3B21  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3263:    3B24  74 06                           MOV     A,#06h
 3264:    3B26  12 32 BC                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3265:    3B29  D0 00                           POP     00h                             ;Restore R0
 3266:    3B2B  22                              RET
 3267:    3B2C  12 3C F3        PM_ROMVERIFY5:  LCALL   ROMVERIFYERR
 3268:    3B2F  50 DE                           JNC     PM_ROMVERIFY3                   ;Jump if less than 16 errors
 3269:    3B31  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3270:    3B34  74 06                           MOV     A,#06h
 3271:    3B36  12 32 BC                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3272:    3B39  12 32 A5                        LCALL   RXBYTE                          ;Wait for keypress
 3273:    3B3C  D0 00                           POP     00h                             ;Restore R0
 3274:    3B3E  22                              RET
 3275:
 3276:    3B3F  90 00 00        PM_ISERASED:    MOV     DPTR,#0000h
 3277:    3B42  75 56 00                        MOV     ROMVERERR,#00h
 3278:    3B45  74 30           PM_ISERASED1:   MOV     A,#30h
 3279:    3B47  12 3C 56                        LCALL   ISPCOMM                         ;Init read page mode
 3280:    3B4A  E5 83                           MOV     A,DPH
 3281:    3B4C  12 3C 56                        LCALL   ISPCOMM                         ;Send high address
 3282:    3B4F  E4              PM_ISERASED2:   CLR     A
 3283:    3B50  12 3C 56                        LCALL   ISPCOMM                         ;Get byte from ROM
 3284:    3B53  04                              INC     A
 3285:    3B54  42 56                           ORL     ROMVERERR,A
 3286:    3B56  A3                              INC     DPTR
 3287:    3B57  E5 82                           MOV     A,DPL
 3288:    3B59  70 F4                           JNZ     PM_ISERASED2                    ;Jump if more bytes on this page
 3289:    3B5B  E5 56                           MOV     A,ROMVERERR
 3290:    3B5D  70 05                           JNZ     PM_ISERASED3
 3291:    3B5F  E5 83                           MOV     A,DPH
 3292:    3B61  B5 52 E1                        CJNE    A,ROMPAGES,PM_ISERASED1         ;Jump if more pagees
 3293:    3B64  C3              PM_ISERASED3:   CLR     C
 3294:    3B65  E5 56                           MOV     A,ROMVERERR
 3295:    3B67  60 01                           JZ      PM_ISERASED4
 3296:    3B69  D3                              SETB    C
 3297:    3B6A  22              PM_ISERASED4:   RET
 3298:
 3299:    3B6B  12 3B 3F        PM_ROMPROG:     LCALL   PM_ISERASED                     ;Check if chip is erased
 3300:    3B6E  50 4E                           JNC     PM_ROMPROG1
 3301:    3B70  74 AC                           MOV     A,#0ACh
 3302:    3B72  12 3C 56                        LCALL   ISPCOMM                         ;Init chip erase byte 1
 3303:    3B75  74 80                           MOV     A,#80h
 3304:    3B77  12 3C 56                        LCALL   ISPCOMM                         ;Init chip erase byte 2
 3305:    3B7A  E4                              CLR     A
 3306:    3B7B  12 3C 56                        LCALL   ISPCOMM                         ;Init chip erase byte 3
 3307:    3B7E  E4                              CLR     A
 3308:    3B7F  12 3C 56                        LCALL   ISPCOMM                         ;Init chip erase byte 4
 3309:    3B82  E4                              CLR     A
 3310:    3B83  12 3C 4F                        LCALL   WAIT                            ;Wait 256 ms
 3311:    3B86  E4                              CLR     A
 3312:    3B87  12 3C 4F                        LCALL   WAIT                            ;Wait 256 ms
 3313:    3B8A  E4                              CLR     A
 3314:    3B8B  12 3C 4F                        LCALL   WAIT                            ;Wait 256 ms
 3315:    3B8E  12 3B 3F                        LCALL   PM_ISERASED
 3316:    3B91  50 2B                           JNC     PM_ROMPROG1
 3317:    3B93  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3318:    3B96  12 31 9C                        LCALL   PRNTCSTR
 3319:    3B99  0B 2A 23 43                     DB      0Bh,2Ah,23h,'Could not erase chip <Enter> ',00h
          3B9D  6F 75 6C 64
          3BA1  20 6E 6F 74
          3BA5  20 65 72 61
          3BA9  73 65 20 63
          3BAD  68 69 70 20
          3BB1  3C 45 6E 74
          3BB5  65 72 3E 20
          3BB9  00
 3320:    3BBA  12 32 A5                        LCALL   RXBYTE                          ;Wait for keypress
 3321:    3BBD  22                              RET
 3322:    3BBE  C0 00           PM_ROMPROG1:    PUSH    00h
 3323:    3BC0  90 00 00                        MOV     DPTR,#0000h
 3324:    3BC3  12 32 95                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3325:    3BC6  74 40           PM_ROMPROG2:    MOV     A,#40h
 3326:    3BC8  12 3C 56                        LCALL   ISPCOMM                         ;Init byte programming mode
 3327:    3BCB  E5 83                           MOV     A,DPH
 3328:    3BCD  12 3C 56                        LCALL   ISPCOMM                         ;Send high address
 3329:    3BD0  E5 82                           MOV     A,DPL
 3330:    3BD2  12 3C 56                        LCALL   ISPCOMM                         ;Send low address
 3331:    3BD5  E6                              MOV     A,@R0                           ;Get byte from buffer
 3332:    3BD6  F5 51                           MOV     ROMVER,A
 3333:    3BD8  12 3C 56                        LCALL   ISPCOMM                         ;Send byte to be programmed
 3334:    3BDB  74 10                           MOV     A,#10h
 3335:    3BDD  12 3C 4F                        LCALL   WAIT                            ;Wait 1mS
 3336:    3BE0  12 3C DE                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3337:    3BE3  B5 51 22                        CJNE    A,ROMVER,PM_ROMPROG4            ;Compare and jump if not equal
 3338:    3BE6  08                              INC     R0
 3339:    3BE7  E8                              MOV     A,R0
 3340:    3BE8  B4 50 03                        CJNE    A,#50h,PM_ROMPROG3
 3341:    3BEB  12 32 95                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3342:    3BEE  A3              PM_ROMPROG3:    INC     DPTR
 3343:    3BEF  E5 82                           MOV     A,DPL
 3344:    3BF1  70 D3                           JNZ     PM_ROMPROG2                     ;Jump if still on same page
 3345:    3BF3  74 2E                           MOV     A,#2Eh
 3346:    3BF5  12 32 BC                        LCALL   TXBYTE
 3347:    3BF8  E5 83                           MOV     A,DPH
 3348:    3BFA  B5 52 C9                        CJNE    A,ROMPAGES,PM_ROMPROG2          ;Jump if more pages
 3349:    3BFD  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3350:    3C00  74 06                           MOV     A,#06h
 3351:    3C02  12 32 BC                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3352:    3C05  D0 00                           POP     00h
 3353:    3C07  22                              RET
 3354:    3C08  C0 E0           PM_ROMPROG4:    PUSH    ACC
 3355:    3C0A  12 3C 7E                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3356:    3C0D  74 06                           MOV     A,#06h
 3357:    3C0F  12 32 BC                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3358:    3C12  12 31 9C                        LCALL   PRNTCSTR
 3359:    3C15  0B 2A 23 45                     DB      0Bh,2Ah,23h,'Error at ',00h
          3C19  72 72 6F 72
          3C1D  20 61 74 20
          3C21  00
 3360:    3C22  E5 83                           MOV     A,DPH
 3361:    3C24  12 31 E8                        LCALL   HEXOUT                          ;High address
 3362:    3C27  E5 82                           MOV     A,DPL
 3363:    3C29  12 31 E8                        LCALL   HEXOUT                          ;Low address
 3364:    3C2C  74 20                           MOV     A,#20h
 3365:    3C2E  12 32 BC                        LCALL   TXBYTE
 3366:    3C31  E5 51                           MOV     A,ROMVER                        ;Byte from .cmd file
 3367:    3C33  12 31 E8                        LCALL   HEXOUT
 3368:    3C36  74 20                           MOV     A,#20h
 3369:    3C38  12 32 BC                        LCALL   TXBYTE
 3370:    3C3B  D0 E0                           POP     ACC
 3371:    3C3D  12 31 E8                        LCALL   HEXOUT                          ;Byte read from ROM
 3372:    3C40  12 32 A5                        LCALL   RXBYTE                          ;Wait for a keypress
 3373:    3C43  D0 00                           POP     00h                             ;Restore R0
 3374:    3C45  22                              RET
 3375:
 3376:                          ;Wait functions
 3377:                          ;------------------------------------------------------------------
 3378:
 3379:    3C46  C0 07           WAIT100:        PUSH    07h                             ;Save R7
 3380:    3C48  7F 64                           MOV     R7,#64h
 3381:    3C4A  DF FE           WAIT1001:       DJNZ    R7,WAIT1001                     ;Wait loop, 100uS
 3382:    3C4C  D0 07                           POP     07h                             ;Restore R7
 3383:    3C4E  22                              RET
 3384:
 3385:    3C4F  CF              WAIT:           XCH     A,R7
 3386:    3C50  91 46           WAIT1:          ACALL   WAIT100
 3387:    3C52  DF FC                           DJNZ    R7,WAIT1
 3388:    3C54  CF                              XCH     A,R7
 3389:    3C55  22                              RET
 3390:
 3391:                          ;Control functions
 3392:                          ;------------------------------------------------------------------
 3393:
 3394:                          ;IN A, OUT A
 3395:    3C56  C0 07           ISPCOMM:        PUSH    07h
 3396:    3C58  C0 02                           PUSH    02h
 3397:    3C5A  7A 08                           MOV     R2,#08h
 3398:    3C5C  33              ISPCOMM1:       RLC     A
 3399:    3C5D  92 93                           MOV     P1.3,C                          ;MISO
 3400:    3C5F  A2 94                           MOV     C,P1.4                          ;MOSI
 3401:    3C61  CF                              XCH     A,R7
 3402:    3C62  33                              RLC     A
 3403:    3C63  CF                              XCH     A,R7
 3404:    3C64  D2 92                           SETB    P1.2                            ;SCK H
 3405:    3C66  00                              NOP
 3406:    3C67  C2 92                           CLR     P1.2                            ;SCK L
 3407:    3C69  DA F1                           DJNZ    R2,ISPCOMM1
 3408:    3C6B  EF                              MOV     A,R7
 3409:    3C6C  D0 02                           POP     02
 3410:    3C6E  D0 07                           POP     07
 3411:    3C70  22                              RET
 3412:
 3413:    3C71  D2 90           ROMON:          SETB    P1.0                            ;+5V On
 3414:    3C73  74 0A                           MOV     A,#0Ah
 3415:    3C75  91 4F                           ACALL   WAIT                            ;Wait 1mS
 3416:    3C77  D2 91                           SETB    P1.1                            ;RST H
 3417:    3C79  74 0A                           MOV     A,#0Ah
 3418:    3C7B  91 4F                           ACALL   WAIT                            ;Wait 1mS
 3419:    3C7D  22                              RET
 3420:
 3421:    3C7E  C2 91           ROMOFF:         CLR     P1.1                            ;RST L
 3422:    3C80  74 01                           MOV     A,#01h
 3423:    3C82  91 4F                           ACALL   WAIT                            ;Wait 100uS
 3424:    3C84  75 90 10                        MOV     P1,#10h                         ;+5V Off, P1.4 As Input
 3425:    3C87  74 0A                           MOV     A,#0Ah
 3426:    3C89  12 3C 4F                        LCALL   WAIT                            ;Wait 1mS
 3427:    3C8C  22                              RET
 3428:
 3429:    3C8D  74 AC           ROMINITPGM:     MOV     A,#0ACh
 3430:    3C8F  12 3C 56                        LCALL   ISPCOMM
 3431:    3C92  74 53                           MOV     A,#53h
 3432:    3C94  12 3C 56                        LCALL   ISPCOMM
 3433:    3C97  74 00                           MOV     A,#00h
 3434:    3C99  12 3C 56                        LCALL   ISPCOMM
 3435:    3C9C  74 00                           MOV     A,#00h
 3436:    3C9E  12 3C 56                        LCALL   ISPCOMM
 3437:    3CA1  B4 69 01                        CJNE    A,#69h,ROMINITPGM1
 3438:    3CA4  22                              RET
 3439:    3CA5  12 31 9C        ROMINITPGM1:    LCALL   PRNTCSTR
 3440:    3CA8  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Initialisation Error <Enter> ',00h
          3CAC  6E 69 74 69
          3CB0  61 6C 69 73
          3CB4  61 74 69 6F
          3CB8  6E 20 45 72
          3CBC  72 6F 72 20
          3CC0  3C 45 6E 74
          3CC4  65 72 3E 20
          3CC8  00
 3441:    3CC9  12 32 A5                        LCALL   RXBYTE
 3442:    3CCC  D3                              SETB    C
 3443:    3CCD  22                              RET
 3444:
 3445:    3CCE  90 00 00        ROMINIT:        MOV     DPTR,#0000h                     ;DPTR holds ROM address
 3446:    3CD1  12 3C 71                        LCALL   ROMON                           ;Turn on VCC and pull RST high
 3447:    3CD4  12 3C 8D                        LCALL   ROMINITPGM
 3448:    3CD7  50 04                           JNC     ROMINIT1
 3449:    3CD9  12 3C 7E                        LCALL   ROMOFF                          ;Init programming failed
 3450:    3CDC  D3                              SETB    C
 3451:    3CDD  22              ROMINIT1:       RET
 3452:
 3453:    3CDE  74 20           BM_ROMRDBYTE:   MOV     A,#20h
 3454:    3CE0  12 3C 56                        LCALL   ISPCOMM
 3455:    3CE3  E5 83                           MOV     A,DPH
 3456:    3CE5  12 3C 56                        LCALL   ISPCOMM
 3457:    3CE8  E5 82                           MOV     A,DPL
 3458:    3CEA  12 3C 56                        LCALL   ISPCOMM
 3459:    3CED  74 00                           MOV     A,#00h
 3460:    3CEF  12 3C 56                        LCALL   ISPCOMM
 3461:    3CF2  22                              RET
 3462:
 3463:    3CF3  C0 E0           ROMVERIFYERR:   PUSH    ACC
 3464:    3CF5  12 31 9C                        LCALL   PRNTCSTR
 3465:    3CF8  0D 20 20 20                     DB      0Dh,'   Error at ',00h
          3CFC  45 72 72 6F
          3D00  72 20 61 74
          3D04  20 00
 3466:    3D06  E5 83                           MOV     A,DPH
 3467:    3D08  12 31 E8                        LCALL   HEXOUT
 3468:    3D0B  E5 82                           MOV     A,DPL
 3469:    3D0D  12 31 E8                        LCALL   HEXOUT
 3470:    3D10  74 20                           MOV     A,#20h
 3471:    3D12  12 32 BC                        LCALL   TXBYTE
 3472:    3D15  E5 51                           MOV     A,ROMVER
 3473:    3D17  12 31 E8                        LCALL   HEXOUT
 3474:    3D1A  74 20                           MOV     A,#20h
 3475:    3D1C  12 32 BC                        LCALL   TXBYTE
 3476:    3D1F  D0 E0                           POP     ACC
 3477:    3D21  12 31 E8                        LCALL   HEXOUT
 3478:    3D24  12 31 DF                        LCALL   PRNTCRLF
 3479:    3D27  05 56                           INC     ROMVERERR
 3480:    3D29  E5 56                           MOV     A,ROMVERERR
 3481:    3D2B  B4 10 00                        CJNE    A,#10h,ROMVERIFYERR1
 3482:    3D2E  B3              ROMVERIFYERR1:  CPL     C
 3483:    3D2F  22                              RET
 3484:
 3485:                          ;LCD Output.
 3486:                          ;-----------------------------------------------------
 3487:    3D30  C0 07           LCDDELAY:       PUSH    07h
 3488:    3D32  7F 00                           MOV     R7,#00h
 3489:    3D34  DF FE                           DJNZ    R7,$
 3490:    3D36  D0 07                           POP     07h
 3491:    3D38  22                              RET
 3492:
 3493:                          ;A contains nibble
 3494:    3D39  C2 E5           LCDNIBOUT:      CLR     ACC.5                           ;
 3495:    3D3B  F0                              MOVX    @DPTR,A                         ;
 3496:    3D3C  D2 E5                           SETB    ACC.5                           ;E
 3497:    3D3E  F0                              MOVX    @DPTR,A                         ;
 3498:    3D3F  C2 E5                           CLR     ACC.5                           ;Negative edge on E
 3499:    3D41  F0                              MOVX    @DPTR,A                         ;
 3500:    3D42  22                              RET
 3501:
 3502:                          ;A contains byte
 3503:    3D43  C0 E0           LCDCMDOUT:      PUSH    ACC
 3504:    3D45  C4                              SWAP    A                               ;High nibble first
 3505:    3D46  54 0F                           ANL     A,#0Fh
 3506:    3D48  B1 39                           ACALL   LCDNIBOUT
 3507:    3D4A  D0 E0                           POP     ACC
 3508:    3D4C  54 0F                           ANL     A,#0Fh
 3509:    3D4E  B1 39                           ACALL   LCDNIBOUT
 3510:    3D50  B1 30                           ACALL   LCDDELAY                        ;Wait for BF to clear
 3511:    3D52  22                              RET
 3512:
 3513:                          ;A contains byte
 3514:    3D53  C0 82           LCDCHROUT:      PUSH    DPL
 3515:    3D55  C0 83                           PUSH    DPH
 3516:    3D57  90 80 00                        MOV     DPTR,#8000h
 3517:    3D5A  C0 E0                           PUSH    ACC
 3518:    3D5C  C4                              SWAP    A                               ;High nibble first
 3519:    3D5D  54 0F                           ANL     A,#0Fh
 3520:    3D5F  D2 E4                           SETB    ACC.4                           ;RS
 3521:    3D61  B1 39                           ACALL   LCDNIBOUT
 3522:    3D63  D0 E0                           POP     ACC
 3523:    3D65  54 0F                           ANL     A,#0Fh
 3524:    3D67  D2 E4                           SETB    ACC.4                           ;RS
 3525:    3D69  B1 39                           ACALL   LCDNIBOUT
 3526:    3D6B  B1 30                           ACALL   LCDDELAY                        ;Wait for BF to clear
 3527:    3D6D  D0 83                           POP     DPH
 3528:    3D6F  D0 82                           POP     DPL
 3529:    3D71  22                              RET
 3530:
 3531:    3D72  C0 82           LCDINIT:        PUSH    DPL
 3532:    3D74  C0 83                           PUSH    DPH
 3533:    3D76  90 80 00                        MOV     DPTR,#8000h
 3534:                                          ;Function set
 3535:    3D79  74 02                           MOV     A,#00000010b
 3536:    3D7B  B1 39                           ACALL   LCDNIBOUT
 3537:    3D7D  74 20                           MOV     A,#00100000b
 3538:    3D7F  B1 43                           ACALL   LCDCMDOUT
 3539:                                          ;Display ON/OFF
 3540:    3D81  74 0F                           MOV     A,#00001111b
 3541:    3D83  B1 43                           ACALL   LCDCMDOUT
 3542:                                          ;Clear
 3543:    3D85  74 01                           MOV     A,#00000001b
 3544:    3D87  B1 43                           ACALL   LCDCMDOUT
 3545:                                          ;Cursor direction
 3546:    3D89  74 06                           MOV     A,#00000110b
 3547:    3D8B  B1 43                           ACALL   LCDCMDOUT
 3548:    3D8D  D0 83                           POP     DPH
 3549:    3D8F  D0 82                           POP     DPL
 3550:    3D91  22                              RET
 3551:
 3552:                          ;Wait loop. Waits 1 second
 3553:                          ;-----------------------------------------------------
 3554:    3D92  7F F8           WAITASEC:       MOV     R7,#0F8h
 3555:    3D94  7E 33                           MOV     R6,#51
 3556:    3D96  7D 10                           MOV     R5,#16
 3557:    3D98  DF FE           WAITASEC1:      DJNZ    R7,WAITASEC1
 3558:    3D9A  DE FC                           DJNZ    R6,WAITASEC1
 3559:    3D9C  DD FA                           DJNZ    R5,WAITASEC1
 3560:    3D9E  00                              NOP
 3561:    3D9F  22                              RET
 3562:
 3563:                          ;Frequency counter. LSB from 74LS393 read at 8001h, TL0, TH0, TF0 bit. 25 bits, max 33554431 Hz
 3564:                          ;IN;    A holds channel (0 to 3). ACC.7 FRQ TTL Active high
 3565:                          ;OUT:   32 Bit result in R7:R6:R5:R4
 3566:                          ;------------------------------------------------------------------
 3567:    3DA0  45 7C           FRQCOUNT:       ORL     A,7Ch                           ;D0,D1  CHANNEL (0-3)
 3568:                                                                                  ;D2     FRQ     Gate active low
 3569:                                                                                  ;D3     FRQ     Reset active high
 3570:                                                                                  ;D4     ADC     CS Active low
 3571:                                                                                  ;D5     ADC     CLK High to Low transition
 3572:                                                                                  ;D6     ADC     DIN
 3573:                                                                                  ;D7     FRQ TTL  Active high
 3574:    3DA2  90 80 01                        MOV     DPTR,#8001h
 3575:    3DA5  F0                              MOVX    @DPTR,A                         ;Reset and gate off
 3576:    3DA6  C0 E0                           PUSH    ACC
 3577:    3DA8  75 8A 00                        MOV     TL0,#00h
 3578:    3DAB  75 8C 00                        MOV     TH0,#00h
 3579:    3DAE  E5 89                           MOV     A,TMOD
 3580:    3DB0  D2 E0                           SETB    ACC.0                           ;M00
 3581:    3DB2  C2 E1                           CLR     ACC.1                           ;M01
 3582:    3DB4  D2 E2                           SETB    ACC.2                           ;C/T0#
 3583:    3DB6  C2 E3                           CLR     ACC.3                           ;GATE0
 3584:    3DB8  F5 89                           MOV     TMOD,A
 3585:    3DBA  E5 88                           MOV     A,TCON
 3586:    3DBC  D2 E4                           SETB    ACC.4                           ;TR0
 3587:    3DBE  C2 E5                           CLR     ACC.5                           ;TF0
 3588:    3DC0  F5 88                           MOV     TCON,A
 3589:    3DC2  D0 E0                           POP     ACC
 3590:    3DC4  55 F3                           ANL     A,0F3h                          ;D2     FRQ Gate active low
 3591:                                                                                  ;D3     FRQ Reset active high
 3592:    3DC6  F0                              MOVX    @DPTR,A                         ;Gate on(low),Reset inactive (low)
 3593:    3DC7  B1 92                           ACALL   WAITASEC
 3594:    3DC9  D2 E2                           SETB    ACC.2                           ;D2     FRQ Gate active low
 3595:    3DCB  F0                              MOVX    @DPTR,A                         ;Stop counting
 3596:    3DCC  E0                              MOVX    A,@DPTR
 3597:    3DCD  FC                              MOV     R4,A
 3598:    3DCE  E5 8A                           MOV     A,TL0
 3599:    3DD0  FD                              MOV     R5,A
 3600:    3DD1  E5 8C                           MOV     A,TH0
 3601:    3DD3  FE                              MOV     R6,A
 3602:    3DD4  E4                              CLR     A                               ;TF0 Is the 25th bit
 3603:    3DD5  A2 8D                           MOV     C,TF0
 3604:    3DD7  33                              RLC     A
 3605:    3DD8  FF                              MOV     R7,A
 3606:    3DD9  22                              RET
 3607:
 3608:                          ;Format frequency conter text line
 3609:                          ;IN:    A holds channel (0 to 3)
 3610:                          ;       LCDLINE+4 Decimal result
 3611:                          ;       R7 Number of digits
 3612:                          ;OUT:   Formatted LCDLINE
 3613:    3DDA  75 40 43        FRQFORMAT:      MOV     LCDLINE,#'C'
 3614:    3DDD  75 41 48                        MOV     LCDLINE+1,#'H'
 3615:    3DE0  44 30                           ORL     A,#30h
 3616:    3DE2  F5 42                           MOV     LCDLINE+2,A
 3617:    3DE4  75 43 20                        MOV     LCDLINE+3,#' '
 3618:    3DE7  78 44                           MOV     R0,#LCDLINE+4
 3619:    3DE9  79 46                           MOV     R1,#LCDLINE+6
 3620:    3DEB  BF 07 00                        CJNE    R7,#07h,$+3
 3621:    3DEE  40 19                           JC      FRQFORMATKHZ
 3622:                                          ;MHz
 3623:    3DF0  7F 08                           MOV     R7,#08h
 3624:    3DF2  E7              FRQFORMATMHZ1:  MOV     A,@R1
 3625:    3DF3  BF 06 03                        CJNE    R7,#06h,FRQFORMATMHZ2
 3626:    3DF6  76 2E                           MOV     @R0,#'.'
 3627:    3DF8  08                              INC     R0
 3628:    3DF9  F6              FRQFORMATMHZ2:  MOV     @R0,A
 3629:    3DFA  08                              INC     R0
 3630:    3DFB  09                              INC     R1
 3631:    3DFC  DF F4                           DJNZ    R7,FRQFORMATMHZ1
 3632:    3DFE  75 4D 4D                        MOV     LCDLINE+13,#'M'
 3633:    3E01  75 4E 48                        MOV     LCDLINE+14,#'H'
 3634:    3E04  75 4F 7A                        MOV     LCDLINE+15,#'z'
 3635:    3E07  80 33                           SJMP    FRQFORMATDONE
 3636:    3E09  BF 04 00        FRQFORMATKHZ:   CJNE    R7,#04h,$+3
 3637:    3E0C  40 19                           JC      FRQFORMATHZ
 3638:                                          ;KHz
 3639:    3E0E  7F 08                           MOV     R7,#08h
 3640:    3E10  E7              FRQFORMATKHZ1:  MOV     A,@R1
 3641:    3E11  BF 03 03                        CJNE    R7,#03h,FRQFORMATKHZ2
 3642:    3E14  76 2E                           MOV     @R0,#'.'
 3643:    3E16  08                              INC     R0
 3644:    3E17  F6              FRQFORMATKHZ2:  MOV     @R0,A
 3645:    3E18  08                              INC     R0
 3646:    3E19  09                              INC     R1
 3647:    3E1A  DF F4                           DJNZ    R7,FRQFORMATKHZ1
 3648:    3E1C  75 4D 4B                        MOV     LCDLINE+13,#'K'
 3649:    3E1F  75 4E 48                        MOV     LCDLINE+14,#'H'
 3650:    3E22  75 4F 7A                        MOV     LCDLINE+15,#'z'
 3651:    3E25  80 15                           SJMP    FRQFORMATDONE
 3652:    3E27                  FRQFORMATHZ:    ;Hz
 3653:    3E27  75 44 20                        MOV     LCDLINE+4,#' '
 3654:    3E2A  08                              INC     R0
 3655:    3E2B  7F 08                           MOV     R7,#08h
 3656:    3E2D  E7              FRQFORMATHZ1:   MOV     A,@R1
 3657:    3E2E  F6                              MOV     @R0,A
 3658:    3E2F  08                              INC     R0
 3659:    3E30  09                              INC     R1
 3660:    3E31  DF FA                           DJNZ    R7,FRQFORMATHZ1
 3661:    3E33  75 4D 48                        MOV     LCDLINE+13,#'H'
 3662:    3E36  75 4E 7A                        MOV     LCDLINE+14,#'z'
 3663:    3E39  75 4F 20                        MOV     LCDLINE+15,#' '
 3664:    3E3C  22              FRQFORMATDONE:  RET
 3665:
 3666:                          ;AD Converter.
 3667:                          ;IN:    A holds channel (0 to 7).
 3668:                          ;OUT:   R2:R0 Holds 16 Bit result
 3669:                          ;-----------------------------------------------------
 3670:    3E3D  45 18           ADCONVERT:      ORL     A,18h                           ;START, SINGLE ENDED
 3671:    3E3F  23                              RL      A
 3672:    3E40  23                              RL      A
 3673:    3E41  23                              RL      A
 3674:    3E42  FA                              MOV     R2,A
 3675:    3E43  E5 7C                           MOV     A,7Ch                           ;D0,D1 FRQ SEL
 3676:                                                                                  ;D2 FRQ GATE    ACTIVE LOW
 3677:                                                                                  ;D3 FRQ RESET   ACTIVE HIGH
 3678:                                                                                  ;D4 ADC CS      ACTIVE LOW
 3679:                                                                                  ;D5 ADC CLK     HIGH TO LOW TRANSITION
 3680:                                                                                  ;D6 ADC DIN     START,S/D,D2,D1,D0
 3681:                                                                                  ;D7 FRQ TTL     ACTIVE HIGH
 3682:    3E45  90 80 01                        MOV     DPTR,#8001h
 3683:    3E48  F0                              MOVX    @DPTR,A
 3684:                                          ;CS low
 3685:    3E49  C2 E4                           CLR     ACC.4                           ;D4 ADC CS      ACTIVE LOW
 3686:    3E4B  F0                              MOVX    @DPTR,A
 3687:                                          ;Clock in channel select and Single/Diff+2 clocks for sample
 3688:    3E4C  7F 07                           MOV     R7,#07h
 3689:    3E4E  CA              ADCONVERT1:     XCH     A,R2
 3690:    3E4F  33                              RLC     A
 3691:    3E50  CA                              XCH     A,R2
 3692:    3E51  92 E6                           MOV     ACC.6,C ;ADC DIN
 3693:    3E53  C2 E5                           CLR     ACC.5
 3694:    3E55  F0                              MOVX    @DPTR,A
 3695:    3E56  D2 E5                           SETB    ACC.5
 3696:    3E58  F0                              MOVX    @DPTR,A
 3697:    3E59  DF F3                           DJNZ    R7,ADCONVERT1
 3698:    3E5B  7A 00                           MOV     R2,#00h
 3699:                                          ;Clock in 5 bits, including null bit
 3700:    3E5D  7F 05                           MOV     R7,#05h
 3701:    3E5F  C0 E0           ADCONVERT2:     PUSH    ACC
 3702:    3E61  90 80 00                        MOV     DPTR,#8000h
 3703:    3E64  E0                              MOVX    A,@DPTR
 3704:    3E65  13                              RRC     A
 3705:    3E66  CA                              XCH     A,R2
 3706:    3E67  33                              RLC     A
 3707:    3E68  CA                              XCH     A,R2
 3708:    3E69  90 80 01                        MOV     DPTR,#8001h
 3709:    3E6C  D0 E0                           POP     ACC
 3710:    3E6E  C2 E5                           CLR     ACC.5
 3711:    3E70  F0                              MOVX    @DPTR,A
 3712:    3E71  D2 E5                           SETB    ACC.5
 3713:    3E73  F0                              MOVX    @DPTR,A
 3714:    3E74  DF E9                           DJNZ    R7,ADCONVERT2
 3715:    3E76  78 00                           MOV     R0,#00h
 3716:                                          ;Clock in 8 bits
 3717:    3E78  7F 08                           MOV     R7,#08h
 3718:    3E7A  C0 E0           ADCONVERT3:     PUSH    ACC
 3719:    3E7C  90 80 00                        MOV     DPTR,#8000h
 3720:    3E7F  E0                              MOVX    A,@DPTR
 3721:    3E80  13                              RRC     A
 3722:    3E81  C8                              XCH     A,R0
 3723:    3E82  33                              RLC     A
 3724:    3E83  C8                              XCH     A,R0
 3725:    3E84  90 80 01                        MOV     DPTR,#8001h
 3726:    3E87  D0 E0                           POP     ACC
 3727:    3E89  C2 E5                           CLR     ACC.5
 3728:    3E8B  F0                              MOVX    @DPTR,A
 3729:    3E8C  D2 E5                           SETB    ACC.5
 3730:    3E8E  F0                              MOVX    @DPTR,A
 3731:    3E8F  DF E9                           DJNZ    R7,ADCONVERT3
 3732:    3E91  22                              RET
 3733:
 3734:                          ;AD Converter output
 3735:                          ;IN:    A holds channel (0 to 7).
 3736:                          ;       R2:R0 adc result
 3737:                          ;       R1 pointer to buffer
 3738:                          ;OUT:   6 Characters
 3739:                          ;-----------------------------------------------------
 3740:    3E92  89 50           ADOUTPUT:       MOV     FPCHR_OUT,R1
 3741:    3E94  C0 E0                           PUSH    ACC
 3742:                                          ;Convert 16 bit integer in R2:R0 to float and push it to fp arg stack
 3743:    3E96  12 23 BF                        LCALL   PUSHR2R0
 3744:                                          ;Push the channelS constant to fp arg stack
 3745:    3E99  90 28 89                        MOV     DPTR,#ADCMUL
 3746:    3E9C  D0 E0                           POP     ACC
 3747:    3E9E  75 F0 06                        MOV     B,#FP_NUMBER_SIZE
 3748:    3EA1  A4                              MUL     AB
 3749:    3EA2  25 82                           ADD     A,DPL
 3750:    3EA4  F5 82                           MOV     DPL,A
 3751:    3EA6  50 02                           JNC     ADOUTPUT1
 3752:    3EA8  05 83                           INC     DPH
 3753:    3EAA  12 27 3B        ADOUTPUT1:      LCALL   PUSHC
 3754:                                          ;Multiply
 3755:    3EAD  12 21 96                        LCALL   FLOATING_MUL
 3756:    3EB0  75 25 22                        MOV     FORMAT,#22h
 3757:    3EB3  E5 24                           MOV     A,ARG_STACK
 3758:    3EB5  C3                              CLR     C
 3759:    3EB6  94 05                           SUBB    A,#05h
 3760:    3EB8  F8                              MOV     R0,A
 3761:    3EB9  12 24 83                        LCALL   FLOATING_POINT_OUTPUT
 3762:    3EBC  22                              RET
 3763:
 3764:                          ;Single step called when INT1 pin low and interupt is enabled
 3765:                          ;------------------------------------------------------------------
 3766:    3EBD  C0 D0           SINGLESTEP:     PUSH    PSW
 3767:    3EBF  C0 E0                           PUSH    ACC
 3768:    3EC1  C2 D3                           CLR     RS0
 3769:    3EC3  C2 D4                           CLR     RS1
 3770:    3EC5  C0 00                           PUSH    00h
 3771:    3EC7  A8 81                           MOV     R0,SP
 3772:    3EC9  18                              DEC     R0                              ;Skip PSW
 3773:    3ECA  18                              DEC     R0                              ;Skip ACC
 3774:    3ECB  18                              DEC     R0                              ;Skip R0
 3775:    3ECC  E5 5B                           MOV     A,SSADRMSB
 3776:    3ECE  04                              INC     A
 3777:    3ECF  60 0A                           JZ      SINGLESTEP0
 3778:    3ED1  E6                              MOV     A,@R0                           ;MSB adress
 3779:    3ED2  B5 5B 74                        CJNE    A,SSADRMSB,SINGLESTEPEX2
 3780:    3ED5  18                              DEC     R0
 3781:    3ED6  E6                              MOV     A,@R0                           ;MSB adress
 3782:    3ED7  08                              INC     R0
 3783:    3ED8  B5 5A 6E                        CJNE    A,SSADRLSB,SINGLESTEPEX2
 3784:    3EDB  74 07           SINGLESTEP0:    MOV     A,#07h
 3785:    3EDD  12 32 BC                        LCALL   TXBYTE
 3786:    3EE0  E6                              MOV     A,@R0                           ;MSB adress
 3787:    3EE1  12 32 BC                        LCALL   TXBYTE
 3788:    3EE4  18                              DEC     R0
 3789:    3EE5  E6                              MOV     A,@R0                           ;LSB adress
 3790:    3EE6  12 32 BC                        LCALL   TXBYTE
 3791:    3EE9  08                              INC     R0                              ;MSB adress
 3792:    3EEA  08                              INC     R0                              ;PSW
 3793:    3EEB  E6                              MOV     A,@R0                           ;PSW
 3794:    3EEC  12 32 BC                        LCALL   TXBYTE
 3795:    3EEF  08                              INC     R0                              ;ACC
 3796:    3EF0  E6                              MOV     A,@R0                           ;ACC
 3797:    3EF1  12 32 BC                        LCALL   TXBYTE
 3798:    3EF4  E5 F0                           MOV     A,B                             ;B
 3799:    3EF6  12 32 BC                        LCALL   TXBYTE
 3800:    3EF9  E5 81                           MOV     A,SP                            ;SP
 3801:    3EFB  C3                              CLR     C
 3802:    3EFC  94 05                           SUBB    A,#05h
 3803:    3EFE  12 32 BC                        LCALL   TXBYTE
 3804:    3F01  E5 82                           MOV     A,DPL                           ;DPL
 3805:    3F03  12 32 BC                        LCALL   TXBYTE
 3806:    3F06  E5 83                           MOV     A,DPH                           ;DPH
 3807:    3F08  12 32 BC                        LCALL   TXBYTE
 3808:    3F0B  08                              INC     R0                              ;R0
 3809:    3F0C  E6                              MOV     A,@R0                           ;R0
 3810:    3F0D  12 32 BC                        LCALL   TXBYTE
 3811:    3F10  78 01                           MOV     R0,#01h
 3812:    3F12  E6              SINGLESTEP1:    MOV     A,@R0                           ;31 Bytes
 3813:    3F13  12 32 BC                        LCALL   TXBYTE
 3814:    3F16  08                              INC     R0
 3815:    3F17  B8 20 F8                        CJNE    R0,#20h,SINGLESTEP1
 3816:    3F1A  C0 82                           PUSH    DPL
 3817:    3F1C  C0 83                           PUSH    DPH
 3818:    3F1E  78 20                           MOV     R0,#20h                         ;32 Bytes
 3819:    3F20  E0              SINGLESTEP2:    MOVX    A,@DPTR
 3820:    3F21  12 32 BC                        LCALL   TXBYTE
 3821:    3F24  A3                              INC     DPTR
 3822:    3F25  D8 F9                           DJNZ    R0,SINGLESTEP2
 3823:    3F27  12 32 A5        SINGLESTEP3:    LCALL   RXBYTE
 3824:    3F2A  B4 52 04                        CJNE    A,#'R',SINGLESTEP4              ;R Run
 3825:    3F2D  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 3826:    3F2F  80 0E                           SJMP    SINGLESTEPEX
 3827:    3F31  B4 73 08        SINGLESTEP4:    CJNE    A,#'s',SINGLESTEP5              ;s Stop
 3828:    3F34  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 3829:    3F36  E4                              CLR     A
 3830:    3F37  C0 E0                           PUSH    ACC                             ;Force a software reset
 3831:    3F39  C0 E0                           PUSH    ACC
 3832:    3F3B  32                              RETI                                    ;Return to reset vector
 3833:    3F3C  B4 69 11        SINGLESTEP5:    CJNE    A,#'i',SINGLESTEP6              ;i Step into
 3834:    3F3F  75 5A FF        SINGLESTEPEX:   MOV     SSADRLSB,#0FFh
 3835:    3F42  75 5B FF                        MOV     SSADRMSB,#0FFh
 3836:    3F45  D0 83           SINGLESTEPEX1:  POP     DPH
 3837:    3F47  D0 82                           POP     DPL
 3838:    3F49  D0 00           SINGLESTEPEX2:  POP     00h
 3839:    3F4B  D0 E0                           POP     ACC
 3840:    3F4D  D0 D0                           POP     PSW
 3841:    3F4F  32                              RETI
 3842:    3F50  B4 6F 0C        SINGLESTEP6:    CJNE    A,#'o',SINGLESTEP7              ;o Step over / Run to caret
 3843:    3F53  12 32 A5                        LCALL   RXBYTE
 3844:    3F56  F5 5A                           MOV     SSADRLSB,A
 3845:    3F58  12 32 A5                        LCALL   RXBYTE
 3846:    3F5B  F5 5B                           MOV     SSADRMSB,A
 3847:    3F5D  80 E6                           SJMP    SINGLESTEPEX1
 3848:    3F5F  B4 41 05        SINGLESTEP7:    CJNE    A,#'A',SINGLESTEP8              ;A Adress input
 3849:    3F62  12 32 84                        LCALL   INPDPTR
 3850:    3F65  80 C0                           SJMP    SINGLESTEP3
 3851:    3F67  B4 49 05        SINGLESTEP8:    CJNE    A,#'I',SINGLESTEP9              ;Dump internal memory
 3852:    3F6A  12 33 BF                        LCALL   MEMDUMP
 3853:    3F6D  80 B8                           SJMP    SINGLESTEP3
 3854:    3F6F  B4 44 05        SINGLESTEP9:    CJNE    A,#'D',SINGLESTEP10             ;Dump external memory
 3855:    3F72  12 33 7E                        LCALL   DUMP
 3856:    3F75  80 B0                           SJMP    SINGLESTEP3
 3857:    3F77  B4 53 AD        SINGLESTEP10:   CJNE    A,#'S',SINGLESTEP3              ;Dump SFR's
 3858:    3F7A  D0 83                           POP     DPH
 3859:    3F7C  D0 82                           POP     DPL
 3860:    3F7E  D0 00                           POP     00h
 3861:    3F80  D0 E0                           POP     ACC
 3862:    3F82  D0 D0                           POP     PSW
 3863:    3F84  C0 D0                           PUSH    PSW
 3864:    3F86  C0 E0                           PUSH    ACC
 3865:    3F88  C2 D3                           CLR     RS0
 3866:    3F8A  C2 D4                           CLR     RS1
 3867:    3F8C  C0 00                           PUSH    00h
 3868:    3F8E  C0 82                           PUSH    DPL
 3869:    3F90  C0 83                           PUSH    DPH
 3870:    3F92  12 33 E2                        LCALL   DUMPSFR
 3871:    3F95  80 90                           SJMP    SINGLESTEP3
 3872:
 3873:                                          END





                     register banks used:  ---

                     no errors



