

       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



        Source File:    MCU.a51
        Object File:    MCU.hex
        List File:      MCU.lst



 Line  I  Addr  Code            Source

    1:                          $NOPAGING
    2:          N      00FA     $PAGEWIDTH (250) ;250 columns per line
    3:                          $NOTABS          ;expand tabs
    4:                          $NOSYMBOLS
    5:
    6:                          $INCLUDE        (MCU.inc)
    7: 1                        ;*****************************************************
    8: 1                        ;Interrupt vectors.
    9: 1                        ;-----------------------------------------------------
   10: 1                        ;RESET          0000
   11: 1                        ;IE0            0003
   12: 1                        ;TF0            000B
   13: 1                        ;IE1            0013
   14: 1                        ;TF1            001B
   15: 1                        ;RI & TI        0023
   16: 1                        ;TF2 & EXF2     002B
   17: 1                        ;-----------------------------------------------------
   18: 1                        ;*****************************************************
   19: 1                        ;PORT 1
   20: 1                        ;-----------------------------------------------------
   21: 1                        ;P1.0           OUT:    +5V On
   22: 1                        ;P1.1           OUT:    RST
   23: 1                        ;P1.2           OUT:    SCK
   24: 1                        ;P1.3           OUT:    MISO
   25: 1                        ;P1.4           IN:     MOSI
   26: 1                        ;P1.5
   27: 1                        ;P1.6
   28: 1                        ;P1.7
   29: 1                        ;-----------------------------------------------------
   30: 1                        ;*****************************************************
   31: 1                        ;Internal RAM Locations
   32: 1                        ;-----------------------------------------------------
   33: 1                        ;20             Interrupt control bit flags
   34: 1                        ;               D0                      If set INT0 interrupt jumps to 2003h
   35: 1                        ;               D1                      If set TIMER0 interrupt jumps to 200Bh
   36: 1                        ;               D2                      If set INT1 interrupt jumps to 2013h
   37: 1                        ;               D3                      If set TIMER1 interrupt jumps to 201Bh
   38: 1                        ;               D4                      If set RI/TI interrupt jumps to 2023h
   39: 1                        ;               D5                      If set TIMER2 interrupt jumps to 202Bh
   40: 1                        ;               D6                      If set output is to terminal instead of LCD
   41: 1                        ;               D7                      If set single stepping is enabled
   42: 1                        ;21             D6                      OUTPUT PORT #8000
   43: 1                        ;               D7
   44: 1                        ;24             ARG_STACK               ARGUMENT STACK POINTER
   45: 1                        ;25             FORMAT                  LOCATION OF OUTPUT FORMAT BYTE
   46: 1                        ;26.1           INTGRC                  BIT SET IF INTEGER ERROR
   47: 1                        ;26.3           ADD_IN                  DCMPXZ IN BASIC BACKAGE
   48: 1                        ;26.6           ZSURP                   ZERO SUPRESSION FOR HEX PRINT
   49: 1                        ;28-3D          FP WORK AREA
   50: 1                        ;40-4F          ROMBUFF / LCDLINE       16 Bytes
   51: 1                        ;50             FPCHR_OUT               Holds addrss to next byte during FP number convertion
   52: 1                        ;51             ROMVER                  Byte to be verified
   53: 1                        ;52             ROMPAGES                Number of pages
   54: 1                        ;53             ROMACTION               Menu pos
   55: 1                        ;54             ROMSIZE                 Menu pos
   56: 1                        ;55             ROMMODE                 Menu pos
   57: 1                        ;56             ROMVERERR               Number of verify errors
   58: 1                        ;57             DPLSAVE                 Holds DPL during PRNTCSTR
   59: 1                        ;58             DPHSAVE                 Holds DPH during PRNTCSTR
   60: 1                        ;59             MODE                    Selected mode (0-7)
   61: 1                        ;5A             SSADRLSB                Single step adress
   62: 1                        ;5B             SSADRMSB                Single step adress
   63: 1                        ;60             LCF1
   64: 1                        ;68             LCF2
   65: 1                        ;70             LCF3
   66: 1
   67: 1                        ;C0-FF          48 Byte stack
   68: 1
   69: 1                        ;External RAM Locations
   70: 1                        ;-----------------------------------------------------
   71: 1                        ;0048           EXTERNAL RAM FP NUMBER INPUT AREA
   72: 1                        ;0100           EXTERNAL RAM FP STACK
   73: 1                        ;8000           MEMORU MAPPED I/O
   74: 1                        ;8001           MEMORU MAPPED I/O
   75: 1
   76: 1                        ;-----------------------------------------------------
   77: 1                        ;*****************************************************
   78: 1                        ;SCREEN DRIVER
   79: 1                        ;-----------------------------------------------------
   80: 1                        ;01             START SEND ROMDATA.HEX FILE
   81: 1                        ;02             STOP SEND FILE
   82: 1                        ;03             START RECIEVE ROMDATA.HEX FILE
   83: 1                        ;04             STOP RECIEVE FILE
   84: 1                        ;05             START RECIEVE FILE IN 16 BYTE BLOCKS
   85: 1                        ;06             STOP RECIEVE FILE IN 16 BYTE BLOCKS
   86: 1                        ;07             BELL
   87: 1                        ;08             BACK SPACE
   88: 1                        ;09             TAB
   89: 1                        ;0A             LF
   90: 1                        ;0B             LOCATE
   91: 1                        ;0C             HOME
   92: 1                        ;0D             CR
   93: 1                        ;0E             CLS
   94: 1                        ;0F             MODE
   95: 1                        ;10             START SEND CMDFILE.CMD FILE
   96: 1                        ;-----------------------------------------------------
   97: 1                        ;*****************************************************
   98: 1                        ;Memory mapped I/O
   99: 1                        ;-----------------------------------------------------
  100: 1                        ;8000h Output
  101: 1                        ;-----------------------------------------------------
  102: 1                        ;D0             LCD DB4
  103: 1                        ;D1             LCD DB5
  104: 1                        ;D2             LCD DB6
  105: 1                        ;D3             LCD DB7
  106: 1                        ;D4             LCD RS
  107: 1                        ;D5             LCD E
  108: 1                        ;D6             LC Meter        0=C, 1=L
  109: 1                        ;D7             LC Meter        0=F1, 1=F2 (Adding C Cal)
  110: 1                        ;-----------------------------------------------------
  111: 1                        ;8001h Output
  112: 1                        ;-----------------------------------------------------
  113: 1                        ;D0             FRQ SEL A
  114: 1                        ;D1             FRQ SEL B       00=EXT FRQ,01=FGEN,10=LCMETER,11=ALE
  115: 1                        ;D2             FRQ GATE        ACTIVE LOW
  116: 1                        ;D3             FRQ RESET       ACTIVE HIGH
  117: 1                        ;D4             ADC CS          ACTIVE LOW
  118: 1                        ;D5             ADC CLK         HIGH TO LOW TRANSITION
  119: 1                        ;D6             ADC DIN         START,S/D,D2,D1,D0
  120: 1                        ;D7             FRQ TTL         ACTIVE HIGH
  121: 1                        ;-----------------------------------------------------
  122: 1                        ;8000h Input
  123: 1                        ;-----------------------------------------------------
  124: 1                        ;D0             FRQ LSB
  125: 1                        ;D1
  126: 1                        ;D2
  127: 1                        ;D3
  128: 1                        ;D4
  129: 1                        ;D5
  130: 1                        ;D6
  131: 1                        ;D7             FRQ MSB
  132: 1                        ;-----------------------------------------------------
  133: 1                        ;8001h Input
  134: 1                        ;-----------------------------------------------------
  135: 1                        ;D0             ADC DOUT
  136: 1                        ;D1
  137: 1                        ;D2
  138: 1                        ;D3
  139: 1                        ;D4
  140: 1                        ;D5
  141: 1                        ;D6
  142: 1                        ;D7
  143: 1
  144: 1                        ;-----------------------------------------------------
  145: 1                        ;*****************************************************
  146: 1                        ;Equates
  147: 1                        ;-----------------------------------------------------
  148: 1        N      00C8     T2CON           EQU 0C8h
  149: 1        N      00CA     RCAP2L          EQU 0CAh
  150: 1        N      00CB     RCAP2H          EQU 0CBh
  151: 1        N      00CC     TL2             EQU 0CCh
  152: 1        N      00CD     TH2             EQU 0CDh
  153: 1        N        BD     PT2             BIT 0BDh
  154: 1        N      000A     MODEMAX         EQU 10
  155: 1                        ;-----------------------------------------------------
  156: 1        N      0020     INTBITS         EQU 20h                 ;Interrupt jump control
  157: 1        N      0021     OUTD7D6         EQU 21h                 ;Output port #8000h
  158: 1        N      0040     ROMBUFF         EQU 40h                 ;16 Bytes
  159: 1        N      0040     LCDLINE         EQU 40h                 ;16 Bytes
  160: 1        N      0050     FPCHR_OUT       EQU 50h                 ;Holds addrss to next byte during FP number convertion
  161: 1        N      0051     ROMVER          EQU 51h                 ;Byte to be verified
  162: 1        N      0052     ROMPAGES        EQU 52h                 ;Number of pages
  163: 1        N      0053     ROMACTION       EQU 53h                 ;Menu pos
  164: 1        N      0054     ROMSIZE         EQU 54h                 ;Menu pos
  165: 1        N      0055     ROMMODE         EQU 55h                 ;Menu pos
  166: 1        N      0056     ROMVERERR       EQU 56h                 ;Number of verify errors
  167: 1        N      0057     DPLSAVE         EQU 57h                 ;Holds DPL during PRNTCSTR
  168: 1        N      0058     DPHSAVE         EQU 58h                 ;Holds DPH during PRNTCSTR
  169: 1        N      0059     MODE            EQU 59h                 ;Selected mode (0-7)
  170: 1        N      005A     SSADRLSB        EQU 5Ah                 ;Single step adress LSB
  171: 1        N      005B     SSADRMSB        EQU 5Bh                 ;Single step adress MSB
  172: 1                        ;*****************************************************
  173: 1                        ; The following values MUST be provided by the user
  174: 1                        ;*****************************************************
  175: 1        N      0001     ARG_STACK_PAGE  EQU 01H                 ;External memory page for arg stack
  176: 1        N      0024     ARG_STACK       EQU 24H                 ;ARGUMENT STACK POINTER
  177: 1        N      0025     FORMAT          EQU 25H                 ;LOCATION OF OUTPUT FORMAT BYTE
  178: 1        B        31     INTGRC          BIT 26H.1               ;BIT SET IF INTEGER ERROR
  179: 1        B        33     ADD_IN          BIT 26H.3               ;DCMPXZ IN BASIC BACKAGE
  180: 1        B        36     ZSURP           BIT 26H.6               ;ZERO SUPRESSION FOR HEX PRINT
  181: 1                        ;*****************************************************
  182: 1                        ;XRAM
  183: 1                        ;*****************************************************
  184: 1        N      0048     CONVT           EQU 0048H               ;String addr TO CONVERT NUMBERS
  185: 1        N      0060     LCF1            EQU 0060H               ;LC Meter F1
  186: 1        N      0068     LCF2            EQU 0068h               ;LC Meter F2
  187: 1        N      0070     LCF3            EQU 0070h               ;LC Meter F3
  188: 1        N      0078     LCCA            EQU 0078h               ;((F1/F2)^2)-1
  189: 1        N      0080     LCCB            EQU 0080h               ;((1/2*Pi*F1)^2)*LCCA
  190: 1        N      0088     LCCT            EQU 0088h               ;Temp
  191: 1                        ;-----------------------------------------------------
  192:
  193:          N      0001     DEVMODE         EQU 1
  194:          N      0000     DEBUG           EQU 0
  195:
  196:          N      0000     IF DEVMODE=0
  197:                          ;RESET:***********************************************
  198:                                          ORG     0000h
  199:                                          LJMP    START0
  200:                          ;IE0IRQ:**********************************************
  201:                                          ORG     0003h
  202:                                          AJMP    IE0IRQ
  203:                          ;TF0IRQ:**********************************************
  204:                                          ORG     000Bh
  205:                                          JB      INTBITS.1,$+4
  206:                                          RETI
  207:                                          LJMP    200Bh
  208:                          ;IE1IRQ:**********************************************
  209:                                          ORG     0013h
  210:                                          AJMP    IE1IRQ
  211:                          ;TF1IRQ:**********************************************
  212:                                          ORG     001Bh
  213:                                          JB      INTBITS.3,$+4
  214:                                          RETI
  215:                                          LJMP    201Bh
  216:                          ;RITIIRQ:*********************************************
  217:                                          ORG     0023h
  218:                                          JB      INTBITS.4,$+4
  219:                                          RETI
  220:                                          LJMP    2023h
  221:                          ;TF2EXF2IRQ:******************************************
  222:                                          ORG     002Bh
  223:                                          JB      INTBITS.5,$+4
  224:                                          RETI
  225:                                          LJMP    202Bh
  226:                          ;*****************************************************
  227:                          IE0IRQ:         JB      INTBITS.0,IE0IRQ1
  228:                                          DEC     MODE
  229:                                          ACALL   SETMODE
  230:                                          ACALL   DEBOUNCEINT0
  231:                                          LJMP    START
  232:                          IE0IRQ1:        LJMP    2003h
  233:
  234:                          IE1IRQ:         JB      INTBITS.2,IE1IRQ1
  235:                                          JB      INTBITS.7,IE1IRQ2
  236:                                          INC     MODE
  237:                                          ACALL   SETMODE
  238:                                          ACALL   DEBOUNCEINT1
  239:                                          LCALL   LCDCLEAR
  240:                                          LJMP    START
  241:                          IE1IRQ1:        LJMP    2013h
  242:                          IE1IRQ2:        LJMP    SINGLESTEP
  243:
  244:                          ELSE
  245:                          ;RESET:***********************************************
  246:          N      2000                     ORG     2000h
  247:    2000  02 30 00                        LJMP    START0
  248:                          ;IE0IRQ:**********************************************
  249:          N      2003                     ORG     2003h
  250:    2003  01 2C                           AJMP    IE0IRQ
  251:                          ;TF0IRQ:**********************************************
  252:          N      200B                     ORG     200Bh
  253:    200B  32                              RETI
  254:                          ;IE1IRQ:**********************************************
  255:          N      2013                     ORG     2013h
  256:    2013  01 35                           AJMP    IE1IRQ
  257:                          ;TF1IRQ:**********************************************
  258:          N      201B                     ORG     201Bh
  259:    201B  32                              RETI
  260:                          ;RITIIRQ:*********************************************
  261:          N      2023                     ORG     2023h
  262:    2023  32                              RETI
  263:                          ;TF2EXF2IRQ:******************************************
  264:          N      202B                     ORG     202Bh
  265:    202B  32                              RETI
  266:                          ;*****************************************************
  267:    202C  15 59           IE0IRQ:         DEC     MODE
  268:    202E  11 60                           ACALL   SETMODE
  269:    2030  11 44                           ACALL   DEBOUNCEINT0
  270:    2032  02 30 3B                        LJMP    START
  271:
  272:    2035  20 07 09        IE1IRQ:         JB      INTBITS.7,IE1IRQ2
  273:    2038  05 59                           INC     MODE
  274:    203A  11 60                           ACALL   SETMODE
  275:    203C  11 52                           ACALL   DEBOUNCEINT1
  276:    203E  02 30 3B                        LJMP    START
  277:    2041  02 3D 95        IE1IRQ2:        LJMP    SINGLESTEP
  278:
  279:                          ENDIF
  280:
  281:    2044  7E 00           DEBOUNCEINT0:   MOV     R6,#00h
  282:    2046  7F 00                           MOV     R7,#00h
  283:    2048  30 B2 F9        DEBOUNCEINT01:  JNB     P3.2,DEBOUNCEINT0
  284:    204B  DE FB                           DJNZ    R6,DEBOUNCEINT01
  285:    204D  DF F9                           DJNZ    R7,DEBOUNCEINT01
  286:    204F  C2 89                           CLR     IE0
  287:    2051  32                              RETI
  288:
  289:    2052  7E 00           DEBOUNCEINT1:   MOV     R6,#00h
  290:    2054  7F 00                           MOV     R7,#00h
  291:    2056  30 B3 F9        DEBOUNCEINT11:  JNB     P3.3,DEBOUNCEINT1
  292:    2059  DE FB                           DJNZ    R6,DEBOUNCEINT11
  293:    205B  DF F9                           DJNZ    R7,DEBOUNCEINT11
  294:    205D  C2 8B                           CLR     IE1
  295:    205F  32                              RETI
  296:
  297:    2060  E5 59           SETMODE:        MOV     A,MODE
  298:    2062  B4 FF 02                        CJNE    A,#0FFh,SETMODE1
  299:    2065  74 0A                           MOV     A,#MODEMAX
  300:    2067  B4 0B 01        SETMODE1:       CJNE    A,#MODEMAX+1,SETMODE2
  301:    206A  E4                              CLR     A
  302:    206B  F5 59           SETMODE2:       MOV     MODE,A
  303:    206D  FF                              MOV     R7,A
  304:    206E  90 2D 13                        MOV     DPTR,#MODE0
  305:    2071  DF 03                           DJNZ    R7,SETMODE3
  306:    2073  90 2D 1C                        MOV     DPTR,#MODE1
  307:    2076  DF 03           SETMODE3:       DJNZ    R7,SETMODE4
  308:    2078  90 2D 26                        MOV     DPTR,#MODE2
  309:    207B  DF 03           SETMODE4:       DJNZ    R7,SETMODE5
  310:    207D  90 2D 34                        MOV     DPTR,#MODE3
  311:    2080  DF 03           SETMODE5:       DJNZ    R7,SETMODE6
  312:    2082  90 2D 41                        MOV     DPTR,#MODE4
  313:    2085  DF 03           SETMODE6:       DJNZ    R7,SETMODE7
  314:    2087  90 2D 4E                        MOV     DPTR,#MODE5
  315:    208A  DF 03           SETMODE7:       DJNZ    R7,SETMODE8
  316:    208C  90 2D 5C                        MOV     DPTR,#MODE6
  317:    208F  DF 03           SETMODE8:       DJNZ    R7,SETMODE9
  318:    2091  90 2D 66                        MOV     DPTR,#MODE7
  319:    2094  DF 03           SETMODE9:       DJNZ    R7,SETMODE10
  320:    2096  90 2D 70                        MOV     DPTR,#MODE8
  321:    2099  DF 03           SETMODE10:      DJNZ    R7,SETMODE11
  322:    209B  90 2D 78                        MOV     DPTR,#MODE9
  323:    209E  DF 03           SETMODE11:      DJNZ    R7,SETMODE12
  324:    20A0  90 2D 80                        MOV     DPTR,#MODE10
  325:    20A3  12 3D 58        SETMODE12:      LCALL   LCDCLEAR
  326:    20A6  12 31 46                        LCALL   PRNTCDPTRLCD
  327:    20A9  22                              RET
  328:
  329:          N      0000     IF DEVMODE=0
  330:                                          ORG     00C0h
  331:                          ELSE
  332:          N      20C0                     ORG     20C0h
  333:                          ENDIF
  334:
  335:                          $INCLUDE        (FP52.a51)
  336: 1                        ; This is a complete BCD floating point package for the 8051 micro-
  337: 1                        ; controller. It provides 8 digits of accuracy with exponents that
  338: 1                        ; range from +127 to -127. The mantissa is in packed BCD, while the
  339: 1                        ; exponent is expressed in pseudo-twos complement. A ZERO exponent
  340: 1                        ; is used to express the number ZERO. An exponent value of 80H or
  341: 1                        ; greater than means the exponent is positive, i.e. 80H = E 0,
  342: 1                        ; 81H = E+1, 82H = E+2 and so on. If the exponent is 7FH or less,
  343: 1                        ; the exponent is negative, 7FH = E-1, 7EH = E-2, and so on.
  344: 1                        ; ALL NUMBERS ARE ASSUMED TO BE NORMALIZED and all results are
  345: 1                        ; normalized after calculation. A normalized mantissa is >=.10 and
  346: 1                        ; <=.99999999.
  347: 1                        ;
  348: 1                        ; The numbers in memory assumed to be stored as follows:
  349: 1                        ;
  350: 1                        ; EXPONENT OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE
  351: 1                        ; SIGN OF ARGUMENT 2       =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-1
  352: 1                        ; DIGIT 78 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-2
  353: 1                        ; DIGIT 56 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-3
  354: 1                        ; DIGIT 34 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-4
  355: 1                        ; DIGIT 12 OF ARGUMENT 2   =   VALUE OF ARG_STACK+FP_NUMBER_SIZE-5
  356: 1                        ;
  357: 1                        ; EXPONENT OF ARGUMENT 1   =   VALUE OF ARG_STACK
  358: 1                        ; SIGN OF ARGUMENT 1       =   VALUE OF ARG_STACK-1
  359: 1                        ; DIGIT 78 OF ARGUMENT 1   =   VALUE OF ARG_STACK-2
  360: 1                        ; DIGIT 56 OF ARGUMENT 1   =   VALUE OF ARG_STACK-3
  361: 1                        ; DIGIT 34 OF ARGUMENT 1   =   VALUE OF ARG_STACK-4
  362: 1                        ; DIGIT 12 OF ARGUMENT 1   =   VALUE OF ARG_STACK-5
  363: 1                        ;
  364: 1                        ; The operations are performed thusly:
  365: 1                        ;
  366: 1                        ; ARG_STACK+FP_NUMBER_SIZE = ARG_STACK+FP_NUMBER_SIZE # ARG_STACK
  367: 1                        ;
  368: 1                        ; Which is ARGUMENT 2 = ARGUMENT 2 # ARGUMENT 1
  369: 1                        ;
  370: 1                        ; Where # can be ADD, SUBTRACT, MULTIPLY OR DIVIDE.
  371: 1                        ;
  372: 1                        ; Note that the stack gets popped after an operation.
  373: 1                        ;
  374: 1                        ; The FP_COMP instruction POPS the ARG_STACK TWICE and returns status.
  375: 1                        ;
  376: 1                        ;**********************************************************************
  377: 1                        ;
  378: 1                        ;**********************************************************************
  379: 1                        ;
  380: 1                        ; STATUS ON RETURN - After performing an operation (+, -, *, /)
  381: 1                        ;                    the accumulator contains the following status
  382: 1                        ;
  383: 1                        ; ACCUMULATOR - BIT 0 - FLOATING POINT UNDERFLOW OCCURED
  384: 1                        ;
  385: 1                        ;             - BIT 1 - FLOATING POINT OVERFLOW OCCURED
  386: 1                        ;
  387: 1                        ;             - BIT 2 - RESULT WAS ZER0
  388: 1                        ;
  389: 1                        ;             - BIT 3 - DIVIDE BY ZERO ATTEMPTED
  390: 1                        ;
  391: 1                        ;             - BIT 4 - NOT USED, 0 RETURNED
  392: 1                        ;
  393: 1                        ;             - BIT 5 - NOT USED, 0 RETURNED
  394: 1                        ;
  395: 1                        ;             - BIT 6 - NOT USED, 0 RETURNED
  396: 1                        ;
  397: 1                        ;             - BIT 7 - NOT USED, 0 RETURNED
  398: 1                        ;
  399: 1                        ; NOTE: When underflow occures, a ZERO result is returned.
  400: 1                        ;       When overflow or divide by zero occures, a result of
  401: 1                        ;       .99999999 E+127 is returned and it is up to the user
  402: 1                        ;       to handle these conditions as needed in the program.
  403: 1                        ;
  404: 1                        ; NOTE: The Compare instruction returns F0 = 0 if ARG 1 = ARG 2
  405: 1                        ;       and returns a CARRY FLAG = 1 if ARG 1 is > ARG 2
  406: 1                        ;
  407: 1                        ;***********************************************************************
  408: 1                        ;
  409: 1                        ; The following equates are used internally
  410: 1                        ;
  411: 1                        ;***********************************************************************
  412: 1                        ;
  413: 1        N      0006     FP_NUMBER_SIZE  EQU     6
  414: 1        N      0004     DIGIT           EQU     4
  415: 1        N      0000     R0B0            EQU     0
  416: 1        N      0001     R1B0            EQU     1
  417: 1        N      0000     UNDERFLOW       EQU     0
  418: 1        N      0001     OVERFLOW        EQU     1
  419: 1        N      0002     ZERO            EQU     2
  420: 1        N      0003     ZERO_DIVIDE     EQU     3
  421: 1                        ;
  422: 1                        ;***********************************************************************
  423: 1                                ;**************************************************************
  424: 1                                ;
  425: 1                                ; The following internal locations are used by the math pack
  426: 1                                ; ordering is important and the FP_DIGITS must be bit
  427: 1                                ; addressable
  428: 1                                ;
  429: 1                                ;***************************************************************
  430: 1                                ;
  431: 1        N      0028     FP_STATUS       EQU     28H                             ;NOT used data pointer me
  432: 1        N      0029     FP_TEMP         EQU     FP_STATUS+1                     ;NOT USED
  433: 1        N      002A     FP_CARRY        EQU     FP_STATUS+2                     ;USED FOR BITS
  434: 1        N      002B     FP_DIG12        EQU     FP_CARRY+1
  435: 1        N      002C     FP_DIG34        EQU     FP_CARRY+2
  436: 1        N      002D     FP_DIG56        EQU     FP_CARRY+3
  437: 1        N      002E     FP_DIG78        EQU     FP_CARRY+4
  438: 1        N      002F     FP_SIGN         EQU     FP_CARRY+5
  439: 1        N      0030     FP_EXP          EQU     FP_CARRY+6
  440: 1        B        78     MSIGN           BIT     FP_SIGN.0
  441: 1        B        50     XSIGN           BIT     FP_CARRY.0
  442: 1        B        51     FOUND_RADIX     BIT     FP_CARRY.1
  443: 1        B        52     FIRST_RADIX     BIT     FP_CARRY.2
  444: 1        B        53     DONE_LOAD       BIT     FP_CARRY.3
  445: 1        N      002B     FP_NIB1         EQU     FP_DIG12
  446: 1        N      002C     FP_NIB2         EQU     FP_NIB1+1
  447: 1        N      002D     FP_NIB3         EQU     FP_NIB1+2
  448: 1        N      002E     FP_NIB4         EQU     FP_NIB1+3
  449: 1        N      002F     FP_NIB5         EQU     FP_NIB1+4
  450: 1        N      0030     FP_NIB6         EQU     FP_NIB1+5
  451: 1        N      0031     FP_NIB7         EQU     FP_NIB1+6
  452: 1        N      0032     FP_NIB8         EQU     FP_NIB1+7
  453: 1        N      0033     FP_ACCX         EQU     FP_NIB1+8
  454: 1        N      0034     FP_ACCC         EQU     FP_NIB1+9
  455: 1        N      0035     FP_ACC1         EQU     FP_NIB1+10
  456: 1        N      0036     FP_ACC2         EQU     FP_NIB1+11
  457: 1        N      0037     FP_ACC3         EQU     FP_NIB1+12
  458: 1        N      0038     FP_ACC4         EQU     FP_NIB1+13
  459: 1        N      0039     FP_ACC5         EQU     FP_NIB1+14
  460: 1        N      003A     FP_ACC6         EQU     FP_NIB1+15
  461: 1        N      003B     FP_ACC7         EQU     FP_NIB1+16
  462: 1        N      003C     FP_ACC8         EQU     FP_NIB1+17
  463: 1        N      003D     FP_ACCS         EQU     FP_NIB1+18
  464: 1                                ;
  465: 1
  466: 1        C      20C0     FP_BASE         EQU     $
  467: 1
  468: 1                                ;**************************************************************
  469: 1                                ;
  470: 1                                ; The floating point entry points and jump table
  471: 1                                ;
  472: 1                                ;**************************************************************
  473: 1                                ;
  474: 1  20C0  01 F2                           AJMP    FLOATING_ADD
  475: 1  20C2  01 E8                           AJMP    FLOATING_SUB
  476: 1  20C4  21 A5                           AJMP    FLOATING_COMP
  477: 1  20C6  21 D6                           AJMP    FLOATING_MUL
  478: 1  20C8  41 0B                           AJMP    FLOATING_DIV
  479: 1  20CA  61 D2                           AJMP    HEXSCAN
  480: 1  20CC  81 0B                           AJMP    FLOATING_POINT_INPUT
  481: 1  20CE  81 C3                           AJMP    FLOATING_POINT_OUTPUT
  482: 1  20D0  C1 40                           AJMP    CONVERT_BINARY_TO_ASCII_STRING
  483: 1  20D2  A1 E7                           AJMP    CONVERT_ASCII_STRING_TO_BINARY
  484: 1  20D4  C1 1C                           AJMP    MULNUM10
  485: 1  20D6  C1 88                           AJMP    FPHEXOUT
  486: 1                        ;
  487: 1                        ; the remaining jump to routines were extracted from basic52
  488: 1                        ; by me to make the floating point software stand alone
  489: 1                        ;
  490: 1  20D8  61 FF                           AJMP    PUSHR2R0                        ; INTEGER to FLOAT
  491: 1  20DA  C1 D2                           AJMP    IFIX                            ; FLOAT to INTEGER
  492: 1  20DC  E1 13                           AJMP    PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
  493: 1  20DE  E1 0F                           AJMP    POPAS                           ; POP ARGUMENT TO R3:R1
  494: 1  20E0  E1 30                           AJMP    MOVAS                           ; COPY ARGUMENT
  495: 1  20E2  E1 53                           AJMP    AINT                            ; INT FUNCTION
  496: 1  20E4  E1 7B                           AJMP    PUSHC                           ; PUSH ARG IN DPTR TO STACK
  497: 1
  498: 1  20E6  22              PRTERR:         RET
  499: 1  20E7  22              BADPRM:         RET
  500: 1
  501: 1                                ;
  502: 1                                ;
  503: 1  20E8                  FLOATING_SUB:
  504: 1                                ;
  505: 1  20E8  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
  506: 1  20EB  A8 24                           MOV     R0,ARG_STACK
  507: 1  20ED  18                              DEC     R0                              ;POINT TO SIGN
  508: 1  20EE  E2                              MOVX    A,@R0                           ;READ SIGN
  509: 1  20EF  B2 E0                           CPL     ACC.0
  510: 1  20F1  F2                              MOVX    @R0,A
  511: 1                                ;
  512: 1                                ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  513: 1                                ;
  514: 1  20F2                  FLOATING_ADD:
  515: 1                                ;
  516: 1                                ;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  517: 1                                ;
  518: 1                                ;
  519: 1  20F2  71 B3                           ACALL   MDES1                           ;R7=TOS EXP, R6=TOS-1 EXP, R4=TOS SIGN
  520: 1                                                                                                                        ;R3=TOS-1 SIGN, OPERATION IS R1 # R0
  521: 1                                ;
  522: 1  20F4  EF                              MOV     A,R7                            ;GET TOS EXPONENT
  523: 1  20F5  60 0D                           JZ      POP_AND_EXIT                    ;IF TOS=0 THEN POP AND EXIT
  524: 1  20F7  BE 00 12                        CJNE    R6,#0,LOAD1                     ;CLEAR CARRY EXIT IF ZERO
  525: 1                                ;
  526: 1                                ;**************************************************************
  527: 1                                ;
  528: 1  20FA                  SWAP_AND_EXIT:                                          ; Swap external args and return
  529: 1                                ;
  530: 1                                ;**************************************************************
  531: 1                                ;
  532: 1  20FA  71 A7                           ACALL   LOAD_POINTERS
  533: 1  20FC  7F 06                           MOV     R7,#FP_NUMBER_SIZE
  534: 1                                ;
  535: 1  20FE  E2              SE1:            MOVX    A,@R0                           ;SWAP THE ARGUMENTS
  536: 1  20FF  F3                              MOVX    @R1,A
  537: 1  2100  18                              DEC     R0
  538: 1  2101  19                              DEC     R1
  539: 1  2102  DF FA                           DJNZ    R7,SE1
  540: 1                                ;
  541: 1  2104                  POP_AND_EXIT:
  542: 1                                ;
  543: 1  2104  E5 24                           MOV     A,ARG_STACK                     ;POP THE STACK
  544: 1  2106  24 06                           ADD     A,#FP_NUMBER_SIZE
  545: 1  2108  F5 24                           MOV     ARG_STACK,A
  546: 1  210A  E4                              CLR     A
  547: 1  210B  22                              RET
  548: 1                                ;
  549: 1                                ;
  550: 1  210C  9E              LOAD1:          SUBB    A,R6                            ;A = ARG 1 EXP - ARG 2 EXP
  551: 1  210D  8F 30                           MOV     FP_EXP,R7                       ;SAVE EXPONENT AND SIGN
  552: 1  210F  8C 2F                           MOV     FP_SIGN,R4
  553: 1  2111  50 09                           JNC     LOAD2                           ;ARG1 EXPONENT IS LARGER OR SAME
  554: 1  2113  8E 30                           MOV     FP_EXP,R6
  555: 1  2115  8B 2F                           MOV     FP_SIGN,R3
  556: 1  2117  F4                              CPL     A
  557: 1  2118  04                              INC     A                               ;COMPENSATE FOR EXP DELTA
  558: 1  2119  C8                              XCH     A,R0                            ;FORCE R0 TO POINT AT THE LARGEST
  559: 1  211A  C9                              XCH     A,R1                            ;EXPONENT
  560: 1  211B  C8                              XCH     A,R0
  561: 1                                ;
  562: 1  211C  FF              LOAD2:          MOV     R7,A                            ;SAVE THE EXPONENT DELTA IN R7
  563: 1  211D  C2 33                           CLR     ADD_IN
  564: 1  211F  BD 00 02                        CJNE    R5,#0,$+5
  565: 1  2122  D2 33                           SETB    ADD_IN
  566: 1                                ;
  567: 1                                ; Load the R1 mantissa
  568: 1                                ;
  569: 1  2124  71 C4                           ACALL   LOADR1_MANTISSA                 ;LOAD THE SMALLEST NUMBER
  570: 1                                ;
  571: 1                                ; Now align the number to the delta exponent
  572: 1                                ; R4 points to the string of the last digits lost
  573: 1                                ;
  574: 1  2126  BF 0B 00                        CJNE    R7,#DIGIT+DIGIT+3,$+3
  575: 1  2129  40 02                           JC      $+4
  576: 1  212B  7F 0A                           MOV     R7,#DIGIT+DIGIT+2
  577: 1                                ;
  578: 1  212D  75 2A 00                        MOV     FP_CARRY,#00                    ;CLEAR THE CARRY
  579: 1  2130  71 04                           ACALL   RIGHT                           ;SHIFT THE NUMBER
  580: 1                                ;
  581: 1                                ; Set up for addition and subtraction
  582: 1                                ;
  583: 1  2132  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  584: 1  2134  79 2E                           MOV     R1,#FP_DIG78
  585: 1  2136  74 9E                           MOV     A,#9EH
  586: 1  2138  C3                              CLR     C
  587: 1  2139  9C                              SUBB    A,R4
  588: 1  213A  D4                              DA      A
  589: 1  213B  CC                              XCH     A,R4
  590: 1  213C  70 01                           JNZ     $+3
  591: 1  213E  FC                              MOV     R4,A
  592: 1  213F  B4 50 00                        CJNE    A,#50H,$+3                      ;TEST FOR SUBTRACTION
  593: 1  2142  30 33 18                        JNB     ADD_IN,SUBLP                    ;DO SUBTRACTION IF NO ADD_IN
  594: 1  2145  B3                              CPL     C                               ;FLIP CARRY FOR ADDITION
  595: 1  2146  31 54                           ACALL   ADDLP                           ;DO ADDITION
  596: 1                                ;
  597: 1  2148  50 08                           JNC     ADD_R
  598: 1  214A  05 2A                           INC     FP_CARRY
  599: 1  214C  7F 01                           MOV     R7,#1
  600: 1  214E  71 04                           ACALL   RIGHT
  601: 1  2150  51 BB                           ACALL   INC_FP_EXP                      ;SHIFT AND BUMP EXPONENT
  602: 1                                ;
  603: 1  2152  41 AC           ADD_R:          AJMP    STORE_ALIGN_TEST_AND_EXIT
  604: 1                                ;
  605: 1  2154  E2              ADDLP:          MOVX    A,@R0
  606: 1  2155  37                              ADDC    A,@R1
  607: 1  2156  D4                              DA      A
  608: 1  2157  F7                              MOV     @R1,A
  609: 1  2158  18                              DEC     R0
  610: 1  2159  19                              DEC     R1
  611: 1  215A  DF F8                           DJNZ    R7,ADDLP                        ;LOOP UNTIL DONE
  612: 1  215C  22                              RET
  613: 1                                ;
  614: 1                                ;
  615: 1  215D  E2              SUBLP:          MOVX    A,@R0                           ;NOW DO SUBTRACTION
  616: 1  215E  FE                              MOV     R6,A
  617: 1  215F  E4                              CLR     A
  618: 1  2160  34 99                           ADDC    A,#99H
  619: 1  2162  97                              SUBB    A,@R1
  620: 1  2163  2E                              ADD     A,R6
  621: 1  2164  D4                              DA      A
  622: 1  2165  F7                              MOV     @R1,A
  623: 1  2166  18                              DEC     R0
  624: 1  2167  19                              DEC     R1
  625: 1  2168  DF F3                           DJNZ    R7,SUBLP
  626: 1  216A  40 11                           JC      FSUB6
  627: 1                                ;
  628: 1                                ;
  629: 1                                ; Need to complement the result and sign because the floating
  630: 1                                ; point accumulator mantissa was larger than the external
  631: 1                                ; memory and their signs were equal.
  632: 1                                ;
  633: 1  216C  B2 78                           CPL     FP_SIGN.0
  634: 1  216E  79 2E                           MOV     R1,#FP_DIG78
  635: 1  2170  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  636: 1                                ;
  637: 1  2172  74 9A           FSUB5:          MOV     A,#9AH
  638: 1  2174  97                              SUBB    A,@R1
  639: 1  2175  24 00                           ADD     A,#0
  640: 1  2177  D4                              DA      A
  641: 1  2178  F7                              MOV     @R1,A
  642: 1  2179  19                              DEC     R1
  643: 1  217A  B3                              CPL     C
  644: 1  217B  DF F5                           DJNZ    R7,FSUB5                        ;LOOP
  645: 1                                ;
  646: 1                                ; Now see how many zeros their are
  647: 1                                ;
  648: 1  217D  78 2B           FSUB6:          MOV     R0,#FP_DIG12
  649: 1  217F  7F 00                           MOV     R7,#0
  650: 1                                ;
  651: 1  2181  E6              FSUB7:          MOV     A,@R0
  652: 1  2182  70 08                           JNZ     FSUB8
  653: 1  2184  0F                              INC     R7
  654: 1  2185  0F                              INC     R7
  655: 1  2186  08                              INC     R0
  656: 1  2187  B8 2F F7                        CJNE    R0,#FP_SIGN,FSUB7
  657: 1  218A  41 F4                           AJMP    ZERO_AND_EXIT
  658: 1                                ;
  659: 1  218C  B4 10 00        FSUB8:          CJNE    A,#10H,$+3
  660: 1  218F  50 01                           JNC     FSUB9
  661: 1  2191  0F                              INC     R7
  662: 1                                ;
  663: 1                                ; Now R7 has the number of leading zeros in the FP ACC
  664: 1                                ;
  665: 1  2192  E5 30           FSUB9:          MOV     A,FP_EXP                        ;GET THE OLD EXPONENT
  666: 1  2194  C3                              CLR     C
  667: 1  2195  9F                              SUBB    A,R7                            ;SUBTRACT FROM THE NUMBER OF ZEROS
  668: 1  2196  60 0B                           JZ      FSUB10
  669: 1  2198  40 09                           JC      FSUB10
  670: 1                                ;
  671: 1  219A  F5 30                           MOV     FP_EXP,A                        ;SAVE THE NEW EXPONENT
  672: 1                                ;
  673: 1  219C  71 3E                           ACALL   LEFT1                           ;SHIFT THE FP ACC
  674: 1  219E  75 2A 00                        MOV     FP_CARRY,#0
  675: 1  21A1  41 AC                           AJMP    STORE_ALIGN_TEST_AND_EXIT
  676: 1                                ;
  677: 1  21A3  41 EE           FSUB10:         AJMP    UNDERFLOW_AND_EXIT
  678: 1                                ;
  679: 1                                ;***************************************************************
  680: 1                                ;
  681: 1  21A5                  FLOATING_COMP:  ; Compare two floating point numbers
  682: 1                                        ; used for relational operations and is faster
  683: 1                                        ; than subtraction. ON RETURN, The carry is set
  684: 1                                        ; if ARG1 is > ARG2, else carry is not set
  685: 1                                        ; if ARG1 = ARG2, F0 gets set
  686: 1                                ;
  687: 1                                ;***************************************************************
  688: 1                                ;
  689: 1  21A5  71 B3                           ACALL   MDES1                           ;SET UP THE REGISTERS
  690: 1  21A7  E5 24                           MOV     A,ARG_STACK
  691: 1  21A9  24 0C                           ADD     A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
  692: 1  21AB  F5 24                           MOV     ARG_STACK,A                     ;POP THE STACK TWICE, CLEAR THE CARRY
  693: 1  21AD  EE                              MOV     A,R6                            ;CHECK OUT EXPONENTS
  694: 1  21AE  C2 D5                           CLR     F0
  695: 1  21B0  C3                              CLR     C
  696: 1  21B1  9F                              SUBB    A,R7
  697: 1  21B2  60 0A                           JZ      EXPONENTS_EQUAL
  698: 1  21B4  40 03                           JC      ARG1_EXP_IS_LARGER
  699: 1                                ;
  700: 1                                ; Now the ARG2 EXPONENT is > ARG1 EXPONENT
  701: 1                                ;
  702: 1  21B6                  SIGNS_DIFFERENT:
  703: 1                                ;
  704: 1  21B6  EB                              MOV     A,R3                            ;SEE IF SIGN OF ARG2 IS POSITIVE
  705: 1  21B7  80 01                           SJMP    $+3
  706: 1                                ;
  707: 1  21B9                  ARG1_EXP_IS_LARGER:
  708: 1                                ;
  709: 1  21B9  EC                              MOV     A,R4                            ;GET THE SIGN OF ARG1 EXPONENT
  710: 1  21BA  60 01                           JZ      $+3
  711: 1  21BC  B3                              CPL     C
  712: 1  21BD  22                              RET
  713: 1                                ;
  714: 1  21BE                  EXPONENTS_EQUAL:
  715: 1                                ;
  716: 1                                ; First, test the sign, then the mantissa
  717: 1                                ;
  718: 1  21BE  BD 00 F5                        CJNE    R5,#0,SIGNS_DIFFERENT
  719: 1                                ;
  720: 1  21C1                  BOTH_PLUS:
  721: 1                                ;
  722: 1  21C1  7F 04                           MOV     R7,#DIGIT                       ;POINT AT MS DIGIT
  723: 1  21C3  18                              DEC     R0
  724: 1  21C4  18                              DEC     R0
  725: 1  21C5  18                              DEC     R0
  726: 1  21C6  19                              DEC     R1
  727: 1  21C7  19                              DEC     R1
  728: 1  21C8  19                              DEC     R1
  729: 1                                ;
  730: 1                                ; Now do the compare
  731: 1                                ;
  732: 1  21C9  E2              CLOOP:          MOVX    A,@R0
  733: 1  21CA  FE                              MOV     R6,A
  734: 1  21CB  E3                              MOVX    A,@R1
  735: 1  21CC  9E                              SUBB    A,R6
  736: 1  21CD  70 EA                           JNZ     ARG1_EXP_IS_LARGER
  737: 1  21CF  08                              INC     R0
  738: 1  21D0  09                              INC     R1
  739: 1  21D1  DF F6                           DJNZ    R7,CLOOP
  740: 1                                ;
  741: 1                                ; If here, the numbers are the same, the carry is cleared
  742: 1                                ;
  743: 1  21D3  D2 D5                           SETB    F0
  744: 1  21D5  22                              RET                                     ;EXIT WITH EQUAL
  745: 1                                ;
  746: 1                        ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  747: 1                        ;
  748: 1  21D6                  FLOATING_MUL:                                           ; Floating point multiply
  749: 1                        ;
  750: 1                        ;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
  751: 1                        ;
  752: 1  21D6  71 B1                           ACALL   MUL_DIV_EXP_AND_SIGN
  753: 1                                ;
  754: 1                                ; check for zero exponents
  755: 1                                ;
  756: 1  21D8  BE 00 02                        CJNE    R6,#00,$+5                      ;ARG 2 EXP ZERO?
  757: 1  21DB  41 F4                           AJMP    ZERO_AND_EXIT
  758: 1                                ;
  759: 1                                ; calculate the exponent
  760: 1                                ;
  761: 1  21DD  8D 2F           FMUL1:          MOV     FP_SIGN,R5                      ;SAVE THE SIGN, IN CASE OF FAILURE
  762: 1                                ;
  763: 1  21DF  EF                              MOV     A,R7
  764: 1  21E0  60 F9                           JZ      FMUL1-2
  765: 1  21E2  2E                              ADD     A,R6                            ;ADD THE EXPONENTS
  766: 1  21E3  20 E7 05                        JB      ACC.7,FMUL_OVER
  767: 1  21E6  10 D7 06                        JBC     CY,FMUL2                        ;SEE IF CARRY IS SET
  768: 1                                ;
  769: 1  21E9  41 EE                           AJMP    UNDERFLOW_AND_EXIT
  770: 1                                ;
  771: 1  21EB                  FMUL_OVER:
  772: 1                                ;
  773: 1  21EB  50 02                           JNC     FMUL2                           ;OK IF SET
  774: 1                                ;
  775: 1  21ED  41 DD           FOV:            AJMP    OVERFLOW_AND_EXIT
  776: 1                                ;
  777: 1  21EF  94 81           FMUL2:          SUBB    A,#129                          ;SUBTRACT THE EXPONENT BIAS
  778: 1  21F1  FE                              MOV     R6,A                            ;SAVE IT FOR LATER
  779: 1                                ;
  780: 1                                ; Unpack and load R0
  781: 1                                ;
  782: 1  21F2  51 C7                           ACALL   UNPACK_R0
  783: 1                                ;
  784: 1                                ; Now set up for loop multiply
  785: 1                                ;
  786: 1  21F4  7B 04                           MOV     R3,#DIGIT
  787: 1  21F6  AC 01                           MOV     R4,R1B0
  788: 1                                ;
  789: 1                                ;
  790: 1                                ; Now, do the multiply and accumulate the product
  791: 1                                ;
  792: 1  21F8  8C 01           FMUL3:          MOV     R1B0,R4
  793: 1  21FA  E3                              MOVX    A,@R1
  794: 1  21FB  FA                              MOV     R2,A
  795: 1  21FC  71 74                           ACALL   MUL_NIBBLE
  796: 1                                ;
  797: 1  21FE  EA                              MOV     A,R2
  798: 1  21FF  C4                              SWAP    A
  799: 1  2200  71 74                           ACALL   MUL_NIBBLE
  800: 1  2202  1C                              DEC     R4
  801: 1  2203  DB F3                           DJNZ    R3,FMUL3
  802: 1                                ;
  803: 1                                ; Now, pack and restore the sign
  804: 1                                ;
  805: 1  2205  8E 30                           MOV     FP_EXP,R6
  806: 1  2207  8D 2F                           MOV     FP_SIGN,R5
  807: 1  2209  41 6C                           AJMP    PACK                            ;FINISH IT OFF
  808: 1                                ;
  809: 1                                ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  810: 1                                ;
  811: 1  220B                  FLOATING_DIV:
  812: 1                                ;
  813: 1                                ;DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
  814: 1                                ;
  815: 1  220B  71 B3                           ACALL   MDES1
  816: 1                                ;
  817: 1                                ; Check the exponents
  818: 1                                ;
  819: 1  220D  8D 2F                           MOV     FP_SIGN,R5                      ;SAVE THE SIGN
  820: 1  220F  BF 00 06                        CJNE    R7,#0,DIV0                      ;CLEARS THE CARRY
  821: 1  2212  51 DD                           ACALL   OVERFLOW_AND_EXIT
  822: 1  2214  E4                              CLR     A
  823: 1  2215  D2 E3                           SETB    ACC.ZERO_DIVIDE
  824: 1  2217  22                              RET
  825: 1                                ;
  826: 1  2218  EE              DIV0:           MOV     A,R6                            ;GET EXPONENT
  827: 1  2219  60 C0                           JZ      FMUL1-2                         ;EXIT IF ZERO
  828: 1  221B  9F                              SUBB    A,R7                            ;DELTA EXPONENT
  829: 1  221C  20 E7 04                        JB      ACC.7,D_UNDER
  830: 1  221F  50 04                           JNC     DIV3
  831: 1  2221  41 EE                           AJMP    UNDERFLOW_AND_EXIT
  832: 1                                ;
  833: 1  2223  50 C8           D_UNDER:        JNC     FOV
  834: 1                                ;
  835: 1  2225  24 81           DIV3:           ADD     A,#129                          ;CORRECTLY BIAS THE EXPONENT
  836: 1  2227  F5 30                           MOV     FP_EXP,A                        ;SAVE THE EXPONENT
  837: 1  2229  71 C4                           ACALL   LOADR1_MANTISSA                 ;LOAD THE DIVIDED
  838: 1                                ;
  839: 1  222B  7A 34                           MOV     R2,#FP_ACCC                     ;SAVE LOCATION
  840: 1  222D  AB 00                           MOV     R3,R0B0                         ;SAVE POINTER IN R3
  841: 1  222F  75 2A 00                        MOV     FP_CARRY,#0                     ;ZERO CARRY BYTE
  842: 1                                ;
  843: 1  2232  7D FF           DIV4:           MOV     R5,#0FFH                        ;LOOP COUNT
  844: 1  2234  D3                              SETB    C
  845: 1                                ;
  846: 1  2235  8B 00           DIV5:           MOV     R0B0,R3                         ;RESTORE THE EXTERNAL POINTER
  847: 1  2237  79 2E                           MOV     R1,#FP_DIG78                    ;SET UP INTERNAL POINTER
  848: 1  2239  7F 04                           MOV     R7,#DIGIT                       ;LOOP COUNT
  849: 1  223B  50 17                           JNC     DIV7                            ;EXIT IF NO CARRY
  850: 1                                ;
  851: 1  223D  E2              DIV6:           MOVX    A,@R0                           ;DO ACCUMLATION
  852: 1  223E  FE                              MOV     R6,A
  853: 1  223F  E4                              CLR     A
  854: 1  2240  34 99                           ADDC    A,#99H
  855: 1  2242  9E                              SUBB    A,R6
  856: 1  2243  27                              ADD     A,@R1
  857: 1  2244  D4                              DA      A
  858: 1  2245  F7                              MOV     @R1,A
  859: 1  2246  18                              DEC     R0
  860: 1  2247  19                              DEC     R1
  861: 1  2248  DF F3                           DJNZ    R7,DIV6                         ;LOOP
  862: 1                                ;
  863: 1  224A  0D                              INC     R5                              ;SUBTRACT COUNTER
  864: 1  224B  40 E8                           JC      DIV5                            ;KEEP LOOPING IF CARRY
  865: 1  224D  E7                              MOV     A,@R1                           ;GET CARRY
  866: 1  224E  94 01                           SUBB    A,#1                            ;CARRY IS CLEARED
  867: 1  2250  F7                              MOV     @R1,A                           ;SAVE CARRY DIGIT
  868: 1  2251  B3                              CPL     C
  869: 1  2252  80 E1                           SJMP    DIV5                            ;LOOP
  870: 1                                ;
  871: 1                                ; Restore the result if carry was found
  872: 1                                ;
  873: 1  2254  31 54           DIV7:           ACALL   ADDLP                           ;ADD NUMBER BACK
  874: 1  2256  77 00                           MOV     @R1,#0                          ;CLEAR CARRY
  875: 1  2258  8A 00                           MOV     R0B0,R2                         ;GET SAVE COUNTER
  876: 1  225A  A6 05                           MOV     @R0,5                           ;SAVE COUNT BYTE
  877: 1                                ;
  878: 1  225C  0A                              INC     R2                              ;ADJUST SAVE COUNTER
  879: 1  225D  7F 01                           MOV     R7,#1                           ;BUMP DIVIDEND
  880: 1  225F  71 3C                           ACALL   LEFT
  881: 1  2261  BA 3E CE                        CJNE    R2,#FP_ACC8+2,DIV4
  882: 1                                ;
  883: 1  2264  D5 30 02                        DJNZ    FP_EXP,DIV8
  884: 1  2267  41 EE                           AJMP    UNDERFLOW_AND_EXIT
  885: 1                                ;
  886: 1  2269  75 2A 00        DIV8:           MOV     FP_CARRY,#0
  887: 1                                ;
  888: 1                                ;***************************************************************
  889: 1                                ;
  890: 1  226C                  PACK:   ; Pack the mantissa
  891: 1                                ;
  892: 1                                ;***************************************************************
  893: 1                                ;
  894: 1                                ; First, set up the pointers
  895: 1                                ;
  896: 1  226C  78 34                           MOV     R0,#FP_ACCC
  897: 1  226E  E6                              MOV     A,@R0                           ;GET FP_ACCC
  898: 1  226F  FE                              MOV     R6,A                            ;SAVE FOR ZERO COUNT
  899: 1  2270  60 03                           JZ      PACK0                           ;JUMP OVER IF ZERO
  900: 1  2272  51 BB                           ACALL   INC_FP_EXP                      ;BUMP THE EXPONENT
  901: 1  2274  18                              DEC     R0
  902: 1                                ;
  903: 1  2275  08              PACK0:          INC     R0                              ;POINT AT FP_ACC1
  904: 1                                ;
  905: 1  2276  74 08           PACK1:          MOV     A,#8                            ;ADJUST NIBBLE POINTER
  906: 1  2278  F9                              MOV     R1,A
  907: 1  2279  28                              ADD     A,R0
  908: 1  227A  F8                              MOV     R0,A
  909: 1  227B  B6 05 00                        CJNE    @R0,#5,$+3                      ;SEE IF ADJUSTING NEEDED
  910: 1  227E  40 13                           JC      PACK3+1
  911: 1                                ;
  912: 1  2280  D3              PACK2:          SETB    C
  913: 1  2281  E4                              CLR     A
  914: 1  2282  18                              DEC     R0
  915: 1  2283  36                              ADDC    A,@R0
  916: 1  2284  D4                              DA      A
  917: 1  2285  D6                              XCHD    A,@R0                           ;SAVE THE VALUE
  918: 1  2286  30 E4 09                        JNB     ACC.4,PACK3
  919: 1  2289  D9 F5                           DJNZ    R1,PACK2
  920: 1                                ;
  921: 1  228B  18                              DEC     R0
  922: 1  228C  76 01                           MOV     @R0,#1
  923: 1  228E  51 BB                           ACALL   INC_FP_EXP
  924: 1  2290  80 06                           SJMP    PACK4
  925: 1                                ;
  926: 1  2292  19              PACK3:          DEC     R1
  927: 1  2293  E9                              MOV     A,R1
  928: 1  2294  C3                              CLR     C
  929: 1  2295  C8                              XCH     A,R0
  930: 1  2296  98                              SUBB    A,R0
  931: 1  2297  F8                              MOV     R0,A
  932: 1                                ;
  933: 1  2298  79 2B           PACK4:          MOV     R1,#FP_DIG12
  934: 1                                ;
  935: 1                                ; Now, pack
  936: 1                                ;
  937: 1  229A  E6              PLOOP:          MOV     A,@R0
  938: 1  229B  C4                              SWAP    A                               ;FLIP THE DIGITS
  939: 1  229C  08                              INC     R0
  940: 1  229D  D6                              XCHD    A,@R0
  941: 1  229E  42 06                           ORL     6,A                             ;ACCUMULATE THE OR'ED DIGITS
  942: 1  22A0  F7                              MOV     @R1,A
  943: 1  22A1  08                              INC     R0
  944: 1  22A2  09                              INC     R1
  945: 1  22A3  B9 2F F4                        CJNE    R1,#FP_SIGN,PLOOP
  946: 1  22A6  EE                              MOV     A,R6
  947: 1  22A7  70 03                           JNZ     STORE_ALIGN_TEST_AND_EXIT
  948: 1  22A9  75 30 00                        MOV     FP_EXP,#0                       ;ZERO EXPONENT
  949: 1                                ;
  950: 1                                ;**************************************************************
  951: 1                                ;
  952: 1  22AC                  STORE_ALIGN_TEST_AND_EXIT:                              ;Save the number align carry and exit
  953: 1                                ;
  954: 1                                ;**************************************************************
  955: 1                                ;
  956: 1  22AC  71 A7                           ACALL   LOAD_POINTERS
  957: 1  22AE  89 24                           MOV     ARG_STACK,R1                    ;SET UP THE NEW STACK
  958: 1  22B0  78 30                           MOV     R0,#FP_EXP
  959: 1                                ;
  960: 1                                ; Now load the numbers
  961: 1                                ;
  962: 1  22B2  E6              STORE2:         MOV     A,@R0
  963: 1  22B3  F3                              MOVX    @R1,A                           ;SAVE THE NUMBER
  964: 1  22B4  18                              DEC     R0
  965: 1  22B5  19                              DEC     R1
  966: 1  22B6  B8 2A F9                        CJNE    R0,#FP_CARRY,STORE2
  967: 1                                ;
  968: 1  22B9  E4                              CLR     A                               ;NO ERRORS
  969: 1                                ;
  970: 1  22BA  22              PRET:           RET                                     ;EXIT
  971: 1                                ;
  972: 1  22BB                  INC_FP_EXP:
  973: 1                                ;
  974: 1  22BB  05 30                           INC     FP_EXP
  975: 1  22BD  E5 30                           MOV     A,FP_EXP
  976: 1  22BF  70 F9                           JNZ     PRET                            ;EXIT IF NOT ZERO
  977: 1  22C1  D0 E0                           POP     ACC                             ;WASTE THE CALLING STACK
  978: 1  22C3  D0 E0                           POP     ACC
  979: 1  22C5  41 DD                           AJMP    OVERFLOW_AND_EXIT
  980: 1                                ;
  981: 1                        ;***********************************************************************
  982: 1                        ;
  983: 1  22C7                  UNPACK_R0:      ; Unpack BCD digits and load into nibble locations
  984: 1                        ;
  985: 1                        ;***********************************************************************
  986: 1                                ;
  987: 1  22C7  C0 01                           PUSH    R1B0
  988: 1  22C9  79 32                           MOV     R1,#FP_NIB8
  989: 1                                ;
  990: 1  22CB  E2              ULOOP:          MOVX    A,@R0
  991: 1  22CC  54 0F                           ANL     A,#0FH
  992: 1  22CE  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE
  993: 1  22CF  E2                              MOVX    A,@R0
  994: 1  22D0  C4                              SWAP    A
  995: 1  22D1  54 0F                           ANL     A,#0FH
  996: 1  22D3  19                              DEC     R1
  997: 1  22D4  F7                              MOV     @R1,A                           ;SAVE THE NIBBLE AGAIN
  998: 1  22D5  18                              DEC     R0
  999: 1  22D6  19                              DEC     R1
 1000: 1  22D7  B9 2A F1                        CJNE    R1,#FP_NIB1-1,ULOOP
 1001: 1                                ;
 1002: 1  22DA  D0 01                           POP     R1B0
 1003: 1                                ;
 1004: 1  22DC  22              LOAD7:          RET
 1005: 1                                ;
 1006: 1                                ;**************************************************************
 1007: 1                                ;
 1008: 1  22DD                  OVERFLOW_AND_EXIT:      ;LOAD 99999999 E+127,  SET OV BIT, AND EXIT
 1009: 1                                ;
 1010: 1                                ;**************************************************************
 1011: 1                                ;
 1012: 1  22DD  78 2E                           MOV     R0,#FP_DIG78
 1013: 1  22DF  74 99                           MOV     A,#99H
 1014: 1                                ;
 1015: 1  22E1  F6              OVE1:           MOV     @R0,A
 1016: 1  22E2  18                              DEC     R0
 1017: 1  22E3  B8 2A FB                        CJNE    R0,#FP_CARRY,OVE1
 1018: 1                                ;
 1019: 1  22E6  75 30 FF                        MOV     FP_EXP,#0FFH
 1020: 1  22E9  51 AC                           ACALL   STORE_ALIGN_TEST_AND_EXIT
 1021: 1                                ;
 1022: 1  22EB  D2 E1                           SETB    ACC.OVERFLOW
 1023: 1  22ED  22                              RET
 1024: 1                                ;
 1025: 1                                ;**************************************************************
 1026: 1                                ;
 1027: 1  22EE                  UNDERFLOW_AND_EXIT:     ;LOAD 0, SET UF BIT, AND EXIT
 1028: 1                                ;
 1029: 1                                ;**************************************************************
 1030: 1                                ;
 1031: 1  22EE  51 F4                           ACALL   ZERO_AND_EXIT
 1032: 1  22F0  E4                              CLR     A
 1033: 1  22F1  D2 E0                           SETB    ACC.UNDERFLOW
 1034: 1  22F3  22                              RET
 1035: 1                                ;
 1036: 1                                ;**************************************************************
 1037: 1                                ;
 1038: 1  22F4                  ZERO_AND_EXIT:          ;LOAD 0, SET ZERO BIT, AND EXIT
 1039: 1                                ;
 1040: 1                                ;**************************************************************
 1041: 1                                ;
 1042: 1  22F4  51 FB                           ACALL   FP_CLEAR
 1043: 1  22F6  51 AC                           ACALL   STORE_ALIGN_TEST_AND_EXIT
 1044: 1  22F8  D2 E2                           SETB    ACC.ZERO
 1045: 1  22FA  22                              RET                                     ;EXIT
 1046: 1                                ;
 1047: 1                                ;**************************************************************
 1048: 1                                ;
 1049: 1  22FB                  FP_CLEAR:
 1050: 1                                ;
 1051: 1                                ; Clear internal storage
 1052: 1                                ;
 1053: 1                                ;**************************************************************
 1054: 1                                ;
 1055: 1  22FB  E4                              CLR     A
 1056: 1  22FC  78 3D                           MOV     R0,#FP_ACC8+1
 1057: 1                                ;
 1058: 1  22FE  F6              FPC1:           MOV     @R0,A
 1059: 1  22FF  18                              DEC     R0
 1060: 1  2300  B8 29 FB                        CJNE    R0,#FP_TEMP,FPC1
 1061: 1  2303  22                              RET
 1062: 1                                ;
 1063: 1                                ;**************************************************************
 1064: 1                                ;
 1065: 1  2304                  RIGHT:  ; Shift ACCUMULATOR RIGHT the number of nibbles in R7
 1066: 1                                ; Save the shifted values in R4 if SAVE_ROUND is set
 1067: 1                                ;
 1068: 1                                ;**************************************************************
 1069: 1                                ;
 1070: 1  2304  7C 00                           MOV     R4,#0                           ;IN CASE OF NO SHIFT
 1071: 1                                ;
 1072: 1  2306  C3              RIGHT1:         CLR     C
 1073: 1  2307  EF                              MOV     A,R7                            ;GET THE DIGITS TO SHIFT
 1074: 1  2308  60 22                           JZ      RIGHT5-1                        ;EXIT IF ZERO
 1075: 1  230A  94 02                           SUBB    A,#2                            ;TWO TO DO?
 1076: 1  230C  50 1F                           JNC     RIGHT5                          ;SHIFT TWO NIBBLES
 1077: 1                                ;
 1078: 1                                ; Swap one nibble then exit
 1079: 1                                ;
 1080: 1  230E  C0 00           RIGHT3:         PUSH    R0B0                            ;SAVE POINTER REGISTER
 1081: 1  2310  C0 01                           PUSH    R1B0
 1082: 1                                ;
 1083: 1  2312  79 2E                           MOV     R1,#FP_DIG78                    ;LOAD THE POINTERS
 1084: 1  2314  78 2D                           MOV     R0,#FP_DIG56
 1085: 1  2316  EC                              MOV     A,R4                            ;GET THE OVERFLOW REGISTER
 1086: 1  2317  D7                              XCHD    A,@R1                           ;GET DIGIT 8
 1087: 1  2318  C4                              SWAP    A                               ;FLIP FOR LOAD
 1088: 1  2319  FC                              MOV     R4,A
 1089: 1                                ;
 1090: 1  231A  E7              RIGHTL:         MOV     A,@R1                           ;GET THE LOW ORDER BYTE
 1091: 1  231B  D6                              XCHD    A,@R0                           ;SWAP NIBBLES
 1092: 1  231C  C4                              SWAP    A                               ;FLIP FOR STORE
 1093: 1  231D  F7                              MOV     @R1,A                           ;SAVE THE DIGITS
 1094: 1  231E  18                              DEC     R0                              ;BUMP THE POINTERS
 1095: 1  231F  19                              DEC     R1
 1096: 1  2320  B9 2A F7                        CJNE    R1,#FP_DIG12-1,RIGHTL           ;LOOP
 1097: 1                                ;
 1098: 1  2323  E7                              MOV     A,@R1                           ;ACC = CH8
 1099: 1  2324  C4                              SWAP    A                               ;ACC = 8CH
 1100: 1  2325  54 0F                           ANL     A,#0FH                          ;ACC = 0CH
 1101: 1  2327  F7                              MOV     @R1,A                           ;CARRY DONE
 1102: 1  2328  D0 01                           POP     R1B0                            ;EXIT
 1103: 1  232A  D0 00                           POP     R0B0                            ;RESTORE REGISTER
 1104: 1  232C  22                              RET
 1105: 1                                ;
 1106: 1  232D  FF              RIGHT5:         MOV     R7,A                            ;SAVE THE NEW SHIFT NUMBER
 1107: 1  232E  E4                              CLR     A
 1108: 1  232F  C5 2A                           XCH     A,FP_CARRY                      ;SWAP THE NIBBLES
 1109: 1  2331  C5 2B                           XCH     A,FP_DIG12
 1110: 1  2333  C5 2C                           XCH     A,FP_DIG34
 1111: 1  2335  C5 2D                           XCH     A,FP_DIG56
 1112: 1  2337  C5 2E                           XCH     A,FP_DIG78
 1113: 1  2339  FC                              MOV     R4,A                            ;SAVE THE LAST DIGIT SHIFTED
 1114: 1  233A  80 CB                           SJMP    RIGHT1+1
 1115: 1                                ;
 1116: 1                                ;***************************************************************
 1117: 1                                ;
 1118: 1  233C                  LEFT:   ; Shift ACCUMULATOR LEFT the number of nibbles in R7
 1119: 1                                ;
 1120: 1                                ;***************************************************************
 1121: 1                                ;
 1122: 1  233C  7C 00                           MOV     R4,#00H                         ;CLEAR FOR SOME ENTRYS
 1123: 1                                ;
 1124: 1  233E  C3              LEFT1:          CLR     C
 1125: 1  233F  EF                              MOV     A,R7                            ;GET SHIFT VALUE
 1126: 1  2340  60 22                           JZ      LEFT5-1                         ;EXIT IF ZERO
 1127: 1  2342  94 02                           SUBB    A,#2                            ;SEE HOW MANY BYTES TO SHIFT
 1128: 1  2344  50 1F                           JNC     LEFT5
 1129: 1                                ;
 1130: 1  2346  C0 00           LEFT3:          PUSH    R0B0                            ;SAVE POINTER
 1131: 1  2348  C0 01                           PUSH    R1B0
 1132: 1  234A  78 2A                           MOV     R0,#FP_CARRY
 1133: 1  234C  79 2B                           MOV     R1,#FP_DIG12
 1134: 1                                ;
 1135: 1  234E  E6                              MOV     A,@R0                           ;ACC=CHCL
 1136: 1  234F  C4                              SWAP    A                               ;ACC = CLCH
 1137: 1  2350  F6                              MOV     @R0,A                           ;ACC = CLCH, @R0 = CLCH
 1138: 1                                ;
 1139: 1  2351  E7              LEFTL:          MOV     A,@R1                           ;DIG 12
 1140: 1  2352  C4                              SWAP    A                               ;DIG 21
 1141: 1  2353  D6                              XCHD    A,@R0
 1142: 1  2354  F7                              MOV     @R1,A                           ;SAVE IT
 1143: 1  2355  08                              INC     R0                              ;BUMP POINTERS
 1144: 1  2356  09                              INC     R1
 1145: 1  2357  B8 2E F7                        CJNE    R0,#FP_DIG78,LEFTL
 1146: 1                                ;
 1147: 1  235A  EC                              MOV     A,R4
 1148: 1  235B  C4                              SWAP    A
 1149: 1  235C  D6                              XCHD    A,@R0
 1150: 1  235D  54 F0                           ANL     A,#0F0H
 1151: 1  235F  FC                              MOV     R4,A
 1152: 1                                ;
 1153: 1  2360  D0 01                           POP     R1B0
 1154: 1  2362  D0 00                           POP     R0B0                            ;RESTORE
 1155: 1  2364  22                              RET                                     ;DONE
 1156: 1                                ;
 1157: 1  2365  FF              LEFT5:          MOV     R7,A                            ;RESTORE COUNT
 1158: 1  2366  E4                              CLR     A
 1159: 1  2367  CC                              XCH     A,R4                            ;GET THE RESTORATION BYTE
 1160: 1  2368  C5 2E                           XCH     A,FP_DIG78                      ;DO THE SWAP
 1161: 1  236A  C5 2D                           XCH     A,FP_DIG56
 1162: 1  236C  C5 2C                           XCH     A,FP_DIG34
 1163: 1  236E  C5 2B                           XCH     A,FP_DIG12
 1164: 1  2370  C5 2A                           XCH     A,FP_CARRY
 1165: 1  2372  80 CB                           SJMP    LEFT1+1
 1166: 1                                ;
 1167: 1  2374                  MUL_NIBBLE:
 1168: 1                                ;
 1169: 1                                ; Multiply the nibble in R7 by the FP_NIB locations
 1170: 1                                ; accumulate the product in FP_ACC
 1171: 1                                ;
 1172: 1                                ; Set up the pointers for multiplication
 1173: 1                                ;
 1174: 1  2374  54 0F                           ANL     A,#0FH                          ;STRIP OFF MS NIBBLE
 1175: 1  2376  FF                              MOV     R7,A
 1176: 1  2377  78 3C                           MOV     R0,#FP_ACC8
 1177: 1  2379  79 32                           MOV     R1,#FP_NIB8
 1178: 1  237B  E4                              CLR     A
 1179: 1  237C  F5 33                           MOV     FP_ACCX,A
 1180: 1                                ;
 1181: 1  237E  18              MNLOOP:         DEC     R0                              ;BUMP POINTER TO PROPAGATE CARRY
 1182: 1  237F  26                              ADD     A,@R0                           ;ATTEMPT TO FORCE CARRY
 1183: 1  2380  D4                              DA      A                               ;BCD ADJUST
 1184: 1  2381  30 E4 03                        JNB     ACC.4,MNL0                      ;DON'T ADJUST IF NO NEED
 1185: 1  2384  18                              DEC     R0                              ;PROPAGATE CARRY TO THE NEXT DIGIT
 1186: 1  2385  06                              INC     @R0                             ;DO THE ADJUSTING
 1187: 1  2386  08                              INC     R0                              ;RESTORE R0
 1188: 1                                ;
 1189: 1  2387  D6              MNL0:           XCHD    A,@R0                           ;RESTORE INITIAL NUMBER
 1190: 1  2388  8F F0                           MOV     B,R7                            ;GET THE NUBBLE TO MULTIPLY
 1191: 1  238A  E7                              MOV     A,@R1                           ;GET THE OTHER NIBBLE
 1192: 1  238B  A4                              MUL     AB                              ;DO THE MULTIPLY
 1193: 1  238C  75 F0 0A                        MOV     B,#10                           ;NOW BCD ADJUST
 1194: 1  238F  84                              DIV     AB
 1195: 1  2390  C5 F0                           XCH     A,B                             ;GET THE REMAINDER
 1196: 1  2392  26                              ADD     A,@R0                           ;PROPAGATE THE PARTIAL PRODUCTS
 1197: 1  2393  D4                              DA      A                               ;BCD ADJUST
 1198: 1  2394  30 E4 02                        JNB     ACC.4,MNL1                      ;PROPAGATE PARTIAL PRODUCT CARRY
 1199: 1  2397  05 F0                           INC     B
 1200: 1                                ;
 1201: 1  2399  08              MNL1:           INC     R0
 1202: 1  239A  D6                              XCHD    A,@R0                           ;SAVE THE NEW PRODUCT
 1203: 1  239B  18                              DEC     R0
 1204: 1  239C  E5 F0                           MOV     A,B                             ;GET BACK THE QUOTIENT
 1205: 1  239E  19                              DEC     R1
 1206: 1  239F  B9 2A DC                        CJNE    R1,#FP_NIB1-1,MNLOOP
 1207: 1                                ;
 1208: 1  23A2  25 33                           ADD     A,FP_ACCX                       ;GET THE OVERFLOW
 1209: 1  23A4  D4                              DA      A                               ;ADJUST
 1210: 1  23A5  F6                              MOV     @R0,A                           ;SAVE IT
 1211: 1  23A6  22                              RET                                     ;EXIT
 1212: 1                                ;
 1213: 1                                ;***************************************************************
 1214: 1                                ;
 1215: 1  23A7                  LOAD_POINTERS:  ; Load the ARG_STACK into R0 and bump R1
 1216: 1                                ;
 1217: 1                                ;***************************************************************
 1218: 1                                ;
 1219: 1  23A7  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1220: 1  23AA  A8 24                           MOV     R0,ARG_STACK
 1221: 1  23AC  74 06                           MOV     A,#FP_NUMBER_SIZE
 1222: 1  23AE  28                              ADD     A,R0
 1223: 1  23AF  F9                              MOV     R1,A
 1224: 1  23B0  22                              RET
 1225: 1                                ;
 1226: 1                                ;***************************************************************
 1227: 1                                ;
 1228: 1  23B1                  MUL_DIV_EXP_AND_SIGN:
 1229: 1                                ;
 1230: 1                                ; Load the sign into R7, R6. R5 gets the sign for
 1231: 1                                ; multiply and divide.
 1232: 1                                ;
 1233: 1                                ;***************************************************************
 1234: 1                                ;
 1235: 1  23B1  51 FB                           ACALL   FP_CLEAR                        ;CLEAR INTERNAL MEMORY
 1236: 1                                ;
 1237: 1  23B3  71 A7           MDES1:          ACALL   LOAD_POINTERS                   ;LOAD REGISTERS
 1238: 1  23B5  E2                              MOVX    A,@R0                           ;ARG 1 EXP
 1239: 1  23B6  FF                              MOV     R7,A                            ;SAVED IN R7
 1240: 1  23B7  E3                              MOVX    A,@R1                           ;ARG 2 EXP
 1241: 1  23B8  FE                              MOV     R6,A                            ;SAVED IN R6
 1242: 1  23B9  18                              DEC     R0                              ;BUMP POINTERS TO SIGN
 1243: 1  23BA  19                              DEC     R1
 1244: 1  23BB  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1245: 1  23BC  FC                              MOV     R4,A                            ;SIGN OF ARG1
 1246: 1  23BD  E3                              MOVX    A,@R1                           ;GET SIGN OF NEXT ARG
 1247: 1  23BE  FB                              MOV     R3,A                            ;SIGN OF ARG2
 1248: 1  23BF  6C                              XRL     A,R4                            ;ACC GETS THE NEW SIGN
 1249: 1  23C0  FD                              MOV     R5,A                            ;R5 GETS THE NEW SIGN
 1250: 1                                ;
 1251: 1                                ; Bump the pointers to point at the LS digit
 1252: 1                                ;
 1253: 1  23C1  18                              DEC     R0
 1254: 1  23C2  19                              DEC     R1
 1255: 1                                ;
 1256: 1  23C3  22                              RET
 1257: 1                                ;
 1258: 1                                ;***************************************************************
 1259: 1                                ;
 1260: 1  23C4                  LOADR1_MANTISSA:
 1261: 1                                ;
 1262: 1                                ; Load the mantissa of R0 into FP_Digits
 1263: 1                                ;
 1264: 1                                ;***************************************************************
 1265: 1                                ;
 1266: 1  23C4  C0 00                           PUSH    R0B0                            ;SAVE REGISTER 1
 1267: 1  23C6  78 2E                           MOV     R0,#FP_DIG78                    ;SET UP THE POINTER
 1268: 1                                ;
 1269: 1  23C8  E3              LOADR1:         MOVX    A,@R1
 1270: 1  23C9  F6                              MOV     @R0,A
 1271: 1  23CA  19                              DEC     R1
 1272: 1  23CB  18                              DEC     R0
 1273: 1  23CC  B8 2A F9                        CJNE    R0,#FP_CARRY,LOADR1
 1274: 1                                ;
 1275: 1  23CF  D0 00                           POP     R0B0
 1276: 1  23D1  22                              RET
 1277: 1                                ;
 1278: 1                                ;***************************************************************
 1279: 1                                ;
 1280: 1  23D2                  HEXSCAN:        ; Scan a string to determine if it is a hex number
 1281: 1                                        ; set carry if hex, else carry = 0
 1282: 1                                ;
 1283: 1                                ;***************************************************************
 1284: 1                                ;
 1285: 1  23D2  91 A8                           ACALL   GET_DPTR_CHARACTER
 1286: 1  23D4  C0 83                           PUSH    DPH
 1287: 1  23D6  C0 82                           PUSH    DPL                             ;SAVE THE POINTER
 1288: 1                                ;
 1289: 1  23D8  E0              HEXSC1:         MOVX    A,@DPTR                         ;GET THE CHARACTER
 1290: 1  23D9  D1 B6                           ACALL   DIGIT_CHECK                     ;SEE IF A DIGIT
 1291: 1  23DB  40 12                           JC      HS1                             ;CONTINUE IF A DIGIT
 1292: 1  23DD  71 F2                           ACALL   HEX_CHECK                       ;SEE IF HEX
 1293: 1  23DF  40 0E                           JC      HS1
 1294: 1                                ;
 1295: 1  23E1  C2 E5                           CLR     ACC.5                           ;NO LOWER CASE
 1296: 1  23E3  B4 48 03                        CJNE    A,#'H',HEXDON
 1297: 1  23E6  D3                              SETB    C
 1298: 1  23E7  80 01                           SJMP    HEXDO1                          ;NUMBER IS VALID HEX, MAYBE
 1299: 1                                ;
 1300: 1  23E9  C3              HEXDON:         CLR     C
 1301: 1                                ;
 1302: 1  23EA  D0 82           HEXDO1:         POP     DPL                             ;RESTORE POINTER
 1303: 1  23EC  D0 83                           POP     DPH
 1304: 1  23EE  22                              RET
 1305: 1                                ;
 1306: 1  23EF  A3              HS1:            INC     DPTR                            ;BUMP TO NEXT CHARACTER
 1307: 1  23F0  80 E6                           SJMP    HEXSC1                          ;LOOP
 1308: 1                                ;
 1309: 1  23F2                  HEX_CHECK:      ;CHECK FOR A VALID ASCII HEX, SET CARRY IF FOUND
 1310: 1                                ;
 1311: 1  23F2  C2 E5                           CLR     ACC.5                           ;WASTE LOWER CASE
 1312: 1  23F4  B4 47 00                        CJNE    A,#'F'+1,$+3                    ;SEE IF F OR LESS
 1313: 1  23F7  40 01                           JC      HC1
 1314: 1  23F9  22                              RET
 1315: 1                                ;
 1316: 1  23FA  B4 41 00        HC1:            CJNE    A,#'A',$+3                      ;SEE IF A OR GREATER
 1317: 1  23FD  B3                              CPL     C
 1318: 1  23FE  22                              RET
 1319: 1                                ;
 1320: 1                                ;
 1321: 1  23FF                  PUSHR2R0:
 1322: 1                                ;
 1323: 1  23FF  7B 00                           MOV     R3,#HIGH CONVT                  ;CONVERSION LOCATION
 1324: 1  2401  79 48                           MOV     R1,#LOW CONVT
 1325: 1  2403  D1 40                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1326: 1  2405  74 0D                           MOV     A,#0DH                          ;A CR TO TERMINATE
 1327: 1  2407  F3                              MOVX    @R1,A                           ;SAVE THE CR
 1328: 1  2408  90 00 48                        MOV     DPTR,#CONVT
 1329: 1                                ;
 1330: 1                                ; Falls thru to FLOATING INPUT
 1331: 1                                ;
 1332: 1                                ;***************************************************************
 1333: 1                                ;
 1334: 1  240B                  FLOATING_POINT_INPUT:   ; Input a floating point number pointed to by the DPTR
 1335: 1                                ;
 1336: 1                                ;***************************************************************
 1337: 1                                ;
 1338: 1  240B  51 FB                           ACALL   FP_CLEAR                        ;CLEAR EVERYTHING
 1339: 1  240D  91 A8                           ACALL   GET_DPTR_CHARACTER
 1340: 1  240F  91 AE                           ACALL   PLUS_MINUS_TEST
 1341: 1  2411  92 78                           MOV     MSIGN,C                         ;SAVE THE MANTISSA SIGN
 1342: 1                                ;
 1343: 1                                ; Now, set up for input loop
 1344: 1                                ;
 1345: 1  2413  78 34                           MOV     R0,#FP_ACCC
 1346: 1  2415  7E 7F                           MOV     R6,#7FH                         ;BASE EXPONENT
 1347: 1  2417  D2 D5                           SETB    F0                              ;SET INITIAL FLAG
 1348: 1                                ;
 1349: 1  2419  D1 B4           INLOOP:         ACALL   GET_DIGIT_CHECK
 1350: 1  241B  50 07                           JNC     GTEST                           ;IF NOT A CHARACTER, WHAT IS IT?
 1351: 1  241D  54 0F                           ANL     A,#0FH                          ;STRIP ASCII
 1352: 1  241F  91 81                           ACALL   STDIG                           ;STORE THE DIGITS
 1353: 1                                ;
 1354: 1  2421  A3              INLPIK:         INC     DPTR                            ;BUMP POINTER FOR LOOP
 1355: 1  2422  80 F5                           SJMP    INLOOP                          ;LOOP FOR INPUT
 1356: 1                                ;
 1357: 1  2424  B4 2E 0C        GTEST:          CJNE    A,#'.',GT1                      ;SEE IF A RADIX
 1358: 1  2427  20 51 63                        JB      FOUND_RADIX,INERR
 1359: 1  242A  D2 51                           SETB    FOUND_RADIX
 1360: 1  242C  B8 34 F2                        CJNE    R0,#FP_ACCC,INLPIK
 1361: 1  242F  D2 52                           SETB    FIRST_RADIX                     ;SET IF FIRST RADIX
 1362: 1  2431  80 EE                           SJMP    INLPIK                          ;GET ADDITIONAL DIGITS
 1363: 1                                ;
 1364: 1  2433  20 D5 57        GT1:            JB      F0,INERR                        ;ERROR IF NOT CLEARED
 1365: 1  2436  B4 65 02                        CJNE    A,#'e',$+5                      ;CHECK FOR LOWER CASE
 1366: 1  2439  80 03                           SJMP    $+5
 1367: 1  243B  B4 45 33                        CJNE    A,#'E',FINISH_UP
 1368: 1  243E  91 A7                           ACALL   INC_AND_GET_DPTR_CHARACTER
 1369: 1  2440  91 AE                           ACALL   PLUS_MINUS_TEST
 1370: 1  2442  92 50                           MOV     XSIGN,C                         ;SAVE SIGN STATUS
 1371: 1  2444  D1 B4                           ACALL   GET_DIGIT_CHECK
 1372: 1  2446  50 45                           JNC     INERR
 1373: 1                                ;
 1374: 1  2448  54 0F                           ANL     A,#0FH                          ;STRIP ASCII BIAS OFF THE CHARACTER
 1375: 1  244A  FD                              MOV     R5,A                            ;SAVE THE CHARACTER IN R5
 1376: 1                                ;
 1377: 1  244B  A3              GT2:            INC     DPTR
 1378: 1  244C  D1 B4                           ACALL   GET_DIGIT_CHECK
 1379: 1  244E  50 0D                           JNC     FINISH1
 1380: 1  2450  54 0F                           ANL     A,#0FH                          ;STRIP OFF BIAS
 1381: 1  2452  CD                              XCH     A,R5                            ;GET THE LAST DIGIT
 1382: 1  2453  75 F0 0A                        MOV     B,#10                           ;MULTIPLY BY TEN
 1383: 1  2456  A4                              MUL     AB
 1384: 1  2457  2D                              ADD     A,R5                            ;ADD TO ORIGINAL VALUE
 1385: 1  2458  FD                              MOV     R5,A                            ;SAVE IN R5
 1386: 1  2459  50 F0                           JNC     GT2                             ;LOOP IF NO CARRY
 1387: 1  245B  7D FF                           MOV     R5,#0FFH                        ;FORCE AN ERROR
 1388: 1                                ;
 1389: 1  245D  ED              FINISH1:        MOV     A,R5                            ;GET THE SIGN
 1390: 1  245E  30 50 09                        JNB     XSIGN,POSNUM                    ;SEE IF EXPONENT IS POS OR NEG
 1391: 1  2461  C3                              CLR     C
 1392: 1  2462  9E                              SUBB    A,R6
 1393: 1  2463  F4                              CPL     A
 1394: 1  2464  04                              INC     A
 1395: 1  2465  40 09                           JC      FINISH2
 1396: 1  2467  74 01                           MOV     A,#01H
 1397: 1  2469  22                              RET
 1398: 1                                ;
 1399: 1  246A  2E              POSNUM:         ADD     A,R6                            ;ADD TO EXPONENT
 1400: 1  246B  50 03                           JNC     FINISH2
 1401: 1                                ;
 1402: 1  246D  74 02           POSNM1:         MOV     A,#02H
 1403: 1  246F  22                              RET
 1404: 1                                ;
 1405: 1  2470  CE              FINISH2:        XCH     A,R6                            ;SAVE THE EXPONENT
 1406: 1                                ;
 1407: 1  2471                  FINISH_UP:
 1408: 1                                ;
 1409: 1  2471  8E 30                           MOV     FP_EXP,R6                       ;SAVE EXPONENT
 1410: 1  2473  B8 34 02                        CJNE    R0,#FP_ACCC,$+5
 1411: 1  2476  51 FB                           ACALL   FP_CLEAR                        ;CLEAR THE MEMORY IF 0
 1412: 1  2478  E5 24                           MOV     A,ARG_STACK                     ;GET THE ARG STACK
 1413: 1  247A  C3                              CLR     C
 1414: 1  247B  94 0C                           SUBB    A,#FP_NUMBER_SIZE+FP_NUMBER_SIZE
 1415: 1  247D  F5 24                           MOV     ARG_STACK,A                     ;ADJUST FOR STORE
 1416: 1  247F  41 6C                           AJMP    PACK
 1417: 1                                ;
 1418: 1  2481  C2 D5           STDIG:          CLR     F0                              ;CLEAR INITIAL DESIGNATOR
 1419: 1  2483  70 0B                           JNZ     STDIG1                          ;CONTINUE IF NOT ZERO
 1420: 1  2485  B8 34 08                        CJNE    R0,#FP_ACCC,STDIG1
 1421: 1  2488  30 52 04                        JNB     FIRST_RADIX,RET_X
 1422: 1                                ;
 1423: 1  248B  DE 02           DECX:           DJNZ    R6,RET_X
 1424: 1                                ;
 1425: 1  248D  74 FF           INERR:          MOV     A,#0FFH
 1426: 1                                ;
 1427: 1  248F  22              RET_X:          RET
 1428: 1                                ;
 1429: 1  2490  20 53 02        STDIG1:         JB      DONE_LOAD,FRTEST
 1430: 1  2493  C2 52                           CLR     FIRST_RADIX
 1431: 1                                ;
 1432: 1  2495  20 52 F3        FRTEST:         JB      FIRST_RADIX,DECX
 1433: 1                                ;
 1434: 1  2498  20 51 01        FDTEST:         JB      FOUND_RADIX,FDT1
 1435: 1  249B  0E                              INC     R6
 1436: 1                                ;
 1437: 1  249C  20 53 F0        FDT1:           JB      DONE_LOAD,RET_X
 1438: 1  249F  B8 3D 02                        CJNE    R0,#FP_ACC8+1,FDT2
 1439: 1  24A2  D2 53                           SETB    DONE_LOAD
 1440: 1                                ;
 1441: 1  24A4  F6              FDT2:           MOV     @R0,A                           ;SAVE THE STRIPPED ACCUMULATOR
 1442: 1  24A5  08                              INC     R0                              ;BUMP THE POINTER
 1443: 1  24A6  22                              RET                                     ;EXIT
 1444: 1                                ;
 1445: 1                                ;***************************************************************
 1446: 1                                ;
 1447: 1                                ; I/O utilities
 1448: 1                                ;
 1449: 1                                ;***************************************************************
 1450: 1                                ;
 1451: 1  24A7                  INC_AND_GET_DPTR_CHARACTER:
 1452: 1                                ;
 1453: 1  24A7  A3                              INC     DPTR
 1454: 1                                ;
 1455: 1  24A8                  GET_DPTR_CHARACTER:
 1456: 1                                ;
 1457: 1  24A8  E0                              MOVX    A,@DPTR                         ;GET THE CHARACTER
 1458: 1  24A9  B4 20 16                        CJNE    A,#' ',PMT1                     ;SEE IF A SPACE
 1459: 1                                ;
 1460: 1                                ; Kill spaces
 1461: 1                                ;
 1462: 1  24AC  80 F9                           SJMP    INC_AND_GET_DPTR_CHARACTER
 1463: 1                                ;
 1464: 1  24AE                  PLUS_MINUS_TEST:
 1465: 1                                ;
 1466: 1  24AE  B4 E3 02                        CJNE    A,#0E3H,$+5                     ;SEE IF A PLUS, PLUS TOKEN FROM BASIC
 1467: 1  24B1  80 0E                           SJMP    PMT3
 1468: 1  24B3  B4 2B 02                        CJNE    A,#'+',$+5
 1469: 1  24B6  80 09                           SJMP    PMT3
 1470: 1  24B8  B4 E5 02                        CJNE    A,#0E5H,$+5                     ;SEE IF MINUS, MINUS TOKEN FROM BASIC
 1471: 1  24BB  80 03                           SJMP    PMT2
 1472: 1  24BD  B4 2D 02                        CJNE    A,#'-',PMT1
 1473: 1                                ;
 1474: 1  24C0  D3              PMT2:           SETB    C
 1475: 1                                ;
 1476: 1  24C1  A3              PMT3:           INC     DPTR
 1477: 1                                ;
 1478: 1  24C2  22              PMT1:           RET
 1479: 1                                ;
 1480: 1                                ;***************************************************************
 1481: 1                                ;
 1482: 1  24C3                  FLOATING_POINT_OUTPUT:  ; Output the number, format is in location 25
 1483: 1                                ;
 1484: 1                                ; IF FORMAT = 00 - FREE FLOATING
 1485: 1                                ;           = FX - EXPONENTIAL (X IS THE NUMBER OF SIG DIGITS)
 1486: 1                                ;           = NX - N = NUM BEFORE RADIX, X = NUM AFTER RADIX
 1487: 1                                ;                  N + X = 8 MAX
 1488: 1                                ;
 1489: 1                                ;***************************************************************
 1490: 1                                ;
 1491: 1  24C3  71 B3                           ACALL   MDES1                           ;GET THE NUMBER TO OUTPUT, R0 IS POINTER
 1492: 1  24C5  31 04                           ACALL   POP_AND_EXIT                    ;OUTPUT POPS THE STACK
 1493: 1  24C7  EF                              MOV     A,R7
 1494: 1  24C8  FE                              MOV     R6,A                            ;PUT THE EXPONENT IN R6
 1495: 1  24C9  51 C7                           ACALL   UNPACK_R0                       ;UNPACK THE NUMBER
 1496: 1  24CB  78 2B                           MOV     R0,#FP_NIB1                     ;POINT AT THE NUMBER
 1497: 1  24CD  E5 25                           MOV     A,FORMAT                        ;GET THE FORMAT
 1498: 1  24CF  FB                              MOV     R3,A                            ;SAVE IN CASE OF EXP FORMAT
 1499: 1  24D0  60 49                           JZ      FREE                            ;FREE FLOATING?
 1500: 1  24D2  B4 F0 00                        CJNE    A,#0F0H,$+3                     ;SEE IF EXPONENTIAL
 1501: 1  24D5  50 73                           JNC     EXPOUT
 1502: 1                                ;
 1503: 1                                ; If here, must be integer USING format
 1504: 1                                ;
 1505: 1  24D7  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1506: 1  24D8  70 02                           JNZ     $+4
 1507: 1  24DA  7E 80                           MOV     R6,#80H
 1508: 1  24DC  EB                              MOV     A,R3                            ;GET THE FORMAT
 1509: 1  24DD  C4                              SWAP    A                                       ;SPLIT INTEGER AND FRACTION
 1510: 1  24DE  54 0F                           ANL     A,#0FH
 1511: 1  24E0  FA                              MOV     R2,A                            ;SAVE INTEGER
 1512: 1  24E1  B1 B0                           ACALL   NUM_LT                          ;GET THE NUMBER OF INTEGERS
 1513: 1  24E3  CA                              XCH     A,R2                            ;FLIP FOR SUBB
 1514: 1  24E4  C3                              CLR             C
 1515: 1  24E5  9A                              SUBB    A,R2
 1516: 1  24E6  FF                              MOV     R7,A
 1517: 1  24E7  50 06                           JNC     $+8
 1518: 1  24E9  7D 3F                           MOV     R5,#'?'                         ;OUTPUT A QUESTION MARK
 1519: 1  24EB  B1 E5                           ACALL   SOUT1                           ;NUMBER IS TOO LARGE FOR FORMAT
 1520: 1  24ED  A1 1B                           AJMP    FREE
 1521: 1  24EF  BA 00 07                        CJNE    R2,#00,USING0                   ;SEE IF ZERO
 1522: 1  24F2  1F                              DEC     R7
 1523: 1  24F3  B1 D2                           ACALL   SS7
 1524: 1  24F5  B1 DF                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1525: 1  24F7  80 06                           SJMP    USING1
 1526: 1                                ;
 1527: 1  24F9  B1 D2           USING0:         ACALL   SS7                             ;OUTPUT SPACES, IF NEED TO
 1528: 1  24FB  EA                              MOV     A,R2                            ;OUTPUT DIGITS
 1529: 1  24FC  FF                              MOV     R7,A
 1530: 1  24FD  B1 94                           ACALL   OUTR0
 1531: 1                                ;
 1532: 1  24FF  EB              USING1:         MOV     A,R3
 1533: 1  2500  54 0F                           ANL     A,#0FH                          ;GET THE NUMBER RIGHT OF DP
 1534: 1  2502  FA                              MOV     R2,A                            ;SAVE IT
 1535: 1  2503  60 BD                           JZ      PMT1                            ;EXIT IF ZERO
 1536: 1  2505  B1 DB                           ACALL   ROUT                            ;OUTPUT DP
 1537: 1  2507  B1 B9                           ACALL   NUM_RT
 1538: 1  2509  B5 02 03                        CJNE    A,2,USINGX                      ;COMPARE A TO R2
 1539: 1                                ;
 1540: 1  250C  EA              USINGY:         MOV     A,R2
 1541: 1  250D  A1 C9                           AJMP    Z7R7
 1542: 1                                ;
 1543: 1  250F  50 FB           USINGX:         JNC     USINGY
 1544: 1                                ;
 1545: 1  2511  CA              USING2:         XCH     A,R2
 1546: 1  2512  C3                              CLR     C
 1547: 1  2513  9A                              SUBB    A,R2
 1548: 1  2514  CA                              XCH     A,R2
 1549: 1  2515  B1 C9                           ACALL   Z7R7                            ;OUTPUT ZEROS IF NEED TO
 1550: 1  2517  EA                              MOV     A,R2
 1551: 1  2518  FF                              MOV     R7,A
 1552: 1  2519  A1 94                           AJMP    OUTR0
 1553: 1                                ;
 1554: 1                                ; First, force exponential output, if need to
 1555: 1                                ;
 1556: 1  251B  EE              FREE:           MOV     A,R6                            ;GET THE EXPONENT
 1557: 1  251C  70 04                           JNZ     FREE1                           ;IF ZERO, PRINT IT
 1558: 1  251E  B1 E3                           ACALL   SOUT
 1559: 1  2520  A1 DF                           AJMP    ZOUT
 1560: 1                                ;
 1561: 1  2522  7B F0           FREE1:          MOV     R3,#0F0H                        ;IN CASE EXP NEEDED
 1562: 1  2524  74 77                           MOV     A,#80H-DIGIT-DIGIT-1
 1563: 1  2526  2E                              ADD     A,R6
 1564: 1  2527  40 21                           JC      EXPOUT
 1565: 1  2529  94 F7                           SUBB    A,#0F7H
 1566: 1  252B  40 1D                           JC      EXPOUT
 1567: 1                                ;
 1568: 1                                ; Now, just print the number
 1569: 1                                ;
 1570: 1  252D  B1 D4                           ACALL   SINOUT                          ;PRINT THE SIGN OF THE NUMBER
 1571: 1  252F  B1 B0                           ACALL   NUM_LT                          ;GET THE NUMBER LEFT OF DP
 1572: 1  2531  B4 08 02                        CJNE    A,#8,FREE4
 1573: 1  2534  A1 94                           AJMP    OUTR0
 1574: 1                                ;
 1575: 1  2536  B1 94           FREE4:          ACALL   OUTR0
 1576: 1  2538  B1 A6                           ACALL   ZTEST                           ;TEST FOR TRAILING ZEROS
 1577: 1  253A  60 57                           JZ      U_RET                           ;DONE IF ALL TRAILING ZEROS
 1578: 1  253C  B1 DB                           ACALL   ROUT                            ;OUTPUT RADIX
 1579: 1                                ;
 1580: 1  253E  7F 01           FREE2:          MOV     R7,#1                           ;OUTPUT ONE DIGIT
 1581: 1  2540  B1 94                           ACALL   OUTR0
 1582: 1  2542  70 4F                           JNZ     U_RET
 1583: 1  2544  B1 A6                           ACALL   ZTEST
 1584: 1  2546  60 4B                           JZ      U_RET
 1585: 1  2548  80 F4                           SJMP    FREE2                           ;LOOP
 1586: 1                                ;
 1587: 1  254A  B1 D4           EXPOUT:         ACALL   SINOUT                          ;PRINT THE SIGN
 1588: 1  254C  7F 01                           MOV     R7,#1                           ;OUTPUT ONE CHARACTER
 1589: 1  254E  B1 94                           ACALL   OUTR0
 1590: 1  2550  B1 DB                           ACALL   ROUT                            ;OUTPUT RADIX
 1591: 1  2552  EB                              MOV     A,R3                            ;GET FORMAT
 1592: 1  2553  54 0F                           ANL     A,#0FH                          ;STRIP INDICATOR
 1593: 1  2555  60 06                           JZ      EXPOTX
 1594: 1                                ;
 1595: 1  2557  FF                              MOV     R7,A                            ;OUTPUT THE NUMBER OF DIGITS
 1596: 1  2558  1F                              DEC     R7                              ;ADJUST BECAUSE ONE CHAR ALREADY OUT
 1597: 1  2559  B1 94                           ACALL   OUTR0
 1598: 1  255B  80 02                           SJMP    EXPOT4
 1599: 1                                ;
 1600: 1  255D  B1 3E           EXPOTX:         ACALL   FREE2                           ;OUTPUT UNTIL TRAILING ZEROS
 1601: 1                                ;
 1602: 1  255F  B1 E3           EXPOT4:         ACALL   SOUT                            ;OUTPUT A SPACE
 1603: 1  2561  7D 45                           MOV     R5,#'E'
 1604: 1  2563  B1 E5                           ACALL   SOUT1                           ;OUTPUT AN E
 1605: 1  2565  EE                              MOV     A,R6                            ;GET THE EXPONENT
 1606: 1  2566  60 04                           JZ      XOUT0                           ;EXIT IF ZERO
 1607: 1  2568  14                              DEC     A                               ;ADJUST FOR THE DIGIT ALREADY OUTPUT
 1608: 1  2569  B4 80 05                        CJNE    A,#80H,XOUT2                    ;SEE WHAT IT IS
 1609: 1                                ;
 1610: 1  256C  B1 E3           XOUT0:          ACALL   SOUT
 1611: 1  256E  E4                              CLR     A
 1612: 1  256F  80 0C                           SJMP    XOUT4
 1613: 1                                ;
 1614: 1  2571  40 06           XOUT2:          JC      XOUT3                           ;NEGATIVE EXPONENT
 1615: 1  2573  7D 2B                           MOV     R5,#'+'                         ;OUTPUT A PLUS SIGN
 1616: 1  2575  B1 E5                           ACALL   SOUT1
 1617: 1  2577  80 04                           SJMP    XOUT4
 1618: 1                                ;
 1619: 1  2579  B1 D7           XOUT3:          ACALL   MOUT
 1620: 1  257B  F4                              CPL     A                               ;FLIP BITS
 1621: 1  257C  04                              INC     A                               ;BUMP
 1622: 1                                ;
 1623: 1  257D  C2 E7           XOUT4:          CLR     ACC.7
 1624: 1  257F  F8                              MOV     R0,A
 1625: 1  2580  7A 00                           MOV     R2,#0
 1626: 1  2582  79 48                           MOV     R1,#LOW CONVT                   ;CONVERSION LOCATION
 1627: 1  2584  7B 00                           MOV     R3,#HIGH CONVT
 1628: 1  2586  D1 40                           ACALL   CONVERT_BINARY_TO_ASCII_STRING
 1629: 1  2588  78 48                           MOV     R0,#LOW CONVT                   ;NOW, OUTPUT EXPONENT
 1630: 1                                ;
 1631: 1  258A  E2              EXPOT5:         MOVX    A,@R0                           ;GET THE CHARACTER
 1632: 1  258B  FD                              MOV     R5,A                            ;OUTPUT IT
 1633: 1  258C  B1 E5                           ACALL   SOUT1
 1634: 1  258E  08                              INC     R0                              ;BUMP THE POINTER
 1635: 1  258F  E8                              MOV     A,R0                            ;GET THE POINTER
 1636: 1  2590  B5 01 F7                        CJNE    A,R1B0,EXPOT5                   ;LOOP
 1637: 1                                ;
 1638: 1  2593  22              U_RET:          RET                                     ;EXIT
 1639: 1                                ;
 1640: 1  2594                  OUTR0:  ; Output the characters pointed to by R0, also bias ascii
 1641: 1                                ;
 1642: 1  2594  EF                              MOV     A,R7                            ;GET THE COUNTER
 1643: 1  2595  60 0E                           JZ      OUTR                            ;EXIT IF DONE
 1644: 1  2597  E6                              MOV     A,@R0                           ;GET THE NUMBER
 1645: 1  2598  44 30                           ORL     A,#30H                          ;ASCII BIAS
 1646: 1  259A  08                              INC     R0                              ;BUMP POINTER AND COUNTER
 1647: 1  259B  1F                              DEC     R7
 1648: 1  259C  FD                              MOV     R5,A                            ;PUT CHARACTER IN OUTPUT REGISTER
 1649: 1  259D  B1 E5                           ACALL   SOUT1                           ;OUTPUT THE CHARACTER
 1650: 1  259F  E4                              CLR     A                               ;JUST FOR TEST
 1651: 1  25A0  B8 33 F1                        CJNE    R0,#FP_NIB8+1,OUTR0
 1652: 1  25A3  74 55                           MOV     A,#55H                          ;KNOW WHERE EXIT OCCURED
 1653: 1                                ;
 1654: 1  25A5  22              OUTR:           RET
 1655: 1                                ;
 1656: 1  25A6  A9 00           ZTEST:          MOV     R1,R0B0                         ;GET POINTER REGISTER
 1657: 1                                ;
 1658: 1  25A8  E7              ZT0:            MOV     A,@R1                           ;GET THE VALUE
 1659: 1  25A9  70 04                           JNZ     ZT1
 1660: 1  25AB  09                              INC     R1                              ;BUMP POINTER
 1661: 1  25AC  B9 33 F9                        CJNE    R1,#FP_NIB8+1,ZT0
 1662: 1                                ;
 1663: 1  25AF  22              ZT1:            RET
 1664: 1                                ;
 1665: 1  25B0  EE              NUM_LT:         MOV     A,R6                            ;GET EXPONENT
 1666: 1  25B1  C3                              CLR     C                               ;GET READY FOR SUBB
 1667: 1  25B2  94 80                           SUBB    A,#80H                          ;SUB EXPONENT BIAS
 1668: 1  25B4  50 01                           JNC     NL1                             ;OK IF NO CARRY
 1669: 1  25B6  E4                              CLR     A                               ;NO DIGITS LEFT
 1670: 1                                ;
 1671: 1  25B7  FF              NL1:            MOV     R7,A                            ;SAVE THE COUNT
 1672: 1  25B8  22                              RET
 1673: 1                                ;
 1674: 1  25B9  C3              NUM_RT:         CLR     C                               ;SUBB AGAIN
 1675: 1  25BA  74 80                           MOV     A,#80H                          ;EXPONENT BIAS
 1676: 1  25BC  9E                              SUBB    A,R6                            ;GET THE BIASED EXPONENT
 1677: 1  25BD  50 01                           JNC     NR1
 1678: 1  25BF  E4                              CLR     A
 1679: 1                                ;
 1680: 1  25C0  22              NR1:            RET                                     ;EXIT
 1681: 1                                ;
 1682: 1  25C1  EF              SPACE7:         MOV     A,R7                            ;GET THE NUMBER OF SPACES
 1683: 1  25C2  60 FC                           JZ      NR1                             ;EXIT IF ZERO
 1684: 1  25C4  B1 E3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1685: 1  25C6  1F                              DEC     R7                              ;BUMP COUNTER
 1686: 1  25C7  80 F8                           SJMP    SPACE7                          ;LOOP
 1687: 1                                ;
 1688: 1  25C9  FF              Z7R7:           MOV     R7,A
 1689: 1                                ;
 1690: 1  25CA  EF              ZERO7:          MOV     A,R7                            ;GET COUNTER
 1691: 1  25CB  60 F3                           JZ      NR1                             ;EXIT IF ZERO
 1692: 1  25CD  B1 DF                           ACALL   ZOUT                            ;OUTPUT A ZERO
 1693: 1  25CF  1F                              DEC     R7                              ;BUMP COUNTER
 1694: 1  25D0  80 F8                           SJMP    ZERO7                           ;LOOP
 1695: 1                                ;
 1696: 1  25D2  B1 C1           SS7:            ACALL   SPACE7
 1697: 1                                ;
 1698: 1  25D4  EC              SINOUT:         MOV     A,R4                            ;GET THE SIGN
 1699: 1  25D5  60 0C                           JZ      SOUT                            ;OUTPUT A SPACE IF ZERO
 1700: 1                                ;
 1701: 1  25D7  7D 2D           MOUT:           MOV     R5,#'-'
 1702: 1  25D9  80 0A                           SJMP    SOUT1                           ;OUTPUT A MINUS IF NOT
 1703: 1                                ;
 1704: 1  25DB  7D 2E           ROUT:           MOV     R5,#'.'                         ;OUTPUT A RADIX
 1705: 1  25DD  80 06                           SJMP    SOUT1
 1706: 1                                ;
 1707: 1  25DF  7D 30           ZOUT:           MOV     R5,#'0'                         ;OUTPUT A ZERO
 1708: 1  25E1  80 02                           SJMP    SOUT1
 1709: 1                                ;
 1710: 1  25E3  7D 20           SOUT:           MOV     R5,#' '                         ;OUTPUT A SPACE
 1711: 1                                ;
 1712: 1  25E5  C1 C1           SOUT1:          AJMP    R5OUT
 1713: 1                                ;
 1714: 1                                ;***************************************************************
 1715: 1                                ;
 1716: 1  25E7                  CONVERT_ASCII_STRING_TO_BINARY:
 1717: 1                                ;
 1718: 1                                ;DPTR POINTS TO ASCII STRING
 1719: 1                                ;PUT THE BINARY NUMBER IN R2:R0, ERROR IF >64K
 1720: 1                                ;
 1721: 1                                ;***************************************************************
 1722: 1                                ;
 1723: 1  25E7  71 D2           CASB:           ACALL   HEXSCAN                         ;SEE IF HEX NUMBER
 1724: 1  25E9  92 33                           MOV     ADD_IN,C                        ;IF ADD_IN IS SET, THE NUMBER IS HEX
 1725: 1  25EB  D1 B4                           ACALL   GET_DIGIT_CHECK
 1726: 1  25ED  B3                              CPL     C                               ;FLIP FOR EXIT
 1727: 1  25EE  40 28                           JC      RCASB
 1728: 1  25F0  7B 00                           MOV     R3,#00H                         ;ZERO R3:R1 FOR LOOP
 1729: 1  25F2  79 00                           MOV     R1,#00H
 1730: 1  25F4  80 15                           SJMP    CASB5
 1731: 1                                ;
 1732: 1  25F6  A3              CASB2:          INC     DPTR
 1733: 1  25F7  89 00                           MOV     R0B0,R1                         ;SAVE THE PRESENT CONVERTED VALUE
 1734: 1  25F9  8B 02                           MOV     R0B0+2,R3                       ;IN R2:R0
 1735: 1  25FB  D1 B4                           ACALL   GET_DIGIT_CHECK
 1736: 1  25FD  40 0C                           JC      CASB5
 1737: 1  25FF  30 33 16                        JNB     ADD_IN,RCASB                    ;CONVERSION COMPLETE
 1738: 1  2602  71 F2                           ACALL   HEX_CHECK                       ;SEE IF HEX NUMBER
 1739: 1  2604  40 03                           JC      CASB4                           ;PROCEED IF GOOD
 1740: 1  2606  A3                              INC     DPTR                            ;BUMP PAST H
 1741: 1  2607  80 0F                           SJMP    RCASB
 1742: 1                                ;
 1743: 1  2609  24 09           CASB4:          ADD     A,#9                            ;ADJUST HEX ASCII BIAS
 1744: 1                                ;
 1745: 1  260B  75 F0 0A        CASB5:          MOV     B,#10
 1746: 1  260E  30 33 03                        JNB     ADD_IN,CASB6
 1747: 1  2611  75 F0 10                        MOV     B,#16                           ;HEX MODE
 1748: 1                                ;
 1749: 1  2614  D1 1F           CASB6:          ACALL   MULNUM                          ;ACCUMULATE THE DIGITS
 1750: 1  2616  50 DE                           JNC     CASB2                           ;LOOP IF NO CARRY
 1751: 1                                ;
 1752: 1  2618  E4              RCASB:          CLR     A                               ;RESET ACC
 1753: 1  2619  92 E1                           MOV     ACC.OVERFLOW,C                  ;IF OVERFLOW, SAY SO
 1754: 1  261B  22                              RET                                     ;EXIT
 1755: 1                                ;
 1756: 1                                ;
 1757: 1  261C  75 F0 0A        MULNUM10:       MOV     B,#10
 1758: 1                                ;
 1759: 1                                ;***************************************************************
 1760: 1                                ;
 1761: 1  261F                  MULNUM: ; Take the next digit in the acc (masked to 0FH)
 1762: 1                                ; accumulate in R3:R1
 1763: 1                                ;
 1764: 1                                ;***************************************************************
 1765: 1                                ;
 1766: 1  261F  C0 E0                           PUSH    ACC                             ;SAVE ACC
 1767: 1  2621  C0 F0                           PUSH    B                               ;SAVE MULTIPLIER
 1768: 1  2623  E9                              MOV     A,R1                            ;PUT LOW ORDER BITS IN ACC
 1769: 1  2624  A4                              MUL     AB                              ;DO THE MULTIPLY
 1770: 1  2625  F9                              MOV     R1,A                            ;PUT THE RESULT BACK
 1771: 1  2626  EB                              MOV     A,R3                            ;GET THE HIGH ORDER BYTE
 1772: 1  2627  AB F0                           MOV     R3,B                            ;SAVE THE OVERFLOW
 1773: 1  2629  D0 F0                           POP     B                               ;GET THE MULTIPLIER
 1774: 1  262B  A4                              MUL     AB                              ;DO IT
 1775: 1  262C  A2 D2                           MOV     C,OV                            ;SAVE OVERFLOW IN F0
 1776: 1  262E  92 D5                           MOV     F0,C
 1777: 1  2630  2B                              ADD     A,R3                            ;ADD OVERFLOW TO HIGH RESULT
 1778: 1  2631  FB                              MOV     R3,A                            ;PUT IT BACK
 1779: 1  2632  D0 E0                           POP     ACC                             ;GET THE ORIGINAL ACC BACK
 1780: 1  2634  72 D5                           ORL     C,F0                            ;OR CARRY AND OVERFLOW
 1781: 1  2636  40 07                           JC      MULX                            ;NO GOOD IF THE CARRY IS SET
 1782: 1                                ;
 1783: 1  2638  54 0F           MUL11:          ANL     A,#0FH                          ;MASK OFF HIGH ORDER BITS
 1784: 1  263A  29                              ADD     A,R1                            ;NOW ADD THE ACC
 1785: 1  263B  F9                              MOV     R1,A                            ;PUT IT BACK
 1786: 1  263C  E4                              CLR     A                               ;PROPAGATE THE CARRY
 1787: 1  263D  3B                              ADDC    A,R3
 1788: 1  263E  FB                              MOV     R3,A                            ;PUT IT BACK
 1789: 1                                ;
 1790: 1  263F  22              MULX:           RET                                     ;EXIT WITH OR WITHOUT CARRY
 1791: 1                                ;
 1792: 1                                ;***************************************************************
 1793: 1                                ;
 1794: 1  2640                  CONVERT_BINARY_TO_ASCII_STRING:
 1795: 1                                ;
 1796: 1                                ;R3:R1 contains the address of the string
 1797: 1                                ;R2:R0 contains the value to convert
 1798: 1                                ;DPTR, R7, R6, and ACC gets clobbered
 1799: 1                                ;
 1800: 1                                ;***************************************************************
 1801: 1                                ;
 1802: 1  2640  E4                              CLR     A                               ;NO LEADING ZEROS
 1803: 1  2641  90 27 10                        MOV     DPTR,#10000                     ;SUBTRACT 10000
 1804: 1  2644  D1 5D                           ACALL   RSUB                            ;DO THE SUBTRACTION
 1805: 1  2646  90 03 E8                        MOV     DPTR,#1000                      ;NOW 1000
 1806: 1  2649  D1 5D                           ACALL   RSUB
 1807: 1  264B  90 00 64                        MOV     DPTR,#100                       ;NOW 100
 1808: 1  264E  D1 5D                           ACALL   RSUB
 1809: 1  2650  90 00 0A                        MOV     DPTR,#10                        ;NOW 10
 1810: 1  2653  D1 5D                           ACALL   RSUB
 1811: 1  2655  90 00 01                        MOV     DPTR,#1                         ;NOW 1
 1812: 1  2658  D1 5D                           ACALL   RSUB
 1813: 1  265A  60 20                           JZ      RSUB2                           ;JUMP OVER RET
 1814: 1                                ;
 1815: 1  265C  22              RSUB_R:         RET
 1816: 1                                ;
 1817: 1  265D  7E FF           RSUB:           MOV     R6,#-1                          ;SET UP THE COUNTER
 1818: 1                                ;
 1819: 1  265F  0E              RSUB1:          INC     R6                              ;BUMP THE COUNTER
 1820: 1  2660  CA                              XCH     A,R2                            ;DO A FAST COMPARE
 1821: 1  2661  B5 83 00                        CJNE    A,DPH,$+3
 1822: 1  2664  CA                              XCH     A,R2
 1823: 1  2665  40 12                           JC      FAST_DONE
 1824: 1  2667  C8                              XCH     A,R0                            ;GET LOW BYTE
 1825: 1  2668  95 82                           SUBB    A,DPL                           ;SUBTRACT, CARRY IS CLEARED
 1826: 1  266A  C8                              XCH     A,R0                            ;PUT IT BACK
 1827: 1  266B  CA                              XCH     A,R2                            ;GET THE HIGH BYTE
 1828: 1  266C  95 83                           SUBB    A,DPH                           ;ADD THE HIGH BYTE
 1829: 1  266E  CA                              XCH     A,R2                            ;PUT IT BACK
 1830: 1  266F  50 EE                           JNC     RSUB1                           ;LOOP UNTIL CARRY
 1831: 1                                ;
 1832: 1  2671  C8                              XCH     A,R0
 1833: 1  2672  25 82                           ADD     A,DPL                           ;RESTORE R2:R0
 1834: 1  2674  C8                              XCH     A,R0
 1835: 1  2675  CA                              XCH     A,R2
 1836: 1  2676  35 83                           ADDC    A,DPH
 1837: 1  2678  CA                              XCH     A,R2
 1838: 1                                ;
 1839: 1  2679                  FAST_DONE:
 1840: 1                                ;
 1841: 1  2679  4E                              ORL     A,R6                            ;OR THE COUNT VALUE
 1842: 1  267A  60 E0                           JZ      RSUB_R                          ;RETURN IF ZERO
 1843: 1                                ;
 1844: 1  267C  74 30           RSUB2:          MOV     A,#'0'                          ;GET THE ASCII BIAS
 1845: 1  267E  2E                              ADD     A,R6                            ;ADD THE COUNT
 1846: 1                                ;
 1847: 1  267F  8B A0           RSUB4:          MOV     P2,R3                           ;SET UP P2
 1848: 1  2681  F3                              MOVX    @R1,A                           ;PLACE THE VALUE IN MEMORY
 1849: 1  2682  09                              INC     R1
 1850: 1  2683  B9 00 01                        CJNE    R1,#00H,RSUB3                   ;SEE IF RAPPED AROUND
 1851: 1  2686  0B                              INC     R3                              ;BUMP HIGH BYTE
 1852: 1                                ;
 1853: 1  2687  22              RSUB3:          RET                                     ;EXIT
 1854: 1                                ;
 1855: 1                                ;***************************************************************
 1856: 1                                ;
 1857: 1  2688                  FPHEXOUT:       ; Output the hex number in R3:R1, supress leading zeros, if set
 1858: 1                                ;
 1859: 1                                ;***************************************************************
 1860: 1                                ;
 1861: 1  2688  B1 E3                           ACALL   SOUT                            ;OUTPUT A SPACE
 1862: 1  268A  A2 36                           MOV     C,ZSURP                         ;GET ZERO SUPPRESSION BIT
 1863: 1  268C  92 33                           MOV     ADD_IN,C
 1864: 1  268E  EB                              MOV     A,R3                            ;GET HIGH NIBBLE AND PRINT IT
 1865: 1  268F  D1 AB                           ACALL   HOUTHI
 1866: 1  2691  EB                              MOV     A,R3
 1867: 1  2692  D1 AC                           ACALL   HOUTLO
 1868: 1                                ;
 1869: 1  2694  C2 33           HEX2X:          CLR     ADD_IN                          ;DON'T SUPPRESS ZEROS
 1870: 1  2696  E9                              MOV     A,R1                            ;GET LOW NIBBLE AND PRINT IT
 1871: 1  2697  D1 AB                           ACALL   HOUTHI
 1872: 1  2699  E9                              MOV     A,R1
 1873: 1  269A  D1 AC                           ACALL   HOUTLO
 1874: 1  269C  7D 48                           MOV     R5,#'H'                         ;OUTPUT H TO INDICATE HEX MODE
 1875: 1                                ;
 1876: 1  269E  A1 E5           SOUT_1:         AJMP    SOUT1
 1877: 1                                ;
 1878: 1  26A0  C2 33           HOUT1:          CLR     ADD_IN                          ;PRINTED SOMETHING, SO CLEAR ADD_IN
 1879: 1  26A2  24 90                           ADD     A,#90H                          ;CONVERT TO ASCII
 1880: 1  26A4  D4                              DA      A
 1881: 1  26A5  34 40                           ADDC    A,#40H
 1882: 1  26A7  D4                              DA      A                               ;GOT IT HERE
 1883: 1  26A8  FD                              MOV     R5,A                            ;OUTPUT THE BYTE
 1884: 1  26A9  80 F3                           SJMP    SOUT_1
 1885: 1                                ;
 1886: 1  26AB  C4              HOUTHI:         SWAP    A                               ;SWAP TO OUTPUT HIGH NIBBLE
 1887: 1                                ;
 1888: 1  26AC  54 0F           HOUTLO:         ANL     A,#0FH                          ;STRIP
 1889: 1  26AE  70 F0                           JNZ     HOUT1                           ;PRINT IF NOT ZERO
 1890: 1  26B0  30 33 ED                        JNB     ADD_IN,HOUT1                    ;OUTPUT A ZERO IF NOT SUPRESSED
 1891: 1  26B3  22                              RET
 1892: 1                                ;
 1893: 1                                ;
 1894: 1  26B4                  GET_DIGIT_CHECK:        ; Get a character, then check for digit
 1895: 1                                ;
 1896: 1  26B4  91 A8                           ACALL   GET_DPTR_CHARACTER
 1897: 1                                ;
 1898: 1  26B6                  DIGIT_CHECK:    ;CHECK FOR A VALID ASCII DIGIT, SET CARRY IF FOUND
 1899: 1                                ;
 1900: 1  26B6  B4 3A 00                        CJNE    A,#'9'+1,$+3                    ;SEE IF ASCII 9 OR LESS
 1901: 1  26B9  40 01                           JC      DC1
 1902: 1  26BB  22                              RET
 1903: 1                                ;
 1904: 1  26BC  B4 30 00        DC1:            CJNE    A,#'0',$+3                      ;SEE IF ASCII 0 OR GREATER
 1905: 1  26BF  B3                              CPL     C
 1906: 1  26C0  22                              RET
 1907: 1                                ;
 1908: 1
 1909: 1  26C1  C0 E0           R5OUT:          PUSH    ACC                             ; ME
 1910: 1  26C3  C0 00                           PUSH    00H
 1911: 1  26C5  A8 50                           MOV     R0,FPCHR_OUT
 1912: 1  26C7  ED                              MOV     A,R5                            ; ME
 1913: 1  26C8  F6                              MOV     @R0,A
 1914: 1  26C9  05 50                           INC     FPCHR_OUT
 1915: 1  26CB  D0 00                           POP     00H
 1916: 1  26CD  D0 E0                           POP     ACC                             ; ME
 1917: 1  26CF  22                              RET                                     ; ME
 1918: 1
 1919: 1  26D0  01 E7           SQ_ERR:         JMP     BADPRM                          ; me
 1920: 1
 1921: 1                                ;***************************************************************
 1922: 1                                ;
 1923: 1  26D2                  IFIX:   ; Convert a floating point number to an integer, put in R3:R1
 1924: 1                                ;
 1925: 1                                ;***************************************************************
 1926: 1                                ;
 1927: 1  26D2  E4                              CLR     A                               ;RESET THE START
 1928: 1  26D3  FB                              MOV     R3,A
 1929: 1  26D4  F9                              MOV     R1,A
 1930: 1  26D5  A8 24                           MOV     R0,ARG_STACK                    ;GET THE ARG STACK
 1931: 1  26D7  75 A0 01                        MOV     P2,#ARG_STACK_PAGE
 1932: 1  26DA  E2                              MOVX    A,@R0                           ;READ EXPONENT
 1933: 1  26DB  C3                              CLR     C
 1934: 1  26DC  94 81                           SUBB    A,#81H                          ;BASE EXPONENT
 1935: 1  26DE  FC                              MOV     R4,A                            ;SAVE IT
 1936: 1  26DF  18                              DEC     R0                              ;POINT AT SIGN
 1937: 1  26E0  E2                              MOVX    A,@R0                           ;GET THE SIGN
 1938: 1  26E1  70 ED                           JNZ     SQ_ERR                          ;ERROR IF NEGATIVE
 1939: 1  26E3  40 17                           JC      INC_ASTKA                       ;EXIT IF EXPONENT IS < 81H
 1940: 1  26E5  0C                              INC     R4                              ;ADJUST LOOP COUNTER
 1941: 1  26E6  E8                              MOV     A,R0                            ;BUMP THE POINTER REGISTER
 1942: 1  26E7  94 05                           SUBB    A,#FP_NUMBER_SIZE-1
 1943: 1  26E9  F8                              MOV     R0,A
 1944: 1                                ;
 1945: 1  26EA  08              I2:             INC     R0                              ;POINT AT DIGIT
 1946: 1  26EB  E2                              MOVX    A,@R0                           ;GET DIGIT
 1947: 1  26EC  C4                              SWAP    A                               ;FLIP
 1948: 1  26ED  11 D4                           CALL    FP_BASE+20                      ;ACCUMULATE
 1949: 1  26EF  40 DF                           JC      SQ_ERR
 1950: 1  26F1  DC 02                           DJNZ    R4,$+4
 1951: 1  26F3  80 07                           SJMP    INC_ASTKA
 1952: 1  26F5  E2                              MOVX    A,@R0                           ;GET DIGIT
 1953: 1  26F6  11 D4                           CALL    FP_BASE+20
 1954: 1  26F8  40 D6                           JC      SQ_ERR
 1955: 1  26FA  DC EE                           DJNZ    R4,I2
 1956: 1                        ;
 1957: 1                        ; Pop the ARG STACK and check for overflow
 1958: 1  26FC                  INC_ASTKA:
 1959: 1  26FC  74 06                           MOV     A,#FP_NUMBER_SIZE               ;number to pop
 1960: 1  26FE  80 18                           SJMP    SETREG+1
 1961: 1                        ;
 1962: 1                        ;Push ARG STACK and check for underflow
 1963: 1  2700                  DEC_ASTKA:
 1964: 1  2700  74 FA                           MOV     A,#-FP_NUMBER_SIZE
 1965: 1  2702  25 24                           ADD     A,ARG_STACK
 1966: 1  2704  B4 00 00                        CJNE    A,#0,$+3
 1967: 1  2707  40 45                           JC      E4YY
 1968: 1  2709  F5 24                           MOV     ARG_STACK,A
 1969: 1  270B  F9                              MOV     R1,A
 1970: 1  270C  7B 01                           MOV     R3,#ARG_STACK_PAGE
 1971: 1  270E  22              SRT:            RET
 1972: 1                        ;
 1973: 1  270F  D1 FC           POPAS:          ACALL   INC_ASTKA
 1974: 1  2711  E1 41                           AJMP    VARCOP                          ;COPY THE VARIABLE
 1975: 1                        ;
 1976: 1  2713  F1 00           PUSHAS:         ACALL   DEC_ASTKA
 1977: 1  2715  E1 41                           AJMP    VARCOP
 1978: 1                        ;
 1979: 1  2717  E4              SETREG:         CLR     A                               ;DON'T POP ANYTHING
 1980: 1  2718  A8 24                           MOV     R0,ARG_STACK
 1981: 1  271A  7A 01                           MOV     R2,#ARG_STACK_PAGE
 1982: 1  271C  8A A0                           MOV     P2,R2
 1983: 1  271E  28                              ADD     A,R0
 1984: 1  271F  40 2D                           JC      E4YY
 1985: 1  2721  F5 24                           MOV     ARG_STACK,A
 1986: 1  2723  E2                              MOVX    A,@R0
 1987: 1  2724  22              A_D:            RET
 1988: 1                                ;
 1989: 1  2725  18              DEC3210:        DEC     R0                              ;BUMP THE POINTER
 1990: 1  2726  B8 FF 01                        CJNE    R0,#0FFH,$+4                    ;SEE IF OVERFLOWED
 1991: 1  2729  1A                              DEC     R2                              ;BUMP THE HIGH BYTE
 1992: 1  272A  19                              DEC     R1                              ;BUMP THE POINTER
 1993: 1  272B  B9 FF 01                        CJNE    R1,#0FFH,DEC_R                  ;SEE IF OVERFLOWED
 1994: 1  272E  1B                              DEC     R3                              ;CHANGE THE HIGH BYTE
 1995: 1  272F  22              DEC_R:          RET                                     ;EXIT
 1996: 1                        ;
 1997: 1
 1998: 1
 1999: 1                        ;Routine to copy bottom arg on stack to address in DPTR.
 2000: 1                        ;Does not work over page boundaries.
 2001: 1                        ;Bugs fixed by JKJ/IRC
 2002: 1  2730  F1 17           MOVAS:          ACALL   SETREG                          ;SET UP R2:R0
 2003: 1  2732  AB 83                           MOV     R3,DPH
 2004: 1  2734  A9 82                           MOV     R1,DPL
 2005: 1  2736  8A A0           M_C:            MOV     P2,R2                           ;SET UP THE PORTS
 2006: 1  2738  E2                              MOVX    A,@R0                           ;READ THE VALUE
 2007: 1  2739  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 2008: 1  273B  F3                              MOVX    @R1,A                           ;SAVE IT
 2009: 1  273C  08                              INC     R0
 2010: 1  273D  09                              INC     R1
 2011: 1  273E  DC F6                           DJNZ    R4,M_C                          ;LOOP
 2012: 1  2740  22                              RET                                     ;EXIT
 2013: 1
 2014: 1
 2015: 1                        ; VARCOP - Copy a variable from R2:R0 to R3:R1
 2016: 1  2741  7C 06           VARCOP:         MOV     R4,#FP_NUMBER_SIZE              ;LOAD THE LOOP COUNTER
 2017: 1  2743  8A A0           V_C:            MOV     P2,R2                           ;SET UP THE PORTS
 2018: 1  2745  E2                              MOVX    A,@R0                           ;READ THE VALUE
 2019: 1  2746  8B A0                           MOV     P2,R3                           ;PORT TIME AGAIN
 2020: 1  2748  F3                              MOVX    @R1,A                           ;SAVE IT
 2021: 1  2749  F1 25                           ACALL   DEC3210
 2022: 1  274B  DC F6                           DJNZ    R4,V_C                          ;LOOP
 2023: 1  274D  22                              RET                                     ;EXIT
 2024: 1                        ;
 2025: 1  274E  90 27 89        E4YY:           MOV     DPTR,#EXA
 2026: 1  2751  01 E6                           JMP     PRTERR                          ; me
 2027: 1
 2028: 1                                ; integer operator - INT
 2029: 1  2753  F1 17           AINT:           ACALL   SETREG                          ;SET UP THE REGISTERS, CLEAR CARRY
 2030: 1  2755  94 81                           SUBB    A,#129                          ;SUBTRACT EXPONENT BIAS
 2031: 1  2757  50 0D                           JNC     AI1                             ;JUMP IF ACC > 81H
 2032: 1                                ;
 2033: 1                                ; Force the number to be a zero
 2034: 1                                ;
 2035: 1  2759  D1 FC                           ACALL   INC_ASTKA                       ;BUMP THE STACK
 2036: 1                                ;
 2037: 1  275B  90 27 60        P_Z:            MOV     DPTR,#ZRO                       ;PUT ZERO ON THE STACK
 2038: 1  275E  E1 7B                           AJMP    PUSHC
 2039: 1  2760  00 00 00 00     ZRO:            DB      0,0,0,0,0,0
       1  2764  00 00
 2040: 1                                ;
 2041: 1  2766  94 07           AI1:            SUBB    A,#7
 2042: 1  2768  50 10                           JNC     AI3
 2043: 1  276A  F4                              CPL     A
 2044: 1  276B  04                              INC     A
 2045: 1  276C  FB                              MOV     R3,A
 2046: 1  276D  18                              DEC     R0                              ;POINT AT SIGN
 2047: 1                                ;
 2048: 1  276E  18              AI2:            DEC     R0                              ;NOW AT LSB'S
 2049: 1  276F  E2                              MOVX    A,@R0                           ;READ BYTE
 2050: 1  2770  54 F0                           ANL     A,#0F0H                         ;STRIP NIBBLE
 2051: 1  2772  F2                              MOVX    @R0,A                           ;WRITE BYTE
 2052: 1  2773  DB 01                           DJNZ    R3,$+3
 2053: 1  2775  22                              RET
 2054: 1  2776  E4                              CLR     A
 2055: 1  2777  F2                              MOVX    @R0,A                           ;CLEAR THE LOCATION
 2056: 1  2778  DB F4                           DJNZ    R3,AI2
 2057: 1  277A  22              AI3:            RET                                     ;EXIT
 2058: 1                                ;
 2059: 1                                ; PUSHC - Push constant pointed by DPTR on to the arg stack
 2060: 1  277B  F1 00           PUSHC:          ACALL   DEC_ASTKA
 2061: 1  277D  8B A0                           MOV     P2,R3
 2062: 1  277F  7B 06                           MOV     R3,#FP_NUMBER_SIZE              ;LOOP COUNTER
 2063: 1  2781  E4              PCL:            CLR     A                               ;SET UP A
 2064: 1  2782  93                              MOVC    A,@A+DPTR                       ;LOAD IT
 2065: 1  2783  F3                              MOVX    @R1,A                           ;SAVE IT
 2066: 1  2784  A3                              INC     DPTR                            ;BUMP POINTERS
 2067: 1  2785  19                              DEC     R1
 2068: 1  2786  DB F9                           DJNZ    R3,PCL                          ;LOOP
 2069: 1  2788  22                              RET                                     ;EXIT
 2070: 1                        ;
 2071: 1  2789  41 2D 53 54     EXA:            DB      'A-STACK',0
       1  278D  41 43 4B 00
 2072: 1
 2073:
 2074:                          ;------------------------------------------------------------------
 2075:
 2076:                          ;Binary to decimal converter
 2077:                          ;Converts R7:R6:R5:R4 to decimal pointed to by R0
 2078:                          ;Returns with number of digits in A
 2079:                          ;------------------------------------------------------------------
 2080:    2791  C0 00           BIN2DEC:        PUSH    00h
 2081:    2793  90 27 E7                        MOV     DPTR,#BINDEC
 2082:    2796  7A 0A                           MOV     R2,#0Ah
 2083:    2798  7B 2F           BIN2DEC1:       MOV     R3,#2Fh
 2084:    279A  0B              BIN2DEC2:       INC     R3
 2085:    279B  F1 BA                           ACALL   SUBIT
 2086:    279D  50 FB                           JNC     BIN2DEC2
 2087:    279F  F1 D3                           ACALL   ADDIT
 2088:    27A1  EB                              MOV     A,R3
 2089:    27A2  F6                              MOV     @R0,A
 2090:    27A3  08                              INC     R0
 2091:    27A4  A3                              INC     DPTR
 2092:    27A5  A3                              INC     DPTR
 2093:    27A6  A3                              INC     DPTR
 2094:    27A7  A3                              INC     DPTR
 2095:    27A8  DA EE                           DJNZ    R2,BIN2DEC1
 2096:    27AA  D0 00                           POP     00h
 2097:                                          ;Remove leading zeroes
 2098:    27AC  7A 09                           MOV     R2,#09h
 2099:    27AE  E6              BIN2DEC3:       MOV     A,@R0
 2100:    27AF  B4 30 05                        CJNE    A,#30h,BIN2DEC4
 2101:    27B2  76 20                           MOV     @R0,#20h
 2102:    27B4  08                              INC     R0
 2103:    27B5  DA F7                           DJNZ    R2,BIN2DEC3
 2104:    27B7  0A              BIN2DEC4:       INC     R2
 2105:    27B8  EA                              MOV     A,R2
 2106:    27B9  22                              RET
 2107:
 2108:    27BA  E4              SUBIT:          CLR     A
 2109:    27BB  93                              MOVC    A,@A+DPTR
 2110:    27BC  CC                              XCH     A,R4
 2111:    27BD  C3                              CLR     C
 2112:    27BE  9C                              SUBB    A,R4
 2113:    27BF  FC                              MOV     R4,A
 2114:    27C0  74 01                           MOV     A,#01h
 2115:    27C2  93                              MOVC    A,@A+DPTR
 2116:    27C3  CD                              XCH     A,R5
 2117:    27C4  9D                              SUBB    A,R5
 2118:    27C5  FD                              MOV     R5,A
 2119:    27C6  74 02                           MOV     A,#02h
 2120:    27C8  93                              MOVC    A,@A+DPTR
 2121:    27C9  CE                              XCH     A,R6
 2122:    27CA  9E                              SUBB    A,R6
 2123:    27CB  FE                              MOV     R6,A
 2124:    27CC  74 03                           MOV     A,#03h
 2125:    27CE  93                              MOVC    A,@A+DPTR
 2126:    27CF  CF                              XCH     A,R7
 2127:    27D0  9F                              SUBB    A,R7
 2128:    27D1  FF                              MOV     R7,A
 2129:    27D2  22                              RET
 2130:
 2131:    27D3  E4              ADDIT:          CLR     A
 2132:    27D4  93                              MOVC    A,@A+DPTR
 2133:    27D5  2C                              ADD     A,R4
 2134:    27D6  FC                              MOV     R4,A
 2135:    27D7  74 01                           MOV     A,#01h
 2136:    27D9  93                              MOVC    A,@A+DPTR
 2137:    27DA  3D                              ADDC    A,R5
 2138:    27DB  FD                              MOV     R5,A
 2139:    27DC  74 02                           MOV     A,#02h
 2140:    27DE  93                              MOVC    A,@A+DPTR
 2141:    27DF  3E                              ADDC    A,R6
 2142:    27E0  FE                              MOV     R6,A
 2143:    27E1  74 03                           MOV     A,#03h
 2144:    27E3  93                              MOVC    A,@A+DPTR
 2145:    27E4  3F                              ADDC    A,R7
 2146:    27E5  FF                              MOV     R7,A
 2147:    27E6  22                              RET
 2148:
 2149:    27E7  00 CA 9A 3B     BINDEC:         DB 000h,0CAh,09Ah,03Bh                  ;1000000000
 2150:    27EB  00 E1 F5 05                     DB 000h,0E1h,0F5h,005h                  ; 100000000
 2151:    27EF  80 96 98 00                     DB 080h,096h,098h,000h                  ;  10000000
 2152:    27F3  40 42 0F 00                     DB 040h,042h,0Fh,0000h                  ;   1000000
 2153:    27F7  A0 86 01 00                     DB 0A0h,086h,001h,000h                  ;    100000
 2154:    27FB  10 27 00 00                     DB 010h,027h,000h,000h                  ;     10000
 2155:    27FF  E8 03 00 00                     DB 0E8h,003h,000h,000h                  ;      1000
 2156:    2803  64 00 00 00                     DB 064h,000h,000h,000h                  ;       100
 2157:    2807  0A 00 00 00                     DB 00Ah,000h,000h,000h                  ;        10
 2158:    280B  01 00 00 00                     DB 001h,000h,000h,000h                  ;         1
 2159:
 2160:                          ;------------------------------------------------------------------
 2161:
 2162:                          ;Get LC meter frquency
 2163:                          ;IN:    A Port #8000h value, R3:R1 points to FP buffer
 2164:                          ;OUT:   Nothing
 2165:    280F  C0 03           LCMETERGETFRQ:  PUSH    03h                             ;Save R3
 2166:    2811  C0 01                           PUSH    01h                             ;Save R1
 2167:    2813  90 80 00                        MOV     DPTR,#8000h
 2168:    2816  F0                              MOVX    @DPTR,A                         ;D7, D6
 2169:    2817  74 FA                           MOV     A,#250
 2170:    2819  12 3C 4A                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2171:    281C  74 FA                           MOV     A,#250
 2172:    281E  12 3C 4A                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2173:    2821  74 02                           MOV     A,#02h                          ;CH2, LC Meter
 2174:    2823  12 2A 2B                        LCALL   FRQCOUNT
 2175:    2826  78 40                           MOV     R0,#LCDLINE
 2176:    2828  12 27 91                        LCALL   BIN2DEC
 2177:    282B  78 40                           MOV     R0,#LCDLINE
 2178:    282D  90 00 48                        MOV     DPTR,#CONVT
 2179:    2830  7F 0A                           MOV     R7,#0Ah
 2180:    2832  E6              LCMETERGETFRQ1: MOV     A,@R0
 2181:    2833  F0                              MOVX    @DPTR,A
 2182:    2834  08                              INC     R0
 2183:    2835  A3                              INC     DPTR
 2184:    2836  DF FA                           DJNZ    R7,LCMETERGETFRQ1
 2185:    2838  74 0D                           MOV     A,#0Dh
 2186:    283A  F0                              MOVX    @DPTR,A
 2187:    283B  90 00 48                        MOV     DPTR,#CONVT
 2188:    283E  12 24 0B                        LCALL   FLOATING_POINT_INPUT
 2189:    2841  D0 01                           POP     01h                             ;Restore R1
 2190:    2843  D0 03                           POP     03H                             ;Restore R3
 2191:    2845  12 27 0F                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2192:    2848  22                              RET
 2193:
 2194:                          ;Calculate X=((Fa/Fb)^2)-1
 2195:                          ;IN:    Fa=R2:R0, Fb=R3:R1
 2196:                          ;OUT:   Nothing
 2197:    2849  C0 01           LCCALC:         PUSH    01h
 2198:    284B  C0 03                           PUSH    03h
 2199:    284D  12 27 13                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2200:    2850  D0 02                           POP     02h
 2201:    2852  D0 00                           POP     00h
 2202:    2854  12 27 13                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2203:    2857  12 22 0B                        LCALL   FLOATING_DIV
 2204:    285A  A8 24                           MOV     R0,ARG_STACK
 2205:    285C  7A 01                           MOV     R2,#ARG_STACK_PAGE
 2206:    285E  12 27 13                        LCALL   PUSHAS                          ; PUSH R2:R0 TO ARGUMENT
 2207:    2861  12 21 D6                        LCALL   FLOATING_MUL
 2208:    2864  90 2C E3                        MOV     DPTR,#FPONE
 2209:    2867  12 27 7B                        LCALL   PUSHC                           ; PUSH ARG IN DPTR TO STACK
 2210:    286A  12 20 E8                        LCALL   FLOATING_SUB
 2211:    286D  22                              RET
 2212:
 2213:                          ;Get LC meter frquency F1 and F2. Calculatr LCCA=((F1/F2)^2)-1 and LCCB=LCCA*((1/(2*Pi*F1))^2)*(1/Ccal)
 2214:                          ;IN:    Nothing
 2215:                          ;OUT:   Nothing
 2216:    286E  74 00           LCMETERINIT:    MOV     A,#00h                          ;D6 LC Meter    0=C, 1=L
 2217:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2218:    2870  90 80 00                        MOV     DPTR,#8000h
 2219:    2873  F0                              MOVX    @DPTR,A                         ;D7, D6
 2220:    2874  12 3D 58                        LCALL   LCDCLEAR
 2221:    2877  12 31 27                        LCALL   PRNTCSTRLCD
 2222:    287A  43 61 6C 69                     DB      'Calibrating',0
          287E  62 72 61 74
          2882  69 6E 67 00
 2223:    2886  7F 05                           MOV     R7,#05h
 2224:    2888  C0 07           LCMETERINIT1:   PUSH    07h
 2225:    288A  12 2A 1E                        LCALL   WAITASEC
 2226:    288D  74 2E                           MOV     A,#'.'
 2227:    288F  12 3D 68                        LCALL   LCDCHROUT
 2228:    2892  D0 07                           POP     07h
 2229:    2894  DF F2                           DJNZ    R7,LCMETERINIT1
 2230:    2896  74 00                           MOV     A,#00h                          ;D6 LC Meter    0=C, 1=L
 2231:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2232:    2898  79 60                           MOV     R1,#LOW LCF1
 2233:    289A  7B 00                           MOV     R3,#HIGH LCF1
 2234:    289C  12 28 0F                        LCALL   LCMETERGETFRQ                   ;Get F1
 2235:    289F  74 80                           MOV     A,#80h                          ;D6 LC Meter    0=C, 1=L
 2236:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2237:    28A1  79 68                           MOV     R1,#LOW LCF2
 2238:    28A3  7B 00                           MOV     R3,#HIGH LCF2
 2239:    28A5  12 28 0F                        LCALL   LCMETERGETFRQ                   ;Get F2
 2240:                                          ;Calculate LCCA=((F1/F2)^2)-1
 2241:    28A8  78 60                           MOV     R0,#LOW LCF1
 2242:    28AA  7A 00                           MOV     R2,#HIGH LCF1
 2243:    28AC  79 68                           MOV     R1,#LOW LCF2
 2244:    28AE  7B 00                           MOV     R3,#HIGH LCF2
 2245:    28B0  12 28 49                        LCALL   LCCALC
 2246:                                          ;Save result to LCCA
 2247:    28B3  79 78                           MOV     R1,#LOW LCCA
 2248:    28B5  7B 00                           MOV     R3,#HIGH LCCA
 2249:    28B7  12 27 0F                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2250:                                          ;Calculate A=(1/(2*Pi*F1))^2
 2251:    28BA  90 2C E9                        MOV     DPTR,#FPTWO
 2252:    28BD  12 27 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2253:    28C0  90 2C EF                        MOV     DPTR,#FPPI
 2254:    28C3  12 27 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2255:    28C6  12 21 D6                        LCALL   FLOATING_MUL
 2256:    28C9  78 60                           MOV     R0,#LOW LCF1
 2257:    28CB  7A 00                           MOV     R2,#HIGH LCF1
 2258:    28CD  12 27 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2259:    28D0  12 21 D6                        LCALL   FLOATING_MUL
 2260:    28D3  79 88                           MOV     R1,#LOW LCCT
 2261:    28D5  7B 00                           MOV     R3,#HIGH LCCT
 2262:    28D7  12 27 0F                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2263:    28DA  90 2C E3                        MOV     DPTR,#FPONE
 2264:    28DD  12 27 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2265:    28E0  78 88                           MOV     R0,#LOW LCCT
 2266:    28E2  7A 00                           MOV     R2,#HIGH LCCT
 2267:    28E4  12 27 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2268:    28E7  12 22 0B                        LCALL   FLOATING_DIV
 2269:    28EA  A8 24                           MOV     R0,ARG_STACK
 2270:    28EC  7A 01                           MOV     R2,#ARG_STACK_PAGE
 2271:    28EE  12 27 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2272:    28F1  12 21 D6                        LCALL   FLOATING_MUL
 2273:                                          ;Calculate LCCB=A*LCCA*(1/Ccal)
 2274:    28F4  78 78                           MOV     R0,#LOW LCCA
 2275:    28F6  7A 00                           MOV     R2,#HIGH LCCA
 2276:    28F8  12 27 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2277:    28FB  12 21 D6                        LCALL   FLOATING_MUL
 2278:    28FE  90 2C F5                        MOV     DPTR,#FPCCAL
 2279:    2901  12 27 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2280:    2904  12 22 0B                        LCALL   FLOATING_DIV
 2281:                                          ;Save result to LCCB
 2282:    2907  79 80                           MOV     R1,#LOW LCCB
 2283:    2909  7B 00                           MOV     R3,#HIGH LCCB
 2284:    290B  12 27 0F                        LCALL   POPAS                           ;POP ARGUMENT TO R3:R1
 2285:    290E  E4                              CLR     A
 2286:    290F  90 80 00                        MOV     DPTR,#8000h
 2287:    2912  F0                              MOVX    @DPTR,A                         ;D7, D6
 2288:    2913  12 3D 58                        LCALL   LCDCLEAR
 2289:    2916  22                              RET
 2290:
 2291:                          ;Inductance meter Lx=((F1/F3)^2)-1)*((F1/F2)^2)-1)*((1/(2*Pi*F1))^2)*(1/Ccal)
 2292:                          ;IN:    Nothing
 2293:                          ;OUT:   Nothing
 2294:    2917  74 40           LMETER:         MOV     A,#40h                          ;D6 LC Meter    0=C, 1=L
 2295:    2919  F5 21                           MOV     OUTD7D6,A
 2296:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2297:    291B  79 70                           MOV     R1,#LOW LCF3
 2298:    291D  7B 00                           MOV     R3,#HIGH LCF3
 2299:    291F  12 28 0F                        LCALL   LCMETERGETFRQ                   ;Get F3
 2300:                                          ;Calculate A=((F1/F3)^2)-1
 2301:    2922  78 60                           MOV     R0,#LOW LCF1
 2302:    2924  7A 00                           MOV     R2,#HIGH LCF1
 2303:    2926  79 70                           MOV     R1,#LOW LCF3
 2304:    2928  7B 00                           MOV     R3,#HIGH LCF3
 2305:    292A  12 28 49                        LCALL   LCCALC
 2306:                                          ;Calculate B=A*LCCB
 2307:    292D  78 80                           MOV     R0,#LOW LCCB
 2308:    292F  7A 00                           MOV     R2,#HIGH LCCB
 2309:    2931  12 27 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2310:    2934  12 21 D6                        LCALL   FLOATING_MUL
 2311:    2937  85 24 82                        MOV     DPL,ARG_STACK
 2312:    293A  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 2313:    293D  15 82                           DEC     DPL
 2314:    293F  E0                              MOVX    A,@DPTR
 2315:    2940  05 82                           INC     DPL
 2316:    2942  60 02                           JZ      LMETER1
 2317:    2944  E4                              CLR     A
 2318:    2945  F0                              MOVX    @DPTR,A
 2319:    2946  E0              LMETER1:        MOVX    A,@DPTR
 2320:    2947  B4 80 00                        CJNE    A,#80h,$+3
 2321:    294A  40 02                           JC      LMETER2
 2322:    294C  E4                              CLR     A
 2323:    294D  F0                              MOVX    @DPTR,A
 2324:    294E  75 4E 6E        LMETER2:        MOV     LCDLINE+14,#'n'
 2325:    2951  90 2D 01                        MOV     DPTR,#FPN
 2326:    2954  60 16                           JZ      LMETER3
 2327:    2956  B4 7B 00                        CJNE    A,#7Bh,$+3
 2328:    2959  40 11                           JC      LMETER3
 2329:    295B  75 4E 75                        MOV     LCDLINE+14,#'u'
 2330:    295E  90 2D 07                        MOV     DPTR,#FPU
 2331:    2961  B4 7E 00                        CJNE    A,#7Eh,$+3
 2332:    2964  40 06                           JC      LMETER3
 2333:    2966  75 4E 6D                        MOV     LCDLINE+14,#'m'
 2334:    2969  90 2D 0D                        MOV     DPTR,#FPM
 2335:    296C  12 27 7B        LMETER3:        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2336:    296F  12 21 D6                        LCALL   FLOATING_MUL
 2337:    2972  75 40 4C                        MOV     LCDLINE,#'L'
 2338:    2975  75 41 20                        MOV     LCDLINE+1,#' '
 2339:    2978  75 42 3D                        MOV     LCDLINE+2,#'='
 2340:    297B  75 43 20                        MOV     LCDLINE+3,#' '
 2341:    297E  75 4F 48                        MOV     LCDLINE+15,#'H'
 2342:    2981  75 50 44                        MOV     FPCHR_OUT,#LCDLINE+4
 2343:    2984  75 25 53                        MOV     FORMAT,#53h
 2344:    2987  E5 24                           MOV     A,ARG_STACK
 2345:    2989  C3                              CLR     C
 2346:    298A  94 05                           SUBB    A,#05h
 2347:    298C  F8                              MOV     R0,A
 2348:    298D  12 24 C3                        LCALL   FLOATING_POINT_OUTPUT
 2349:    2990  74 00                           MOV     A,#00h
 2350:    2992  12 3D 63                        LCALL   LCDSETADR
 2351:    2995  78 40                           MOV     R0,#LCDLINE
 2352:    2997  7F 10                           MOV     R7,#10h
 2353:    2999  12 31 51                        LCALL   PRINTSTR
 2354:    299C  02 30 3B                        LJMP    START
 2355:
 2356:                          ;Capacitance meter: Cx=((F1/F3)^2)-1)/((F1/F2)^2)-1)*Ccal
 2357:                          ;IN:    Nothing
 2358:                          ;OUT:   Nothing
 2359:    299F  74 00           CMETER:         MOV     A,#00h                          ;D6 LC Meter    0=C, 1=L
 2360:                                                                                  ;D7 LC Meter    0=F1, 1=F2 (Adding C Cal)
 2361:    29A1  F5 21                           MOV     OUTD7D6,A
 2362:    29A3  79 70                           MOV     R1,#LOW LCF3
 2363:    29A5  7B 00                           MOV     R3,#HIGH LCF3
 2364:    29A7  12 28 0F                        LCALL   LCMETERGETFRQ                   ;Get F3
 2365:                                          ;Calculate A=((F1/F3)^2)-1
 2366:    29AA  78 60                           MOV     R0,#LOW LCF1
 2367:    29AC  7A 00                           MOV     R2,#HIGH LCF1
 2368:    29AE  79 70                           MOV     R1,#LOW LCF3
 2369:    29B0  7B 00                           MOV     R3,#HIGH LCF3
 2370:    29B2  12 28 49                        LCALL   LCCALC
 2371:                                          ;Calculate B=A/LCCA
 2372:    29B5  78 78                           MOV     R0,#LOW LCCA
 2373:    29B7  7A 00                           MOV     R2,#HIGH LCCA
 2374:    29B9  12 27 13                        LCALL   PUSHAS                          ;PUSH R2:R0 TO ARGUMENT
 2375:    29BC  12 22 0B                        LCALL   FLOATING_DIV
 2376:                                          ;Calculate Cx=A/B*Ccal
 2377:    29BF  90 2C F5                        MOV     DPTR,#FPCCAL
 2378:    29C2  12 27 7B                        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2379:    29C5  12 21 D6                        LCALL   FLOATING_MUL
 2380:    29C8  85 24 82                        MOV     DPL,ARG_STACK
 2381:    29CB  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 2382:    29CE  15 82                           DEC     DPL
 2383:    29D0  E0                              MOVX    A,@DPTR
 2384:    29D1  05 82                           INC     DPL
 2385:    29D3  60 02                           JZ      CMETER1
 2386:    29D5  E4                              CLR     A
 2387:    29D6  F0                              MOVX    @DPTR,A
 2388:    29D7  E0              CMETER1:        MOVX    A,@DPTR
 2389:    29D8  75 4E 70                        MOV     LCDLINE+14,#'p'
 2390:    29DB  90 2C FB                        MOV     DPTR,#FPP
 2391:    29DE  60 0B                           JZ      CMETER2
 2392:    29E0  B4 78 00                        CJNE    A,#78h,$+3
 2393:    29E3  40 06                           JC      CMETER2
 2394:    29E5  75 4E 6E                        MOV     LCDLINE+14,#'n'
 2395:    29E8  90 2D 01                        MOV     DPTR,#FPN
 2396:    29EB  12 27 7B        CMETER2:        LCALL   PUSHC                           ;PUSH ARG IN DPTR TO STACK
 2397:    29EE  12 21 D6                        LCALL   FLOATING_MUL
 2398:    29F1  75 40 43                        MOV     LCDLINE,#'C'
 2399:    29F4  75 41 20                        MOV     LCDLINE+1,#' '
 2400:    29F7  75 42 3D                        MOV     LCDLINE+2,#'='
 2401:    29FA  75 43 20                        MOV     LCDLINE+3,#' '
 2402:    29FD  75 4F 46                        MOV     LCDLINE+15,#'F'
 2403:    2A00  75 50 44                        MOV     FPCHR_OUT,#LCDLINE+4
 2404:    2A03  75 25 53                        MOV     FORMAT,#53h
 2405:    2A06  E5 24                           MOV     A,ARG_STACK
 2406:    2A08  C3                              CLR     C
 2407:    2A09  94 05                           SUBB    A,#05h
 2408:    2A0B  F8                              MOV     R0,A
 2409:    2A0C  12 24 C3                        LCALL   FLOATING_POINT_OUTPUT
 2410:    2A0F  74 00                           MOV     A,#00h
 2411:    2A11  12 3D 63                        LCALL   LCDSETADR
 2412:    2A14  78 40                           MOV     R0,#LCDLINE
 2413:    2A16  7F 10                           MOV     R7,#10h
 2414:    2A18  12 31 51                        LCALL   PRINTSTR
 2415:    2A1B  02 30 3B                        LJMP    START
 2416:
 2417:                          ;------------------------------------------------------------------
 2418:
 2419:                          ;Wait loop. Waits 1 second
 2420:                          ;-----------------------------------------------------
 2421:    2A1E  7F F8           WAITASEC:       MOV     R7,#0F8h
 2422:    2A20  7E 33                           MOV     R6,#51
 2423:    2A22  7D 10                           MOV     R5,#16
 2424:    2A24  DF FE           WAITASEC1:      DJNZ    R7,WAITASEC1
 2425:    2A26  DE FC                           DJNZ    R6,WAITASEC1
 2426:    2A28  DD FA                           DJNZ    R5,WAITASEC1
 2427:    2A2A  22                              RET
 2428:
 2429:                          ;Frequency counter. LSB from 74LS393 read at 8001h, TL0, TH0, TF0 bit. 25 bits, max 33554431 Hz
 2430:                          ;IN;    A holds channel (0 to 3). ACC.7 FRQ TTL Active high
 2431:                          ;OUT:   32 Bit result in R7:R6:R5:R4
 2432:                          ;------------------------------------------------------------------
 2433:    2A2B  44 7C           FRQCOUNT:       ORL     A,#7Ch                          ;D0,D1  CHANNEL (0-3)
 2434:                                                                                  ;D2     FRQ     Gate active low
 2435:                                                                                  ;D3     FRQ     Reset active high
 2436:                                                                                  ;D4     ADC     CS Active low
 2437:                                                                                  ;D5     ADC     CLK High to Low transition
 2438:                                                                                  ;D6     ADC     DIN
 2439:                                                                                  ;D7     FRQ TTL  Active high
 2440:    2A2D  90 80 01                        MOV     DPTR,#8001h
 2441:    2A30  F0                              MOVX    @DPTR,A                         ;Reset and gate off
 2442:    2A31  C0 E0                           PUSH    ACC
 2443:    2A33  75 8A 00                        MOV     TL0,#00h
 2444:    2A36  75 8C 00                        MOV     TH0,#00h
 2445:    2A39  E5 89                           MOV     A,TMOD
 2446:    2A3B  D2 E0                           SETB    ACC.0                           ;M00
 2447:    2A3D  C2 E1                           CLR     ACC.1                           ;M01
 2448:    2A3F  D2 E2                           SETB    ACC.2                           ;C/T0#
 2449:    2A41  C2 E3                           CLR     ACC.3                           ;GATE0
 2450:    2A43  F5 89                           MOV     TMOD,A
 2451:    2A45  E5 88                           MOV     A,TCON
 2452:    2A47  D2 E4                           SETB    ACC.4                           ;TR0
 2453:    2A49  C2 E5                           CLR     ACC.5                           ;TF0
 2454:    2A4B  F5 88                           MOV     TCON,A
 2455:    2A4D  D0 E0                           POP     ACC
 2456:    2A4F  54 F3                           ANL     A,#0F3h                         ;D2     FRQ Gate active low
 2457:                                                                                  ;D3     FRQ Reset active high
 2458:    2A51  F0                              MOVX    @DPTR,A                         ;Gate on(low),Reset inactive (low)
 2459:    2A52  51 1E                           ACALL   WAITASEC
 2460:    2A54  D2 E2                           SETB    ACC.2                           ;D2     FRQ Gate active low
 2461:    2A56  F0                              MOVX    @DPTR,A                         ;Stop counting
 2462:    2A57  E0                              MOVX    A,@DPTR
 2463:    2A58  FC                              MOV     R4,A
 2464:    2A59  E5 8A                           MOV     A,TL0
 2465:    2A5B  FD                              MOV     R5,A
 2466:    2A5C  E5 8C                           MOV     A,TH0
 2467:    2A5E  FE                              MOV     R6,A
 2468:    2A5F  E4                              CLR     A                               ;TF0 Is the 25th bit
 2469:    2A60  A2 8D                           MOV     C,TF0
 2470:    2A62  33                              RLC     A
 2471:    2A63  FF                              MOV     R7,A
 2472:    2A64  22                              RET
 2473:
 2474:                          ;Format frequency conter text line
 2475:                          ;IN:    A holds channel (0 to 3)
 2476:                          ;       LCDLINE+4 Decimal result
 2477:                          ;       R7 Number of digits
 2478:                          ;OUT:   Formatted LCDLINE
 2479:    2A65  75 40 43        FRQFORMAT:      MOV     LCDLINE,#'C'
 2480:    2A68  75 41 48                        MOV     LCDLINE+1,#'H'
 2481:    2A6B  44 30                           ORL     A,#30h
 2482:    2A6D  F5 42                           MOV     LCDLINE+2,A
 2483:    2A6F  75 43 20                        MOV     LCDLINE+3,#' '
 2484:    2A72  78 44                           MOV     R0,#LCDLINE+4
 2485:    2A74  79 46                           MOV     R1,#LCDLINE+6
 2486:    2A76  BF 07 00                        CJNE    R7,#07h,$+3
 2487:    2A79  40 19                           JC      FRQFORMATKHZ
 2488:                                          ;MHz
 2489:    2A7B  7F 08                           MOV     R7,#08h
 2490:    2A7D  E7              FRQFORMATMHZ1:  MOV     A,@R1
 2491:    2A7E  BF 06 03                        CJNE    R7,#06h,FRQFORMATMHZ2
 2492:    2A81  76 2E                           MOV     @R0,#'.'
 2493:    2A83  08                              INC     R0
 2494:    2A84  F6              FRQFORMATMHZ2:  MOV     @R0,A
 2495:    2A85  08                              INC     R0
 2496:    2A86  09                              INC     R1
 2497:    2A87  DF F4                           DJNZ    R7,FRQFORMATMHZ1
 2498:    2A89  75 4D 4D                        MOV     LCDLINE+13,#'M'
 2499:    2A8C  75 4E 48                        MOV     LCDLINE+14,#'H'
 2500:    2A8F  75 4F 7A                        MOV     LCDLINE+15,#'z'
 2501:    2A92  80 33                           SJMP    FRQFORMATDONE
 2502:    2A94  BF 04 00        FRQFORMATKHZ:   CJNE    R7,#04h,$+3
 2503:    2A97  40 19                           JC      FRQFORMATHZ
 2504:                                          ;KHz
 2505:    2A99  7F 08                           MOV     R7,#08h
 2506:    2A9B  E7              FRQFORMATKHZ1:  MOV     A,@R1
 2507:    2A9C  BF 03 03                        CJNE    R7,#03h,FRQFORMATKHZ2
 2508:    2A9F  76 2E                           MOV     @R0,#'.'
 2509:    2AA1  08                              INC     R0
 2510:    2AA2  F6              FRQFORMATKHZ2:  MOV     @R0,A
 2511:    2AA3  08                              INC     R0
 2512:    2AA4  09                              INC     R1
 2513:    2AA5  DF F4                           DJNZ    R7,FRQFORMATKHZ1
 2514:    2AA7  75 4D 4B                        MOV     LCDLINE+13,#'K'
 2515:    2AAA  75 4E 48                        MOV     LCDLINE+14,#'H'
 2516:    2AAD  75 4F 7A                        MOV     LCDLINE+15,#'z'
 2517:    2AB0  80 15                           SJMP    FRQFORMATDONE
 2518:    2AB2                  FRQFORMATHZ:    ;Hz
 2519:    2AB2  75 44 20                        MOV     LCDLINE+4,#' '
 2520:    2AB5  08                              INC     R0
 2521:    2AB6  7F 08                           MOV     R7,#08h
 2522:    2AB8  E7              FRQFORMATHZ1:   MOV     A,@R1
 2523:    2AB9  F6                              MOV     @R0,A
 2524:    2ABA  08                              INC     R0
 2525:    2ABB  09                              INC     R1
 2526:    2ABC  DF FA                           DJNZ    R7,FRQFORMATHZ1
 2527:    2ABE  75 4D 48                        MOV     LCDLINE+13,#'H'
 2528:    2AC1  75 4E 7A                        MOV     LCDLINE+14,#'z'
 2529:    2AC4  75 4F 20                        MOV     LCDLINE+15,#' '
 2530:    2AC7  22              FRQFORMATDONE:  RET
 2531:
 2532:                          ;Frequency conter and AD Converter channel 0 and 5
 2533:                          ;IN:    Frequency cont channel (0-3)
 2534:                          ;OUT:   Nothing
 2535:    2AC8  C0 E0           FREQENCYCOUNT:  PUSH    ACC
 2536:    2ACA  12 2A 2B                        LCALL   FRQCOUNT
 2537:    2ACD  78 44                           MOV     R0,#LCDLINE+4                   ;Decimal buffer
 2538:    2ACF  12 27 91                        LCALL   BIN2DEC
 2539:    2AD2  FF                              MOV     R7,A                            ;Number of digits
 2540:    2AD3  D0 E0                           POP     ACC
 2541:    2AD5  54 03                           ANL     A,#03h
 2542:    2AD7  12 2A 65                        LCALL   FRQFORMAT
 2543:    2ADA  74 00                           MOV     A,#00h
 2544:    2ADC  12 3D 63                        LCALL   LCDSETADR
 2545:    2ADF  78 40                           MOV     R0,#LCDLINE                     ;Output result
 2546:    2AE1  7F 10                           MOV     R7,#10h
 2547:    2AE3  12 31 51                        LCALL   PRINTSTR
 2548:    2AE6  74 00                           MOV     A,#00h                          ;ADC Channel 0
 2549:    2AE8  12 2B 2C                        LCALL   ADCONVERT
 2550:    2AEB  74 00                           MOV     A,#00h
 2551:    2AED  79 44                           MOV     R1,#LCDLINE+4
 2552:    2AEF  75 25 22                        MOV     FORMAT,#22h
 2553:    2AF2  12 2B 81                        LCALL   ADOUTPUT
 2554:    2AF5  74 05                           MOV     A,#05h                          ;ADC Channel 5
 2555:    2AF7  12 2B 2C                        LCALL   ADCONVERT
 2556:    2AFA  E8                              MOV     A,R0
 2557:    2AFB  C3                              CLR     C
 2558:    2AFC  94 73                           SUBB    A,#73h
 2559:    2AFE  F8                              MOV     R0,A
 2560:    2AFF  EA                              MOV     A,R2
 2561:    2B00  94 00                           SUBB    A,#00h
 2562:    2B02  50 02                           JNC     FREQENCYCOUNT1
 2563:    2B04  E4                              CLR     A
 2564:    2B05  F8                              MOV     R0,A
 2565:    2B06  FA              FREQENCYCOUNT1: MOV     R2,A
 2566:    2B07  74 05                           MOV     A,#05h
 2567:    2B09  79 4A                           MOV     R1,#LCDLINE+10
 2568:    2B0B  75 25 13                        MOV     FORMAT,#13h
 2569:    2B0E  12 2B 81                        LCALL   ADOUTPUT
 2570:    2B11  75 40 56                        MOV     LCDLINE,#'V'                    ;Output result
 2571:    2B14  75 41 41                        MOV     LCDLINE+1,#'A'
 2572:    2B17  75 42 52                        MOV     LCDLINE+2,#'R'
 2573:    2B1A  75 43 20                        MOV     LCDLINE+3,#' '
 2574:    2B1D  74 40                           MOV     A,#40h
 2575:    2B1F  12 3D 63                        LCALL   LCDSETADR
 2576:    2B22  78 40                           MOV     R0,#LCDLINE
 2577:    2B24  7F 10                           MOV     R7,#10h
 2578:    2B26  12 31 51                        LCALL   PRINTSTR
 2579:    2B29  02 30 3B                        LJMP    START
 2580:
 2581:                          ;------------------------------------------------------------------
 2582:
 2583:                          ;AD Converter.
 2584:                          ;IN:    A holds channel (0 to 7).
 2585:                          ;OUT:   R2:R0 Holds 16 Bit result
 2586:                          ;-----------------------------------------------------
 2587:    2B2C  44 18           ADCONVERT:      ORL     A,#18h                          ;START, SINGLE ENDED
 2588:    2B2E  23                              RL      A
 2589:    2B2F  23                              RL      A
 2590:    2B30  23                              RL      A
 2591:    2B31  FA                              MOV     R2,A
 2592:    2B32  74 7C                           MOV     A,#7Ch                          ;D0,D1 FRQ SEL
 2593:                                                                                  ;D2 FRQ GATE    ACTIVE LOW
 2594:                                                                                  ;D3 FRQ RESET   ACTIVE HIGH
 2595:                                                                                  ;D4 ADC CS      ACTIVE LOW
 2596:                                                                                  ;D5 ADC CLK     HIGH TO LOW TRANSITION
 2597:                                                                                  ;D6 ADC DIN     START,S/D,D2,D1,D0
 2598:                                                                                  ;D7 FRQ TTL     ACTIVE HIGH
 2599:    2B34  90 80 01                        MOV     DPTR,#8001h
 2600:    2B37  F0                              MOVX    @DPTR,A
 2601:                                          ;CS low
 2602:    2B38  C2 E4                           CLR     ACC.4                           ;D4 ADC CS      ACTIVE LOW
 2603:    2B3A  F0                              MOVX    @DPTR,A
 2604:                                          ;Clock in channel select and Single/Diff+2 clocks for sample
 2605:    2B3B  7F 07                           MOV     R7,#07h
 2606:    2B3D  CA              ADCONVERT1:     XCH     A,R2
 2607:    2B3E  33                              RLC     A
 2608:    2B3F  CA                              XCH     A,R2
 2609:    2B40  92 E6                           MOV     ACC.6,C ;ADC DIN
 2610:    2B42  C2 E5                           CLR     ACC.5
 2611:    2B44  F0                              MOVX    @DPTR,A
 2612:    2B45  D2 E5                           SETB    ACC.5
 2613:    2B47  F0                              MOVX    @DPTR,A
 2614:    2B48  DF F3                           DJNZ    R7,ADCONVERT1
 2615:    2B4A  7A 00                           MOV     R2,#00h
 2616:                                          ;Clock in 5 bits, including null bit
 2617:    2B4C  7F 05                           MOV     R7,#05h
 2618:    2B4E  C0 E0           ADCONVERT2:     PUSH    ACC
 2619:    2B50  90 80 00                        MOV     DPTR,#8000h
 2620:    2B53  E0                              MOVX    A,@DPTR
 2621:    2B54  13                              RRC     A
 2622:    2B55  CA                              XCH     A,R2
 2623:    2B56  33                              RLC     A
 2624:    2B57  CA                              XCH     A,R2
 2625:    2B58  90 80 01                        MOV     DPTR,#8001h
 2626:    2B5B  D0 E0                           POP     ACC
 2627:    2B5D  C2 E5                           CLR     ACC.5
 2628:    2B5F  F0                              MOVX    @DPTR,A
 2629:    2B60  D2 E5                           SETB    ACC.5
 2630:    2B62  F0                              MOVX    @DPTR,A
 2631:    2B63  DF E9                           DJNZ    R7,ADCONVERT2
 2632:    2B65  78 00                           MOV     R0,#00h
 2633:                                          ;Clock in 8 bits
 2634:    2B67  7F 08                           MOV     R7,#08h
 2635:    2B69  C0 E0           ADCONVERT3:     PUSH    ACC
 2636:    2B6B  90 80 00                        MOV     DPTR,#8000h
 2637:    2B6E  E0                              MOVX    A,@DPTR
 2638:    2B6F  13                              RRC     A
 2639:    2B70  C8                              XCH     A,R0
 2640:    2B71  33                              RLC     A
 2641:    2B72  C8                              XCH     A,R0
 2642:    2B73  90 80 01                        MOV     DPTR,#8001h
 2643:    2B76  D0 E0                           POP     ACC
 2644:    2B78  C2 E5                           CLR     ACC.5
 2645:    2B7A  F0                              MOVX    @DPTR,A
 2646:    2B7B  D2 E5                           SETB    ACC.5
 2647:    2B7D  F0                              MOVX    @DPTR,A
 2648:    2B7E  DF E9                           DJNZ    R7,ADCONVERT3
 2649:    2B80  22                              RET
 2650:
 2651:                          ;AD Converter output
 2652:                          ;IN:    A holds channel (0 to 7).
 2653:                          ;       R2:R0 adc result
 2654:                          ;       R1 pointer to buffer
 2655:                          ;OUT:   6 Characters
 2656:                          ;-----------------------------------------------------
 2657:    2B81  89 50           ADOUTPUT:       MOV     FPCHR_OUT,R1
 2658:    2B83  C0 E0                           PUSH    ACC
 2659:                                          ;Convert 16 bit integer in R2:R0 to float and push it to fp arg stack
 2660:    2B85  12 23 FF                        LCALL   PUSHR2R0
 2661:                                          ;Push the channelS constant to fp arg stack
 2662:    2B88  90 2C B3                        MOV     DPTR,#ADCMUL
 2663:    2B8B  D0 E0                           POP     ACC
 2664:    2B8D  75 F0 06                        MOV     B,#FP_NUMBER_SIZE
 2665:    2B90  A4                              MUL     AB
 2666:    2B91  25 82                           ADD     A,DPL
 2667:    2B93  F5 82                           MOV     DPL,A
 2668:    2B95  50 02                           JNC     ADOUTPUT1
 2669:    2B97  05 83                           INC     DPH
 2670:    2B99  12 27 7B        ADOUTPUT1:      LCALL   PUSHC
 2671:                                          ;Multiply
 2672:    2B9C  12 21 D6                        LCALL   FLOATING_MUL
 2673:    2B9F  E5 24                           MOV     A,ARG_STACK
 2674:    2BA1  C3                              CLR     C
 2675:    2BA2  94 05                           SUBB    A,#05h
 2676:    2BA4  F8                              MOV     R0,A
 2677:    2BA5  12 24 C3                        LCALL   FLOATING_POINT_OUTPUT
 2678:    2BA8  22                              RET
 2679:
 2680:                          ;AD Converter
 2681:                          ;IN:    Nothing
 2682:                          ;OUT:   Nothing
 2683:    2BA9  74 02           ADCONVERTERINT: MOV     A,#02h                          ;Channel 2
 2684:    2BAB  12 2B 2C                        LCALL   ADCONVERT
 2685:    2BAE  74 02                           MOV     A,#02h
 2686:    2BB0  79 44                           MOV     R1,#LCDLINE+4
 2687:    2BB2  75 25 22                        MOV     FORMAT,#22h
 2688:    2BB5  12 2B 81                        LCALL   ADOUTPUT
 2689:    2BB8  74 06                           MOV     A,#06h                          ;Channel 6
 2690:    2BBA  12 2B 2C                        LCALL   ADCONVERT
 2691:    2BBD  74 06                           MOV     A,#06h
 2692:    2BBF  79 4A                           MOV     R1,#LCDLINE+10
 2693:    2BC1  75 25 13                        MOV     FORMAT,#13h
 2694:    2BC4  12 2B 81                        LCALL   ADOUTPUT
 2695:    2BC7  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2696:    2BCA  75 41 4E                        MOV     LCDLINE+1,#'N'
 2697:    2BCD  75 42 54                        MOV     LCDLINE+2,#'T'
 2698:    2BD0  75 43 20                        MOV     LCDLINE+3,#' '
 2699:    2BD3  74 00                           MOV     A,#00h
 2700:    2BD5  12 3D 63                        LCALL   LCDSETADR
 2701:    2BD8  78 40                           MOV     R0,#LCDLINE
 2702:    2BDA  7F 10                           MOV     R7,#10h
 2703:    2BDC  12 31 51                        LCALL   PRINTSTR
 2704:    2BDF  74 03                           MOV     A,#03h                          ;Channel 3
 2705:    2BE1  12 2B 2C                        LCALL   ADCONVERT
 2706:    2BE4  74 03                           MOV     A,#03h
 2707:    2BE6  79 44                           MOV     R1,#LCDLINE+4
 2708:    2BE8  75 25 22                        MOV     FORMAT,#22h
 2709:    2BEB  12 2B 81                        LCALL   ADOUTPUT
 2710:    2BEE  74 07                           MOV     A,#07h                          ;Channel 7
 2711:    2BF0  12 2B 2C                        LCALL   ADCONVERT
 2712:    2BF3  74 07                           MOV     A,#07h
 2713:    2BF5  79 4A                           MOV     R1,#LCDLINE+10
 2714:    2BF7  75 25 13                        MOV     FORMAT,#13h
 2715:    2BFA  12 2B 81                        LCALL   ADOUTPUT
 2716:    2BFD  75 40 49                        MOV     LCDLINE,#'I'                    ;Output result
 2717:    2C00  75 41 4E                        MOV     LCDLINE+1,#'N'
 2718:    2C03  75 42 54                        MOV     LCDLINE+2,#'T'
 2719:    2C06  75 43 20                        MOV     LCDLINE+3,#' '
 2720:    2C09  74 40                           MOV     A,#40h
 2721:    2C0B  12 3D 63                        LCALL   LCDSETADR
 2722:    2C0E  78 40                           MOV     R0,#LCDLINE
 2723:    2C10  7F 10                           MOV     R7,#10h
 2724:    2C12  12 31 51                        LCALL   PRINTSTR
 2725:    2C15  7F 14                           MOV     R7,#14h
 2726:    2C17  74 FA           ADCONVERTERINT1:MOV     A,#250
 2727:    2C19  12 3C 4A                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2728:    2C1C  DF F9                           DJNZ    R7,ADCONVERTERINT1
 2729:    2C1E  02 30 3B                        LJMP    START
 2730:
 2731:    2C21  74 00           ADCONVERTEREXT: MOV     A,#00h                          ;Channel 0
 2732:    2C23  12 2B 2C                        LCALL   ADCONVERT
 2733:    2C26  74 00                           MOV     A,#00h
 2734:    2C28  79 44                           MOV     R1,#LCDLINE+4
 2735:    2C2A  75 25 22                        MOV     FORMAT,#22h
 2736:    2C2D  12 2B 81                        LCALL   ADOUTPUT
 2737:    2C30  74 05                           MOV     A,#05h                          ;Channel 5
 2738:    2C32  12 2B 2C                        LCALL   ADCONVERT
 2739:    2C35  E8                              MOV     A,R0
 2740:    2C36  C3                              CLR     C
 2741:    2C37  94 73                           SUBB    A,#73h
 2742:    2C39  F8                              MOV     R0,A
 2743:    2C3A  EA                              MOV     A,R2
 2744:    2C3B  94 00                           SUBB    A,#00h
 2745:    2C3D  50 02                           JNC     ADCONVEXT
 2746:    2C3F  E4                              CLR     A
 2747:    2C40  F8                              MOV     R0,A
 2748:    2C41  FA              ADCONVEXT:      MOV     R2,A
 2749:    2C42  74 05                           MOV     A,#05h
 2750:    2C44  79 4A                           MOV     R1,#LCDLINE+10
 2751:    2C46  75 25 13                        MOV     FORMAT,#13h
 2752:    2C49  12 2B 81                        LCALL   ADOUTPUT
 2753:    2C4C  75 40 56                        MOV     LCDLINE,#'V'                    ;Output result
 2754:    2C4F  75 41 41                        MOV     LCDLINE+1,#'A'
 2755:    2C52  75 42 52                        MOV     LCDLINE+2,#'R'
 2756:    2C55  75 43 20                        MOV     LCDLINE+3,#' '
 2757:    2C58  74 00                           MOV     A,#00h
 2758:    2C5A  12 3D 63                        LCALL   LCDSETADR
 2759:    2C5D  78 40                           MOV     R0,#LCDLINE
 2760:    2C5F  7F 10                           MOV     R7,#10h
 2761:    2C61  12 31 51                        LCALL   PRINTSTR
 2762:    2C64  74 01                           MOV     A,#01h                          ;Channel 1
 2763:    2C66  12 2B 2C                        LCALL   ADCONVERT
 2764:    2C69  74 01                           MOV     A,#01h
 2765:    2C6B  79 44                           MOV     R1,#LCDLINE+4
 2766:    2C6D  75 25 22                        MOV     FORMAT,#22h
 2767:    2C70  12 2B 81                        LCALL   ADOUTPUT
 2768:    2C73  74 04                           MOV     A,#04h                          ;Channel 4
 2769:    2C75  12 2B 2C                        LCALL   ADCONVERT
 2770:    2C78  E8                              MOV     A,R0
 2771:    2C79  C3                              CLR     C
 2772:    2C7A  94 73                           SUBB    A,#73h
 2773:    2C7C  F8                              MOV     R0,A
 2774:    2C7D  EA                              MOV     A,R2
 2775:    2C7E  94 00                           SUBB    A,#00h
 2776:    2C80  50 02                           JNC     ADCONVEXT1
 2777:    2C82  E4                              CLR     A
 2778:    2C83  F8                              MOV     R0,A
 2779:    2C84  FA              ADCONVEXT1:     MOV     R2,A
 2780:    2C85  74 04                           MOV     A,#04h
 2781:    2C87  79 4A                           MOV     R1,#LCDLINE+10
 2782:    2C89  75 25 13                        MOV     FORMAT,#13h
 2783:    2C8C  12 2B 81                        LCALL   ADOUTPUT
 2784:    2C8F  75 40 45                        MOV     LCDLINE,#'E'                    ;Output result
 2785:    2C92  75 41 58                        MOV     LCDLINE+1,#'X'
 2786:    2C95  75 42 54                        MOV     LCDLINE+2,#'T'
 2787:    2C98  75 43 20                        MOV     LCDLINE+3,#' '
 2788:    2C9B  74 40                           MOV     A,#40h
 2789:    2C9D  12 3D 63                        LCALL   LCDSETADR
 2790:    2CA0  78 40                           MOV     R0,#LCDLINE
 2791:    2CA2  7F 10                           MOV     R7,#10h
 2792:    2CA4  12 31 51                        LCALL   PRINTSTR
 2793:    2CA7  7F 14                           MOV     R7,#14h
 2794:    2CA9  74 FA           ADCONVERTEREXT1:MOV     A,#250
 2795:    2CAB  12 3C 4A                        LCALL   WAIT                            ;Wait 25ms for relay to kick in / out
 2796:    2CAE  DF F9                           DJNZ    R7,ADCONVERTEREXT1
 2797:    2CB0  02 30 3B                        LJMP    START
 2798:
 2799:                          ;------------------------------------------------------------------
 2800:    2CB3  7E 00 00 07     ADCMUL:         DB 7Eh,00h,00h,07h,03h,52h              ;CH0
          2CB7  03 52
 2801:    2CB9  7E 00 00 07                     DB 7Eh,00h,00h,07h,03h,16h              ;CH1
          2CBD  03 16
 2802:    2CBF  7E 00 00 00                     DB 7Eh,00h,00h,00h,02h,36h              ;CH2
          2CC3  02 36
 2803:    2CC5  7E 00 00 07                     DB 7Eh,00h,00h,07h,03h,16h              ;CH3
          2CC9  03 16
 2804:    2CCB  7D 00 00 00                     DB 7Dh,00h,00h,00h,50h,30h              ;CH4
          2CCF  50 30
 2805:    2CD1  7D 00 00 00                     DB 7Dh,00h,00h,00h,50h,30h              ;CH5
          2CD5  50 30
 2806:    2CD7  00 00 00 00                     DB 00h,00h,00h,00h,00h,00h              ;CH6
          2CDB  00 00
 2807:    2CDD  00 00 00 00                     DB 00h,00h,00h,00h,00h,00h              ;CH7
          2CE1  00 00
 2808:                          ;------------------------------------------------------------------
 2809:    2CE3  81 00 00 00     FPONE:          DB 81h,00h,00h,00h,00h,10h              ;1.0000000
          2CE7  00 10
 2810:    2CE9  81 00 00 00     FPTWO:          DB 81h,00h,00h,00h,00h,20h              ;2.0000000
          2CED  00 20
 2811:    2CEF  81 00 27 59     FPPI:           DB 81h,00h,27h,59h,41h,31h              ;3.1415927
          2CF3  41 31
 2812:    2CF5  77 00 00 00     FPCCAL:         DB 77h,00h,00h,00h,50h,94h              ;1nF=1e-9
          2CF9  50 94
 2813:    2CFB  8D 00 00 00     FPP:            DB 8Dh,00h,00h,00h,00h,10h              ;1e12
          2CFF  00 10
 2814:    2D01  8A 00 00 00     FPN:            DB 8Ah,00h,00h,00h,00h,10h              ;1e9
          2D05  00 10
 2815:    2D07  87 00 00 00     FPU:            DB 87h,00h,00h,00h,00h,10h              ;1e6
          2D0B  00 10
 2816:    2D0D  84 00 00 00     FPM:            DB 84h,00h,00h,00h,00h,10h              ;1e3
          2D11  00 10
 2817:                          ;------------------------------------------------------------------
 2818:
 2819:    2D13  54 65 72 6D     MODE0:          DB 'Terminal',0
          2D17  69 6E 61 6C
          2D1B  00
 2820:    2D1C  46 72 71 20     MODE1:          DB 'Frq Count',0
          2D20  43 6F 75 6E
          2D24  74 00
 2821:    2D26  46 72 71 20     MODE2:          DB 'Frq Count TTL',0
          2D2A  43 6F 75 6E
          2D2E  74 20 54 54
          2D32  4C 00
 2822:    2D34  46 72 71 20     MODE3:          DB 'Frq Count FG',0
          2D38  43 6F 75 6E
          2D3C  74 20 46 47
          2D40  00
 2823:    2D41  46 72 71 20     MODE4:          DB 'Frq Count LC',0
          2D45  43 6F 75 6E
          2D49  74 20 4C 43
          2D4D  00
 2824:    2D4E  46 72 71 20     MODE5:          DB 'Frq Count ALE',0
          2D52  43 6F 75 6E
          2D56  74 20 41 4C
          2D5A  45 00
 2825:    2D5C  56 6F 6C 74     MODE6:          DB 'Volts INT',0
          2D60  73 20 49 4E
          2D64  54 00
 2826:    2D66  56 6F 6C 74     MODE7:          DB 'Volts EXT',0
          2D6A  73 20 45 58
          2D6E  54 00
 2827:    2D70  4C 20 4D 65     MODE8:          DB 'L Meter',0
          2D74  74 65 72 00
 2828:    2D78  43 20 4D 65     MODE9:          DB 'C Meter',0
          2D7C  74 65 72 00
 2829:    2D80  43 61 6C 69     MODE10:         DB 'Calibrating',0
          2D84  62 72 61 74
          2D88  69 6E 67 00
 2830:
 2831:          N      0000     IF DEVMODE=0
 2832:                                          ORG     1000h
 2833:                          ELSE
 2834:          N      3000                     ORG     3000h
 2835:                          ENDIF
 2836:
 2837:    3000  E4              START0:         CLR     A
 2838:    3001  F5 A8                           MOV     IE,A                            ;Disable all interrupts
 2839:    3003  F5 59                           MOV     MODE,A                          ;Set mode to RS232 Terminal
 2840:    3005  F5 21                           MOV     OUTD7D6,A
 2841:    3007  F5 20                           MOV     INTBITS,A                       ;RAM int routines (.0-.5 INTERRUPTS, .6=LCD OUT, .7 Single step)
 2842:    3009  14                              DEC     A
 2843:    300A  F5 5A                           MOV     SSADRLSB,A                      ;Single step adress
 2844:    300C  F5 5B                           MOV     SSADRMSB,A                      ;Single step adress
 2845:    300E  F5 B0                           MOV     P3,A                            ;All bits input
 2846:    3010  75 CA D9                        MOV     RCAP2L,#0D9h                    ;19200bps with 24MHz OSC
 2847:    3013  F5 CB                           MOV     RCAP2H,A
 2848:    3015  75 CC D9                        MOV     TL2,#0D9h
 2849:    3018  F5 CD                           MOV     TH2,A
 2850:    301A  75 C8 34                        MOV     T2CON,#34h                      ;TF2=l
 2851:                                                                                  ;EXF2=l
 2852:                                                                                  ;RCLK=h
 2853:                                                                                  ;TCLK=h
 2854:                                                                                  ;EXEN2=l
 2855:                                                                                  ;TR2=h
 2856:                                                                                  ;C/T2#=l
 2857:                                                                                  ;CP/RL2#=l
 2858:    301D  75 98 50                        MOV     SCON,#50h                       ;SM0=l
 2859:                                                                                  ;SM1=h
 2860:                                                                                  ;SM2=l
 2861:                                                                                  ;REN=h
 2862:                                                                                  ;TB8=l
 2863:                                                                                  ;RB8=l
 2864:                                                                                  ;TI=l
 2865:                                                                                  ;RI=l
 2866:    3020  75 53 01                        MOV     ROMACTION,#01h                  ;Action
 2867:    3023  75 54 02                        MOV     ROMSIZE,#02h                    ;Size
 2868:    3026  75 55 01                        MOV     ROMMODE,#01h                    ;Mode
 2869:
 2870:    3029  D2 A8                           SETB    EX0                             ;Enable INT0
 2871:    302B  D2 AA                           SETB    EX1                             ;Enable INT1
 2872:    302D  D2 AF                           SETB    EA                              ;Enable interrupts
 2873:    302F  12 3D 7C                        LCALL   LCDINIT
 2874:    3032  12 28 6E                        LCALL   LCMETERINIT
 2875:    3035  12 20 60                        LCALL   SETMODE
 2876:
 2877:          N      FFFF     IF DEVMODE=1
 2878:    3038  75 20 3F                        MOV     INTBITS,#3Fh                    ;Redirect all interrupts, Output to LCD
 2879:          N      0000             IF DEBUG=1
 2880:                                          SETB    INTBITS.7                       ;Set single step flag
 2881:                                          CLR     IT1                             ;Level triggered
 2882:                                          CLR     P3.3                            ;Pull INT1 low
 2883:                                          NOP
 2884:                                          NOP
 2885:                                  ENDIF
 2886:                          ENDIF
 2887:
 2888:    303B  75 81 CF        START:          MOV     SP,#0CFh                        ;Init stack pointer. The stack is 48 bytes
 2889:    303E  90 20 00                        MOV     DPTR,#2000h
 2890:          N      FFFF     IF DEVMODE=1
 2891:    3041  30 98 06                        JNB     RI,START01
 2892:    3044  75 20 00                        MOV     INTBITS,#00h                    ;Redirect no interrupts
 2893:    3047  02 00 00                        LJMP    0000h
 2894:    304A                  START01:;       MOV     MODE,#08h
 2895:                          ENDIF
 2896:
 2897:    304A  75 24 80                        MOV     ARG_STACK,#80h
 2898:    304D  12 3D 7C                        LCALL   LCDINIT
 2899:    3050  E5 59                           MOV     A,MODE
 2900:    3052  FF                              MOV     R7,A
 2901:    3053  70 02                           JNZ     START1
 2902:    3055  01 92                           AJMP    TERMINAL                        ;RS232 Terminal
 2903:    3057  DF 04           START1:         DJNZ    R7,START2
 2904:    3059  E4                              CLR     A                               ;Frequency counter channel0. External, Amplified
 2905:    305A  02 2A C8                        LJMP    FREQENCYCOUNT
 2906:    305D  DF 05           START2:         DJNZ    R7,START3                       ;Frequency counter channel0. External, TTL Level
 2907:    305F  74 80                           MOV     A,#80h
 2908:    3061  02 2A C8                        LJMP    FREQENCYCOUNT
 2909:    3064  DF 05           START3:         DJNZ    R7,START4
 2910:    3066  74 01                           MOV     A,#01h                          ;Frequency counter channel1. Function generator
 2911:    3068  02 2A C8                        LJMP    FREQENCYCOUNT
 2912:    306B  DF 05           START4:         DJNZ    R7,START5
 2913:    306D  74 02                           MOV     A,#02h                          ;Frequency counter channel2. LC Meter
 2914:    306F  02 2A C8                        LJMP    FREQENCYCOUNT
 2915:    3072  DF 05           START5:         DJNZ    R7,START6
 2916:    3074  74 03                           MOV     A,#03h                          ;Frequency counter channel3. ALE
 2917:    3076  02 2A C8                        LJMP    FREQENCYCOUNT
 2918:    3079  DF 03           START6:         DJNZ    R7,START7
 2919:    307B  02 2B A9                        LJMP    ADCONVERTERINT                  ;AD Coverter Internal PSU
 2920:    307E  DF 03           START7:         DJNZ    R7,START8
 2921:    3080  02 2C 21                        LJMP    ADCONVERTEREXT                  ;AD Coverter External PSU
 2922:    3083  DF 03           START8:         DJNZ    R7,START9
 2923:    3085  02 29 17                        LJMP    LMETER                          ;Inductance
 2924:    3088  DF 03           START9:         DJNZ    R7,START10
 2925:    308A  02 29 9F                        LJMP    CMETER                          ;Capacitance
 2926:    308D  12 28 6E        START10:        LCALL   LCMETERINIT                     ;Calibrate
 2927:    3090  80 A9                           SJMP    START
 2928:
 2929:                          ;------------------------------------------------------------------
 2930:
 2931:                          ;RS232 Terminal
 2932:                          ;IN:    Nothing
 2933:                          ;OUT:   Nothing
 2934:    3092  51 9F           TERMINAL:       ACALL   HELPMENU
 2935:    3094  31 AB           TERMINAL1:      ACALL   PRNTCRLF
 2936:    3096  74 3E                           MOV     A,#3Eh
 2937:    3098  51 88                           ACALL   TXBYTE
 2938:    309A  51 71           TERMINAL2:      ACALL   RXBYTE
 2939:    309C  B4 41 06                        CJNE    A,#41h,TERMINAL3
 2940:                                          ;Address input
 2941:    309F  31 A6                           ACALL   PRNTCMND
 2942:    30A1  51 50                           ACALL   INPDPTR
 2943:    30A3  80 EF                           SJMP    TERMINAL1
 2944:    30A5  B4 44 06        TERMINAL3:      CJNE    A,#44h,TERMINAL4
 2945:                                          ;Dump
 2946:    30A8  31 A6                           ACALL   PRNTCMND
 2947:    30AA  71 59                           ACALL   DUMP
 2948:    30AC  80 E4                           SJMP    TERMINAL
 2949:    30AE  B4 45 06        TERMINAL4:      CJNE    A,#45h,TERMINAL5
 2950:                                          ;Enter hex
 2951:    30B1  31 A6                           ACALL   PRNTCMND
 2952:    30B3  71 85                           ACALL   ENTERHEX
 2953:    30B5  80 DB                           SJMP    TERMINAL
 2954:    30B7  B4 47 06        TERMINAL5:      CJNE    A,#47h,TERMINAL6
 2955:                                          ;Go
 2956:    30BA  31 A6                           ACALL   PRNTCMND
 2957:    30BC  B1 7D                           ACALL   GO
 2958:    30BE  80 D2                           SJMP    TERMINAL
 2959:    30C0  B4 48 04        TERMINAL6:      CJNE    A,#48h,TERMINAL7
 2960:                                          ;Help
 2961:    30C3  31 A6                           ACALL   PRNTCMND
 2962:    30C5  80 CB                           SJMP    TERMINAL
 2963:    30C7  B4 49 06        TERMINAL7:      CJNE    A,#49h,TERMINAL8
 2964:                                          ;Internal memory
 2965:    30CA  31 A6                           ACALL   PRNTCMND
 2966:    30CC  71 B7                           ACALL   MEMDUMP
 2967:    30CE  80 C4                           SJMP    TERMINAL1
 2968:    30D0  B4 4C 06        TERMINAL8:      CJNE    A,#4Ch,TERMINAL9
 2969:                                          ;Load
 2970:    30D3  31 A6                           ACALL   PRNTCMND
 2971:    30D5  B1 50                           ACALL   LOAD
 2972:    30D7  80 BB                           SJMP    TERMINAL1
 2973:    30D9  B4 50 06        TERMINAL9:      CJNE    A,#50h,TERMINAL10
 2974:                                          ;Program ROM
 2975:    30DC  31 A6                           ACALL   PRNTCMND
 2976:    30DE  B1 81                           ACALL   EPROM
 2977:    30E0  80 B0                           SJMP    TERMINAL
 2978:    30E2  B4 52 06        TERMINAL10:     CJNE    A,#52h,TERMINAL11
 2979:                                          ;Run
 2980:    30E5  31 A6                           ACALL   PRNTCMND
 2981:    30E7  B1 7F                           ACALL   RUN
 2982:    30E9  80 A7                           SJMP    TERMINAL
 2983:    30EB  B4 53 07        TERMINAL11:     CJNE    A,#53h,TERMINAL12
 2984:                                          ;SFR dump
 2985:    30EE  12 31 A6                        LCALL   PRNTCMND
 2986:    30F1  71 DA                           ACALL   DUMPSFR
 2987:    30F3  80 9F                           SJMP    TERMINAL1
 2988:    30F5  B4 46 06        TERMINAL12:     CJNE    A,#46h,TERMINAL13
 2989:                                          ;Enter float
 2990:    30F8  31 A6                           ACALL   PRNTCMND
 2991:    30FA  71 9A                           ACALL   ENTERFLOAT
 2992:    30FC  80 96                           SJMP    TERMINAL1
 2993:    30FE  B4 9F 03        TERMINAL13:     CJNE    A,#9Fh,TERMINAL14
 2994:                                          ;Esc
 2995:    3101  02 00 00                        LJMP    0000h
 2996:    3104  B4 0D 93        TERMINAL14:     CJNE    A,#0Dh,TERMINAL2
 2997:                                          ;CR
 2998:    3107  80 8B                           SJMP    TERMINAL1
 2999:
 3000:                          ;RS232 Functions
 3001:                          ;------------------------------------------------------------------
 3002:
 3003:    3109  85 82 57        PRNTCSTR:       MOV     DPLSAVE,DPL
 3004:    310C  85 83 58                        MOV     DPHSAVE,DPH
 3005:    310F  D0 83                           POP     DPH
 3006:    3111  D0 82                           POP     DPL
 3007:    3113  E4              PRNTCSTR1:      CLR     A
 3008:    3114  93                              MOVC    A,@A+DPTR
 3009:    3115  A3                              INC     DPTR
 3010:    3116  60 04                           JZ      PRNTCSTR2
 3011:    3118  51 88                           ACALL   TXBYTE
 3012:    311A  80 F7                           SJMP    PRNTCSTR1
 3013:    311C  C0 82           PRNTCSTR2:      PUSH    DPL
 3014:    311E  C0 83                           PUSH    DPH
 3015:    3120  85 57 82                        MOV     DPL,DPLSAVE
 3016:    3123  85 58 83                        MOV     DPH,DPHSAVE
 3017:    3126  22                              RET
 3018:
 3019:    3127  85 82 57        PRNTCSTRLCD:    MOV     DPLSAVE,DPL
 3020:    312A  85 83 58                        MOV     DPHSAVE,DPH
 3021:    312D  D0 83                           POP     DPH
 3022:    312F  D0 82                           POP     DPL
 3023:    3131  E4              PRNTCSTRLCD1:   CLR     A
 3024:    3132  93                              MOVC    A,@A+DPTR
 3025:    3133  A3                              INC     DPTR
 3026:    3134  60 05                           JZ      PRNTCSTRLCD2
 3027:    3136  12 3D 68                        LCALL   LCDCHROUT
 3028:    3139  80 F6                           SJMP    PRNTCSTRLCD1
 3029:    313B  C0 82           PRNTCSTRLCD2:   PUSH    DPL
 3030:    313D  C0 83                           PUSH    DPH
 3031:    313F  85 57 82                        MOV     DPL,DPLSAVE
 3032:    3142  85 58 83                        MOV     DPH,DPHSAVE
 3033:    3145  22                              RET
 3034:
 3035:    3146  E4              PRNTCDPTRLCD:   CLR     A
 3036:    3147  93                              MOVC    A,@A+DPTR
 3037:    3148  A3                              INC     DPTR
 3038:    3149  60 05                           JZ      PRNTCDPTRLCD1
 3039:    314B  12 3D 68                        LCALL   LCDCHROUT
 3040:    314E  80 F6                           SJMP    PRNTCDPTRLCD
 3041:    3150  22              PRNTCDPTRLCD1:  RET
 3042:
 3043:    3151  30 06 09        PRINTSTR:       JNB     INTBITS.6,PRINTSTRLCD
 3044:    3154  E6              PRINTSTRTRM:    MOV     A,@R0
 3045:    3155  51 88                           ACALL   TXBYTE
 3046:    3157  08                              INC     R0
 3047:    3158  DF FA                           DJNZ    R7,PRINTSTRTRM
 3048:    315A  31 AB                           ACALL   PRNTCRLF
 3049:    315C  22                              RET
 3050:
 3051:    315D  E6              PRINTSTRLCD:    MOV     A,@R0
 3052:    315E  12 3D 68                        LCALL   LCDCHROUT
 3053:    3161  08                              INC     R0
 3054:    3162  DF F9                           DJNZ    R7,PRINTSTRLCD
 3055:    3164  22                              RET
 3056:
 3057:    3165  E0              PRINTDPTRSTR:   MOVX    A,@DPTR
 3058:    3166  51 88                           ACALL   TXBYTE
 3059:    3168  A3                              INC     DPTR
 3060:    3169  B4 0D F9                        CJNE    A,#0Dh,PRINTDPTRSTR
 3061:    316C  74 0A                           MOV     A,#0Ah
 3062:    316E  51 88                           ACALL   TXBYTE
 3063:    3170  22                              RET
 3064:
 3065:    3171  75 50 40        PRINTFP:        MOV     FPCHR_OUT,#LCDLINE
 3066:    3174  75 25 00                        MOV     FORMAT,#00h
 3067:    3177  E5 24                           MOV     A,ARG_STACK
 3068:    3179  C3                              CLR     C
 3069:    317A  94 05                           SUBB    A,#05h
 3070:    317C  F8                              MOV     R0,A
 3071:    317D  12 24 C3                        LCALL   FLOATING_POINT_OUTPUT
 3072:    3180  A8 50                           MOV     R0,FPCHR_OUT
 3073:    3182  E4                              CLR     A
 3074:    3183  F6                              MOV     @R0,A
 3075:    3184  78 40                           MOV     R0,#LCDLINE
 3076:    3186  E6                              MOV     A,@R0
 3077:    3187  51 88           PRINTFP1:       ACALL   TXBYTE
 3078:    3189  08                              INC     R0
 3079:    318A  E6                              MOV     A,@R0
 3080:    318B  70 FA                           JNZ     PRINTFP1
 3081:    318D  74 20                           MOV     A,#20h
 3082:    318F  51 88                           ACALL   TXBYTE
 3083:    3191  74 20                           MOV     A,#20h
 3084:    3193  51 88                           ACALL   TXBYTE
 3085:    3195  74 20                           MOV     A,#20h
 3086:    3197  51 88                           ACALL   TXBYTE
 3087:    3199  74 20                           MOV     A,#20h
 3088:    319B  51 88                           ACALL   TXBYTE
 3089:    319D  74 0D                           MOV     A,#0Dh
 3090:    319F  51 88                           ACALL   TXBYTE
 3091:    31A1  74 0A                           MOV     A,#0Ah
 3092:    31A3  51 88                           ACALL   TXBYTE
 3093:    31A5  22                              RET
 3094:
 3095:    31A6  51 88           PRNTCMND:       ACALL   TXBYTE
 3096:    31A8  31 AB                           ACALL   PRNTCRLF
 3097:    31AA  22                              RET
 3098:
 3099:    31AB  74 0D           PRNTCRLF:       MOV     A,#0Dh
 3100:    31AD  51 88                           ACALL   TXBYTE
 3101:    31AF  74 0A                           MOV     A,#0Ah
 3102:    31B1  51 88                           ACALL   TXBYTE
 3103:    31B3  22                              RET
 3104:
 3105:    31B4  C0 E0           HEXOUT:         PUSH    ACC
 3106:    31B6  C4                              SWAP    A
 3107:    31B7  31 BB                           ACALL   HEXOUT1
 3108:    31B9  D0 E0                           POP     ACC
 3109:    31BB  54 0F           HEXOUT1:        ANL     A,#0Fh
 3110:    31BD  C3                              CLR     C
 3111:    31BE  94 0A                           SUBB    A,#0Ah
 3112:    31C0  40 02                           JC      HEXOUT2
 3113:    31C2  24 07                           ADD     A,#07h
 3114:    31C4  24 3A           HEXOUT2:        ADD     A,#3Ah
 3115:    31C6  51 88                           ACALL   TXBYTE
 3116:    31C8  22                              RET
 3117:
 3118:    31C9  78 08           BINOUT:         MOV     R0,#08h
 3119:    31CB  33              BINOUT1:        RLC     A
 3120:    31CC  C0 E0                           PUSH    ACC
 3121:    31CE  74 20                           MOV     A,#20h
 3122:    31D0  12 32 88                        LCALL   TXBYTE
 3123:    31D3  74 20                           MOV     A,#20h
 3124:    31D5  12 32 88                        LCALL   TXBYTE
 3125:    31D8  74 30                           MOV     A,#30H
 3126:    31DA  50 01           BINOUT2:        JNC     BINOUT3
 3127:    31DC  04                              INC     A
 3128:    31DD  12 32 88        BINOUT3:        LCALL   TXBYTE
 3129:    31E0  D0 E0                           POP     ACC
 3130:    31E2  D8 E7                           DJNZ    R0,BINOUT1
 3131:    31E4  12 31 AB                        LCALL   PRNTCRLF
 3132:    31E7  22                              RET
 3133:
 3134:    31E8  E5 83           HEXDPTR:        MOV     A,DPH
 3135:    31EA  31 B4                           ACALL   HEXOUT
 3136:    31EC  E5 82                           MOV     A,DPL
 3137:    31EE  31 B4                           ACALL   HEXOUT
 3138:    31F0  74 20                           MOV     A,#20h
 3139:    31F2  51 88                           ACALL   TXBYTE
 3140:    31F4  22                              RET
 3141:
 3142:    31F5  E5 24           HEXDUMPFP:      MOV     A,ARG_STACK
 3143:    31F7  C3                              CLR     C
 3144:    31F8  94 05                           SUBB    A,#05h
 3145:    31FA  F5 82                           MOV     DPL,A
 3146:    31FC  75 83 01                        MOV     DPH,#ARG_STACK_PAGE
 3147:    31FF  7F 06                           MOV     R7,#06h
 3148:    3201  E0              HEXDUMPFP1:     MOVX    A,@DPTR
 3149:    3202  31 B4                           ACALL   HEXOUT
 3150:    3204  05 82                           INC     DPL
 3151:    3206  DF F9                           DJNZ    R7,HEXDUMPFP1
 3152:    3208  74 0D                           MOV     A,#0Dh
 3153:    320A  51 88                           ACALL   TXBYTE
 3154:    320C  74 0A                           MOV     A,#0Ah
 3155:    320E  51 88                           ACALL   TXBYTE
 3156:    3210  22                              RET
 3157:
 3158:    3211  51 1D           HEXINPBYTE:     ACALL   HEXINP
 3159:    3213  40 07                           JC      HEXINPBYTE1
 3160:    3215  C4                              SWAP    A
 3161:    3216  FB                              MOV     R3,A
 3162:    3217  51 1D                           ACALL   HEXINP
 3163:    3219  40 01                           JC      HEXINPBYTE1
 3164:    321B  2B                              ADD     A,R3
 3165:    321C  22              HEXINPBYTE1:    RET
 3166:
 3167:    321D  51 29           HEXINP:         ACALL   HEXINP2
 3168:    321F  40 07                           JC      HEXINP1
 3169:    3221  C0 E0                           PUSH    ACC
 3170:    3223  EA                              MOV     A,R2
 3171:    3224  51 88                           ACALL   TXBYTE
 3172:    3226  D0 E0                           POP     ACC
 3173:    3228  22              HEXINP1:        RET
 3174:
 3175:    3229  51 71           HEXINP2:        ACALL   RXBYTE
 3176:    322B  B4 9F 02                        CJNE    A,#9Fh,HEXINP3                  ;Esc
 3177:    322E  D3                              SETB    C
 3178:    322F  22                              RET
 3179:    3230  B4 0D 02        HEXINP3:        CJNE    A,#0Dh,HEXINP4                  ;Cr
 3180:    3233  D3                              SETB    C
 3181:    3234  22                              RET
 3182:    3235  FA              HEXINP4:        MOV     R2,A
 3183:    3236  B4 3A 00                        CJNE    A,#3Ah,HEXINP40
 3184:    3239  50 08           HEXINP40:       JNC     HEXINP5
 3185:    323B  B4 30 00                        CJNE    A,#30h,HEXINP41
 3186:    323E  40 E9           HEXINP41:       JC      HEXINP2
 3187:    3240  94 30                           SUBB    A,#30h
 3188:    3242  22                              RET
 3189:    3243  B4 47 00        HEXINP5:        CJNE    A,#47h,HEXINP50
 3190:    3246  50 E1           HEXINP50:       JNC     HEXINP2
 3191:    3248  B4 41 00                        CJNE    A,#41h,HEXINP51
 3192:    324B  40 DC           HEXINP51:       JC      HEXINP2
 3193:    324D  94 37                           SUBB    A,#37h
 3194:    324F  22                              RET
 3195:
 3196:    3250  31 E8           INPDPTR:        ACALL   HEXDPTR
 3197:    3252  51 11                           ACALL   HEXINPBYTE
 3198:    3254  40 08                           JC      INPDPTR1
 3199:    3256  F5 83                           MOV     DPH,A
 3200:    3258  51 11                           ACALL   HEXINPBYTE
 3201:    325A  40 02                           JC      INPDPTR1
 3202:    325C  F5 82                           MOV     DPL,A
 3203:    325E  31 AB           INPDPTR1:       ACALL   PRNTCRLF
 3204:    3260  22                              RET
 3205:
 3206:    3261  74 05           RX16BYTES:      MOV     A,#05h
 3207:    3263  51 88                           ACALL   TXBYTE
 3208:    3265  78 40                           MOV     R0,#ROMBUFF
 3209:    3267  51 71           RX16BYTES1:     ACALL   RXBYTE
 3210:    3269  F6                              MOV     @R0,A
 3211:    326A  08                              INC     R0
 3212:    326B  B8 50 F9                        CJNE    R0,#ROMBUFF+10h,RX16BYTES1
 3213:    326E  78 40                           MOV     R0,#ROMBUFF
 3214:    3270  22                              RET
 3215:
 3216:    3271  20 07 08        RXBYTE:         JB      20h.7,RXBYTE1
 3217:    3274  30 98 FD                        JNB     RI,$
 3218:    3277  C2 98                           CLR     RI
 3219:    3279  E5 99                           MOV     A,SBUF
 3220:    327B  22                              RET
 3221:
 3222:    327C  C2 AA           RXBYTE1:        CLR     EX1
 3223:    327E  30 98 FD                        JNB     RI,$
 3224:    3281  C2 98                           CLR     RI
 3225:    3283  E5 99                           MOV     A,SBUF
 3226:    3285  D2 AA                           SETB    EX1
 3227:    3287  22                              RET
 3228:
 3229:    3288  20 07 08        TXBYTE:         JB      20h.7,TXBYTE1
 3230:    328B  F5 99                           MOV     SBUF,A
 3231:    328D  30 99 FD                        JNB     TI,$
 3232:    3290  C2 99                           CLR     TI
 3233:    3292  22                              RET
 3234:
 3235:    3293  C2 AA           TXBYTE1:        CLR     EX1
 3236:    3295  F5 99                           MOV     SBUF,A
 3237:    3297  30 99 FD                        JNB     TI,$
 3238:    329A  C2 99                           CLR     TI
 3239:    329C  D2 AA                           SETB    EX1
 3240:    329E  22                              RET
 3241:
 3242:                          ;Functions
 3243:                          ;------------------------------------------------------------------
 3244:
 3245:    329F  31 09           HELPMENU:       ACALL   PRNTCSTR
 3246:    32A1  0E                              DB      0Eh
 3247:          N      FFFF     IF DEVMODE=1
 3248:    32A2  2A 2A 2A 20                     DB      '*** DEVMODE ***',0Dh,0Ah
          32A6  44 45 56 4D
          32AA  4F 44 45 20
          32AE  2A 2A 2A 0D
          32B2  0A
 3249:                          ENDIF
 3250:    32B3  41 20 41 64                     DB      'A Address input',0Dh,0Ah
          32B7  64 72 65 73
          32BB  73 20 69 6E
          32BF  70 75 74 0D
          32C3  0A
 3251:    32C4  44 20 44 75                     DB      'D Dump as hex',0Dh,0Ah
          32C8  6D 70 20 61
          32CC  73 20 68 65
          32D0  78 0D 0A
 3252:    32D3  45 20 45 6E                     DB      'E Enter hex',0Dh,0Ah
          32D7  74 65 72 20
          32DB  68 65 78 0D
          32DF  0A
 3253:    32E0  46 20 45 6E                     DB      'F Enter float',0Dh,0Ah
          32E4  74 65 72 20
          32E8  66 6C 6F 61
          32EC  74 0D 0A
 3254:    32EF  47 20 47 6F                     DB      'G Go (Load and Run)',0Dh,0Ah
          32F3  20 28 4C 6F
          32F7  61 64 20 61
          32FB  6E 64 20 52
          32FF  75 6E 29 0D
          3303  0A
 3255:    3304  48 20 48 65                     DB      'H Help',0Dh,0Ah
          3308  6C 70 0D 0A
 3256:    330C  49 20 49 6E                     DB      'I Internal memory dump',0Dh,0Ah
          3310  74 65 72 6E
          3314  61 6C 20 6D
          3318  65 6D 6F 72
          331C  79 20 64 75
          3320  6D 70 0D 0A
 3257:    3324  4C 20 4C 6F                     DB      'L Load cmd file',0Dh,0Ah
          3328  61 64 20 63
          332C  6D 64 20 66
          3330  69 6C 65 0D
          3334  0A
 3258:    3335  50 20 50 72                     DB      'P Program ROM',0Dh,0Ah
          3339  6F 67 72 61
          333D  6D 20 52 4F
          3341  4D 0D 0A
 3259:    3344  52 20 52 75                     DB      'R Run',0Dh,0Ah
          3348  6E 0D 0A
 3260:    334B  53 20 53 46                     DB      'S SFR dunp',0Dh,0Ah,00h
          334F  52 20 64 75
          3353  6E 70 0D 0A
          3357  00
 3261:    3358  22                              RET
 3262:
 3263:    3359  C0 82           DUMP:           PUSH    DPL
 3264:    335B  C0 83                           PUSH    DPH
 3265:    335D  C0 02                           PUSH    02h
 3266:    335F  C0 03                           PUSH    03h
 3267:    3361  7B 10           DUMP1:          MOV     R3,#10h
 3268:    3363  7A 10           DUMP2:          MOV     R2,#10h
 3269:    3365  31 E8                           ACALL   HEXDPTR
 3270:    3367  E0              DUMP3:          MOVX    A,@DPTR
 3271:    3368  31 B4                           ACALL   HEXOUT
 3272:    336A  74 20                           MOV     A,#20h
 3273:    336C  51 88                           ACALL   TXBYTE
 3274:    336E  A3                              INC     DPTR
 3275:    336F  DA F6                           DJNZ    R2,DUMP3
 3276:    3371  31 AB                           ACALL   PRNTCRLF
 3277:    3373  DB EE                           DJNZ    R3,DUMP2
 3278:    3375  31 AB                           ACALL   PRNTCRLF
 3279:    3377  51 71                           ACALL   RXBYTE
 3280:    3379  B4 9F E5                        CJNE    A,#9Fh,DUMP1                    ;Esc
 3281:    337C  D0 03                           POP     03h
 3282:    337E  D0 02                           POP     02h
 3283:    3380  D0 83                           POP     DPH
 3284:    3382  D0 82                           POP     DPL
 3285:    3384  22                              RET
 3286:
 3287:    3385  C0 82           ENTERHEX:       PUSH    DPL
 3288:    3387  C0 83                           PUSH    DPH
 3289:    3389  31 E8           ENTERHEX1:      ACALL   HEXDPTR
 3290:    338B  51 11                           ACALL   HEXINPBYTE
 3291:    338D  40 06                           JC      ENTERHEX2
 3292:    338F  F0                              MOVX    @DPTR,A
 3293:    3390  A3                              INC     DPTR
 3294:    3391  31 AB                           ACALL   PRNTCRLF
 3295:    3393  80 F4                           SJMP    ENTERHEX1
 3296:    3395  D0 83           ENTERHEX2:      POP     DPH
 3297:    3397  D0 82                           POP     DPL
 3298:    3399  22                              RET
 3299:
 3300:    339A  C0 82           ENTERFLOAT:     PUSH    DPL
 3301:    339C  C0 83                           PUSH    DPH
 3302:    339E  90 00 48                        MOV     DPTR,#CONVT
 3303:    33A1  51 71           ENTERFLOAT1:    ACALL   RXBYTE
 3304:    33A3  51 88                           ACALL   TXBYTE
 3305:    33A5  F0                              MOVX    @DPTR,A
 3306:    33A6  A3                              INC     DPTR
 3307:    33A7  B4 0D F7                        CJNE    A,#0Dh,ENTERFLOAT1
 3308:    33AA  90 00 48                        MOV     DPTR,#CONVT
 3309:    33AD  12 24 0B                        LCALL   FLOATING_POINT_INPUT
 3310:    33B0  31 F5                           ACALL   HEXDUMPFP
 3311:    33B2  D0 83                           POP     DPH
 3312:    33B4  D0 82                           POP     DPL
 3313:    33B6  22                              RET
 3314:
 3315:    33B7  C0 00           MEMDUMP:        PUSH    00h
 3316:    33B9  78 00                           MOV     R0,#00h
 3317:    33BB  E4              MEMDUMP1:       CLR     A
 3318:    33BC  31 B4                           ACALL   HEXOUT
 3319:    33BE  E8                              MOV     A,R0
 3320:    33BF  31 B4                           ACALL   HEXOUT
 3321:    33C1  74 20                           MOV     A,#20h
 3322:    33C3  51 88                           ACALL   TXBYTE
 3323:    33C5  E6              MEMDUMP2:       MOV     A,@R0
 3324:    33C6  31 B4                           ACALL   HEXOUT
 3325:    33C8  74 20                           MOV     A,#20h
 3326:    33CA  51 88                           ACALL   TXBYTE
 3327:    33CC  08                              INC     R0
 3328:    33CD  E8                              MOV     A,R0
 3329:    33CE  54 0F                           ANL     A,#0Fh
 3330:    33D0  70 F3                           JNZ     MEMDUMP2
 3331:    33D2  31 AB                           ACALL   PRNTCRLF
 3332:    33D4  E8                              MOV     A,R0
 3333:    33D5  70 E4                           JNZ     MEMDUMP1
 3334:    33D7  D0 00                           POP     00h
 3335:    33D9  22                              RET
 3336:
 3337:    33DA  C0 D0           DUMPSFR:        PUSH    PSW
 3338:    33DC  C2 D3                           CLR     RS0
 3339:    33DE  C2 D4                           CLR     RS1
 3340:    33E0  C0 E0                           PUSH    ACC
 3341:    33E2  C0 00                           PUSH    00h
 3342:    33E4  C0 E0                           PUSH    ACC
 3343:    33E6  12 31 09                        LCALL   PRNTCSTR
 3344:    33E9  0D 0A 53 46                     DB 0Dh,0Ah,'SFR  D7 D6 D5 D4 D3 D2 D1 D0',0Dh,0Ah
          33ED  52 20 20 44
          33F1  37 20 44 36
          33F5  20 44 35 20
          33F9  44 34 20 44
          33FD  33 20 44 32
          3401  20 44 31 20
          3405  44 30 0D 0A
 3345:    3409  2D 2D 2D 2D                     DB '----------------------------',0Dh,0Ah
          340D  2D 2D 2D 2D
          3411  2D 2D 2D 2D
          3415  2D 2D 2D 2D
          3419  2D 2D 2D 2D
          341D  2D 2D 2D 2D
          3421  2D 2D 2D 2D
          3425  0D 0A
 3346:    3427  41 43 43 20                     DB 'ACC ',0
          342B  00
 3347:    342C  D0 E0                           POP     ACC
 3348:    342E  12 31 C9                        LCALL   BINOUT
 3349:    3431  12 31 09                        LCALL   PRNTCSTR
 3350:    3434  42 20 20 20                     DB 'B   ',0
          3438  00
 3351:    3439  E5 F0                           MOV     A,B
 3352:    343B  12 31 C9                        LCALL   BINOUT
 3353:    343E  12 31 09                        LCALL   PRNTCSTR
 3354:    3441  44 50 48 20                     DB 'DPH ',0
          3445  00
 3355:    3446  E5 83                           MOV     A,DPH
 3356:    3448  12 31 C9                        LCALL   BINOUT
 3357:    344B  12 31 09                        LCALL   PRNTCSTR
 3358:    344E  44 50 4C 20                     DB 'DPL ',0
          3452  00
 3359:    3453  E5 82                           MOV     A,DPL
 3360:    3455  12 31 C9                        LCALL   BINOUT
 3361:    3458  12 31 09                        LCALL   PRNTCSTR
 3362:    345B  49 45 20 20                     DB 'IE  ',0
          345F  00
 3363:    3460  E5 A8                           MOV     A,IE
 3364:    3462  12 31 C9                        LCALL   BINOUT
 3365:    3465  12 31 09                        LCALL   PRNTCSTR
 3366:    3468  49 50 20 20                     DB 'IP  ',0
          346C  00
 3367:    346D  E5 B8                           MOV     A,IP
 3368:    346F  12 31 C9                        LCALL   BINOUT
 3369:    3472  12 31 09                        LCALL   PRNTCSTR
 3370:    3475  50 30 20 20                     DB 'P0  ',0
          3479  00
 3371:    347A  E5 80                           MOV     A,P0
 3372:    347C  12 31 C9                        LCALL   BINOUT
 3373:    347F  12 31 09                        LCALL   PRNTCSTR
 3374:    3482  50 31 20 20                     DB 'P1  ',0
          3486  00
 3375:    3487  E5 90                           MOV     A,P1
 3376:    3489  12 31 C9                        LCALL   BINOUT
 3377:    348C  12 31 09                        LCALL   PRNTCSTR
 3378:    348F  50 32 20 20                     DB 'P2  ',0
          3493  00
 3379:    3494  E5 A0                           MOV     A,P2
 3380:    3496  12 31 C9                        LCALL   BINOUT
 3381:    3499  12 31 09                        LCALL   PRNTCSTR
 3382:    349C  50 33 20 20                     DB 'P3  ',0
          34A0  00
 3383:    34A1  E5 B0                           MOV     A,P3
 3384:    34A3  12 31 C9                        LCALL   BINOUT
 3385:    34A6  12 31 09                        LCALL   PRNTCSTR
 3386:    34A9  50 43 4F 4E                     DB 'PCON',0
          34AD  00
 3387:    34AE  E5 87                           MOV     A,PCON
 3388:    34B0  12 31 C9                        LCALL   BINOUT
 3389:    34B3  12 31 09                        LCALL   PRNTCSTR
 3390:    34B6  50 53 57 20                     DB 'PSW ',0
          34BA  00
 3391:    34BB  E5 D0                           MOV     A,PSW
 3392:    34BD  12 31 C9                        LCALL   BINOUT
 3393:    34C0  12 31 09                        LCALL   PRNTCSTR
 3394:    34C3  53 42 55 46                     DB 'SBUF',0
          34C7  00
 3395:    34C8  E5 99                           MOV     A,SBUF
 3396:    34CA  12 31 C9                        LCALL   BINOUT
 3397:    34CD  12 31 09                        LCALL   PRNTCSTR
 3398:    34D0  53 43 4F 4E                     DB 'SCON',0
          34D4  00
 3399:    34D5  E5 98                           MOV     A,SCON
 3400:    34D7  12 31 C9                        LCALL   BINOUT
 3401:    34DA  12 31 09                        LCALL   PRNTCSTR
 3402:    34DD  53 50 20 20                     DB 'SP  ',0
          34E1  00
 3403:    34E2  E5 81                           MOV     A,SP
 3404:    34E4  12 31 C9                        LCALL   BINOUT
 3405:    34E7  12 31 09                        LCALL   PRNTCSTR
 3406:    34EA  54 43 4F 4E                     DB 'TCON',0
          34EE  00
 3407:    34EF  E5 88                           MOV     A,TCON
 3408:    34F1  12 31 C9                        LCALL   BINOUT
 3409:    34F4  12 31 09                        LCALL   PRNTCSTR
 3410:    34F7  54 48 30 20                     DB 'TH0 ',0
          34FB  00
 3411:    34FC  E5 8C                           MOV     A,TH0
 3412:    34FE  12 31 C9                        LCALL   BINOUT
 3413:    3501  12 31 09                        LCALL   PRNTCSTR
 3414:    3504  54 48 31 20                     DB 'TH1 ',0
          3508  00
 3415:    3509  E5 8D                           MOV     A,TH1
 3416:    350B  12 31 C9                        LCALL   BINOUT
 3417:    350E  12 31 09                        LCALL   PRNTCSTR
 3418:    3511  54 4C 30 20                     DB 'TL0 ',0
          3515  00
 3419:    3516  E5 8A                           MOV     A,TL0
 3420:    3518  12 31 C9                        LCALL   BINOUT
 3421:    351B  12 31 09                        LCALL   PRNTCSTR
 3422:    351E  54 4C 31 20                     DB 'TL1 ',0
          3522  00
 3423:    3523  E5 8B                           MOV     A,TL1
 3424:    3525  12 31 C9                        LCALL   BINOUT
 3425:    3528  12 31 09                        LCALL   PRNTCSTR
 3426:    352B  54 4D 4F 44                     DB 'TMOD',0
          352F  00
 3427:    3530  E5 89                           MOV     A,TMOD
 3428:    3532  12 31 C9                        LCALL   BINOUT
 3429:    3535  D0 00                           POP     00h
 3430:    3537  D0 E0                           POP     ACC
 3431:    3539  D0 D0                           POP     PSW
 3432:    353B  22                              RET
 3433:
 3434:    353C  7B 40           LOAD1K:         MOV     R3,#40h
 3435:    353E  51 61           LOAD1K1:        ACALL   RX16BYTES                       ;Read 16 bytes from cmd file
 3436:    3540  E6              LOAD1K2:        MOV     A,@R0
 3437:    3541  F0                              MOVX    @DPTR,A
 3438:    3542  A3                              INC     DPTR
 3439:    3543  08                              INC     R0
 3440:    3544  E8                              MOV     A,R0
 3441:    3545  64 50                           XRL     A,#50h
 3442:    3547  70 F7                           JNZ     LOAD1K2                         ;Not 16 bytes yet
 3443:    3549  DB F3                           DJNZ    R3,LOAD1K1                      ;Not 1K yet
 3444:    354B  74 2E                           MOV     A,#'.'
 3445:    354D  51 88                           ACALL   TXBYTE
 3446:    354F  22                              RET
 3447:
 3448:    3550  C0 82           LOAD:           PUSH    DPL
 3449:    3552  C0 83                           PUSH    DPH
 3450:    3554  C0 00                           PUSH    00h
 3451:    3556  C0 03                           PUSH    03h
 3452:    3558  C0 04                           PUSH    04h
 3453:    355A  31 09                           ACALL   PRNTCSTR
 3454:    355C  4C 6F 61 64                     DB      'Loading .',0
          3560  69 6E 67 20
          3564  2E 00
 3455:    3566  7C 08                           MOV     R4,#08h
 3456:    3568  B1 3C           LOAD10:         ACALL   LOAD1K
 3457:    356A  DC FC                           DJNZ    R4,LOAD10
 3458:    356C  74 06                           MOV     A,#06h
 3459:    356E  51 88                           ACALL   TXBYTE                          ;End read 16 bytes from cmd file
 3460:    3570  31 AB                           ACALL   PRNTCRLF
 3461:    3572  D0 04                           POP     04h
 3462:    3574  D0 03                           POP     03h
 3463:    3576  D0 00                           POP     00h
 3464:    3578  D0 83                           POP     DPH
 3465:    357A  D0 82                           POP     DPL
 3466:    357C  22                              RET
 3467:
 3468:    357D  B1 50           GO:             ACALL   LOAD
 3469:    357F  E4              RUN:            CLR     A
 3470:    3580  73                              JMP     @A+DPTR
 3471:
 3472:                          ;ROM menu selection
 3473:                          ;------------------------------------------------------------------
 3474:
 3475:    3581  B1 F6           EPROM:          ACALL   ROMMENU
 3476:    3583  B4 94 6F                        CJNE    A,#94h,EPROMEXIT
 3477:    3586  12 38 89                        LCALL   ROMINSERT
 3478:    3589  40 F6                           JC      EPROM
 3479:    358B  12 3C C9                        LCALL   ROMINIT                         ;Turn on VCC, pull RST high and init programming mode
 3480:    358E  40 F1                           JC      EPROM                           ;Initialisation failed
 3481:    3590  E5 53                           MOV     A,ROMACTION
 3482:    3592  14                              DEC     A
 3483:    3593  70 12                           JNZ     EPROM2
 3484:                                          ;Test erased
 3485:    3595  12 39 33                        LCALL   ROMWAIT
 3486:    3598  E5 55                           MOV     A,ROMMODE
 3487:    359A  14                              DEC     A
 3488:    359B  70 05                           JNZ     EPROM1
 3489:    359D  12 39 43                        LCALL   BM_ROMERASED
 3490:    35A0  80 DF                           SJMP    EPROM
 3491:    35A2  12 3A 28        EPROM1:         LCALL   PM_ROMERASED
 3492:    35A5  80 DA                           SJMP    EPROM
 3493:    35A7  14              EPROM2:         DEC     A
 3494:    35A8  70 12                           JNZ     EPROM3
 3495:                                          ;Dump to hex file
 3496:    35AA  12 39 33                        LCALL   ROMWAIT
 3497:    35AD  E5 55                           MOV     A,ROMMODE
 3498:    35AF  14                              DEC     A
 3499:    35B0  70 05                           JNZ     EPROM21
 3500:    35B2  12 39 8F                        LCALL   BM_ROMDUMPF
 3501:    35B5  80 CA                           SJMP    EPROM
 3502:    35B7  12 3A 7F        EPROM21:        LCALL   PM_ROMDUMPF
 3503:    35BA  80 C5                           SJMP    EPROM
 3504:    35BC  14              EPROM3:         DEC     A
 3505:    35BD  70 0F                           JNZ     EPROM4
 3506:                                          ;Dump to screen
 3507:    35BF  E5 55                           MOV     A,ROMMODE
 3508:    35C1  14                              DEC     A
 3509:    35C2  70 05                           JNZ     EPROM31
 3510:    35C4  12 39 BB                        LCALL   BM_ROMDUMPS
 3511:    35C7  80 B8                           SJMP    EPROM
 3512:    35C9  12 3A B7        EPROM31:        LCALL   PM_ROMDUMPS
 3513:    35CC  80 B3                           SJMP    EPROM
 3514:    35CE  14              EPROM4:         DEC     A
 3515:    35CF  70 12                           JNZ     EPROM5
 3516:                                          ;Verify
 3517:    35D1  12 39 33                        LCALL   ROMWAIT
 3518:    35D4  E5 55                           MOV     A,ROMMODE
 3519:    35D6  14                              DEC     A
 3520:    35D7  70 05                           JNZ     EPROM41
 3521:    35D9  12 39 E8                        LCALL   BM_ROMVERIFY
 3522:    35DC  80 A3                           SJMP    EPROM
 3523:    35DE  12 3A EF        EPROM41:        LCALL   PM_ROMVERIFY
 3524:    35E1  80 9E                           SJMP    EPROM
 3525:    35E3                  EPROM5:         ;Program
 3526:    35E3  12 39 33                        LCALL   ROMWAIT
 3527:    35E6  E5 55                           MOV     A,ROMMODE
 3528:    35E8  14                              DEC     A
 3529:    35E9  70 05                           JNZ     EPROM51
 3530:    35EB  12 3B 66                        LCALL   PM_ROMPROG
 3531:    35EE  80 91                           SJMP    EPROM
 3532:    35F0  12 3B 66        EPROM51:        LCALL   PM_ROMPROG
 3533:    35F3  80 8C                           SJMP    EPROM
 3534:    35F5  22              EPROMEXIT:      RET
 3535:
 3536:    35F6  31 09           ROMMENU:        ACALL   PRNTCSTR
 3537:    35F8  0E                              DB      0Eh
 3538:    35F9  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          35FD  2D 2D 2D 2D
          3601  2D 2D 2D 2D
          3605  2D 2D 2D 2D
          3609  2D 2D 2D 2D
          360D  20 20 2D 2D
          3611  2D 2D 2D 2D
          3615  2D 2D 2D 2D
          3619  2D 2D 2D 2D
          361D  2D 2D 2D 20
          3621  20 2D 2D 2D
          3625  2D 2D 2D 2D
          3629  2D 2D 2D 2D
          362D  2D 2D 2D 2D
          3631  2D 2D 0D 0A
 3539:    3635  20 20 20 7C                     DB      '   |  Action       |  |  EEPROM size  |  |  Mode         |',0Dh,0Ah
          3639  20 20 41 63
          363D  74 69 6F 6E
          3641  20 20 20 20
          3645  20 20 20 7C
          3649  20 20 7C 20
          364D  20 45 45 50
          3651  52 4F 4D 20
          3655  73 69 7A 65
          3659  20 20 7C 20
          365D  20 7C 20 20
          3661  4D 6F 64 65
          3665  20 20 20 20
          3669  20 20 20 20
          366D  20 7C 0D 0A
 3540:    3671  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          3675  2D 2D 2D 2D
          3679  2D 2D 2D 2D
          367D  2D 2D 2D 2D
          3681  2D 2D 2D 2D
          3685  20 20 2D 2D
          3689  2D 2D 2D 2D
          368D  2D 2D 2D 2D
          3691  2D 2D 2D 2D
          3695  2D 2D 2D 20
          3699  20 2D 2D 2D
          369D  2D 2D 2D 2D
          36A1  2D 2D 2D 2D
          36A5  2D 2D 2D 2D
          36A9  2D 2D 0D 0A
 3541:    36AD  20 20 20 7C                     DB      '   |  Test erased  |  |  4K           |  |  Byte         |',0Dh,0Ah
          36B1  20 20 54 65
          36B5  73 74 20 65
          36B9  72 61 73 65
          36BD  64 20 20 7C
          36C1  20 20 7C 20
          36C5  20 34 4B 20
          36C9  20 20 20 20
          36CD  20 20 20 20
          36D1  20 20 7C 20
          36D5  20 7C 20 20
          36D9  42 79 74 65
          36DD  20 20 20 20
          36E1  20 20 20 20
          36E5  20 7C 0D 0A
 3542:    36E9  20 20 20 7C                     DB      '   |  Filedump     |  |  8K           |  |  Page         |',0Dh,0Ah
          36ED  20 20 46 69
          36F1  6C 65 64 75
          36F5  6D 70 20 20
          36F9  20 20 20 7C
          36FD  20 20 7C 20
          3701  20 38 4B 20
          3705  20 20 20 20
          3709  20 20 20 20
          370D  20 20 7C 20
          3711  20 7C 20 20
          3715  50 61 67 65
          3719  20 20 20 20
          371D  20 20 20 20
          3721  20 7C 0D 0A
 3543:    3725  20 20 20 7C                     DB      '   |  Screendump   |  |  16K          |  |               |',0Dh,0Ah
          3729  20 20 53 63
          372D  72 65 65 6E
          3731  64 75 6D 70
          3735  20 20 20 7C
          3739  20 20 7C 20
          373D  20 31 36 4B
          3741  20 20 20 20
          3745  20 20 20 20
          3749  20 20 7C 20
          374D  20 7C 20 20
          3751  20 20 20 20
          3755  20 20 20 20
          3759  20 20 20 20
          375D  20 7C 0D 0A
 3544:    3761  20 20 20 7C                     DB      '   |  Verify       |  |  32K          |  |               |',0Dh,0Ah
          3765  20 20 56 65
          3769  72 69 66 79
          376D  20 20 20 20
          3771  20 20 20 7C
          3775  20 20 7C 20
          3779  20 33 32 4B
          377D  20 20 20 20
          3781  20 20 20 20
          3785  20 20 7C 20
          3789  20 7C 20 20
          378D  20 20 20 20
          3791  20 20 20 20
          3795  20 20 20 20
          3799  20 7C 0D 0A
 3545:    379D  20 20 20 7C                     DB      '   |  Program      |  |  64K          |  |               |',0Dh,0Ah
          37A1  20 20 50 72
          37A5  6F 67 72 61
          37A9  6D 20 20 20
          37AD  20 20 20 7C
          37B1  20 20 7C 20
          37B5  20 36 34 4B
          37B9  20 20 20 20
          37BD  20 20 20 20
          37C1  20 20 7C 20
          37C5  20 7C 20 20
          37C9  20 20 20 20
          37CD  20 20 20 20
          37D1  20 20 20 20
          37D5  20 7C 0D 0A
 3546:    37D9  20 20 20 2D                     DB      '   -----------------  -----------------  -----------------',0Dh,0Ah
          37DD  2D 2D 2D 2D
          37E1  2D 2D 2D 2D
          37E5  2D 2D 2D 2D
          37E9  2D 2D 2D 2D
          37ED  20 20 2D 2D
          37F1  2D 2D 2D 2D
          37F5  2D 2D 2D 2D
          37F9  2D 2D 2D 2D
          37FD  2D 2D 2D 20
          3801  20 2D 2D 2D
          3805  2D 2D 2D 2D
          3809  2D 2D 2D 2D
          380D  2D 2D 2D 2D
          3811  2D 2D 0D 0A
 3547:    3815  00                              DB      00h
 3548:    3816  78 54                           MOV     R0,#ROMSIZE
 3549:    3818  12 38 6C                        LCALL   MENUSET
 3550:    381B  08                              INC     R0
 3551:    381C  12 38 6C                        LCALL   MENUSET
 3552:    381F  78 53                           MOV     R0,#ROMACTION
 3553:    3821  11 24                           ACALL   MENUXP
 3554:    3823  22                              RET
 3555:
 3556:    3824  12 38 6C        MENUXP:         LCALL   MENUSET
 3557:    3827  74 08                           MOV     A,#08h
 3558:    3829  12 32 88                        LCALL   TXBYTE
 3559:    382C  12 32 71                        LCALL   RXBYTE
 3560:    382F  B4 9A 0C                        CJNE    A,#9Ah,MENUXP1
 3561:    3832  E6                              MOV     A,@R0
 3562:    3833  14                              DEC     A
 3563:    3834  60 EE                           JZ      MENUXP
 3564:    3836  74 20                           MOV     A,#20h
 3565:    3838  12 32 88                        LCALL   TXBYTE
 3566:    383B  16                              DEC     @R0
 3567:    383C  80 E6                           SJMP    MENUXP
 3568:    383E  B4 9B 0D        MENUXP1:        CJNE    A,#9Bh,MENUXP2
 3569:    3841  E6                              MOV     A,@R0
 3570:    3842  94 05                           SUBB    A,#05h
 3571:    3844  60 DE                           JZ      MENUXP
 3572:    3846  74 20                           MOV     A,#20h
 3573:    3848  12 32 88                        LCALL   TXBYTE
 3574:    384B  06                              INC     @R0
 3575:    384C  80 D6                           SJMP    MENUXP
 3576:    384E  B4 9C 08        MENUXP2:        CJNE    A,#9Ch,MENUYP1
 3577:    3851  E8                              MOV     A,R0
 3578:    3852  94 55                           SUBB    A,#ROMMODE
 3579:    3854  60 CE                           JZ      MENUXP
 3580:    3856  08                              INC     R0
 3581:    3857  80 CB                           SJMP    MENUXP
 3582:    3859  B4 9D 08        MENUYP1:        CJNE    A,#9Dh,MENUYP2
 3583:    385C  E8                              MOV     A,R0
 3584:    385D  94 53                           SUBB    A,#ROMACTION
 3585:    385F  60 C3                           JZ      MENUXP
 3586:    3861  18                              DEC     R0
 3587:    3862  80 C0                           SJMP    MENUXP
 3588:    3864  B4 9F 01        MENUYP2:        CJNE    A,#9Fh,MENUYP3                  ;Esc
 3589:    3867  22                              RET
 3590:    3868  B4 94 B9        MENUYP3:        CJNE    A,#94h,MENUXP                   ;Insert
 3591:    386B  22                              RET
 3592:
 3593:    386C  74 0B           MENUSET:        MOV     A,#0Bh
 3594:    386E  12 32 88                        LCALL   TXBYTE
 3595:    3871  E6                              MOV     A,@R0
 3596:    3872  24 22                           ADD     A,#22h
 3597:    3874  12 32 88                        LCALL   TXBYTE
 3598:    3877  E8                              MOV     A,R0
 3599:    3878  94 53                           SUBB    A,#ROMACTION
 3600:    387A  75 F0 13                        MOV     B,#13h
 3601:    387D  A4                              MUL     AB
 3602:    387E  24 24                           ADD     A,#24h
 3603:    3880  12 32 88                        LCALL   TXBYTE
 3604:    3883  74 FB                           MOV     A,#0FBh                         ;
 3605:    3885  12 32 88                        LCALL   TXBYTE
 3606:    3888  22                              RET
 3607:
 3608:                          ;------------------------------------------------------------------
 3609:
 3610:    3889  12 3C 79        ROMINSERT:      LCALL   ROMOFF
 3611:    388C  12 31 09                        LCALL   PRNTCSTR
 3612:    388F  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Insert ',00h
          3893  6E 73 65 72
          3897  74 20 00
 3613:    389A  E5 54                           MOV     A,ROMSIZE
 3614:    389C  14                              DEC     A
 3615:    389D  70 09                           JNZ     ROMINSERT1
 3616:    389F  12 31 09                        LCALL   PRNTCSTR
 3617:    38A2  34 4B 00                        DB      '4K',00h
 3618:    38A5  75 52 10                        MOV     ROMPAGES,#10h                   ;16 Pages
 3619:    38A8  14              ROMINSERT1:     DEC     A
 3620:    38A9  70 09                           JNZ     ROMINSERT2
 3621:    38AB  12 31 09                        LCALL   PRNTCSTR
 3622:    38AE  38 4B 00                        DB      '8K',00h
 3623:    38B1  75 52 20                        MOV     ROMPAGES,#20h                   ;32 Pages
 3624:    38B4  14              ROMINSERT2:     DEC     A
 3625:    38B5  70 0A                           JNZ     ROMINSERT3
 3626:    38B7  12 31 09                        LCALL   PRNTCSTR
 3627:    38BA  31 36 4B 00                     DB      '16K',00h
 3628:    38BE  75 52 40                        MOV     ROMPAGES,#40h                   ;64 Pages
 3629:    38C1  14              ROMINSERT3:     DEC     A
 3630:    38C2  70 0A                           JNZ     ROMINSERT4
 3631:    38C4  12 31 09                        LCALL   PRNTCSTR
 3632:    38C7  33 32 4B 00                     DB      '32K',00h
 3633:    38CB  75 52 80                        MOV     ROMPAGES,#80h                   ;128 Pages
 3634:    38CE  14              ROMINSERT4:     DEC     A
 3635:    38CF  70 0A                           JNZ     ROMINSERT5
 3636:    38D1  12 31 09                        LCALL   PRNTCSTR
 3637:    38D4  36 34 4B 00                     DB      '64K',00h
 3638:    38D8  75 52 00                        MOV     ROMPAGES,#00h                   ;256 Pages
 3639:    38DB  12 31 09        ROMINSERT5:     LCALL   PRNTCSTR
 3640:    38DE  20 64 65 76                     DB      ' device and strike <Enter> ',00h
          38E2  69 63 65 20
          38E6  61 6E 64 20
          38EA  73 74 72 69
          38EE  6B 65 20 3C
          38F2  45 6E 74 65
          38F6  72 3E 20 00
 3641:    38FA  12 32 71                        LCALL   RXBYTE
 3642:    38FD  B4 9F 02                        CJNE    A,#9Fh,ROMINSERT6               ;Esc
 3643:    3900  D3                              SETB    C
 3644:    3901  22                              RET
 3645:    3902  12 31 09        ROMINSERT6:     LCALL   PRNTCSTR
 3646:    3905  0B 2A 23 20                     DB      0Bh,2Ah,23h,'                                       '
          3909  20 20 20 20
          390D  20 20 20 20
          3911  20 20 20 20
          3915  20 20 20 20
          3919  20 20 20 20
          391D  20 20 20 20
          3921  20 20 20 20
          3925  20 20 20 20
          3929  20 20 20 20
          392D  20 20
 3647:    392F  0D 00                           DB      0Dh,00h
 3648:    3931  C3                              CLR     C
 3649:    3932  22                              RET
 3650:
 3651:    3933  12 31 09        ROMWAIT:        LCALL   PRNTCSTR
 3652:    3936  0B 2A 23 57                     DB      0Bh,2Ah,23h,'Wait ...',00h
          393A  61 69 74 20
          393E  2E 2E 2E 00
 3653:    3942  22                              RET
 3654:
 3655:
 3656:                          ;Byte mode
 3657:                          ;------------------------------------------------------------------
 3658:
 3659:    3943  12 3C D9        BM_ROMERASED:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3660:    3946  B4 FF 0E                        CJNE    A,#0FFh,BM_ROMERASED1           ;Not erased
 3661:    3949  A3                              INC     DPTR                            ;Next address
 3662:    394A  E5 82                           MOV     A,DPL
 3663:    394C  70 F5                           JNZ     BM_ROMERASED                    ;Jump if more bytes in this page
 3664:    394E  E5 83                           MOV     A,DPH
 3665:    3950  B5 52 F0                        CJNE    A,ROMPAGES,BM_ROMERASED         ;Jump if more pages
 3666:    3953  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3667:    3956  22                              RET
 3668:    3957  12 3C 79        BM_ROMERASED1:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3669:    395A  12 31 09                        LCALL   PRNTCSTR
 3670:    395D  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          3961  79 74 65 20
          3965  61 74 20 00
 3671:    3969  E5 83                           MOV     A,DPH
 3672:    396B  12 31 B4                        LCALL   HEXOUT                          ;High address
 3673:    396E  E5 82                           MOV     A,DPL
 3674:    3970  12 31 B4                        LCALL   HEXOUT                          ;Low address
 3675:    3973  12 31 09                        LCALL   PRNTCSTR
 3676:    3976  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          397A  20 65 72 61
          397E  73 65 64 20
          3982  3C 45 6E 74
          3986  65 72 3E 20
          398A  00
 3677:    398B  12 32 71                        LCALL   RXBYTE                          ;Wait for keypress
 3678:    398E  22                              RET
 3679:
 3680:    398F  74 03           BM_ROMDUMPF:    MOV     A,#03h
 3681:    3991  12 32 88                        LCALL   TXBYTE                          ;Init write to file
 3682:    3994  12 3C D9        BM_ROMDUMPF1:   LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3683:    3997  12 31 B4                        LCALL   HEXOUT                          ;Output as hex
 3684:    399A  74 20                           MOV     A,#20h
 3685:    399C  12 32 88                        LCALL   TXBYTE                          ;Output a space
 3686:    399F  A3                              INC     DPTR
 3687:    39A0  E5 82                           MOV     A,DPL
 3688:    39A2  54 0F                           ANL     A,#0Fh
 3689:    39A4  70 03                           JNZ     BM_ROMDUMPF2                    ;Still on same line
 3690:    39A6  12 31 AB                        LCALL   PRNTCRLF                        ;Output CRLF
 3691:    39A9  E5 82           BM_ROMDUMPF2:   MOV     A,DPL
 3692:    39AB  70 E7                           JNZ     BM_ROMDUMPF1                    ;Jump if more bytes in this page
 3693:    39AD  E5 83                           MOV     A,DPH
 3694:    39AF  B5 52 E2                        CJNE    A,ROMPAGES,BM_ROMDUMPF1         ;Jump if more pages
 3695:    39B2  74 04                           MOV     A,#04h
 3696:    39B4  12 32 88                        LCALL   TXBYTE                          ;End write to file
 3697:    39B7  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3698:    39BA  22              BM_ROMDUMPF3:   RET
 3699:
 3700:    39BB  12 3C D9        BM_ROMDUMPS:    LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3701:    39BE  12 31 B4                        LCALL   HEXOUT                          ;Output as hex
 3702:    39C1  74 20                           MOV     A,#20h
 3703:    39C3  12 32 88                        LCALL   TXBYTE                          ;Output a space
 3704:    39C6  A3                              INC     DPTR                            ;Next ROM address
 3705:    39C7  E5 82                           MOV     A,DPL
 3706:    39C9  54 0F                           ANL     A,#0Fh
 3707:    39CB  70 03                           JNZ     BM_ROMDUMPS1                    ;Jump if still on same line
 3708:    39CD  12 31 AB                        LCALL   PRNTCRLF                        ;Output CRLF
 3709:    39D0  E5 82           BM_ROMDUMPS1:   MOV     A,DPL
 3710:    39D2  70 E7                           JNZ     BM_ROMDUMPS                     ;Jump if more bytes in this page
 3711:    39D4  12 31 AB                        LCALL   PRNTCRLF                        ;Output CRLF
 3712:    39D7  12 32 71                        LCALL   RXBYTE                          ;Wait for a keypress
 3713:    39DA  B4 9F 02                        CJNE    A,#9Fh,BM_ROMDUMPS2
 3714:    39DD  80 05                           SJMP    BM_ROMDUMPS3
 3715:    39DF  E5 83           BM_ROMDUMPS2:   MOV     A,DPH
 3716:    39E1  B5 52 D7                        CJNE    A,ROMPAGES,BM_ROMDUMPS          ;Jump if more pages
 3717:    39E4  12 3C 79        BM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3718:    39E7  22                              RET
 3719:
 3720:    39E8  C0 00           BM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3721:    39EA  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3722:    39ED  12 32 61                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3723:    39F0  86 51           BM_ROMVERIFY1:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3724:    39F2  12 3C D9                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3725:    39F5  B5 51 1D                        CJNE    A,ROMVER,BM_ROMVERIFY4          ;Compare and jump if not equal
 3726:    39F8  08              BM_ROMVERIFY2:  INC     R0                              ;Increment buffer pointer
 3727:    39F9  E8                              MOV     A,R0
 3728:    39FA  B4 50 03                        CJNE    A,#50h,BM_ROMVERIFY3            ;Jump if not last byte in buffer
 3729:    39FD  12 32 61                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3730:    3A00  A3              BM_ROMVERIFY3:  INC     DPTR                            ;Next ROM address
 3731:    3A01  E5 82                           MOV     A,DPL
 3732:    3A03  70 EB                           JNZ     BM_ROMVERIFY1                   ;Jump if still on same page
 3733:    3A05  E5 83                           MOV     A,DPH
 3734:    3A07  B5 52 E6                        CJNE    A,ROMPAGES,BM_ROMVERIFY1        ;Jump if more pages
 3735:    3A0A  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3736:    3A0D  74 06                           MOV     A,#06h
 3737:    3A0F  12 32 88                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3738:    3A12  D0 00                           POP     00h                             ;Restore R0
 3739:    3A14  22                              RET
 3740:    3A15  12 3C EE        BM_ROMVERIFY4:  LCALL   ROMVERIFYERR
 3741:    3A18  50 DE                           JNC     BM_ROMVERIFY2                   ;Jump if less than 16 errors
 3742:    3A1A  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3743:    3A1D  74 06                           MOV     A,#06h
 3744:    3A1F  12 32 88                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3745:    3A22  12 32 71                        LCALL   RXBYTE                          ;Wait for a keypress
 3746:    3A25  D0 00                           POP     00h                             ;Restore R0
 3747:    3A27  22                              RET
 3748:
 3749:                          ;Page mode
 3750:                          ;------------------------------------------------------------------
 3751:
 3752:    3A28  74 30           PM_ROMERASED:   MOV     A,#30h
 3753:    3A2A  12 3C 51                        LCALL   ISPCOMM                         ;Init read page mode
 3754:    3A2D  E5 83                           MOV     A,DPH
 3755:    3A2F  12 3C 51                        LCALL   ISPCOMM                         ;Send high address
 3756:    3A32  E4              PM_ROMERASED1:  CLR     A
 3757:    3A33  12 3C 51                        LCALL   ISPCOMM                         ;Get byte from ROM
 3758:    3A36  B4 FF 0E                        CJNE    A,#0FFh,PM_ROMERASED2           ;Jump if not erased
 3759:    3A39  A3                              INC     DPTR
 3760:    3A3A  E5 82                           MOV     A,DPL
 3761:    3A3C  70 F4                           JNZ     PM_ROMERASED1                   ;Jump if more bytes on this page
 3762:    3A3E  E5 83                           MOV     A,DPH
 3763:    3A40  B5 52 E5                        CJNE    A,ROMPAGES,PM_ROMERASED         ;Jump if more pagees
 3764:    3A43  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3765:    3A46  22                              RET
 3766:    3A47  12 3C 79        PM_ROMERASED2:  LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3767:    3A4A  12 31 09                        LCALL   PRNTCSTR
 3768:    3A4D  0B 2A 23 42                     DB      0Bh,2Ah,23h,'Byte at ',00h
          3A51  79 74 65 20
          3A55  61 74 20 00
 3769:    3A59  E5 83                           MOV     A,DPH
 3770:    3A5B  12 31 B4                        LCALL   HEXOUT                          ;Output high address as hex
 3771:    3A5E  E5 82                           MOV     A,DPL
 3772:    3A60  12 31 B4                        LCALL   HEXOUT                          ;Output low address as hex
 3773:    3A63  12 31 09                        LCALL   PRNTCSTR
 3774:    3A66  20 6E 6F 74                     DB      ' not erased <Enter> ',00h
          3A6A  20 65 72 61
          3A6E  73 65 64 20
          3A72  3C 45 6E 74
          3A76  65 72 3E 20
          3A7A  00
 3775:    3A7B  12 32 71                        LCALL   RXBYTE                          ;Wait for a keypress
 3776:    3A7E  22                              RET
 3777:
 3778:    3A7F  74 03           PM_ROMDUMPF:    MOV     A,#03h
 3779:    3A81  12 32 88                        LCALL   TXBYTE                          ;Init Output to hex file
 3780:    3A84  74 30           PM_ROMDUMPF1:   MOV     A,#30h
 3781:    3A86  12 3C 51                        LCALL   ISPCOMM                         ;Init read page mode
 3782:    3A89  E5 83                           MOV     A,DPH
 3783:    3A8B  12 3C 51                        LCALL   ISPCOMM                         ;Send high address
 3784:    3A8E  E4              PM_ROMDUMPF2:   CLR     A
 3785:    3A8F  12 3C 51                        LCALL   ISPCOMM                         ;Get byte from ROM
 3786:    3A92  12 31 B4                        LCALL   HEXOUT                          ;Output as hex
 3787:    3A95  74 20                           MOV     A,#20h
 3788:    3A97  12 32 88                        LCALL   TXBYTE                          ;Output a space
 3789:    3A9A  A3                              INC     DPTR
 3790:    3A9B  E5 82                           MOV     A,DPL
 3791:    3A9D  54 0F                           ANL     A,#0Fh
 3792:    3A9F  B4 00 07                        CJNE    A,#00h,PM_ROMDUMPF3             ;Jump if more bytes in this line
 3793:    3AA2  12 31 AB                        LCALL   PRNTCRLF                        ;Output CRLF
 3794:    3AA5  E5 82                           MOV     A,DPL
 3795:    3AA7  70 E5                           JNZ     PM_ROMDUMPF2                    ;Jump if more bytes in this page
 3796:    3AA9  E5 83           PM_ROMDUMPF3:   MOV     A,DPH
 3797:    3AAB  B5 52 D6                        CJNE    A,ROMPAGES,PM_ROMDUMPF1         ;Jump if more pages
 3798:    3AAE  74 04                           MOV     A,#04h
 3799:    3AB0  12 32 88                        LCALL   TXBYTE                          ;End Output to hex file
 3800:    3AB3  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3801:    3AB6  22                              RET
 3802:
 3803:    3AB7  74 30           PM_ROMDUMPS:    MOV     A,#30h
 3804:    3AB9  12 3C 51                        LCALL   ISPCOMM                         ;Init read page mode
 3805:    3ABC  E5 83                           MOV     A,DPH
 3806:    3ABE  12 3C 51                        LCALL   ISPCOMM                         ;Send high address
 3807:    3AC1  E4              PM_ROMDUMPS1:   CLR     A
 3808:    3AC2  12 3C 51                        LCALL   ISPCOMM                         ;Get byte from ROM
 3809:    3AC5  12 31 B4                        LCALL   HEXOUT                          ;Output as hex
 3810:    3AC8  74 20                           MOV     A,#20h
 3811:    3ACA  12 32 88                        LCALL   TXBYTE                          ;Output a space
 3812:    3ACD  A3                              INC     DPTR
 3813:    3ACE  E5 82                           MOV     A,DPL
 3814:    3AD0  54 0F                           ANL     A,#0Fh
 3815:    3AD2  70 12                           JNZ     PM_ROMDUMPS2                    ;Jump if still on same line
 3816:    3AD4  12 31 AB                        LCALL   PRNTCRLF                        ;Output CRLF
 3817:    3AD7  E5 82                           MOV     A,DPL
 3818:    3AD9  70 E6                           JNZ     PM_ROMDUMPS1                    ;Jump if more bytes on this page
 3819:    3ADB  12 31 AB                        LCALL   PRNTCRLF                        ;Output CRLF
 3820:    3ADE  12 32 71                        LCALL   RXBYTE                          ;Wait for a keypress
 3821:    3AE1  B4 9F 02                        CJNE    A,#9Fh,PM_ROMDUMPS2
 3822:    3AE4  80 05                           SJMP    PM_ROMDUMPS3                    ;Esc pressed
 3823:    3AE6  E5 83           PM_ROMDUMPS2:   MOV     A,DPH
 3824:    3AE8  B5 52 CC                        CJNE    A,ROMPAGES,PM_ROMDUMPS          ;Jump if more pages
 3825:    3AEB  12 3C 79        PM_ROMDUMPS3:   LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3826:    3AEE  22                              RET
 3827:
 3828:    3AEF  C0 00           PM_ROMVERIFY:   PUSH    00h                             ;Save R0
 3829:    3AF1  75 56 00                        MOV     ROMVERERR,#00h                  ;Number of errors
 3830:    3AF4  12 32 61                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3831:    3AF7  74 30           PM_ROMVERIFY1:  MOV     A,#30h
 3832:    3AF9  12 3C 51                        LCALL   ISPCOMM                         ;Init read page mode
 3833:    3AFC  E5 83                           MOV     A,DPH
 3834:    3AFE  12 3C 51                        LCALL   ISPCOMM                         ;Send high address
 3835:    3B01  86 51           PM_ROMVERIFY2:  MOV     ROMVER,@R0                      ;Get byte from buffer
 3836:    3B03  E4                              CLR     A
 3837:    3B04  12 3C 51                        LCALL   ISPCOMM                         ;Get byte from ROM
 3838:    3B07  B5 51 1D                        CJNE    A,ROMVER,PM_ROMVERIFY5          ;Compare and jump if not equal
 3839:    3B0A  08              PM_ROMVERIFY3:  INC     R0                              ;Increment buffer pointer
 3840:    3B0B  E8                              MOV     A,R0
 3841:    3B0C  B4 50 03                        CJNE    A,#50h,PM_ROMVERIFY4            ;Jump if not last byte in buffer
 3842:    3B0F  12 32 61                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3843:    3B12  A3              PM_ROMVERIFY4:  INC     DPTR
 3844:    3B13  E5 82                           MOV     A,DPL
 3845:    3B15  70 EA                           JNZ     PM_ROMVERIFY2                   ;Jump if still on same page
 3846:    3B17  E5 83                           MOV     A,DPH
 3847:    3B19  B5 52 DB                        CJNE    A,ROMPAGES,PM_ROMVERIFY1        ;Jump if more pages
 3848:    3B1C  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3849:    3B1F  74 06                           MOV     A,#06h
 3850:    3B21  12 32 88                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3851:    3B24  D0 00                           POP     00h                             ;Restore R0
 3852:    3B26  22                              RET
 3853:    3B27  12 3C EE        PM_ROMVERIFY5:  LCALL   ROMVERIFYERR
 3854:    3B2A  50 DE                           JNC     PM_ROMVERIFY3                   ;Jump if less than 16 errors
 3855:    3B2C  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3856:    3B2F  74 06                           MOV     A,#06h
 3857:    3B31  12 32 88                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3858:    3B34  12 32 71                        LCALL   RXBYTE                          ;Wait for keypress
 3859:    3B37  D0 00                           POP     00h                             ;Restore R0
 3860:    3B39  22                              RET
 3861:
 3862:    3B3A  90 00 00        PM_ISERASED:    MOV     DPTR,#0000h
 3863:    3B3D  75 56 00                        MOV     ROMVERERR,#00h
 3864:    3B40  74 30           PM_ISERASED1:   MOV     A,#30h
 3865:    3B42  12 3C 51                        LCALL   ISPCOMM                         ;Init read page mode
 3866:    3B45  E5 83                           MOV     A,DPH
 3867:    3B47  12 3C 51                        LCALL   ISPCOMM                         ;Send high address
 3868:    3B4A  E4              PM_ISERASED2:   CLR     A
 3869:    3B4B  12 3C 51                        LCALL   ISPCOMM                         ;Get byte from ROM
 3870:    3B4E  04                              INC     A
 3871:    3B4F  42 56                           ORL     ROMVERERR,A
 3872:    3B51  A3                              INC     DPTR
 3873:    3B52  E5 82                           MOV     A,DPL
 3874:    3B54  70 F4                           JNZ     PM_ISERASED2                    ;Jump if more bytes on this page
 3875:    3B56  E5 56                           MOV     A,ROMVERERR
 3876:    3B58  70 05                           JNZ     PM_ISERASED3
 3877:    3B5A  E5 83                           MOV     A,DPH
 3878:    3B5C  B5 52 E1                        CJNE    A,ROMPAGES,PM_ISERASED1         ;Jump if more pagees
 3879:    3B5F  C3              PM_ISERASED3:   CLR     C
 3880:    3B60  E5 56                           MOV     A,ROMVERERR
 3881:    3B62  60 01                           JZ      PM_ISERASED4
 3882:    3B64  D3                              SETB    C
 3883:    3B65  22              PM_ISERASED4:   RET
 3884:
 3885:    3B66  12 3B 3A        PM_ROMPROG:     LCALL   PM_ISERASED                     ;Check if chip is erased
 3886:    3B69  50 4E                           JNC     PM_ROMPROG1
 3887:    3B6B  74 AC                           MOV     A,#0ACh
 3888:    3B6D  12 3C 51                        LCALL   ISPCOMM                         ;Init chip erase byte 1
 3889:    3B70  74 80                           MOV     A,#80h
 3890:    3B72  12 3C 51                        LCALL   ISPCOMM                         ;Init chip erase byte 2
 3891:    3B75  E4                              CLR     A
 3892:    3B76  12 3C 51                        LCALL   ISPCOMM                         ;Init chip erase byte 3
 3893:    3B79  E4                              CLR     A
 3894:    3B7A  12 3C 51                        LCALL   ISPCOMM                         ;Init chip erase byte 4
 3895:    3B7D  E4                              CLR     A
 3896:    3B7E  12 3C 4A                        LCALL   WAIT                            ;Wait 256 ms
 3897:    3B81  E4                              CLR     A
 3898:    3B82  12 3C 4A                        LCALL   WAIT                            ;Wait 256 ms
 3899:    3B85  E4                              CLR     A
 3900:    3B86  12 3C 4A                        LCALL   WAIT                            ;Wait 256 ms
 3901:    3B89  12 3B 3A                        LCALL   PM_ISERASED
 3902:    3B8C  50 2B                           JNC     PM_ROMPROG1
 3903:    3B8E  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3904:    3B91  12 31 09                        LCALL   PRNTCSTR
 3905:    3B94  0B 2A 23 43                     DB      0Bh,2Ah,23h,'Could not erase chip <Enter> ',00h
          3B98  6F 75 6C 64
          3B9C  20 6E 6F 74
          3BA0  20 65 72 61
          3BA4  73 65 20 63
          3BA8  68 69 70 20
          3BAC  3C 45 6E 74
          3BB0  65 72 3E 20
          3BB4  00
 3906:    3BB5  12 32 71                        LCALL   RXBYTE                          ;Wait for keypress
 3907:    3BB8  22                              RET
 3908:    3BB9  C0 00           PM_ROMPROG1:    PUSH    00h
 3909:    3BBB  90 00 00                        MOV     DPTR,#0000h
 3910:    3BBE  12 32 61                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3911:    3BC1  74 40           PM_ROMPROG2:    MOV     A,#40h
 3912:    3BC3  12 3C 51                        LCALL   ISPCOMM                         ;Init byte programming mode
 3913:    3BC6  E5 83                           MOV     A,DPH
 3914:    3BC8  12 3C 51                        LCALL   ISPCOMM                         ;Send high address
 3915:    3BCB  E5 82                           MOV     A,DPL
 3916:    3BCD  12 3C 51                        LCALL   ISPCOMM                         ;Send low address
 3917:    3BD0  E6                              MOV     A,@R0                           ;Get byte from buffer
 3918:    3BD1  F5 51                           MOV     ROMVER,A
 3919:    3BD3  12 3C 51                        LCALL   ISPCOMM                         ;Send byte to be programmed
 3920:    3BD6  74 10                           MOV     A,#10h
 3921:    3BD8  12 3C 4A                        LCALL   WAIT                            ;Wait 1mS
 3922:    3BDB  12 3C D9                        LCALL   BM_ROMRDBYTE                    ;Read a byte from ROM
 3923:    3BDE  B5 51 22                        CJNE    A,ROMVER,PM_ROMPROG4            ;Compare and jump if not equal
 3924:    3BE1  08                              INC     R0
 3925:    3BE2  E8                              MOV     A,R0
 3926:    3BE3  B4 50 03                        CJNE    A,#50h,PM_ROMPROG3
 3927:    3BE6  12 32 61                        LCALL   RX16BYTES                       ;Read 16 bytes from cmd file. R0 points to start of 16 byte buffer
 3928:    3BE9  A3              PM_ROMPROG3:    INC     DPTR
 3929:    3BEA  E5 82                           MOV     A,DPL
 3930:    3BEC  70 D3                           JNZ     PM_ROMPROG2                     ;Jump if still on same page
 3931:    3BEE  74 2E                           MOV     A,#2Eh
 3932:    3BF0  12 32 88                        LCALL   TXBYTE
 3933:    3BF3  E5 83                           MOV     A,DPH
 3934:    3BF5  B5 52 C9                        CJNE    A,ROMPAGES,PM_ROMPROG2          ;Jump if more pages
 3935:    3BF8  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3936:    3BFB  74 06                           MOV     A,#06h
 3937:    3BFD  12 32 88                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3938:    3C00  D0 00                           POP     00h
 3939:    3C02  22                              RET
 3940:    3C03  C0 E0           PM_ROMPROG4:    PUSH    ACC
 3941:    3C05  12 3C 79                        LCALL   ROMOFF                          ;Set RST low and turn off VCC
 3942:    3C08  74 06                           MOV     A,#06h
 3943:    3C0A  12 32 88                        LCALL   TXBYTE                          ;End read 16 bytes from cmd file
 3944:    3C0D  12 31 09                        LCALL   PRNTCSTR
 3945:    3C10  0B 2A 23 45                     DB      0Bh,2Ah,23h,'Error at ',00h
          3C14  72 72 6F 72
          3C18  20 61 74 20
          3C1C  00
 3946:    3C1D  E5 83                           MOV     A,DPH
 3947:    3C1F  12 31 B4                        LCALL   HEXOUT                          ;High address
 3948:    3C22  E5 82                           MOV     A,DPL
 3949:    3C24  12 31 B4                        LCALL   HEXOUT                          ;Low address
 3950:    3C27  74 20                           MOV     A,#20h
 3951:    3C29  12 32 88                        LCALL   TXBYTE
 3952:    3C2C  E5 51                           MOV     A,ROMVER                        ;Byte from .cmd file
 3953:    3C2E  12 31 B4                        LCALL   HEXOUT
 3954:    3C31  74 20                           MOV     A,#20h
 3955:    3C33  12 32 88                        LCALL   TXBYTE
 3956:    3C36  D0 E0                           POP     ACC
 3957:    3C38  12 31 B4                        LCALL   HEXOUT                          ;Byte read from ROM
 3958:    3C3B  12 32 71                        LCALL   RXBYTE                          ;Wait for a keypress
 3959:    3C3E  D0 00                           POP     00h                             ;Restore R0
 3960:    3C40  22                              RET
 3961:
 3962:                          ;Wait functions
 3963:                          ;------------------------------------------------------------------
 3964:
 3965:    3C41  C0 07           WAIT100:        PUSH    07h                             ;Save R7
 3966:    3C43  7F 64                           MOV     R7,#64h
 3967:    3C45  DF FE           WAIT1001:       DJNZ    R7,WAIT1001                     ;Wait loop, 100uS
 3968:    3C47  D0 07                           POP     07h                             ;Restore R7
 3969:    3C49  22                              RET
 3970:
 3971:    3C4A  CF              WAIT:           XCH     A,R7
 3972:    3C4B  91 41           WAIT1:          ACALL   WAIT100
 3973:    3C4D  DF FC                           DJNZ    R7,WAIT1
 3974:    3C4F  CF                              XCH     A,R7
 3975:    3C50  22                              RET
 3976:
 3977:                          ;Control functions
 3978:                          ;------------------------------------------------------------------
 3979:
 3980:                          ;IN A, OUT A
 3981:    3C51  C0 07           ISPCOMM:        PUSH    07h
 3982:    3C53  C0 02                           PUSH    02h
 3983:    3C55  7A 08                           MOV     R2,#08h
 3984:    3C57  33              ISPCOMM1:       RLC     A
 3985:    3C58  92 93                           MOV     P1.3,C                          ;MISO
 3986:    3C5A  A2 94                           MOV     C,P1.4                          ;MOSI
 3987:    3C5C  CF                              XCH     A,R7
 3988:    3C5D  33                              RLC     A
 3989:    3C5E  CF                              XCH     A,R7
 3990:    3C5F  D2 92                           SETB    P1.2                            ;SCK H
 3991:    3C61  00                              NOP
 3992:    3C62  C2 92                           CLR     P1.2                            ;SCK L
 3993:    3C64  DA F1                           DJNZ    R2,ISPCOMM1
 3994:    3C66  EF                              MOV     A,R7
 3995:    3C67  D0 02                           POP     02
 3996:    3C69  D0 07                           POP     07
 3997:    3C6B  22                              RET
 3998:
 3999:    3C6C  D2 90           ROMON:          SETB    P1.0                            ;+5V On
 4000:    3C6E  74 0A                           MOV     A,#0Ah
 4001:    3C70  91 4A                           ACALL   WAIT                            ;Wait 1mS
 4002:    3C72  D2 91                           SETB    P1.1                            ;RST H
 4003:    3C74  74 0A                           MOV     A,#0Ah
 4004:    3C76  91 4A                           ACALL   WAIT                            ;Wait 1mS
 4005:    3C78  22                              RET
 4006:
 4007:    3C79  C2 91           ROMOFF:         CLR     P1.1                            ;RST L
 4008:    3C7B  74 01                           MOV     A,#01h
 4009:    3C7D  91 4A                           ACALL   WAIT                            ;Wait 100uS
 4010:    3C7F  75 90 10                        MOV     P1,#10h                         ;+5V Off, P1.4 As Input
 4011:    3C82  74 0A                           MOV     A,#0Ah
 4012:    3C84  12 3C 4A                        LCALL   WAIT                            ;Wait 1mS
 4013:    3C87  22                              RET
 4014:
 4015:    3C88  74 AC           ROMINITPGM:     MOV     A,#0ACh
 4016:    3C8A  12 3C 51                        LCALL   ISPCOMM
 4017:    3C8D  74 53                           MOV     A,#53h
 4018:    3C8F  12 3C 51                        LCALL   ISPCOMM
 4019:    3C92  74 00                           MOV     A,#00h
 4020:    3C94  12 3C 51                        LCALL   ISPCOMM
 4021:    3C97  74 00                           MOV     A,#00h
 4022:    3C99  12 3C 51                        LCALL   ISPCOMM
 4023:    3C9C  B4 69 01                        CJNE    A,#69h,ROMINITPGM1
 4024:    3C9F  22                              RET
 4025:    3CA0  12 31 09        ROMINITPGM1:    LCALL   PRNTCSTR
 4026:    3CA3  0B 2A 23 49                     DB      0Bh,2Ah,23h,'Initialisation Error <Enter> ',00h
          3CA7  6E 69 74 69
          3CAB  61 6C 69 73
          3CAF  61 74 69 6F
          3CB3  6E 20 45 72
          3CB7  72 6F 72 20
          3CBB  3C 45 6E 74
          3CBF  65 72 3E 20
          3CC3  00
 4027:    3CC4  12 32 71                        LCALL   RXBYTE
 4028:    3CC7  D3                              SETB    C
 4029:    3CC8  22                              RET
 4030:
 4031:    3CC9  90 00 00        ROMINIT:        MOV     DPTR,#0000h                     ;DPTR holds ROM address
 4032:    3CCC  12 3C 6C                        LCALL   ROMON                           ;Turn on VCC and pull RST high
 4033:    3CCF  12 3C 88                        LCALL   ROMINITPGM
 4034:    3CD2  50 04                           JNC     ROMINIT1
 4035:    3CD4  12 3C 79                        LCALL   ROMOFF                          ;Init programming failed
 4036:    3CD7  D3                              SETB    C
 4037:    3CD8  22              ROMINIT1:       RET
 4038:
 4039:    3CD9  74 20           BM_ROMRDBYTE:   MOV     A,#20h
 4040:    3CDB  12 3C 51                        LCALL   ISPCOMM
 4041:    3CDE  E5 83                           MOV     A,DPH
 4042:    3CE0  12 3C 51                        LCALL   ISPCOMM
 4043:    3CE3  E5 82                           MOV     A,DPL
 4044:    3CE5  12 3C 51                        LCALL   ISPCOMM
 4045:    3CE8  74 00                           MOV     A,#00h
 4046:    3CEA  12 3C 51                        LCALL   ISPCOMM
 4047:    3CED  22                              RET
 4048:
 4049:    3CEE  C0 E0           ROMVERIFYERR:   PUSH    ACC
 4050:    3CF0  12 31 09                        LCALL   PRNTCSTR
 4051:    3CF3  0D 20 20 20                     DB      0Dh,'   Error at ',00h
          3CF7  45 72 72 6F
          3CFB  72 20 61 74
          3CFF  20 00
 4052:    3D01  E5 83                           MOV     A,DPH
 4053:    3D03  12 31 B4                        LCALL   HEXOUT
 4054:    3D06  E5 82                           MOV     A,DPL
 4055:    3D08  12 31 B4                        LCALL   HEXOUT
 4056:    3D0B  74 20                           MOV     A,#20h
 4057:    3D0D  12 32 88                        LCALL   TXBYTE
 4058:    3D10  E5 51                           MOV     A,ROMVER
 4059:    3D12  12 31 B4                        LCALL   HEXOUT
 4060:    3D15  74 20                           MOV     A,#20h
 4061:    3D17  12 32 88                        LCALL   TXBYTE
 4062:    3D1A  D0 E0                           POP     ACC
 4063:    3D1C  12 31 B4                        LCALL   HEXOUT
 4064:    3D1F  12 31 AB                        LCALL   PRNTCRLF
 4065:    3D22  05 56                           INC     ROMVERERR
 4066:    3D24  E5 56                           MOV     A,ROMVERERR
 4067:    3D26  B4 10 00                        CJNE    A,#10h,ROMVERIFYERR1
 4068:    3D29  B3              ROMVERIFYERR1:  CPL     C
 4069:    3D2A  22                              RET
 4070:
 4071:                          ;LCD Output.
 4072:                          ;-----------------------------------------------------
 4073:    3D2B  C0 07           LCDDELAY:       PUSH    07h
 4074:    3D2D  7F 00                           MOV     R7,#00h
 4075:    3D2F  DF FE                           DJNZ    R7,$
 4076:    3D31  D0 07                           POP     07h
 4077:    3D33  22                              RET
 4078:
 4079:                          ;A contains nibble
 4080:    3D34  C0 82           LCDNIBOUT:      PUSH    DPL
 4081:    3D36  C0 83                           PUSH    DPH
 4082:    3D38  90 80 00                        MOV     DPTR,#8000h
 4083:    3D3B  45 21                           ORL     A,OUTD7D6
 4084:    3D3D  D2 E5                           SETB    ACC.5                           ;E
 4085:    3D3F  F0                              MOVX    @DPTR,A                         ;
 4086:    3D40  C2 E5                           CLR     ACC.5                           ;Negative edge on E
 4087:    3D42  F0                              MOVX    @DPTR,A                         ;
 4088:    3D43  D0 83                           POP     DPH
 4089:    3D45  D0 82                           POP     DPL
 4090:    3D47  22                              RET
 4091:
 4092:                          ;A contains byte
 4093:    3D48  C0 E0           LCDCMDOUT:      PUSH    ACC
 4094:    3D4A  C4                              SWAP    A                               ;High nibble first
 4095:    3D4B  54 0F                           ANL     A,#0Fh
 4096:    3D4D  B1 34                           ACALL   LCDNIBOUT
 4097:    3D4F  D0 E0                           POP     ACC
 4098:    3D51  54 0F                           ANL     A,#0Fh
 4099:    3D53  B1 34                           ACALL   LCDNIBOUT
 4100:    3D55  B1 2B                           ACALL   LCDDELAY                        ;Wait for BF to clear
 4101:    3D57  22                              RET
 4102:
 4103:    3D58  74 01           LCDCLEAR:       MOV     A,#00000001b
 4104:    3D5A  B1 48                           ACALL   LCDCMDOUT
 4105:    3D5C  B1 2B                           ACALL   LCDDELAY
 4106:    3D5E  B1 2B                           ACALL   LCDDELAY
 4107:    3D60  B1 2B                           ACALL   LCDDELAY
 4108:    3D62  22                              RET
 4109:
 4110:                          ;A contais address
 4111:    3D63  44 80           LCDSETADR:      ORL     A,#10000000b
 4112:    3D65  B1 48                           ACALL   LCDCMDOUT
 4113:    3D67  22                              RET
 4114:
 4115:                          ;A contains byte
 4116:    3D68  C0 E0           LCDCHROUT:      PUSH    ACC
 4117:    3D6A  C4                              SWAP    A                               ;High nibble first
 4118:    3D6B  54 0F                           ANL     A,#0Fh
 4119:    3D6D  D2 E4                           SETB    ACC.4                           ;RS
 4120:    3D6F  B1 34                           ACALL   LCDNIBOUT
 4121:    3D71  D0 E0                           POP     ACC
 4122:    3D73  54 0F                           ANL     A,#0Fh
 4123:    3D75  D2 E4                           SETB    ACC.4                           ;RS
 4124:    3D77  B1 34                           ACALL   LCDNIBOUT
 4125:    3D79  B1 2B                           ACALL   LCDDELAY                        ;Wait for BF to clear
 4126:    3D7B  22                              RET
 4127:
 4128:    3D7C  74 03           LCDINIT:        MOV     A,#00000011b                    ;Function set
 4129:    3D7E  B1 34                           ACALL   LCDNIBOUT
 4130:    3D80  B1 2B                           ACALL   LCDDELAY                        ;Wait for BF to clear
 4131:    3D82  74 28                           MOV     A,#00101000b
 4132:    3D84  B1 48                           ACALL   LCDCMDOUT
 4133:    3D86  74 28                           MOV     A,#00101000b
 4134:    3D88  B1 48                           ACALL   LCDCMDOUT
 4135:    3D8A  74 0C                           MOV     A,#00001100b                    ;Display ON/OFF
 4136:    3D8C  B1 48                           ACALL   LCDCMDOUT
 4137:    3D8E  B1 58                           ACALL   LCDCLEAR                        ;Clear
 4138:    3D90  74 06                           MOV     A,#00000110b                    ;Cursor direction
 4139:    3D92  B1 48                           ACALL   LCDCMDOUT
 4140:    3D94  22                              RET
 4141:
 4142:                          ;Single step called when INT1 pin low and interupt is enabled
 4143:                          ;------------------------------------------------------------------
 4144:    3D95  C0 D0           SINGLESTEP:     PUSH    PSW
 4145:    3D97  C0 E0                           PUSH    ACC
 4146:    3D99  C2 D3                           CLR     RS0
 4147:    3D9B  C2 D4                           CLR     RS1
 4148:    3D9D  C0 00                           PUSH    00h
 4149:    3D9F  A8 81                           MOV     R0,SP
 4150:    3DA1  18                              DEC     R0                              ;Skip PSW
 4151:    3DA2  18                              DEC     R0                              ;Skip ACC
 4152:    3DA3  18                              DEC     R0                              ;Skip R0
 4153:    3DA4  E5 5B                           MOV     A,SSADRMSB
 4154:    3DA6  04                              INC     A
 4155:    3DA7  60 0A                           JZ      SINGLESTEP0
 4156:    3DA9  E6                              MOV     A,@R0                           ;MSB adress
 4157:    3DAA  B5 5B 74                        CJNE    A,SSADRMSB,SINGLESTEPEX2
 4158:    3DAD  18                              DEC     R0
 4159:    3DAE  E6                              MOV     A,@R0                           ;MSB adress
 4160:    3DAF  08                              INC     R0
 4161:    3DB0  B5 5A 6E                        CJNE    A,SSADRLSB,SINGLESTEPEX2
 4162:    3DB3  74 07           SINGLESTEP0:    MOV     A,#07h
 4163:    3DB5  12 32 88                        LCALL   TXBYTE
 4164:    3DB8  E6                              MOV     A,@R0                           ;MSB adress
 4165:    3DB9  12 32 88                        LCALL   TXBYTE
 4166:    3DBC  18                              DEC     R0
 4167:    3DBD  E6                              MOV     A,@R0                           ;LSB adress
 4168:    3DBE  12 32 88                        LCALL   TXBYTE
 4169:    3DC1  08                              INC     R0                              ;MSB adress
 4170:    3DC2  08                              INC     R0                              ;PSW
 4171:    3DC3  E6                              MOV     A,@R0                           ;PSW
 4172:    3DC4  12 32 88                        LCALL   TXBYTE
 4173:    3DC7  08                              INC     R0                              ;ACC
 4174:    3DC8  E6                              MOV     A,@R0                           ;ACC
 4175:    3DC9  12 32 88                        LCALL   TXBYTE
 4176:    3DCC  E5 F0                           MOV     A,B                             ;B
 4177:    3DCE  12 32 88                        LCALL   TXBYTE
 4178:    3DD1  E5 81                           MOV     A,SP                            ;SP
 4179:    3DD3  C3                              CLR     C
 4180:    3DD4  94 05                           SUBB    A,#05h
 4181:    3DD6  12 32 88                        LCALL   TXBYTE
 4182:    3DD9  E5 82                           MOV     A,DPL                           ;DPL
 4183:    3DDB  12 32 88                        LCALL   TXBYTE
 4184:    3DDE  E5 83                           MOV     A,DPH                           ;DPH
 4185:    3DE0  12 32 88                        LCALL   TXBYTE
 4186:    3DE3  08                              INC     R0                              ;R0
 4187:    3DE4  E6                              MOV     A,@R0                           ;R0
 4188:    3DE5  12 32 88                        LCALL   TXBYTE
 4189:    3DE8  78 01                           MOV     R0,#01h
 4190:    3DEA  E6              SINGLESTEP1:    MOV     A,@R0                           ;31 Bytes
 4191:    3DEB  12 32 88                        LCALL   TXBYTE
 4192:    3DEE  08                              INC     R0
 4193:    3DEF  B8 20 F8                        CJNE    R0,#20h,SINGLESTEP1
 4194:    3DF2  C0 82                           PUSH    DPL
 4195:    3DF4  C0 83                           PUSH    DPH
 4196:    3DF6  78 20                           MOV     R0,#20h                         ;32 Bytes
 4197:    3DF8  E0              SINGLESTEP2:    MOVX    A,@DPTR
 4198:    3DF9  12 32 88                        LCALL   TXBYTE
 4199:    3DFC  A3                              INC     DPTR
 4200:    3DFD  D8 F9                           DJNZ    R0,SINGLESTEP2
 4201:    3DFF  12 32 71        SINGLESTEP3:    LCALL   RXBYTE
 4202:    3E02  B4 52 04                        CJNE    A,#'R',SINGLESTEP4              ;R Run
 4203:    3E05  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 4204:    3E07  80 0E                           SJMP    SINGLESTEPEX
 4205:    3E09  B4 73 08        SINGLESTEP4:    CJNE    A,#'s',SINGLESTEP5              ;s Stop
 4206:    3E0C  D2 B3                           SETB    P3.3                            ;Set INT1 pin high
 4207:    3E0E  E4                              CLR     A
 4208:    3E0F  C0 E0                           PUSH    ACC                             ;Force a software reset
 4209:    3E11  C0 E0                           PUSH    ACC
 4210:    3E13  32                              RETI                                    ;Return to reset vector
 4211:    3E14  B4 69 11        SINGLESTEP5:    CJNE    A,#'i',SINGLESTEP6              ;i Step into
 4212:    3E17  75 5A FF        SINGLESTEPEX:   MOV     SSADRLSB,#0FFh
 4213:    3E1A  75 5B FF                        MOV     SSADRMSB,#0FFh
 4214:    3E1D  D0 83           SINGLESTEPEX1:  POP     DPH
 4215:    3E1F  D0 82                           POP     DPL
 4216:    3E21  D0 00           SINGLESTEPEX2:  POP     00h
 4217:    3E23  D0 E0                           POP     ACC
 4218:    3E25  D0 D0                           POP     PSW
 4219:    3E27  32                              RETI
 4220:    3E28  B4 6F 0C        SINGLESTEP6:    CJNE    A,#'o',SINGLESTEP7              ;o Step over / Run to caret
 4221:    3E2B  12 32 71                        LCALL   RXBYTE
 4222:    3E2E  F5 5A                           MOV     SSADRLSB,A
 4223:    3E30  12 32 71                        LCALL   RXBYTE
 4224:    3E33  F5 5B                           MOV     SSADRMSB,A
 4225:    3E35  80 E6                           SJMP    SINGLESTEPEX1
 4226:    3E37  B4 41 05        SINGLESTEP7:    CJNE    A,#'A',SINGLESTEP8              ;A Adress input
 4227:    3E3A  12 32 50                        LCALL   INPDPTR
 4228:    3E3D  80 C0                           SJMP    SINGLESTEP3
 4229:    3E3F  B4 49 05        SINGLESTEP8:    CJNE    A,#'I',SINGLESTEP9              ;Dump internal memory
 4230:    3E42  12 33 B7                        LCALL   MEMDUMP
 4231:    3E45  80 B8                           SJMP    SINGLESTEP3
 4232:    3E47  B4 44 05        SINGLESTEP9:    CJNE    A,#'D',SINGLESTEP10             ;Dump external memory
 4233:    3E4A  12 33 59                        LCALL   DUMP
 4234:    3E4D  80 B0                           SJMP    SINGLESTEP3
 4235:    3E4F  B4 53 AD        SINGLESTEP10:   CJNE    A,#'S',SINGLESTEP3              ;Dump SFR's
 4236:    3E52  D0 83                           POP     DPH
 4237:    3E54  D0 82                           POP     DPL
 4238:    3E56  D0 00                           POP     00h
 4239:    3E58  D0 E0                           POP     ACC
 4240:    3E5A  D0 D0                           POP     PSW
 4241:    3E5C  C0 D0                           PUSH    PSW
 4242:    3E5E  C0 E0                           PUSH    ACC
 4243:    3E60  C2 D3                           CLR     RS0
 4244:    3E62  C2 D4                           CLR     RS1
 4245:    3E64  C0 00                           PUSH    00h
 4246:    3E66  C0 82                           PUSH    DPL
 4247:    3E68  C0 83                           PUSH    DPH
 4248:    3E6A  12 33 DA                        LCALL   DUMPSFR
 4249:    3E6D  80 90                           SJMP    SINGLESTEP3
 4250:
 4251:                                          END





                     register banks used:  ---

                     no errors



